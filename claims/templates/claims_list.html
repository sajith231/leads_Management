{% extends "base.html" %}
{% block content %}
<style>
    .claims-container { padding: 20px; max-width: 100%; margin: 0 auto; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
    h1 { color: #333; font-size: 28px; font-weight: 600; margin: 0; }
    .add-btn { padding: 12px 24px; background: #4CAF50; color: white; border: none; border-radius: 4px; font-size: 16px; font-weight: 500; cursor: pointer; text-decoration: none; display: inline-block; transition: background 0.3s; }
    .add-btn:hover { background: #45a049; }
    
    /* Filter Section */
    .filter-section { background: #fff; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); padding: 20px; margin-bottom: 20px; }
    .filter-form { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; align-items: end; }
    .filter-group { display: flex; flex-direction: column; }
    .filter-group label { font-size: 13px; font-weight: 500; color: #555; margin-bottom: 5px; }
    .filter-input, .filter-select { padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; width: 100%; transition: border-color 0.3s; }
    .filter-input:focus, .filter-select:focus { outline: none; border-color: #4CAF50; }
    .filter-buttons { display: flex; gap: 10px; }
    .btn-filter { padding: 10px 20px; background: #2196F3; color: white; border: none; border-radius: 4px; font-size: 14px; font-weight: 500; cursor: pointer; transition: background 0.3s; }
    .btn-filter:hover { background: #1976D2; }
    .btn-clear { padding: 10px 20px; background: #757575; color: white; border: none; border-radius: 4px; font-size: 14px; font-weight: 500; cursor: pointer; transition: background 0.3s; }
    .btn-clear:hover { background: #616161; }
    
    .table-container { background: #fff; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; min-width: 1200px; }
    thead { background: #f8f9fa; }
    th { padding: 15px; text-align: left; font-weight: 600; color: #555; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 2px solid #dee2e6; }
    td { padding: 15px; border-bottom: 1px solid #dee2e6; color: #333; font-size: 14px; }
    tr:hover { background: #f8f9fa; }
    .client-name { font-weight: 700; color: #1a1a1a; }
    .expense-badge { display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 500; }
    .badge-travel { background: #e3f2fd; color: #1976d2; }
    .badge-food { background: #fff3e0; color: #f57c00; }
    .badge-accommodation { background: #f3e5f5; color: #7b1fa2; }
    .badge-fuel { background: #e8f5e9; color: #388e3c; }
    .badge-self { background: #fce4ec; color: #c2185b; }
    .status-dropdown { padding: 6px 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; cursor: pointer; transition: border-color 0.3s; width: 120px; }
    .status-dropdown:focus { outline: none; border-color: #4CAF50; }
    .status-claimed { background: #fff3cd; color: #856404; border-color: #ffc107; }
    .status-approved { background: #d4edda; color: #155724; border-color: #28a745; }
    .status-rejected { background: #f8d7da; color: #721c24; border-color: #dc3545; }
    .amount { font-weight: 600; color: #2e7d32; }
    .receipt-icon { color: #1976d2; text-decoration: none; display: inline-flex; align-items: center; justify-content: center; padding: 8px; border-radius: 4px; transition: all 0.3s; }
    .receipt-icon:hover { background: #e3f2fd; color: #1565c0; transform: scale(1.1); }
    .receipt-icon svg { display: block; }
    .action-buttons { display: flex; gap: 8px; }
    .btn-edit, .btn-delete { padding: 6px 12px; border: none; border-radius: 4px; font-size: 13px; font-weight: 500; cursor: pointer; text-decoration: none; display: inline-block; transition: all 0.3s; }
    .btn-edit { background: #2196F3; color: white; }
    .btn-edit:hover { background: #1976D2; }
    .btn-delete { background: #f44336; color: white; }
    .btn-delete:hover { background: #d32f2f; }
    .no-claims { text-align: center; padding: 60px 20px; color: #999; }
    .no-claims p { font-size: 16px; margin-bottom: 20px; }
    
    /* Pagination Styles */
    .pagination-container { display: flex; justify-content: space-between; align-items: center; padding: 20px; background: #fff; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-top: 20px; flex-wrap: wrap; gap: 15px; }
    .pagination-info { color: #555; font-size: 14px; }
    .pagination { display: flex; gap: 5px; list-style: none; padding: 0; margin: 0; }
    .pagination li { display: inline-block; }
    .pagination a, .pagination span { display: inline-block; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; text-decoration: none; color: #333; font-size: 14px; transition: all 0.3s; }
    .pagination a:hover { background: #f0f0f0; border-color: #2196F3; color: #2196F3; }
    .pagination .active span { background: #2196F3; color: white; border-color: #2196F3; font-weight: 600; }
    .pagination .disabled span { color: #ccc; cursor: not-allowed; }
    .pagination .disabled a { pointer-events: none; color: #ccc; }
    
    @media (max-width: 768px) {
        .claims-container { padding: 10px; }
        .header { flex-direction: column; gap: 15px; align-items: flex-start; }
        h1 { font-size: 24px; }
        .filter-form { grid-template-columns: 1fr; }
        .pagination-container { flex-direction: column; }
        .pagination { flex-wrap: wrap; justify-content: center; }
    }
</style>

<div class="claims-container">
    <div class="header">
        <h1>Claims List üßæ</h1>
        <a href="{% url 'claims_add' %}" class="add-btn">+ Add Claim</a>
    </div>
    
    {% if messages %}
        {% for message in messages %}
            <div style="padding: 12px 20px; margin-bottom: 20px; border-radius: 4px; 
                        background: {% if message.tags == 'error' %}#fee;{% else %}#d4edda;{% endif %}
                        color: {% if message.tags == 'error' %}#c33;{% else %}#155724;{% endif %}
                        border: 1px solid {% if message.tags == 'error' %}#fcc;{% else %}#c3e6cb;{% endif %}">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}
    
    <!-- Filter Section -->
    <div class="filter-section">
        <form method="GET" action="{% url 'claims_list' %}" class="filter-form" id="filterForm">
            <div class="filter-group">
                <label for="client"> üîçÔ∏éClient Name üë§</label>
                <input type="text" id="client" name="client" class="filter-input" 
                       placeholder="Search by client..." value="{{ request.GET.client }}">
            </div>
            
            <div class="filter-group">
                <label for="created_by"> üîçÔ∏éCreated By üë•</label>
                <input type="text" id="created_by" name="created_by" class="filter-input" 
                       placeholder="Search by user..." value="{{ request.GET.created_by }}">
            </div>
            
            <div class="filter-group">
                <label for="status">Status üìä</label>
                <select id="status" name="status" class="filter-select">
                    <option value="">All Status</option>
                    <option value="claimed" {% if request.GET.status == 'claimed' %}selected{% endif %}>Claimed</option>
                    <option value="approved" {% if request.GET.status == 'approved' %}selected{% endif %}>Approved</option>
                    <option value="rejected" {% if request.GET.status == 'rejected' %}selected{% endif %}>Rejected</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label for="expense_type">Expense Type üßæ</label>
                <select id="expense_type" name="expense_type" class="filter-select">
                    <option value="">All Types</option>
                    <option value="travel" {% if request.GET.expense_type == 'travel' %}selected{% endif %}>Travel/Public Transport</option>
                    <option value="food" {% if request.GET.expense_type == 'food' %}selected{% endif %}>Food/Meal</option>
                    <option value="accommodation" {% if request.GET.expense_type == 'accommodation' %}selected{% endif %}>Accommodation</option>
                    <option value="fuel" {% if request.GET.expense_type == 'fuel' %}selected{% endif %}>Fuel/Parking/Toll</option>
                    <option value="self" {% if request.GET.expense_type == 'self' %}selected{% endif %}>Self/Personal</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label for="date_from">Date From üìÖ</label>
                <input type="date" id="date_from" name="date_from" class="filter-input" value="{{ request.GET.date_from }}">
            </div>
            
            <div class="filter-group">
                <label for="date_to">Date To üìÖ</label>
                <input type="date" id="date_to" name="date_to" class="filter-input" value="{{ request.GET.date_to }}">
            </div>
            
            <div class="filter-group">
                <label>&nbsp;</label>
                <div class="filter-buttons">
                    <button type="submit" class="btn-filter">Filter</button>
                    <a href="{% url 'claims_list' %}" class="btn-clear" style="text-decoration: none; display: inline-flex; align-items: center; justify-content: center;">Clear</a>
                </div>
            </div>
        </form>
    </div>
    
    <div class="table-container">
        {% if claims %}
        <table>
            <thead>
                <tr>
                    <th>Date üìÖ</th>
                    <th>Client Name üë§</th>
                    <th>Expense Category üíµ</th>
                    <th>Amount ‚Çπ</th>
                    <th>Purpose of expense üìã</th>
                    <th>Receipt/Bill üìú</th>
                    <th>Created By üë§</th>
                    <th>Status üìä</th>
                    <th>Actions ‚öôÔ∏è</th>
                </tr>
            </thead>
            <tbody>
                {% for claim in claims %}
                <tr id="claim-row-{{ claim.id }}">
                    <td>{{ claim.created_at|date:"d M Y" }}</td>
                    <td><span class="client-name">{{ claim.client_name|default:"N/A" }}</span></td>
                    <td>
                        {% if claim.expense_type == 'travel' %}
                            <span class="expense-badge badge-travel">Travel/Public Transport</span>
                        {% elif claim.expense_type == 'food' %}
                            <span class="expense-badge badge-food">Food/Meal</span>
                        {% elif claim.expense_type == 'accommodation' %}
                            <span class="expense-badge badge-accommodation">Accommodation</span>
                        {% elif claim.expense_type == 'fuel' %}
                            <span class="expense-badge badge-fuel">Fuel/Parking/Toll</span>
                        {% elif claim.expense_type == 'self' %}
                            <span class="expense-badge badge-self">Self/Personal</span>
                        {% endif %}
                    </td>
                    <td class="amount">‚Çπ{{ claim.amount }}</td>
                    <td>{{ claim.description|truncatewords:10 }}</td>
                    <td style="text-align: center;">
                        {% if claim.receipt %}
                            <a href="{{ claim.receipt.url }}" target="_blank" class="receipt-icon" title="View Receipt">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                    <polyline points="14 2 14 8 20 8"></polyline>
                                    <line x1="16" y1="13" x2="8" y2="13"></line>
                                    <line x1="16" y1="17" x2="8" y2="17"></line>
                                    <polyline points="10 9 9 9 8 9"></polyline>
                                </svg>
                            </a>
                        {% else %}
                            <span style="color: #ccc;">‚Äî</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if claim.created_by %}
                            {{ claim.created_by.get_full_name|default:claim.created_by.username }}
                        {% else %}
                            N/A
                        {% endif %}
                    </td>
                    <td>
                        <select class="status-dropdown status-{{ claim.status }}" 
                                onchange="updateStatus({{ claim.id }}, this.value)"
                                data-original="{{ claim.status }}">
                            <option value="claimed" {% if claim.status == 'claimed' %}selected{% endif %}>Claimed</option>
                            <option value="approved" {% if claim.status == 'approved' %}selected{% endif %}>Approved</option>
                            <option value="rejected" {% if claim.status == 'rejected' %}selected{% endif %}>Rejected</option>
                        </select>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <a href="{% url 'claims_edit' claim.id %}" class="btn-edit">Edit</a>
                            <button type="button" class="btn-delete" onclick="deleteClaim({{ claim.id }})">Delete</button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="no-claims">
            <p>No claims found matching your filters.</p>
            <a href="{% url 'claims_list' %}" class="btn-clear" style="text-decoration: none;">Clear Filters</a>
        </div>
        {% endif %}
    </div>
    
    <!-- Pagination -->
    {% if claims %}
    <div class="pagination-container">
        <div class="pagination-info">
            Showing {{ claims.start_index }} to {{ claims.end_index }} of {{ claims.paginator.count }} claims
        </div>
        
        <ul class="pagination">
            {% if claims.has_previous %}
                <li>
                    <a href="?page=1{% if request.GET.client %}&client={{ request.GET.client }}{% endif %}{% if request.GET.created_by %}&created_by={{ request.GET.created_by }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.expense_type %}&expense_type={{ request.GET.expense_type }}{% endif %}{% if request.GET.date_from %}&date_from={{ request.GET.date_from }}{% endif %}{% if request.GET.date_to %}&date_to={{ request.GET.date_to }}{% endif %}">First</a>
                </li>
                <li>
                    <a href="?page={{ claims.previous_page_number }}{% if request.GET.client %}&client={{ request.GET.client }}{% endif %}{% if request.GET.created_by %}&created_by={{ request.GET.created_by }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.expense_type %}&expense_type={{ request.GET.expense_type }}{% endif %}{% if request.GET.date_from %}&date_from={{ request.GET.date_from }}{% endif %}{% if request.GET.date_to %}&date_to={{ request.GET.date_to }}{% endif %}">Previous</a>
                </li>
            {% else %}
                <li class="disabled"><span>First</span></li>
                <li class="disabled"><span>Previous</span></li>
            {% endif %}
            
            {% for num in claims.paginator.page_range %}
                {% if claims.number == num %}
                    <li class="active"><span>{{ num }}</span></li>
                {% elif num > claims.number|add:'-3' and num < claims.number|add:'3' %}
                    <li>
                        <a href="?page={{ num }}{% if request.GET.client %}&client={{ request.GET.client }}{% endif %}{% if request.GET.created_by %}&created_by={{ request.GET.created_by }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.expense_type %}&expense_type={{ request.GET.expense_type }}{% endif %}{% if request.GET.date_from %}&date_from={{ request.GET.date_from }}{% endif %}{% if request.GET.date_to %}&date_to={{ request.GET.date_to }}{% endif %}">{{ num }}</a>
                    </li>
                {% endif %}
            {% endfor %}
            
            {% if claims.has_next %}
                <li>
                    <a href="?page={{ claims.next_page_number }}{% if request.GET.client %}&client={{ request.GET.client }}{% endif %}{% if request.GET.created_by %}&created_by={{ request.GET.created_by }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.expense_type %}&expense_type={{ request.GET.expense_type }}{% endif %}{% if request.GET.date_from %}&date_from={{ request.GET.date_from }}{% endif %}{% if request.GET.date_to %}&date_to={{ request.GET.date_to }}{% endif %}">Next</a>
                </li>
                <li>
                    <a href="?page={{ claims.paginator.num_pages }}{% if request.GET.client %}&client={{ request.GET.client }}{% endif %}{% if request.GET.created_by %}&created_by={{ request.GET.created_by }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.expense_type %}&expense_type={{ request.GET.expense_type }}{% endif %}{% if request.GET.date_from %}&date_from={{ request.GET.date_from }}{% endif %}{% if request.GET.date_to %}&date_to={{ request.GET.date_to }}{% endif %}">Last</a>
                </li>
            {% else %}
                <li class="disabled"><span>Next</span></li>
                <li class="disabled"><span>Last</span></li>
            {% endif %}
        </ul>
    </div>
    {% endif %}
</div>

<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

async function updateStatus(claimId, newStatus) {
    const selectElement = document.querySelector(`#claim-row-${claimId} .status-dropdown`);
    const originalStatus = selectElement.getAttribute('data-original');

    const updateUrl = `{% url 'update_claim_status' 0 %}`.replace('0', claimId);

    try {
        const response = await fetch(updateUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ status: newStatus })
        });

        if (!response.ok) {
            const text = await response.text();
            throw new Error(`HTTP ${response.status}: ${text}`);
        }

        const result = await response.json();

        if (result.success) {
            selectElement.className = `status-dropdown status-${newStatus}`;
            selectElement.setAttribute('data-original', newStatus);
            showMessage('Status updated successfully!', 'success');
        } else {
            selectElement.value = originalStatus;
            showMessage('Failed to update status: ' + (result.error || 'Unknown error'), 'error');
        }
    } catch (error) {
        console.error('Error updating status:', error);
        selectElement.value = originalStatus;
        showMessage('Error updating status', 'error');
    }
}

async function deleteClaim(claimId) {
    if (!confirm('Are you sure you want to delete this claim?')) {
        return;
    }

    const deleteUrl = `{% url 'claims_delete' 0 %}`.replace('0', claimId);

    try {
        const response = await fetch(deleteUrl, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        });

        if (!response.ok) {
            const text = await response.text();
            throw new Error(`HTTP ${response.status}: ${text}`);
        }

        const result = await response.json();

        if (result.success) {
            const row = document.getElementById(`claim-row-${claimId}`);
            row.style.opacity = '0';
            setTimeout(() => {
                row.remove();
                const tbody = document.querySelector('tbody');
                if (tbody.children.length === 0) {
                    location.reload();
                }
            }, 300);
            showMessage('Claim deleted successfully!', 'success');
        } else {
            showMessage('Failed to delete claim: ' + (result.error || 'Unknown error'), 'error');
        }
    } catch (error) {
        console.error('Error deleting claim:', error);
        showMessage('Error deleting claim', 'error');
    }
}

function showMessage(text, type) {
    const existingMessages = document.querySelectorAll('.flash-message');
    existingMessages.forEach(msg => msg.remove());

    const messageDiv = document.createElement('div');
    messageDiv.className = 'flash-message';
    messageDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 4px;
        background: ${type === 'success' ? '#d4edda' : '#f8d7da'};
        color: ${type === 'success' ? '#155724' : '#721c24'};
        border: 1px solid ${type === 'success' ? '#c3e6cb' : '#f5c6cb'};
        z-index: 10000;
        animation: slideIn 0.3s ease-out;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    `;
    messageDiv.textContent = text;
    document.body.appendChild(messageDiv);

    setTimeout(() => {
        messageDiv.style.animation = 'slideOut 0.3s ease-in';
        setTimeout(() => {
            messageDiv.remove();
        }, 300);
    }, 3000);
}

const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    @keyframes slideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
`;
document.head.appendChild(style);
</script>
{% endblock %}