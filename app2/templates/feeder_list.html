{% extends "base.html" %}
{% load app2_extras %}
{% block content %}
<style>
  .module-badge {
  display: inline-block;
  background: #e9ecef;
  color: #495057;
  padding: 2px 6px;
  border-radius: 3px;
  margin: 2px;
  font-size: 11px;
  white-space: nowrap;
}

.container-fluid {
  background: #fff;
  padding: 30px;
  border-radius: 10px;
  max-width: 1400px;
  margin: auto;
  box-shadow: 0 0 10px rgba(0,0,0,0.1);
}

.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 10px;
  margin-bottom: 20px;
}

.breadcrumb {
  font-size: 14px;
  color: #888;
}

h2 {
  margin: 0;
  font-size: 24px;
  color: #333;
}

.add-btn {
  background-color: #4d6bf9;
  color: white;
  padding: 10px 20px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  text-decoration: none;
  font-size: 14px;
  display: inline-block;
}

.add-btn:hover {
  background-color: #3d5af1;
}

.search-box {
  margin-bottom: 0;
}

.search-box input {
  padding: 10px 12px;
  border: 1px solid #ddd;
  border-radius: 6px;
  width: 300px;
  font-size: 14px;
}

.total-count {
  color: #666;
  font-size: 14px;
  margin-bottom: 10px;
}

.table-container {
  overflow-x: auto;
  overflow-y: visible;
  margin-top: 20px;
}

table {
  width: 100%;
  border-collapse: collapse;
  min-width: 1300px;
  position: relative;
}

th, td {
  padding: 12px 8px;
  text-align: left;
  border-bottom: 1px solid #ddd;
  font-size: 14px;
  vertical-align: middle;
}

th {
  background-color: #f8f9fa;
  font-weight: bold;
  color: #333;
  position: sticky;
  top: 0;
  z-index: 10;
}

tbody tr {
  position: relative;
}

tbody tr:hover {
  background-color: #f5f5f5;
}

.actions {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}

.btn {
  padding: 5px 10px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 12px;
  text-decoration: none;
  display: inline-block;
}

.btn-edit {
  background-color: #17a2b8;
  color: white;
}

.btn-edit:hover {
  background-color: #138496;
}

.btn-delete {
  background-color: #dc3545;
  color: white;
}

.btn-delete:hover {
  background-color: #c82333;
}

.no-data {
  text-align: center;
  padding: 40px;
  color: #888;
}

/* Status Styles - FIXED OVERLAP */
.status-dropdown {
  position: relative;
  display: inline-block;
}

tbody tr {
  position: relative;
  z-index: 1;
}

tbody tr:has(.status-dropdown .show) {
  z-index: 1001;
}

.status-btn {
  padding: 6px 12px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 12px;
  font-weight: bold;
  min-width: 120px;
  text-align: center;
  display: inline-block;
  position: relative;
  z-index: 1;
}

.status-pending {
  background-color: #fff3cd;
  color: #856404;
}

.status-accepted {
  background-color: #e0f2f1;
  color: #00695c;
}

.status-rejected {
  background-color: #ffebee;
  color: #c62828;
}

.status-under-process {
  background-color: #e3f2fd;
  color: #1565c0;
}

.status-key-uploaded {
  background-color: #d1c4e9;
  color: #4a148c;
}

.status-dropdown-content {
  display: none;
  position: absolute;
  background-color: #ffffff;
  min-width: 160px;
  box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.3);
  z-index: 10000;
  border-radius: 4px;
  top: calc(100% + 2px);
  left: 0;
  border: 1px solid #ddd;
}

.status-dropdown-content.show {
  display: block !important;
  visibility: visible !important;
  opacity: 1 !important;
}

.status-dropdown-content button {
  background-color: transparent;
  color: #333;
  padding: 10px 16px;
  text-decoration: none;
  display: block;
  border: none;
  width: 100%;
  text-align: left;
  cursor: pointer;
  font-size: 13px;
  transition: background-color 0.2s;
}

.status-dropdown-content button:hover {
  background-color: #f1f1f1;
}

.status-dropdown-content button:first-child {
  border-radius: 4px 4px 0 0;
}

.status-dropdown-content button:last-child {
  border-radius: 0 0 4px 4px;
}

.modules-cell {
  max-width: 220px;
  overflow: visible;
}

.pagination-wrapper {
  display: flex;
  justify-content: center;
  margin-top: 30px;
}

.pagination {
  display: flex;
  list-style: none;
  padding: 0;
  border: 1px solid #ccc;
  border-radius: 8px;
  overflow: hidden;
}

.pagination li {
  display: inline-block;
}

.pagination a, .pagination span {
  display: block;
  padding: 8px 14px;
  text-decoration: none;
  color: #333;
  border-right: 1px solid #ccc;
  font-size: 14px;
  background: white;
}

.pagination li:last-child a, .pagination li:last-child span {
  border-right: none;
}

.pagination .active span {
  background-color: #4d6bf9;
  color: white;
  font-weight: bold;
}

.pagination a:hover {
  background-color: #f0f0f0;
}

.pagination .disabled a {
  pointer-events: none;
  color: #ccc;
  background-color: #f9f9f9;
}

.search-filter-section {
  margin-bottom: 20px;
}

.filter-form {
  display: flex;
  flex-wrap: wrap;
  gap: 15px;
  align-items: center;
}

select {
  padding: 10px 12px;
  border: 1px solid #ddd;
  border-radius: 6px;
  background: white;
  font-size: 14px;
  min-width: 150px;
  cursor: pointer;
}

.clear-btn {
  padding: 10px 16px;
  background: #6c757d;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
}

.clear-btn:hover {
  background: #5a6268;
}

@media (max-width: 768px) {
  .header {
    flex-direction: column;
    align-items: flex-start;
  }

  .filter-form {
    flex-direction: column;
    align-items: stretch;
  }

  .search-box input,
  select,
  .add-btn,
  .clear-btn {
    width: 100%;
  }

  .actions {
    flex-direction: column;
    gap: 5px;
  }
}
</style>

<div class="container-fluid">
  <div class="header">
    <div>
      <div class="breadcrumb">Home / Feeder / List</div>
      <h2>Feeder List</h2>
    </div>
  </div>

  <div class="search-filter-section">
    <form method="get" id="filter-form" class="filter-form">
      <div>
        <a href="{% url 'feeder' %}" class="add-btn">+ Add New Feeder</a>
      </div>
      
      <div class="search-box">
        <input type="text" 
               name="q" 
               id="search-input"
               placeholder="Search by name, software, or branch..." 
               value="{{ query }}">
      </div>

      <select name="branch" id="branch-select">
        <option value="">All Branches</option>
        {% for b in branches %}
          <option value="{{ b.name }}" {% if request.GET.branch == b.name %}selected{% endif %}>{{ b.name }}</option>
        {% endfor %}
      </select>

      <select name="status" id="status-select">
        <option value="">All Status</option>
        <option value="pending" {% if request.GET.status == 'pending' %}selected{% endif %}>Pending</option>
        <option value="accepted" {% if request.GET.status == 'accepted' %}selected{% endif %}>Accepted</option>
        <option value="key_uploaded" {% if request.GET.status == 'key_uploaded' %}selected{% endif %}>Key Uploaded</option>
        <option value="rejected" {% if request.GET.status == 'rejected' %}selected{% endif %}>Rejected</option>
        <option value="under_process" {% if request.GET.status == 'under_process' %}selected{% endif %}>Under Process</option>
      </select>

      <button type="button" id="clear-filters" class="clear-btn">
        Clear All
      </button>
    </form>
  </div>

  <div class="total-count">
    Total Records: {{ page_obj.paginator.count }}
  </div>

  <div class="table-container">
    {% if page_obj %}
    <table>
      <thead>
        <tr>
          <th>S.No</th>
          <th>Name</th>
          <th>Software</th>
          <th>Branch</th>
          <th>Installation Date</th>
          <th>Software Amount</th>
          <th>More Modules</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for feeder in page_obj %}
        <tr>
          <td>{{ forloop.counter0|add:page_obj.start_index }}</td>
          <td style="text-transform: uppercase; font-weight: bold;">{{ feeder.name }}</td>
          <td>{{ feeder.software }}</td>
          <td>{{ feeder.branch }}</td>
          <td>{{ feeder.installation_date|date:"d-m-Y" }}</td>
          <td>₹{{ feeder.module_charges|default:feeder.software_amount|floatformat:2 }}</td>
          <td class="modules-cell">
            {% if feeder.more_modules_list %}
              {% for m in feeder.more_modules_list %}
                <span class="module-badge">
                  {{ m }}
                  {% if m|lower != "ultimate" and m|lower != "i-care" and m|lower != "b-care" %}
                    <span class="module-price">
                      ₹{{ feeder.price_dict|get_item:m|floatformat:2|default:"0.00" }}
                    </span>
                  {% endif %}
                </span>
              {% endfor %}
            {% else %}
              <span style="color: #999;">None</span>
            {% endif %}
          </td>
          <td>
            {% if 'feeder_status' in allowed_menus %}
            <div class="status-dropdown" id="status-dropdown-{{ feeder.id }}">
              <button type="button" 
                      class="status-btn {{ feeder.get_status_display_class }}" 
                      id="status-btn-{{ feeder.id }}"
                      data-feeder-id="{{ feeder.id }}"
                      data-current-status="{{ feeder.status }}"
                      onclick="toggleStatusDropdown({{ feeder.id }}, event)">
                {{ feeder.get_status_display }}
              </button>
              <div class="status-dropdown-content">
                <button type="button" onclick="updateStatus({{ feeder.id }}, 'pending', event)">Pending</button>
                <button type="button" onclick="updateStatus({{ feeder.id }}, 'accepted', event)">Accepted</button>
                <button type="button" onclick="updateStatus({{ feeder.id }}, 'key_uploaded', event)">Key Uploaded</button>
                <button type="button" onclick="updateStatus({{ feeder.id }}, 'rejected', event)">Rejected</button>
                <button type="button" onclick="updateStatus({{ feeder.id }}, 'under_process', event)">Under Process</button>
              </div>
            </div>
            {% else %}
            <span class="status-btn {{ feeder.get_status_display_class }}">
              {{ feeder.get_status_display }}
            </span>
            {% endif %}
          </td>
          <td class="actions">
            <a href="{% url 'feeder_edit' feeder.id %}" class="btn btn-edit">Edit</a>
            <form method="post" action="{% url 'feeder_delete' feeder.id %}" style="display:inline; margin: 0;" onsubmit="return confirm('Are you sure you want to delete this feeder?')">
              {% csrf_token %}
              <button type="submit" class="btn btn-delete">Delete</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <div class="no-data">
      <p>No feeders found. <a href="{% url 'feeder' %}">Add your first feeder</a></p>
    </div>
    {% endif %}

    {% if page_obj %}
    <div class="pagination-wrapper">
      <ul class="pagination">
        {% if page_obj.has_previous %}
          <li><a href="?page=1{% if query %}&q={{ query }}{% endif %}{% if request.GET.branch %}&branch={{ request.GET.branch }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}">&laquo;</a></li>
          <li><a href="?page={{ page_obj.previous_page_number }}{% if query %}&q={{ query }}{% endif %}{% if request.GET.branch %}&branch={{ request.GET.branch }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}">&lsaquo;</a></li>
        {% else %}
          <li class="disabled"><a>&laquo;</a></li>
          <li class="disabled"><a>&lsaquo;</a></li>
        {% endif %}

        {% for num in page_obj.paginator.page_range %}
          {% if num == page_obj.number %}
            <li class="active"><span>{{ num }}</span></li>
          {% elif num >= page_obj.number|add:'-2' and num <= page_obj.number|add:'2' %}
            <li><a href="?page={{ num }}{% if query %}&q={{ query }}{% endif %}{% if request.GET.branch %}&branch={{ request.GET.branch }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}">{{ num }}</a></li>
          {% elif num == 1 or num == page_obj.paginator.num_pages %}
            <li><a href="?page={{ num }}{% if query %}&q={{ query }}{% endif %}{% if request.GET.branch %}&branch={{ request.GET.branch }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}">{{ num }}</a></li>
          {% elif num == page_obj.number|add:'-3' or num == page_obj.number|add:'3' %}
            <li><span>…</span></li>
          {% endif %}
        {% endfor %}

        {% if page_obj.has_next %}
          <li><a href="?page={{ page_obj.next_page_number }}{% if query %}&q={{ query }}{% endif %}{% if request.GET.branch %}&branch={{ request.GET.branch }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}">&rsaquo;</a></li>
          <li><a href="?page={{ page_obj.paginator.num_pages }}{% if query %}&q={{ query }}{% endif %}{% if request.GET.branch %}&branch={{ request.GET.branch }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}">&raquo;</a></li>
        {% else %}
          <li class="disabled"><a>&rsaquo;</a></li>
          <li class="disabled"><a>&raquo;</a></li>
        {% endif %}
      </ul>
    </div>
    {% endif %}
  </div>
</div>

<script>
// Get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Toggle status dropdown
function toggleStatusDropdown(feederId, event) {
    console.log('toggleStatusDropdown called for feeder:', feederId);
    
    if (event) {
        event.stopPropagation();
        event.preventDefault();
    }
    
    const dropdown = document.querySelector(`#status-dropdown-${feederId}`);
    const dropdownContent = dropdown.querySelector('.status-dropdown-content');
    
    if (!dropdownContent) {
        console.error('Dropdown content not found for feeder:', feederId);
        return;
    }
    
    // Close all other dropdowns and reset their row z-index
    document.querySelectorAll('.status-dropdown-content').forEach(d => {
        if (d !== dropdownContent) {
            d.classList.remove('show');
            const parentRow = d.closest('tr');
            if (parentRow) {
                parentRow.style.zIndex = '1';
            }
        }
    });
    
    // Toggle current dropdown
    const isShowing = dropdownContent.classList.toggle('show');
    
    // Set z-index on the parent row
    const parentRow = dropdown.closest('tr');
    if (parentRow) {
        parentRow.style.zIndex = isShowing ? '1001' : '1';
    }
    
    console.log('Toggled dropdown, show class:', dropdownContent.classList.contains('show'));
}

// Close dropdown when clicking outside
document.addEventListener('click', function(event) {
    if (!event.target.closest('.status-dropdown')) {
        document.querySelectorAll('.status-dropdown-content').forEach(d => {
            d.classList.remove('show');
            const parentRow = d.closest('tr');
            if (parentRow) {
                parentRow.style.zIndex = '1';
            }
        });
        console.log('Closed all dropdowns due to outside click');
    }
});

// Update status function
function updateStatus(feederId, newStatus, event) {
    console.log('updateStatus called:', feederId, newStatus);
    
    if (event) {
        event.stopPropagation();
        event.preventDefault();
    }
    
    // Close the dropdown immediately
    const dropdown = document.querySelector(`#status-dropdown-${feederId}`);
    const dropdownContent = dropdown.querySelector('.status-dropdown-content');
    if (dropdownContent) {
        dropdownContent.classList.remove('show');
        const parentRow = dropdown.closest('tr');
        if (parentRow) {
            parentRow.style.zIndex = '1';
        }
    }
    
    const csrftoken = getCookie('csrftoken');
    const statusBtn = document.getElementById(`status-btn-${feederId}`);
    
    if (!statusBtn) {
        console.error('Status button not found for feeder:', feederId);
        return;
    }
    
    const originalText = statusBtn.textContent;
    const originalClass = statusBtn.className;

    // Show loading state
    statusBtn.textContent = 'Updating...';
    statusBtn.disabled = true;
    
    // Make the AJAX request
    fetch(`/feeder/${feederId}/status-update/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({ 
            status: newStatus 
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // Update button with new status
            statusBtn.textContent = data.new_status;
            statusBtn.className = `status-btn ${data.status_class}`;
            statusBtn.setAttribute('data-current-status', newStatus);
        } else {
            throw new Error(data.error || 'Unknown error occurred');
        }
    })
    .catch(error => {
        console.error('Error updating status:', error);
        
        // Restore original state
        statusBtn.textContent = originalText;
        statusBtn.className = originalClass;
        
        // Show error message to user
        alert(`Error updating status: ${error.message}`);
    })
    .finally(() => {
        // Re-enable button
        statusBtn.disabled = false;
    });
}

// Filter form functionality
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded - initializing feeder list functionality');
    
    const searchInput = document.getElementById('search-input');
    const branchSelect = document.getElementById('branch-select');
    const statusSelect = document.getElementById('status-select');
    const clearButton = document.getElementById('clear-filters');
    const filterForm = document.getElementById('filter-form');
    
    let searchTimeout;
    let lastSearchValue = searchInput ? searchInput.value : '';

    // Auto-submit form with debounce for search input
    function debounceSearch() {
        clearTimeout(searchTimeout);
        const currentValue = searchInput.value;
        
        // Only trigger search if value has changed
        if (currentValue !== lastSearchValue) {
            searchTimeout = setTimeout(() => {
                lastSearchValue = currentValue;
                filterForm.submit();
            }, 500);
        }
    }

    // Event listeners
    if (searchInput) {
        searchInput.addEventListener('input', debounceSearch);
        searchInput.addEventListener('keyup', function(e) {
            if (e.key === 'Enter') {
                clearTimeout(searchTimeout);
                lastSearchValue = searchInput.value;
                filterForm.submit();
            }
        });
    }

    if (branchSelect) {
        branchSelect.addEventListener('change', () => filterForm.submit());
    }

    if (statusSelect) {
        statusSelect.addEventListener('change', () => filterForm.submit());
    }

    // Clear all filters
    if (clearButton) {
        clearButton.addEventListener('click', function() {
            searchInput.value = '';
            branchSelect.value = '';
            statusSelect.value = '';
            
            // Submit form to clear filters
            window.location.href = window.location.pathname;
        });
    }

    // Show loading cursor during form submission
    filterForm.addEventListener('submit', function() {
        document.body.style.cursor = 'wait';
    });
    
    // Check CSRF token
    const csrfToken = getCookie('csrftoken');
    if (!csrfToken) {
        console.warn('CSRF token not found. Status updates may fail.');
    }
    
    // Debug: Check if dropdown elements exist
    const dropdowns = document.querySelectorAll('.status-dropdown');
    console.log('Found status dropdowns:', dropdowns.length);
    dropdowns.forEach((dropdown, index) => {
        const content = dropdown.querySelector('.status-dropdown-content');
        console.log(`Dropdown ${index}:`, {
            id: dropdown.id,
            hasContent: !!content,
            contentVisible: content ? window.getComputedStyle(content).display : 'N/A'
        });
    });
});
</script>

{% endblock %}