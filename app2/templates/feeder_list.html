{% extends "base.html" %}
{% load app2_extras %}
{% block content %}
<style>
  .module-badge {
    display: block;
    background: #e9ecef;
    color: #495057;
    padding: 2px 6px;
    border-radius: 3px;
    margin-bottom: 2px;
    font-size: 11px;
    white-space: nowrap;
  }

  .container {
    background: #fff;
    padding: 30px;
    border-radius: 10px;
    max-width: 1400px;
    margin: auto;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
  }

  .header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 20px;
  }

  .breadcrumb {
    font-size: 14px;
    color: #888;
  }

  h2 {
    margin: 0;
    font-size: 24px;
    color: #333;
  }

  .add-btn {
    background-color: #4d6bf9;
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    text-decoration: none;
    font-size: 14px;
  }

  .add-btn:hover {
    background-color: #3d5af1;
  }

  .search-box {
    margin-bottom: 20px;
  }

  .search-box input {
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    width: 100%;
    max-width: 300px;
    font-size: 14px;
  }

  .total-count {
    color: #666;
    font-size: 14px;
    margin-bottom: 10px;
  }

  .table-container {
    overflow-x: auto;
    margin-top: 20px;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    min-width: 1300px;
  }

  th, td {
    padding: 12px 8px;
    text-align: left;
    border-bottom: 1px solid #ddd;
    font-size: 14px;
  }

  th {
    background-color: #f8f9fa;
    font-weight: bold;
    color: #333;
    position: sticky;
    top: 0;
  }

  tr:hover {
    background-color: #f5f5f5;
  }

  .actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }

  .btn {
    padding: 5px 10px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    text-decoration: none;
  }

  .btn-edit {
    background-color: #17a2b8;
    color: white;
  }

  .btn-delete {
    background-color: #dc3545;
    color: white;
  }

  .btn-view {
    background-color: #28a745;
    color: white;
  }

  .no-data {
    text-align: center;
    padding: 40px;
    color: #888;
  }

  /* Status Styles */
  .status-dropdown {
    position: relative;
    display: inline-block;
  }

  .status-btn {
    padding: 6px 12px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    font-weight: bold;
    min-width: 100px;
    text-align: center;
  }

  .status-pending {
  background-color: #fff3cd;  /* Light yellow */
  color: #856404;             /* Dark amber text */
}

.status-accepted {
  background-color: #e0f2f1;
  color: #00695c;
}

.status-rejected {
  background-color: #ffebee;
  color: #c62828;
}

.status-under-process {
  background-color: #e3f2fd;
  color: #1565c0;
}

.status-key-uploaded {
  background-color: #d1c4e9;  /* Soft purple */
  color: #4a148c;             /* Deep purple text */
}



  .status-dropdown-content {
    display: none;
    position: absolute;
    background-color: #f9f9f9;
    min-width: 160px;
    box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
    z-index: 1;
    border-radius: 4px;
    top: 100%;
    left: 0;
  }

  .status-dropdown-content button {
    background-color: transparent;
    color: black;
    padding: 8px 16px;
    text-decoration: none;
    display: block;
    border: none;
    width: 100%;
    text-align: left;
    cursor: pointer;
    font-size: 12px;
  }

  .status-dropdown-content button:hover {
    background-color: #f1f1f1;
  }

  .status-dropdown:hover .status-dropdown-content {
    display: block;
  }

  .modules-cell {
    max-width: 200px;
    overflow: hidden;
  }

  .pagination-wrapper {
    display: flex;
    justify-content: center;
    margin-top: 30px;
  }

  .pagination {
    display: flex;
    list-style: none;
    padding: 0;
    border: 1px solid #ccc;
    border-radius: 8px;
    overflow: hidden;
  }

  .pagination li {
    display: inline-block;
  }

  .pagination a, .pagination span {
    display: block;
    padding: 8px 14px;
    text-decoration: none;
    color: #333;
    border-right: 1px solid #ccc;
    font-size: 14px;
    background: white;
  }

  .pagination li:last-child a, .pagination li:last-child span {
    border-right: none;
  }

  .pagination .active span {
    background-color: #4d6bf9;
    color: white;
    font-weight: bold;
  }

  .pagination a:hover {
    background-color: #f0f0f0;
  }

  .pagination .disabled a {
    pointer-events: none;
    color: #ccc;
    background-color: #f9f9f9;
  }

  @media (max-width: 768px) {
    .header {
      flex-direction: column;
      align-items: flex-start;
    }

    .add-btn {
      width: 100%;
      text-align: center; 
    }

    .search-box input {
      width: 100%;
    }

    .actions {
      flex-direction: column;
      gap: 5px;
    }
  }

  @media (max-width: 480px) {
    h2 {
      font-size: 20px;
    }

    .btn {
      font-size: 11px;
      padding: 6px 8px;
    }

    .status-btn {
      font-size: 10px;
    }
  }
</style>

<div class="container-fluid">
  <div class="header">
    <div>
      <div class="breadcrumb">Home / Feeder / List</div>
      <h2>Feeder List</h2>
    </div>
    <a href="{% url 'feeder' %}" class="add-btn">+ Add New Feeder</a>
  </div>

  <form method="get" id="filter-form" style="display: flex; flex-wrap: wrap; gap: 10px;">
  <input type="text" name="q" placeholder="Search..." value="{{ query }}">

  <select name="branch" id="branch-select">
    <option value="">All Branches</option>
    {% for b in branches %}
      <option value="{{ b.name }}" {% if request.GET.branch == b.name %}selected{% endif %}>{{ b.name }}</option>
    {% endfor %}
  </select>

  <select name="status" id="status-select">
    <option value="">All Status</option>
    <option value="pending" {% if request.GET.status == 'pending' %}selected{% endif %}>Pending</option>
    <option value="accepted" {% if request.GET.status == 'accepted' %}selected{% endif %}>Accepted</option>
    <option value="key_uploaded" {% if request.GET.status == 'key_uploaded' %}selected{% endif %}>Key Uploaded</option>
    <option value="rejected" {% if request.GET.status == 'rejected' %}selected{% endif %}>Rejected</option>
    <option value="under_process" {% if request.GET.status == 'under_process' %}selected{% endif %}>Under Process</option>
  </select>
</form>

  <button type="submit" class="add-btn" style="padding: 10px 16px;">Filter</button>
</form>

  <div class="total-count">
    Total Records: {{ page_obj.paginator.count }}
  </div>

  <div class="table-container">
    {% if page_obj %}
    <table>
      <thead>
        <tr>
          <th>S.No</th>
          <th>Name</th>
          <th>Software</th>
          <th>Branch</th>
          <th>Installation Date</th>
          <th>Software Amount</th>
          <th>More Modules</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for feeder in page_obj %}
        <tr>
          <td>{{ forloop.counter0|add:page_obj.start_index }}</td>
          <td style="text-transform: uppercase; font-weight: bold;">{{ feeder.name }}</td>
          <td>{{ feeder.software }}</td>
          <td>{{ feeder.branch }}</td>
          <td>{{ feeder.installation_date|date:"d-m-Y" }}</td>
          <td>₹{{ feeder.module_charges|default:feeder.software_amount|floatformat:2 }}</td>
          <td class="modules-cell">
            {% if feeder.more_modules_list %}
              {% for m in feeder.more_modules_list %}
                <span class="module-badge">
                  {{ m }}
                  {% if m|lower != "ultimate" and m|lower != "i-care" and m|lower != "b-care" %}
                    <span class="module-price">
                      ₹{{ feeder.price_dict|get_item:m|floatformat:2|default:"0.00" }}
                    </span>
                  {% endif %}
                </span>
              {% endfor %}
            {% else %}
              <span class="text-muted">None</span>
            {% endif %}
          </td>
          <td>
            <div class="status-dropdown">
              <button class="status-btn {{ feeder.get_status_display_class }}" 
                      id="status-btn-{{ feeder.id }}"
                      data-feeder-id="{{ feeder.id }}"
                      data-current-status="{{ feeder.status }}">
                {{ feeder.get_status_display }}
              </button>
              <div class="status-dropdown-content">
                <button type="button" onclick="updateStatus({{ feeder.id }}, 'pending')" 
                        data-status="pending">Pending</button>
                <button type="button" onclick="updateStatus({{ feeder.id }}, 'accepted')" 
                        data-status="accepted">Accepted</button>
<button type="button" onclick="updateStatus({{ feeder.id }}, 'key_uploaded')" 
                        data-status="accepted">Key Uploaded</button>
                <button type="button" onclick="updateStatus({{ feeder.id }}, 'rejected')" 
                        data-status="rejected">Rejected</button>
                <button type="button" onclick="updateStatus({{ feeder.id }}, 'under_process')" 
                        data-status="under_process">Under Process</button>
              </div>
            </div>
          </td>
          <td class="actions">
            <a href="{% url 'feeder_edit' feeder.id %}" class="btn btn-edit">Edit</a>
            <form method="post" action="{% url 'feeder_delete' feeder.id %}" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this feeder?')">
              {% csrf_token %}
              <button type="submit" class="btn btn-delete">Delete</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <div class="no-data">
      <p>No feeders found. <a href="{% url 'feeder' %}">Add your first feeder</a></p>
    </div>
    {% endif %}

    <div class="pagination-wrapper">
      <ul class="pagination">
        {% if page_obj.has_previous %}
          <li><a href="?page=1{% if query %}&q={{ query }}{% endif %}">&laquo;</a></li>
          <li><a href="?page={{ page_obj.previous_page_number }}{% if query %}&q={{ query }}{% endif %}">&lsaquo;</a></li>
        {% else %}
          <li class="disabled"><a>&laquo;</a></li>
          <li class="disabled"><a>&lsaquo;</a></li>
        {% endif %}

        {% for num in page_obj.paginator.page_range %}
          {% if num == page_obj.number %}
            <li class="active"><span>{{ num }}</span></li>
          {% elif num >= page_obj.number|add:'-2' and num <= page_obj.number|add:'2' %}
            <li><a href="?page={{ num }}{% if query %}&q={{ query }}{% endif %}">{{ num }}</a></li>
          {% elif num == 1 or num == page_obj.paginator.num_pages %}
            <li><a href="?page={{ num }}{% if query %}&q={{ query }}{% endif %}">{{ num }}</a></li>
          {% elif num == page_obj.number|add:'-3' or num == page_obj.number|add:'3' %}
            <li><span>…</span></li>
          {% endif %}
        {% endfor %}

        {% if page_obj.has_next %}
          <li><a href="?page={{ page_obj.next_page_number }}{% if query %}&q={{ query }}{% endif %}">&rsaquo;</a></li>
          <li><a href="?page={{ page_obj.paginator.num_pages }}{% if query %}&q={{ query }}{% endif %}">&raquo;</a></li>
        {% else %}
          <li class="disabled"><a>&rsaquo;</a></li>
          <li class="disabled"><a>&raquo;</a></li>
        {% endif %}
      </ul>
    </div>
  </div>
</div>
<script>
  document.getElementById('branch-select').addEventListener('change', function() {
    document.getElementById('filter-form').submit();
  });

  document.getElementById('status-select').addEventListener('change', function() {
    document.getElementById('filter-form').submit();
  });
</script>

<script>
// Get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function updateStatus(feederId, newStatus) {
    const csrftoken = getCookie('csrftoken');
    const statusBtn = document.getElementById(`status-btn-${feederId}`); // FIXED: Added backticks
    
    if (!statusBtn) {
        console.error('Status button not found for feeder:', feederId);
        return;
    }
    
    const originalText = statusBtn.textContent;
    const originalClass = statusBtn.className;

    // Show loading state
    statusBtn.textContent = 'Updating...';
    statusBtn.disabled = true;

    // Make the AJAX request - FIXED: Added backticks and corrected URL
    fetch(`/feeder/${feederId}/status-update/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({ 
            status: newStatus 
        })
    })
    .then(response => {
        console.log('Response status:', response.status);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`); // FIXED: Added backticks
        }
        
        return response.json();
    })
    .then(data => {
        console.log('Response data:', data);
        
        if (data.success) {
            // Update button with new status
            statusBtn.textContent = data.new_status;
            statusBtn.className = `status-btn ${data.status_class}`; // FIXED: Added backticks
            
            // Show success message (optional)
            console.log('Status updated successfully');
        } else {
            throw new Error(data.error || 'Unknown error occurred');
        }
    })
    .catch(error => {
        console.error('Error updating status:', error);
        
        // Restore original state
        statusBtn.textContent = originalText;
        statusBtn.className = originalClass;
        
        // Show error message to user
        alert(`Error updating status: ${error.message}`); // FIXED: Added backticks
    })
    .finally(() => {
        // Re-enable button
        statusBtn.disabled = false;
    });
}

// Helper function to get status class (keeping your existing logic)
function getStatusClass(status) {
    const statusClasses = {
        'pending': 'status-pending',
        'accepted': 'status-accepted',
        'rejected': 'status-rejected',
        'under_process': 'status-under-process',
        'key_uploaded': 'status-key-uploaded',
    };
    return statusClasses[status] || 'status-pending';
}

// Add some debugging
document.addEventListener('DOMContentLoaded', function() {
    console.log('Feeder list page loaded');
    
    // Check if CSRF token is available
    const csrfToken = getCookie('csrftoken');
    if (!csrfToken) {
        console.warn('CSRF token not found. This may cause issues with status updates.');
    }
});
</script>

{% endblock %}