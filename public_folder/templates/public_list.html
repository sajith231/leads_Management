{% extends "base.html" %}
{% load static %}
{% block content %}
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: #f5f7fa;
      line-height: 1.6;
    }
    .container {
      max-width: 1200px;
      margin: 20px auto;
      padding: 0 20px;
    }
    .card {
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
      overflow: hidden;
      margin-bottom: 20px;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 24px 28px;
      border-bottom: 1px solid #e5e7eb;
      flex-wrap: wrap;
      gap: 16px;
    }
    .header h2 {
      font-size: 24px;
      font-weight: 600;
      color: #1a202c;
      margin: 0;
    }
    .header-subtitle {
      font-size: 14px;
      color: #6b7280;
      margin-top: 4px;
    }
    .header-actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    .btn-add {
      display: inline-block;
      padding: 10px 20px;
      background: #3b82f6;
      color: #ffffff;
      text-decoration: none;
      border-radius: 8px;
      font-weight: 600;
      font-size: 14px;
      transition: background 0.2s;
      border: none;
      cursor: pointer;
    }
    .btn-add:hover {
      background: #2563eb;
    }
    .btn-whatsapp {
      background: #25d366;
      padding: 10px 20px;
      color: #ffffff;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .btn-whatsapp:hover {
      background: #20ba5a;
    }
    .btn-copy {
      background: #8b5cf6;
      padding: 10px 20px;
      color: #ffffff;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .btn-copy:hover {
      background: #7c3aed;
    }

    /* Filter Section */
    .filter-section {
      padding: 20px 28px;
      background: #f9fafb;
      border-bottom: 1px solid #e5e7eb;
    }
    .filter-form {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: flex-end;
    }
    .filter-group {
      flex: 1;
      min-width: 200px;
    }
    .filter-group label {
      display: block;
      margin-bottom: 6px;
      font-weight: 500;
      color: #374151;
      font-size: 13px;
    }
    .filter-group input {
      width: 100%;
      padding: 10px 14px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.2s;
    }
    .filter-group input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    .filter-buttons {
      display: flex;
      gap: 8px;
    }
    .btn-filter {
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
      white-space: nowrap;
    }
    .btn-search {
      background: #3b82f6;
      color: #ffffff;
    }
    .btn-search:hover {
      background: #2563eb;
    }
    .btn-reset {
      background: #f3f4f6;
      color: #374151;
    }
    .btn-reset:hover {
      background: #e5e7eb;
    }
    .results-info {
      padding: 12px 28px;
      background: #eff6ff;
      border-bottom: 1px solid #e5e7eb;
      font-size: 14px;
      color: #1e40af;
    }

    .table-wrapper {
      overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    thead {
      background: #f9fafb;
    }
    th {
      padding: 14px 16px;
      text-align: left;
      font-weight: 600;
      color: #374151;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 2px solid #e5e7eb;
    }
    td {
      padding: 16px;
      border-bottom: 1px solid #f3f4f6;
      vertical-align: top;
    }
    tbody tr {
      transition: background 0.15s;
    }
    tbody tr:hover {
      background: #f9fafb;
    }
    .file-name {
      font-weight: 600;
      color: #1a202c;
      margin-bottom: 4px;
    }
    .file-path {
      font-size: 12px;
      color: #9ca3af;
    }
    .description {
      color: #4b5563;
      max-width: 300px;
      word-break: break-word;
    }
    .client-name {
      color: #1a202c;
      font-weight: 500;
    }
    .timestamp {
      color: #6b7280;
      font-size: 13px;
      white-space: nowrap;
    }
    .action-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .btn-action {
      padding: 7px 14px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      text-decoration: none;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }
    .btn-download {
      background: #10b981;
      color: #ffffff;
    }
    .btn-download:hover {
      background: #059669;
    }
    .btn-delete {
      background: #ef4444;
      color: #ffffff;
    }
    .btn-delete:hover {
      background: #dc2626;
    }
    .no-data {
      padding: 48px;
      text-align: center;
      color: #6b7280;
      font-size: 15px;
    }
    .empty-state {
      color: #9ca3af;
      font-size: 48px;
    }

    /* Pagination Styles */
    .pagination-wrapper {
      padding: 20px 28px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-top: 1px solid #e5e7eb;
      flex-wrap: wrap;
      gap: 16px;
    }
    .pagination-info {
      font-size: 14px;
      color: #6b7280;
    }
    .pagination {
      display: flex;
      gap: 8px;
      list-style: none;
    }
    .page-item {
      display: inline-block;
    }
    .page-link {
      padding: 8px 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      color: #374151;
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
      display: inline-block;
      min-width: 40px;
      text-align: center;
    }
    .page-link:hover {
      background: #f3f4f6;
      border-color: #9ca3af;
    }
    .page-item.active .page-link {
      background: #3b82f6;
      color: #ffffff;
      border-color: #3b82f6;
    }
    .page-item.disabled .page-link {
      color: #9ca3af;
      cursor: not-allowed;
      opacity: 0.5;
    }
    .page-item.disabled .page-link:hover {
      background: transparent;
      border-color: #d1d5db;
    }

    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      animation: fadeIn 0.3s;
    }
    .modal.show {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .modal-content {
      background-color: #ffffff;
      border-radius: 12px;
      padding: 32px;
      width: 90%;
      max-width: 450px;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
      animation: slideUp 0.3s;
    }
    .modal-header {
      margin-bottom: 24px;
    }
    .modal-header h3 {
      font-size: 20px;
      font-weight: 600;
      color: #1a202c;
      margin: 0 0 8px 0;
    }
    .modal-header p {
      font-size: 14px;
      color: #6b7280;
      margin: 0;
    }
    .modal-body {
      margin-bottom: 24px;
    }
    .form-group {
      margin-bottom: 16px;
    }
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #374151;
      font-size: 14px;
    }
    .form-group input {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.2s;
    }
    .form-group input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    .modal-footer {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }
    .btn-modal {
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
    }
    .btn-cancel {
      background: #f3f4f6;
      color: #374151;
    }
    .btn-cancel:hover {
      background: #e5e7eb;
    }
    .btn-send {
      background: #25d366;
      color: #ffffff;
    }
    .btn-send:hover {
      background: #20ba5a;
    }
    .btn-send:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }
    .alert {
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 16px;
      font-size: 14px;
    }
    .alert-success {
      background: #d1fae5;
      color: #065f46;
      border: 1px solid #6ee7b7;
    }
    .alert-error {
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #fca5a5;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes slideUp {
      from {
        transform: translateY(20px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    /* Toast Notification */
    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: #1a202c;
      color: #ffffff;
      padding: 16px 24px;
      border-radius: 8px;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
      display: none;
      animation: slideInRight 0.3s;
      z-index: 1001;
    }
    .toast.show {
      display: block;
    }
    @keyframes slideInRight {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        align-items: flex-start;
      }
      .header-actions {
        width: 100%;
      }
      .btn-add, .btn-whatsapp, .btn-copy {
        flex: 1;
        text-align: center;
      }
      .filter-form {
        flex-direction: column;
      }
      .filter-group {
        width: 100%;
      }
      .filter-buttons {
        width: 100%;
      }
      .btn-filter {
        flex: 1;
      }
      table {
        font-size: 13px;
      }
      th, td {
        padding: 12px 10px;
      }
      .description {
        max-width: 200px;
      }
      .modal-content {
        padding: 24px;
        margin: 20px;
      }
      .modal-footer {
        flex-direction: column;
      }
      .btn-modal {
        width: 100%;
      }
      .pagination-wrapper {
        flex-direction: column;
        align-items: center;
      }
      .pagination {
        flex-wrap: wrap;
        justify-content: center;
      }
    }
  </style>

  <div class="container">
    <div class="card">
      <div class="header">
        <div>
          <h2>Client Data</h2>
          <p class="header-subtitle">Manage uploaded files and documents</p>
        </div>
        <div class="header-actions">
          <a href="{% url 'public_upload' %}" class="btn-add">+ Add New File</a>
          <button onclick="openWhatsAppModal()" class="btn-whatsapp">üì§ Share on WhatsApp</button>
          <button onclick="copyUploadLink()" class="btn-copy">üìã Copy Link</button>
        </div>
      </div>

      <!-- Filter Section -->
      <div class="filter-section">
        <form method="get" action="{% url 'public_list' %}" class="filter-form" id="filterForm">
          <div class="filter-group">
            <label for="search">Search</label>
            <input 
              type="text" 
              id="search" 
              name="search" 
              placeholder="Search by client, file name, or description..." 
              value="{{ search_query }}"
            >
          </div>
          <div class="filter-group">
            <label for="date_from">From Date</label>
            <input 
              type="date" 
              id="date_from" 
              name="date_from" 
              value="{{ date_from }}"
            >
          </div>
          <div class="filter-group">
            <label for="date_to">To Date</label>
            <input 
              type="date" 
              id="date_to" 
              name="date_to" 
              value="{{ date_to }}"
            >
          </div>
          <div class="filter-buttons">
            <button type="submit" class="btn-filter btn-search">üîç Search</button>
            <button type="button" onclick="resetFilters()" class="btn-filter btn-reset">‚Ü∫ Reset</button>
          </div>
        </form>
      </div>

      <!-- Results Info -->
      {% if search_query or date_from or date_to %}
      <div class="results-info">
        üìä Found {{ total_count }} result{{ total_count|pluralize }}
        {% if search_query %}
          matching "{{ search_query }}"
        {% endif %}
        {% if date_from or date_to %}
          {% if date_from and date_to %}
            from {{ date_from }} to {{ date_to }}
          {% elif date_from %}
            from {{ date_from }}
          {% elif date_to %}
            until {{ date_to }}
          {% endif %}
        {% endif %}
      </div>
      {% endif %}

      {% if files %}
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>Client</th>
                <th>File Name</th>
                <th>Description</th>
                <th>Uploaded</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for f in files %}
                <tr>
                  <td>
                    <div class="client-name">
                      {{ f.client_name|default:"‚Äî" }}
                    </div>
                  </td>
                  <td>
                    <div class="file-name">
                      {{ f.provided_name|default:f.original_name|default:f.file.name|truncatechars:50 }}
                    </div>
                  </td>
                  <td>
                    <div class="description">{{ f.description|default:"‚Äî" }}</div>
                  </td>
                  <td>
                    <div class="timestamp">{{ f.uploaded_at|date:"Y-m-d H:i" }}</div>
                  </td>
                  <td>
                    <div class="action-buttons">
                      <a href="{% url 'download_file' f.id %}" class="btn-action btn-download">Download</a>
                      <form method="post" action="{% url 'delete_file' f.id %}" style="display:inline;">
                        {% csrf_token %}
                        <button type="submit" class="btn-action btn-delete" onclick="return confirm('Are you sure you want to delete this file?');">Delete</button>
                      </form>
                    </div>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        {% if files.paginator.num_pages > 1 %}
        <div class="pagination-wrapper">
          <div class="pagination-info">
            Showing {{ files.start_index }} to {{ files.end_index }} of {{ total_count }} entries
          </div>
          <ul class="pagination">
            <!-- Previous Button -->
            {% if files.has_previous %}
              <li class="page-item">
                <a class="page-link" href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}">¬´</a>
              </li>
              <li class="page-item">
                <a class="page-link" href="?page={{ files.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}">‚Äπ</a>
              </li>
            {% else %}
              <li class="page-item disabled">
                <span class="page-link">¬´</span>
              </li>
              <li class="page-item disabled">
                <span class="page-link">‚Äπ</span>
              </li>
            {% endif %}

            <!-- Page Numbers -->
            {% for num in files.paginator.page_range %}
              {% if files.number == num %}
                <li class="page-item active">
                  <span class="page-link">{{ num }}</span>
                </li>
              {% elif num > files.number|add:'-3' and num < files.number|add:'3' %}
                <li class="page-item">
                  <a class="page-link" href="?page={{ num }}{% if search_query %}&search={{ search_query }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}">{{ num }}</a>
                </li>
              {% endif %}
            {% endfor %}

            <!-- Next Button -->
            {% if files.has_next %}
              <li class="page-item">
                <a class="page-link" href="?page={{ files.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}">‚Ä∫</a>
              </li>
              <li class="page-item">
                <a class="page-link" href="?page={{ files.paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}">¬ª</a>
              </li>
            {% else %}
              <li class="page-item disabled">
                <span class="page-link">‚Ä∫</span>
              </li>
              <li class="page-item disabled">
                <span class="page-link">¬ª</span>
              </li>
            {% endif %}
          </ul>
        </div>
        {% endif %}
      {% else %}
        <div class="no-data">
          <div class="empty-state">üìÅ</div>
          <p style="margin-top: 8px;">
            {% if search_query or date_from or date_to %}
              No files found matching your filters
            {% else %}
              No files uploaded yet
            {% endif %}
          </p>
        </div>
      {% endif %}
    </div>
  </div>

  <!-- WhatsApp Modal -->
  <div id="whatsappModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>üì§ Share Upload Link via WhatsApp</h3>
        <p>Enter the recipient's phone number</p>
      </div>
      <div class="modal-body">
        <div id="modalAlert"></div>
        <div class="form-group">
          <label for="phoneNumber">Phone Number (with country code)</label>
          <input 
            type="tel" 
            id="phoneNumber" 
            placeholder="e.g., 919876543210" 
            autocomplete="tel"
            value="91"
          >
          <small style="color: #6b7280; font-size: 12px; margin-top: 4px; display: block;">
            Include country code without + symbol (e.g., 91 for India)
          </small>
        </div>
      </div>
      <div class="modal-footer">
        <button onclick="closeWhatsAppModal()" class="btn-modal btn-cancel">Cancel</button>
        <button onclick="sendWhatsAppMessage()" class="btn-modal btn-send" id="sendBtn">Send Link</button>
      </div>
    </div>
  </div>

  <!-- Toast Notification -->
  <div id="toast" class="toast"></div>

  <script>
    // Get CSRF token
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    const csrftoken = getCookie('csrftoken');

    // Reset filters
    function resetFilters() {
      window.location.href = "{% url 'public_list' %}";
    }

    // Open WhatsApp Modal
    function openWhatsAppModal() {
      document.getElementById('whatsappModal').classList.add('show');
      document.getElementById('phoneNumber').focus();
    }

    // Close WhatsApp Modal
    function closeWhatsAppModal() {
      document.getElementById('whatsappModal').classList.remove('show');
      document.getElementById('phoneNumber').value = '';
      document.getElementById('modalAlert').innerHTML = '';
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
      const modal = document.getElementById('whatsappModal');
      if (event.target === modal) {
        closeWhatsAppModal();
      }
    }

    // Show alert in modal
    function showModalAlert(message, type) {
      const alertDiv = document.getElementById('modalAlert');
      alertDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
      setTimeout(() => {
        alertDiv.innerHTML = '';
      }, 5000);
    }

    // Show toast notification
    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    // Send WhatsApp Message
    async function sendWhatsAppMessage() {
      const phoneNumber = document.getElementById('phoneNumber').value.trim();
      const sendBtn = document.getElementById('sendBtn');

      if (!phoneNumber) {
        showModalAlert('Please enter a phone number', 'error');
        return;
      }

      // Disable button and show loading state
      sendBtn.disabled = true;
      sendBtn.textContent = 'Sending...';

      try {
        const formData = new FormData();
        formData.append('phone_number', phoneNumber);

        const response = await fetch("{% url 'send_whatsapp' %}", {
          method: 'POST',
          headers: {
            'X-CSRFToken': csrftoken
          },
          body: formData
        });

        const data = await response.json();

        if (data.success) {
          showModalAlert(data.message || 'Message sent successfully!', 'success');
          setTimeout(() => {
            closeWhatsAppModal();
          }, 2000);
        } else {
          showModalAlert(data.error || 'Failed to send message', 'error');
        }
      } catch (error) {
        console.error('Error:', error);
        showModalAlert('Network error. Please try again.', 'error');
      } finally {
        // Re-enable button
        sendBtn.disabled = false;
        sendBtn.textContent = 'Send Link';
      }
    }

    // Copy Upload Link
    function copyUploadLink() {
      const uploadUrl = window.location.origin + "{% url 'public_upload' %}";
      
      // Create temporary input element
      const tempInput = document.createElement('input');
      tempInput.value = uploadUrl;
      document.body.appendChild(tempInput);
      tempInput.select();
      tempInput.setSelectionRange(0, 99999); // For mobile devices

      try {
        document.execCommand('copy');
        showToast('‚úÖ Link copied to clipboard!');
      } catch (err) {
        // Fallback for modern browsers
        navigator.clipboard.writeText(uploadUrl).then(() => {
          showToast('‚úÖ Link copied to clipboard!');
        }).catch(() => {
          showToast('‚ùå Failed to copy link');
        });
      }

      document.body.removeChild(tempInput);
    }

    // Allow Enter key to send message
    document.getElementById('phoneNumber').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        sendWhatsAppMessage();
      }
    });

    // Allow Enter key to search
    document.getElementById('search').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        document.getElementById('filterForm').submit();
      }
    });
    document.getElementById('phoneNumber').addEventListener('input', function() {
    if (!this.value.startsWith("91")) {
        this.value = "91";
    }
});
  </script>
{% endblock %}