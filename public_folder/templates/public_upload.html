<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Public Upload</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: #f5f7fa;
      padding: 20px;
      line-height: 1.6;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
      padding: 32px;
    }
    h2 {
      font-size: 24px;
      font-weight: 600;
      color: #1a202c;
      margin-bottom: 24px;
    }
    .form-group {
      margin-bottom: 20px;
      position: relative;
    }
    label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: #374151;
      margin-bottom: 8px;
    }
    input[type="text"],
    textarea,
    input[type="file"],
    select {
      width: 100%;
      padding: 10px 14px;
      font-size: 14px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      transition: border-color 0.2s;
      font-family: inherit;
      background-color: white;
    }
    input[type="text"]:focus,
    textarea:focus,
    input[type="file"]:focus,
    select:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    textarea {
      resize: vertical;
      min-height: 80px;
    }
    .optional {
      color: #9ca3af;
      font-weight: 400;
      font-size: 13px;
    }
    .required {
      color: #ef4444;
    }
    .btn-submit {
      width: 100%;
      padding: 12px 24px;
      font-size: 15px;
      font-weight: 600;
      color: #ffffff;
      background: #3b82f6;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s;
      margin-top: 8px;
    }
    .btn-submit:hover {
      background: #2563eb;
    }
    .btn-submit:active {
      background: #1d4ed8;
    }
    .btn-submit:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }
    .message {
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
    }
    .message-success {
      background: #d1fae5;
      color: #065f46;
      border: 1px solid #a7f3d0;
    }
    .message-error {
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #fecaca;
    }
    .message ul {
      margin-left: 20px;
    }
    .help-text {
      font-size: 13px;
      color: #6b7280;
      margin-top: 6px;
    }
    
    /* Dropdown styles */
    .dropdown-container {
      position: relative;
    }
    .dropdown-input {
      width: 100%;
      padding: 10px 14px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 14px;
    }
    .dropdown-input.loading {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24'%3E%3Cpath fill='%233b82f6' d='M12,1A11,11,0,1,0,23,12,11,11,0,0,0,12,1Zm0,19a8,8,0,1,1,8-8A8,8,0,0,1,12,20Z' opacity='.25'/%3E%3Cpath fill='%233b82f6' d='M10.14,1.16a11,11,0,0,0-9,8.92A1.59,1.59,0,0,0,2.46,12,1.52,1.52,0,0,0,4.11,10.7a8,8,0,0,1,6.66-6.61A1.42,1.42,0,0,0,12,2.69h0A1.57,1.57,0,0,0,10.14,1.16Z'%3E%3CanimateTransform attributeName='transform' type='rotate' dur='0.75s' values='0 12 12;360 12 12' repeatCount='indefinite'/%3E%3C/path%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 10px center;
      background-size: 20px 20px;
      padding-right: 40px;
    }
    .dropdown-list {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      max-height: 300px;
      overflow-y: auto;
      background: white;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      z-index: 1000;
      display: none;
      margin-top: 4px;
    }
    .dropdown-list.show {
      display: block;
    }
    .dropdown-item {
      padding: 12px 14px;
      cursor: pointer;
      border-bottom: 1px solid #f3f4f6;
      transition: background-color 0.15s;
    }
    .dropdown-item:hover {
      background-color: #f3f4f6;
    }
    .dropdown-item:last-child {
      border-bottom: none;
    }
    .dropdown-item small {
      color: #6b7280;
      font-size: 12px;
      display: block;
      margin-top: 2px;
    }
    .loading-indicator {
      padding: 12px 14px;
      text-align: center;
      color: #6b7280;
      font-style: italic;
      font-size: 13px;
    }
    .no-results {
      padding: 12px 14px;
      text-align: center;
      color: #6b7280;
      font-style: italic;
      font-size: 13px;
    }
    .error-message {
      background-color: #fee2e2;
      padding: 10px 14px;
      border-radius: 6px;
      margin-top: 8px;
      font-size: 13px;
      color: #991b1b;
      display: none;
      border: 1px solid #fecaca;
    }
    .retry-btn {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 8px;
      font-size: 13px;
      transition: background 0.2s;
    }
    .retry-btn:hover {
      background: #2563eb;
    }
    .success-indicator {
      color: #059669;
      font-size: 12px;
      margin-top: 4px;
      display: none;
    }
    .success-indicator.show {
      display: block;
    }
    .results-count {
      padding: 8px 14px;
      background-color: #f9fafb;
      border-bottom: 1px solid #e5e7eb;
      font-size: 12px;
      color: #6b7280;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Public Upload</h2>

    {% if message %}
      <div class="message message-success">{{ message }}</div>
    {% endif %}
    
    {% if errors %}
      <div class="message message-error">
        <ul>
        {% for e in errors %}
          <li>{{ e }}</li>
        {% endfor %}
        </ul>
      </div>
    {% endif %}

    <form method="post" enctype="multipart/form-data" novalidate>
      {% csrf_token %}
      
      <div class="form-group">
        <label for="client_search">
          Client Name <span class="required">*</span>
        </label>
        <div class="dropdown-container">
          <input 
            type="text" 
            id="client_search" 
            name="client_name" 
            class="dropdown-input" 
            placeholder="Start typing to search clients..."
            autocomplete="off"
            required
          >
          <div class="dropdown-list" id="client_dropdown">
            <div class="loading-indicator" id="loading_indicator">Loading clients...</div>
          </div>
        </div>
        <input type="hidden" id="client_code" name="client_code">
        <input type="hidden" id="client_branch" name="client_branch">
        <div class="success-indicator" id="success_indicator">
          âœ“ Clients loaded successfully
        </div>
        <div class="error-message" id="api_error">
          Failed to load clients. You can still type the client name manually.
          <button type="button" class="retry-btn" onclick="loadClients()">Retry</button>
        </div>
      </div>

      <div class="form-group">
        <label for="provided_name">
          File Name <span class="optional">(optional)</span>
        </label>
        <input id="provided_name" name="provided_name" type="text" placeholder="Custom file name">
      </div>

      <div class="form-group">
        <label for="description">
          Description <span class="optional">(optional)</span>
        </label>
        <textarea id="description" name="description" placeholder="Brief description of the file"></textarea>
      </div>

      <div class="form-group">
        <label for="file">Select File <span class="required">*</span></label>
        <input id="file" name="file" type="file" required>
        <p class="help-text">Accepted formats: All file types</p>
      </div>

      <button class="btn-submit" type="submit" id="submit_btn">Upload File</button>
    </form>
  </div>

  <script>
    let allClients = [];
    let debounceTimer;
    let isLoadingClients = false;
    
    // Load clients from Django backend
    async function loadClients() {
      if (isLoadingClients) {
        console.log('Already loading clients...');
        return;
      }
      
      isLoadingClients = true;
      const loadingIndicator = document.getElementById('loading_indicator');
      const clientDropdown = document.getElementById('client_dropdown');
      const apiError = document.getElementById('api_error');
      const successIndicator = document.getElementById('success_indicator');
      const clientSearch = document.getElementById('client_search');
      
      try {
        console.log('Starting to load clients...');
        loadingIndicator.style.display = 'block';
        apiError.style.display = 'none';
        successIndicator.classList.remove('show');
        clientDropdown.classList.remove('show');
        clientSearch.classList.add('loading');
        
        const url = window.location.origin + '/public_folder/get-clients/';
        console.log('Fetching from URL:', url);
        
        const response = await fetch(url, {
          method: 'GET',
          headers: {
            'Accept': 'application/json',
          }
        });
        
        console.log('Response status:', response.status);
        
        if (!response.ok) {
          const errorText = await response.text();
          console.error('Error response:', errorText);
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('Response data:', data);
        
        if (Array.isArray(data)) {
          // Sort clients alphabetically by name
          allClients = data.sort((a, b) => {
            const nameA = (a.name || '').toLowerCase();
            const nameB = (b.name || '').toLowerCase();
            return nameA.localeCompare(nameB);
          });
          
          loadingIndicator.style.display = 'none';
          successIndicator.classList.add('show');
          console.log(`Successfully loaded ${allClients.length} clients (sorted alphabetically)`);
          
          // Hide success indicator after 3 seconds
          setTimeout(() => {
            successIndicator.classList.remove('show');
          }, 3000);
        } else if (data.error) {
          throw new Error(data.error);
        } else {
          throw new Error('Invalid response format - expected array');
        }
        
      } catch (error) {
        console.error('Error loading clients:', error);
        loadingIndicator.style.display = 'none';
        apiError.style.display = 'block';
        
        let errorMsg = 'Failed to load clients. ';
        
        if (error.message.includes('404')) {
          errorMsg += 'Endpoint not found. Check your URL configuration.';
        } else if (error.message.includes('Failed to fetch')) {
          errorMsg += 'Network error. Check your internet connection.';
        } else {
          errorMsg += error.message;
        }
        
        errorMsg += ' You can still type the client name manually.';
        
        apiError.innerHTML = `${errorMsg} <button type="button" class="retry-btn" onclick="loadClients()">Retry</button>`;
      } finally {
        isLoadingClients = false;
        clientSearch.classList.remove('loading');
      }
    }
    
    // Filter and display clients based on search term
    function searchClients(searchTerm) {
      const clientDropdown = document.getElementById('client_dropdown');
      
      if (searchTerm.length < 2) {
        clientDropdown.classList.remove('show');
        return;
      }
      
      if (allClients.length === 0) {
        clientDropdown.innerHTML = '<div class="no-results">No clients loaded. Type manually or click Retry.</div>';
        clientDropdown.classList.add('show');
        return;
      }
      
      const searchLower = searchTerm.toLowerCase();
      const filtered = allClients.filter(client => {
        return (
          (client.name && client.name.toLowerCase().includes(searchLower)) ||
          (client.code && client.code.toLowerCase().includes(searchLower)) ||
          (client.branch && client.branch.toLowerCase().includes(searchLower))
        );
      });
      
      // Display ALL filtered results (no limit)
      displayClients(filtered);
    }
    
    // Display clients in dropdown
    function displayClients(clients) {
      const clientDropdown = document.getElementById('client_dropdown');
      
      if (clients.length === 0) {
        clientDropdown.innerHTML = '<div class="no-results">No matching clients found</div>';
        clientDropdown.classList.add('show');
        return;
      }
      
      // Show count of results
      let html = `<div class="results-count">Showing ${clients.length} client${clients.length !== 1 ? 's' : ''}</div>`;
      
      // Display ALL clients without limiting
      clients.forEach(client => {
        const name = client.name || 'Unknown';
        const code = client.code ? ` (${client.code})` : '';
        const branch = client.branch ? `<small>${client.branch}</small>` : '';
        
        html += `
          <div class="dropdown-item" 
               data-name="${escapeHtml(name)}" 
               data-code="${escapeHtml(client.code || '')}" 
               data-branch="${escapeHtml(client.branch || '')}">
            <div>${escapeHtml(name)}${escapeHtml(code)}</div>
            ${branch}
          </div>
        `;
      });
      
      clientDropdown.innerHTML = html;
      clientDropdown.classList.add('show');
      
      // Add click handlers
      document.querySelectorAll('.dropdown-item').forEach(item => {
        item.addEventListener('click', function() {
          document.getElementById('client_search').value = this.dataset.name;
          document.getElementById('client_code').value = this.dataset.code;
          document.getElementById('client_branch').value = this.dataset.branch;
          clientDropdown.classList.remove('show');
        });
      });
    }
    
    // Escape HTML to prevent XSS
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // Debounced search
    function debounceSearch() {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => {
        const searchTerm = document.getElementById('client_search').value.trim();
        searchClients(searchTerm);
      }, 300);
    }
    
    // Event listeners
    document.addEventListener('DOMContentLoaded', function() {
      const clientSearch = document.getElementById('client_search');
      const clientDropdown = document.getElementById('client_dropdown');
      
      console.log('Page loaded, starting client load...');
      
      // Load clients on page load
      loadClients();
      
      // Search on input
      clientSearch.addEventListener('input', function() {
        debounceSearch();
        
        // Clear hidden fields when user types
        if (this.value.trim() === '') {
          document.getElementById('client_code').value = '';
          document.getElementById('client_branch').value = '';
        }
      });
      
      // Show all clients on focus if empty
      clientSearch.addEventListener('focus', function() {
        if (this.value.trim() === '' && allClients.length > 0) {
          displayClients(allClients);
        }
      });
      
      // Close dropdown when clicking outside
      document.addEventListener('click', function(event) {
        if (!clientSearch.contains(event.target) && !clientDropdown.contains(event.target)) {
          clientDropdown.classList.remove('show');
        }
      });
    });
  </script>
</body>
</html>