{% extends 'base.html' %}

{% block content %}
<div style="padding: 20px; max-width: 800px; margin: 0 auto;">
    <div style="margin-bottom: 30px; border-bottom: 3px solid #3498db; padding-bottom: 10px;">
        <h2 style="color: #2c3e50; margin: 0;">
            <i class="fas fa-edit"></i>
            Edit Software Update
        </h2>
    </div>

    <div style="background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); padding: 30px;">
        
        <!-- Requested By Info Display - NEW -->
        {% if complaint.requested_by %}
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                    padding: 20px; border-radius: 8px; margin-bottom: 25px; color: white;
                    display: flex; align-items: center; gap: 15px;">
            <i class="fas fa-user-circle" style="font-size: 48px; opacity: 0.9;"></i>
            <div>
                <p style="margin: 0; font-size: 12px; opacity: 0.9; text-transform: uppercase; letter-spacing: 1px;">
                    Requested By
                </p>
                <h3 style="margin: 5px 0 0 0; font-size: 20px; font-weight: 600;">
                    {{ complaint.requested_by.get_full_name|default:complaint.requested_by.username }}
                </h3>
                <p style="margin: 5px 0 0 0; font-size: 13px; opacity: 0.8;">
                    <i class="fas fa-at"></i> {{ complaint.requested_by.username }}
                </p>
            </div>
        </div>
        {% endif %}

        <form method="POST" enctype="multipart/form-data" id="editForm">
            {% csrf_token %}
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; color: #2c3e50; font-weight: 600;">
                    <i class="fas fa-user"></i> Client Name
                </label>
                <input type="text" 
                       name="client_name" 
                       value="{{ complaint.client_name }}"
                       required
                       style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px; transition: border 0.3s;"
                       onfocus="this.style.borderColor='#3498db'"
                       onblur="this.style.borderColor='#e0e0e0'">
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; color: #2c3e50; font-weight: 600;">
                    <i class="fas fa-building"></i> Branch
                </label>
                <select name="branch" 
                        required
                        style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px; transition: border 0.3s;"
                        onfocus="this.style.borderColor='#3498db'"
                        onblur="this.style.borderColor='#e0e0e0'">
                    {% for branch in branches %}
                    <option value="{{ branch.id }}" {% if branch.name == complaint.branch %}selected{% endif %}>
                        {{ branch.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; color: #2c3e50; font-weight: 600;">
                    <i class="fas fa-laptop-code"></i> Software
                </label>
                <select name="software" 
                        required
                        style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px; transition: border 0.3s;"
                        onfocus="this.style.borderColor='#3498db'"
                        onblur="this.style.borderColor='#e0e0e0'">
                    {% for software in softwares %}
                    <option value="{{ software.id }}" {% if software.name == complaint.software %}selected{% endif %}>
                        {{ software.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; color: #2c3e50; font-weight: 600;">
                    <i class="fas fa-tasks"></i> Status
                </label>
                <select name="status" 
                        required
                        style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px; transition: border 0.3s;"
                        onfocus="this.style.borderColor='#3498db'"
                        onblur="this.style.borderColor='#e0e0e0'">
                    <option value="Pending" {% if complaint.status == 'Pending' %}selected{% endif %}>Pending</option>
                    <option value="In Review" {% if complaint.status == 'In Review' %}selected{% endif %}>In Review</option>
                    <option value="Under Development" {% if complaint.status == 'Under Development' %}selected{% endif %}>Under Development</option>
                    <option value="Completed" {% if complaint.status == 'Completed' %}selected{% endif %}>Completed</option>
                </select>
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; color: #2c3e50; font-weight: 600;">
                    <i class="fas fa-file-alt"></i> Description
                </label>
                <textarea name="description" 
                          rows="5"
                          required
                          style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px; resize: vertical; transition: border 0.3s;"
                          onfocus="this.style.borderColor='#3498db'"
                          onblur="this.style.borderColor='#e0e0e0'">{{ complaint.description }}</textarea>
            </div>

            <!-- Existing Images Preview -->
            {% if complaint.images %}
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; color: #2c3e50; font-weight: 600;">
                    <i class="fas fa-images"></i> Existing Images
                </label>
                <div id="existingImagesContainer" style="padding: 15px; background: #f8f9fa; border: 2px solid #e0e0e0; border-radius: 6px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <span style="color: #2c3e50; font-size: 14px;">
                            <span id="existingImageCount"></span> image(s)
                        </span>
                        <button type="button" onclick="clearAllExistingImages()" 
                                style="padding: 4px 12px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                            <i class="fas fa-times"></i> Remove All
                        </button>
                    </div>
                    <div id="existingImagesPreview" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px;"></div>
                </div>
                <input type="hidden" id="deleted_images" name="deleted_images" value="">
            </div>
            {% endif %}

            <!-- Add New Images -->
            <div style="margin-bottom: 20px;">
                <label for="images" style="display: block; margin-bottom: 8px; color: #2c3e50; font-weight: 600;">
                    <i class="fas fa-image"></i> Add New Images <span id="newImageCount" style="font-weight: normal; color: #7f8c8d;"></span>
                </label>
                <input type="file" 
                       id="images" 
                       name="images"
                       accept="image/*"
                       multiple
                       onchange="addNewImages(this)"
                       style="width: 100%; padding: 12px; border: 2px dashed #e0e0e0; border-radius: 6px; font-size: 14px; background: white; cursor: pointer;">
                <small style="color: #7f8c8d; display: block; margin-top: 5px;">
                    <i class="fas fa-info-circle"></i> Select multiple images to add - New images will be added to existing ones
                </small>
                
                <!-- New Images Preview -->
                <div id="newImagePreviewContainer" style="display: none; margin-top: 15px; padding: 15px; background: white; border: 2px solid #e0e0e0; border-radius: 6px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <strong style="color: #2c3e50;">New Images to Add:</strong>
                        <button type="button" onclick="clearNewImages()" 
                                style="padding: 4px 12px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                            <i class="fas fa-times"></i> Clear All
                        </button>
                    </div>
                    <div id="newImagePreview" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px;"></div>
                </div>
            </div>

            <div style="margin-bottom: 30px;">
                <label style="display: block; margin-bottom: 8px; color: #2c3e50; font-weight: 600;">
                    <i class="fas fa-microphone"></i> Voice Note 
                </label>
                <input type="hidden" name="voice_note" id="voice_note">
                <div style="display: flex; gap: 10px; align-items: center;">
                    <button type="button" id="recordBtn"
                            style="padding: 12px 20px; background: #e74c3c; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: background 0.3s;"
                            onmouseover="this.style.background='#c0392b'"
                            onmouseout="this.style.background='#e74c3c'">
                        <i class="fas fa-microphone"></i> Start Recording
                    </button>
                    <span id="recordingStatus" style="color: #7f8c8d; font-size: 14px;"></span>
                </div>
            </div>

            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <a href="{% url 'software_update' %}"
                   style="padding: 12px 30px; background: #95a5a6; color: white; border-radius: 6px; text-decoration: none; font-weight: 600; transition: background 0.3s;"
                   onmouseover="this.style.background='#7f8c8d'"
                   onmouseout="this.style.background='#95a5a6'">
                    <i class="fas fa-times"></i> Cancel
                </a>
                <button type="submit"
                        style="padding: 12px 30px; background: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: background 0.3s;"
                        onmouseover="this.style.background='#2980b9'"
                        onmouseout="this.style.background='#3498db'">
                    <i class="fas fa-save"></i> Update Complaint
                </button>
            </div>
        </form>
    </div>
</div>

<style>
    .image-preview-item {
        position: relative;
        border: 2px solid #e0e0e0;
        border-radius: 6px;
        overflow: hidden;
        background: #f8f9fa;
    }

    .image-preview-item img {
        width: 100%;
        height: 120px;
        object-fit: cover;
        display: block;
    }

    .image-preview-remove {
        position: absolute;
        top: 5px;
        right: 5px;
        background: #e74c3c;
        color: white;
        border: none;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        cursor: pointer;
        font-size: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s;
    }

    .image-preview-remove:hover {
        background: #c0392b;
    }

    .image-preview-number {
        position: absolute;
        bottom: 5px;
        left: 5px;
        background: rgba(52, 152, 219, 0.9);
        color: white;
        padding: 2px 8px;
        border-radius: 3px;
        font-size: 11px;
        font-weight: 600;
    }

    input[type="file"]::-webkit-file-upload-button {
        padding: 8px 16px;
        background: #3498db;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
        font-weight: 600;
        transition: background 0.3s;
    }
    
    input[type="file"]::-webkit-file-upload-button:hover {
        background: #2980b9;
    }
</style>

<script>
let mediaRecorder;
let audioChunks = [];
let selectedNewFiles = []; // Array for new files to add
let deletedImages = []; // Track deleted existing images
let existingImages = [];

// Initialize existing images
document.addEventListener('DOMContentLoaded', function() {
    {% if complaint.images %}
    try {
        existingImages = {{ complaint.images|safe }};
        displayExistingImages();
    } catch (e) {
        console.error('Error loading existing images:', e);
    }
    {% endif %}
    
    // Form submission handler
    document.getElementById('editForm').addEventListener('submit', function(e) {
        // Set deleted images value
        document.getElementById('deleted_images').value = JSON.stringify(deletedImages);
        
        // Attach new files if any
        if (selectedNewFiles.length > 0) {
            const dataTransfer = new DataTransfer();
            selectedNewFiles.forEach(file => {
                dataTransfer.items.add(file);
            });
            document.getElementById('images').files = dataTransfer.files;
        }
    });
});

// Display existing images
function displayExistingImages() {
    const preview = document.getElementById('existingImagesPreview');
    const count = document.getElementById('existingImageCount');
    
    if (!existingImages || existingImages.length === 0) {
        document.getElementById('existingImagesContainer').style.display = 'none';
        return;
    }
    
    count.textContent = existingImages.length;
    preview.innerHTML = '';
    
    existingImages.forEach((imagePath, index) => {
        const div = document.createElement('div');
        div.className = 'image-preview-item';
        div.innerHTML = `
            <img src="{{ MEDIA_URL }}${imagePath}" alt="Existing ${index + 1}" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22120%22 height=%22120%22><text x=%2250%%25%22 y=%2250%%25%22 text-anchor=%22middle%22 dy=%22.3em%22>Image not found</text></svg>'">
            <button type="button" class="image-preview-remove" onclick="removeExistingImage(${index})" title="Remove image">
                <i class="fas fa-times"></i>
            </button>
            <span class="image-preview-number">#${index + 1}</span>
        `;
        preview.appendChild(div);
    });
}

// Remove individual existing image
function removeExistingImage(index) {
    if (confirm('Remove this image?')) {
        deletedImages.push(existingImages[index]);
        existingImages.splice(index, 1);
        displayExistingImages();
    }
}

// Clear all existing images
function clearAllExistingImages() {
    if (confirm('Remove all existing images?')) {
        deletedImages = deletedImages.concat(existingImages);
        existingImages = [];
        displayExistingImages();
    }
}

// Add new images
function addNewImages(input) {
    const newFiles = Array.from(input.files);
    
    if (newFiles.length === 0) {
        return;
    }
    
    selectedNewFiles = selectedNewFiles.concat(newFiles);
    input.value = ''; // Clear input for more selections
    updateNewImagePreview();
}

// Update new images preview
function updateNewImagePreview() {
    const container = document.getElementById('newImagePreviewContainer');
    const preview = document.getElementById('newImagePreview');
    const count = document.getElementById('newImageCount');
    
    if (selectedNewFiles.length === 0) {
        container.style.display = 'none';
        count.textContent = '';
        return;
    }
    
    count.textContent = `(${selectedNewFiles.length} to add)`;
    container.style.display = 'block';
    preview.innerHTML = '';
    
    selectedNewFiles.forEach((file, index) => {
        const reader = new FileReader();
        
        reader.onload = function(e) {
            const div = document.createElement('div');
            div.className = 'image-preview-item';
            div.innerHTML = `
                <img src="${e.target.result}" alt="New ${index + 1}">
                <button type="button" class="image-preview-remove" onclick="removeNewImage(${index})" title="Remove image">
                    <i class="fas fa-times"></i>
                </button>
                <span class="image-preview-number">New #${index + 1}</span>
            `;
            preview.appendChild(div);
        };
        
        reader.readAsDataURL(file);
    });
}

// Remove individual new image
function removeNewImage(index) {
    selectedNewFiles.splice(index, 1);
    updateNewImagePreview();
}

// Clear all new images
function clearNewImages() {
    selectedNewFiles = [];
    document.getElementById('images').value = '';
    updateNewImagePreview();
}

// Voice recording
document.getElementById('recordBtn').addEventListener('click', async function() {
    if (!mediaRecorder || mediaRecorder.state === 'inactive') {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            
            mediaRecorder.ondataavailable = (event) => {
                audioChunks.push(event.data);
            };
            
            mediaRecorder.onstop = () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                const reader = new FileReader();
                reader.readAsDataURL(audioBlob);
                reader.onloadend = () => {
                    document.getElementById('voice_note').value = reader.result;
                    document.getElementById('recordingStatus').textContent = 'Recording saved!';
                    document.getElementById('recordingStatus').style.color = '#27ae60';
                };
                audioChunks = [];
            };
            
            mediaRecorder.start();
            this.innerHTML = '<i class="fas fa-stop"></i> Stop Recording';
            this.style.background = '#c0392b';
            document.getElementById('recordingStatus').textContent = 'Recording...';
            document.getElementById('recordingStatus').style.color = '#e74c3c';
        } catch (err) {
            alert('Error accessing microphone: ' + err.message);
        }
    } else {
        mediaRecorder.stop();
        mediaRecorder.stream.getTracks().forEach(track => track.stop());
        this.innerHTML = '<i class="fas fa-microphone"></i> Start Recording';
        this.style.background = '#e74c3c';
    }
});
</script>
{% endblock %}