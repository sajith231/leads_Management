{% extends 'base.html' %}

{% block content %}
<div style="padding: 20px; min-height: 100vh;">
    <h2 style="color: #2c3e50; margin-bottom: 30px; border-bottom: 3px solid #3498db; padding-bottom: 10px;">
        <i class="fas fa-plus"></i>
        Software Updates
    </h2>

    <!-- Requested By Info (Compact) -->
<div style="
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: #fff;
    padding: 8px 12px;
    border-radius: 6px;
    margin-bottom: 16px;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    box-shadow: 0 1px 6px rgba(102,126,234,.25);
">
    <i class="fas fa-user-circle" style="font-size: 18px; opacity: 0.9;"></i>
    <div style="line-height: 1.2;">
        <div style="font-size: 11px; opacity: 0.85;">Requested by</div>
        <div style="font-size: 14px; font-weight: 600;">
            {{ request.user.get_full_name|default:request.user.username }}
        </div>
    </div>
</div>


    <form method="POST" enctype="multipart/form-data" id="complaintForm" style="background: #ffffff; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); height: calc(100vh - 250px); overflow-y: auto;">
        {% csrf_token %}
        
        <!-- Client Name - Searchable Dropdown -->
        <div style="margin-bottom: 25px;">
            <label for="client_name" style="display: block; font-weight: 600; color: #34495e; margin-bottom: 8px; font-size: 14px;">
                <i class="fas fa-user"></i> Client Name *
            </label>
            <div style="position: relative;">
                <input 
                    type="text" 
                    id="client_search" 
                    autocomplete="off"
                    placeholder="Search client name or address..."
                    style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px; transition: border-color 0.3s;"
                >
                <input type="hidden" id="client_name" name="client_name" required>
                <input type="hidden" id="client_code" name="client_code">
                
                <div id="client_dropdown" style="display: none; position: absolute; width: 100%; max-height: 300px; overflow-y: auto; background: white; border: 2px solid #3498db; border-top: none; border-radius: 0 0 6px 6px; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    <div id="loading" style="padding: 15px; text-align: center; color: #7f8c8d;">
                        <i class="fas fa-spinner fa-spin"></i> Loading clients...
                    </div>
                    <div id="client_list"></div>
                </div>
            </div>
            <small style="display: block; color: #7f8c8d; margin-top: 5px; font-size: 12px;">
                <i class="fas fa-info-circle"></i> Type to search by client name or address
            </small>
        </div>

        <!-- Branch -->
        <div style="margin-bottom: 25px;">
            <label for="branch" style="display: block; font-weight: 600; color: #34495e; margin-bottom: 8px; font-size: 14px;">
                <i class="fas fa-building"></i> Branch *
            </label>
            <select 
                id="branch" 
                name="branch" 
                required
                style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px; transition: border-color 0.3s;"
                onfocus="this.style.borderColor='#3498db'"
                onblur="this.style.borderColor='#e0e0e0'"
            >
                <option value="">-- Select Branch --</option>
                {% for b in branches %}
                    <option value="{{ b.id }}">{{ b.name }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- Software Dropdown -->
        <div style="margin-bottom: 25px;">
            <label for="software" style="display: block; font-weight: 600; color: #34495e; margin-bottom: 8px; font-size: 14px;">
                <i class="fas fa-laptop-code"></i> Software *
            </label>
            <select 
                id="software" 
                name="software" 
                required
                style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px; transition: border-color 0.3s;"
                onfocus="this.style.borderColor='#3498db'"
                onblur="this.style.borderColor='#e0e0e0'"
            >
                <option value="">-- Select Software --</option>
                {% for s in softwares %}
                    <option value="{{ s.id }}">{{ s.name }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- Complaint Section -->
        <div style="background: #f8f9fa; padding: 25px; border-radius: 8px; margin-bottom: 25px; border-left: 4px solid #e74c3c;">
            <h3 style="color: #2c3e50; margin-top: 0; margin-bottom: 20px; font-size: 18px;">
                <i class="fas fa-exclamation-circle"></i> Complaint Details
            </h3>

            <!-- Description -->
            <div style="margin-bottom: 20px;">
                <label for="description" style="display: block; font-weight: 600; color: #34495e; margin-bottom: 8px; font-size: 14px;">
                    <i class="fas fa-align-left"></i> Description *
                </label>
                <textarea 
                    id="description" 
                    name="description" 
                    required
                    rows="5"
                    style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px; resize: vertical; font-family: inherit; transition: border-color 0.3s;"
                    onfocus="this.style.borderColor='#3498db'"
                    onblur="this.style.borderColor='#e0e0e0'"
                    placeholder="Describe the issue in detail..."
                ></textarea>
            </div>

          <!-- Image Upload with Preview -->
<div style="margin-bottom: 20px;">
    <label for="images" style="display: block; font-weight: 600; color: #34495e; margin-bottom: 8px; font-size: 14px;">
        <i class="fas fa-image"></i> Upload Images <span id="imageCount" style="font-weight:normal;color:#7f8c8d;"></span>
    </label>
    <input 
        type="file" 
        id="images" 
        name="images"
        accept="image/*"
        multiple
        onchange="addImages(this)"
        style="width: 100%; padding: 12px; border: 2px dashed #e0e0e0; border-radius: 6px; font-size: 14px; background: white; cursor: pointer;"
    >
    <small style="display: block; color: #7f8c8d; margin-top: 5px; font-size: 12px;">
        <i class="fas fa-info-circle"></i> Select multiple images - Max 10 images total
    </small>
    
    <!-- Image Preview Container -->
    <div id="imagePreviewContainer" style="display:none;margin-top:15px;padding:15px;background:white;border:2px solid #e0e0e0;border-radius:6px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
            <strong style="color:#2c3e50;">Selected Images:</strong>
            <button type="button" onclick="clearImages()" style="padding:4px 12px;background:#e74c3c;color:white;border:none;border-radius:4px;cursor:pointer;font-size:12px;">
                <i class="fas fa-times"></i> Clear All
            </button>
        </div>
        <div id="imagePreview" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:10px;"></div>
    </div>
</div>

            <!-- Voice Note Recording -->
            <div style="margin-bottom: 0;">
                <label style="display: block; font-weight: 600; color: #34495e; margin-bottom: 8px; font-size: 14px;">
                    <i class="fas fa-microphone"></i> Voice Note
                </label>
                
                <div id="recording-controls" style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                    <button 
                        type="button" 
                        id="recordBtn"
                        onclick="startRecording()"
                        style="padding: 10px 20px; background: #e74c3c; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; transition: background 0.3s;"
                    >
                        <i class="fas fa-circle"></i> Start Recording
                    </button>
                    
                    <button 
                        type="button" 
                        id="stopBtn"
                        onclick="stopRecording()"
                        disabled
                        style="padding: 10px 20px; background: #95a5a6; color: white; border: none; border-radius: 6px; cursor: not-allowed; font-size: 14px; font-weight: 600; transition: background 0.3s;"
                    >
                        <i class="fas fa-stop"></i> Stop Recording
                    </button>
                    
                    <span id="recordingStatus" style="color: #7f8c8d; font-size: 14px; font-weight: 600;"></span>
                </div>

                <div id="audioPlayback" style="margin-top: 15px; display: none;">
                    <audio id="audioPlayer" controls style="width: 100%; max-width: 500px;"></audio>
                    <button 
                        type="button" 
                        onclick="deleteRecording()"
                        style="margin-top: 10px; padding: 8px 16px; background: #e74c3c; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px;"
                    >
                        <i class="fas fa-trash"></i> Delete Recording
                    </button>
                </div>
                
                <input type="hidden" id="voice_note" name="voice_note">
                
                <small style="display: block; color: #7f8c8d; margin-top: 10px; font-size: 12px;">
                    <i class="fas fa-info-circle"></i> Click "Start Recording" to record your voice note
                </small>
            </div>
        </div>

        <!-- Action Buttons -->
        <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 30px; padding-bottom: 20px;">
            <button 
                type="button" 
                onclick="window.history.back()"
                style="padding: 12px 30px; background: #95a5a6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; transition: background 0.3s;"
                onmouseover="this.style.background='#7f8c8d'"
                onmouseout="this.style.background='#95a5a6'"
            >
                <i class="fas fa-times"></i> Cancel
            </button>
            <button 
                type="submit"
                style="padding: 12px 30px; background: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; transition: background 0.3s;"
                onmouseover="this.style.background='#2980b9'"
                onmouseout="this.style.background='#3498db'"
            >
                <i class="fas fa-paper-plane"></i> Submit Complaint
            </button>
        </div>
    </form>
</div>

<style>
    input[type="file"]::-webkit-file-upload-button {
        padding: 8px 16px;
        background: #3498db;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
        font-weight: 600;
        transition: background 0.3s;
    }
    
    input[type="file"]::-webkit-file-upload-button:hover {
        background: #2980b9;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    .recording {
        animation: pulse 1.5s infinite;
    }

    .client-item {
        padding: 12px 15px;
        cursor: pointer;
        border-bottom: 1px solid #ecf0f1;
        transition: background 0.2s;
    }

    .client-item:hover {
        background: #f8f9fa;
    }

    .client-item:last-child {
        border-bottom: none;
    }

    .client-name {
        font-weight: 600;
        color: #2c3e50;
        font-size: 14px;
    }

    .client-address {
        color: #7f8c8d;
        font-size: 12px;
        margin-top: 3px;
    }

    #client_dropdown::-webkit-scrollbar {
        width: 8px;
    }

    #client_dropdown::-webkit-scrollbar-track {
        background: #f1f1f1;
    }

    #client_dropdown::-webkit-scrollbar-thumb {
        background: #3498db;
        border-radius: 4px;
    }

    #client_dropdown::-webkit-scrollbar-thumb:hover {
        background: #2980b9;
    }

    .image-preview-item {
        position: relative;
        border: 2px solid #e0e0e0;
        border-radius: 6px;
        overflow: hidden;
        background: #f8f9fa;
    }

    .image-preview-item img {
        width: 100%;
        height: 120px;
        object-fit: cover;
        display: block;
    }

    .image-preview-remove {
        position: absolute;
        top: 5px;
        right: 5px;
        background: #e74c3c;
        color: white;
        border: none;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        cursor: pointer;
        font-size: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s;
    }

    .image-preview-remove:hover {
        background: #c0392b;
    }

    .image-preview-number {
        position: absolute;
        bottom: 5px;
        left: 5px;
        background: rgba(52, 152, 219, 0.9);
        color: white;
        padding: 2px 8px;
        border-radius: 3px;
        font-size: 11px;
        font-weight: 600;
    }
</style>

<script>
let allClients = [];
let mediaRecorder;
let audioChunks = [];
let recordingTimer;
let recordingSeconds = 0;
let selectedFiles = [];

document.addEventListener('DOMContentLoaded', function() {
    loadClients();
    
    const searchInput = document.getElementById('client_search');
    
    searchInput.addEventListener('focus', function() {
        this.style.borderColor = '#3498db';
        showDropdown();
    });
    
    searchInput.addEventListener('blur', function() {
        this.style.borderColor = '#e0e0e0';
        setTimeout(() => hideDropdown(), 300);
    });
    
    searchInput.addEventListener('input', function() {
        filterClients(this.value);
    });
    
    document.getElementById('complaintForm').addEventListener('submit', function(e) {
        const clientName = document.getElementById('client_name').value;
        if (!clientName) {
            e.preventDefault();
            alert('Please select a client from the dropdown');
            document.getElementById('client_search').focus();
            return;
        }
        
        if (selectedFiles.length > 0) {
            const dataTransfer = new DataTransfer();
            selectedFiles.forEach(file => {
                dataTransfer.items.add(file);
            });
            document.getElementById('images').files = dataTransfer.files;
        }
    });
});

async function loadClients() {
    try {
        const response = await fetch('{% url "get_rrc_clients" %}', {
            method: 'GET',
            headers: {
                'Accept': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.error) {
            throw new Error(data.error);
        }
        
        allClients = data.sort((a, b) => a.name.localeCompare(b.name));
        document.getElementById('loading').style.display = 'none';
        
        if (allClients.length === 0) {
            document.getElementById('client_list').innerHTML = '<div style="padding: 15px; text-align: center; color: #7f8c8d;">No clients found</div>';
        } else {
            displayClients(allClients);
        }
    } catch (error) {
        console.error('Error loading clients:', error);
        document.getElementById('loading').innerHTML = '<span style="color: #e74c3c;"><i class="fas fa-exclamation-circle"></i> Error loading clients. Please refresh the page.</span>';
    }
}

function displayClients(clients) {
    const clientList = document.getElementById('client_list');
    
    if (clients.length === 0) {
        clientList.innerHTML = '<div style="padding: 15px; text-align: center; color: #7f8c8d;">No clients found</div>';
        return;
    }
    
    clientList.innerHTML = clients.map(client => {
        const name = escapeHtml(client.name || '');
        const address = escapeHtml(client.address || '');
        const code = escapeHtml(client.code || '');
        
        return `
            <div class="client-item" onmousedown="selectClient('${code}', '${name}', '${address}')">
                <div class="client-name">${name}</div>
                <div class="client-address">${address}</div>
            </div>
        `;
    }).join('');
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function filterClients(searchTerm) {
    if (!searchTerm || searchTerm.trim() === '') {
        displayClients(allClients);
        return;
    }
    
    const searchLower = searchTerm.toLowerCase().trim();
    const filtered = allClients.filter(client => {
        const name = (client.name || '').toLowerCase();
        const address = (client.address || '').toLowerCase();
        return name.includes(searchLower) || address.includes(searchLower);
    });
    
    displayClients(filtered);
    showDropdown();
}

function selectClient(code, name, address) {
    document.getElementById('client_search').value = `${name} - ${address}`;
    document.getElementById('client_name').value = name;
    document.getElementById('client_code').value = code;
    hideDropdown();
}

function showDropdown() {
    if (allClients.length > 0) {
        document.getElementById('client_dropdown').style.display = 'block';
    }
}

function hideDropdown() {
    document.getElementById('client_dropdown').style.display = 'none';
}

function addImages(input) {
    const newFiles = Array.from(input.files);
    const maxFiles = 10;
    
    if (newFiles.length === 0) {
        return;
    }
    
    if (selectedFiles.length + newFiles.length > maxFiles) {
        alert(`You can only upload a maximum of ${maxFiles} images. You currently have ${selectedFiles.length} image(s).`);
        input.value = '';
        return;
    }
    
    selectedFiles = selectedFiles.concat(newFiles);
    input.value = '';
    updateImagePreview();
}

function updateImagePreview() {
    const previewContainer = document.getElementById('imagePreviewContainer');
    const preview = document.getElementById('imagePreview');
    const imageCount = document.getElementById('imageCount');
    
    if (selectedFiles.length === 0) {
        previewContainer.style.display = 'none';
        imageCount.textContent = '';
        return;
    }
    
    imageCount.textContent = `(${selectedFiles.length} selected)`;
    previewContainer.style.display = 'block';
    preview.innerHTML = '';
    
    selectedFiles.forEach((file, index) => {
        const reader = new FileReader();
        
        reader.onload = function(e) {
            const div = document.createElement('div');
            div.className = 'image-preview-item';
            div.innerHTML = `
                <img src="${e.target.result}" alt="Preview ${index + 1}">
                <button type="button" class="image-preview-remove" onclick="removeImage(${index})" title="Remove image">
                    <i class="fas fa-times"></i>
                </button>
                <span class="image-preview-number">#${index + 1}</span>
            `;
            preview.appendChild(div);
        };
        
        reader.readAsDataURL(file);
    });
}

function removeImage(index) {
    selectedFiles.splice(index, 1);
    updateImagePreview();
}

function clearImages() {
    selectedFiles = [];
    document.getElementById('images').value = '';
    updateImagePreview();
}

async function startRecording() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
        recordingSeconds = 0;

        mediaRecorder.ondataavailable = (event) => {
            audioChunks.push(event.data);
        };

        mediaRecorder.onstop = () => {
            const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
            const audioUrl = URL.createObjectURL(audioBlob);
            const audioPlayer = document.getElementById('audioPlayer');
            audioPlayer.src = audioUrl;
            document.getElementById('audioPlayback').style.display = 'block';

            const reader = new FileReader();
            reader.readAsDataURL(audioBlob);
            reader.onloadend = () => {
                document.getElementById('voice_note').value = reader.result;
            };

            stream.getTracks().forEach(track => track.stop());
        };

        mediaRecorder.start();
        
        document.getElementById('recordBtn').disabled = true;
        document.getElementById('recordBtn').style.background = '#95a5a6';
        document.getElementById('recordBtn').style.cursor = 'not-allowed';
        document.getElementById('stopBtn').disabled = false;
        document.getElementById('stopBtn').style.background = '#e74c3c';
        document.getElementById('stopBtn').style.cursor = 'pointer';
        document.getElementById('recordingStatus').innerHTML = '<i class="fas fa-circle recording" style="color: #e74c3c;"></i> Recording: 0:00';
        document.getElementById('recordingStatus').style.color = '#e74c3c';

        recordingTimer = setInterval(() => {
            recordingSeconds++;
            const minutes = Math.floor(recordingSeconds / 60);
            const seconds = recordingSeconds % 60;
            document.getElementById('recordingStatus').innerHTML = 
                `<i class="fas fa-circle recording" style="color: #e74c3c;"></i> Recording: ${minutes}:${seconds.toString().padStart(2, '0')}`;
        }, 1000);

    } catch (err) {
        alert('Error accessing microphone: ' + err.message);
    }
}

function stopRecording() {
    if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
        clearInterval(recordingTimer);
        
        document.getElementById('recordBtn').disabled = false;
        document.getElementById('recordBtn').style.background = '#e74c3c';
        document.getElementById('recordBtn').style.cursor = 'pointer';
        document.getElementById('stopBtn').disabled = true;
        document.getElementById('stopBtn').style.background = '#95a5a6';
        document.getElementById('stopBtn').style.cursor = 'not-allowed';
        document.getElementById('recordingStatus').textContent = 'Recording completed';
        document.getElementById('recordingStatus').style.color = '#27ae60';
    }
}

function deleteRecording() {
    document.getElementById('audioPlayback').style.display = 'none';
    document.getElementById('audioPlayer').src = '';
    document.getElementById('voice_note').value = '';
    audioChunks = [];
    recordingSeconds = 0;
    document.getElementById('recordingStatus').textContent = '';
}
</script>
{% endblock %}