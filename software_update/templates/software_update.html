{% extends 'base.html' %}

{% block content %}
<div style="padding: 20px; min-height: 100vh;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 3px solid #3498db; padding-bottom: 10px;">
        <h2 style="color: #2c3e50; margin: 0;">
            <i class="fas fa-sync-alt"></i>
            Software Updation 
        </h2>
        <a href="{% url 'software_add' %}" 
           style="padding: 10px 20px; background: #3498db; color: white; border-radius: 6px; text-decoration: none; font-weight: 600; transition: background 0.3s;"
           onmouseover="this.style.background='#2980b9'"
           onmouseout="this.style.background='#3498db'">
            <i class="fas fa-plus"></i> Add Update
        </a>
    </div>

    {% if messages %}
        {% for message in messages %}
        <div style="padding: 15px; margin-bottom: 20px; background: {% if message.tags == 'success' %}#d4edda{% else %}#f8d7da{% endif %}; color: {% if message.tags == 'success' %}#155724{% else %}#721c24{% endif %}; border-radius: 6px; border-left: 4px solid {% if message.tags == 'success' %}#28a745{% else %}#dc3545{% endif %};">
            <i class="fas fa-{% if message.tags == 'success' %}check-circle{% else %}exclamation-circle{% endif %}"></i>
            {{ message }}
        </div>
        {% endfor %}
    {% endif %}

    <!-- Filter Section -->
    <div style="background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); padding: 20px; margin-bottom: 20px;">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
            <!-- Search -->
            <div>
                <label style="display: block; margin-bottom: 5px; color: #2c3e50; font-weight: 600; font-size: 13px;">
                    <i class="fas fa-search"></i> Search
                </label>
                <input type="text" 
                       id="searchInput"
                       value="{{ search_query }}" 
                       placeholder="Search client, branch, software..." 
                       style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px; transition: border 0.3s;"
                       onfocus="this.style.borderColor='#3498db'"
                       onblur="this.style.borderColor='#e0e0e0'">
            </div>

            <!-- Branch Filter -->
            <div>
                <label style="display: block; margin-bottom: 5px; color: #2c3e50; font-weight: 600; font-size: 13px;">
                    <i class="fas fa-building"></i> Branch
                </label>
                <select id="branchFilter"
                        style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px; cursor: pointer; transition: border 0.3s;"
                        onfocus="this.style.borderColor='#3498db'"
                        onblur="this.style.borderColor='#e0e0e0'">
                    <option value="">All Branches</option>
                    {% for branch in branches %}
                    <option value="{{ branch.name }}" {% if branch_filter == branch.name %}selected{% endif %}>
                        {{ branch.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <!-- Software Filter -->
            <div>
                <label style="display: block; margin-bottom: 5px; color: #2c3e50; font-weight: 600; font-size: 13px;">
                    <i class="fas fa-laptop-code"></i> Software
                </label>
                <select id="softwareFilter"
                        style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px; cursor: pointer; transition: border 0.3s;"
                        onfocus="this.style.borderColor='#3498db'"
                        onblur="this.style.borderColor='#e0e0e0'">
                    <option value="">All Software</option>
                    {% for software in softwares %}
                    <option value="{{ software.name }}" {% if software_filter == software.name %}selected{% endif %}>
                        {{ software.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <!-- Status Filter -->
            <div>
                <label style="display: block; margin-bottom: 5px; color: #2c3e50; font-weight: 600; font-size: 13px;">
                    <i class="fas fa-flag"></i> Status
                </label>
                <select id="statusFilter"
                        style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px; cursor: pointer; transition: border 0.3s;"
                        onfocus="this.style.borderColor='#3498db'"
                        onblur="this.style.borderColor='#e0e0e0'">
                    <option value="">All Status</option>
                    <option value="Pending" {% if status_filter == 'Pending' %}selected{% endif %}>Pending</option>
                    <option value="In review" {% if status_filter == 'In review' %}selected{% endif %}>In review</option>
                    <option value="Completed" {% if status_filter == 'Completed' %}selected{% endif %}>Completed</option>
                    <option value="Under Development" {% if status_filter == 'Under Development' %}selected{% endif %}>Under Development</option>
                </select>
            </div>

            <!-- Date From -->
            <div>
                <label style="display: block; margin-bottom: 5px; color: #2c3e50; font-weight: 600; font-size: 13px;">
                    <i class="fas fa-calendar-alt"></i> Date From
                </label>
                <input type="date" 
                       id="dateFrom"
                       value="{{ date_from }}" 
                       style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px; transition: border 0.3s;"
                       onfocus="this.style.borderColor='#3498db'"
                       onblur="this.style.borderColor='#e0e0e0'">
            </div>

            <!-- Date To -->
            <div>
                <label style="display: block; margin-bottom: 5px; color: #2c3e50; font-weight: 600; font-size: 13px;">
                    <i class="fas fa-calendar-check"></i> Date To
                </label>
                <input type="date" 
                       id="dateTo"
                       value="{{ date_to }}" 
                       style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px; transition: border 0.3s;"
                       onfocus="this.style.borderColor='#3498db'"
                       onblur="this.style.borderColor='#e0e0e0'">
            </div>
        </div>

        <!-- Filter Buttons -->
        <div style="display: flex; gap: 10px; justify-content: flex-end;">
            <button onclick="clearFilters()" 
                    style="padding: 10px 25px; background: #95a5a6; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; transition: background 0.3s;"
                    onmouseover="this.style.background='#7f8c8d'"
                    onmouseout="this.style.background='#95a5a6'">
                <i class="fas fa-times"></i> Clear All
            </button>
        </div>
    </div>

    <!-- Table Section -->
    <div style="background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); overflow: hidden;">
        {% if complaints %}
        <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: #34495e; color: white;">
                        <th style="padding: 15px; text-align: left; font-weight: 600; border-bottom: 2px solid #2c3e50;">
                            <i class="fas fa-hashtag"></i> S.No
                        </th>
                        <th style="padding: 15px; text-align: left; font-weight: 600; border-bottom: 2px solid #2c3e50;">
                            <i class="fas fa-calendar"></i> Date
                        </th>
                        <th style="padding: 15px; text-align: left; font-weight: 600; border-bottom: 2px solid #2c3e50;">
                            <i class="fas fa-user-circle"></i> Requested By
                        </th>
                        <th style="padding: 15px; text-align: left; font-weight: 600; border-bottom: 2px solid #2c3e50;">
                            <i class="fas fa-user"></i> Client Name
                        </th>
                        <th style="padding: 15px; text-align: left; font-weight: 600; border-bottom: 2px solid #2c3e50;">
                            <i class="fas fa-building"></i> Branch
                        </th>
                        <th style="padding: 15px; text-align: left; font-weight: 600; border-bottom: 2px solid #2c3e50;">
                            <i class="fas fa-laptop-code"></i> Software
                        </th>
                        <th style="padding: 15px; text-align: left; font-weight: 600; border-bottom: 2px solid #2c3e50;">
                            <i class="fas fa-cog"></i> Updations
                        </th>
                        <th style="padding: 15px; text-align: left; font-weight: 600; border-bottom: 2px solid #2c3e50;">
                            <i class="fas fa-flag"></i> Status
                        </th>
                        <th style="padding: 15px; text-align: center; font-weight: 600; border-bottom: 2px solid #2c3e50;">
                            <i class="fas fa-tools"></i> Actions
                        </th>
                    </tr>
                </thead>
                <tbody>
                    {% for complaint in complaints %}
                    <tr style="border-bottom: 1px solid #ecf0f1; transition: background 0.2s;"
                        onmouseover="this.style.background='#f8f9fa'"
                        onmouseout="this.style.background='white'">
                        <td style="padding: 15px; color: #2c3e50; font-weight: 600;">{{ complaints.start_index|add:forloop.counter0 }}</td>
                        <td style="padding: 15px; color: #7f8c8d; font-size: 13px;">
                            {{ complaint.created_at|date:"d M Y" }}
                        </td>
                        <td style="padding: 15px; color: #2c3e50;">
                            {% if complaint.requested_by %}
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <i class="fas fa-user-circle" style="color: #667eea; font-size: 16px;"></i>
                                    <span>{{ complaint.requested_by.get_full_name|default:complaint.requested_by.username }}</span>
                                </div>
                            {% else %}
                                <span style="color: #95a5a6; font-style: italic;">N/A</span>
                            {% endif %}
                        </td>
                        <td style="padding: 15px; color: #2c3e50;">
                            {{ complaint.client_name }}
                        </td>
                        <td style="padding: 15px; color: #2c3e50;">
                            {{ complaint.branch }}
                        </td>
                        <td style="padding: 15px; color: #2c3e50;">
                            {{ complaint.get_software_display|default:complaint.software }}
                        </td>
                        <td style="padding: 15px; color: #555; max-width: 300px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex: 1;" title="{{ complaint.description }}">
                                    {{ complaint.description|truncatewords:15 }}
                                </div>
                                {% if complaint.voice_note %}
                                <i class="fas fa-microphone" style="color: #e74c3c;" title="Has voice note"></i>
                                {% endif %}
                                {% if complaint.images %}
                                <i class="fas fa-image" style="color: #3498db;" title="Has images"></i>
                                {% endif %}
                            </div>
                        </td>
                        <td style="padding: 15px;">
                            <form method="POST" action="{% url 'software_update_status' complaint.id %}" style="margin: 0;">
                                {% csrf_token %}
                                <select name="status"
                                        onchange="this.form.submit()"
                                        style="padding: 6px 12px;
                                               border-radius: 20px;
                                               font-size: 12px;
                                               font-weight: 600;
                                               border: 2px solid;
                                               cursor: pointer;
                                               background:
                                               {% if complaint.status == 'Pending' %}#fff3cd
                                               {% elif complaint.status == 'In Review' %}#e2e3ff
                                               {% elif complaint.status == 'Under Development' %}#cfe2ff
                                               {% elif complaint.status == 'Completed' %}#d1e7dd
                                               {% endif %};
                                               color:
                                               {% if complaint.status == 'Pending' %}#856404
                                               {% elif complaint.status == 'In Review' %}#3d3dbf
                                               {% elif complaint.status == 'Under Development' %}#084298
                                               {% elif complaint.status == 'Completed' %}#0f5132
                                               {% endif %};
                                               border-color:
                                               {% if complaint.status == 'Pending' %}#ffc107
                                               {% elif complaint.status == 'In Review' %}#6f42c1
                                               {% elif complaint.status == 'Under Development' %}#0d6efd
                                               {% elif complaint.status == 'Completed' %}#198754
                                               {% endif %};">
                                    <option value="Pending" {% if complaint.status == 'Pending' %}selected{% endif %}>
                                        Pending
                                    </option>
                                    <option value="In Review" {% if complaint.status == 'In Review' %}selected{% endif %}>
                                        In Review
                                    </option>
                                    <option value="Under Development" {% if complaint.status == 'Under Development' %}selected{% endif %}>
                                        Under Development
                                    </option>
                                    <option value="Completed" {% if complaint.status == 'Completed' %}selected{% endif %}>
                                        Completed
                                    </option>
                                </select>
                            </form>
                        </td>
                        <td style="padding: 15px; text-align: center;">
                            <div style="display: flex; gap: 8px; justify-content: center;">
                                <a href="{% url 'software_details' complaint.id %}" class="action-btn view-btn" title="View">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <a href="{% url 'software_edit' complaint.id %}" class="action-btn edit-btn" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <form method="POST" action="{% url 'software_delete' complaint.id %}" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this complaint?');">
                                    {% csrf_token %}
                                    <button type="submit" class="action-btn delete-btn" title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        {% if complaints.has_other_pages %}
        <div style="padding: 20px; border-top: 1px solid #ecf0f1; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
            <div style="color: #7f8c8d; font-size: 14px;">
                Page {{ complaints.number }} of {{ complaints.paginator.num_pages }}
            </div>
            
            <div style="display: flex; gap: 5px; align-items: center;">
                {% if complaints.has_previous %}
                <a href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}{% if branch_filter %}&branch={{ branch_filter }}{% endif %}{% if software_filter %}&software={{ software_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}" 
                   class="page-btn">
                    <i class="fas fa-angle-double-left"></i>
                </a>
                <a href="?page={{ complaints.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if branch_filter %}&branch={{ branch_filter }}{% endif %}{% if software_filter %}&software={{ software_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}" 
                   class="page-btn">
                    <i class="fas fa-angle-left"></i>
                </a>
                {% endif %}

                {% for num in complaints.paginator.page_range %}
                    {% if complaints.number == num %}
                        <span class="page-btn active">{{ num }}</span>
                    {% elif num > complaints.number|add:'-3' and num < complaints.number|add:'3' %}
                        <a href="?page={{ num }}{% if search_query %}&search={{ search_query }}{% endif %}{% if branch_filter %}&branch={{ branch_filter }}{% endif %}{% if software_filter %}&software={{ software_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}" 
                           class="page-btn">{{ num }}</a>
                    {% endif %}
                {% endfor %}

                {% if complaints.has_next %}
                <a href="?page={{ complaints.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if branch_filter %}&branch={{ branch_filter }}{% endif %}{% if software_filter %}&software={{ software_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}" 
                   class="page-btn">
                    <i class="fas fa-angle-right"></i>
                </a>
                <a href="?page={{ complaints.paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}{% if branch_filter %}&branch={{ branch_filter }}{% endif %}{% if software_filter %}&software={{ software_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}" 
                   class="page-btn">
                    <i class="fas fa-angle-double-right"></i>
                </a>
                {% endif %}
            </div>
        </div>
        {% endif %}

        {% else %}
        <div style="padding: 60px 20px; text-align: center; color: #7f8c8d;">
            <i class="fas fa-inbox" style="font-size: 64px; margin-bottom: 20px; opacity: 0.5;"></i>
            <h3 style="margin: 0 0 10px 0; color: #95a5a6;">No Complaints Found</h3>
            {% if search_query or branch_filter or software_filter or status_filter or date_from or date_to %}
            <p style="margin: 0;">No results match your filters. Try adjusting your search criteria.</p>
            {% else %}
            <p style="margin: 0;">Click "Add Update" to create your first software update request.</p>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>

<style>
    select:focus {
        outline: none;
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
    }
    
    .action-btn {
        padding: 8px 12px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 13px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        text-decoration: none;
        transition: all 0.2s ease;
        font-weight: 500;
        min-width: 38px;
    }
    
    .view-btn {
        background: #e3f2fd;
        color: #1976d2;
        border: 1px solid #bbdefb;
    }
    
    .view-btn:hover {
        background: #1976d2;
        color: white;
        border-color: #1976d2;
    }
    
    .edit-btn {
        background: #e8f5e9;
        color: #388e3c;
        border: 1px solid #c8e6c9;
    }
    
    .edit-btn:hover {
        background: #388e3c;
        color: white;
        border-color: #388e3c;
    }
    
    .delete-btn {
        background: #ffebee;
        color: #d32f2f;
        border: 1px solid #ffcdd2;
    }
    
    .delete-btn:hover {
        background: #d32f2f;
        color: white;
        border-color: #d32f2f;
    }
    
    .action-btn i {
        font-size: 14px;
    }

    .page-btn {
        padding: 8px 12px;
        border: 1px solid #e0e0e0;
        border-radius: 5px;
        background: white;
        color: #2c3e50;
        text-decoration: none;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 38px;
    }

    .page-btn:hover {
        background: #3498db;
        color: white;
        border-color: #3498db;
    }

    .page-btn.active {
        background: #3498db;
        color: white;
        border-color: #3498db;
        cursor: default;
    }
</style>

<script>
    let searchTimeout;
    
    document.getElementById('searchInput').addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(applyFilters, 500);
    });
    
    document.getElementById('branchFilter').addEventListener('change', applyFilters);
    document.getElementById('softwareFilter').addEventListener('change', applyFilters);
    document.getElementById('statusFilter').addEventListener('change', applyFilters);
    document.getElementById('dateFrom').addEventListener('change', applyFilters);
    document.getElementById('dateTo').addEventListener('change', applyFilters);
    
    function applyFilters() {
        const search = document.getElementById('searchInput').value;
        const branch = document.getElementById('branchFilter').value;
        const software = document.getElementById('softwareFilter').value;
        const status = document.getElementById('statusFilter').value;
        const dateFrom = document.getElementById('dateFrom').value;
        const dateTo = document.getElementById('dateTo').value;
        
        let url = '?';
        const params = [];
        
        if (search) params.push('search=' + encodeURIComponent(search));
        if (branch) params.push('branch=' + encodeURIComponent(branch));
        if (software) params.push('software=' + encodeURIComponent(software));
        if (status) params.push('status=' + encodeURIComponent(status));
        if (dateFrom) params.push('date_from=' + dateFrom);
        if (dateTo) params.push('date_to=' + dateTo);
        
        url += params.join('&');
        
        window.location.href = url || '{% url "software_update" %}';
    }
    
    function clearFilters() {
        window.location.href = '{% url "software_update" %}';
    }
</script>
{% endblock %}