{% extends 'base.html' %}
{% load humanize %}
{% block title %}SIM Recharge History - {{ sim.sim_no }}{% endblock %}
{% block header %}SIM Recharge History - {{ sim.sim_no }}{% endblock %}

{% block content %}
<div class="container mt-4"> 
    <div class="card"> 
        {# ---------- HEADER ---------- #} 
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center"> 
            <h5 class="mb-0"><i class="bi bi-sim"></i> SIM Recharge History</h5> 
            <div> {# NEW – quick-add recharge #} 
                <a href="{% url 'add_recharge' sim.id %}" class="btn btn-light btn-sm me-2"> <i class="bi bi-plus-circle"></i> Add Recharge </a> 
                <a href="{% url 'sim_management' %}" class="btn btn-light btn-sm"> <i class="bi bi-arrow-left"></i> Back to SIM Management </a> 
            </div>
         </div>
        <div class="card-body">
            <!-- SIM Information -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card border-primary">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0"><i class="bi bi-sim"></i> SIM Info</h6>
                        </div>
                        <div class="card-body">
                            <p class="mb-2"><strong>SIM No:</strong> <span class="text-primary">{{ sim.sim_no }}</span></p>
                            <p class="mb-2"><strong>Provider:</strong> {{ sim.provider }}</p>
                            <p class="mb-2"><strong>Branch:</strong> {{ sim.branch|default:"-" }}</p>
                            <p class="mb-0"><strong>In-charge:</strong> {{ sim.incharge|default:"-" }}</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card border-success">
                        <div class="card-header bg-success text-white">
                            <h6 class="mb-0"><i class="bi bi-calendar-check"></i> Current Status</h6>
                        </div>
                        <div class="card-body">
                            <p class="mb-2"><strong>Last Recharge:</strong>
                                <span class="badge bg-info">{{ sim.last_recharge_date|date:"d-m-Y"|default:"-" }}</span>
                            </p>
                            <p class="mb-2"><strong>Amount:</strong>
                                <span class="text-success">₹{{ sim.amount|default:"-" }}</span>
                            </p>
                            <p class="mb-2"><strong>Validity:</strong>
                                <span class="badge bg-warning text-dark">{{ sim.validity|date:"d-m-Y"|default:"-" }}</span>
                            </p>
                            {% if sim.days_remaining is not None %}
                                <p class="mb-0"><strong>Days Left:</strong>
                                    <span class="badge {% if sim.days_remaining <= 0 %}bg-danger{% elif sim.days_remaining <= 5 %}bg-warning text-dark{% else %}bg-success{% endif %}">
                                        {% if sim.days_remaining < 0 %}
    Expired {{ sim.days_remaining_abs }} day{{ sim.days_remaining_abs|pluralize }} ago
{% elif sim.days_remaining == 0 %}
    Expires today
{% else %}
    {{ sim.days_remaining }} day{{ sim.days_remaining|pluralize }} left
{% endif %}

                                    </span>
                                </p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recharge History Table -->
            {% if recharges %}
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0"><i class="bi bi-clock-history"></i> Recharge History</h6>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover mb-0">
                                <thead class="table-dark">
                                    <tr>
                                        <th>#</th>
                                        <th>Date</th>
                                        <th>Amount</th>
                                        <th>Recharged By</th>
                                        <th>Notes</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for r in recharges %}
                                        <tr {% if forloop.first %}class="table-success"{% endif %}>
                                            <td>{% if forloop.first %}<i class="bi bi-star-fill text-warning"></i>{% endif %} {{ forloop.counter }}</td>
                                            <td><strong>{{ r.recharge_date|date:"d-m-Y" }}</strong><br><small class="text-muted">{{ r.recharge_date|date:"l" }}</small></td>
                                            <td><span class="badge bg-success">₹{{ r.amount|floatformat:2 }}</span></td>
                                            <td>{{ r.recharged_by|default:"-" }}</td>
                                            <td><small>{{ r.notes|default:"-"|truncatechars:50 }}</small></td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card-footer bg-light d-flex justify-content-between">
                        <span><strong>Total recharges:</strong> {{ recharges.count }}</span>
                        <span><strong>Grand total:</strong> <span class="text-success">₹{{ total_amount|floatformat:2 }}</span></span>
                    </div>
                </div>
            {% else %}
                <div class="alert alert-info text-center">
                    <i class="bi bi-info-circle fs-2"></i>
                    <h5 class="mt-3">No recharge history found</h5>
                    <p class="mb-0">This SIM has not been recharged yet.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}