{% extends 'base.html' %}
{% block title %}Add New SIM{% endblock %}
{% block header %}Add New SIM{% endblock %}

{% block content %}
<style>
  /* ---------- mini design-system ---------- */
  .add-sim-card{max-width:700px;margin:2rem auto;background:#fff;border-radius:10px;box-shadow:0 4px 18px rgba(0,0,0,.08);}
  .add-sim-card .form-label{margin-bottom:.35rem;font-weight:500;color:#444;font-size:.9rem}
  .add-sim-card .form-control,.add-sim-card .form-select{min-height:38px;font-size:.95rem;border:1px solid #ced4da;border-radius:6px}
  .add-sim-card .form-control:focus,.add-sim-card .form-select:focus{box-shadow:0 0 0 .2rem rgba(0,123,255,.15);border-color:#80bdff}
  .add-sim-card .btn{min-width:90px;font-size:.9rem;border-radius:6px;padding:.45rem 1rem}
  .add-sim-card .btn-secondary{background:#6c757d;border-color:#6c757d}
  .add-sim-card .btn-primary{background:#007bff;border-color:#007bff}
  .add-sim-card .row{margin-bottom:1.1rem}
  .add-sim-card h3{margin-top:.2rem;font-weight:600;color:#333}
</style>

<div class="container add-sim-card p-4">
  <h3 class="mb-4">{% if sim %}Edit SIM{% else %}Add New SIM{% endif %}</h3>
  <form method="post" enctype="multipart/form-data">
  {% csrf_token %}

  <!-- add_sim.html â€“ full snippet of the rows that changed -->
<div class="row">
  <div class="col-md-6 mb-3">
    <label class="form-label">SIM No</label>
    <input type="text" name="sim_no" class="form-control"
       value="{{ sim.sim_no|default:'' }}"
       required>
  </div>
  <div class="col-md-6 mb-3">
    <label class="form-label">Provider</label>
    <select name="provider" class="form-select" required>
      <option value="" disabled {% if not sim.provider %}selected{% endif %}>-- Select Provider --</option>
      <option value="Bsnl" {% if sim.provider == 'Bsnl' %}selected{% endif %}>Bsnl</option>
      <option value="Vi" {% if sim.provider == 'Vi' %}selected{% endif %}>Vi</option>
      <option value="Airtel" {% if sim.provider == 'Airtel' %}selected{% endif %}>Airtel</option>
      <option value="Jio" {% if sim.provider == 'Jio' %}selected{% endif %}>Jio</option>
    </select>
  </div>
</div>

<div class="row">
  <div class="col-md-6 mb-3">
    <label class="form-label">Identify Person</label>
    <select name="identify_person" class="form-select">
      <option value="" disabled selected>-- Select User --</option>
      {% for u in users %}
        <option value="{{ u.pk }}"   
          {% if sim.identify_person == u.name %}selected{% endif %}>
          {{ u.name }}
        </option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-6 mb-3">
    <label class="form-label">In-charge</label>
    <select name="incharge" class="form-select">
      <option value="" disabled selected>-- Select User --</option>
      {% for u in users %}
        <option value="{{ u.pk }}"  
          {% if sim.incharge == u.name %}selected{% endif %}>
          {{ u.name }}
        </option>
      {% endfor %}
    </select>
  </div>
</div>

<div class="row">
  <div class="col-md-6 mb-3">
    <label class="form-label">Last Recharge Date</label>
    <input type="date" name="last_recharge_date" class="form-control"
           value="{{ sim.last_recharge_date|date:'Y-m-d'|default:'' }}">
  </div>
  <div class="col-md-6 mb-3">
    <label class="form-label">Amount</label>
    <input type="number" name="amount" class="form-control"
           value="{{ sim.amount|default:'' }}">
  </div>
</div>

<!-- NEW ROW: Recharged By + Validity Days -->
<div class="row">
  <div class="col-md-6 mb-3">
  <label class="form-label">Recharged By</label>
  <select name="recharged_by" class="form-select">
    <option value="" disabled>-- Select User --</option>
    {% for u in users %}
      <option value="{{ u.pk }}" 
              {% if current_user and current_user.pk == u.pk %}selected{% endif %}
              {% if sim and sim.recharged_by == u.name %}selected{% endif %}>
        {{ u.name }}
      </option>
    {% endfor %}
  </select>
</div>
  <div class="col-md-6 mb-3">
    <label class="form-label">Validity (days)</label>
    <input type="number" name="validity_days" id="id_validity_days"
           class="form-control" min="0"
           value="{{ sim.validity_days|default:'' }}">
    <!-- hidden carrier for the calendar date -->
    <input type="hidden" name="validity_date" id="id_validity_date"
           value="{{ sim.validity_date|date:'Y-m-d'|default:'' }}">
  </div>
</div>

<div class="row">
  <div class="col-md-6 mb-3">
    <label class="form-label">Branch</label>
    <select name="branch" class="form-select" required>
      <option value="" disabled {% if not sim.branch %}selected{% endif %}>-- Select Branch --</option>
      <option value="Sysmac Info" {% if sim.branch == 'Sysmac Info' %}selected{% endif %}>Sysmac Info</option>
      <option value="Sysmac Computers" {% if sim.branch == 'Sysmac Computers' %}selected{% endif %}>Sysmac Computers</option>
      <option value="IMC Dev" {% if sim.branch == 'IMC Dev' %}selected{% endif %}>IMC Dev</option>
      <option value="IMC-HO" {% if sim.branch == 'IMC-HO' %}selected{% endif %}>IMC-HO</option>
      <option value="IMC Mukkam" {% if sim.branch == 'IMC Mukkam' %}selected{% endif %}>IMC Mukkam</option>
    </select>
  </div>
</div>

  <div class="d-flex justify-content-between mt-4">
    <a href="{% url 'sim_management' %}" class="btn btn-secondary">Cancel</a>
    <button type="submit" class="btn btn-primary">{% if sim %}Update SIM{% else %}Save SIM{% endif %}</button>
  </div>
</form>
</div>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const daysInput   = document.getElementById('id_validity_days');
  const dateInput   = document.getElementById('id_validity_date');
  const rechargeInp = document.querySelector('input[name="last_recharge_date"]');

  function calcDate() {
    const days = parseInt(daysInput.value, 10);
    const rDate = rechargeInp.value;
    if (!isNaN(days) && rDate) {
      const d = new Date(rDate);
      d.setDate(d.getDate() + days);
      dateInput.value = d.toISOString().split('T')[0];
    }
  }
  daysInput.addEventListener('input', calcDate);
  rechargeInp.addEventListener('change', calcDate);
});
</script>
{% endblock %}