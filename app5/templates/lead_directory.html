<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lead Directory - Standalone</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: #f0f2f5;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1600px;
            width: 100%;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* LEAD DIRECTORY CONTAINER */
        .lead-directory-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            height: 100%;
            max-height: calc(100vh - 40px);
            display: flex;
            flex-direction: column;
        }
        
        /* DIRECTORY HEADER */
        .directory-header {
            background: #4a6fdc;
            color: white;
            padding: 12px 15px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        
        .directory-left {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            text-align: left;
        }
        
        .directory-left h2 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .directory-date {
            font-size: 13px;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .directory-date i {
            font-size: 12px;
        }
        
        .directory-right {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            text-align: right;
        }
        
        .directory-info-row {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 4px;
        }
        
        .directory-count {
            font-size: 13px;
            font-weight: 500;
            opacity: 0.9;
        }
        
        .directory-today {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .directory-today i {
            font-size: 11px;
        }
        
        /* DIRECTORY TABS */
        .directory-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }
        
        .directory-tab {
            flex: 1;
            padding: 10px 12px;
            text-align: center;
            background: transparent;
            border: none;
            font-weight: 600;
            font-size: 13px;
            color: #6c757d;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }
        
        .directory-tab.active {
            color: #4a6fdc;
            border-bottom-color: #4a6fdc;
            background: white;
        }
        
        .directory-tab:hover {
            background: #e9ecef;
        }
        
        /* DIRECTORY CONTROLS */
        .directory-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            gap: 10px;
        }
        
        .directory-search-container {
            flex: 1;
            min-width: 0;
        }
        
        .search-box {
            position: relative;
            width: 100%;
        }
        
        .search-box input {
            padding: 8px 12px 8px 35px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 13px;
            width: 100%;
            background: white;
        }
        
        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
            font-size: 13px;
        }
        
        .directory-filter-container {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
        }
        
        .filter-label {
            font-size: 13px;
            font-weight: 600;
            color: #495057;
            white-space: nowrap;
        }
        
        .filter-select {
            padding: 6px 8px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 13px;
            background: white;
            cursor: pointer;
            min-width: 120px;
        }
        
        /* LISTS */
        .employee-list, .lead-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px 0;
            display: none;
        }
        
        .employee-list.active, .lead-list.active {
            display: block;
        }
        
        .employee-item, .lead-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.2s;
            cursor: pointer;
        }
        
        .lead-item.selected {
            background: #e3f2fd;
            border-left: 4px solid #2575fc;
        }
        
        .employee-item:hover, .lead-item:hover {
            background: #f8f9fa;
        }
        
        .employee-avatar, .lead-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #4a6fdc;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 12px;
            margin-right: 12px;
            flex-shrink: 0;
        }
        
        .lead-avatar {
            background: #28a745;
        }
        
        .employee-details, .lead-details {
            flex: 1;
            min-width: 0;
        }
        
        .employee-name, .lead-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 2px;
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .employee-role, .lead-info {
            font-size: 12px;
            color: #6c757d;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .lead-phone {
            font-size: 11px;
            color: #495057;
            margin-top: 1px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .lead-ticket {
            font-size: 10px;
            color: #6c757d;
            background: #f8f9fa;
            border-radius: 4px;
            display: inline-block;
            margin-top: 2px;
        }
        
        .lead-status {
            font-size: 10px;
            color: #28a745;
            font-weight: 600;
            margin-top: 2px;
        }
        
        .assign-btn {
            padding: 5px 10px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        
        .assign-btn:hover {
            background: #45a049;
        }
        
        .assign-btn.assigned {
            background: #6c757d;
        }
        
        .no-results {
            padding: 20px 15px;
            text-align: center;
            color: #6c757d;
            font-size: 13px;
        }
        
        /* DATE AND TIME ELAPSED LAYOUT */
        .date-time-container {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 3px;
            min-width: 80px;
        }
        
        .lead-date-compact {
            font-size: 10px;
            color: #6c757d;
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 3px;
            margin-left: auto;
            font-weight: 500;
        }
        
        .lead-datetime {
            font-size: 9px;
            color: #888;
            margin-top: 1px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .lead-datetime i {
            font-size: 8px;
        }
        
        .lead-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            width: 100%;
            margin-bottom: 8px;
        }
        
        .lead-name-container {
            display: flex;
            align-items: center;
            gap: 5px;
            flex: 1;
            min-width: 0;
        }
        
        .lead-priority-indicator {
            font-size: 12px;
            margin-right: 3px;
        }
        
        .lead-info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 3px;
            width: 100%;
        }
        
        /* Time elapsed badge */
        .time-elapsed-badge {
            font-size: 9px !important;
            font-weight: 600 !important;
            padding: 2px 6px !important;
            border-radius: 10px !important;
            display: inline-flex !important;
            align-items: center !important;
            gap: 4px !important;
            background: rgba(0, 0, 0, 0.05) !important;
            color: #666 !important;
            white-space: nowrap !important;
        }
        
        .time-elapsed-badge.time-recent {
            background: rgba(34, 197, 94, 0.15) !important;
            color: #16a34a !important;
        }
        
        .time-elapsed-badge.time-medium {
            background: rgba(245, 158, 11, 0.15) !important;
            color: #d97706 !important;
        }
        
        .time-elapsed-badge.time-old {
            background: rgba(239, 68, 68, 0.15) !important;
            color: #dc2626 !important;
        }
        
        /* Campaign tooltip */
        .lead-campaign {
            position: relative;
            cursor: help;
            font-size: 11px;
            color: #666;
            margin-top: 2px;
            display: flex;
            align-items: center;
            gap: 3px;
            font-style: italic;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .lead-campaign:hover::after {
            content: attr(title);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 1000;
            margin-bottom: 5px;
            max-width: 300px;
            word-wrap: break-word;
        }
        
        .lead-campaign:hover::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: #333;
            margin-bottom: -5px;
            z-index: 1000;
        }
        
        /* PAGINATION */
        .directory-pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 12px 15px;
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
            gap: 10px;
        }
        
        .pagination-info {
            font-size: 12px;
            color: #6c757d;
            margin: 0 10px;
        }
        
        .pagination-btn {
            padding: 6px 12px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            color: #4a6fdc;
        }
        
        .pagination-btn:hover:not(:disabled) {
            background: #4a6fdc;
            color: white;
            border-color: #4a6fdc;
        }
        
        .pagination-btn:disabled {
            background: #f8f9fa;
            color: #6c757d;
            cursor: not-allowed;
        }
        
        .pagination-numbers {
            display: flex;
            gap: 5px;
        }
        
        .page-number {
            padding: 6px 10px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            color: #495057;
        }
        
        .page-number.active {
            background: #4a6fdc;
            color: white;
            border-color: #4a6fdc;
        }
        
        .page-number:hover:not(.active) {
            background: #e9ecef;
        }
        
        /* Selected Lead Highlighting */
        .lead-item.selected {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb) !important;
            border-left: 5px solid #2575fc !important;
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(37, 117, 252, 0.3) !important;
            transition: all 0.3s ease;
        }
        
        .lead-item.selected .lead-name {
            color: #1565c0;
            font-weight: 700;
        }
        
        .lead-item.selected .lead-avatar {
            background: linear-gradient(135deg, #2575fc, #6a11cb);
            color: white;
            font-weight: bold;
        }
        
        /* RESPONSIVE DESIGN */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .directory-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .directory-left, .directory-right {
                width: 100%;
                align-items: flex-start;
                text-align: left;
            }
            
            .directory-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .directory-search-container {
                width: 100%;
            }
            
            .directory-filter-container {
                width: 100%;
                justify-content: space-between;
            }
            
            .employee-item, .lead-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .assign-btn {
                align-self: flex-end;
            }
            
            .lead-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
            
            .lead-date-compact {
                margin-left: 0;
                margin-top: 5px;
            }
            
            .date-time-container {
                align-items: flex-start;
                margin-top: 5px;
            }
            
            .directory-pagination {
                flex-direction: column;
                gap: 8px;
            }
            
            .pagination-numbers {
                order: 3;
                width: 100%;
                justify-content: center;
                margin-top: 8px;
            }
        }
        
        @media (max-width: 576px) {
            body {
                padding: 10px;
            }
            
            .directory-pagination {
                flex-direction: column;
                gap: 8px;
            }
            
            .pagination-numbers {
                order: 0;
                width: 100%;
                justify-content: center;
            }
            
            .pagination-info {
                order: 1;
            }
            
            .pagination-buttons {
                order: 2;
                display: flex;
                gap: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="lead-directory-container">
            <!-- UPDATED DIRECTORY HEADER - Left/Right Alignment -->
            <div class="directory-header">
                <div class="directory-left">
                    <h2>Lead Management</h2>
                    <div class="directory-date" id="currentDate">
                        <i class="far fa-calendar-alt"></i>
                        Loading date...
                    </div>
                </div>
                <div class="directory-right">
                    <div class="directory-info-row">
                        <div class="directory-count">Leads: <span id="activeTabCount">{{ active_leads_data|length }}</span></div>
                        <div class="directory-today" id="todayDate">
                            <i class="far fa-clock"></i>
                            Loading time...
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Directory Tabs -->
            <div class="directory-tabs">
                <button class="directory-tab active" data-tab="leads">Active Leads</button>
                <button class="directory-tab" data-tab="employees">Employees</button>
            </div>
            
            <!-- UPDATED SEARCH AND FILTER - Combined in one row -->
            <div class="directory-controls">
                <div class="directory-search-container">
                    <div class="search-box">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" id="directorySearch" placeholder="Search leads...">
                    </div>
                </div>
                <div class="directory-filter-container">
                    <span class="filter-label">Priority:</span>
                    <select id="priorityFilter" class="filter-select">
                        <option value="all">All</option>
                        <option value="High">游댮 High</option>
                        <option value="Medium">游리 Medium</option>
                        <option value="Low">游릭 Low</option>
                    </select>
                </div>
            </div>
            
            <!-- Lead List (shown by default) -->
            <div class="lead-list active" id="leadList">
                {% if active_leads_data %}
                    {% for lead in active_leads_data %}
                    <div class="lead-item"
                        data-id="{{ lead.id }}"
                        data-index="{{ forloop.counter0 }}"
                        onclick="openLead('{{ lead.id }}', {{ forloop.counter0 }})">
                        
                        <div class="lead-avatar">
                            {{ lead.ownerName|default:""|slice:":2"|upper }}
                        </div>
                        
                        <div class="lead-details">
                            <div class="lead-header">
                                <div class="lead-name-container">
                                    <span class="lead-priority-indicator">
                                        {% if lead.priority == "High" %}游댮
                                        {% elif lead.priority == "Medium" %}游리
                                        {% elif lead.priority == "Low" %}游릭
                                        {% else %}丘뿉% endif %}
                                    </span>
                                    <span class="lead-name">{{ lead.ownerName }}</span>
                                </div>
                                
                                <!-- DATE AND TIME ELAPSED CONTAINER -->
                                <div class="date-time-container">
                                    {% if lead.created_at %}
                                    <div class="lead-date-compact" title="Created: {{ lead.created_at|date:'l, d F Y' }}">
                                        <i class="far fa-calendar-alt"></i>
                                        {{ lead.created_at|date:"d M" }}
                                    </div>
                                    {% endif %}
                                    
                                    <!-- TIME ELAPSED BADGE - Place it right below the date -->
                                    <div class="time-elapsed-badge" 
                                        data-created="{{ lead.created_at|date:'c'|default:lead.date|date:'c' }}">
                                        <i class="fas fa-clock"></i>
                                        <span class="elapsed-text">{{ lead.time_elapsed|default:"Calculating..." }}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="lead-phone">{{ lead.phoneNo }}</div>
                            <div class="lead-ticket">{{ lead.ticket_number }}</div>
                            {% if lead.created_at %}
                            <div class="lead-datetime">
                                <i class="far fa-clock"></i>
                                Created at {{ lead.created_at|time:"H:i" }}
                            </div>
                            {% endif %}
                            <div class="lead-info-row">
                                <div class="lead-status">Status: {{ lead.status }}</div>
                                <span style="color: {% if lead.priority == 'High' %}#ff4444{% elif lead.priority == 'Medium' %}#ffaa00{% else %}#22c55e{% endif %}; font-weight: 600; font-size: 10px; padding: 2px 8px; border-radius: 10px; background: {% if lead.priority == 'High' %}#ff444415{% elif lead.priority == 'Medium' %}#ffaa0015{% else %}#22c55e15{% endif %};">
                                    {{ lead.priority|default:"Medium" }}
                                </span>
                            </div>
                            {% if lead.campaign_display %}
                            <div class="lead-campaign" title="{{ lead.campaign_display }}">
                                <i class="fas fa-bullhorn" style="font-size: 9px;"></i>
                                <span>{{ lead.campaign_display|truncatechars:40 }}</span>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="no-results">No active leads found</div>
                {% endif %}
            </div>
            
            <!-- Employee List (hidden by default) -->
            <div class="employee-list" id="employeeList">
                {% if active_users %}
                    {% for u in active_users %}
                    <div class="employee-item" data-id="{{ u.id }}" data-name="{{ u.name|escapejs }}">
                        <div class="employee-avatar">
                            {{ u.name|slice:":2"|upper }}
                        </div>
                        
                        <div class="employee-details">
                            <div class="employee-name">{{ u.name }}</div>
                            <div class="employee-role">
                                {{ u.department }}{% if u.designation %} - {{ u.designation }}{% endif %}
                            </div>
                        </div>
                        
                        <button class="assign-btn" data-id="{{ u.id }}" data-name="{{ u.name|escapejs }}" data-role="employee-assign">
                            Assign
                        </button>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="no-results">No active users found</div>
                {% endif %}
            </div>
            
            <!-- Pagination -->
            <div class="directory-pagination" id="directoryPagination">
                <div class="pagination-buttons">
                    <button class="pagination-btn" id="prevPage" disabled>
                        <i class="fas fa-chevron-left"></i> Prev
                    </button>
                </div>
                
                <div class="pagination-numbers" id="paginationNumbers">
                    <!-- Page numbers will be generated here -->
                </div>
                
                <div class="pagination-info" id="paginationInfo">
                    Page 1 of 1
                </div>
                
                <div class="pagination-buttons">
                    <button class="pagination-btn" id="nextPage" disabled>
                        Next <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // ========== INITIALIZATION ==========
            console.log('游 Lead Directory initialized');
            
            // Pagination elements
            const prevPageBtn = document.getElementById('prevPage');
            const nextPageBtn = document.getElementById('nextPage');
            const paginationNumbers = document.getElementById('paginationNumbers');
            const paginationInfo = document.getElementById('paginationInfo');
            
            // Search and filter elements
            const directorySearch = document.getElementById('directorySearch');
            const priorityFilter = document.getElementById('priorityFilter');
            const directoryTabs = document.querySelectorAll('.directory-tab');
            const leadList = document.getElementById('leadList');
            const employeeList = document.getElementById('employeeList');
            
            // Current date display elements
            const currentDateElement = document.getElementById('currentDate');
            const todayDateElement = document.getElementById('todayDate');
            const activeTabCount = document.getElementById('activeTabCount');
            
            // ========== DATA ==========
            // Lead data from Django template
            const leads = [
                {% for lead in active_leads_data %}
                {
                    id: {{ lead.id }},
                    ownerName: "{{ lead.ownerName|escapejs }}",
                    phoneNo: "{{ lead.phoneNo|escapejs }}",
                    email: "{{ lead.email|escapejs }}",
                    ticketNo: "{{ lead.ticket_number|escapejs }}",
                    date: "{{ lead.date|date:'Y-m-d'|escapejs }}",
                    createdAt: "{{ lead.created_at|date:'Y-m-d'|escapejs }}",
                    createdTime: "{{ lead.created_at|time:'H:i'|escapejs }}",
                    status: "{{ lead.status|escapejs }}",
                    priority: "{{ lead.priority|default:'Medium'|escapejs }}",
                    campaign_display: "{{ lead.campaign_display|default:''|escapejs }}"
                }{% if not forloop.last %},{% endif %}
                {% endfor %}
            ];
            
            // Employee data from Django template
            const employees = [
                {% for u in active_users %}
                {
                    id: {{ u.id }},
                    name: "{{ u.name|escapejs }}",
                    department: "{{ u.department|escapejs }}",
                    designation: "{{ u.designation|escapejs }}"
                }{% if not forloop.last %},{% endif %}
                {% endfor %}
            ];
            
            console.log(`游늵 Loaded ${leads.length} leads and ${employees.length} employees`);
            
            // ========== PAGINATION CONFIG ==========
            const itemsPerPage = 10;
            let currentPage = 1;
            let totalPages = 1;
            let currentItems = [];
            let filteredItems = [];
            
            // ========== DATE FUNCTIONS ==========
            function updateDirectoryDateDisplay() {
                const now = new Date();
                
                // Format current date for left side
                const currentDateDisplay = now.toLocaleDateString('en-GB', {
                    weekday: 'short',
                    day: '2-digit',
                    month: 'short',
                    year: 'numeric'
                });
                
                // Format time for right side
                const timeDisplay = now.toLocaleTimeString('en-GB', {
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: true
                });
                
                // Format today's date for right side
                const todayDisplay = now.toLocaleDateString('en-GB', {
                    day: '2-digit',
                    month: 'short'
                });
                
                // Update DOM elements
                if (currentDateElement) {
                    currentDateElement.innerHTML = `<i class="far fa-calendar-alt"></i> ${currentDateDisplay}`;
                }
                
                if (todayDateElement) {
                    todayDateElement.innerHTML = `<i class="far fa-clock"></i> ${todayDisplay} ${timeDisplay}`;
                }
            }
            
            // ========== TIME ELAPSED FUNCTIONS ==========
            function updateAllTimeElapsedBadges() {
                const timeElapsedBadges = document.querySelectorAll('.time-elapsed-badge');
                
                timeElapsedBadges.forEach(badge => {
                    const createdDateStr = badge.getAttribute('data-created');
                    const elapsedText = badge.querySelector('.elapsed-text');
                    
                    if (!createdDateStr || !elapsedText) return;
                    
                    try {
                        const createdDate = new Date(createdDateStr);
                        const now = new Date();
                        const diffMs = now - createdDate;
                        
                        // Calculate time difference
                        const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                        const diffHours = Math.floor((diffMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                        const diffMinutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
                        
                        // Format the elapsed time
                        let elapsedTextValue = '';
                        let badgeClass = 'time-elapsed-badge';
                        
                        if (diffDays > 0) {
                            if (diffDays === 1) elapsedTextValue = '1 day ago';
                            else if (diffDays < 7) elapsedTextValue = `${diffDays} days ago`;
                            else if (diffDays < 30) elapsedTextValue = `${Math.floor(diffDays / 7)} week${Math.floor(diffDays / 7) > 1 ? 's' : ''} ago`;
                            else if (diffDays < 365) elapsedTextValue = `${Math.floor(diffDays / 30)} month${Math.floor(diffDays / 30) > 1 ? 's' : ''} ago`;
                            else elapsedTextValue = `${Math.floor(diffDays / 365)} year${Math.floor(diffDays / 365) > 1 ? 's' : ''} ago`;
                            
                            // Color coding based on time
                            if (diffDays < 1) {
                                badgeClass += ' time-recent';
                            } else if (diffDays < 3) {
                                badgeClass += ' time-medium';
                            } else {
                                badgeClass += ' time-old';
                            }
                        } else if (diffHours > 0) {
                            if (diffHours === 1) elapsedTextValue = '1 hour ago';
                            else elapsedTextValue = `${diffHours} hours ago`;
                            badgeClass += ' time-recent';
                        } else if (diffMinutes > 0) {
                            if (diffMinutes === 1) elapsedTextValue = '1 minute ago';
                            else elapsedTextValue = `${diffMinutes} minutes ago`;
                            badgeClass += ' time-recent';
                        } else {
                            elapsedTextValue = 'Just now';
                            badgeClass += ' time-recent';
                        }
                        
                        // Update the element
                        elapsedText.textContent = elapsedTextValue;
                        badge.className = badgeClass;
                        badge.style.display = 'inline-flex';
                        
                    } catch (e) {
                        console.error('Error calculating time elapsed:', e);
                        elapsedText.textContent = 'Time error';
                        badge.style.display = 'inline-flex';
                    }
                });
            }
            
            // ========== DIRECTORY TABS ==========
            function setupDirectoryTabs() {
                directoryTabs.forEach(tab => {
                    tab.addEventListener('click', function() {
                        const targetTab = this.getAttribute('data-tab');
                        
                        // Update active tab
                        directoryTabs.forEach(t => t.classList.remove('active'));
                        this.classList.add('active');
                        
                        // Show/hide appropriate list
                        if (targetTab === 'employees') {
                            employeeList.classList.add('active');
                            leadList.classList.remove('active');
                            document.querySelector('.directory-filter-container').style.display = 'none';
                            currentItems = employees;
                        } else {
                            employeeList.classList.remove('active');
                            leadList.classList.add('active');
                            document.querySelector('.directory-filter-container').style.display = 'flex';
                            currentItems = leads;
                        }
                        
                        // Reset search and filter
                        directorySearch.value = '';
                        priorityFilter.value = 'all';
                        currentPage = 1;
                        filteredItems = [...currentItems];
                        updatePagination();
                        updateActiveTabCount();
                    });
                });
            }
            
            // ========== SEARCH AND FILTER ==========
            function setupSearchAndFilter() {
                // Search functionality
                directorySearch.addEventListener('input', function() {
                    filterDirectoryItems();
                });
                
                // Priority filter
                priorityFilter.addEventListener('change', function() {
                    filterDirectoryItems();
                });
            }
            
            function filterDirectoryItems() {
                const searchTerm = directorySearch.value.toLowerCase();
                const priority = priorityFilter.value;
                const activeTab = document.querySelector('.directory-tab.active').getAttribute('data-tab');
                
                if (activeTab === 'employees') {
                    currentItems = employees;
                } else {
                    currentItems = leads;
                }
                
                // Apply search filter
                if (!searchTerm) {
                    filteredItems = [...currentItems];
                } else {
                    filteredItems = currentItems.filter(item => {
                        let textContent = '';
                        
                        if (activeTab === 'employees') {
                            textContent = (
                                item.name.toLowerCase() + ' ' + 
                                item.department.toLowerCase() + ' ' + 
                                (item.designation || '').toLowerCase()
                            );
                        } else {
                            textContent = (
                                item.ownerName.toLowerCase() + ' ' + 
                                item.phoneNo.toLowerCase() + ' ' + 
                                item.ticketNo.toLowerCase() + ' ' +
                                (item.priority || '').toLowerCase() + ' ' +
                                (item.campaign_display || '').toLowerCase() + ' ' +
                                (item.date || '').toLowerCase()
                            );
                        }
                        
                        return textContent.includes(searchTerm);
                    });
                }
                
                // Apply priority filter (only for leads tab)
                if (activeTab === 'leads' && priority !== 'all') {
                    filteredItems = filteredItems.filter(item => item.priority === priority);
                }
                
                currentPage = 1;
                updatePagination();
                updateActiveTabCount();
            }
            
            // ========== PAGINATION ==========
            function initializePagination() {
                const activeTab = document.querySelector('.directory-tab.active').getAttribute('data-tab');
                if (activeTab === 'employees') {
                    currentItems = employees;
                } else {
                    currentItems = leads;
                }
                
                filteredItems = [...currentItems];
                updatePagination();
                updateActiveTabCount();
            }
            
            function updatePagination() {
                totalPages = Math.ceil(filteredItems.length / itemsPerPage);
                
                // Ensure current page is within bounds
                if (currentPage > totalPages) {
                    currentPage = totalPages || 1;
                }
                
                // Update pagination buttons
                prevPageBtn.disabled = currentPage === 1;
                nextPageBtn.disabled = currentPage === totalPages;
                
                // Update pagination info
                const startItem = (currentPage - 1) * itemsPerPage + 1;
                const endItem = Math.min(currentPage * itemsPerPage, filteredItems.length);
                paginationInfo.textContent = `Page ${currentPage} of ${totalPages} (${filteredItems.length} items)`;
                
                // Generate page numbers
                generatePageNumbers();
                
                // Display current page items
                displayCurrentPageItems();
            }
            
            function generatePageNumbers() {
                paginationNumbers.innerHTML = '';
                
                // Show max 5 page numbers
                let startPage = Math.max(1, currentPage - 2);
                let endPage = Math.min(totalPages, startPage + 4);
                
                // Adjust start page if we're near the end
                if (endPage - startPage < 4) {
                    startPage = Math.max(1, endPage - 4);
                }
                
                // First page
                if (startPage > 1) {
                    const firstPageBtn = document.createElement('button');
                    firstPageBtn.className = 'page-number';
                    firstPageBtn.textContent = '1';
                    firstPageBtn.addEventListener('click', () => goToPage(1));
                    paginationNumbers.appendChild(firstPageBtn);
                    
                    if (startPage > 2) {
                        const ellipsis = document.createElement('span');
                        ellipsis.className = 'pagination-ellipsis';
                        ellipsis.textContent = '...';
                        paginationNumbers.appendChild(ellipsis);
                    }
                }
                
                // Page numbers
                for (let i = startPage; i <= endPage; i++) {
                    const pageBtn = document.createElement('button');
                    pageBtn.className = `page-number ${i === currentPage ? 'active' : ''}`;
                    pageBtn.textContent = i;
                    pageBtn.addEventListener('click', () => goToPage(i));
                    paginationNumbers.appendChild(pageBtn);
                }
                
                // Last page
                if (endPage < totalPages) {
                    if (endPage < totalPages - 1) {
                        const ellipsis = document.createElement('span');
                        ellipsis.className = 'pagination-ellipsis';
                        ellipsis.textContent = '...';
                        paginationNumbers.appendChild(ellipsis);
                    }
                    
                    const lastPageBtn = document.createElement('button');
                    lastPageBtn.className = 'page-number';
                    lastPageBtn.textContent = totalPages;
                    lastPageBtn.addEventListener('click', () => goToPage(totalPages));
                    paginationNumbers.appendChild(lastPageBtn);
                }
            }
            
            function goToPage(page) {
                currentPage = page;
                updatePagination();
            }
            
            function goToPreviousPage() {
                if (currentPage > 1) {
                    currentPage--;
                    updatePagination();
                }
            }
            
            function goToNextPage() {
                if (currentPage < totalPages) {
                    currentPage++;
                    updatePagination();
                }
            }
            
            function displayCurrentPageItems() {
                const activeTab = document.querySelector('.directory-tab.active').getAttribute('data-tab');
                const container = activeTab === 'employees' ? employeeList : leadList;
                
                // Clear container
                container.innerHTML = '';
                
                if (filteredItems.length === 0) {
                    const noResults = document.createElement('div');
                    noResults.className = 'no-results';
                    noResults.textContent = activeTab === 'employees' ? 'No employees found' : 'No leads found';
                    container.appendChild(noResults);
                    return;
                }
                
                // Calculate slice indices
                const startIndex = (currentPage - 1) * itemsPerPage;
                const endIndex = Math.min(startIndex + itemsPerPage, filteredItems.length);
                const currentPageItems = filteredItems.slice(startIndex, endIndex);
                
                // Create items
                currentPageItems.forEach(item => {
                    if (activeTab === 'employees') {
                        createEmployeeItem(item, container);
                    } else {
                        createLeadItem(item, container);
                    }
                });
                
                // Re-attach event listeners
                if (activeTab === 'employees') {
                    setupEmployeeAssignButtons();
                } else {
                    setupLeadViewButtons();
                }
            }
            
            // ========== ITEM CREATION ==========
            function createEmployeeItem(employee, container) {
                const item = document.createElement('div');
                item.className = 'employee-item';
                item.setAttribute('data-id', employee.id);
                item.setAttribute('data-name', employee.name);
                
                item.innerHTML = `
                    <div class="employee-avatar">
                        ${employee.name.slice(0, 2).toUpperCase()}
                    </div>
                    <div class="employee-details">
                        <div class="employee-name">${employee.name}</div>
                        <div class="employee-role">
                            ${employee.department}${employee.designation ? ' - ' + employee.designation : ''}
                        </div>
                    </div>
                    <button class="assign-btn" data-id="${employee.id}" data-name="${employee.name}" data-role="employee-assign">
                        Assign
                    </button>
                `;
                
                container.appendChild(item);
            }
            
            function createLeadItem(lead, container) {
                const item = document.createElement('div');
                item.className = 'lead-item';
                item.setAttribute('data-id', lead.id);
                
                // Priority configuration
                const priorityConfig = getPriorityConfig(lead.priority || 'Medium');
                
                // Format ISO date for JavaScript
                const createdDate = lead.createdAt || lead.date;
                const isoDate = createdDate ? new Date(createdDate).toISOString() : '';
                
                // Format dates for display
                const leadDateInfo = formatDateForDisplay(lead.date);
                const createdDateInfo = formatDateForDisplay(lead.createdAt);
                
                item.innerHTML = `
                    <div class="lead-avatar">
                        ${(lead.ownerName || '').slice(0, 2).toUpperCase()}
                    </div>
                    <div class="lead-details">
                        <div class="lead-header">
                            <div class="lead-name-container">
                                <span class="lead-priority-indicator">
                                    ${priorityConfig.emoji}
                                </span>
                                <span class="lead-name">${lead.ownerName || 'No Name'}</span>
                                ${leadDateInfo.short ? `
                                <span class="lead-date-compact" title="Lead Date: ${leadDateInfo.tooltip}">
                                    <i class="far fa-calendar-alt"></i>
                                    ${leadDateInfo.short}
                                </span>` : ''}
                            </div>
                            ${createdDateInfo.short ? `
                            <div class="lead-date-compact" title="Created: ${createdDateInfo.tooltip}">
                                <i class="far fa-calendar-alt"></i>
                                ${createdDateInfo.short}
                            </div>` : ''}
                        </div>
                        
                        <!-- TIME ELAPSED BADGE -->
                        <div class="time-elapsed-badge" 
                             data-created="${isoDate}"
                             style="display: inline-flex; margin-top: 5px;">
                            <i class="fas fa-clock"></i>
                            <span class="elapsed-text">${lead.time_elapsed || 'Calculating...'}</span>
                        </div>
                        
                        <div class="lead-phone">${lead.phoneNo || 'No Phone'}</div>
                        <div class="lead-ticket">${lead.ticketNo || 'No Ticket'}</div>
                        ${lead.createdTime ? `
                        <div class="lead-datetime">
                            <i class="far fa-clock"></i>
                            Created at ${lead.createdTime}
                        </div>` : ''}
                        <div class="lead-info-row">
                            <div class="lead-status">Status: ${lead.status || 'Unknown'}</div>
                            <span style="color: ${priorityConfig.color}; font-weight: 600; font-size: 10px; padding: 2px 8px; border-radius: 10px; background: ${priorityConfig.color}15;">
                                ${priorityConfig.text}
                            </span>
                        </div>
                        ${lead.campaign_display ? `
                        <div class="lead-campaign" title="${lead.campaign_display}">
                            <i class="fas fa-bullhorn" style="font-size: 9px;"></i>
                            <span>${lead.campaign_display.substring(0, 40)}${lead.campaign_display.length > 40 ? '...' : ''}</span>
                        </div>` : ''}
                    </div>
                `;
                
                container.appendChild(item);
            }
            
            function getPriorityConfig(priority) {
                const configs = {
                    'High': { emoji: '游댮', color: '#ff4444', text: 'High' },
                    'Medium': { emoji: '游리', color: '#ffaa00', text: 'Medium' },
                    'Low': { emoji: '游릭', color: '#22c55e', text: 'Low' }
                };
                
                return configs[priority] || configs['Medium'];
            }
            
            function formatDateForDisplay(dateString) {
                if (!dateString) return { short: '', full: '', tooltip: '' };
                
                try {
                    const dateObj = new Date(dateString);
                    if (isNaN(dateObj.getTime())) {
                        return {
                            short: dateString,
                            full: dateString,
                            tooltip: dateString
                        };
                    }
                    
                    // Short format: "15 Jan"
                    const short = dateObj.toLocaleDateString('en-GB', {
                        day: '2-digit',
                        month: 'short'
                    });
                    
                    // Full format: "15 January 2024"
                    const full = dateObj.toLocaleDateString('en-GB', {
                        day: '2-digit',
                        month: 'long',
                        year: 'numeric'
                    });
                    
                    // Tooltip format: "Monday, 15 January 2024"
                    const tooltip = dateObj.toLocaleDateString('en-GB', {
                        weekday: 'long',
                        day: '2-digit',
                        month: 'long',
                        year: 'numeric'
                    });
                    
                    return {
                        short: short,
                        full: full,
                        tooltip: tooltip,
                        dateObj: dateObj
                    };
                } catch (e) {
                    return {
                        short: dateString,
                        full: dateString,
                        tooltip: dateString
                    };
                }
            }
            
            // ========== EVENT LISTENERS ==========
            function setupEmployeeAssignButtons() {
                const employeeAssignButtons = document.querySelectorAll('#employeeList .assign-btn[data-role="employee-assign"]');
                employeeAssignButtons.forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const empId = this.getAttribute('data-id');
                        const empName = this.getAttribute('data-name');
                        // You can implement assign functionality here
                        showNotification(`Assigning ${empName}`, 'info');
                    });
                });
            }
            
            function setupLeadViewButtons() {
                const leadItems = document.querySelectorAll('#leadList .lead-item');
                
                leadItems.forEach(item => {
                    item.addEventListener('click', function(e) {
                        e.stopPropagation();
                        
                        // Remove previous selection
                        leadItems.forEach(i => i.classList.remove('selected'));
                        
                        // Add selection to current item
                        this.classList.add('selected');
                        
                        const leadId = this.getAttribute('data-id');
                        const leadIndex = this.getAttribute('data-index');
                        
                        // Implement lead view/edit functionality
                        openLead(leadId, leadIndex);
                    });
                });
            }
            
            // ========== UTILITY FUNCTIONS ==========
            function updateActiveTabCount() {
                if (activeTabCount) {
                    activeTabCount.textContent = filteredItems.length;
                }
            }
            
            function showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 15px 20px;
                    background: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : '#2196F3'};
                    color: white;
                    border-radius: 5px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    z-index: 10000;
                    font-weight: 600;
                    transition: all 0.3s ease;
                    max-width: 400px;
                    word-wrap: break-word;
                `;
                notification.textContent = message;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.style.opacity = '0';
                    notification.style.transform = 'translateX(100px)';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }, 3000);
            }
            
            // ========== LEAD OPEN FUNCTION ==========
            function openLead(leadId, leadIndex) {
                // You can implement different behaviors:
                // 1. Redirect to edit page
                // window.location.href = `/app5/lead/edit/${leadId}/`;
                
                // 2. Show lead details in a modal
                // showLeadDetails(leadId);
                
                // 3. For now, just show a notification
                const lead = leads[leadIndex] || filteredItems.find(l => l.id == leadId);
                if (lead) {
                    showNotification(`Opening lead: ${lead.ownerName} (${lead.phoneNo})`, 'info');
                }
            }
            
            // ========== INITIALIZE ==========
            function initializeDirectory() {
                // Set up date display
                updateDirectoryDateDisplay();
                setInterval(updateDirectoryDateDisplay, 60000);
                
                // Initialize time elapsed badges
                setTimeout(() => {
                    updateAllTimeElapsedBadges();
                }, 500);
                setInterval(updateAllTimeElapsedBadges, 60000);
                
                // Set up directory components
                setupDirectoryTabs();
                setupSearchAndFilter();
                initializePagination();
                setupEmployeeAssignButtons();
                setupLeadViewButtons();
                
                // Set up pagination button listeners
                prevPageBtn.addEventListener('click', goToPreviousPage);
                nextPageBtn.addEventListener('click', goToNextPage);
                
                console.log('九 Lead Directory fully initialized');
            }
            
            // Start everything
            initializeDirectory();
        });
    </script>
</body>
</html>