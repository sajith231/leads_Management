{% extends "base.html" %}

{% block title %}Job Card List{% endblock %}

{% block content %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Card Assignment</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .container-fluid {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 10px;
        }
        .dashboard-header {
            background: linear-gradient(135deg, #0062cc, #0095ff);
            color: white;
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 8px;
            margin-bottom: 15px;
        }
        .stat-card {
            background: white;
            border-radius: 6px;
            padding: 10px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .stat-card.total { border-left: 3px solid #007bff; }
        .stat-card.pending { border-left: 3px solid #ffc107; }
        .stat-card.in-progress { border-left: 3px solid #17a2b8; }
        .stat-card.completed { border-left: 3px solid #28a745; }
        .stat-card.returned { border-left: 3px solid #6c757d; }
        .stat-card.rejected { border-left: 3px solid #dc3545; }
        
        .stat-number {
            font-size: 1.3rem;
            font-weight: bold;
            margin: 3px 0;
        }
        .stat-label {
            font-size: 0.7rem;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .table-container {
            background: white;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            overflow-x: auto;
        }
        .table {
            margin-bottom: 0;
            min-width: 1000px;
        }
        .table th {
            background-color: #f1f7ff;
            color: #0062cc;
            font-weight: 600;
            padding: 6px;
            font-size: 0.8rem;
            white-space: nowrap;
            border-right: #212529;
        }
        .table td {
            padding: 6px;
            font-size: 0.8rem;
            vertical-align: middle;
            border-right: 1px solid #bca3a3;
           border-bottom: 1px solid #bca3a3;
        }
        .status-badge {
            padding: 3px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
            background-color: #dff2e8;
            color: #08b21d;
            white-space: nowrap;
        }
        .status-logged { background: #ed5b2e; color: #fff; }
        .status-sent_technician {  background: #ef06cc; color: #fff; }
        .status-completed { background: #10a41d; color: #fff; }
        .status-returned { background-color: #fbe9e7; color: #d84315; }
        .status-rejected { background: #bd0214; color: #fff; }
        .status-accepted { background: #060bf4; color: #fff; }
        .status-mixed { background: #ffc107; color: #212529; }
        
        .action-btn {
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 0.7rem;
            margin-right: 2px;
        }
        .btn-assign {
            background-color: #17a2b8;
            color: white;
            border: none;
        }
        .btn-assign:hover {
            background-color: #138496;
        }
        .btn-view {
            background-color: #6c757d;
            color: white;
            border: none;
        }
        .btn-view:hover {
            background-color: #5a6268;
        }
        .btn-edit {
            background-color: #ffc107;
            color: #212529;
            border: none;
        }
        .btn-edit:hover {
            background-color: #e0a800;
        }
        .btn-delete {
            background-color: #dc3545;
            color: white;
            border: none;
        }
        .btn-delete:hover {
            background-color: #c82333;
        }
        .search-container {
            margin-bottom: 12px;
        }
        .pagination {
            margin-top: 12px;
            font-size: 0.8rem;
        }
        .technician-info {
            font-size: 0.75rem;
            color: #6c757d;
        }

        .back-button {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            background: white;
            border-radius: 8px;
            color: #0062cc;
            text-decoration: none;
            font-weight: 500;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: all 0.3s;
            margin-bottom: 12px;
            border: none;
            cursor: pointer;
        }
        .back-button:hover {
            background: #0062cc;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .stat-card.accepted { border-left: 3px solid #20c997; }

        .page-link {
            padding: 0.25rem 0.5rem;
        }
        .form-control, .form-select {
            padding: 0.3rem 0.6rem;
            font-size: 0.8rem;
        }
        .input-group-text {
            padding: 0.3rem 0.6rem;
            font-size: 0.8rem;
        }
        .table-responsive {
            overflow-x: auto;
        }
        .btn-group {
            flex-wrap: nowrap;
        }
        .empty-state {
            min-width: 1000px;
        }
        .filter-section {
            background-color: #f8f9fa;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #dee2e6;
        }
        .filter-label {
            font-weight: 600;
            margin-right: 10px;
            color: #495057;
        }
        .dropdown-filter {
            display: inline-block;
            margin-right: 10px;
        }
        
        /* Notes column styling */
        .notes-cell {
            max-width: 200px;
            word-wrap: break-word;
            font-size: 0.75rem;
        }
        
        .completion-summary {
            background-color: #f8f9fa;
            border-radius: 4px;
            padding: 4px 6px;
            margin: 2px 0;
            border-left: 3px solid #28a745;
        }
        
        .completion-item {
            margin-bottom: 2px;
            font-size: 0.7rem;
        }
        
        .completion-label {
            font-weight: 600;
            color: #495057;
        }
        
        .completion-value {
            color: #6c757d;
        }
        
        .btn-notes {
            background-color: #17a2b8;
            color: white;
            border: none;
            padding: 1px 4px;
            font-size: 0.65rem;
        }
        
        .btn-notes:hover {
            background-color: #138496;
            color: white;
        }

        /* Date column styling */
        .date-cell {
            font-size: 0.75rem;
            white-space: nowrap;
        }
        .date-time {
            display: block;
            font-size: 0.7rem;
            color: #6c757d;
        }

        /* Item assignments styling */
        .item-assignments {
            max-width: 200px;
        }
        .item-assignment {
            background: #f8f9fa;
            border-radius: 4px;
            padding: 3px 6px;
            margin: 2px 0;
            font-size: 0.7rem;
        }
        .item-assigned {
            border-left: 3px solid #17a2b8;
        }
        .item-logged {
            border-left: 3px solid #ffc107;
        }
        .item-name {
            font-weight: 600;
            color: #495057;
        }
        .item-technician {
            color: #6c757d;
            font-size: 0.65rem;
        }
        .item-status {
            display: inline-block;
            padding: 1px 4px;
            border-radius: 8px;
            font-size: 0.6rem;
            font-weight: 600;
            margin-top: 2px;
        }
        .no-assignments {
            color: #6c757d;
            font-style: italic;
            font-size: 0.7rem;
        }
        .status-summary {
            font-size: 0.65rem;
            color: #6c757d;
            margin-top: 4px;
        }

        /* Modal for detailed notes */
        .modal-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }
        
        .modal-body .detail-item {
            margin-bottom: 10px;
            padding: 8px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        
        .modal-body .detail-label {
            font-weight: 600;
            color: #495057;
            display: block;
            margin-bottom: 4px;
        }
        
        .modal-body .detail-value {
            color: #6c757d;
            font-size: 0.9rem;
        }

        /* Mixed status styling */
        .mixed-status-info {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
            padding: 4px 6px;
            margin-top: 4px;
            font-size: 0.65rem;
            color: #856404;
        }
    </style>
    
    <div class="container-fluid">
        <div class="mb-2">
            <div>
                <button class="back-button" onclick="goBack()">
                    <i class="fas fa-arrow-left"></i> Back
                </button>
            </div>
        </div>

        <div class="dashboard-header">
            <div class="d-flex justify-content-between align-items-center">
                <h2 class="h5 mb-0"><i class="fas fa-tasks me-1"></i> Job Card Assignment</h2>
            </div>
            <p class="mb-0 mt-1 small">Manage and track all job card assignments to technicians</p>
        </div>

        <!-- Statistics Cards -->
        <div class="stats-container">
            <div class="stat-card total">
                <div class="stat-label">Total Jobs</div>
                <div class="stat-number">{{ stats.total }}</div>
            </div>
            <div class="stat-card pending">
                <div class="stat-label">Logged</div>
                <div class="stat-number">{{ stats.logged }}</div>
            </div>
            <div class="stat-card accepted">
                <div class="stat-label">In Technician Hand</div>
                <div class="stat-number">{{ stats.accepted }}</div>
            </div>
            <div class="stat-card in-progress">
                <div class="stat-label">Sent To Technician</div>
                <div class="stat-number">{{ stats.sent_technician }}</div>
            </div>
            <div class="stat-card completed">
                <div class="stat-label">Completed</div>
                <div class="stat-number">{{ stats.completed }}</div>
            </div>
            <div class="stat-card returned">
                <div class="stat-label">Returned</div>
                <div class="stat-number">{{ stats.returned }}</div>
            </div>
            <div class="stat-card rejected">
                <div class="stat-label">Rejected</div>
                <div class="stat-number">{{ stats.rejected }}</div>
            </div>
        </div>

        <!-- Filter + Search in same line -->
        <div class="filter-section">
            <div class="row g-2 align-items-center">
                <div class="col-md-4">
                    <label for="statusFilterDropdown" class="filter-label mb-0">Filter by Status:</label>
                    <select class="form-select form-select-sm d-inline-block w-auto ms-2" id="statusFilterDropdown">
                        <option value="all">All Jobs</option>
                        <option value="logged">Logged</option>
                        <option value="sent_technician">Sent To Technician</option>
                        <option value="accepted">In Technician Hand</option>
                        <option value="completed">Completed</option>
                        <option value="returned">Returned</option>
                        <option value="rejected">Rejected</option>
                        <option value="mixed">Mixed Status</option>
                    </select>
                </div>
                <div class="col-md-8">
                    <div class="input-group input-group-sm">
                        <input type="text" class="form-control" placeholder="Search tickets..." id="searchInput">
                    </div>
                </div>
            </div>
        </div>

        <!-- Job Cards Table -->
        <div class="table-container">
            <div class="table-responsive">
                <table class="table table-hover table-sm">
                    <thead>
                        <tr>
                            <th>Ticket No</th>
                            <th>Customer</th>
                            <th>Technician</th>
                            <th>Assigned Items</th>
                            <th>Assigned Date & Time</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="jobcardsTableBody">
                        {% for jobcard in jobcards %}
                        <tr class="jobcard-row" 
    data-status="{{ jobcard.status }}" 
    data-has-logged="{{ jobcard.has_logged_items|yesno:'true,false' }}" 
    data-has-assigned="{{ jobcard.has_assigned_items|yesno:'true,false' }}"
    data-has-sent-technician="{{ jobcard.has_sent_to_technician_items|yesno:'true,false' }}">
                            <td><strong>{{ jobcard.ticket_no }}</strong></td>
                            <td>{{ jobcard.customer }}</td>
                            
                            <td>
                                {% if jobcard.technician %}
                                    <span class="technician-info">{{ jobcard.technician }}</span>
                                {% else %}
                                    <span class="text-muted">Not assigned</span>
                                {% endif %}
                            </td>
                            
                            <!-- Assigned Items Column -->
                            <td class="item-assignments">
                                {% if jobcard.per_item_assignments %}
                                    {% for assignment in jobcard.per_item_assignments %}
                                        <div class="item-assignment item-assigned">
                                            <div class="item-name">{{ assignment.item }}</div>
                                            <div class="item-technician">→ {{ assignment.technician }}</div>
                                            <div class="item-status status-badge status-{{ assignment.status }}">
                                                {% if assignment.status == 'logged' %}Logged
                                                {% elif assignment.status == 'sent_technician' %}Sent To Technician
                                                {% elif assignment.status == 'accepted' %}In Technician Hand
                                                {% elif assignment.status == 'completed' %}Completed
                                                {% elif assignment.status == 'returned' %}Returned
                                                {% elif assignment.status == 'rejected' %}Rejected
                                                {% else %}{{ assignment.status|title }}
                                                {% endif %}
                                            </div>
                                        </div>
                                    {% endfor %}
                                {% endif %}
                                
                                <!-- Show logged items that are not assigned -->
                                {% if jobcard.items_data %}
                                    {% for item in jobcard.items_data %}
                                        {% if not item.technician and item.status == 'logged' or not item.status %}
                                            <div class="item-assignment item-logged">
                                                <div class="item-name">{{ item.item }}</div>
                                                <div class="item-technician" style="color: #dc3545;">→ Not assigned</div>
                                                <div class="item-status status-badge status-logged">
                                                    Logged
                                                </div>
                                            </div>
                                        {% endif %}
                                    {% endfor %}
                                {% endif %}
                                
                                {% if not jobcard.per_item_assignments and not jobcard.has_logged_items %}
                                    <span class="no-assignments">No items to assign</span>
                                {% endif %}
                                
                                <!-- Status summary -->
                                {% if jobcard.items_data %}
                                    {% with total_items=jobcard.items_data|length %}
                                    {% with assigned_items=jobcard.per_item_assignments|length %}
                                    {% with logged_items=jobcard.has_logged_items %}
                                        <div class="status-summary">
                                            {{ assigned_items }}/{{ total_items }} items assigned
                                        </div>
                                    {% endwith %}
                                    {% endwith %}
                                    {% endwith %}
                                {% endif %}
                            </td>
                            
                            <!-- Assigned Date & Time Column -->
                            <td class="date-cell">
                                {% if jobcard.assigned_date %}
                                    {{ jobcard.assigned_date|date:"M d, Y" }}
                                    <span class="date-time">{{ jobcard.assigned_date|date:"g:i A" }}</span>
                                {% else %}
                                    <span class="text-muted">Not assigned</span>
                                {% endif %}
                            </td>
                            
                            <td>
    {% if jobcard.has_logged_items and jobcard.has_assigned_items %}
        <span class="status-badge status-mixed">
            Mixed Status
        </span>
        <div class="mixed-status-info">
            <i class="fas fa-info-circle"></i>
            Some items still need assignment
        </div>
    {% elif jobcard.has_sent_to_technician_items %}
        <span class="status-badge status-sent_technician">
            Sent To Technician
        </span>
        <div class="mixed-status-info">
            <i class="fas fa-info-circle"></i>
            {{ jobcard.sent_to_technician_count }} item(s) assigned to technicians
        </div>
    {% elif jobcard.has_logged_items %}
        <span class="status-badge status-logged">
            Logged
        </span>
        <div class="mixed-status-info">
            <i class="fas fa-info-circle"></i>
            {{ jobcard.logged_items_count }} item(s) waiting for assignment
        </div>
    {% else %}
        <span class="status-badge status-{{ jobcard.status }}">
            {% if jobcard.status == 'logged' %}Logged
            {% elif jobcard.status == 'sent_technician' %}Sent To Technician
            {% elif jobcard.status == 'accepted' %}In Technician Hand
            {% elif jobcard.status == 'completed' %}Completed
            {% elif jobcard.status == 'returned' %}Returned
            {% elif jobcard.status == 'rejected' %}Rejected
            {% else %}{{ jobcard.get_status_display }}
            {% endif %}
        </span>
    {% endif %}
</td>
                            <td>
                                <div class="btn-group">
                                    {% if jobcard.has_logged_items %}
                                    <a href="{% url 'app5:assign_new_job' %}?ticket={{ jobcard.ticket_no }}" 
                                       class="btn btn-sm btn-assign action-btn" title="Assign">
                                        <i class="fas fa-user-plus"></i>
                                    </a>
                                    {% endif %}
                                    <a href="{% url 'app5:jobcard_assign_edit' jobcard.pk %}" 
                                      class="btn btn-sm btn-edit action-btn" title="Edit">
                                      <i class="fas fa-edit"></i>
                                    </a>
                                    
                                    <button class="btn btn-sm btn-delete action-btn" 
                                            title="Delete" 
                                            onclick="confirmDelete('{{ jobcard.ticket_no }}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="text-center py-3 empty-state">
                                <i class="fas fa-inbox fa-lg text-muted mb-1"></i>
                                <p class="text-muted small mb-0">No job cards found</p>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            {% if jobcards.has_other_pages %}
            <nav aria-label="Job card pagination">
                <ul class="pagination justify-content-center pagination-sm">
                    {% if jobcards.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ jobcards.previous_page_number }}">Previous</a>
                    </li>
                    {% endif %}

                    {% for i in jobcards.paginator.page_range %}
                    <li class="page-item {% if jobcards.number == i %}active{% endif %}">
                        <a class="page-link" href="?page={{ i }}">{{ i }}</a>
                    </li>
                    {% endfor %}

                    {% if jobcards.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ jobcards.next_page_number }}">Next</a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Set default filter to show logged items
            document.getElementById('statusFilterDropdown').value = 'logged';
            filterByStatus('logged');
        });

        function goBack() {
            window.history.back();
        }

        // Status dropdown functionality
        document.getElementById('statusFilterDropdown').addEventListener('change', function() {
            const status = this.value;
            filterByStatus(status);
        });

        function filterByStatus(status) {
            const rows = document.querySelectorAll('.jobcard-row');
            let visibleCount = 0;
            
            rows.forEach(row => {
                if (status === 'all') {
                    row.style.display = '';
                    visibleCount++;
                } else if (status === 'mixed') {
                    // Show rows with mixed status (both logged and assigned items)
                    const hasLogged = row.getAttribute('data-has-logged') === 'true';
                    const hasAssigned = row.getAttribute('data-has-assigned') === 'true';
                    if (hasLogged && hasAssigned) {
                        row.style.display = '';
                        visibleCount++;
                    } else {
                        row.style.display = 'none';
                    }
                } else {
                    const rowStatus = row.getAttribute('data-status');
                    const hasLogged = row.getAttribute('data-has-logged') === 'true';
                    
                    if (status === 'logged') {
                        // Show rows that have logged items
                        if (hasLogged) {
                            row.style.display = '';
                            visibleCount++;
                        } else {
                            row.style.display = 'none';
                        }
                    } else if (rowStatus === status) {
                        row.style.display = '';
                        visibleCount++;
                    } else {
                        row.style.display = 'none';
                    }
                }
            });
            
            // Show message if no rows are visible
            const visibleRows = Array.from(rows).filter(row => row.style.display !== 'none');
            if (visibleRows.length === 0) {
                if (!document.querySelector('.no-results-message')) {
                    const emptyRow = document.createElement('tr');
                    emptyRow.className = 'no-results-message';
                    emptyRow.innerHTML = `
                        <td colspan="7" class="text-center py-3">
                            <i class="fas fa-search fa-lg text-muted mb-1"></i>
                            <p class="text-muted small mb-0">No job cards found with the selected status</p>
                        </td>
                    `;
                    document.getElementById('jobcardsTableBody').appendChild(emptyRow);
                }
            } else {
                const emptyMessage = document.querySelector('.no-results-message');
                if (emptyMessage) {
                    emptyMessage.remove();
                }
            }
            
            // Update search results info
            updateSearchResultsInfo(visibleCount, rows.length, status);
        }

        // Search functionality
        document.getElementById('searchInput').addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const rows = document.querySelectorAll('.jobcard-row');
            let visibleCount = 0;

            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });

            // Show message if no rows are visible after search
            if (visibleCount === 0) {
                if (!document.querySelector('.no-search-results')) {
                    const emptyRow = document.createElement('tr');
                    emptyRow.className = 'no-search-results';
                    emptyRow.innerHTML = `
                        <td colspan="7" class="text-center py-3">
                            <i class="fas fa-search fa-lg text-muted mb-1"></i>
                            <p class="text-muted small mb-0">No job cards match your search</p>
                        </td>
                    `;
                    document.getElementById('jobcardsTableBody').appendChild(emptyRow);
                }
            } else {
                const emptyMessage = document.querySelector('.no-search-results');
                if (emptyMessage) {
                    emptyMessage.remove();
                }
            }
            
            updateSearchResultsInfo(visibleCount, rows.length, 'search');
        });

        function updateSearchResultsInfo(visibleCount, totalCount, filterType) {
            // You can implement this to show search results info similar to jobcard_list.html
            console.log(`Showing ${visibleCount} of ${totalCount} job cards (filter: ${filterType})`);
        }

        // Show notes modal
        function showNotesModal(jobId, ticketNo, workDone, partsUsed, timeSpent, notes, completedAt) {
            document.getElementById('modalTicketNo').textContent = ticketNo;
            document.getElementById('modalWorkDone').textContent = workDone || 'Not specified';
            document.getElementById('modalPartsUsed').textContent = partsUsed || 'None';
            document.getElementById('modalTimeSpent').textContent = timeSpent ? timeSpent + ' hours' : '0 hours';
            document.getElementById('modalNotes').textContent = notes || 'No additional notes';
            
            // Format the completed date if available
            if (completedAt) {
                const date = new Date(completedAt);
                document.getElementById('modalCompletedAt').textContent = date.toLocaleString();
            } else {
                document.getElementById('modalCompletedAt').textContent = 'Not available';
            }
            
            const modal = new bootstrap.Modal(document.getElementById('notesModal'));
            modal.show();
        }

        // Delete confirmation
        function confirmDelete(ticketNo) {
            if (confirm(`Are you sure you want to delete job card ${ticketNo}?`)) {
                fetch(`{% url 'app5:delete_ticket_by_number' '0000' %}`.replace('0000', ticketNo), {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    alert('Error: ' + error);
                });
            }
        }

        // CSRF token helper function
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Auto-refresh functionality (optional)
        function autoRefresh() {
            setTimeout(function() {
                location.reload();
            }, 30000); // Refresh every 30 seconds
        }

        // Uncomment the line below to enable auto-refresh
        // autoRefresh();
    </script>
{% endblock %}