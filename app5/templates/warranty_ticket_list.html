{% extends "base.html" %}
{% block title %}Warranty Tickets List{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
    .container {
        max-width: 1400px;
        margin: 30px auto;
        padding: 20px;
    }

    .page-header {
        text-align: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 3px solid #061262;
    }

    .page-header h1 {
        font-size: 2.2rem;
        color: #061262;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 2px;
    }

    .filters-section {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 25px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .filters-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        align-items: end;
    }

    .form-group label {
        display: block;
        margin-bottom: 8px;
        color: #333;
        font-weight: 600;
    }

    .form-group select {
        width: 100%;
        padding: 10px 15px;
        border: 2px solid #ddd;
        border-radius: 6px;
        font-size: 1rem;
        background: white;
    }

    .btn-apply {
        background: #061262;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .btn-apply:hover {
        background: #0a1b7a;
        transform: translateY(-2px);
    }

    .btn-reset {
        background: #6c757d;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        transition: all 0.3s ease;
    }

    .btn-reset:hover {
        background: #5a6268;
        transform: translateY(-2px);
    }

    .stats-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: white;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        border-top: 4px solid #061262;
    }

    .stat-number {
        font-size: 2rem;
        font-weight: 700;
        color: #061262;
        margin-bottom: 5px;
    }

    .stat-label {
        color: #666;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .table-container {
        background: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        /* Add horizontal scrolling */
        overflow-x: auto;
        -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
    }

    .table {
        width: 100%;
        border-collapse: collapse;
        /* Ensure table doesn't shrink below content width */
        min-width: 1000px; /* Adjust this value based on your content */
    }

    .table th {
        background: #061262;
        color: white;
        padding: 15px;
        text-align: left;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-size: 0.9rem;
        /* Prevent text wrapping in headers */
        white-space: nowrap;
    }

    .table td {
        padding: 15px;
        border-bottom: 1px solid #eee;
        /* Prevent text wrapping in cells */
        white-space: nowrap;
    }

    .table tr:hover {
        background: #f8f9fa;
    }

    .status-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .status-pending { background: #fff3cd; color: #856404; }
    .status-submitted { background: #cce7ff; color: #004085; }
    .status-approved { background: #d4edda; color: #155724; }
    .status-rejected { background: #f8d7da; color: #721c24; }
    .status-completed { background: #d1ecf1; color: #0c5460; }

    .btn-action {
        padding: 6px 12px;
        border: none;
        border-radius: 4px;
        font-size: 0.8rem;
        font-weight: 600;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        transition: all 0.3s ease;
    }

    .btn-view {
        background: #17a2b8;
        color: white;
    }

    .btn-view:hover {
        background: #138496;
        transform: translateY(-1px);
    }

    .btn-back {
        background: #6c757d;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 20px;
        transition: all 0.3s ease;
    }

    .btn-back:hover {
        background: #5a6268;
        transform: translateY(-2px);
    }

    .no-data {
        text-align: center;
        padding: 40px;
        color: #666;
        font-style: italic;
    }

    .text-center { text-align: center; }
    .text-right { text-align: right; }

    .pagination {
        display: flex;
        justify-content: center;
        margin-top: 30px;
        gap: 10px;
    }

    .pagination a, .pagination span {
        padding: 8px 16px;
        border: 1px solid #ddd;
        border-radius: 4px;
        text-decoration: none;
        color: #061262;
        transition: all 0.3s ease;
    }

    .pagination a:hover {
        background: #061262;
        color: white;
    }

    .pagination .current {
        background: #061262;
        color: white;
        border-color: #061262;
    }
    
    /* New styles for warranty status */
    .warranty-status-info {
        background: #e7f3ff;
        border: 1px solid #b3d9ff;
        border-radius: 6px;
        padding: 15px;
        margin-bottom: 20px;
    }
    
    .warranty-status-item {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 8px;
    }
    
    .warranty-status-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
    }
    
    .warranty-sent { background: #007bff; }
    .warranty-returned { background: #28a745; }
    .warranty-pending { background: #ffc107; }
</style>

<div class="container">
    <a href="{% url 'app5:warranty_item' %}" class="btn-back">
        <i class="fas fa-arrow-left"></i>Add New
    </a>

    <div class="page-header">
        <h1><i class="fas fa-list-alt"></i> Warranty Tickets List</h1>
    </div>
<!-- Filters Section -->
    <div class="filters-section">
        <form method="GET" action="{% url 'app5:warranty_ticket_list' %}">
            <div class="filters-grid">
              
                <div class="form-group">
                    <label><i class="fas fa-building"></i> Supplier</label>
                    <select name="supplier">
                        <option value="">All Suppliers</option>
                        {% for supplier in suppliers %}
                            <option value="{{ supplier.id }}" {% if current_supplier == supplier.id|stringformat:"s" %}selected{% endif %}>
                                {{ supplier.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn-apply">
                        <i class="fas fa-search"></i> Apply Filters
                    </button>
                    <a href="{% url 'app5:warranty_ticket_list' %}" class="btn-reset">
                        <i class="fas fa-redo"></i> Reset
                    </a>
                </div>
            </div>
        </form>
    </div>

    <!-- Tickets Table -->
    <div class="table-container">
        {% if warranty_tickets %}
            <table class="table">
                <thead>
                    <tr>
                        <th>Warranty Ticket No</th>
                       
                        <th>Customer</th>
                        <th>Item</th>
                        <th>Supplier</th>
                       
                        <th>Submitted Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for ticket in warranty_tickets %}
                    <tr>
                        <td>
                            <strong>{{ ticket.ticket_no }}</strong>
                            {% if ticket.item_serial %}
                                <br><small style="color: #666;">Serial: {{ ticket.item_serial }}</small>
                            {% endif %}
                        </td>
                       
                        <td>
                            {{ ticket.jobcard.customer }}
                            <br><small style="color: #666;">{{ ticket.jobcard.phone }}</small>
                        </td>
                        <td>
                            {{ ticket.selected_item }}
                        </td>
                        <td>
                            {{ ticket.supplier.name }}
                            {% if ticket.supplier.place %}
                                <br><small style="color: #666;">{{ ticket.supplier.place }}</small>
                            {% endif %}
                        </td>
                    
                        <td>
                            {{ ticket.submitted_at|date:"d M Y" }}
                            {% if ticket.submitted_at %}
                                <br><small style="color: #666;">{{ ticket.submitted_at|date:"H:i" }}</small>
                            {% endif %}
                            {% if ticket.resolved_at %}
                                <br><small style="color: #28a745;">Resolved: {{ ticket.resolved_at|date:"d M Y" }}</small>
                            {% endif %}
                        </td>
                        <td>
                            <a href="{% url 'app5:warranty_ticket_detail' ticket.id %}" class="btn-action btn-view">
                                <i class="fas fa-eye"></i> View Details
                            </a>
                            <!-- {% if ticket.status == 'submitted' %}
                                <a href="{% url 'app5:jobcard_list' %}" class="btn-action" style="background: #28a745; color: white; margin-top: 5px; display: block;">
                                    <i class="fas fa-external-link-alt"></i> View in Job Cards
                                </a>
                            {% endif %} -->
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <div class="no-data">
                <i class="fas fa-inbox fa-3x" style="color: #ccc; margin-bottom: 20px;"></i>
                <h3>No Warranty Tickets Found</h3>
                <p>No warranty tickets match your current filters.</p>
                <a href="{% url 'app5:warranty_item' %}" class="btn-apply" style="margin-top: 15px;">
                    <i class="fas fa-plus"></i> Create New Warranty Ticket
                </a>
            </div>
        {% endif %}
    </div>

    <!-- Pagination -->
    {% if warranty_tickets.has_other_pages %}
    <div class="pagination">
        {% if warranty_tickets.has_previous %}
            <a href="?page=1{% if current_status %}&status={{ current_status }}{% endif %}{% if current_supplier %}&supplier={{ current_supplier }}{% endif %}">&laquo; First</a>
            <a href="?page={{ warranty_tickets.previous_page_number }}{% if current_status %}&status={{ current_status }}{% endif %}{% if current_supplier %}&supplier={{ current_supplier }}{% endif %}">Previous</a>
        {% endif %}

        {% for num in warranty_tickets.paginator.page_range %}
            {% if warranty_tickets.number == num %}
                <span class="current">{{ num }}</span>
            {% elif num > warranty_tickets.number|add:'-3' and num < warranty_tickets.number|add:'3' %}
                <a href="?page={{ num }}{% if current_status %}&status={{ current_status }}{% endif %}{% if current_supplier %}&supplier={{ current_supplier }}{% endif %}">{{ num }}</a>
            {% endif %}
        {% endfor %}

        {% if warranty_tickets.has_next %}
            <a href="?page={{ warranty_tickets.next_page_number }}{% if current_status %}&status={{ current_status }}{% endif %}{% if current_supplier %}&supplier={{ current_supplier }}{% endif %}">Next</a>
            <a href="?page={{ warranty_tickets.paginator.num_pages }}{% if current_status %}&status={{ current_status }}{% endif %}{% if current_supplier %}&supplier={{ current_supplier }}{% endif %}">Last &raquo;</a>
        {% endif %}
    </div>
    {% endif %}
</div>

<script>
    // Add some interactive functionality
    document.addEventListener('DOMContentLoaded', function() {
        // Add click handlers for status badges
        const statusBadges = document.querySelectorAll('.status-badge');
        statusBadges.forEach(badge => {
            badge.addEventListener('click', function() {
                const status = this.classList[1].replace('status-', '');
                window.location.href = `?status=${status}`;
            });
        });

        // Add search functionality
        const searchInput = document.createElement('input');
        searchInput.type = 'text';
        searchInput.placeholder = 'Search tickets...';
        searchInput.style.cssText = `
            width: 100%;
            padding: 10px;
            margin-bottom: 20px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
        `;

        searchInput.addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const rows = document.querySelectorAll('.table tbody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });

        // Insert search input after filters
        const filtersSection = document.querySelector('.filters-section');
        filtersSection.parentNode.insertBefore(searchInput, filtersSection.nextSibling);
        
        // Auto-refresh page every 30 seconds to get latest status updates
        setInterval(function() {
            const currentUrl = window.location.href;
            if (!currentUrl.includes('page=')) {
                window.location.reload();
            }
        }, 30000); // 30 seconds
    });
</script>

{% endblock %}