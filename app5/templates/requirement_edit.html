
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Edit Requirements</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    body { background: #f0f2f5; min-height: 100vh; }
    .container { max-width: 1600px; width: 100%; margin: 0 auto; padding: 20px; }
    .main-content { display: flex; gap: 20px; align-items: stretch; width: 100%; min-height: 80vh; }
    .form-column { flex: 1; min-width: 0; display: flex; flex-direction: column; }
    .form-container { background-color:#dcd9f3; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.15); overflow: hidden; width: 100%; flex: 1; display: flex; flex-direction: column; }
    .form-header { background:#a095f6; color:black; padding: 15px 20px; text-align: center; }
    .form-header h1 { font-size: 22px; margin-bottom: 5px; font-weight: 700; }
    .form-header p { font-size: 13px; opacity: 0.9; }
    .form-body { padding: 20px; flex: 1; display: flex; flex-direction: column; }
    .form-section { margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px dashed #e0e0e0; }
    .section-title { font-size: 16px; color: #14ad09; font-weight: bold; margin-bottom: 15px; padding-bottom: 5px; border-bottom: 1px solid #f0f0f0; display: flex; align-items: center; }
    .section-title i { margin-right: 8px; font-size: 16px; }
    .form-row { display: flex; flex-wrap: wrap; margin: 0 -5px; width: 100%; }
    .form-group { flex: 1; min-width: 180px; padding: 0 5px; margin-bottom: 15px; }
    label { display: block; margin-bottom: 5px; font-weight: 600; color: #444; font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    input, select, textarea { width: 100%; padding: 8px 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px; transition: all 0.2s; background-color: #f9f9f9; }
    input:focus, select:focus, textarea:focus { border-color: #6a11cb; box-shadow: 0 0 0 2px rgba(106,17,203,0.1); outline: none; background-color: white; }
    .form-navigation { display: flex; justify-content: center; margin-bottom: 20px; background: white; border-radius: 10px; padding: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); width: 100%; }
    .nav-menu { display: flex; list-style: none; gap: 5px; width: 100%; justify-content: center; flex-wrap: wrap; }
    .nav-item { flex: 1; text-align: center; min-width: 120px; }
    .nav-link { display: block; padding: 12px 15px; text-decoration: none; color: #666; font-weight: 600; border-radius: 8px; transition: all 0.3s ease; border: 2px solid transparent; font-size: 14px; white-space: nowrap; }
    .nav-link:hover { background: linear-gradient(135deg, #f8f9ff, #e8f0ff); color: #4CAF50; border-color: #4CAF50; }
    .nav-link.active { background: linear-gradient(135deg, #4CAF50, #45a049); color: white; border-color: #4CAF50; box-shadow: 0 4px 12px rgba(37,117,252,0.3); transform: translateY(-2px); }
    .nav-link i { margin-right: 8px; font-size: 16px; }
    .requirements-section { background-color: #ffe9cc; border: 2px solid #f8861b; border-radius: 10px; padding: 20px; margin-bottom: 20px; box-shadow: 0 3px 10px rgba(0,0,0,0.08); }
    .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #e5bc08; width: 100%; }
    .section-title-compact { display: flex; align-items: center; font-size: 16px; color: #d29105; font-weight: 700; margin: 0; white-space: nowrap; }
    .section-title-compact i { margin-right: 10px; font-size: 18px; color: #d29105; }
    .add-btn { background: linear-gradient(135deg, #4CAF50, #45a049); color: white; padding: 10px 20px; border: none; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; }
    .add-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 10px rgba(37,117,252,0.4); }
    .table-container { overflow-x: auto; border: 1px solid #f18d0a; border-radius: 8px; background: white; margin-top: 15px; }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th { background-color: #ffe9cc; padding: 12px 10px; text-align: left; font-weight: 600; color: #444; border: 1px solid #f18d0a; }
    td { padding: 10px; border: 1px solid #f18d0a; background: white; }
    tr:hover { background-color: #f9fafb; }
    .total-row { font-weight: bold; background-color: #ffe9cc; }
    .total-row td { border-top: 2px solid #f18d0a; font-size: 14px; }
    .delete-btn { background: #dc3545; color: white; padding: 6px 10px; border: none; border-radius: 4px; font-size: 12px; cursor: pointer; width: 100%; }
    .delete-btn:hover { background: #c82333; }
    .btn-group { display: flex; justify-content: center; margin-top: auto; gap: 10px; width: 100%; padding-top: 20px; }
    button { padding: 10px 20px;background-color: #0ec33f;color: #ffffff; border: none; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; }
    .submit-btn { background: linear-gradient(135deg, #4CAF50, #45a049); color: white; box-shadow: 0 3px 8px rgba(37,117,252,0.3); }
    .submit-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 10px rgba(37,117,252,0.4); }
    .reset-btn { background-color: #6c757d; color: white; border: none; }
    .reset-btn:hover { background-color: #5a6268; }
    .back-btn { background-color: #007bff; color: white; text-decoration: none; display: flex; align-items: center; justify-content: center; }
    .back-btn:hover { background-color: #0056b3; }

    /* Message styles */
    .success-message { background-color: #d4edda; color: #155724; padding: 12px; border-radius: 6px; margin-bottom: 20px; border: 1px solid #c3e6cb; }
    .error-message { background-color: #f8d7da; color: #721c24; padding: 12px; border-radius: 6px; margin-bottom: 20px; border: 1px solid #f5c6cb; }
    .warning-message { background-color: #fff3cd; color: #856404; padding: 12px; border-radius: 6px; margin-bottom: 20px; border: 1px solid #ffeaa7; }

    /* Edit mode indicator */
    .edit-mode-indicator {
        background: linear-gradient(135deg, #f8d7da, #fff3cd);
        color: #856404;
        padding: 12px 15px;
        border-radius: 6px;
        margin-bottom: 20px;
        border-left: 4px solid #ffc107;
        font-size: 14px;
        font-weight: 600;
    }

    /* Loading spinner */
    .loading-spinner {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid #f3f3f3;
        border-top: 2px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 8px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Lead info panel */
    .lead-info-panel {
        background: linear-gradient(135deg, #e3f2fd, #bbdefb);
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
        border: 2px solid #2196f3;
    }
    
    .lead-info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
    }
    
    .info-item {
        display: flex;
        flex-direction: column;
    }
    
    .info-label {
        font-size: 12px;
        color: #666;
        margin-bottom: 3px;
        font-weight: 600;
    }
    
    .info-value {
        font-size: 14px;
        font-weight: 600;
        color: #333;
    }
    
    .priority-badge {
        display: inline-block;
        padding: 3px 10px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .priority-high { background-color: #ff4444; color: white; }
    .priority-medium { background-color: #ffaa00; color: white; }
    .priority-low { background-color: #44ff44; color: #333; }

    /* Section info */
    .section-info {
        background: #f8f9fa;
        border-radius: 6px;
        padding: 10px 15px;
        margin-bottom: 15px;
        border-left: 4px solid #28a745;
        font-size: 13px;
    }

    @media (max-width: 1200px) {
        .main-content { flex-direction: column; }
    }
    
    @media (max-width: 768px) {
        .container { padding: 10px; }
        .form-row { flex-direction: column; }
        .form-group { min-width: 100%; }
        .nav-menu { flex-direction: column; }
        .nav-item { min-width: 100%; }
        .btn-group { flex-direction: column; }
        .lead-info-grid { grid-template-columns: 1fr; }
    }
</style>
</head>
<body>
<div class="container">
    <div class="main-content">
        <!-- Requirements Form -->
        <div class="form-column">
            <div class="form-container">
                <div class="form-header">
                    <h1>Edit Requirements</h1>
                    <p>Edit existing requirements for this lead</p>
                </div>

                <!-- Navigation Menu -->
                <div class="form-navigation">
                    <ul class="nav-menu">
                        <li class="nav-item">
                            <a href="{% url 'app5:lead' %}" class="nav-link">
                                <i class="fas fa-phone-alt"></i>
                                Lead Form
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#requirements-section" class="nav-link active">
                                <i class="fas fa-clipboard-list"></i>
                                Requirements
                            </a>
                        </li>
                        <li class="nav-item">
                             <a href="{% url 'app5:event_form' %}" class="nav-link">
                             <i class="fas fa-briefcase"></i>
                             Event
                            </a>
                        </li>
                        <li class="nav-item">
                           <a href="{% url 'app5:quotation_form' %}" class="nav-link">
                          <i class="fas fa-file-invoice"></i>
                           Quotation
                         </a>
                        </li>
                    </ul>
                </div>

                <div class="form-body">
                    {% if messages %}
                        {% for message in messages %}
                            <div class="{{ message.tags|default:'info' }}-message">
                                {{ message }}
                            </div>
                        {% endfor %}
                    {% endif %}
                    
                    <!-- Edit Mode Indicator -->
                    <div class="edit-mode-indicator">
                        <i class="fas fa-edit"></i>
                        Editing requirements for {{ lead.ownerName|default:lead.name|default:"Lead" }}
                        {% if requirements|length > 0 %} ({{ requirements|length }} item(s) found){% endif %}
                    </div>
                    
                    <!-- Lead Information Panel -->
                    <div class="lead-info-panel">
                        <div class="lead-info-grid">
                            <div class="info-item">
                                <span class="info-label"><i class="fas fa-user"></i> Lead Name</span>
                                <span class="info-value">{{ lead.ownerName|default:lead.name|default:"Unknown" }}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label"><i class="fas fa-phone"></i> Phone No</span>
                                <span class="info-value">{{ lead.phoneNo|default:lead.phone|default:"-" }}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label"><i class="fas fa-ticket-alt"></i> Ticket No</span>
                                <span class="info-value">{{ lead.ticket_number|default:"-" }}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label"><i class="fas fa-flag"></i> Priority</span>
                                <span class="info-value">
                                    <span class="priority-badge priority-{{ lead.priority|default:"medium"|lower }}">
                                        {{ lead.priority|default:"Medium" }}
                                    </span>
                                </span>
                            </div>
                            <div class="info-item">
                                <span class="info-label"><i class="fas fa-calendar"></i> Created Date</span>
                                <span class="info-value">{{ lead.created_date|date:"d M Y"|default:"-" }}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label"><i class="fas fa-clipboard-list"></i> Total Items</span>
                                <span class="info-value">{{ requirements|length }} item(s)</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Section Information -->
                    {% if section_summary %}
                    <div class="section-info">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                            <div style="font-weight: 600; color: #333;">
                                <i class="fas fa-filter"></i> Section Summary:
                            </div>
                            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                                {% for section, count in section_summary.items %}
                                    <span style="font-size: 12px;">
                                        {{ section }}: <span style="background: #e3f2fd; padding: 2px 8px; border-radius: 10px; font-weight: 600;">{{ count }}</span>
                                    </span>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- ===== Requirements Section ===== -->
                    <div class="requirements-section" id="requirements-section">
                        <div class="section-header">
                            <div class="section-title-compact">
                                <i class="fas fa-clipboard-list"></i>
                                <span>Edit Requirements</span>
                            </div>
                            <button type="button" class="add-btn" id="add-item-btn">
                                <i class="fas fa-plus"></i> Add New Item
                            </button>
                        </div>

                        <form id="requirements-form" method="POST" action="{% url 'app5:update_requirement' lead_id=lead.id %}">
                            {% csrf_token %}

                            <!-- Hidden fields -->
                            <input type="hidden" name="lead_id" value="{{ lead.id }}">
                            <input type="hidden" name="update_mode" value="edit">
                            <input type="hidden" name="requirement_ids" id="hiddenRequirementIds" value="">

                            <!-- Item options template -->
                            <template id="item-options">
                                {% for it in items %}
                                    <option value="{{ it.id }}"
                                        data-unit="{{ it.unit_of_measure }}"
                                        data-price="{{ it.mrp }}"
                                        data-section="{{ it.section|default:'GENERAL' }}">
                                        {{ it.name }}{% if it.section %} - {{ it.section }}{% endif %}
                                    </option>
                                {% endfor %}
                            </template>

                            <div class="table-container">
                                <table id="requirements-table">
                                    <thead>
                                        <tr>
                                            <th width="5%">Sl.No</th>
                                            <th width="25%">Section</th>
                                            <th width="35%">Item Name</th>
                                            <th width="10%">Unit</th>
                                            <th width="15%">Price</th>
                                            <th width="10%">Qty</th>
                                            <th width="15%">Total</th>
                                            <th width="10%">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="table-body">
                                        <!-- Rows will be added dynamically -->
                                    </tbody>
                                    <tfoot>
                                        <tr class="total-row">
                                            <td colspan="6" style="text-align: right; font-weight:700;">Grand Total:</td>
                                            <td id="grand-total" style="font-weight:700;">0.00</td>
                                            <td></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>

                            <!-- Form Actions -->
                            <div class="btn-group">
                                <button type="submit" class="submit-btn" id="submitRequirementsBtn">
                                    <i class="fas fa-save"></i> Update Requirements
                                </button>
                                <button type="button" class="reset-btn" id="resetFormBtn">
                                    <i class="fas fa-undo"></i> Reset Changes
                                </button>
                                <a href="{% url 'app5:requirement_form' %}" class="back-btn">
                                    <i class="fas fa-arrow-left"></i> Back to Requirements
                                </a>
                                <a href="{% url 'app5:lead_report' %}" class="back-btn" style="background-color: #28a745;">
                                    <i class="fas fa-list"></i> View Reports
                                </a>
                            </div>
                        </form>
                    </div>
                    <!-- ===== end Requirements Section ===== -->
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // ===== Requirements table logic =====
        const tbody = document.getElementById('table-body');
        const addBtn = document.getElementById('add-item-btn');
        const grandEl = document.getElementById('grand-total');
        const submitBtn = document.getElementById('submitRequirementsBtn');
        const resetBtn = document.getElementById('resetFormBtn');
        
        // Store original data for reset functionality
        let originalRequirements = [];
        let allItemOptions = [];

        // Format number with 2 decimal places
        function formatNumber(n) {
            n = parseFloat(n) || 0;
            return n.toFixed(2);
        }

        // Get all item options from template
        function loadItemOptions() {
            const template = document.getElementById('item-options');
            if (!template) {
                console.error("❌ Template #item-options not found!");
                return [];
            }
            
            return Array.from(template.content.querySelectorAll('option'));
        }

        // Create a new row
        function createRow(requirementData = null) {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="sl-no"></td>
                <td>
                    <select name="section[]" class="item-section-select section-select" 
                        style="width:100%; padding:8px; border:1px solid #ddd; border-radius:6px;">
                        <option value="">-- Select Section --</option>
                        <option value="GENERAL">General</option>
                        <option value="HARDWARE">Hardware</option>
                        <option value="SOFTWARE">Software</option>
                        <option value="PAPER_ROLLS">Paper Rolls</option>
                        <option value="OTHER">Other</option>
                    </select>
                </td>
                <td>
                    <select name="item_id[]" class="form-control item-select" required>
                        <option value="">-- Select Section First --</option>
                    </select>
                    <input type="hidden" name="requirement_id[]" value="${requirementData ? requirementData.id || '' : ''}">
                </td>
                <td><input type="text" name="unit[]" class="item-unit" readonly placeholder="Unit"></td>
                <td><input type="number" name="price[]" class="item-price" min="0" step="0.01" placeholder="0.00" required></td>
                <td><input type="number" name="qty[]" class="item-qty" min="1" step="1" value="1" required></td>
                <td class="item-total">0.00</td>
                <td><button type="button" class="delete-row delete-btn"><i class="fas fa-trash"></i></button></td>
            `;
            
            attachRowEvents(tr);
            tbody.appendChild(tr);
            
            // If we have requirement data, pre-fill the row
            if (requirementData) {
                setTimeout(() => {
                    populateRowWithData(tr, requirementData);
                }, 50);
            }
            
            return tr;
        }

        // Populate row with existing data
        function populateRowWithData(row, data) {
            const sectionSelect = row.querySelector('.section-select');
            const itemSelect = row.querySelector('.item-select');
            const unitInput = row.querySelector('.item-unit');
            const priceInput = row.querySelector('.item-price');
            const qtyInput = row.querySelector('.item-qty');
            const requirementIdInput = row.querySelector('input[name="requirement_id[]"]');
            
            // Store requirement ID if it exists
            if (data.id) {
                requirementIdInput.value = data.id;
            }
            
            // Set section
            if (sectionSelect && data.section) {
                sectionSelect.value = data.section.toUpperCase();
                
                // Trigger change to populate items
                setTimeout(() => {
                    sectionSelect.dispatchEvent(new Event('change'));
                    
                    // Wait for items to populate
                    setTimeout(() => {
                        if (itemSelect && data.item_id) {
                            // Find item by ID
                            const itemOption = allItemOptions.find(opt => 
                                parseInt(opt.value) === parseInt(data.item_id)
                            );
                            
                            if (itemOption) {
                                itemSelect.value = itemOption.value;
                                itemSelect.dispatchEvent(new Event('change'));
                                
                                // Override with saved data
                                setTimeout(() => {
                                    if (unitInput && data.unit) {
                                        unitInput.value = data.unit;
                                    }
                                    
                                    if (priceInput && data.price) {
                                        priceInput.value = parseFloat(data.price).toFixed(2);
                                    }
                                    
                                    if (qtyInput && data.quantity) {
                                        qtyInput.value = parseInt(data.quantity) || 1;
                                    }
                                    
                                    // Recalculate row total
                                    recalcRow(row);
                                }, 100);
                            } else {
                                // If item not found, set custom values
                                itemSelect.innerHTML = `<option value="${data.item_id}" selected>${data.item_name || 'Custom Item'}</option>`;
                                
                                if (unitInput && data.unit) {
                                    unitInput.value = data.unit;
                                }
                                
                                if (priceInput && data.price) {
                                    priceInput.value = parseFloat(data.price).toFixed(2);
                                }
                                
                                if (qtyInput && data.quantity) {
                                    qtyInput.value = parseInt(data.quantity) || 1;
                                }
                                
                                recalcRow(row);
                            }
                        }
                    }, 200);
                }, 50);
            }
        }

        // Initialize item dropdown with filtered items
        function initializeItemDropdown(itemSelect, section = null) {
            // Clear dropdown
            itemSelect.innerHTML = `<option value="">-- Select Item --</option>`;
            
            if (section) {
                // Normalize section for comparison
                const targetSection = section.toUpperCase().trim();
                
                // Filter items by section
                const filtered = allItemOptions.filter(opt => {
                    const optSection = (opt.dataset.section || '').toUpperCase().trim();
                    return optSection === targetSection;
                });
                
                if (filtered.length === 0) {
                    itemSelect.innerHTML = `<option value="">-- No items in ${section} section --</option>`;
                    itemSelect.disabled = true;
                    return;
                }
                
                // Add filtered items to dropdown
                filtered.forEach(opt => {
                    const newOption = document.createElement('option');
                    newOption.value = opt.value;
                    newOption.textContent = opt.textContent.trim();
                    newOption.dataset.unit = opt.dataset.unit || '';
                    newOption.dataset.price = opt.dataset.price || '0.00';
                    newOption.dataset.section = opt.dataset.section || '';
                    itemSelect.appendChild(newOption);
                });
                
                itemSelect.disabled = false;
            } else {
                itemSelect.innerHTML = `<option value="">-- Select Section First --</option>`;
                itemSelect.disabled = true;
            }
        }

        // Attach events to row elements
        function attachRowEvents(row) {
            const sectionSelect = row.querySelector('.section-select');
            const itemSelect = row.querySelector('.item-select');
            const unitInput = row.querySelector('.item-unit');
            const priceInput = row.querySelector('.item-price');
            const qtyInput = row.querySelector('.item-qty');
            const deleteBtn = row.querySelector('.delete-row');

            // When SECTION changes → filter the items
            sectionSelect.addEventListener('change', function () {
                const sec = this.value.trim();
                
                // Clear item selection and values
                itemSelect.value = "";
                unitInput.value = "";
                priceInput.value = "";
                
                if (sec) {
                    initializeItemDropdown(itemSelect, sec);
                } else {
                    itemSelect.disabled = true;
                    itemSelect.innerHTML = `<option value="">-- Select Section First --</option>`;
                }
                
                recalcRow(row);
            });

            // When ITEM changes → autofill (unit, price)
            itemSelect.addEventListener('change', function () {
                const opt = this.selectedOptions[0];

                if (opt && opt.value !== "") {
                    unitInput.value = opt.dataset.unit || "";
                    priceInput.value = parseFloat(opt.dataset.price || 0).toFixed(2);
                } else {
                    unitInput.value = "";
                    priceInput.value = "";
                }

                recalcRow(row);
            });

            // Price / Qty changes
            priceInput.addEventListener('input', () => recalcRow(row));
            qtyInput.addEventListener('input', () => recalcRow(row));

            deleteBtn.addEventListener('click', function () {
                row.remove();
                refreshSlNos();
                recalcGrandTotal();
            });
        }

        // Recalculate row total
        function recalcRow(row) {
            const priceInput = row.querySelector('.item-price');
            const qtyInput = row.querySelector('.item-qty');
            const totalCell = row.querySelector('.item-total');

            const price = parseFloat(priceInput.value || 0);
            const qty = parseInt(qtyInput.value || 0) || 0;
            const total = price * qty;

            totalCell.textContent = formatNumber(total);
            recalcGrandTotal();
        }

        // Recalculate grand total
        function recalcGrandTotal() {
            let grand = 0;
            document.querySelectorAll('#table-body .item-total').forEach(cell => {
                grand += parseFloat(cell.textContent || 0);
            });
            grandEl.textContent = formatNumber(grand);
        }

        // Refresh serial numbers
        function refreshSlNos() {
            document.querySelectorAll('#table-body tr').forEach((row, idx) => {
                const cell = row.querySelector('.sl-no');
                if (cell) cell.textContent = idx + 1;
            });
        }

        // Load existing requirements
        function loadRequirements() {
            // Clear table
            tbody.innerHTML = '';
            
            {% if requirements %}
                originalRequirements = JSON.parse('{{ requirements_json|safe }}' || '[]');
                
                // Create rows for each requirement
                originalRequirements.forEach((req, index) => {
                    createRow(req);
                });
            {% else %}
                // Create one empty row if no requirements exist
                createRow();
            {% endif %}
            
            refreshSlNos();
            recalcGrandTotal();
            updateRequirementIds();
        }

        // Update hidden requirement IDs field
        function updateRequirementIds() {
            const requirementIds = [];
            document.querySelectorAll('input[name="requirement_id[]"]').forEach(input => {
                if (input.value) {
                    requirementIds.push(input.value);
                }
            });
            
            document.getElementById('hiddenRequirementIds').value = requirementIds.join(',');
        }

        // Reset form to original state
        function resetForm() {
            if (confirm('Are you sure you want to reset all changes? This will restore the original requirements.')) {
                loadRequirements();
                showTemporaryMessage('Changes reset to original state', 'success');
            }
        }

        // Show temporary notification
        function showTemporaryMessage(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                background: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : '#2196F3'};
                color: white;
                border-radius: 5px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                font-weight: 600;
                transition: all 0.3s ease;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100px)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // Initialize the page
        function initializePage() {
            // Load item options
            allItemOptions = loadItemOptions();
            console.log(`Loaded ${allItemOptions.length} item options`);
            
            // Load existing requirements
            loadRequirements();
            
            // Add new row button
            if (addBtn) {
                addBtn.addEventListener('click', function () {
                    createRow();
                    refreshSlNos();
                    updateRequirementIds();
                });
            }
            
            // Reset form button
            if (resetBtn) {
                resetBtn.addEventListener('click', resetForm);
            }
            
            // Form submission validation
            document.getElementById('requirements-form').addEventListener('submit', function(e) {
                // Validate all rows have items selected
                let allValid = true;
                let hasItems = false;
                
                document.querySelectorAll('.item-select').forEach(select => {
                    if (!select.value && select.closest('tr').style.display !== 'none') {
                        allValid = false;
                        select.style.borderColor = '#ff4444';
                    } else {
                        select.style.borderColor = '';
                        hasItems = true;
                    }
                });

                if (!hasItems) {
                    e.preventDefault();
                    showTemporaryMessage('Please add at least one requirement item', 'error');
                    return;
                }

                if (!allValid) {
                    e.preventDefault();
                    showTemporaryMessage('Please select an item for all rows', 'error');
                    return;
                }
                
                // Update requirement IDs before submission
                updateRequirementIds();
                
                // Show loading state
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
                submitBtn.disabled = true;
                resetBtn.disabled = true;
                
                showTemporaryMessage('Saving changes...', 'info');
            });
            
            // Update requirement IDs when rows are deleted
            tbody.addEventListener('DOMNodeRemoved', function() {
                setTimeout(() => {
                    updateRequirementIds();
                }, 100);
            });
            
            console.log('Edit page initialized with {{ requirements|length }} existing requirements');
        }

        // Start initialization
        initializePage();
    });
</script>
</body>
</html>
