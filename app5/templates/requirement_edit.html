<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Edit Requirements</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    body { background: #f0f2f5; min-height: 100vh; }
    .container { max-width: 1600px; width: 100%; margin: 0 auto; padding: 20px; }
    .main-content { display: flex; gap: 20px; align-items: stretch; width: 100%; min-height: 80vh; }
    
    /* Directory Column */
    .directory-column { flex: 0 0 320px; width: 320px; display: flex; flex-direction: column; }
    .lead-directory-container { background: white; border-radius: 10px; box-shadow: 0 3px 10px rgba(0,0,0,0.08); overflow: hidden; height: 100%; display: flex; flex-direction: column; }
    .directory-header { background: #4a6fdc; color: white; padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; }
    .directory-header h2 { font-size: 16px; font-weight: 600; }
    .directory-info { font-size: 12px; opacity: 0.9; }
    .directory-tabs { display: flex; background: #f8f9fa; border-bottom: 1px solid #e9ecef; }
    .directory-tab { flex: 1; padding: 10px 12px; text-align: center; background: transparent; border: none; font-weight: 600; font-size: 13px; color: #6c757d; cursor: pointer; transition: all 0.3s; border-bottom: 3px solid transparent; }
    .directory-tab.active { color: #4a6fdc; border-bottom-color: #4a6fdc; background: white; }
    .directory-tab:hover { background: #e9ecef; }
    .search-container { padding: 12px 15px; background: #f8f9fa; border-bottom: 1px solid #e9ecef; }
    .search-box { position: relative; width: 100%; }
    .search-box input { padding: 8px 12px 8px 35px; border: 1px solid #ddd; border-radius: 8px; font-size: 13px; width: 100%; background: white; }
    .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #6c757d; font-size: 13px; }
    .employee-list, .lead-list { flex: 1; overflow-y: auto; padding: 8px 0; display: none; }
    .employee-list.active, .lead-list.active { display: block; }
    
    /* Lead Item Styles */
    .lead-item {
        display: flex;
        align-items: center;
        padding: 12px 15px;
        border-bottom: 1px solid #f0f0f0;
        transition: all 0.2s;
        cursor: pointer;
        position: relative;
        border-left: 4px solid transparent;
    }
    
    /* Hover effect for all leads */
    .lead-item:hover {
        background: linear-gradient(135deg, #f8f9ff, #e8f0ff);
        transform: translateY(-1px);
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        border-left: 4px solid #4a6fdc;
    }
    
    /* Current/Active lead item styling - ONLY ONE */
    .lead-item.current-lead-item {
        background: linear-gradient(135deg, #e3f2fd, #bbdefb) !important;
        border-left: 4px solid #2196f3 !important;
        box-shadow: 0 2px 8px rgba(33, 150, 243, 0.2) !important;
        position: relative;
        overflow: hidden;
    }
    
    /* Glow effect for current lead */
    .lead-item.current-lead-item::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 2px;
        background: linear-gradient(90deg, #2196f3, #42a5f5, #2196f3);
        animation: pulse-glow 2s infinite;
    }
    
    .lead-item.current-lead-item .lead-avatar {
        background: #2196f3 !important;
        box-shadow: 0 0 0 2px white, 0 0 0 4px #2196f3;
        transform: scale(1.1);
        transition: transform 0.3s;
    }
    
    /* Current lead badge */
    .current-lead-badge {
        background: linear-gradient(135deg, #2196f3, #1976d2);
        color: white;
        font-size: 9px;
        padding: 3px 8px;
        border-radius: 12px;
        font-weight: 700;
        margin-left: auto;
        display: flex;
        align-items: center;
        gap: 4px;
        box-shadow: 0 2px 4px rgba(33, 150, 243, 0.3);
        animation: badge-pulse 1.5s infinite;
    }
    
    /* Active lead indicator in header */
    .active-lead-header {
        background: linear-gradient(135deg, #e3f2fd, #bbdefb);
        border-radius: 8px;
        padding: 12px 15px;
        margin: 10px 15px;
        border-left: 4px solid #2196f3;
        border-right: 4px solid #2196f3;
        box-shadow: 0 2px 8px rgba(33, 150, 243, 0.15);
    }
    
    .active-lead-title {
        font-size: 14px;
        font-weight: 700;
        color: #333;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .active-lead-details {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        font-size: 12px;
    }
    
    .active-lead-detail {
        display: flex;
        align-items: center;
        gap: 5px;
        color: #666;
    }
    
    .active-lead-value {
        font-weight: 700;
        color: #333;
    }
    
    .lead-item.clickable {
        cursor: pointer;
    }
    
    .edit-lead-indicator {
        position: absolute;
        top: 8px;
        right: 8px;
        background: #4CAF50;
        color: white;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        opacity: 0;
        transition: opacity 0.3s;
        z-index: 2;
    }
    
    .lead-item:hover .edit-lead-indicator {
        opacity: 1;
    }
    
    .lead-item.current-lead-item .edit-lead-indicator {
        background: #ff9800;
        opacity: 1;
        transform: scale(1.1);
    }
    
    .lead-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: #28a745;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 12px;
        margin-right: 12px;
        flex-shrink: 0;
        transition: all 0.3s;
    }
    
    .lead-details {
        flex: 1;
        min-width: 0;
    }
    
    .lead-name {
        font-weight: 600;
        color: #333;
        margin-bottom: 2px;
        font-size: 13px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .lead-info {
        font-size: 12px;
        color: #6c757d;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .lead-phone {
        font-size: 11px;
        color: #495057;
        margin-top: 1px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        display: flex;
        align-items: center;
        gap: 4px;
    }
    
    .lead-ticket {
        font-size: 10px;
        color: #6c757d;
        background: #f8f9fa;
        border-radius: 4px;
        display: inline-block;
        margin-top: 2px;
        padding: 2px 6px;
        font-weight: 600;
    }
    
    /* Animations */
    @keyframes pulse-glow {
        0% { opacity: 0.7; }
        50% { opacity: 1; }
        100% { opacity: 0.7; }
    }
    
    @keyframes badge-pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }
    
    /* Filters */
    .filter-container { padding: 10px 15px; background: #f8f9fa; border-bottom: 1px solid #ddd; display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
    .filter-group { display: flex; align-items: center; gap: 8px; }
    .filter-label { font-size: 13px; font-weight: 600; white-space: nowrap; }
    .filter-select { padding: 6px; border-radius: 8px; min-width: 120px; }
    .status-filter-group { display: flex; align-items: center; gap: 8px; margin-left: auto; }
    
    /* No results */
    .no-results { padding: 20px 15px; text-align: center; color: #6c757d; font-size: 13px; }
    
    /* Form Column */
    .form-column { flex: 1; min-width: 0; display: flex; flex-direction: column; }
    .form-container { background-color:#dcd9f3; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.15); overflow: hidden; width: 100%; flex: 1; display: flex; flex-direction: column; }
    .form-header { background:#a095f6; color:black; padding: 15px 20px; text-align: center; }
    .form-header h1 { font-size: 22px; margin-bottom: 5px; font-weight: 700; }
    .form-header p { font-size: 13px; opacity: 0.9; }
    .form-body { padding: 20px; flex: 1; display: flex; flex-direction: column; }
    .form-section { margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px dashed #e0e0e0; }
    .section-title { font-size: 16px; color: #14ad09; font-weight: bold; margin-bottom: 15px; padding-bottom: 5px; border-bottom: 1px solid #f0f0f0; display: flex; align-items: center; }
    .section-title i { margin-right: 8px; font-size: 16px; }
    .form-row { display: flex; flex-wrap: wrap; margin: 0 -5px; width: 100%; }
    .form-group { flex: 1; min-width: 180px; padding: 0 5px; margin-bottom: 15px; }
    label { display: block; margin-bottom: 5px; font-weight: 600; color: #444; font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    input, select, textarea { width: 100%; padding: 8px 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px; transition: all 0.2s; background-color: #f9f9f9; }
    input:focus, select:focus, textarea:focus { border-color: #6a11cb; box-shadow: 0 0 0 2px rgba(106,17,203,0.1); outline: none; background-color: white; }
    .form-navigation { display: flex; justify-content: center; margin-bottom: 20px; background: white; border-radius: 10px; padding: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); width: 100%; }
    .nav-menu { display: flex; list-style: none; gap: 5px; width: 100%; justify-content: center; flex-wrap: wrap; }
    .nav-item { flex: 1; text-align: center; min-width: 120px; }
    .nav-link { display: block; padding: 12px 15px; text-decoration: none; color: #666; font-weight: 600; border-radius: 8px; transition: all 0.3s ease; border: 2px solid transparent; font-size: 14px; white-space: nowrap; }
    .nav-link:hover { background: linear-gradient(135deg, #f8f9ff, #e8f0ff); color: #4CAF50; border-color: #4CAF50; }
    .nav-link.active { background: linear-gradient(135deg, #4CAF50, #45a049); color: white; border-color: #4CAF50; box-shadow: 0 4px 12px rgba(37,117,252,0.3); transform: translateY(-2px); }
    .nav-link i { margin-right: 8px; font-size: 16px; }
    .requirements-section { background-color: #ffe9cc; border: 2px solid #f8861b; border-radius: 10px; padding: 20px; margin-bottom: 20px; box-shadow: 0 3px 10px rgba(0,0,0,0.08); }
    .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #e5bc08; width: 100%; }
    .section-title-compact { display: flex; align-items: center; font-size: 16px; color: #d29105; font-weight: 700; margin: 0; white-space: nowrap; }
    .section-title-compact i { margin-right: 10px; font-size: 18px; color: #d29105; }
    .add-btn { background: linear-gradient(135deg, #4CAF50, #45a049); color: white; padding: 10px 20px; border: none; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; }
    .add-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 10px rgba(37,117,252,0.4); }
    .table-container { overflow-x: auto; border: 1px solid #f18d0a; border-radius: 8px; background: white; margin-top: 15px; }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th { background-color: #ffe9cc; padding: 12px 10px; text-align: left; font-weight: 600; color: #444; border: 1px solid #f18d0a; }
    td { padding: 10px; border: 1px solid #f18d0a; background: white; }
    tr:hover { background-color: #f9fafb; }
    .total-row { font-weight: bold; background-color: #ffe9cc; }
    .total-row td { border-top: 2px solid #f18d0a; font-size: 14px; }
    .delete-btn { background: #dc3545; color: white; padding: 6px 10px; border: none; border-radius: 4px; font-size: 12px; cursor: pointer; width: 100%; }
    .delete-btn:hover { background: #c82333; }
    .btn-group { display: flex; justify-content: center; margin-top: auto; gap: 10px; width: 100%; padding-top: 20px; }
    button { padding: 10px 20px;background-color: #0ec33f;color: #ffffff; border: none; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; }
    .submit-btn { background: linear-gradient(135deg, #4CAF50, #45a049); color: white; box-shadow: 0 3px 8px rgba(37,117,252,0.3); }
    .submit-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 10px rgba(37,117,252,0.4); }
    .reset-btn { background-color: #6c757d; color: white; border: none; }
    .reset-btn:hover { background-color: #5a6268; }
    .back-btn { background-color: #007bff; color: white; text-decoration: none; display: flex; align-items: center; justify-content: center; }
    .back-btn:hover { background-color: #0056b3; }
    
    /* Message styles */
    .success-message { background-color: #d4edda; color: #155724; padding: 12px; border-radius: 6px; margin-bottom: 20px; border: 1px solid #c3e6cb; }
    .error-message { background-color: #f8d7da; color: #721c24; padding: 12px; border-radius: 6px; margin-bottom: 20px; border: 1px solid #f5c6cb; }
    .warning-message { background-color: #fff3cd; color: #856404; padding: 12px; border-radius: 6px; margin-bottom: 20px; border: 1px solid #ffeaa7; }
    
    /* Edit mode indicator */
    .edit-mode-indicator {
        background: linear-gradient(135deg, #f8d7da, #fff3cd);
        color: #856404;
        padding: 12px 15px;
        border-radius: 6px;
        margin-bottom: 20px;
        border-left: 4px solid #ffc107;
        font-size: 14px;
        font-weight: 600;
    }
    
    /* Loading spinner */
    .loading-spinner {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid #f3f3f3;
        border-top: 2px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 8px;
    }
    
    .btn-refresh {
        background:#45a049;
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
    }
    
    .btn-refresh:hover {
        background:#45a049;
        transform: translateY(-2px);
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    /* Lead info panel */
    .lead-info-panel {
        background: linear-gradient(135deg, #e3f2fd, #bbdefb);
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
        border: 2px solid #2196f3;
    }
    
    .lead-info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
    }
    
    .info-item {
        display: flex;
        flex-direction: column;
    }
    
    .info-label {
        font-size: 12px;
        color: #666;
        margin-bottom: 3px;
        font-weight: 600;
    }
    
    .info-value {
        font-size: 14px;
        font-weight: 600;
        color: #333;
    }
    
    .priority-badge {
        display: inline-block;
        padding: 3px 10px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .priority-high { background-color: #ff4444; color: white; }
    .priority-medium { background-color: #ffaa00; color: white; }
    .priority-low { background-color: #44ff44; color: #333; }
    
    /* Pagination */
    .directory-pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 12px 15px;
        background: #f8f9fa;
        border-top: 1px solid #e9ecef;
        gap: 10px;
    }
    .pagination-info {
        font-size: 12px;
        color: #6c757d;
        margin: 0 10px;
    }
    .pagination-btn {
        padding: 6px 12px;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s;
        color: #4a6fdc;
    }
    .pagination-btn:hover:not(:disabled) {
        background: #4a6fdc;
        color: white;
        border-color: #4a6fdc;
    }
    .pagination-btn:disabled {
        background: #f8f9fa;
        color: #6c757d;
        cursor: not-allowed;
    }
    
    @media (max-width: 1200px) {
        .main-content { flex-direction: column; }
        .directory-column { flex: 0 0 auto; width: 100%; }
        .lead-directory-container { height: auto; max-height: 400px; }
    }
    
    @media (max-width: 768px) {
        .container { padding: 10px; }
        .form-row { flex-direction: column; }
        .form-group { min-width: 100%; }
        .nav-menu { flex-direction: column; }
        .nav-item { min-width: 100%; }
        .btn-group { flex-direction: column; }
        .lead-info-grid { grid-template-columns: 1fr; }
        .directory-header { flex-direction: column; align-items: flex-start; gap: 10px; }
        .filter-container { flex-direction: column; align-items: stretch; }
        .status-filter-group { margin-left: 0; }
    }
</style>
</head>
<body>
<div class="container">
    <div class="main-content">
        <!-- Left Column - Lead Directory -->
        <div class="directory-column">
            <div class="lead-directory-container">
                <div class="directory-header">
                    <h2>Lead Directory</h2>
                    <div class="directory-info">
                        <span id="activeTabCount">{{ leads_count }}</span> leads
                    </div>
                </div>
                
                <!-- Directory Tabs -->
                <div class="directory-tabs">
                    <button class="directory-tab active" data-tab="leads">
                        <i class="fas fa-users"></i> Leads
                    </button>
                    <button class="directory-tab" data-tab="employees">
                        <i class="fas fa-user-tie"></i> Employees
                    </button>
                </div>
                
                <div class="search-container">
                    <div class="search-box">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" id="directorySearch" placeholder="Search by Name/Phone/Ticket...">
                    </div>
                </div>

                <!-- Filters -->
                <div class="filter-container" id="leadFilters" style="display: block;">
                    <div class="filter-group">
                        <span class="filter-label">Priority:</span>
                        <select id="priorityFilter" class="filter-select">
                            <option value="all">All</option>
                            <option value="High">üî¥ High</option>
                            <option value="Medium">üü° Medium</option>
                            <option value="Low">üü¢ Low</option>
                        </select>
                    </div>
                    
                    <div class="status-filter-group">
                        <span class="filter-label">Status:</span>
                        <select id="statusFilter" class="filter-select">
                            <option value="all">All</option>
                            <option value="Active">Active</option>
                            <option value="Follow Up">Follow Up</option>
                            <option value="Quoted">Quoted</option>
                            <option value="Closed">Closed</option>
                        </select>
                    </div>
                </div>
                
                <!-- Active Lead Indicator -->
                {% if lead_data %}
                <div class="active-lead-header">
                    <div class="active-lead-title">
                        <i class="fas fa-star" style="color:#2196f3;"></i>
                        <span style="font-weight: 700;">Currently Editing:</span>
                    </div>
                    <div class="active-lead-details">
                        <div class="active-lead-detail">
                            <i class="fas fa-user"></i>
                            <span class="active-lead-value">{{ lead_data.ownerName }}</span>
                        </div>
                        <div class="active-lead-detail">
                            <i class="fas fa-ticket-alt"></i>
                            <span class="active-lead-value">#{{ lead_data.ticket_number }}</span>
                        </div>
                        <div class="active-lead-detail">
                            <i class="fas fa-clipboard-list"></i>
                            <span class="active-lead-value">{{ requirements|length }} item(s)</span>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <!-- Lead List -->
                <div class="lead-list active" id="leadList">
                    {% if active_leads %}
                        {% for lead_item in active_leads %}
                        {% with lead_ticket=lead_item.ticket_number|default:"-" %}
                        <div class="lead-item clickable editable {% if lead_item.id == current_lead_id %}current-lead-item{% endif %}" 
                             data-id="{{ lead_item.id }}" 
                             data-name="{{ lead_item.ownerName|default:lead_item.firstName|default:'Unknown' }}" 
                             data-phone="{{ lead_item.phoneNo|default:'' }}" 
                             data-ticket="{{ lead_ticket }}"
                             data-priority="{{ lead_item.priority|default:'Medium' }}"
                             data-status="{{ lead_item.status|default:'Active' }}"
                             data-requirements-count="{{ lead_item.requirements_count|default:0 }}"
                             onclick="redirectToLeadPage({{ lead_item.id }}, event)">
                            
                            <!-- Edit Indicator -->
                            <div class="edit-lead-indicator" title="Click to edit requirements">
                                <i class="fas fa-edit" style="font-size: 10px;"></i>
                            </div>
                            
                            <!-- Priority Indicator -->
                            <div class="lead-avatar" style="background: {% if lead_item.priority == 'High' %}#dc3545{% elif lead_item.priority == 'Medium' %}#ffc107{% else %}#28a745{% endif %}">
                                {{ lead_item.ownerName|default:lead_item.firstName|default:'U'|slice:":1"|upper }}
                            </div>

                            <div class="lead-details">
                                <!-- Name with Ticket -->
                                <div class="lead-name">
                                    {{ lead_item.ownerName|default:lead_item.firstName|default:'Unknown' }}
                                    {% if lead_ticket and lead_ticket != "-" %}
                                    <span class="lead-ticket">#{{ lead_ticket }}</span>
                                    {% endif %}
                                    
                                    <!-- CURRENT LEAD BADGE - Only for current lead -->
                                    {% if lead_item.id == current_lead_id %}
                                    <div class="current-lead-badge">
                                        <i class="fas fa-star" style="font-size: 8px;"></i>
                                        EDITING
                                    </div>
                                    {% endif %}
                                </div>
                                
                                <!-- Phone -->
                                {% with phone=lead_item.phoneNo|default:'' %}
                                {% if phone %}
                                <div class="lead-phone">
                                    <i class="fas fa-phone-alt" style="font-size: 9px;"></i> {{ phone }}
                                </div>
                                {% endif %}
                                {% endwith %}
                                
                                <!-- Company/Place -->
                                {% with company=lead_item.company|default:lead_item.business|default:'' place=lead_item.place|default:lead_item.District|default:lead_item.State|default:'' %}
                                {% if company or place %}
                                <div class="lead-info">
                                    {% if company %}{{ company }}{% endif %}
                                    {% if place %}{% if company %} - {% endif %}{{ place }}{% endif %}
                                </div>
                                {% endif %}
                                {% endwith %}
                                
                                <!-- Status & Priority -->
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 5px;">
                                    <span style="color: {% if lead_item.status == 'Active' %}#28a745{% elif lead_item.status == 'Follow Up' %}#17a2b8{% elif lead_item.status == 'Quoted' %}#ffc107{% elif lead_item.status == 'Closed' %}#6c757d{% else %}#6c757d{% endif %}; font-size: 10px; font-weight: 600;">
                                        {{ lead_item.status|default:'Active' }}
                                    </span>
                                    <span style="color: {% if lead_item.priority == 'High' %}#dc3545{% elif lead_item.priority == 'Medium' %}#ffc107{% else %}#28a745{% endif %}; font-weight:600; font-size: 10px; padding: 2px 6px; border-radius: 10px; background: rgba(0,0,0,0.05);">
                                        {{ lead_item.priority|default:'Medium' }}
                                    </span>
                                </div>
                                
                                <!-- Requirements Count -->
                                {% with req_count=lead_item.requirements_count|default:0 %}
                                {% if req_count > 0 %}
                                <div style="margin-top: 3px; font-size: 10px; color: #28a745; font-weight: 600; display: flex; align-items: center; gap: 4px;">
                                    <i class="fas fa-clipboard-list" style="font-size: 9px;"></i> 
                                    {{ req_count }} item(s)
                                    <span style="font-size: 9px; color: #6c757d; margin-left: 4px;">
                                        <i class="fas fa-external-link-alt"></i> Click to edit
                                    </span>
                                </div>
                                {% else %}
                                <div style="margin-top: 3px; font-size: 10px; color: #6c757d; display: flex; align-items: center; gap: 4px;">
                                    <i class="fas fa-plus-circle" style="font-size: 9px;"></i> 
                                    No requirements yet
                                    <span style="font-size: 9px; color: #007bff; margin-left: 4px;">
                                        <i class="fas fa-external-link-alt"></i> Click to add
                                    </span>
                                </div>
                                {% endif %}
                                {% endwith %}
                                
                                <!-- Current Indicator -->
                                {% if lead_item.id == current_lead_id %}
                                <div style="margin-top: 3px; font-size: 10px; color: #2196f3; font-weight: 700; display: flex; align-items: center; gap: 4px; animation: pulse-glow 2s infinite;">
                                    <i class="fas fa-pen" style="font-size: 9px;"></i> 
                                    Currently Editing This Lead
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endwith %}
                        {% endfor %}
                    {% else %}
                        <div class="no-results">
                            <i class="fas fa-user-slash" style="font-size: 24px; margin-bottom: 10px; color: #6c757d;"></i>
                            <p>No leads found</p>
                            <p style="font-size: 11px; margin-top: 5px;">Create leads in the Lead Form first</p>
                        </div>
                    {% endif %}
                </div>
                
                <!-- Employee List (hidden by default) -->
                <div class="employee-list" id="employeeList">
                    {% if active_users %}
                        {% for u in active_users %}
                        <div class="lead-item" data-id="{{ u.id }}" data-name="{{ u.get_full_name|default:u.username }}" data-phone="">
                            <div class="lead-avatar">
                                {{ u.get_full_name|default:u.username|slice:":1"|upper }}
                            </div>

                            <div class="lead-details">
                                <div class="lead-name">{{ u.get_full_name|default:u.username }}</div>
                                <div class="lead-info">
                                    {% if u.email %}{{ u.email }}{% endif %}
                                </div>
                                <div style="margin-top: 3px; font-size: 10px; color: #6c757d; font-weight: 600;">
                                    Staff Member
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="no-results">
                            <i class="fas fa-user-tie" style="font-size: 24px; margin-bottom: 10px; color: #6c757d;"></i>
                            <p>No active employees found</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Right Column - Requirements Form -->
        <div class="form-column">
            <div class="form-container">
                <div class="form-header">
                    <h1>Edit Requirements</h1>
                    <p>Edit existing requirements for this lead</p>
                </div>

                <!-- Navigation Menu -->
                <div class="form-navigation">
                    <ul class="nav-menu">
                        <li class="nav-item">
                            <a href="{% url 'app5:lead' %}" class="nav-link">
                                <i class="fas fa-phone-alt"></i>
                                Lead Form
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#requirements-section" class="nav-link active">
                                <i class="fas fa-clipboard-list"></i>
                                Requirements
                            </a>
                        </li>
                        <li class="nav-item">
                             <a href="{% url 'app5:event_form' %}" class="nav-link">
                             <i class="fas fa-briefcase"></i>
                             Event
                            </a>
                        </li>
                        <li class="nav-item">
                           <a href="{% url 'app5:quotation_form' %}" class="nav-link">
                          <i class="fas fa-file-invoice"></i>
                           Quotation
                         </a>
                        </li>
                    </ul>
                </div>

                <div class="form-body">
                    {% if messages %}
                        {% for message in messages %}
                            <div class="{{ message.tags|default:'info' }}-message">
                                {{ message }}
                            </div>
                        {% endfor %}
                    {% endif %}
                    
                    <!-- Lead Information Panel -->
                    <div class="lead-info-panel">
                        <div class="lead-info-grid">
                            <div class="info-item">
                                <span class="info-label"><i class="fas fa-user"></i> Lead Name</span>
                                <span class="info-value">{{ lead_data.ownerName|default:"Unknown" }}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label"><i class="fas fa-phone"></i> Phone No</span>
                                <span class="info-value">{{ lead_data.phoneNo|default:"-" }}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label"><i class="fas fa-ticket-alt"></i> Ticket No</span>
                                <span class="info-value">{{ lead_data.ticket_number|default:"-" }}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label"><i class="fas fa-clipboard-list"></i> Total Items</span>
                                <span class="info-value">{{ requirements|length }} item(s)</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ===== Requirements Section ===== -->
                    <div class="requirements-section" id="requirements-section">
                        <div class="section-header">
                            <div class="section-title-compact">
                                <i class="fas fa-clipboard-list"></i>
                                <span>Edit Requirements</span>
                            </div>
                            <button type="button" class="add-btn" id="add-item-btn">
                                <i class="fas fa-plus"></i> Add New Item
                            </button>
                        </div>

                        <form id="requirements-form" method="POST" action="{% url 'app5:update_requirement' lead_id=lead.id %}">
                            {% csrf_token %}

                            <!-- Hidden fields -->
                            <input type="hidden" name="lead_id" value="{{ lead.id }}">
                            <input type="hidden" name="update_mode" value="edit">
                            <input type="hidden" name="requirement_ids" id="hiddenRequirementIds" value="">

                            <!-- Item options template -->
                            <template id="item-options">
                                {% for it in items %}
                                    <option value="{{ it.id }}"
                                        data-unit="{{ it.unit_of_measure }}"
                                        data-price="{{ it.mrp }}"
                                        data-section="{{ it.section|default:'GENERAL' }}">
                                        {{ it.name }}{% if it.section %} - {{ it.section }}{% endif %}
                                    </option>
                                {% endfor %}
                            </template>

                            <div class="table-container">
                                <table id="requirements-table">
                                    <thead>
                                        <tr>
                                            <th width="5%">Sl.No</th>
                                            <th width="25%">Section</th>
                                            <th width="35%">Item Name</th>
                                            <th width="10%">Unit</th>
                                            <th width="15%">Price</th>
                                            <th width="10%">Qty</th>
                                            <th width="15%">Total</th>
                                            <th width="10%">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="table-body">
                                        <!-- Rows will be added dynamically -->
                                    </tbody>
                                    <tfoot>
                                        <tr class="total-row">
                                            <td colspan="6" style="text-align: right; font-weight:700;">Grand Total:</td>
                                            <td id="grand-total" style="font-weight:700;">0.00</td>
                                            <td></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>

                            <!-- Form Actions -->
                            <div class="btn-group">
                                <button type="submit" class="submit-btn" id="submitRequirementsBtn">
                                    <i class="fas fa-save"></i> Update Requirements
                                </button>
                                <button class="btn-refresh" onclick="window.location.href='{% url 'app5:lead_report' %}'">
                                    <i class="fas fa-sync-alt"></i> Back to Reports
                                </button>
                            </div>
                        </form>
                    </div>
                    <!-- ===== end Requirements Section ===== -->
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // =====================================================
    // ENHANCED DIRECTORY FUNCTIONALITY
    // =====================================================
    function setupDirectory() {
        // Tab switching
        const tabs = document.querySelectorAll('.directory-tab');
        const leadList = document.getElementById('leadList');
        const employeeList = document.getElementById('employeeList');
        
        tabs.forEach(tab => {
            tab.addEventListener('click', function() {
                const tabName = this.getAttribute('data-tab');
                
                // Update active tab
                tabs.forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                
                // Show/hide lists
                if (tabName === 'leads') {
                    leadList.classList.add('active');
                    employeeList.classList.remove('active');
                    document.getElementById('leadFilters').style.display = 'block';
                } else {
                    leadList.classList.remove('active');
                    employeeList.classList.add('active');
                    document.getElementById('leadFilters').style.display = 'none';
                }
            });
        });
        
        // Search and filter functionality
        const searchInput = document.getElementById('directorySearch');
        const priorityFilter = document.getElementById('priorityFilter');
        const statusFilter = document.getElementById('statusFilter');
        
        function filterLeads() {
            const searchTerm = searchInput.value.toLowerCase();
            const priorityValue = priorityFilter.value;
            const statusValue = statusFilter.value;
            
            const leadItems = document.querySelectorAll('#leadList .lead-item');
            
            leadItems.forEach(item => {
                const name = item.getAttribute('data-name').toLowerCase();
                const phone = item.getAttribute('data-phone').toLowerCase();
                const ticket = item.getAttribute('data-ticket').toLowerCase();
                const priority = item.getAttribute('data-priority');
                const status = item.getAttribute('data-status');
                
                // Combine search fields
                const matchesSearch = !searchTerm || 
                                     name.includes(searchTerm) || 
                                     phone.includes(searchTerm) || 
                                     ticket.includes(searchTerm);
                
                // Match priority (if not "all")
                const matchesPriority = priorityValue === 'all' || priority === priorityValue;
                
                // Match status (if not "all")
                const matchesStatus = statusValue === 'all' || status === statusValue;
                
                // Show/hide based on all filters
                if (matchesSearch && matchesPriority && matchesStatus) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }
        
        if (searchInput) searchInput.addEventListener('input', filterLeads);
        if (priorityFilter) priorityFilter.addEventListener('change', filterLeads);
        if (statusFilter) statusFilter.addEventListener('change', filterLeads);
        
        // Initialize highlighting for current lead
        highlightCurrentLead();
    }
    
    // =====================================================
    // HIGHLIGHT CURRENT LEAD ONLY
    // =====================================================
    function highlightCurrentLead() {
        const currentLeadId = {{ current_lead_id|default:0 }};
        
        // Remove current-lead-item class from all leads
        document.querySelectorAll('.lead-item').forEach(item => {
            item.classList.remove('current-lead-item');
        });
        
        // Add current-lead-item class only to current lead
        if (currentLeadId) {
            const currentLeadItem = document.querySelector(`.lead-item[data-id="${currentLeadId}"]`);
            if (currentLeadItem) {
                currentLeadItem.classList.add('current-lead-item');
                
                // Scroll current lead into view
                setTimeout(() => {
                    currentLeadItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 500);
            }
        }
    }
    
    // =====================================================
    // REDIRECT FUNCTION
    // =====================================================
    function redirectToLeadPage(leadId, event) {
    if (event) {
        event.stopPropagation();
        event.preventDefault();
    }
    
    if (!leadId) {
        console.error('Lead ID not found!');
        return;
    }
    
    // Save lead to localStorage BEFORE redirecting
    saveSelectedLeadToStorage(leadId);
    
    // Check if we're already on this lead's edit page
    const currentLeadId = {{ current_lead_id|default:0 }};
    if (leadId == currentLeadId) {
        highlightCurrentLead();
        return;
    }
    
    // Construct the edit URL
    const editUrl = `{% url 'app5:edit_requirement' 0 %}`.replace('0', leadId);
    
    // Show confirmation if there are unsaved changes
    if (hasUnsavedChanges()) {
        if (confirm('You have unsaved changes. Are you sure you want to navigate away?')) {
            window.location.href = editUrl;
        }
    } else {
        window.location.href = editUrl;
    }
}


// Add this to both pages (requirement_edit.html and quotation_form.html)
function enhanceNavigationLinks() {
    // Get current selected lead ID
    const selectedLeadId = getSelectedLeadId();
    if (!selectedLeadId) return;
    
    // Update all relevant navigation links
    document.querySelectorAll('a[href*="quotation"], a[href*="requirement"], a[href*="event"]').forEach(link => {
        const href = link.getAttribute('href');
        if (href && !href.includes('#') && !href.includes('lead_id=')) {
            const separator = href.includes('?') ? '&' : '?';
            link.setAttribute('href', `${href}${separator}lead_id=${selectedLeadId}`);
        }
    });
}

function getSelectedLeadId() {
    // First check if there's a current lead item
    const currentLeadItem = document.querySelector('.lead-item.current-lead-item');
    if (currentLeadItem) {
        return currentLeadItem.getAttribute('data-id');
    }
    
    // Then check localStorage
    try {
        return localStorage.getItem('selectedLeadId');
    } catch (error) {
        console.error('Error getting lead ID from storage:', error);
        return null;
    }
}

// Call this function after page loads
document.addEventListener('DOMContentLoaded', function() {
    // ... existing initialization code ...
    
    // Enhance navigation links
    enhanceNavigationLinks();
    
    // Also update links when a new lead is selected
    document.querySelectorAll('.lead-item').forEach(item => {
        item.addEventListener('click', function() {
            setTimeout(enhanceNavigationLinks, 100);
        });
    });
});
    
    // =====================================================
    // CHECK FOR UNSAVED CHANGES
    // =====================================================
    function hasUnsavedChanges() {
        // Check if any requirement values have been modified
        const originalCount = {{ requirements|length|default:0 }};
        const currentCount = document.querySelectorAll('#table-body tr').length;
        
        if (originalCount !== currentCount) {
            return true;
        }
        
        // Check if any values have changed
        let hasChanges = false;
        document.querySelectorAll('#table-body tr').forEach((row, index) => {
            const priceInput = row.querySelector('.item-price');
            const qtyInput = row.querySelector('.item-qty');
            const itemSelect = row.querySelector('.item-select');
            
            // Check if values differ from original
            if (priceInput && qtyInput && itemSelect) {
                // You would need to compare with original values here
                // For now, just check if any values are different from default
                if (priceInput.value !== '' || qtyInput.value !== '1' || itemSelect.value !== '') {
                    hasChanges = true;
                }
            }
        });
        
        return hasChanges;
    }
    
    // =====================================================
    // REQUIREMENTS TABLE FUNCTIONALITY
    // =====================================================
    document.addEventListener('DOMContentLoaded', function() {
        // Setup directory
        setupDirectory();
        
        // Requirements table logic
        const tbody = document.getElementById('table-body');
        const addBtn = document.getElementById('add-item-btn');
        const grandEl = document.getElementById('grand-total');
        const submitBtn = document.getElementById('submitRequirementsBtn');
        
        // Store original data
        let originalRequirements = [];
        let allItemOptions = [];

        // Format number with 2 decimal places
        function formatNumber(n) {
            n = parseFloat(n) || 0;
            return n.toFixed(2);
        }

        // Get all item options from template
        function loadItemOptions() {
            const template = document.getElementById('item-options');
            if (!template) {
                console.error("‚ùå Template #item-options not found!");
                return [];
            }
            
            return Array.from(template.content.querySelectorAll('option'));
        }

        // Create a new row
        function createRow(requirementData = null) {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="sl-no"></td>
                <td>
                    <select name="section[]" class="item-section-select section-select" 
                        style="width:100%; padding:8px; border:1px solid #ddd; border-radius:6px;">
                        <option value="">-- Select Section --</option>
                        <option value="GENERAL">General</option>
                        <option value="HARDWARE">Hardware</option>
                        <option value="SOFTWARE">Software</option>
                        <option value="PAPER_ROLLS">Paper Rolls</option>
                        <option value="OTHER">Other</option>
                    </select>
                </td>
                <td>
                    <select name="item_id[]" class="form-control item-select" required>
                        <option value="">-- Select Section First --</option>
                    </select>
                    <input type="hidden" name="requirement_id[]" value="${requirementData ? requirementData.id || '' : ''}">
                </td>
                <td><input type="text" name="unit[]" class="item-unit" readonly placeholder="Unit"></td>
                <td><input type="number" name="price[]" class="item-price" min="0" step="0.01" placeholder="0.00" required></td>
                <td><input type="number" name="qty[]" class="item-qty" min="1" step="1" value="1" required></td>
                <td class="item-total">0.00</td>
                <td><button type="button" class="delete-row delete-btn"><i class="fas fa-trash"></i></button></td>
            `;
            
            attachRowEvents(tr);
            tbody.appendChild(tr);
            
            // If we have requirement data, pre-fill the row
            if (requirementData) {
                setTimeout(() => {
                    populateRowWithData(tr, requirementData);
                }, 50);
            }
            
            return tr;
        }

        // Populate row with existing data
        function populateRowWithData(row, data) {
            const sectionSelect = row.querySelector('.section-select');
            const itemSelect = row.querySelector('.item-select');
            const unitInput = row.querySelector('.item-unit');
            const priceInput = row.querySelector('.item-price');
            const qtyInput = row.querySelector('.item-qty');
            const requirementIdInput = row.querySelector('input[name="requirement_id[]"]');
            
            // Store requirement ID if it exists
            if (data.id) {
                requirementIdInput.value = data.id;
            }
            
            // Set section
            if (sectionSelect && data.section) {
                sectionSelect.value = data.section.toUpperCase();
                
                // Trigger change to populate items
                setTimeout(() => {
                    sectionSelect.dispatchEvent(new Event('change'));
                    
                    // Wait for items to populate
                    setTimeout(() => {
                        if (itemSelect && data.item_id) {
                            // Find item by ID
                            const itemOption = allItemOptions.find(opt => 
                                parseInt(opt.value) === parseInt(data.item_id)
                            );
                            
                            if (itemOption) {
                                itemSelect.value = itemOption.value;
                                itemSelect.dispatchEvent(new Event('change'));
                                
                                // Override with saved data
                                setTimeout(() => {
                                    if (unitInput && data.unit) {
                                        unitInput.value = data.unit;
                                    }
                                    
                                    if (priceInput && data.price) {
                                        priceInput.value = parseFloat(data.price).toFixed(2);
                                    }
                                    
                                    if (qtyInput && data.quantity) {
                                        qtyInput.value = parseInt(data.quantity) || 1;
                                    }
                                    
                                    // Recalculate row total
                                    recalcRow(row);
                                }, 100);
                            } else {
                                // If item not found, set custom values
                                itemSelect.innerHTML = `<option value="${data.item_id}" selected>${data.item_name || 'Custom Item'}</option>`;
                                
                                if (unitInput && data.unit) {
                                    unitInput.value = data.unit;
                                }
                                
                                if (priceInput && data.price) {
                                    priceInput.value = parseFloat(data.price).toFixed(2);
                                }
                                
                                if (qtyInput && data.quantity) {
                                    qtyInput.value = parseInt(data.quantity) || 1;
                                }
                                
                                recalcRow(row);
                            }
                        }
                    }, 200);
                }, 50);
            }
        }

        // Initialize item dropdown with filtered items
        function initializeItemDropdown(itemSelect, section = null) {
            // Clear dropdown
            itemSelect.innerHTML = `<option value="">-- Select Item --</option>`;
            
            if (section) {
                // Normalize section for comparison
                const targetSection = section.toUpperCase().trim();
                
                // Filter items by section
                const filtered = allItemOptions.filter(opt => {
                    const optSection = (opt.dataset.section || '').toUpperCase().trim();
                    return optSection === targetSection;
                });
                
                if (filtered.length === 0) {
                    itemSelect.innerHTML = `<option value="">-- No items in ${section} section --</option>`;
                    itemSelect.disabled = true;
                    return;
                }
                
                // Add filtered items to dropdown
                filtered.forEach(opt => {
                    const newOption = document.createElement('option');
                    newOption.value = opt.value;
                    newOption.textContent = opt.textContent.trim();
                    newOption.dataset.unit = opt.dataset.unit || '';
                    newOption.dataset.price = opt.dataset.price || '0.00';
                    newOption.dataset.section = opt.dataset.section || '';
                    itemSelect.appendChild(newOption);
                });
                
                itemSelect.disabled = false;
            } else {
                itemSelect.innerHTML = `<option value="">-- Select Section First --</option>`;
                itemSelect.disabled = true;
            }
        }

        // Attach events to row elements
        function attachRowEvents(row) {
            const sectionSelect = row.querySelector('.section-select');
            const itemSelect = row.querySelector('.item-select');
            const unitInput = row.querySelector('.item-unit');
            const priceInput = row.querySelector('.item-price');
            const qtyInput = row.querySelector('.item-qty');
            const deleteBtn = row.querySelector('.delete-row');

            // When SECTION changes ‚Üí filter the items
            sectionSelect.addEventListener('change', function () {
                const sec = this.value.trim();
                
                // Clear item selection and values
                itemSelect.value = "";
                unitInput.value = "";
                priceInput.value = "";
                
                if (sec) {
                    initializeItemDropdown(itemSelect, sec);
                } else {
                    itemSelect.disabled = true;
                    itemSelect.innerHTML = `<option value="">-- Select Section First --</option>`;
                }
                
                recalcRow(row);
            });

            // When ITEM changes ‚Üí autofill (unit, price)
            itemSelect.addEventListener('change', function () {
                const opt = this.selectedOptions[0];

                if (opt && opt.value !== "") {
                    unitInput.value = opt.dataset.unit || "";
                    priceInput.value = parseFloat(opt.dataset.price || 0).toFixed(2);
                } else {
                    unitInput.value = "";
                    priceInput.value = "";
                }

                recalcRow(row);
            });

            // Price / Qty changes
            priceInput.addEventListener('input', () => recalcRow(row));
            qtyInput.addEventListener('input', () => recalcRow(row));

            deleteBtn.addEventListener('click', function () {
                if (confirm('Are you sure you want to delete this item?')) {
                    row.remove();
                    refreshSlNos();
                    recalcGrandTotal();
                    updateRequirementIds();
                }
            });
        }

        // Recalculate row total
        function recalcRow(row) {
            const priceInput = row.querySelector('.item-price');
            const qtyInput = row.querySelector('.item-qty');
            const totalCell = row.querySelector('.item-total');

            const price = parseFloat(priceInput.value || 0);
            const qty = parseInt(qtyInput.value || 0) || 0;
            const total = price * qty;

            totalCell.textContent = formatNumber(total);
            recalcGrandTotal();
        }

        // Recalculate grand total
        function recalcGrandTotal() {
            let grand = 0;
            document.querySelectorAll('#table-body .item-total').forEach(cell => {
                grand += parseFloat(cell.textContent || 0);
            });
            grandEl.textContent = formatNumber(grand);
        }

        // Refresh serial numbers
        function refreshSlNos() {
            document.querySelectorAll('#table-body tr').forEach((row, idx) => {
                const cell = row.querySelector('.sl-no');
                if (cell) cell.textContent = idx + 1;
            });
        }

        // Load existing requirements
        function loadRequirements() {
            // Clear table
            tbody.innerHTML = '';
            
            // Track used item IDs to prevent duplicates
            const usedItemIds = new Set();
            
            {% if requirements %}
                try {
                    const requirementsData = {{ requirements_json|safe }};
                    console.log('Total requirements found:', requirementsData.length);
                    
                    // Filter out duplicates based on item_id
                    const uniqueRequirements = requirementsData.filter((req, index, self) => {
                        if (!req.item_id) return true; // Keep if no item_id
                        const isDuplicate = usedItemIds.has(req.item_id);
                        if (!isDuplicate) {
                            usedItemIds.add(req.item_id);
                        }
                        return !isDuplicate;
                    });
                    
                    console.log('Unique requirements:', uniqueRequirements.length);
                    
                    // Create rows for each unique requirement
                    uniqueRequirements.forEach((req, index) => {
                        if (req && (req.item_id || req.item_name)) {
                            createRow(req);
                        }
                    });
                    
                    // If no valid requirements, create empty row
                    if (uniqueRequirements.length === 0) {
                        createRow();
                    }
                } catch (error) {
                    console.error('Error loading requirements:', error);
                    // Create one empty row as fallback
                    createRow();
                }
            {% else %}
                // Create one empty row if no requirements exist
                createRow();
            {% endif %}
            
            refreshSlNos();
            recalcGrandTotal();
            updateRequirementIds();
        }

        // Update hidden requirement IDs field
        function updateRequirementIds() {
            const requirementIds = [];
            document.querySelectorAll('input[name="requirement_id[]"]').forEach(input => {
                if (input.value) {
                    requirementIds.push(input.value);
                }
            });
            
            document.getElementById('hiddenRequirementIds').value = requirementIds.join(',');
        }

        // Initialize the page
        function initializePage() {
            // Load item options
            allItemOptions = loadItemOptions();
            console.log(`Loaded ${allItemOptions.length} item options`);
            
            // Load existing requirements
            loadRequirements();
            
            // Add new row button
            if (addBtn) {
                addBtn.addEventListener('click', function () {
                    createRow();
                    refreshSlNos();
                    updateRequirementIds();
                });
            }
            
            // Form submission validation
            document.getElementById('requirements-form').addEventListener('submit', function(e) {
                // Validate all rows have items selected
                let allValid = true;
                let hasItems = false;
                
                document.querySelectorAll('.item-select').forEach(select => {
                    if (!select.value && select.closest('tr').style.display !== 'none') {
                        allValid = false;
                        select.style.borderColor = '#ff4444';
                    } else {
                        select.style.borderColor = '';
                        hasItems = true;
                    }
                });

                if (!hasItems) {
                    e.preventDefault();
                    alert('Please add at least one requirement item');
                    return;
                }

                if (!allValid) {
                    e.preventDefault();
                    alert('Please select an item for all rows');
                    return;
                }
                
                // Update requirement IDs before submission
                updateRequirementIds();
                
                // Show loading state
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
                submitBtn.disabled = true;
            });
            
            console.log('Edit page initialized with {{ requirements|length }} existing requirements');
        }

        // Start initialization
        initializePage();
    });
</script>

<script>
// =====================================================
// SIMPLIFIED SMART NAVIGATION
// =====================================================
(function() {
    'use strict';
    
    console.log('üöÄ Initializing Lead Navigation...');
    
    // Highlight current lead on load
    function highlightCurrentLead() {
        const currentLeadId = {{ current_lead_id|default:0 }};
        console.log('Current lead ID:', currentLeadId);
        
        if (currentLeadId) {
            const currentLeadItem = document.querySelector(`.lead-item[data-id="${currentLeadId}"]`);
            if (currentLeadItem) {
                // Remove from all
                document.querySelectorAll('.lead-item').forEach(item => {
                    item.classList.remove('current-lead-item');
                });
                
                // Add to current
                currentLeadItem.classList.add('current-lead-item');
                
                // Scroll into view
                setTimeout(() => {
                    currentLeadItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 300);
                
                console.log('‚úÖ Current lead highlighted:', currentLeadItem.getAttribute('data-name'));
            }
        }
    }
    
    // Enhance lead items with proper navigation
    function enhanceLeadItems() {
        const leadItems = document.querySelectorAll('.lead-item[data-id].clickable');
        
        leadItems.forEach(item => {
            item.addEventListener('click', function(e) {
                // Don't interfere with button clicks
                if (e.target.tagName === 'BUTTON' || e.target.closest('button')) {
                    return;
                }
                
                e.preventDefault();
                e.stopPropagation();
                
                const leadId = this.getAttribute('data-id');
                const currentLeadId = {{ current_lead_id|default:0 }};
                
                // If clicking on current lead, do nothing
                if (parseInt(leadId) === parseInt(currentLeadId)) {
                    return;
                }
                
                // Construct URL
                const editUrl = `{% url 'app5:edit_requirement' 0 %}`.replace('0', leadId);
                
                // Check for unsaved changes
                const hasChanges = false; // Implement your own hasUnsavedChanges() if needed
                
                if (hasChanges) {
                    if (confirm('You have unsaved changes. Navigate away?')) {
                        window.location.href = editUrl;
                    }
                } else {
                    window.location.href = editUrl;
                }
            });
        });
        
        console.log(`‚úÖ Enhanced ${leadItems.length} lead items`);
    }

    // Add this function to requirement_edit.html (inside <script> tags or in a separate script)
function saveSelectedLeadToStorage(leadId) {
    if (!leadId) return;
    
    // Get lead data from the clicked lead item
    const leadItem = document.querySelector(`.lead-item[data-id="${leadId}"]`);
    if (!leadItem) return;
    
    const leadData = {
        id: leadId,
        name: leadItem.getAttribute('data-name') || '',
        phone: leadItem.getAttribute('data-phone') || '',
        ticket: leadItem.getAttribute('data-ticket') || '',
        priority: leadItem.getAttribute('data-priority') || '',
        status: leadItem.getAttribute('data-status') || '',
        requirementsCount: leadItem.getAttribute('data-requirements-count') || '0'
    };
    
    // Save to localStorage
    try {
        localStorage.setItem('selectedLeadData', JSON.stringify(leadData));
        localStorage.setItem('selectedLeadId', leadId);
        localStorage.setItem('selectedLeadTimestamp', Date.now().toString());
        
        console.log('‚úÖ Lead saved to storage:', leadData.name);
        showLeadSavedNotification(leadData.name);
    } catch (error) {
        console.error('‚ùå Error saving lead to storage:', error);
    }
}

// Show notification when lead is saved
function showLeadSavedNotification(leadName) {
    // Create a temporary notification
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 20px;
        background: linear-gradient(135deg, #4CAF50, #45a049);
        color: white;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        z-index: 10000;
        font-weight: 600;
        animation: slideIn 0.3s ease;
    `;
    notification.innerHTML = `<i class="fas fa-check-circle"></i> Selected: ${leadName}`;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.opacity = '0';
        setTimeout(() => notification.remove(), 300);
    }, 2000);
}
    
    // Initialize when DOM is ready
    function init() {
        highlightCurrentLead();
        enhanceLeadItems();
        
        // Add a visual indicator to the page title
        const currentLeadName = "{{ lead_data.ownerName|default:'Lead' }}";
        document.title = `Editing: ${currentLeadName} - Edit Requirements`;
        
        console.log('‚úÖ Lead navigation initialized');
    }
    
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }
})();


</script>

</body>
</html>