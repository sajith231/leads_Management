{% extends "base.html" %}

{% block title %}Lead Report{% endblock %}

{% block content %}
<html>
    <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compact Customer Information Form</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* All your existing CSS styles remain exactly the same */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
    background: #f0f2f5;
    min-height: 100vh;
    margin: 0; /* Remove default margin */
}
        
        .container {
    max-width: 1600px;
    width: 100%;
    margin: 0 auto;
    padding: 20px;
    height: 100vh; /* Make container full viewport height */
}
        
        .main-content {
    display: flex;
    gap: 20px;
    align-items: stretch;
    width: 100%;
    height: calc(100vh - 40px); /* Full viewport height minus container padding */
}

.directory-column {
    flex: 0 0 320px;
    width: 320px;
    display: flex;
    flex-direction: column;
    height: 100%; /* Take full height of parent */
}

.form-column {
    flex: 1;
    min-width: 0;
    display: flex;
    flex-direction: column;
    height: 100%; /* Take full height of parent */
}

.form-container {
    background-color:#dcd9f3;
    border-radius: 10px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
    overflow: hidden;
    width: 100%;
    height: 100%; /* Take full height of parent */
    display: flex;
    flex-direction: column;
}

.lead-directory-container {
    background: white;
    border-radius: 10px;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
    overflow: hidden;
    height: 100%; /* Take full height of parent */
    display: flex;
    flex-direction: column;
}
        
        .form-header {
            background:#a095f6;
            color:black;
            padding: 15px 20px;
            text-align: center;
        }
        
        .form-header h1 {
            font-size: 22px;
            margin-bottom: 5px;
            font-weight: 700;
        }
        
        .form-header p {
            font-size: 13px;
            opacity: 0.9;
        }
        
        .form-body {
    padding: 20px;
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow-y: auto; /* Allow scrolling if content is too long */
}
        
        .form-section {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px dashed #e0e0e0;
        }
        
        #communication-details {
            background-color:#dbf5dd;
            border: 2px solid #0ec33f;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 3px 10px rgba(37, 117, 252, 0.15);
        }
        
        .section-title {
            font-size: 16px;
            color: #14ad09;
            font-weight: bold;
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .section-title i {
            margin-right: 8px;
            font-size: 16px;
        }
        
        .form-row {
            display: flex;
            flex-wrap: wrap;
            margin: 0 -5px;
            width: 100%;
        }

        .status-select {
            width: 100% !important;
            padding: 10px 12px;
            font-size: 14px;
            font-weight: 600;
            border: 2px solid #2575fc;
            border-radius: 8px;
            background: #f9fcff;
            cursor: pointer;
            transition: 0.2s ease-in-out;
        }

        .status-select:focus {
            border-color: #0a57d1;
            background: white;
            box-shadow: 0 0 6px rgba(0, 102, 255, 0.4);
            outline: none;
        }

        .status-select:hover {
            background: #eef6ff;
        }
        
        .form-group {
            flex: 1;
            min-width: 180px;
            padding: 0 5px;
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #444;
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        input, select, textarea {
            width: 100%;
            
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
            transition: all 0.2s;
            background-color: #f9f9f9;
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: #6a11cb;
            box-shadow: 0 0 0 2px rgba(106, 17, 203, 0.1);
            outline: none;
            background-color: white;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            margin-top: 8px;
        }
        
        .checkbox-group input {
            width: auto;
            margin-right: 8px;
        }
        
        .btn-group {
            display: flex;
            justify-content: center;
            margin-top: auto;
            gap: 10px;
            width: 100%;
            padding-top: 20px;
        }
        
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .submit-btn {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            box-shadow: 0 3px 8px rgba(37, 117, 252, 0.3);
        }
        
        .submit-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(37, 117, 252, 0.4);
        }
        
        .submit-btn:disabled {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            opacity: 1;
            cursor: pointer;
        }
        
        .reset-btn {
            background-color:#4CAF50;
            color: #fffdfd;
            border: 1px solid #ddd;
        }
        
        .reset-btn:hover {
            background-color:#4CAF50;
        }

        /* EDIT BUTTON STYLES */
        .edit-btn {
            background: linear-gradient(135deg, #4CAF50, #4CAF50);
            color: white;
           
        }
        
        .edit-btn:hover {
            transform: translateY(-1px);
           
        }
        
        .edit-btn:disabled {
            background: linear-gradient(135deg, #cccccc, #aaaaaa);
            color: #666666;
            cursor: not-allowed;
            box-shadow: none;
        }
        
        .edit-btn:disabled:hover {
            transform: none;
            box-shadow: none;
        }
        
        .single-line-sections {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            width: 100%;
        }
        
        .section-column {
            flex: 1;
            background:#ffe9cc;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
            border: 1px solid #f8861b;
            min-width: 0;
        }
        
        .section-header-compact {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e5bc08;
            width: 100%;
        }
        
        .section-title-compact {
            display: flex;
            align-items: center;
            font-size: 16px;
            color: #d29105;
            font-weight: 700;
            margin: 0;
            white-space: nowrap;
        }
        
        .section-title-compact i {
            margin-right: 10px;
            font-size: 18px;
            color: #d29105;
        }
        
        .header-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: flex-end;
        }
        
        .date-field-compact {
            min-width: 180px;
        }
        
        .date-field-compact label {
            margin-bottom: 5px;
            font-size: 12px;
            color:black;
            font-weight: 600;
        }
        
        .date-field-compact input {
            background: white;
            border: 1px solid black;
            font-weight: 500;
            width: 100%;
            min-width: 150px;
        }

       
        
        .compact-form-group {
            margin-bottom: 12px;
            width: 100%;
            position: relative;
        }
        
        .compact-form-group label {
            font-size: 12px;
            margin-bottom: 4px;
        }
        
        .compact-form-group input, 
        .compact-form-group select {
            padding: 6px 8px;
            font-size: 12px;
            height: 32px;
            width: 100%;
        }
        
        .toggle-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .toggle-label {
            font-size: 13px;
            font-weight: 600;
            color: #444;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
;
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: #4CAF50;
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
        
        .individual-fields {
            display: none;
        }
        
        .business-fields {
            display: block;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            max-width: 400px;
            width: 90%;
            text-align: center;
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-content h3 {
            color: #333;
            margin-bottom: 20px;
        }

        .modal-content p {
            color: #666;
            margin-bottom: 25px;
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 25px;
        }

        .modal-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            flex: 1;
        }

        .self-assign-btn {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
        }

        .self-assign-btn:hover {
            background: linear-gradient(135deg, #45a049, #4CAF50);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .unassign-btn {
            background: linear-gradient(135deg, #6c757d, #5a6268);
            color: white;
        }

        .unassign-btn:hover {
            background: linear-gradient(135deg, #5a6268, #6c757d);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .cancel-btn {
            padding: 10px 20px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: #f8f9fa;
            color: #666;
            cursor: pointer;
            width: 100%;
        }

        .cancel-btn:hover {
            background: #e9ecef;
            border-color: #adb5bd;
        }
        
            .lead-directory-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            height: 100%;
            max-height: calc(100vh - 40px);
            display: flex;
            flex-direction: column;
        }
        
        /* UPDATED DIRECTORY HEADER - Left/Right Alignment */
        .directory-header {
            background: #4a6fdc;
            color: white;
            padding: 12px 15px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        
        .directory-left {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            text-align: left;
        }
        
        .directory-left h2 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .directory-date {
            font-size: 13px;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .directory-date i {
            font-size: 12px;
        }
        
        .directory-right {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            text-align: right;
        }
        
        .directory-info-row {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 4px;
        }
        
        .directory-count {
            font-size: 13px;
            font-weight: 500;
            opacity: 0.9;
        }
        
        .directory-today {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .directory-today i {
            font-size: 11px;
        }
        
        .directory-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }
        
        .directory-tab {
            flex: 1;
            padding: 10px 12px;
            text-align: center;
            background: transparent;
            border: none;
            font-weight: 600;
            font-size: 13px;
            color: #6c757d;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }
        
        .directory-tab.active {
            color: #4a6fdc;
            border-bottom-color: #4a6fdc;
            background: white;
        }
        
        .directory-tab:hover {
            background: #e9ecef;
        }
        
        /* UPDATED SEARCH AND FILTER CONTAINER - Left/Right Layout */
        .directory-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            gap: 10px;
        }
        
        .directory-search-container {
            flex: 1;
            min-width: 0;
        }
        
        .search-box {
            position: relative;
            width: 100%;
        }
        
        .search-box input {
            padding: 8px 12px 8px 35px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 13px;
            width: 100%;
            background: white;
        }
        
        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
            font-size: 13px;
        }
        
        .directory-filter-container {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
        }
        
        .filter-label {
            font-size: 13px;
            font-weight: 600;
            color: #495057;
            white-space: nowrap;
        }
        
        .filter-select {
            padding: 6px 8px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 13px;
            background: white;
            cursor: pointer;
            min-width: 120px;
        }
        
       .employee-list, .lead-list {
    flex: 1;
    overflow-y: auto;
    padding: 8px 0;
    display: none;
}
        .employee-list.active, .lead-list.active {
            display: block;
        }
        
        .employee-item, .lead-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.2s;
            cursor: pointer;
        }

        .lead-item.selected {
            background: #e3f2fd;
            border-left: 4px solid #2575fc;
        }
        
        .employee-item:hover, .lead-item:hover {
            background: #f8f9fa;
        }
        
        .employee-avatar, .lead-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #4a6fdc;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 12px;
            margin-right: 12px;
            flex-shrink: 0;
        }
        
        .lead-avatar {
            background: #28a745;
        }
        
        .employee-details, .lead-details {
            flex: 1;
            min-width: 0;
        }
        
        .employee-name, .lead-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 2px;
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .employee-role, .lead-info {
            font-size: 12px;
            color: #6c757d;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .lead-phone {
            font-size: 11px;
            color: #495057;
            margin-top: 1px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .lead-ticket {
            font-size: 10px;
            color: #6c757d;
            background: #f8f9fa;
           
            border-radius: 4px;
            display: inline-block;
            margin-top: 2px;
        }
        
        .lead-status {
            font-size: 10px;
            color: #28a745;
            font-weight: 600;
            margin-top: 2px;
        }
        
        .assign-btn {
            padding: 5px 10px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        
        .assign-btn:hover {
            background: #45a049;
        }
        
        .assign-btn.assigned {
            background: #6c757d;
        }
        
        .no-results {
            padding: 20px 15px;
            text-align: center;
            color: #6c757d;
            font-size: 13px;
        }
        
        /* Status in Communication Details */
        .status-inline {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-left: auto;
        }
        
        .status-inline label {
            margin-bottom: 0;
            font-size: 13px;
            color: #333;
            white-space: nowrap;
        }
        
        .status-inline select {
            width: 150px;
            padding: 6px 8px;
            font-size: 13px;
            height: 32px;
        }

        .loading-spinner {
            display: none;
            text-align: center;
            padding: 10px;
            color: #2575fc;
        }

        .loading-spinner i {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Pagination Styles */
        .directory-pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 12px 15px;
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
            gap: 10px;
        }
        
        .pagination-info {
            font-size: 12px;
            color: #6c757d;
            margin: 0 10px;
        }
        
        .pagination-btn {
            padding: 6px 12px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            color: #4a6fdc;
        }
        
        .pagination-btn:hover:not(:disabled) {
            background: #4a6fdc;
            color: white;
            border-color: #4a6fdc;
        }
        
        .pagination-btn:disabled {
            background: #f8f9fa;
            color: #6c757d;
            cursor: not-allowed;
        }
        
        .pagination-numbers {
            display: flex;
            gap: 5px;
        }
        
        .page-number {
            padding: 6px 10px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            color: #495057;
        }
        
        .page-number.active {
            background: #4a6fdc;
            color: white;
            border-color: #4a6fdc;
        }
        
        .page-number:hover:not(.active) {
            background: #e9ecef;
        }

        .clear-btn {
            background-color: #4CAF50;
            color: white;
            border: 1px solid #ddd;
        }
        
        .clear-btn:hover {
            background-color: #4CAF50;
        }
        
        /* Searchable Select Styles */
        .select-search-container {
            position: relative;
            width: 100%;
        }
        
        .select-search-input {
            padding: 8px 35px 8px 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
            width: 100%;
            background-color: #f9f9f9;
            cursor: pointer;
            height: 32px;
        }
        
        .select-search-input:focus {
            border-color: #6a11cb;
            box-shadow: 0 0 0 2px rgba(106, 17, 203, 0.1);
            outline: none;
            background-color: white;
        }
        
        .select-search-input.active {
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
            border-bottom-color: #eee;
        }
        
        .select-options {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #6a11cb;
            border-top: none;
            border-radius: 0 0 6px 6px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            display: none;
        }
        
        .select-options.active {
            display: block;
        }
        
        .select-option {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            font-size: 13px;
            transition: background-color 0.2s;
        }
        
        .select-option:hover {
            background-color: #f5f5f5;
        }
        
        .select-option.selected {
            background-color: #e3f2fd;
            color: #1976d2;
            font-weight: 600;
        }
        
        .select-search-icon {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
            pointer-events: none;
        }
        
        .select-clear-icon {
            position: absolute;
            right: 30px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
            cursor: pointer;
            font-size: 12px;
            display: none;
        }
        
        .select-clear-icon:hover {
            color: #666;
        }
        
        .select-clear-icon.active {
            display: block;
        }
        
        .no-results-option {
            padding: 8px 12px;
            color: #999;
            font-style: italic;
            font-size: 13px;
            text-align: center;
        }
        
        /* Enhanced Lead Date Display Styles */
        .lead-date-full {
            font-size: 10px;
            color: #6c757d;
            background: #f8f9fa;
            padding: 2px 8px;
            border-radius: 10px;
            white-space: nowrap;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            margin-left: 5px;
            font-weight: 500;
        }
        
        .lead-date-full i {
            font-size: 9px;
            color: #6c757d;
        }
        
        .lead-date-compact {
            font-size: 10px;
            color: #6c757d;
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 3px;
            margin-left: auto;
            font-weight: 500;
        }
        
        .lead-datetime {
            font-size: 9px;
            color: #888;
            margin-top: 1px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .lead-datetime i {
            font-size: 8px;
        }
        
        .lead-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            width: 100%;
            margin-bottom: 8px;
        }
        
        .lead-name-container {
            display: flex;
            align-items: center;
            gap: 5px;
            flex: 1;
            min-width: 0;
        }
        
        .lead-priority-indicator {
            font-size: 12px;
            margin-right: 3px;
        }
        
        .lead-info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 3px;
            width: 100%;
        }
        
        /* ========== DATE AND TIME ELAPSED LAYOUT ========== */

        .date-time-container {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 3px;
            min-width: 80px;
        }

        /* Time elapsed badge - placed below the date */
        .time-elapsed-badge {
            font-size: 9px !important;
            font-weight: 600 !important;
            padding: 2px 6px !important;
            border-radius: 10px !important;
            display: inline-flex !important;
            align-items: center !important;
            gap: 4px !important;
            background: rgba(0, 0, 0, 0.05) !important;
            color: #666 !important;
            white-space: nowrap !important;
        }

        .time-elapsed-badge.time-recent {
            background: rgba(34, 197, 94, 0.15) !important;
            color: #16a34a !important;
        }

        .time-elapsed-badge.time-medium {
            background: rgba(245, 158, 11, 0.15) !important;
            color: #d97706 !important;
        }

        .time-elapsed-badge.time-old {
            background: rgba(239, 68, 68, 0.15) !important;
            color: #dc2626 !important;
        }
        
        /* Campaign tooltip */
        .lead-campaign {
            position: relative;
            cursor: help;
            font-size: 11px;
            color: #666;
            margin-top: 2px;
            display: flex;
            align-items: center;
            gap: 3px;
            font-style: italic;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .lead-campaign:hover::after {
            content: attr(title);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 1000;
            margin-bottom: 5px;
            max-width: 300px;
            word-wrap: break-word;
        }
        
        .lead-campaign:hover::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: #333;
            margin-bottom: -5px;
            z-index: 1000;
        }
        
        /* Campaign dropdown badge */
        .campaign-badge {
            display: inline-block;
            
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            margin-left: 5px;
            font-weight: 600;
        }
        
        /* Campaign Details Styles */
        .campaign-details-section {
            animation: slideDown 0.3s ease-out;
            margin-top: 10px;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .campaign-detail-item {
            padding: 8px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e8e8e8;
        }

        .campaign-detail-item span {
            word-break: break-word;
        }

        /* Status Badges for Campaigns */
        .status-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-active {
            background: #e8f5e9;
            color: #4caf50;
        }

        .status-draft {
            background: #e3f2fd;
            color: #2196f3;
        }

        .status-completed {
            background: #f3e5f5;
            color: #9c27b0;
        }

        .campaign-stats-summary {
            margin-top: 5px;
            font-size: 11px;
            color: #666;
        }

        .campaign-stats-summary span {
            margin-right: 10px;
        }

        .campaign-stats-summary i {
            margin-right: 3px;
        }
        
        /* Campaign details mobile */
        .campaign-details-section {
            animation: slideDown 0.3s ease-out;
            margin-top: 10px;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .campaign-detail-item {
            padding: 8px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e8e8e8;
        }

        .campaign-detail-item span {
            word-break: break-word;
        }

        /* Status Badges */
        .status-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-active {
            background: #e8f5e9;
            color: #4caf50;
        }

        .status-draft {
            background: #e3f2fd;
            color: #2196f3;
        }

        .status-completed {
            background: #f3e5f5;
            color: #9c27b0;
        }

        .campaign-stats-summary {
            margin-top: 5px;
            font-size: 11px;
            color: #666;
        }

        .campaign-stats-summary span {
            margin-right: 10px;
        }

        .campaign-stats-summary i {
            margin-right: 3px;
        }

        /* Style for new firm option */
        .select-option.new-firm {
            color: #4CAF50;
            font-weight: 600;
            background-color: rgba(76, 175, 80, 0.1);
            border-left: 3px solid #4CAF50;
        }

        .select-option.new-firm:hover {
            background-color: rgba(76, 175, 80, 0.2);
        }

        .select-option.new-firm::before {
            content: "✚ ";
            font-weight: bold;
            margin-right: 5px;
        }

        /* API Customer Tooltip Styles */
        .api-customer-tooltip {
            position: absolute;
            background: white;
            border: 1px solid #4a6fdc;
            border-radius: 6px;
            padding: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10000;
            max-width: 300px;
            font-size: 12px;
            pointer-events: none;
        }

        /* API indicator in dropdown */
        .select-option .campaign-badge {
           
            color: white;
            font-size: 10px;
            padding: 1px 6px;
            border-radius: 3px;
            margin-left: 8px;
        }

        /* Firm source badge */
        #firmSourceBadge {
            margin-left: 5px;
            font-size: 10px;
            padding: 2px 6px;
            
            color: white;
            border-radius: 3px;
            vertical-align: middle;
        }

        /* API data source indicator */
        .api-source-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: #f0f7ff;
            border: 1px solid #4a6fdc;
            border-radius: 4px;
            padding: 2px 6px;
            font-size: 10px;
            color: #4a6fdc;
            margin-left: 5px;
        }

        /* Hover effects for API options */
        .select-option[data-is-api="true"]:hover {
            background: #f0f7ff;
            border-left: 3px solid #4a6fdc;
        }

        /* API customer details section */
        #apiCustomerDetails {
            border: 1px solid #4a6fdc;
            background: #f8faff;
        }

        #apiCustomerDetails strong {
            color: #4a6fdc;
        }

        /* First letter search styles */
       

        /* ========================================
   SELECTED LEAD HIGHLIGHTING
   ======================================== */
.lead-item.selected {
    background: linear-gradient(135deg, #e3f2fd, #bbdefb) !important;
    border-left: 5px solid #2575fc !important;
    transform: translateX(5px);
    box-shadow: 0 4px 15px rgba(37, 117, 252, 0.3) !important;
    transition: all 0.3s ease;
}

.lead-item.selected .lead-name {
    color: #1565c0;
    font-weight: 700;
}

.lead-item.selected .lead-avatar {
    background: linear-gradient(135deg, #2575fc, #6a11cb);
    color: white;
    font-weight: bold;
}

.lead-item.selected::before {
    content: "✓";
    position: absolute;
    right: 10px;
    top: 10px;
    background: #4CAF50;
    color: white;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 14px;
}

        /* ========================================
   REQUIREMENTS SECTION STYLES
   ======================================== */
.requirements-section {
    background: #fff5e6;
    border-radius: 10px;
    padding: 20px;
    margin-top: 20px;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
    border: 1px solid #ffcc80;
}

.section-info-badge {
    background: #ff9800;
    color: white;
    padding: 2px 10px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
    margin-left: 10px;
}

.add-btn {
    background: linear-gradient(135deg, #4CAF50, #45a049);
    color: white;
    border: none;
    padding: 8px 15px;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 5px;
    transition: all 0.2s;
}

.add-btn:hover {
    background: linear-gradient(135deg, #45a049, #4CAF50);
    transform: translateY(-1px);
    box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
}

.table-container {
    overflow-x: auto;
    background: white;
    border-radius: 8px;
    border: 1px solid #eee;
    margin-top: 15px;
}

#requirements-table {
    table-layout: fixed;   /* Forces equal, stable column sizing */
    width: 100%;
}

#requirements-table th {
    background: #f5f5f5;
    padding: 12px 10px;
    text-align: left;
    font-size: 13px;
    font-weight: 600;
    color: #333;
    border-bottom: 2px solid #ddd;
}

#requirements-table td {
    padding: 10px;
    border-bottom: 1px solid #eee;
    font-size: 13px;
}

#requirements-table tbody tr:hover {
    background: #f9f9f9;
}



#requirements-table input,
#requirements-table select {
    width: 100%;
    min-width: 0;
    box-sizing: border-box;
    padding: 6px 6px;
    font-size: 13px;
    text-align: left;
}



#requirements-table th.section-col,
#requirements-table td.section-col { width: 18%; }

#requirements-table th.item-col,
#requirements-table td.item-col { width: 28%; }

#requirements-table th.price-col,
#requirements-table td.price-col { width: 10%; }

#requirements-table th.qty-col,
#requirements-table td.qty-col { width: 8%; }

#requirements-table th.unit-col,
#requirements-table td.unit-col { width: 10%; }

#requirements-table th.total-col,
#requirements-table td.total-col { width: 12%; }

#requirements-table th.action-col,
#requirements-table td.action-col { width: 6%; }

/* Numbers aligned nicely */
.price-cell input,
.total-cell input,
.qty-cell input {
    text-align: right;     /* ✅ Right aligned */
    padding-right: 8px;   /* Optional: nice spacing */
}


#requirements-table select:focus,
#requirements-table input:focus {
    outline: none;
    border-color: #4CAF50;
    box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.1);
}

#requirements-table .price-cell,
#requirements-table .total-cell {
    font-family: monospace;
    text-align: right;
    font-weight: 600;
}

.remove-btn {
    background: #ff4444;
    color: white;
    border: none;
    padding: 5px 10px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 30px;
    height: 30px;
}

.remove-btn:hover {
    background: #cc0000;
}

.total-row {
    background: #f8f9fa !important;
    border-top: 2px solid #ddd;
}

#grand-total {
    color: #4CAF50;
    font-size: 15px;
}

        /* Requirements Badge Styles */
        .lead-requirements-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            background: linear-gradient(135deg, #ff9800, #f57c00);
            color: white;
            padding: 4px 10px;
            border-radius: 14px;
            font-size: 11px;
            font-weight: 700;
            margin-top: 6px;
            box-shadow: 0 2px 6px rgba(255, 152, 0, 0.4);
            transition: all 0.2s ease;
        }
        
        .lead-requirements-badge:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 152, 0, 0.6);
        }
        
        .lead-requirements-badge i {
            font-size: 10px;
        }
        
        .lead-requirements-badge.has-requirements {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            box-shadow: 0 2px 6px rgba(76, 175, 80, 0.4);
        }

        .lead-requirements-badge.has-requirements:hover {
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.6);
        }
        
        .lead-requirements-badge.no-requirements {
            background: linear-gradient(135deg, #9e9e9e, #757575);
            opacity: 0.5;
            cursor: default;
        }
        
        .lead-requirements-badge.no-requirements:hover {
            transform: none;
            box-shadow: 0 2px 6px rgba(158, 158, 158, 0.3);
        }
        
        /* Requirement details tooltip */
        .requirements-tooltip {
            position: absolute;
            bottom: 100%;
            left: 0;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            min-width: 200px;
            display: none;
            margin-bottom: 5px;
        }
        
        .lead-requirements-badge:hover .requirements-tooltip {
            display: block;
        }
        
        .requirements-tooltip-item {
            font-size: 11px;
            color: #333;
            padding: 3px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .requirements-tooltip-item:last-child {
            border-bottom: none;
        }
        
        /* Enhanced lead item for requirements */
        .lead-item.has-requirements {
            border-left: 3px solid #4CAF50;
        }
        
        /* Requirements count in header */
        .directory-requirements-count {
            font-size: 11px;
            color: #666;
            margin-left: 10px;
            padding: 2px 6px;
            background: #f0f0f0;
            border-radius: 10px;
        }

        /* Notification Styles */
        .custom-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            animation: slideIn 0.3s ease-out;
        }
        .notification-content {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 20px;
            border-radius: 8px;
            background: #4CAF50;
            color: white;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .notification-error {
            background: #f44336;
        }
        .notification-warning {
            background: #ff9800;
        }
        .notification-info {
            background: #2196F3;
        }
        .notification-close {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 0;
            margin-left: 10px;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @media (max-width: 1200px) {
            .single-line-sections {
                flex-direction: column;
            }
            
            .section-column {
                width: 100%;
            }
            
            .main-content {
                flex-direction: column;
            }
            
            .directory-column {
                flex: 0 0 auto;
                width: 100%;
            }
            
            .lead-directory-container {
                height: auto;
                max-height: 400px;
            }
        }
        
        @media (max-width: 992px) {
            .nav-menu {
                flex-wrap: wrap;
            }
            
            .nav-item {
                flex: 1 0 33.333%;
                margin-bottom: 5px;
            }
            
            .header-controls {
                justify-content: space-between;
                width: 100%;
            }
            
            .directory-pagination {
                flex-wrap: wrap;
                gap: 8px;
            }
            
            .pagination-numbers {
                order: 3;
                width: 100%;
                justify-content: center;
                margin-top: 8px;
            }
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .form-group {
                flex: 1 0 50%;
            }
            
            .form-body {
                padding: 15px;
            }
            
            .btn-group {
                flex-direction: column;
            }
            
            button {
                width: 100%;
            }
            
            .section-header-compact {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .header-controls {
                width: 100%;
                justify-content: space-between;
            }
            
            .date-field-compact {
                width: 100%;
                min-width: auto;
            }
            
            .date-field-compact input {
                width: 100%;
            }
            
            .nav-item {
                flex: 1 0 50%;
            }

            .modal-buttons {
                flex-direction: column;
            }
            
            .directory-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .directory-left, .directory-right {
                width: 100%;
                align-items: flex-start;
                text-align: left;
            }
            
            .directory-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .directory-search-container {
                width: 100%;
            }
            
            .directory-filter-container {
                width: 100%;
                justify-content: space-between;
            }
            
            .employee-item, .lead-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .assign-btn {
                align-self: flex-end;
            }
            
            /* Status in Communication Details - Mobile */
            .status-inline {
                margin-top: 10px;
                margin-left: 0;
                width: 100%;
                justify-content: space-between;
            }
            
            .status-inline select {
                width: 120px;
            }
            
            /* Lead details mobile adjustments */
            .lead-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
            
            .lead-date-full {
                align-self: flex-start;
                margin-left: 0;
                margin-top: 5px;
            }
            
            .lead-date-compact {
                margin-left: 0;
                margin-top: 5px;
            }
            
            /* Date time container mobile */
            .date-time-container {
                align-items: flex-start;
                margin-top: 5px;
            }
            
            /* Campaign tooltip mobile */
            .lead-campaign:hover::after {
                font-size: 11px;
                padding: 6px 8px;
                max-width: 250px;
            }

            /* Campaign details mobile */
            .campaign-details-section {
                padding: 10px;
            }
            
            /* Time elapsed mobile */
            .time-elapsed-badge {
                font-size: 8px;
                padding: 2px 4px;
            }
        }
        
        @media (max-width: 576px) {
            body {
                padding: 10px;
            }
            
            .form-header {
                padding: 12px 15px;
            }
            
            .form-header h1 {
                font-size: 20px;
            }
            
            .form-group {
                flex: 1 0 100%;
            }
            
            .header-controls {
                flex-direction: column;
                gap: 10px;
                width: 100%;
            }
            
            .date-field-compact {
                width: 100%;
            }
            
            .nav-item {
                flex: 1 0 100%;
            }
            
            .nav-link {
                padding: 15px;
                font-size: 15px;
            }
            
            .toggle-container {
                justify-content: center;
                width: 100%;
            }
            
            /* Status in Communication Details - Small Mobile */
            .status-inline {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
            
            .status-inline select {
                width: 100%;
            }
            
            .directory-pagination {
                flex-direction: column;
                gap: 8px;
            }
            
            .pagination-numbers {
                order: 0;
                width: 100%;
                justify-content: center;
            }
            
            .pagination-info {
                order: 1;
            }
            
            .pagination-buttons {
                order: 2;
                display: flex;
                gap: 8px;
            }
            
            /* Campaign tooltip small mobile */
            .lead-campaign:hover::after {
                font-size: 10px;
                padding: 4px 6px;
                max-width: 200px;
            }

            /* Campaign details small mobile */
            .campaign-stats-summary {
                display: flex;
                flex-direction: column;
                gap: 5px;
            }
            
            /* Time elapsed small mobile */
            .time-elapsed-badge {
                font-size: 8px;
                padding: 2px 4px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-content">
            <!-- Left Column - Lead Directory -->
            <!-- Left Column - Lead Directory -->
<div class="directory-column">
    <div class="lead-directory-container">
        <!-- UPDATED DIRECTORY HEADER - Left/Right Alignment -->
        <div class="directory-header">
            <div class="directory-left">
                <h2>Lead Management</h2>
                <div class="directory-date" id="currentDate">
                    <i class="far fa-calendar-alt"></i>
                    Loading date...
                </div>
            </div>
            <div class="directory-right">
                <div class="directory-info-row">
                    <div class="directory-count">Leads: <span id="activeTabCount">{{ active_leads_data|length }}</span></div>
                    <div class="directory-today" id="todayDate">
                        <i class="far fa-clock"></i>
                        Loading time...
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Directory Tabs -->
        
        
        <!-- UPDATED SEARCH AND FILTER - Combined in one row -->
        <div class="directory-controls">
            <div class="directory-search-container">
                <div class="search-box">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" id="directorySearch" placeholder="Search leads...">
                </div>
            </div>
            <div class="directory-filter-container">
                <span class="filter-label">Priority:</span>
                <select id="priorityFilter" class="filter-select">
                    <option value="all">All</option>
                    <option value="High">🔴 High</option>
                    <option value="Medium">🟡 Medium</option>
                    <option value="Low">🟢 Low</option>
                </select>
            </div>
        </div>
        
        <!-- Lead List (shown by default) -->
        <div class="lead-list active" id="leadList">
            {% if active_leads_data %}
                {% for lead in active_leads_data %}
                <div class="lead-item" 
                     data-id="{{ lead.id }}"
                     data-index="{{ forloop.counter0 }}"
                     data-owner="{{ lead.ownerName|escapejs }}"
                     data-phone="{{ lead.phoneNo|escapejs }}"
                     data-email="{{ lead.email|escapejs }}"
                     data-status="{{ lead.status|escapejs }}"
                     data-priority="{{ lead.priority|default:'Medium'|escapejs }}"
                     data-customertype="{{ lead.customerType|default:'Business'|escapejs }}"
                     data-name="{{ lead.name|escapejs }}"
                     data-address="{{ lead.address|escapejs }}"
                     data-place="{{ lead.place|escapejs }}"
                     data-district="{{ lead.District|escapejs }}"
                     data-state="{{ lead.State|escapejs }}"
                     data-pincode="{{ lead.pinCode|escapejs }}"
                     data-firstname="{{ lead.firstName|escapejs }}"
                     data-individualaddress="{{ lead.individualAddress|escapejs }}"
                     data-individualplace="{{ lead.individualPlace|escapejs }}"
                     data-individualdistrict="{{ lead.individualDistrict|escapejs }}"
                     data-individualstate="{{ lead.individualState|escapejs }}"
                     data-individualpincode="{{ lead.individualPinCode|escapejs }}"
                     data-reffrom="{{ lead.refFrom|escapejs }}"
                     data-business="{{ lead.business|escapejs }}"
                     data-campaign="{{ lead.campaign|default:''|escapejs }}"
                     data-campaign-display="{{ lead.campaign_display|default:''|escapejs }}"
                     data-marketedby="{{ lead.marketedBy|escapejs }}"
                     data-marketedby-name="{{ lead.marketed_by_name|default:lead.marketedBy|escapejs }}"
                     data-consultant="{{ lead.Consultant|escapejs }}"
                     data-branch="{{ lead.requirement|escapejs }}"
                     data-branch-name="{{ lead.branch_name|default:lead.requirement|escapejs }}"
                     data-details="{{ lead.details|escapejs }}"
                     data-date="{{ lead.date|date:'Y-m-d'|escapejs }}"
                     data-requirements-count="{{ lead.requirements_count|default:0 }}"
                     data-requirements="{{ lead.requirements_json|default:'[]'|escapejs }}">
                    <div class="lead-avatar">
                        {{ lead.ownerName|default:""|slice:":2"|upper }}
                    </div>

                    <div class="lead-details">
                        <div class="lead-header">
                            <div class="lead-name-container">
                                <span class="lead-priority-indicator">
                                    {% if lead.priority == "High" %}🔴
                                    {% elif lead.priority == "Medium" %}🟡
                                    {% elif lead.priority == "Low" %}🟢
                                    {% else %}⚪{% endif %}
                                </span>
                                <span class="lead-name">{{ lead.ownerName }}</span>
                            </div>
                            
                            <!-- DATE AND TIME ELAPSED CONTAINER -->
                            <div class="date-time-container">
                                {% if lead.created_at %}
                                <div class="lead-date-compact" title="Created: {{ lead.created_at|date:'l, d F Y' }}">
                                    <i class="far fa-calendar-alt"></i>
                                    {{ lead.created_at|date:"d M" }}
                                </div>
                                {% endif %}
                                
                                <!-- TIME ELAPSED BADGE - Place it right below the date -->
                                <div class="time-elapsed-badge" 
                                     data-created="{{ lead.created_at|date:'c'|default:lead.date|date:'c' }}">
                                    <i class="fas fa-clock"></i>
                                    <span class="elapsed-text">{{ lead.time_elapsed|default:"Calculating..." }}</span>
                                </div>
                            </div>
                        </div>

                        <div class="lead-phone">{{ lead.phoneNo }}</div>
                        <div class="lead-ticket">{{ lead.ticket_number }}</div>
                        {% if lead.created_at %}
                        <div class="lead-datetime">
                            <i class="far fa-clock"></i>
                            Created at {{ lead.created_at|time:"H:i" }}
                        </div>
                        {% endif %}
                        <div class="lead-info-row">
                            <div class="lead-status">Status: {{ lead.status }}</div>
                            <span style="color: {% if lead.priority == 'High' %}#ff4444{% elif lead.priority == 'Medium' %}#ffaa00{% else %}#22c55e{% endif %}; font-weight: 600; font-size: 10px; padding: 2px 8px; border-radius: 10px; background: {% if lead.priority == 'High' %}#ff444415{% elif lead.priority == 'Medium' %}#ffaa0015{% else %}#22c55e15{% endif %};">
                                {{ lead.priority|default:"Medium" }}
                            </span>
                        </div>
                        {% if lead.campaign_display %}
                        <div class="lead-campaign" title="{{ lead.campaign_display }}">
                            <i class="fas fa-bullhorn" style="font-size: 9px;"></i>
                            <span>{{ lead.campaign_display|truncatechars:40 }}</span>
                        </div>
                        {% endif %}
                        
                        <!-- REQUIREMENTS BADGE WITH HOVER PREVIEW -->
                        {% if lead.requirements_count > 0 %}
                        <div class="lead-requirements-badge has-requirements" title="Click lead to view {{ lead.requirements_count }} item(s)">
                            <i class="fas fa-box"></i>
                            {{ lead.requirements_count }} item{{ lead.requirements_count|pluralize }}
                            <!-- Optional tooltip preview (will show on hover) -->
                            <div class="requirements-tooltip" style="display: none; max-height: 200px; overflow-y: auto;">
                                {% if lead.requirements %}
                                    {% for req in lead.requirements %}
                                    <div class="requirements-tooltip-item">
                                        <strong>{{ req.item_name }}</strong> (Qty: {{ req.quantity }})
                                    </div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                        </div>
                        {% else %}
                        <div class="lead-requirements-badge no-requirements" title="No items added">
                            <i class="fas fa-box"></i>
                            No items
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="no-results">No active leads found</div>
            {% endif %}
        </div>
        
        <!-- Employee List (hidden by default) -->
        <div class="employee-list" id="employeeList">
            {% if active_users %}
                {% for u in active_users %}
                <div class="employee-item" data-id="{{ u.id }}" data-name="{{ u.name|escapejs }}">
                    <div class="employee-avatar">
                        {{ u.name|slice:":2"|upper }}
                    </div>

                    <div class="employee-details">
                        <div class="employee-name">{{ u.name }}</div>
                        <div class="employee-role">
                            {{ u.department }}{% if u.designation %} - {{ u.designation }}{% endif %}
                        </div>
                    </div>

                    <button class="assign-btn" data-id="{{ u.id }}" data-name="{{ u.name|escapejs }}" data-role="employee-assign">
                        Assign
                    </button>
                </div>
                {% endfor %}
            {% else %}
                <div class="no-results">No active users found</div>
            {% endif %}
        </div>
        
        <!-- Pagination -->
        <div class="directory-pagination" id="directoryPagination">
            <div class="pagination-buttons">
                <button class="pagination-btn" id="prevPage" disabled>
                    <i class="fas fa-chevron-left"></i> Prev
                </button>
            </div>
            
            <div class="pagination-numbers" id="paginationNumbers">
                <!-- Page numbers will be generated here -->
            </div>
            
            <div class="pagination-info" id="paginationInfo">
                Page 1 of 1
            </div>
            
            <div class="pagination-buttons">
                <button class="pagination-btn" id="nextPage" disabled>
                    Next <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>
</div>
            
            <!-- Right Column - Lead Form -->
            <div class="form-column">
                <div class="form-container">
                    <div class="form-header">
                        <h1>Lead Creation Form</h1>
                        <p>Please fill in all the required details accurately</p>
                    </div>
                    <div class="form-body">
                        <form id="customerForm" method="POST" action="{% url 'app5:lead' %}">
                            {% csrf_token %}
                            
                            <!-- Communication Details Section -->
                            <div class="form-section" id="communication-details">
                                <div class="section-title">
                                    <div>
                                        <i class="fas fa-phone-alt"></i>
                                        <span>Communication Details</span>
                                    </div>
                                    <div class="status-inline">
                                        <select id="status" name="status" class="status-select" required>
                                            <option value="">Status</option>
                                            <option value="Active">🟢Active</option>
                                            <option value="Inactive">🔴Inactive</option>
                                            <option value="Installed">🟡 Installed</option>
                                        </select>

                                        <select id="priority" name="priority" class="status-select" required>
                                        <option value="">Priority</option>
                                        <option value="High">🔴 High</option>
                                        <option value="Medium">🟡 Medium</option>
                                        <option value="Low">🟢  Low</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="ownerName">Owner Name *</label>
                                       <input type="text" id="ownerName" name="ownerName" placeholder="Enter owner name" required>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="phoneNo">Phone Number *</label>
                                         <input type="tel" id="phoneNo" name="phoneNo" placeholder="Enter phone number" required>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="email">Email Address</label>
                                         <input type="email" id="email" name="email" placeholder="Enter Email Address">
                                    </div>
                                </div>
                            </div>

                            
                            <!-- Single Line Layout for Business and Basic Information -->
                            <div class="single-line-sections">
                                <!-- Basic Information Section -->
                                <div class="section-column" id="basic-info">
                                    <div class="section-header-compact">
                                        <div class="section-title-compact">
                                            <i class="fas fa-user"></i>
                                            <span>Basic Information</span>
                                        </div>
                                        <div class="header-controls">
                                            <div class="toggle-container">
                                                <span class="toggle-label">New</span>
                                                <label class="toggle-switch">
                                                    <input type="checkbox" id="customerTypeToggle" name="customerTypeToggle" checked>
                                                    <span class="toggle-slider"></span>
                                                </label>
                                                <span class="toggle-label">Exist</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Business fields (shown by default) -->
                                    <div class="business-fields">
                                        <!-- Searchable Firm Name Field with API Data -->
                                        <div class="compact-form-group">
                                            <label for="name">
                                                Firm Name * 
                                                <span id="firmSourceBadge" class="campaign-badge" style="background: #4a6fdc;">
                                                    API: {{ api_data_count }}
                                                </span>
                                            </label>
                                            <div class="select-search-container" id="firmNameContainer">
                                                <input type="text" class="select-search-input" id="nameSearch" 
                                                       placeholder="Search from {{ api_data_count }} API customers or type new firm..." 
                                                       title="Connected to customer API - {{ api_data_count }} records available"
                                                       autocomplete="off">
                                                <i class="fas fa-times select-clear-icon" id="firmNameClear"></i>
                                                <i class="fas fa-chevron-down select-search-icon"></i>
                                                <!-- First letter search buttons -->
                                                <!-- <div class="first-letter-search" id="firstLetterSearch" style="display: flex; flex-wrap: wrap; gap: 2px; margin-top: 5px; margin-bottom: 5px;">
                                                    {% for letter in "ABCDEFGHIJKLMNOPQRSTUVWXYZ" %}
                                                    <button type="button" class="letter-btn" data-letter="{{ letter }}" style="padding: 2px 5px; font-size: 11px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 3px;">{{ letter }}</button>
                                                    {% endfor %}
                                                </div> -->
                                                <div class="select-options" id="firmNameOptions"></div>
                                            </div>
                                            <input type="text" id="name" name="name" style="display: none;">
                                            
                                            <!-- API Customer Details (hidden by default) -->
                                            <div id="apiCustomerDetails" class="campaign-details-section" style="display: none; margin-top: 8px;">
                                                <div class="campaign-detail-item">
                                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                                        <strong>API Customer Details</strong>
                                                        <button type="button" onclick="closeApiCustomerDetails()" style="background: none; border: none; color: #666; cursor: pointer;">
                                                            <i class="fas fa-times"></i>
                                                        </button>
                                                    </div>
                                                    <div id="apiCustomerInfo" style="font-size: 12px; line-height: 1.4;">
                                                        <!-- Customer details will be populated here -->
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="compact-form-group">
                                            <label for="address">Address</label>
                                            <input type="text" id="address" name="address">
                                        </div>
                                        
                                        <div class="compact-form-group">
                                            <label for="place">Place *</label>
                                            <input type="text" id="place" name="place" required>
                                        </div>
                                        
                                        <div class="compact-form-group">
                                            <label for="District">District</label>
                                            <select id="District" name="District">
                                                <option value="">Select District</option>
                                                {% for district in districts %}
                                                <option value="{{ district.name }}">{{ district.name }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        
                                        <div class="compact-form-group">
                                            <label for="State">State</label>
                                            <select id="State" name="State">
                                                <option value="">Select State</option>
                                                {% for state in states %}
                                                <option value="{{ state.name }}">{{ state.name }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        
                                        <div class="compact-form-group">
                                            <label for="pinCode">Pin Code *</label>
                                            <input type="text" id="pinCode" name="pinCode" required>
                                        </div>
                                    </div>
                                    
                                    <!-- Individual fields (hidden by default) -->
                                    <div class="individual-fields">
                                        <div class="compact-form-group">
                                            <label for="firstName">Firm Name *</label>
                                            <input type="text" id="firstName" name="firstName">
                                        </div>
                                        
                                        <div class="compact-form-group">
                                            <label for="individualAddress">Address</label>
                                            <input type="text" id="individualAddress" name="individualAddress">
                                        </div>
                                        
                                        <div class="compact-form-group">
                                            <label for="individualPlace">Place *</label>
                                            <input type="text" id="individualPlace" name="individualPlace">
                                        </div>
                                        
                                        <div class="compact-form-group">
                                            <label for="individualDistrict">District</label>
                                            <select id="individualDistrict" name="individualDistrict">
                                                <option value="">Select District</option>
                                                {% for district in districts %}
                                                <option value="{{ district.name }}">{{ district.name }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        
                                        <div class="compact-form-group">
                                            <label for="individualState">State</label>
                                            <select id="individualState" name="individualState">
                                                <option value="">Select State</option>
                                                {% for state in states %}
                                                <option value="{{ state.name }}">{{ state.name }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        
                                        <div class="compact-form-group">
                                            <label for="individualPinCode">Pin Code *</label>
                                            <input type="text" id="individualPinCode" name="individualPinCode">
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Business Information Section -->
                                <div class="section-column" id="business-info">
                                    <div class="section-header-compact">
                                        <div class="section-title-compact">
                                            <i class="fas fa-briefcase"></i>
                                            <span>Business Information</span>
                                        </div>
                                        <div class="header-controls">
                                            <div class="date-field-compact">
                                                <label for="date">Date</label>
                                                <input type="date" id="date" name="date" value="{{ today|date:'Y-m-d' }}">
                                            </div>
                                        </div>
                                    </div>

                                     <div class="compact-form-group">
                                        <label for="requirement">Branch</label>
                                        <select id="requirement" name="requirement">
                                            <option value="">Select Branch</option>
                                            {% for department in departments %}
                                            <option value="{{ department.id }}">{{ department.name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>

                                    <div class="compact-form-group">
                                        <label for="business">Business Nature</label>
                                        <select id="business" name="business">
                                            <option value="">Select Business Nature</option>
                                            {% for nature in business_natures %}
                                            <option value="{{ nature.name }}">{{ nature.name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    
                                    <!-- Searchable Reference From Field -->
                                    <div class="compact-form-group">
                                        <label for="refFrom">Reference From</label>
                                        <div class="select-search-container" id="refFromContainer">
                                            <input type="text" class="select-search-input" id="refFromSearch" placeholder="Search or select reference..." readonly>
                                            <i class="fas fa-times select-clear-icon" id="refFromClear"></i>
                                            <i class="fas fa-chevron-down select-search-icon"></i>
                                            <div class="select-options" id="refFromOptions"></div>
                                        </div>
                                        <select id="refFrom" name="refFrom" style="display: none;">
                                            <option value="">Select Reference</option>
                                            {% for ref in references %}
                                            <option value="{{ ref.ref_name }}">{{ ref.ref_name }}</option>
                                            {% empty %}
                                            {% endfor %}
                                        </select>
                                    </div>
                                    
                                    <div class="compact-form-group">
                                        <label for="marketedBy">Marketed By</label>
                                        <select id="marketedBy" name="marketedBy" class="form-select">
                                            <option value="">-- Select Active User --</option>
                                            {% for user in active_users %}
                                                <option value="{{ user.id }}">{{ user.name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    
                                    <!-- CAMPAIGN DETAILS FIELD WITH DISPLAY -->
                                    <div class="compact-form-group">
    <label for="campaign">Campaign Details 
        <span class="campaign-badge" style="background: #9c27b0;">{{ campaigns|length }}</span>
    </label>
    
    <select id="campaign" name="campaign" class="form-control" onchange="displayCampaignDetails(this)">
        <option value="">-- Select Campaign --</option>
        {% for campaign in campaigns %}
            <option value="{{ campaign.campaign_unique_id }}"
                    data-id="{{ campaign.campaign_unique_id }}"
                    data-name="{{ campaign.campaign_name }}"
                    data-software="{{ campaign.software_name }}"
                    
                    data-leads="{{ campaign.total_leads|default:0 }}">
                {{ campaign.campaign_unique_id }} - {{ campaign.campaign_name }}
                {% if campaign.software_name %} ({{ campaign.software_name }}){% endif %}
                <!-- {% if campaign.status %} [{{ campaign.status|title }}]{% endif %} -->
            </option>
        {% empty %}
            <option value="">No campaigns available</option>
        {% endfor %}
    </select>
    
    {% if campaigns %}
        <small class="text-muted" style="display: block; margin-top: 4px;">
            Select from {{ campaigns|length }} available campaigns
        </small>
    {% endif %}
</div>



                                    
                                    <div class="compact-form-group">
                                        <label for="Consultant">Consultant</label>
                                        <input type="text" id="Consultant" name="Consultant" placeholder="Enter consultant name">
                                    </div>
                                    
                                    <div class="compact-form-group">
                                        <label for="details">Notes</label>
                                        <input type="text" id="details" name="details" placeholder="Enter details">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Hidden field to store assignment type -->
                           <!-- Hidden field to store assignment type -->
                            <input type="hidden" id="assignmentType" name="assignmentType" value="">
                            
                            <!-- ===== Requirements Section ===== -->
                            <div class="requirements-section" id="requirements-section" style="margin-top: 20px;">
                                <div class="section-header-compact">
                                    <div class="section-title-compact">
                                        <i class="fas fa-clipboard-list"></i>
                                        <span>Requirements List</span>
                                        <span id="itemsCountBadge" class="section-info-badge">0 items</span>
                                    </div>
                                    <button type="button" class="add-btn" id="add-item-btn">
                                        <i class="fas fa-plus"></i> Add Item
                                    </button>
                                </div>

                                <!-- Item Options Template -->
                                <template id="item-options">
    {% for section, items in items_by_section.items %}
        {% for item in items %}
            <option
                value="{{ item.id }}"
                data-name="{{ item.name }}"
                data-section="{{ section }}"
                data-unit="{{ item.unit|default:'pcs' }}"
                data-price="{{ item.price|default:'0' }}"
                data-hsn="{{ item.hsn|default:'' }}"
                data-description="{{ item.description|default:'' }}"
            >
                {{ item.name }}
            </option>
        {% endfor %}
    {% endfor %}
</template>


                                <div class="table-container" style="margin-top: 15px;">
                                    <table id="requirements-table">
                                        <thead>
                                            <tr>
                                                <th width="5%">#</th>
                                                <th width="25%">Section</th>
                                                <th width="35%">Item Name</th>
                                                <th width="10%">Unit</th>
                                                <th width="15%">Price</th>
                                                <th width="10%">Qty</th>
                                                <th width="15%">Total</th>
                                                <th width="10%">Action</th>
                                            </tr>
                                        </thead>
                                        <tbody id="table-body">
                                            <!-- Rows will be added dynamically -->
                                        </tbody>
                                        <tfoot>
                                            <tr class="total-row">
                                                <td colspan="6" style="text-align: right; font-weight:700; font-size: 14px;">Grand Total:</td>
                                                <td id="grand-total" style="font-weight:700; font-size: 14px;">0.00</td>
                                                <td></td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>

                                <!-- Hidden fields for requirements -->
                                <input type="hidden" name="requirement_ids" id="hiddenRequirementIds" value="">
                                <input type="hidden" name="requirement_details" id="hiddenRequirementDetails" value="">
                            </div>
                            <!-- ===== end Requirements Section ===== -->
                            
                            <!-- Form Actions -->
                            <div class="btn-group" id="form-actions">
                                <button type="submit" class="submit-btn" title="Create a new lead with current form data">
                                    <i class="fas fa-paper-plane"></i>
                                    &nbsp; Submit Form
                                </button>
                                <button type="button" class="clear-btn" id="clearFormBtn" title="Clear the form and reset to create a new lead">
                                    <i class="fas fa-eraser"></i>
                                    &nbsp;Clear
                                </button>
                                <!-- EDIT BUTTON - Now always visible but disabled when no lead selected -->
                                <button type="button" class="edit-btn" id="editFormBtn" disabled title="Edit the selected lead from the directory">
                                    <i class="fas fa-edit"></i>
                                    &nbsp; Edit Lead
                                </button>
                                <button type="button" class="reset-btn" onclick="window.location.href='{% url 'app5:lead_report' %}'">
                                    <i class="fas fa-arrow-left"></i>
                                    &nbsp; Back
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Self-Assigned Modal -->
    <div id="assignmentModal" class="modal">
        <div class="modal-content">
            <h3>Select Assignment Type</h3>
            <p>How would you like to handle this lead?</p>
            
            <div class="modal-buttons">
                <button type="button" id="selfAssignedBtn" class="modal-btn self-assign-btn">
                    <i class="fas fa-user-check"></i> Self Assigned
                </button>
                <button type="button" id="unassignedBtn" class="modal-btn unassign-btn">
                    <i class="fas fa-users"></i> Unassigned
                </button>
            </div>
            
            <button type="button" id="cancelModalBtn" class="cancel-btn">
                Cancel
            </button>
        </div>
    </div>

 <script>
document.addEventListener('DOMContentLoaded', function() {
    
    // Set today's date as default
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('date').value = today;
    
    // Toggle functionality for Individual/Business
    const customerTypeToggle = document.getElementById('customerTypeToggle');
    const businessFields = document.querySelector('.business-fields');
    const individualFields = document.querySelector('.individual-fields');
    
    // Modal elements
    const assignmentModal = document.getElementById('assignmentModal');
    const selfAssignedBtn = document.getElementById('selfAssignedBtn');
    const unassignedBtn = document.getElementById('unassignedBtn');
    const cancelModalBtn = document.getElementById('cancelModalBtn');
    const assignmentTypeField = document.getElementById('assignmentType');
    
    // Pagination elements
    const prevPageBtn = document.getElementById('prevPage');
    const nextPageBtn = document.getElementById('nextPage');
    const paginationNumbers = document.getElementById('paginationNumbers');
    const paginationInfo = document.getElementById('paginationInfo');
    
    // Clear button element
    const clearFormBtn = document.getElementById('clearFormBtn');
    
    // Edit button element
    const editFormBtn = document.getElementById('editFormBtn');
    
    // Requirements elements
    const addItemBtn = document.getElementById('add-item-btn');
    const tableBody = document.getElementById('table-body');
    const itemsCountBadge = document.getElementById('itemsCountBadge');
    const grandTotalCell = document.getElementById('grand-total');
    const hiddenRequirementIds = document.getElementById('hiddenRequirementIds');
    const hiddenRequirementDetails = document.getElementById('hiddenRequirementDetails');
    
    // Pagination configuration
    const itemsPerPage = 10;
    let currentPage = 1;
    let totalPages = 1;
    let currentItems = [];
    let filteredItems = [];
    
    // Searchable Select Variables
    let isRefFromOpen = false;
    let currentRefFromIndex = -1;
    
    // Firm Name searchable select Variables
    let isFirmNameOpen = false;
    let currentFirmNameIndex = -1;
    let filteredFirmOptions = [];
    
    // Requirements management
    let rowCount = 0;
    const itemOptionsTemplate = document.getElementById('item-options');
    const itemOptions = itemOptionsTemplate ? Array.from(itemOptionsTemplate.content.querySelectorAll('option')) : [];
    
    // Group items by section
    const itemsBySection = {};
    itemOptions.forEach(option => {
        const section = option.getAttribute('data-section') || 'GENERAL';
        if (!itemsBySection[section]) {
            itemsBySection[section] = [];
        }
        itemsBySection[section].push(option);
    });
    
    // Create lookup maps for marketedBy and branch
    const marketedByMap = {
        {% for user in active_users %}
        "{{ user.id }}": "{{ user.name|escapejs }}",
        {% endfor %}
    };

    const branchMap = {
        {% for department in departments %}
        "{{ department.id }}": "{{ department.name|escapejs }}",
        {% endfor %}
    };

    // Existing firms data from Django template
    const existingFirms = [
        {% for firm in existing_firms %}
            "{{ firm|escapejs }}",
        {% endfor %}
    ];

    // Campaign data map with complete structure
    const campaignMap = {};
    {% for campaign in campaigns %}
        {% if campaign.campaign_unique_id %}
            campaignMap["{{ campaign.campaign_unique_id|escapejs }}"] = {
                id: "{{ campaign.campaign_unique_id|escapejs }}",
                name: "{{ campaign.campaign_name|escapejs }}",
                software: "{{ campaign.software_name|escapejs|default:'' }}",
                status: "{{ campaign.status|escapejs|default:'draft' }}",
                fromDate: "{{ campaign.from_date|date:'d M, Y'|escapejs }}",
                toDate: "{{ campaign.to_date|date:'d M, Y'|escapejs }}",
                days: "{{ campaign.number_of_days|escapejs }}",
                location: "{{ campaign.location|escapejs|default:'Not specified' }}",
                amount: "{{ campaign.total_amount|escapejs }}",
                reach: "{{ campaign.total_reach|default:0|escapejs }}",
                impression: "{{ campaign.total_impression|default:0|escapejs }}",
                leads: "{{ campaign.total_leads|default:0|escapejs }}",
                fullName: "{{ campaign.campaign_unique_id|escapejs }} - {{ campaign.campaign_name|escapejs }}{% if campaign.software_name %} ({{ campaign.software_name|escapejs }}){% endif %}{% if campaign.status %} [{{ campaign.status|title|escapejs }}]{% endif %}",
                displayName: "{{ campaign.campaign_unique_id|escapejs }} - {{ campaign.campaign_name|escapejs }}"
            };
        {% endif %}
    {% endfor %}

    // Lead data - created on server side via template earlier (active_leads_data)
    const leads = [
        {% for lead in active_leads_data %}
        {
            id: {{ lead.id }},
            ownerName: "{{ lead.ownerName|escapejs }}",
            phoneNo: "{{ lead.phoneNo|escapejs }}",
            email: "{{ lead.email|escapejs }}",
            ticketNo: "{{ lead.ticket_number|escapejs }}",
            date: "{{ lead.date|date:'Y-m-d'|escapejs }}",
            createdAt: "{{ lead.created_at|date:'Y-m-d'|escapejs }}",
            createdTime: "{{ lead.created_at|time:'H:i'|escapejs }}",
            status: "{{ lead.status|escapejs }}",
            priority: "{{ lead.priority|default:'Medium'|escapejs }}",
            customerType: "{{ lead.customerType|escapejs }}",
            name: "{{ lead.name|escapejs }}",
            address: "{{ lead.address|escapejs }}",
            place: "{{ lead.place|escapejs }}",
            District: "{{ lead.District|escapejs }}",
            State: "{{ lead.State|escapejs }}",
            pinCode: "{{ lead.pinCode|escapejs }}",
            firstName: "{{ lead.firstName|escapejs }}",
            individualAddress: "{{ lead.individualAddress|escapejs }}",
            individualPlace: "{{ lead.individualPlace|escapejs }}",
            individualDistrict: "{{ lead.individualDistrict|escapejs }}",
            individualState: "{{ lead.individualState|escapejs }}",
            individualPinCode: "{{ lead.individualPinCode|escapejs }}",
            refFrom: "{{ lead.refFrom|escapejs }}",
            business: "{{ lead.business|escapejs }}",
            campaign: "{{ lead.campaign|default:''|escapejs }}",
            campaign_display: "{{ lead.campaign_display|default:''|escapejs }}",
            marketedBy: "{{ lead.marketedBy|escapejs }}",
            Consultant: "{{ lead.Consultant|escapejs }}",
            requirement: "{{ lead.requirement|escapejs }}",
            details: "{{ lead.details|escapejs }}",
            // Add the actual names for display
            marketedByName: "{{ lead.marketed_by_name|default:lead.marketedBy|escapejs }}",
            branchName: "{{ lead.branch_name|default:lead.requirement|escapejs }}",
            campaignName: "{{ lead.campaign_display|default:lead.campaign|default:''|escapejs }}",
            // Requirements data from JSON attribute
            requirementsJson: "{{ lead.requirements_json|default:'[]'|escapejs }}",
            requirementsCount: {{ lead.requirements_count|default:0 }}
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];

    // Employee data
    const employees = [
        {% for u in active_users %}
        {
            id: {{ u.id }},
            name: "{{ u.name|escapejs }}",
            department: "{{ u.department|escapejs }}",
            designation: "{{ u.designation|escapejs }}"
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];

    // ========== API CUSTOMER DATA FUNCTIONS ==========

    // Store API customer data from Django context
    const apiCustomerData = [
        {% for customer in api_customer_data %}
        {
            code: "{{ customer.code|escapejs }}",
            name: "{{ customer.name|escapejs }}",
            address: "{{ customer.address|escapejs }}",
            address3: "{{ customer.address3|escapejs }}",
            branch: "{{ customer.branch|escapejs }}",
            district: "{{ customer.district|escapejs }}",
            state: "{{ customer.state|escapejs }}",
            mobile: "{{ customer.mobile|escapejs }}",
            software: "{{ customer.software|escapejs }}",
            nature: "{{ customer.nature|escapejs }}",
            rout: "{{ customer.rout|escapejs }}",
            installationdate: "{{ customer.installationdate|escapejs }}",
            is_api: true
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];

    console.log('📡 API Customer Data Loaded:', apiCustomerData.length, 'customers');
    console.log('📊 Total leads:', leads.length);
    console.log('👥 Total employees:', employees.length);
    console.log('🎯 Campaigns available:', Object.keys(campaignMap).length);
    console.log('🏢 Existing firms:', existingFirms.length);
    console.log('📡 API Customers:', apiCustomerData.length);
    console.log('📦 Item options:', itemOptions.length);
    console.log('📋 Items by section:', Object.keys(itemsBySection).length);

    // ========== FIRM NAME SEARCH FUNCTIONS ==========

    /**
     * Initialize Firm Name Search with API Data
     */
    function initializeFirmNameSearch() {
        const firmNameSearch = document.getElementById('nameSearch');
        const firmNameOptions = document.getElementById('firmNameOptions');
        const firmNameClear = document.getElementById('firmNameClear');
        const firmSourceBadge = document.getElementById('firmSourceBadge');
        const hiddenNameField = document.getElementById('name');
        
        if (!firmNameSearch) return;
        
        // Combine API customers and existing firms
        const allCustomers = [...apiCustomerData];
        
        // Add existing firms as non-API customers
        existingFirms.forEach(firm => {
            if (firm && !allCustomers.some(c => c.name === firm)) {
                allCustomers.push({
                    name: firm,
                    is_api: false,
                    address: '',
                    district: '',
                    state: '',
                    mobile: '',
                    software: ''
                });
            }
        });
        
        console.log('🏢 Total customers for search:', allCustomers.length);
        console.log('🔍 API customers:', apiCustomerData.length);
        console.log('📋 Local firms:', existingFirms.length);
        
        // Sort customers by name
        allCustomers.sort((a, b) => {
            const nameA = (a.name || '').toLowerCase();
            const nameB = (b.name || '').toLowerCase();
            return nameA.localeCompare(nameB);
        });
        
        // Populate firm name options
        function populateFirmOptions(searchTerm = '') {
            firmNameOptions.innerHTML = '';
            
            if (!searchTerm) {
                // Show first 20 customers by default
                const defaultCustomers = allCustomers.slice(0, 20);
                defaultCustomers.forEach(customer => {
                    addFirmOption(customer, searchTerm);
                });
                
                // Add "new firm" option at the bottom
                const newFirmOption = document.createElement('div');
                newFirmOption.className = 'select-option new-firm';
                newFirmOption.textContent = `Create new firm: "${searchTerm || '...'}"`;
                newFirmOption.onclick = function() {
                    firmNameSearch.value = searchTerm;
                    hiddenNameField.value = searchTerm;
                    firmNameOptions.classList.remove('active');
                    firmNameClear.classList.add('active');
                    firmSourceBadge.textContent = 'New';
                    firmSourceBadge.style.backgroundColor = '#4CAF50';
                    closeApiCustomerDetails();
                };
                firmNameOptions.appendChild(newFirmOption);
                return;
            }
            
            const searchLower = searchTerm.toLowerCase();
            let matchedCustomers = [];
            
            // Search in customer names
            allCustomers.forEach(customer => {
                if (customer.name && customer.name.toLowerCase().includes(searchLower)) {
                    matchedCustomers.push(customer);
                }
            });
            
            // If no matches, check if it's a new firm
            if (matchedCustomers.length === 0) {
                const newFirmOption = document.createElement('div');
                newFirmOption.className = 'select-option new-firm';
                newFirmOption.textContent = `Create new firm: "${searchTerm}"`;
                newFirmOption.onclick = function() {
                    firmNameSearch.value = searchTerm;
                    hiddenNameField.value = searchTerm;
                    firmNameOptions.classList.remove('active');
                    firmNameClear.classList.add('active');
                    firmSourceBadge.textContent = 'New';
                    firmSourceBadge.style.backgroundColor = '#4CAF50';
                    closeApiCustomerDetails();
                };
                firmNameOptions.appendChild(newFirmOption);
                return;
            }
            
            // Sort matches by relevance
            matchedCustomers.sort((a, b) => {
                const aStartsWith = a.name.toLowerCase().startsWith(searchLower);
                const bStartsWith = b.name.toLowerCase().startsWith(searchLower);
                
                if (aStartsWith && !bStartsWith) return -1;
                if (!aStartsWith && bStartsWith) return 1;
                
                const aIndex = a.name.toLowerCase().indexOf(searchLower);
                const bIndex = b.name.toLowerCase().indexOf(searchLower);
                return aIndex - bIndex;
            });
            
            // Show matches (limit to 20)
            matchedCustomers.slice(0, 20).forEach(customer => {
                addFirmOption(customer, searchTerm);
            });
            
            // Add "new firm" option if search doesn't exactly match
            if (!matchedCustomers.some(c => c.name.toLowerCase() === searchLower)) {
                const newFirmOption = document.createElement('div');
                newFirmOption.className = 'select-option new-firm';
                newFirmOption.textContent = `Create new firm: "${searchTerm}"`;
                newFirmOption.onclick = function() {
                    firmNameSearch.value = searchTerm;
                    hiddenNameField.value = searchTerm;
                    firmNameOptions.classList.remove('active');
                    firmNameClear.classList.add('active');
                    firmSourceBadge.textContent = 'New';
                    firmSourceBadge.style.backgroundColor = '#4CAF50';
                    closeApiCustomerDetails();
                };
                firmNameOptions.appendChild(newFirmOption);
            }
        }
        
        // Add a firm option to the dropdown
        function addFirmOption(customer, searchTerm) {
            const option = document.createElement('div');
            option.className = 'select-option';
            if (customer.is_api) {
                option.setAttribute('data-is-api', 'true');
            }
            
            // Highlight matching text
            let displayName = customer.name;
            if (searchTerm) {
                const regex = new RegExp(`(${searchTerm})`, 'gi');
                displayName = customer.name.replace(regex, '<strong>$1</strong>');
            }
            
            option.innerHTML = `
                ${displayName}
                ${customer.is_api ? '<span class="api-source-indicator">API</span>' : ''}
            `;
            
            option.onclick = function() {
                firmNameSearch.value = customer.name;
                hiddenNameField.value = customer.name;
                firmNameOptions.classList.remove('active');
                firmNameClear.classList.add('active');
                
                // Update source badge
                if (customer.is_api) {
                    firmSourceBadge.textContent = 'API';
                    firmSourceBadge.style.backgroundColor = '#4a6fdc';
                    
                    // Show API customer details
                    showApiCustomerDetails(customer);
                } else {
                    firmSourceBadge.textContent = 'Local';
                    firmSourceBadge.style.backgroundColor = '#ff9800';
                    closeApiCustomerDetails();
                }
                
                // If API customer, populate address fields
                if (customer.is_api && customer.address) {
                    document.getElementById('address').value = customer.address || '';
                    document.getElementById('place').value = customer.district || '';
                    document.getElementById('District').value = customer.district || '';
                    document.getElementById('State').value = customer.state || '';
                    document.getElementById('pinCode').value = '';
                    
                    // Populate phone if available
                    if (customer.mobile) {
                        document.getElementById('phoneNo').value = customer.mobile;
                    }
                }
            };
            
            firmNameOptions.appendChild(option);
        }
        
        // Event listeners
        firmNameSearch.addEventListener('focus', function() {
            if (!isFirmNameOpen) {
                firmNameOptions.classList.add('active');
                firmNameSearch.classList.add('active');
                isFirmNameOpen = true;
                populateFirmOptions(this.value);
            }
        });
        
        firmNameSearch.addEventListener('input', function() {
            populateFirmOptions(this.value);
            firmNameClear.classList.toggle('active', this.value.length > 0);
        });
        
        firmNameSearch.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                if (filteredFirmOptions.length > 0 && currentFirmNameIndex >= 0) {
                    // Select current option
                } else {
                    // Create new firm
                    const searchValue = this.value.trim();
                    if (searchValue) {
                        firmNameSearch.value = searchValue;
                        hiddenNameField.value = searchValue;
                        firmNameOptions.classList.remove('active');
                        firmSourceBadge.textContent = 'New';
                        firmSourceBadge.style.backgroundColor = '#4CAF50';
                        closeApiCustomerDetails();
                    }
                }
            } else if (e.key === 'ArrowDown') {
                e.preventDefault();
                navigateFirmOptions(1);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                navigateFirmOptions(-1);
            } else if (e.key === 'Escape') {
                firmNameOptions.classList.remove('active');
                isFirmNameOpen = false;
            }
        });
        
        firmNameClear.addEventListener('click', function() {
            firmNameSearch.value = '';
            hiddenNameField.value = '';
            firmNameClear.classList.remove('active');
            firmSourceBadge.textContent = '';
            populateFirmOptions('');
            closeApiCustomerDetails();
            firmNameSearch.focus();
        });
        
        // First letter search buttons
        const letterButtons = document.querySelectorAll('.letter-btn');
        letterButtons.forEach(btn => {
            btn.addEventListener('click', function() {
                const letter = this.getAttribute('data-letter');
                firmNameSearch.value = letter;
                firmNameSearch.focus();
                populateFirmOptions(letter);
            });
        });
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!firmNameSearch.contains(e.target) && !firmNameOptions.contains(e.target)) {
                firmNameOptions.classList.remove('active');
                firmNameSearch.classList.remove('active');
                isFirmNameOpen = false;
            }
        });
        
        console.log('✅ Firm name search initialized with', allCustomers.length, 'customers');
    }
    
    /**
     * Show API customer details
     */
    function showApiCustomerDetails(customer) {
        const apiDetails = document.getElementById('apiCustomerDetails');
        const apiInfo = document.getElementById('apiCustomerInfo');
        
        if (!apiDetails || !apiInfo) return;
        
        apiInfo.innerHTML = `
        
            <div><strong>Mobile:</strong> ${customer.mobile || 'N/A'}</div>
            
        `;
        
        apiDetails.style.display = 'block';
    }
    
    /**
     * Close API customer details
     */
    function closeApiCustomerDetails() {
        const apiDetails = document.getElementById('apiCustomerDetails');
        if (apiDetails) {
            apiDetails.style.display = 'none';
        }
    }
 

    function initializeRequirementsSection() {
        // Add event listener to Add Item button
        addItemBtn.addEventListener('click', addNewRow);
        
        // Add first row by default
        addNewRow();
        
        console.log('✅ Requirements section initialized');
    }

    /**
     * Add new row to requirements table
     */
    function addNewRow(itemData = null) {
        rowCount++;
        const row = document.createElement('tr');
        row.id = `row-${rowCount}`;
        
        // Section dropdown
        const sectionCell = document.createElement('td');
        const sectionSelect = document.createElement('select');
        sectionSelect.className = 'section-select';
        sectionSelect.innerHTML = '<option value="">Select Section</option>';
        
        // Add section options
        Object.keys(itemsBySection).forEach(section => {
            const option = document.createElement('option');
            option.value = section;
            option.textContent = section;
            if (itemData && itemData.section === section) {
                option.selected = true;
            }
            sectionSelect.appendChild(option);
        });
        
        sectionCell.appendChild(sectionSelect);
        
        // Item dropdown
        const itemCell = document.createElement('td');
        const itemSelect = document.createElement('select');
        itemSelect.className = 'item-select';
        itemSelect.innerHTML = '<option value="">Select Item</option>';
        itemSelect.disabled = true;
        itemCell.appendChild(itemSelect);
        
        // Unit cell
        const unitCell = document.createElement('td');
        const unitInput = document.createElement('input');
        unitInput.type = 'text';
        unitInput.className = 'unit-input';
        unitInput.readOnly = true;
        if (itemData && itemData.unit) {
            unitInput.value = itemData.unit;
        }
        unitCell.appendChild(unitInput);
        
        // Price cell
        const priceCell = document.createElement('td');
        const priceInput = document.createElement('input');
        priceInput.type = 'number';
        priceInput.className = 'price-input';
        priceInput.step = '0.01';
        priceInput.min = '0';
        priceInput.readOnly = true;
        if (itemData && itemData.price) {
            priceInput.value = itemData.price;
            priceInput.readOnly = false;
        }
        priceCell.appendChild(priceInput);
        
        // Quantity cell
        const qtyCell = document.createElement('td');
        const qtyInput = document.createElement('input');
        qtyInput.type = 'number';
        qtyInput.className = 'qty-input';
        qtyInput.min = '1';
        qtyInput.value = itemData ? (itemData.quantity || '1') : '1';
        qtyCell.appendChild(qtyInput);
        
        // Total cell
        const totalCell = document.createElement('td');
        const totalInput = document.createElement('input');
        totalInput.type = 'text';
        totalInput.className = 'total-input';
        totalInput.readOnly = true;
        if (itemData && itemData.price && itemData.quantity) {
            const total = parseFloat(itemData.price) * parseInt(itemData.quantity);
            totalInput.value = total.toFixed(2);
        }
        totalCell.appendChild(totalInput);
        
        // Action cell
        const actionCell = document.createElement('td');
        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'remove-btn';
        removeBtn.innerHTML = '<i class="fas fa-trash"></i>';
        removeBtn.title = 'Remove item';
        actionCell.appendChild(removeBtn);
        
        // Build row
        row.innerHTML = `<td>${rowCount}</td>`;
        row.appendChild(sectionCell);
        row.appendChild(itemCell);
        row.appendChild(unitCell);
        row.appendChild(priceCell);
        row.appendChild(qtyCell);
        row.appendChild(totalCell);
        row.appendChild(actionCell);
        
        tableBody.appendChild(row);
        
        // Populate items if section is already selected
        if (itemData && itemData.section) {
            populateItemsForSection(sectionSelect, itemSelect, itemData);
        }
        
        // Add event listeners
        addRowEventListeners(row, itemData);
        
        // Initial calculations
        updateRowNumbers();
        updateTotal();
        updateItemsCount();
        updateHiddenFields();
        
        return row;
    }

    /**
     * Populate items for a selected section
     */
    /**
 * Populate items for a selected section
 */
function populateItemsForSection(sectionSelect, itemSelect, itemData = null) {
    const section = sectionSelect.value;
    itemSelect.innerHTML = '<option value="">Select Item</option>';
    itemSelect.disabled = !section;
    
    if (section && itemsBySection[section]) {
        itemsBySection[section].forEach(itemOption => {
            const option = document.createElement('option');
            option.value = itemOption.value;
            option.textContent = itemOption.textContent;
            option.dataset.unit = itemOption.getAttribute('data-unit');
            option.dataset.price = itemOption.getAttribute('data-price');
            option.dataset.hsn = itemOption.getAttribute('data-hsn');
            option.dataset.description = itemOption.getAttribute('data-description');
            
            // Select this item if it matches the itemData
            if (itemData && itemData.item_id && itemData.item_id == itemOption.value) {
                option.selected = true;
            }
            
            itemSelect.appendChild(option);
        });
        
        // If itemData has item_id but wasn't found in options, try to select by name
        if (itemData && itemData.item_id && !itemSelect.value) {
            for (let i = 0; i < itemSelect.options.length; i++) {
                if (itemSelect.options[i].textContent === itemData.item_name) {
                    itemSelect.selectedIndex = i;
                    break;
                }
            }
        }
        
        // Trigger item selection
        if (itemSelect.value) {
            itemSelect.dispatchEvent(new Event('change'));
        }
    }
}

    // ========== FORM SUBMISSION WITH ASSIGNMENT MODAL ==========

    /**
     * Handle form submission with assignment modal
     */
    

    /**
     * Validate form before showing modal
     */
    function validateForm() {
        const form = document.getElementById('customerForm');
        const requiredFields = form.querySelectorAll('[required]');
        let isValid = true;
        let firstInvalidField = null;
        
        // Check all required fields
        requiredFields.forEach(field => {
            if (!field.value.trim()) {
                isValid = false;
                field.style.borderColor = '#f44336';
                
                if (!firstInvalidField) {
                    firstInvalidField = field;
                }
            } else {
                field.style.borderColor = '';
            }
        });
        
        // Check phone number format
        const phoneField = document.getElementById('phoneNo');
        if (phoneField.value && !/^\d{10,15}$/.test(phoneField.value.replace(/\D/g, ''))) {
            isValid = false;
            phoneField.style.borderColor = '#f44336';
            showNotification('Please enter a valid phone number (10-15 digits)', 'error');
            if (!firstInvalidField) firstInvalidField = phoneField;
        }
        
        // Check email format
        const emailField = document.getElementById('email');
        if (emailField.value && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailField.value)) {
            isValid = false;
            emailField.style.borderColor = '#f44336';
            showNotification('Please enter a valid email address', 'error');
            if (!firstInvalidField) firstInvalidField = emailField;
        }
        
        // Check firm name (if business mode)
        if (customerTypeToggle.checked) {
            const firmNameSearch = document.getElementById('nameSearch');
            if (!firmNameSearch.value.trim()) {
                isValid = false;
                firmNameSearch.style.borderColor = '#f44336';
                showNotification('Firm name is required for business customers', 'error');
                if (!firstInvalidField) firstInvalidField = firmNameSearch;
            }
        } else {
            // Check first name (if individual mode)
            const firstNameField = document.getElementById('firstName');
            if (!firstNameField.value.trim()) {
                isValid = false;
                firstNameField.style.borderColor = '#f44336';
                showNotification('Firm name is required for individual customers', 'error');
                if (!firstInvalidField) firstInvalidField = firstNameField;
            }
        }
        
        if (!isValid) {
            showNotification('Please fill in all required fields correctly', 'error');
            
            // Scroll to first invalid field
            if (firstInvalidField) {
                firstInvalidField.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center' 
                });
                firstInvalidField.focus();
            }
        }
        
        return isValid;
    }

    function initializeFormSubmissionWithModal() {
    const form = document.getElementById('customerForm');
    const assignmentModal = document.getElementById('assignmentModal');
    const selfAssignedBtn = document.getElementById('selfAssignedBtn');
    const unassignedBtn = document.getElementById('unassignedBtn');
    const cancelModalBtn = document.getElementById('cancelModalBtn');
    const assignmentTypeField = document.getElementById('assignmentType');
    
    if (!form || !assignmentModal) {
        console.error('Form or modal not found');
        return;
    }
    
    console.log('✅ Assignment modal initialized');
    
    // ========== FORM SUBMIT HANDLER ==========
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        console.log('📝 Form submission intercepted');
        
        // Validate form first
        if (!validateForm()) {
            console.log('❌ Form validation failed');
            return false;
        }
        
        console.log('✅ Form validation passed');
        
        // Update hidden fields before showing modal
        updateHiddenFields();
        
        // Show the assignment modal
        showModal();
        
        return false;
    });
    
    // ========== SELF ASSIGNED BUTTON ==========
    selfAssignedBtn.addEventListener('click', function() {
        console.log('👤 Self-assigned selected');
        assignmentTypeField.value = 'self_assigned';
        
        // Hide modal
        hideModal();
        
        // Submit form
        submitFormDirectly();
    });
    
    // ========== UNASSIGNED BUTTON ==========
    unassignedBtn.addEventListener('click', function() {
        console.log('👥 Unassigned selected');
        assignmentTypeField.value = 'unassigned';
        
        // Hide modal
        hideModal();
        
        // Submit form
        submitFormDirectly();
    });
    
    // ========== CANCEL BUTTON ==========
    cancelModalBtn.addEventListener('click', function() {
        console.log('❌ Assignment cancelled');
        hideModal();
    });
    
    // ========== CLICK OUTSIDE MODAL TO CLOSE ==========
    assignmentModal.addEventListener('click', function(e) {
        if (e.target === assignmentModal) {
            console.log('❌ Clicked outside modal');
            hideModal();
        }
    });
    
    // ========== ESC KEY TO CLOSE ==========
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && assignmentModal.style.display === 'flex') {
            console.log('❌ ESC pressed, closing modal');
            hideModal();
        }
    });
    
    // ========== HELPER FUNCTIONS ==========
    
    function showModal() {
        assignmentModal.style.display = 'flex';
        document.body.style.overflow = 'hidden'; // Prevent scrolling
        console.log('✅ Modal shown');
    }
    
    function hideModal() {
        assignmentModal.style.display = 'none';
        document.body.style.overflow = ''; // Restore scrolling
        console.log('✅ Modal hidden');
    }
    
    function submitFormDirectly() {
        console.log('📤 Submitting form with assignment type:', assignmentTypeField.value);
        
        // Update requirements data one final time
        updateHiddenFields();
        
        // Submit the form
        form.submit();
    }
    
    function validateForm() {
        const requiredFields = form.querySelectorAll('[required]');
        let isValid = true;
        let firstInvalidField = null;
        
        // Check all required fields
        requiredFields.forEach(field => {
            if (!field.value.trim()) {
                isValid = false;
                field.style.borderColor = '#f44336';
                
                if (!firstInvalidField) {
                    firstInvalidField = field;
                }
            } else {
                field.style.borderColor = '';
            }
        });
        
        // Check phone number format
        const phoneField = document.getElementById('phoneNo');
        if (phoneField.value && !/^\d{10,15}$/.test(phoneField.value.replace(/\D/g, ''))) {
            isValid = false;
            phoneField.style.borderColor = '#f44336';
            showNotification('Please enter a valid phone number (10-15 digits)', 'error');
            if (!firstInvalidField) firstInvalidField = phoneField;
        }
        
        // Check email format
        const emailField = document.getElementById('email');
        if (emailField.value && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailField.value)) {
            isValid = false;
            emailField.style.borderColor = '#f44336';
            showNotification('Please enter a valid email address', 'error');
            if (!firstInvalidField) firstInvalidField = emailField;
        }
        
        // Check firm name (if business mode)
        const customerTypeToggle = document.getElementById('customerTypeToggle');
        if (customerTypeToggle && customerTypeToggle.checked) {
            const firmNameSearch = document.getElementById('nameSearch');
            if (!firmNameSearch.value.trim()) {
                isValid = false;
                firmNameSearch.style.borderColor = '#f44336';
                showNotification('Firm name is required for business customers', 'error');
                if (!firstInvalidField) firstInvalidField = firmNameSearch;
            }
        } else {
            // Check first name (if individual mode)
            const firstNameField = document.getElementById('firstName');
            if (!firstNameField.value.trim()) {
                isValid = false;
                firstNameField.style.borderColor = '#f44336';
                showNotification('Firm name is required for individual customers', 'error');
                if (!firstInvalidField) firstInvalidField = firstNameField;
            }
        }
        
        if (!isValid) {
            showNotification('Please fill in all required fields correctly', 'error');
            
            // Scroll to first invalid field
            if (firstInvalidField) {
                firstInvalidField.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center' 
                });
                firstInvalidField.focus();
            }
        }
        
        return isValid;
    }
}
    /**
 * Add event listeners to a row
 */
function addRowEventListeners(row, itemData = null) {
    const sectionSelect = row.querySelector('.section-select');
    const itemSelect = row.querySelector('.item-select');
    const unitInput = row.querySelector('.unit-input');
    const priceInput = row.querySelector('.price-input');
    const qtyInput = row.querySelector('.qty-input');
    const totalInput = row.querySelector('.total-input');
    const removeBtn = row.querySelector('.remove-btn');
    
    // Section change handler
    sectionSelect.addEventListener('change', function() {
        populateItemsForSection(this, itemSelect, itemData);
        
        // Reset dependent fields
        if (unitInput) unitInput.value = '';
        if (priceInput) {
            priceInput.value = '';
            priceInput.readOnly = true;
        }
        if (qtyInput) qtyInput.value = '1';
        if (totalInput) totalInput.value = '';
        updateTotal();
    });
    
    // Item change handler
    itemSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        
        if (selectedOption && selectedOption.value) {
            if (unitInput) unitInput.value = selectedOption.dataset.unit || '';
            if (priceInput) {
                priceInput.value = selectedOption.dataset.price || '0';
                priceInput.readOnly = false;
            }
        } else {
            if (unitInput) unitInput.value = '';
            if (priceInput) {
                priceInput.value = '';
                priceInput.readOnly = true;
            }
        }
        
        if (qtyInput) qtyInput.value = '1';
        updateRowTotal();
    });
    
    // Price change handler
    if (priceInput) {
        priceInput.addEventListener('input', updateRowTotal);
    }
    
    // Quantity change handler
    if (qtyInput) {
        qtyInput.addEventListener('input', updateRowTotal);
    }
    
    // Remove button handler
    if (removeBtn) {
        removeBtn.addEventListener('click', function() {
            row.remove();
            updateRowNumbers();
            updateTotal();
            updateItemsCount();     // NEW: Update count when item selected
    updateHiddenFields();
        });
    }
    
    // If itemData is provided, select the item
    if (itemData && itemData.item_id && itemSelect) {
        // Find and select the item
        setTimeout(() => {
            for (let i = 0; i < itemSelect.options.length; i++) {
                if (itemSelect.options[i].value == itemData.item_id) {
                    itemSelect.selectedIndex = i;
                    itemSelect.dispatchEvent(new Event('change'));
                    break;
                }
            }
        }, 100);
    }
    
    // Update row total function
    function updateRowTotal() {
        if (!priceInput || !qtyInput || !totalInput) return;
        
        const price = parseFloat(priceInput.value) || 0;
        const qty = parseInt(qtyInput.value) || 0;
        const total = price * qty;
        totalInput.value = total.toFixed(2);
        updateTotal();
    }
    
    // Initialize row total if itemData exists
    if (itemData && itemData.price && itemData.quantity) {
        setTimeout(updateRowTotal, 150);
    }
}

    /**
     * Update row numbers
     */
    function updateRowNumbers() {
        const rows = tableBody.querySelectorAll('tr');
        rows.forEach((row, index) => {
            row.cells[0].textContent = index + 1;
        });
    }

    /**
     * Update grand total
     */
    function updateTotal() {
        let grandTotal = 0;
        const totalInputs = tableBody.querySelectorAll('.total-input');
        
        totalInputs.forEach(input => {
            grandTotal += parseFloat(input.value) || 0;
        });
        
        grandTotalCell.textContent = grandTotal.toFixed(2);
    }

    /**
     * Update items count badge
     */
   // AFTER (CORRECT)
function updateItemsCount() {
    let itemCount = 0;
    const rows = tableBody.querySelectorAll('tr');
    
    rows.forEach(row => {
        const itemSelect = row.querySelector('.item-select');
        if (itemSelect && itemSelect.value) {  // Only count if item is selected
            itemCount++;
        }
    });
    
    itemsCountBadge.textContent = `${itemCount} item${itemCount !== 1 ? 's' : ''}`;
}
    /**
     * Update hidden fields with requirement data
     */
    function updateHiddenFields() {
        const requirementData = []; // Array of requirement objects for JSON
        
        const rows = tableBody.querySelectorAll('tr');
        console.log('🔍 updateHiddenFields - Found rows:', rows.length);
        
        rows.forEach((row, index) => {
            const sectionSelect = row.querySelector('.section-select');
            const itemSelect = row.querySelector('.item-select');
            const unitInput = row.querySelector('.unit-input');
            const priceInput = row.querySelector('.price-input');
            const qtyInput = row.querySelector('.qty-input');
            
            if (itemSelect && itemSelect.value) {
                const price = parseFloat(priceInput ? (priceInput.value || '0') : '0');
                const quantity = parseInt(qtyInput ? (qtyInput.value || '1') : '1');
                const itemName = itemSelect.options[itemSelect.selectedIndex]?.text || '';
                
                // Build requirement data object for JSON submission
                requirementData.push({
                    item_id: parseInt(itemSelect.value) || null,
                    item_name: itemName,
                    section: sectionSelect ? sectionSelect.value : 'GENERAL',
                    unit: unitInput ? unitInput.value : 'pcs',
                    price: price,
                    quantity: quantity
                });
                
                console.log(`  Row ${index + 1}: Item=${itemName}, Price=${price}, Qty=${quantity}`);
            }
        });
        
        // Create or update hidden input for requirements_data JSON
        const form = document.getElementById('customerForm');
        let requirementsDataInput = document.getElementById('requirementsDataInput');
        
        if (!requirementsDataInput) {
            requirementsDataInput = document.createElement('input');
            requirementsDataInput.type = 'hidden';
            requirementsDataInput.id = 'requirementsDataInput';
            requirementsDataInput.name = 'requirements_data';
            form.appendChild(requirementsDataInput);
        }
        
        requirementsDataInput.value = JSON.stringify(requirementData);
        
        console.log('✅ Requirements data prepared for submission:', {
            count: requirementData.length,
            data: requirementData
        });
    }

    /**
     * Clear requirements table
     */
    function clearRequirements() {
        tableBody.innerHTML = '';
        rowCount = 0;
        updateItemsCount();
        updateTotal();
        updateHiddenFields();
    }

    /**
     * Parse requirements JSON from lead element
     */
    function parseRequirementsFromJson(requirementsJson) {
        try {
            if (requirementsJson && requirementsJson !== '[]') {
                return JSON.parse(requirementsJson);
            }
        } catch (error) {
            console.error('Error parsing requirements JSON:', error);
        }
        return [];
    }

    /**
     * Populate requirements from lead data
     */
    // Replace the populateRequirements function in your JavaScript with this:

/**
 * Populate requirements from lead data
 */
/**
 * Populate requirements from lead data
 */
function populateRequirements(leadData) {
    console.log('📦 Populating requirements for lead:', leadData.ownerName);
    
    // Clear existing rows
    clearRequirements();
    
    // Parse requirements from JSON
    let requirements = [];
    
    // Check if requirements data exists
    if (leadData.requirementsJson && leadData.requirementsJson !== '[]') {
        try {
            requirements = JSON.parse(leadData.requirementsJson);
            console.log('✅ Parsed requirements from JSON:', requirements);
        } catch (error) {
            console.error('❌ Error parsing requirements JSON:', error);
            // Try alternative approach
            if (typeof leadData.requirementsJson === 'string' && 
                leadData.requirementsJson.startsWith('[')) {
                try {
                    requirements = JSON.parse(leadData.requirementsJson);
                } catch (e) {
                    console.error('Failed to parse JSON string:', e);
                }
            }
        }
    }
    
    console.log('   Found requirements:', requirements.length);
    
    // If we have requirements data
    if (requirements && Array.isArray(requirements) && requirements.length > 0) {
        console.log('   📋 Loading', requirements.length, 'requirements');
        
        // Show a preview notification with items summary
        let itemsSummary = requirements.map((req, idx) => 
            `${idx + 1}. ${req.item_name || 'Unknown Item'} (Qty: ${req.quantity || 1})`
        ).join('\n');
        
        console.log('📊 Items Summary:\n' + itemsSummary);
        
        // Add each requirement as a row
        requirements.forEach((requirement, index) => {
            if (!requirement) return;
            
            console.log(`   [${index + 1}] Requirement:`, requirement);
            
            // Find the item data from itemOptions array
            let itemData = null;
            if (requirement.item_id) {
                // itemOptions is defined at the top of your script
                if (itemOptions && Array.isArray(itemOptions)) {
                    itemData = itemOptions.find(option => {
                        const optionValue = option.getAttribute ? option.getAttribute('value') : option.value;
                        return optionValue == requirement.item_id;
                    });
                }
            }
            
            // Prepare requirement data for the row
            const requirementData = {
                section: requirement.section || (itemData ? 
                    (itemData.getAttribute ? itemData.getAttribute('data-section') : itemData.dataset?.section) : 'GENERAL'),
                item_id: requirement.item_id || '',
                item_name: requirement.item_name || (itemData ? 
                    (itemData.textContent || itemData.text) : ''),
                unit: requirement.unit || (itemData ? 
                    (itemData.getAttribute ? itemData.getAttribute('data-unit') : itemData.dataset?.unit) : 'pcs'),
                price: requirement.price || (itemData ? 
                    (itemData.getAttribute ? itemData.getAttribute('data-price') : itemData.dataset?.price) : '0'),
                quantity: requirement.quantity || '1'
            };
            
            console.log(`     Section: ${requirementData.section}, Item: ${requirementData.item_name}`);
            
            // Add the row
            addNewRow(requirementData);
        });
        
        console.log('✅ Requirements loaded successfully');
        
        // Show a success toast with item count
        showNotification(`✅ Loaded ${requirements.length} item${requirements.length !== 1 ? 's' : ''}`, 'success');
    } else {
        console.log('     ⚠️ No requirements data found for this lead');
        // Add one empty row if no requirements exist
        addNewRow();
    }
}

/**
 * Fetch requirements from server via AJAX
 */
function fetchRequirementsFromServer(leadId) {
    console.log('🌐 Fetching requirements from server for lead ID:', leadId);
    
    if (!leadId) return;
    
    // Show loading indicator
    showNotification('Loading requirements...', 'info');
    
    // Fetch requirements from server
    fetch(`/api/lead/${leadId}/requirements/`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('✅ Requirements fetched from server:', data);
            
            if (data && data.requirements && Array.isArray(data.requirements)) {
                // Add each requirement
                data.requirements.forEach(requirement => {
                    const requirementData = {
                        section: requirement.section || 'GENERAL',
                        item_id: requirement.item_id || '',
                        item_name: requirement.item_name || '',
                        unit: requirement.unit || 'pcs',
                        price: requirement.price || '0',
                        quantity: requirement.quantity || '1'
                    };
                    
                    addNewRow(requirementData);
                });
                
                showNotification(`✅ Loaded ${data.requirements.length} requirements`, 'success');
            } else {
                console.log('⚠️ No requirements in server response');
                addNewRow();
            }
        })
        .catch(error => {
            console.error('❌ Error fetching requirements:', error);
            showNotification('⚠️ Could not load requirements', 'warning');
            addNewRow();
        });
}

    // ========== LEAD ITEM CLICK HANDLERS ==========

    /**
     * Set up lead item click functionality
     */
    /**
 * Set up lead item click functionality
 */
/**
 * Add event listeners to lead items for click functionality
 */
function setupLeadViewButtons() {
    const leadItems = document.querySelectorAll('#leadList .lead-item');
    
    leadItems.forEach(item => {
        item.addEventListener('click', function(e) {
            e.stopPropagation();
            e.preventDefault();
            
            // Remove previous selection
            leadItems.forEach(i => i.classList.remove('selected'));
            
            // Add selection to current item
            this.classList.add('selected');
            
            const leadId = this.getAttribute('data-id');
            const leadIndex = this.getAttribute('data-index');
            
            // IMPORTANT: Get the lead data from your leads array
            // Since you have the data-index attribute, use it to find the lead
            let leadData = null;
            
            if (leadIndex !== null && leadIndex !== undefined) {
                // Use the data-index to get the lead from leads array
                leadData = leads[parseInt(leadIndex)];
            }
            
            // Fallback: search by ID if index doesn't work
            if (!leadData && leadId) {
                leadData = leads.find(lead => String(lead.id) === String(leadId));
            }
            
            if (leadData) {
                console.log('📥 Loading lead data into form:', leadData);
                
                // Populate the form with lead data
                populateFormWithLeadData(leadData);
                
                // Update form header to indicate edit mode
                updateFormHeaderForEdit(leadData.ownerName);
                
                // Set hidden field for lead ID (if you add one)
                const leadIdField = document.getElementById('lead_id');
                if (leadIdField) {
                    leadIdField.value = leadData.id;
                }
                
                // Scroll to form for better UX
                setTimeout(() => {
                    document.querySelector('.form-column').scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'start' 
                    });
                }, 100);
                
                // Show success notification
                showNotification(`✅ Loaded lead: ${leadData.ownerName}`, 'success');
                
            } else {
                console.error('Lead data not found for ID:', leadId, 'Index:', leadIndex);
                showNotification('Could not load lead data', 'error');
            }
        });
    });
}


function resetFormHeader() {
    const formHeader = document.querySelector('.form-header h1');
    const formSubtitle = document.querySelector('.form-header p');
    
    if (formHeader) {
        formHeader.textContent = 'Lead Creation Form';
        formHeader.innerHTML = 'Lead Creation Form'; // Clear any HTML
    }
    
    if (formSubtitle) {
        formSubtitle.textContent = 'Please fill in all the required details accurately';
        formSubtitle.style.color = '';
        formSubtitle.style.fontWeight = '';
    }
}

   
    function populateFormWithLeadData(leadData) {
        console.log('🚀 START: Loading complete lead data into form');
        
        try {
            // ========== SECTION 1: COMMUNICATION DETAILS ==========
            console.log('📱 SECTION 1: Populating Communication Details');
            
            setFieldValue('ownerName', leadData.ownerName);
            setFieldValue('phoneNo', leadData.phoneNo);
            setFieldValue('email', leadData.email);
            setFieldValue('status', leadData.status);
            setFieldValue('priority', leadData.priority);
            
            console.log('✅ Communication details populated');
            
            // ========== SECTION 2: CUSTOMER TYPE TOGGLE ==========
            console.log('🔄 SECTION 2: Setting Customer Type Toggle');
            
            const toggle = document.getElementById('customerTypeToggle');
            const customerType = leadData.customerType || 'Business';
            
            if (customerType === 'Individual') {
                toggle.checked = false;
                console.log('   👤 Customer Type: Individual (Toggle OFF)');
            } else {
                toggle.checked = true;
                console.log('   🏢 Customer Type: Business (Toggle ON)');
            }
            
            // Force toggle update immediately
            initializeToggleWithData(customerType);
            
            // Wait for DOM to update after toggle change
            setTimeout(() => {
                // ========== SECTION 3: BASIC INFORMATION ==========
                console.log('🏢 SECTION 3: Populating Basic Information');
                
                if (customerType === 'Business') {
                    // Business fields
                    setFieldValue('name', leadData.name);
                    setFieldValue('nameSearch', leadData.name);
                    setFieldValue('address', leadData.address);
                    setFieldValue('place', leadData.place);
                    setFieldValue('District', leadData.District);
                    setFieldValue('State', leadData.State);
                    setFieldValue('pinCode', leadData.pinCode);
                    
                    console.log('✅ Business fields populated');
                } else {
                    // Individual fields
                    setFieldValue('firstName', leadData.firstName);
                    setFieldValue('individualAddress', leadData.individualAddress);
                    setFieldValue('individualPlace', leadData.individualPlace);
                    setFieldValue('individualDistrict', leadData.individualDistrict);
                    setFieldValue('individualState', leadData.individualState);
                    setFieldValue('individualPinCode', leadData.individualPinCode);
                    
                    console.log('✅ Individual fields populated');
                }
                
                // ========== SECTION 4: BUSINESS INFORMATION ==========
                console.log('💼 SECTION 4: Populating Business Information');
                
                setFieldValue('date', leadData.date);
                setFieldValue('requirement', leadData.requirement);
                setFieldValue('business', leadData.business);
                setFieldValue('refFrom', leadData.refFrom);
                setFieldValue('refFromSearch', leadData.refFrom);
                setFieldValue('marketedBy', leadData.marketedBy);
                setFieldValue('campaign', leadData.campaign);
                setFieldValue('Consultant', leadData.Consultant);
                setFieldValue('details', leadData.details);
                
                console.log('✅ Business information populated');
                
                // ========== SECTION 5: REQUIREMENTS ==========
                console.log('📦 SECTION 5: Populating Requirements');
                
                // Populate requirements section
                populateRequirements(leadData);
                
                console.log('✅ Requirements populated');
                
                // ========== SECTION 6: EDIT BUTTON AND FINAL ACTIONS ==========
                console.log('🎯 SECTION 6: Final Actions');
                
                // Show edit button with lead ID
                if (leadData.id) {
                    showEditButton(leadData.id);
                    console.log('     ✏️ Edit button ENABLED for lead ID:', leadData.id);
                }
                
                // Show success notification with detailed item info
                let notificationMessage = `✅ Loaded: ${leadData.ownerName}`;
                
                // Add customer type
                notificationMessage += ` (${customerType})`;
                
                // Add item count from requirements
                const requirementsCount = tableBody.querySelectorAll('tr').length;
                if (requirementsCount > 0) {
                    notificationMessage += ` | 📦 ${requirementsCount} item${requirementsCount !== 1 ? 's' : ''} loaded`;
                } else {
                    notificationMessage += ` | No items`;
                }
                
                // Add edit button hint
                notificationMessage += ` | ✏️ Edit`;
                
                showNotification(notificationMessage, 'success');
                
                console.log('✅ FORM POPULATION COMPLETE!');
                console.log('='.repeat(80));
                
            }, 300); // Give time for DOM to update after toggle
        } catch (error) {
            console.error('❌ Error populating form:', error);
            showNotification('⚠️ Error loading lead details', 'warning');
        }
    }

    // ========== HELPER FUNCTIONS ==========

    /**
     * Set form field value safely
     */
    function setFieldValue(fieldId, value) {
        const field = document.getElementById(fieldId);
        if (field) {
            if (field.tagName === 'SELECT') {
                // For select fields, try to find matching option
                let optionFound = false;
                
                for (let i = 0; i < field.options.length; i++) {
                    if (field.options[i].value === value || 
                        field.options[i].text === value) {
                        field.selectedIndex = i;
                        optionFound = true;
                        break;
                    }
                }
                
                if (!optionFound && value) {
                    // If no option found, set value directly
                    field.value = value;
                }
            } else {
                // For input fields
                field.value = value || '';
            }
            
            // Trigger change event
            field.dispatchEvent(new Event('change', { bubbles: true }));
        }
    }

    /**
     * Initialize customer type toggle with data
     */
    function initializeToggleWithData(customerType) {
        const toggle = document.getElementById('customerTypeToggle');
        
        if (customerType === 'Individual') {
            toggle.checked = false;
        } else {
            toggle.checked = true;
        }
        
        // Force UI update
        initializeToggle();
    }

    /**
     * Initialize customer type toggle functionality
     */
    function initializeToggle() {
        const isBusinessMode = customerTypeToggle.checked;
        
        if (isBusinessMode) {
            // Business mode - Show business fields, hide individual fields
            businessFields.style.display = 'block';
            individualFields.style.display = 'none';
            
            // Set required fields for business mode
            document.querySelectorAll('.business-fields [required]').forEach(field => {
                field.required = true;
            });
            document.querySelectorAll('.individual-fields [required]').forEach(field => {
                field.required = false;
            });
            
            // Enable firm name search field
            const firmNameSearch = document.getElementById('nameSearch');
            if (firmNameSearch) {
                firmNameSearch.readOnly = false;
                firmNameSearch.placeholder = `Search from ${apiCustomerData.length} API customers or type new firm...`;
            }
            
        } else {
            // Individual mode - Show individual fields, hide business fields
            businessFields.style.display = 'none';
            individualFields.style.display = 'block';
            
            // Set required fields for individual mode
            document.querySelectorAll('.business-fields [required]').forEach(field => {
                field.required = false;
            });
            document.querySelectorAll('.individual-fields [required]').forEach(field => {
                field.required = true;
            });
            
            // Close firm name dropdown if open
            const firmNameOptions = document.getElementById('firmNameOptions');
            if (firmNameOptions) firmNameOptions.classList.remove('active');
            
            // Close API customer details
            closeApiCustomerDetails();
        }
    }

    /**
     * Show edit button with lead ID
     */
    function showEditButton(leadId) {
        editFormBtn.disabled = false;
        editFormBtn.dataset.leadId = leadId;
        
        // When lead is selected, disable Submit button
        const submitBtn = document.querySelector('.submit-btn');
        if (submitBtn) {
            submitBtn.disabled = true;
        }
        
        console.log('✏️ Edit button enabled for lead ID:', leadId);
        console.log('🚫 Submit button disabled (lead selected)');
    }
    
    /**
     * Hide edit button
     */
    function hideEditButton() {
        editFormBtn.disabled = true;
        delete editFormBtn.dataset.leadId;
        
        // When lead is deselected, enable Submit button
        const submitBtn = document.querySelector('.submit-btn');
        if (submitBtn) {
            submitBtn.disabled = false;
        }
        
        console.log('✏️ Edit button disabled');
        console.log('✅ Submit button enabled (no lead selected)');
    }

    /**
     * Initialize Edit Button
     */
    function initializeEditButton() {
        // Initially disable the edit button and enable submit button
        editFormBtn.disabled = true;
        
        const submitBtn = document.querySelector('.submit-btn');
        if (submitBtn) {
            submitBtn.disabled = false;
        }
        
        // Edit button click handler
        editFormBtn.addEventListener('click', function() {
            if (!this.disabled) {
                const leadId = this.dataset.leadId;
                if (leadId) {
                    // Redirect to edit page with the lead ID
                    window.location.href = `/app5/lead/edit/${leadId}/`;
                } else {
                    showNotification('No lead selected for editing', 'error');
                }
            }
        });
        
        console.log('✅ Edit button initialized');
    }

    /**
     * Clear all form fields and reset to default state
     */
    function clearForm() {
        // Get the form element
        const form = document.getElementById('customerForm');
        
        // Store the CSRF token before resetting
        const csrfToken = form.querySelector('[name=csrfmiddlewaretoken]').value;
        
        // Reset the form
        form.reset();
        
        // Restore the CSRF token
        form.querySelector('[name=csrfmiddlewaretoken]').value = csrfToken;
        
        // Reset the toggle to default state (Business - checked)
        const toggle = document.getElementById('customerTypeToggle');
        toggle.checked = true;
        
        // Force the toggle to update the UI
        initializeToggle();
        
        // Set today's date as default
        document.getElementById('date').value = today;
        
        // Clear requirements
        clearRequirements();
        
        // Add one empty row
        addNewRow();
        
        // Clear any selected lead in the directory
        const selectedLead = document.querySelector('.lead-item.selected');
        if (selectedLead) {
            selectedLead.classList.remove('selected');
        }
        
        // Hide edit button AND enable submit button
        hideEditButton();
        
        // Ensure Submit button is enabled
        const submitBtn = document.querySelector('.submit-btn');
        if (submitBtn) {
            submitBtn.disabled = false;
        }
        
        // Show success message
        showNotification('Form has been cleared successfully', 'success');
        
        console.log('✅ Form cleared successfully');
        console.log('✅ Submit button enabled');
        console.log('🚫 Edit button disabled');
    }

    /**
     * Show notification message
     */
    function showNotification(message, type = 'info') {
        // Remove any existing notification
        const existingNotification = document.querySelector('.custom-notification');
        if (existingNotification) {
            existingNotification.remove();
        }
        
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `custom-notification notification-${type}`;
        notification.innerHTML = `
            <div class="notification-content">
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                <span>${message}</span>
                <button class="notification-close"><i class="fas fa-times"></i></button>
            </div>
        `;
        
        // Add styles
        const style = document.createElement('style');
        style.textContent = `
            .custom-notification {
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 9999;
                animation: slideIn 0.3s ease-out;
            }
            .notification-content {
                display: flex;
                align-items: center;
                gap: 10px;
                padding: 12px 20px;
                border-radius: 8px;
                background: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : '#2196F3'};
                color: white;
                font-weight: 500;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            }
            .notification-close {
                background: none;
                border: none;
                color: white;
                cursor: pointer;
                padding: 0;
                margin-left: 10px;
            }
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
        `;
        
        notification.appendChild(style);
        document.body.appendChild(notification);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            notification.remove();
        }, 5000);
        
        // Close button functionality
        notification.querySelector('.notification-close').addEventListener('click', () => {
            notification.remove();
        });
    }

    // ========== INITIALIZATION ==========

    /**
     * Initialize all functionality
     */
    function initializeApp() {
        // -------------------------
        // Initialize UI components
        // -------------------------
        initializeToggle();
        initializeEditButton();
        initializeRequirementsSection();
        initializeFirmNameSearch(); // Initialize firm name search FIRST
        setupDirectoryTabs();
        setupDirectorySearch();
        setupPriorityFilter();
        initializePagination();
        setupEventListeners();
        initializeSearchableSelect();
        initializeDateDisplay();
        setupLeadViewButtons();
        initializeFormSubmissionWithModal(); // ADD THIS LINE
        
        // -------------------------
        // Initialize Time Elapsed
        // -------------------------
        setTimeout(() => {
            updateAllTimeElapsedBadges();
        }, 500);

        setInterval(updateAllTimeElapsedBadges, 60000);

        // -------------------------
        // Debug logs
        // -------------------------
        console.log('✅ Lead Management System initialized successfully');
        console.log('📊 Total leads:', leads.length);
        console.log('👥 Total employees:', employees.length);
        console.log('🎯 Campaigns available:', Object.keys(campaignMap).length);
        console.log('🏢 Total customers for search:', apiCustomerData.length + existingFirms.length);
        console.log('📡 API Customers:', apiCustomerData.length);
        console.log('📋 Local Firms:', existingFirms.length);
        console.log('📅 Date display initialized');
        console.log('⏱️ Time elapsed indicators enabled');
        console.log('📦 Requirements section initialized');
        console.log('🔍 Firm name search with API data initialized');
        console.log('🎭 Form submission with modal initialized');
        
        // Initialize requirements display
        setTimeout(initializeAllLeadRequirements, 1000);
    }

    // Initialize the application
    initializeApp();

    // ========== EXISTING FUNCTIONS (simplified) ==========
    
    function initializeSearchableSelect() {
        // Your existing searchable select code for refFrom
        const refFromSearch = document.getElementById('refFromSearch');
        const refFromOptions = document.getElementById('refFromOptions');
        const refFromClear = document.getElementById('refFromClear');
        
        if (refFromSearch && refFromOptions) {
            const references = [
                {% for ref in references %}
                "{{ ref.ref_name|escapejs }}",
                {% endfor %}
            ];
            
            refFromSearch.addEventListener('focus', function() {
                if (!isRefFromOpen) {
                    refFromOptions.innerHTML = '';
                    references.forEach(ref => {
                        const option = document.createElement('div');
                        option.className = 'select-option';
                        option.textContent = ref;
                        option.onclick = function() {
                            refFromSearch.value = ref;
                            document.getElementById('refFrom').value = ref;
                            refFromOptions.classList.remove('active');
                            refFromClear.classList.add('active');
                        };
                        refFromOptions.appendChild(option);
                    });
                    refFromOptions.classList.add('active');
                    refFromSearch.classList.add('active');
                    isRefFromOpen = true;
                }
            });
            
            refFromSearch.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                refFromOptions.innerHTML = '';
                
                const filtered = references.filter(ref => 
                    ref.toLowerCase().includes(searchTerm)
                );
                
                if (filtered.length === 0) {
                    const noResult = document.createElement('div');
                    noResult.className = 'no-results-option';
                    noResult.textContent = 'No matches found';
                    refFromOptions.appendChild(noResult);
                } else {
                    filtered.forEach(ref => {
                        const option = document.createElement('div');
                        option.className = 'select-option';
                        option.textContent = ref;
                        option.onclick = function() {
                            refFromSearch.value = ref;
                            document.getElementById('refFrom').value = ref;
                            refFromOptions.classList.remove('active');
                            refFromClear.classList.add('active');
                        };
                        refFromOptions.appendChild(option);
                    });
                }
            });
            
            refFromClear.addEventListener('click', function() {
                refFromSearch.value = '';
                document.getElementById('refFrom').value = '';
                refFromClear.classList.remove('active');
                refFromSearch.focus();
            });
            
            document.addEventListener('click', function(e) {
                if (!refFromSearch.contains(e.target) && !refFromOptions.contains(e.target)) {
                    refFromOptions.classList.remove('active');
                    refFromSearch.classList.remove('active');
                    isRefFromOpen = false;
                }
            });
        }
        
        console.log('🔍 Reference search initialized');
    }
    
    function initializeDateDisplay() {
        // Your existing date display code
        const currentDate = new Date();
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        document.getElementById('currentDate').innerHTML = 
            `<i class="far fa-calendar-alt"></i> ${currentDate.toLocaleDateString('en-US', options)}`;
        
        const timeOptions = { hour: '2-digit', minute: '2-digit', hour12: true };
        document.getElementById('todayDate').innerHTML = 
            `<i class="far fa-clock"></i> ${currentDate.toLocaleTimeString('en-US', timeOptions)}`;
        
        console.log('📅 Date display updated');
    }
    
    /**
 * Update all time elapsed badges in real-time with proper formatting
 */
function updateAllTimeElapsedBadges() {
    const timeElapsedBadges = document.querySelectorAll('.time-elapsed-badge');
    const now = new Date();
    
    timeElapsedBadges.forEach(badge => {
        const createdDateStr = badge.getAttribute('data-created');
        const elapsedText = badge.querySelector('.elapsed-text');
        
        if (!createdDateStr || !elapsedText) {
            console.log('Missing data for time elapsed badge');
            return;
        }
        
        try {
            const createdDate = new Date(createdDateStr);
            
            // Check if date is valid
            if (isNaN(createdDate.getTime())) {
                console.log('Invalid date:', createdDateStr);
                elapsedText.textContent = 'Invalid date';
                return;
            }
            
            const diffMs = now - createdDate;
            const diffSeconds = Math.floor(diffMs / 1000);
            const diffMinutes = Math.floor(diffSeconds / 60);
            const diffHours = Math.floor(diffMinutes / 60);
            const diffDays = Math.floor(diffHours / 24);
            
            // Format the elapsed time
            let elapsedTextValue = '';
            let badgeClass = 'time-elapsed-badge';
            
            if (diffDays > 0) {
                if (diffDays === 1) {
                    elapsedTextValue = '1 day ago';
                    badgeClass += ' time-medium';
                } else if (diffDays < 7) {
                    elapsedTextValue = `${diffDays} days ago`;
                    badgeClass += ' time-medium';
                } else if (diffDays < 30) {
                    const weeks = Math.floor(diffDays / 7);
                    elapsedTextValue = `${weeks} week${weeks > 1 ? 's' : ''} ago`;
                    badgeClass += ' time-old';
                } else if (diffDays < 365) {
                    const months = Math.floor(diffDays / 30);
                    elapsedTextValue = `${months} month${months > 1 ? 's' : ''} ago`;
                    badgeClass += ' time-old';
                } else {
                    const years = Math.floor(diffDays / 365);
                    elapsedTextValue = `${years} year${years > 1 ? 's' : ''} ago`;
                    badgeClass += ' time-old';
                }
            } else if (diffHours > 0) {
                if (diffHours === 1) {
                    elapsedTextValue = '1 hour ago';
                } else {
                    elapsedTextValue = `${diffHours} hours ago`;
                }
                badgeClass += ' time-recent';
            } else if (diffMinutes > 0) {
                if (diffMinutes === 1) {
                    elapsedTextValue = '1 minute ago';
                } else if (diffMinutes < 5) {
                    elapsedTextValue = `${diffMinutes} minutes ago`;
                } else if (diffMinutes < 60) {
                    elapsedTextValue = `${diffMinutes} minutes ago`;
                }
                badgeClass += ' time-recent';
            } else {
                elapsedTextValue = 'Just now';
                badgeClass += ' time-recent';
            }
            
            // Update the element
            elapsedText.textContent = elapsedTextValue;
            badge.className = badgeClass;
            badge.style.display = 'inline-flex';
            
        } catch (e) {
            console.error('Error calculating time elapsed:', e, 'Date string:', createdDateStr);
            elapsedText.textContent = 'Time error';
            badge.className = 'time-elapsed-badge';
            badge.style.display = 'inline-flex';
        }
    });
}
    
    function setupDirectoryTabs() {
        // Your existing directory tabs code
        const tabs = document.querySelectorAll('.directory-tab');
        tabs.forEach(tab => {
            tab.addEventListener('click', function() {
                const tabName = this.getAttribute('data-tab');
                
                // Update active tab
                tabs.forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                
                // Show corresponding list
                document.querySelectorAll('.employee-list, .lead-list').forEach(list => {
                    list.classList.remove('active');
                });
                document.getElementById(tabName === 'employees' ? 'employeeList' : 'leadList').classList.add('active');
                
                // Update count
                const countElement = document.getElementById('activeTabCount');
                if (tabName === 'employees') {
                    countElement.textContent = employees.length;
                } else {
                    countElement.textContent = leads.length;
                }
            });
        });
        
        console.log('📁 Directory tabs initialized');
    }
    
    function setupDirectorySearch() {
        // Your existing directory search code
        const searchInput = document.getElementById('directorySearch');
        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const activeTab = document.querySelector('.directory-tab.active').getAttribute('data-tab');
            const items = activeTab === 'employees' ? 
                document.querySelectorAll('.employee-item') : 
                document.querySelectorAll('.lead-item');
            
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(searchTerm) ? 'flex' : 'none';
            });
        });
        
        console.log('🔍 Directory search initialized');
    }
    
    function setupPriorityFilter() {
        // Your existing priority filter code
        const filterSelect = document.getElementById('priorityFilter');
        filterSelect.addEventListener('change', function() {
            const selectedPriority = this.value;
            const leadItems = document.querySelectorAll('.lead-item');
            
            leadItems.forEach(item => {
                const priority = item.getAttribute('data-priority');
                if (selectedPriority === 'all' || priority === selectedPriority) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        });
        
        console.log('🎯 Priority filter initialized');
    }
    
    function initializePagination() {
        // Your existing pagination code
        console.log('📄 Pagination initialized');
    }
    
    function setupEventListeners() {
        // Clear form functionality
        clearFormBtn.addEventListener('click', function() {
            if (confirm('Are you sure you want to clear all form fields?')) {
                clearForm();
            }
        });
        
        // Toggle event listener
        customerTypeToggle.addEventListener('change', initializeToggle);
        
        console.log('🎮 Event listeners setup complete');
    }

    // ========== REQUIREMENTS DISPLAY FUNCTIONS ==========
    
    /**
     * Enhanced function to populate lead requirements in directory
     * Call this after form submission or when requirements are updated
     */
    function updateLeadRequirementsDisplay(leadId, requirementsData) {
        const leadItem = document.querySelector(`.lead-item[data-id="${leadId}"]`);
        
        if (!leadItem) {
            console.log('Lead item not found for ID:', leadId);
            return;
        }
        
        // Use the data-requirements-count if available, otherwise count from data
        let requirementsCount = parseInt(leadItem.getAttribute('data-requirements-count') || 0);
        
        // If we have requirementsData parameter, use its length instead
        if (requirementsData && Array.isArray(requirementsData)) {
            requirementsCount = requirementsData.length;
            // Update the stored count
            leadItem.setAttribute('data-requirements-count', requirementsCount);
            leadItem.setAttribute('data-requirements', JSON.stringify(requirementsData));
        }
        
        // Create or update requirements badge
        let badge = leadItem.querySelector('.lead-requirements-badge');
        
        if (!badge) {
            badge = document.createElement('div');
            badge.className = 'lead-requirements-badge';
            
            // Insert badge after lead-info-row
            const leadDetails = leadItem.querySelector('.lead-details');
            if (leadDetails) {
                leadDetails.appendChild(badge);
            }
        }
        
        // Update badge content and styling
        if (requirementsCount > 0) {
            badge.className = 'lead-requirements-badge has-requirements';
            badge.innerHTML = `
                <i class="fas fa-box"></i>
                <span>${requirementsCount} item${requirementsCount !== 1 ? 's' : ''}</span>
            `;
            
            // Add has-requirements class to lead item
            leadItem.classList.add('has-requirements');
            
            // Add tooltip with requirement details if we have the data
            if (requirementsData && requirementsData.length > 0) {
                const tooltip = document.createElement('div');
                tooltip.className = 'requirements-tooltip';
                
                requirementsData.forEach((req, index) => {
                    const item = document.createElement('div');
                    item.className = 'requirements-tooltip-item';
                    const price = parseFloat(req.price || 0);
                    const qty = parseInt(req.quantity || 1);
                    const total = price * qty;
                    
                    item.innerHTML = `
                        <strong>${index + 1}. ${req.item_name || 'Item'}</strong><br>
                        <small>Qty: ${qty} × ₹${price.toFixed(2)} = ₹${total.toFixed(2)}</small>
                    `;
                    tooltip.appendChild(item);
                });
                
                badge.appendChild(tooltip);
            }
            
            console.log(`✅ Updated lead ${leadId} with ${requirementsCount} requirements`);
        } else {
            badge.className = 'lead-requirements-badge no-requirements';
            badge.innerHTML = `
                <i class="fas fa-box"></i>
                <span>No items</span>
            `;
            
            leadItem.classList.remove('has-requirements');
            
            console.log(`✅ Cleared requirements for lead ${leadId}`);
        }
    }
    
    /**
     * Initialize requirements display for all leads on page load
     */
    function initializeAllLeadRequirements() {
        console.log('🔄 Initializing requirements display for all leads...');
        
        const leadItems = document.querySelectorAll('.lead-item');
        let updatedCount = 0;
        
        leadItems.forEach(leadItem => {
            const leadId = leadItem.getAttribute('data-id');
            const requirementsJson = leadItem.getAttribute('data-requirements');
            
            if (requirementsJson) {
                try {
                    const requirements = JSON.parse(requirementsJson);
                    updateLeadRequirementsDisplay(leadId, requirements);
                    updatedCount++;
                } catch (error) {
                    console.error(`Error parsing requirements for lead ${leadId}:`, error);
                }
            }
        });
        
        console.log(`✅ Initialized requirements for ${updatedCount} leads`);
    }
    
    /**
     * Get current requirements from the form table
     */
    function getCurrentRequirementsFromForm() {
        const requirements = [];
        const tableBody = document.getElementById('table-body');
        
        if (!tableBody) return requirements;
        
        const rows = tableBody.querySelectorAll('tr');
        
        rows.forEach(row => {
            const itemSelect = row.querySelector('.item-select');
            const sectionSelect = row.querySelector('.section-select');
            const unitInput = row.querySelector('.unit-input');
            const priceInput = row.querySelector('.price-input');
            const qtyInput = row.querySelector('.qty-input');
            
            if (itemSelect && itemSelect.value) {
                const selectedOption = itemSelect.options[itemSelect.selectedIndex];
                
                requirements.push({
                    item_id: itemSelect.value,
                    item_name: selectedOption.textContent,
                    section: sectionSelect ? sectionSelect.value : '',
                    unit: unitInput ? unitInput.value : '',
                    price: priceInput ? parseFloat(priceInput.value) || 0 : 0,
                    quantity: qtyInput ? parseInt(qtyInput.value) || 1 : 1
                });
            }
        });
        
        return requirements;
    }
    
    /**
     * Update selected lead's requirements when form requirements change
     */
    function updateSelectedLeadRequirements() {
        const selectedLead = document.querySelector('.lead-item.selected');
        
        if (selectedLead) {
            const leadId = selectedLead.getAttribute('data-id');
            const currentRequirements = getCurrentRequirementsFromForm();
            
            updateLeadRequirementsDisplay(leadId, currentRequirements);
            
            console.log(`✅ Updated requirements for selected lead ${leadId}:`, currentRequirements.length);
        }
    }
    
    // Watch for changes in requirements table
    if (tableBody) {
        // Use MutationObserver to detect changes
        const observer = new MutationObserver(function(mutations) {
            updateSelectedLeadRequirements();
        });
        
        observer.observe(tableBody, {
            childList: true,
            subtree: true,
            attributes: false
        });
        
        console.log('👀 Requirements change observer activated');
    }
    
    // Also update when items are added/removed
    document.addEventListener('click', function(e) {
        if (e.target.closest('#add-item-btn') || e.target.closest('.remove-btn')) {
            setTimeout(updateSelectedLeadRequirements, 100);
        }
    });
    
    // Update when item selections change
    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('item-select') || 
            e.target.classList.contains('qty-input') || 
            e.target.classList.contains('price-input')) {
            setTimeout(updateSelectedLeadRequirements, 100);
        }
    });

});

// Global functions
window.closeApiCustomerDetails = closeApiCustomerDetails;

// Display campaign details function
window.displayCampaignDetails = function(selectElement) {
    const selectedOption = selectElement.options[selectElement.selectedIndex];
    const campaignId = selectedOption.value;
    
    if (campaignId && campaignMap[campaignId]) {
        const campaign = campaignMap[campaignId];
        showNotification(`Selected: ${campaign.displayName}`, 'info');
    }
};

// Test function
window.testLeadClick = function() {
    const firstLead = document.querySelector('.lead-item');
    if (firstLead) {
        firstLead.click();
        console.log('Test: Clicked first lead');
        return true;
    }
    console.log('Test: No leads found');
    return false;
};

// Make requirements functions globally accessible
window.updateLeadRequirementsDisplay = updateLeadRequirementsDisplay;
window.initializeAllLeadRequirements = initializeAllLeadRequirements;
window.getCurrentRequirementsFromForm = getCurrentRequirementsFromForm;
window.updateSelectedLeadRequirements = updateSelectedLeadRequirements;

</script>
</body>
</html>
{% endblock %}