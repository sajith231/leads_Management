{% extends "base.html" %}

{% block title %}Edit Service Invoice{% endblock %}

{% block content %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Service Invoice</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* Use the same styles as service_billing.html */
        :root {
            --primary: #0062cc;
            --secondary: #0095ff;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --info: #17a2b8;
            --light: #f8f9fa;
            --dark: #343a40;
            --gray: #6c757d;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 15px;
        }
        
        .page-header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .form-section {
            background: #fbf5df;
            border: 2px solid #8b8d0c;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            margin-bottom: 25px;
        }
        
        .service-item {
            background: #f3cfea;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid #94097f;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border: none;
            padding: 10px 20px;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="page-header">
            <div class="header-content">
                <div>
                    <h2 class="mb-1"><i class="fas fa-edit me-2"></i> Edit Service Invoice</h2>
                    <p class="mb-0">Edit invoice for ticket: {{ service_billing.ticket_no }} - Technician: {{ current_user_name }}</p>
                </div>
            </div>
        </div>

        <div class="form-section">
            <h4 class="mb-4"><i class="fas fa-edit me-2"></i>Edit Billing Information</h4>
            
            <form id="billingForm" method="POST">
                {% csrf_token %}
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">Ticket Number</label>
                        <input type="text" class="form-control" value="{{ service_billing.ticket_no }}" readonly>
                        <input type="hidden" name="ticketNo" value="{{ service_billing.ticket_no }}">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Invoice Date</label>
                        <input type="date" class="form-control" id="date" name="date" 
                               value="{{ service_billing.date|date:'Y-m-d' }}" required>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label class="form-label">Customer Name</label>
                        <input type="text" class="form-control" id="customerName" name="customerName" 
                               value="{{ service_billing.customer_name }}"readonly required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Customer Contact</label>
                        <input type="text" class="form-control" id="customerContact" name="customerContact" 
                               value="{{ service_billing.customer_contact }}" readonly required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Payment Status</label>
                        <select class="form-select" name="paymentStatus" required>
                            <option value="pending" {% if service_billing.payment_status == 'pending' %}selected{% endif %}>Pending</option>
                            <option value="paid" {% if service_billing.payment_status == 'paid' %}selected{% endif %}>Paid</option>
                            <option value="partial" {% if service_billing.payment_status == 'partial' %}selected{% endif %}>Partial Payment</option>
                        </select>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-12">
                        <label class="form-label">Customer Address</label>
                        <textarea class="form-control" id="customerAddress" name="customerAddress" rows="2" readonly>{{ service_billing.customer_address }}</textarea>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-12">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">Service Items & Charges</h5>
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="addServiceItem()">
                                <i class="fas fa-plus"></i> Add Item
                            </button>
                        </div>
                        
                        <div id="serviceItemsContainer">
                            {% for item in invoice_items %}
                            <div class="service-item">
                                <div class="row">
                                    <div class="col-md-3">
                                        <label class="form-label">Item Name</label>
                                        <input type="text" class="form-control" name="itemName[]" 
                                               value="{{ item.item_name }} " placeholder="e.g., Laptop, Printer" readonly required>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">Serial No</label>
                                        <input type="text" class="form-control" name="itemSerial[]" 
                                               value="{{ item.serial_no }}" placeholder="Serial number" readonly>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Service Description</label>
                                        <input type="text" class="form-control" name="serviceDescription[]" 
                                               value="{{ item.service_description }} " placeholder="e.g., Screen replacement, Software installation"  readonly required>
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">Charge (₹)</label>
                                        <input type="number" class="form-control service-charge" name="serviceCharge[]" 
                                               value="{{ item.charge }}" min="0" step="0.01" placeholder="0.00" required>
                                    </div>
                                    <div class="col-md-1">
                                        <label class="form-label">&nbsp;</label>
                                        <button type="button" class="btn btn-sm btn-danger w-100" onclick="removeServiceItem(this)" 
                                                style="margin-top: 8px;">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                
                <div class="row mb-4">
                    <div class="col-12">
                        <label class="form-label">Additional Notes</label>
                        <textarea class="form-control" name="notes" rows="3" 
                                  placeholder="Any additional notes or terms...">{{ service_billing.notes }}</textarea>
                    </div>
                </div>
                
                <div class="totals-section mb-4">
                    <div class="row">
                        <div class="col-md-3">
                            <strong>Subtotal: ₹<span id="subtotal">{{ service_billing.subtotal|floatformat:2 }}</span></strong>
                        </div>
                        <div class="col-md-3">
                            <strong>Tax (10%): ₹<span id="tax">{{ service_billing.tax|floatformat:2 }}</span></strong>
                        </div>
                        <div class="col-md-3">
                            <strong>Total: ₹<span id="total">{{ service_billing.total|floatformat:2 }}</span></strong>
                        </div>
                        <div class="col-md-3 text-end">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>Update Invoice
                            </button>
                            <a href="{% url 'app5:service_billing_list' %}" class="btn btn-secondary">
                                <i class="fas fa-times me-2"></i>Cancel
                            </a>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Use the same JavaScript functions as service_billing.html for dynamic item management
        document.addEventListener('DOMContentLoaded', function() {
            // Add event listener for service charge changes
            document.addEventListener('input', function(e) {
                if (e.target.classList.contains('service-charge')) {
                    calculateTotals();
                }
            });
            
            calculateTotals();
        });
        
        function addServiceItem() {
            const container = document.getElementById('serviceItemsContainer');
            const serviceItem = document.createElement('div');
            serviceItem.className = 'service-item';
            serviceItem.innerHTML = `
                <div class="row">
                    <div class="col-md-3">
                        <label class="form-label">Item Name</label>
                        <input type="text" class="form-control" name="itemName[]" placeholder="e.g., Laptop, Printer" required>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Serial No</label>
                        <input type="text" class="form-control" name="itemSerial[]" placeholder="Serial number">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Service Description</label>
                        <input type="text" class="form-control" name="serviceDescription[]" placeholder="e.g., Screen replacement, Software installation" required>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Charge (₹)</label>
                        <input type="number" class="form-control service-charge" name="serviceCharge[]" min="0" step="0.01" placeholder="0.00" required>
                    </div>
                    <div class="col-md-1">
                        <label class="form-label">&nbsp;</label>
                        <button type="button" class="btn btn-sm btn-danger w-100" onclick="removeServiceItem(this)" style="margin-top: 8px;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            `;
            container.appendChild(serviceItem);
            calculateTotals();
        }
        
        function removeServiceItem(button) {
            const serviceItem = button.closest('.service-item');
            if (document.querySelectorAll('.service-item').length > 1) {
                serviceItem.remove();
                calculateTotals();
            } else {
                alert('At least one service item is required.');
            }
        }
        
        function calculateTotals() {
            let subtotal = 0;
            const chargeInputs = document.querySelectorAll('.service-charge');
            
            chargeInputs.forEach(input => {
                const value = parseFloat(input.value) || 0;
                subtotal += value;
            });
            
            const tax = subtotal * 0.1;
            const total = subtotal + tax;
            
            document.getElementById('subtotal').textContent = subtotal.toFixed(2);
            document.getElementById('tax').textContent = tax.toFixed(2);
            document.getElementById('total').textContent = total.toFixed(2);
        }
    </script>
</body>
</html>
{% endblock %}