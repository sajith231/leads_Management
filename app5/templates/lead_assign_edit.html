{% extends "base.html" %}

{% block title %}Assign / Edit Lead{% endblock %}

{% block content %}
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Assign Lead</title>

<style>
  body { font-family: "Segoe UI", sans-serif; background-color: #f8f9fa; padding: 20px; }
  .assign-form-container { max-width: 700px; margin: 30px auto; background: #fff; padding: 25px 35px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
  h2 { font-size: 22px; color: #333; margin-bottom: 15px; text-align: center; }
  label { font-weight: 600; display: block; margin-bottom: 6px; color: #444; }
  select, input[type="text"], input[type="number"] { width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #ccc; background-color: #fff; font-size: 15px; margin-bottom: 15px; }
  select:focus { border-color: #007bff; outline: none; }
  button { background-color: #007bff; color: white; border: none; border-radius: 6px; padding: 10px 18px; font-size: 15px; cursor: pointer; }
  button:hover { background-color: #0056b3; }
  .btn-secondary { background-color: #6c757d; color: #fff; padding: 10px 14px; border-radius: 6px; text-decoration: none; display: inline-block; margin-left: 8px; }
  .btn-secondary:hover { background-color: #565e64; }
  .form-group { margin-bottom: 20px; }
  .alert { padding: 10px; border-radius: 5px; margin-bottom: 15px; }
  .alert-success { background-color: #d1e7dd; color: #0f5132; }
  .alert-error { background-color: #f8d7da; color: #842029; }
  .muted { color: #6c757d; font-size: 13px; }
</style>

<div class="assign-form-container">
  <h2>ðŸŽ¯ {% if lead %}Edit Assignment{% else %}Assign Lead{% endif %}</h2>

  {# Messages #}
  {% if messages %}
    {% for message in messages %}
      <div class="alert {% if message.tags == 'success' %}alert-success{% else %}alert-error{% endif %}">
        {{ message }}
      </div>
    {% endfor %}
  {% endif %}

  {# Choose form action depending on whether we're editing or creating #}
  {% if lead %}
    <form method="POST" action="{% url 'app5:lead_assign_edit' lead.id %}">
  {% else %}
    <form method="POST" action="{% url 'app5:assign_lead' %}">
  {% endif %}
    {% csrf_token %}

    {# Lead selection / display #}
    <div class="form-group">
      <label for="lead_id">ðŸŽ« Lead</label>

      {% if lead %}
        {# Show uneditable lead label and include hidden lead_id so view receives it #}
        <input type="text" id="lead_label" value="{% if lead.ticket_number %}{{ lead.ticket_number }}{% elif lead.ownerName %}{{ lead.ownerName }}{% else %}Lead #{{ lead.id }}{% endif %}" readonly>
        <input type="hidden" name="lead_id" value="{{ lead.id }}">
        <div class="muted" style="margin-top:6px;">
          {% if lead.ownerName %}Customer: <strong>{{ lead.ownerName }}</strong>{% endif %}
        </div>
      {% else %}
        <select id="lead_id" name="lead_id" required>
          <option value="">-- Select Unassigned Lead --</option>
          {% for lead_item in unassigned_leads %}
            <option value="{{ lead_item.id }}">
              {% if lead_item.ticket_number %}{{ lead_item.ticket_number }}{% else %}Lead #{{ lead_item.id }}{% endif %}
            </option>
          {% empty %}
            <option value="" disabled>No unassigned leads available</option>
          {% endfor %}
        </select>
      {% endif %}
    </div>

    {# Assign To field (users list expected in context) #}
    <div class="form-group">
      <label for="assign_to">ðŸ‘¤ Assign To</label>
      <select id="assign_to" name="assigned_to" required>
        <option value="">-- Select User --</option>
        {% for user in users %}
          {# Determine a friendly display name for the user - FIXED SYNTAX #}
          {% if user.name %}
            {% with display_name=user.name %}
              <option value="{{ user.id }}"
                {% if lead %}
                  {# Try a few safe fallbacks to pre-select the current assigned user #}
                  {% if lead.assigned_to and lead.assigned_to.id == user.id %}
                    selected
                  {% elif lead.assigned_to_name and lead.assigned_to_name == display_name %}
                    selected
                  {% elif lead.assigned_to and lead.assigned_to|stringformat:"s" == user.id|stringformat:"s" %}
                    selected
                  {% endif %}
                {% endif %}
              >
                {{ display_name }}
              </option>
            {% endwith %}
          {% elif user.first_name or user.last_name %}
            {% with display_name=user.first_name|add:" "|add:user.last_name %}
              <option value="{{ user.id }}"
                {% if lead %}
                  {# Try a few safe fallbacks to pre-select the current assigned user #}
                  {% if lead.assigned_to and lead.assigned_to.id == user.id %}
                    selected
                  {% elif lead.assigned_to_name and lead.assigned_to_name == display_name %}
                    selected
                  {% elif lead.assigned_to and lead.assigned_to|stringformat:"s" == user.id|stringformat:"s" %}
                    selected
                  {% endif %}
                {% endif %}
              >
                {{ display_name }}
              </option>
            {% endwith %}
          {% elif user.get_full_name %}
            {% with display_name=user.get_full_name %}
              <option value="{{ user.id }}"
                {% if lead %}
                  {# Try a few safe fallbacks to pre-select the current assigned user #}
                  {% if lead.assigned_to and lead.assigned_to.id == user.id %}
                    selected
                  {% elif lead.assigned_to_name and lead.assigned_to_name == display_name %}
                    selected
                  {% elif lead.assigned_to and lead.assigned_to|stringformat:"s" == user.id|stringformat:"s" %}
                    selected
                  {% endif %}
                {% endif %}
              >
                {{ display_name }}
              </option>
            {% endwith %}
          {% elif user.username %}
            {% with display_name=user.username %}
              <option value="{{ user.id }}"
                {% if lead %}
                  {# Try a few safe fallbacks to pre-select the current assigned user #}
                  {% if lead.assigned_to and lead.assigned_to.id == user.id %}
                    selected
                  {% elif lead.assigned_to_name and lead.assigned_to_name == display_name %}
                    selected
                  {% elif lead.assigned_to and lead.assigned_to|stringformat:"s" == user.id|stringformat:"s" %}
                    selected
                  {% endif %}
                {% endif %}
              >
                {{ display_name }}
              </option>
            {% endwith %}
          {% elif user.email %}
            {% with display_name=user.email %}
              <option value="{{ user.id }}"
                {% if lead %}
                  {# Try a few safe fallbacks to pre-select the current assigned user #}
                  {% if lead.assigned_to and lead.assigned_to.id == user.id %}
                    selected
                  {% elif lead.assigned_to_name and lead.assigned_to_name == display_name %}
                    selected
                  {% elif lead.assigned_to and lead.assigned_to|stringformat:"s" == user.id|stringformat:"s" %}
                    selected
                  {% endif %}
                {% endif %}
              >
                {{ display_name }}
              </option>
            {% endwith %}
          {% else %}
            {% with display_name="User #"|add:user.id|stringformat:"s" %}
              <option value="{{ user.id }}"
                {% if lead %}
                  {# Try a few safe fallbacks to pre-select the current assigned user #}
                  {% if lead.assigned_to and lead.assigned_to.id == user.id %}
                    selected
                  {% elif lead.assigned_to_name and lead.assigned_to_name == display_name %}
                    selected
                  {% elif lead.assigned_to and lead.assigned_to|stringformat:"s" == user.id|stringformat:"s" %}
                    selected
                  {% endif %}
                {% endif %}
              >
                {{ display_name }}
              </option>
            {% endwith %}
          {% endif %}
        {% empty %}
          <option value="" disabled>No active users available</option>
        {% endfor %}
      </select>

      {% if not users %}
        <small style="color: #dc3545;">No active users found. Please contact administrator.</small>
      {% endif %}
    </div>


    <div style="text-align:center;">
      <button type="submit">{% if lead %}âœ… Update Assignment{% else %}âœ… Assign Lead{% endif %}</button>

      {# Back link - if editing go back to assign list, otherwise to assign list too #}
      <a href="{% url 'app5:lead_assign_list' %}" class="btn-secondary">â¬… Back to List</a>
    </div>
  </form>
</div>

{% endblock %}