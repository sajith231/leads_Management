<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Requirements Management</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    body { background: #f0f2f5; min-height: 100vh; }
    .container { max-width: 1600px; width: 100%; margin: 0 auto; padding: 20px; }
    .main-content { display: flex; gap: 20px; align-items: stretch; width: 100%; min-height: 80vh; }
    .directory-column { flex: 0 0 320px; width: 320px; display: flex; flex-direction: column; }
    .form-column { flex: 1; min-width: 0; display: flex; flex-direction: column; }
    .form-container { background-color:#dcd9f3; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.15); overflow: hidden; width: 100%; flex: 1; display: flex; flex-direction: column; }
    .form-header { background:#a095f6; color:black; padding: 15px 20px; text-align: center; }
    .form-header h1 { font-size: 22px; margin-bottom: 5px; font-weight: 700; }
    .form-header p { font-size: 13px; opacity: 0.9; }
    .form-body { padding: 20px; flex: 1; display: flex; flex-direction: column; }
    .form-section { margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px dashed #e0e0e0; }
    #communication-details { background-color:#dbf5dd; border: 2px solid #0ec33f; border-radius: 10px; padding: 20px; box-shadow: 0 3px 10px rgba(37,117,252,0.15); }
    .section-title { font-size: 16px; color: #14ad09; font-weight: bold; margin-bottom: 15px; padding-bottom: 5px; border-bottom: 1px solid #f0f0f0; display: flex; align-items: center; }
    .section-title i { margin-right: 8px; font-size: 16px; }
    .form-row { display: flex; flex-wrap: wrap; margin: 0 -5px; width: 100%; }
    .form-group { flex: 1; min-width: 180px; padding: 0 5px; margin-bottom: 15px; }
    label { display: block; margin-bottom: 5px; font-weight: 600; color: #444; font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    input, select, textarea { width: 100%; padding: 8px 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px; transition: all 0.2s; background-color: #f9f9f9; }
    input:focus, select:focus, textarea:focus { border-color: #6a11cb; box-shadow: 0 0 0 2px rgba(106,17,203,0.1); outline: none; background-color: white; }
    .form-navigation { display: flex; justify-content: center; margin-bottom: 20px; background: white; border-radius: 10px; padding: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); width: 100%; }
    .nav-menu { display: flex; list-style: none; gap: 5px; width: 100%; justify-content: center; flex-wrap: wrap; }
    .nav-item { flex: 1; text-align: center; min-width: 120px; }
    .nav-link { display: block; padding: 12px 15px; text-decoration: none; color: #666; font-weight: 600; border-radius: 8px; transition: all 0.3s ease; border: 2px solid transparent; font-size: 14px; white-space: nowrap; }
    .nav-link:hover { background: linear-gradient(135deg, #f8f9ff, #e8f0ff); color: #4CAF50; border-color: #4CAF50; }
    .nav-link.active { background: linear-gradient(135deg, #4CAF50, #45a049); color: white; border-color: #4CAF50; box-shadow: 0 4px 12px rgba(37,117,252,0.3); transform: translateY(-2px); }
    .nav-link i { margin-right: 8px; font-size: 16px; }
    .requirements-section { background-color: #ffe9cc; border: 2px solid #f8861b; border-radius: 10px; padding: 20px; margin-bottom: 20px; box-shadow: 0 3px 10px rgba(0,0,0,0.08); }
    .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #e5bc08; width: 100%; }
    .section-title-compact { display: flex; align-items: center; font-size: 16px; color: #d29105; font-weight: 700; margin: 0; white-space: nowrap; }
    .section-title-compact i { margin-right: 10px; font-size: 18px; color: #d29105; }
    .add-btn { background: linear-gradient(135deg, #4CAF50, #45a049); color: white; padding: 10px 20px; border: none; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; }
    .add-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 10px rgba(37,117,252,0.4); }
    .table-container { overflow-x: auto; border: 1px solid #f18d0a; border-radius: 8px; background: white; margin-top: 15px; }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th { background-color: #ffe9cc; padding: 12px 10px; text-align: left; font-weight: 600; color: #444; border: 1px solid #f18d0a; }
    td { padding: 10px; border: 1px solid #f18d0a; background: white; }
    tr:hover { background-color: #f9fafb; }
    .total-row { font-weight: bold; background-color: #ffe9cc; }
    .total-row td { border-top: 2px solid #f18d0a; font-size: 14px; }
    .delete-btn { background: #dc3545; color: white; padding: 6px 10px; border: none; border-radius: 4px; font-size: 12px; cursor: pointer; width: 100%; }
    .delete-btn:hover { background: #c82333; }
    .btn-group { display: flex; justify-content: center; margin-top: auto; gap: 10px; width: 100%; padding-top: 20px; }
    button { padding: 10px 20px;background-color: #0ec33f;color: #ffffff; border: none; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; }
    .submit-btn { background: linear-gradient(135deg, #4CAF50, #45a049); color: white; box-shadow: 0 3px 8px rgba(37,117,252,0.3); }
    .submit-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 10px rgba(37,117,252,0.4); }
    .back-btn { background-color: #4CAF50; color: #faf9f9; border: 1px solid #ddd; text-decoration: none; display: flex; align-items: center; justify-content: center; }
    .back-btn:hover { background-color: #4CAF50; }

    /* Lead Directory Styles */
    .lead-directory-container { background: white; border-radius: 10px; box-shadow: 0 3px 10px rgba(0,0,0,0.08); overflow: hidden; height: 100%; display: flex; flex-direction: column; }
    .directory-header { background: #4a6fdc; color: white; padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; }
    .directory-header h2 { font-size: 16px; font-weight: 600; }
    .directory-info { font-size: 12px; opacity: 0.9; }
    .directory-tabs { display: flex; background: #f8f9fa; border-bottom: 1px solid #e9ecef; }
    .directory-tab { flex: 1; padding: 10px 12px; text-align: center; background: transparent; border: none; font-weight: 600; font-size: 13px; color: #6c757d; cursor: pointer; transition: all 0.3s; border-bottom: 3px solid transparent; }
    .directory-tab.active { color: #4a6fdc; border-bottom-color: #4a6fdc; background: white; }
    .directory-tab:hover { background: #e9ecef; }
    .search-container { padding: 12px 15px; background: #f8f9fa; border-bottom: 1px solid #e9ecef; }
    .search-box { position: relative; width: 100%; }
    .search-box input { padding: 8px 12px 8px 35px; border: 1px solid #ddd; border-radius: 8px; font-size: 13px; width: 100%; background: white; }
    .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #6c757d; font-size: 13px; }
    .employee-list, .lead-list { flex: 1; overflow-y: auto; padding: 8px 0; display: none; }
    .employee-list.active, .lead-list.active { display: block; }
    .employee-item, .lead-item { display: flex; align-items: center; padding: 12px 15px; border-bottom: 1px solid #f0f0f0; transition: background 0.2s; cursor: pointer; }
    .lead-item.selected { background: #e3f2fd; border-left: 4px solid #2575fc; }
    .employee-item:hover, .lead-item:hover { background: #f8f9fa; }
    .employee-avatar, .lead-avatar { width: 32px; height: 32px; border-radius: 50%; background: #4a6fdc; color: white; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 12px; margin-right: 12px; flex-shrink: 0; }
    .lead-avatar { background: #28a745; }
    .employee-details, .lead-details { flex: 1; min-width: 0; }
    .employee-name, .lead-name { font-weight: 600; color: #333; margin-bottom: 2px; font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .employee-role, .lead-info { font-size: 12px; color: #6c757d; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .lead-phone { font-size: 11px; color: #495057; margin-top: 1px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .lead-ticket { font-size: 10px; color: #6c757d; background: #f8f9fa;  border-radius: 4px; display: inline-block; margin-top: 2px; }
    .lead-status { font-size: 10px; color: #28a745; font-weight: 600; margin-top: 2px; }
    .assign-btn { padding: 5px 10px; background: #4CAF50; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer; transition: all 0.2s; flex-shrink: 0; }
    .assign-btn:hover { background: #45a049; }
    .assign-btn.assigned { background: #6c757d; }
    .no-results { padding: 20px 15px; text-align: center; color: #6c757d; font-size: 13px; }

    /* Priority Filter Styles */
    .filter-container { padding: 10px 15px; background: #f8f9fa; border-bottom: 1px solid #ddd; }
    .filter-group { display: flex; align-items: center; gap: 10px; }
    .filter-label { font-size: 13px; font-weight: 600; }
    .filter-select { padding: 6px; border-radius: 8px; }

    /* Pagination Styles */
    .directory-pagination { display: flex; justify-content: center; align-items: center; padding: 12px 15px; background: #f8f9fa; border-top: 1px solid #e9ecef; gap: 10px; }
    .pagination-info { font-size: 12px; color: #6c757d; margin: 0 10px; }
    .pagination-btn { padding: 6px 12px; background: white; border: 1px solid #dee2e6; border-radius: 4px; font-size: 12px; cursor: pointer; transition: all 0.2s; color: #4a6fdc; }
    .pagination-btn:hover:not(:disabled) { background: #4a6fdc; color: white; border-color: #4a6fdc; }
    .pagination-btn:disabled { background: #f8f9fa; color: #6c757d; cursor: not-allowed; }
    .pagination-numbers { display: flex; gap: 5px; }
    .page-number { padding: 6px 10px; background: white; border: 1px solid #dee2e6; border-radius: 4px; font-size: 12px; cursor: pointer; transition: all 0.2s; color: #495057; }
    .page-number.active { background: #4a6fdc; color: white; border-color: #4a6fdc; }
    .page-number:hover:not(.active) { background: #e9ecef; }

    /* Message styles */
    .success-message { background-color: #d4edda; color: #155724; padding: 12px; border-radius: 6px; margin-bottom: 20px; border: 1px solid #c3e6cb; }
    .error-message { background-color: #f8d7da; color: #721c24; padding: 12px; border-radius: 6px; margin-bottom: 20px; border: 1px solid #f5c6cb; }
    .warning-message { background-color: #fff3cd; color: #856404; padding: 12px; border-radius: 6px; margin-bottom: 20px; border: 1px solid #ffeaa7; }

    /* Lead selection styles */
    .lead-selection-hint {
        background: #e3f2fd;
        color: #1976d2;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 12px;
        margin-bottom: 10px;
        border-left: 4px solid #2196f3;
    }

    /* Existing requirements indicator */
    .existing-requirements-info {
        background: #fff3cd;
        color: #856404;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 12px;
        margin-bottom: 10px;
        border-left: 4px solid #ffc107;
    }

    /* Edit mode indicator */
    .edit-mode-indicator {
        background: #d1ecf1;
        color: #0c5460;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 12px;
        margin-bottom: 10px;
        border-left: 4px solid #17a2b8;
    }

    /* Loading spinner */
    .loading-spinner {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid #f3f3f3;
        border-top: 2px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 8px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Section info badge */
    .section-info-badge {
        display: inline-block;
        padding: 3px 8px;
        background: #e3f2fd;
        color: #1976d2;
        border-radius: 12px;
        font-size: 11px;
        margin-left: 8px;
        font-weight: 600;
    }

    @media (max-width: 1200px) {
        .main-content { flex-direction: column; }
        .directory-column { flex: 0 0 auto; width: 100%; }
        .lead-directory-container { height: auto; max-height: 400px; }
    }
    
    @media (max-width: 768px) {
        .container { padding: 10px; }
        .form-row { flex-direction: column; }
        .form-group { min-width: 100%; }
        .nav-menu { flex-direction: column; }
        .nav-item { min-width: 100%; }
        .directory-pagination { flex-wrap: wrap; }
        .directory-header { flex-direction: column; align-items: flex-start; gap: 10px; }
        .employee-item, .lead-item { flex-direction: column; align-items: flex-start; gap: 10px; }
        .assign-btn { align-self: flex-end; }
    }
</style>
</head>
<body>
<div class="container">
    <div class="main-content">
        <!-- Left Column - Lead Directory -->
        <div class="directory-column">
            <div class="lead-directory-container">
                <div class="directory-header">
                    <h2>Lead Management</h2>
                    <div class="directory-info">Showing <span id="activeTabCount">{{ leads_count }}</span> active leads</div>
                </div>
                
                <!-- Directory Tabs -->
                <div class="directory-tabs">
                    <button class="directory-tab active" data-tab="leads">Active Leads</button>
                    <button class="directory-tab" data-tab="employees">Employees</button>
                </div>
                
                <div class="search-container">
                    <div class="search-box">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" id="directorySearch" placeholder="Search by Name/Phone/Ticket...">
                    </div>
                </div>

                <!-- Priority Filter -->
                <div class="filter-container" id="priorityFilterContainer" style="display: block;">
                    <div class="filter-group">
                        <span class="filter-label">Priority:</span>
                        <select id="priorityFilter" class="filter-select">
                            <option value="all">All Priorities</option>
                            <option value="High">游댮 High</option>
                            <option value="Medium">游리 Medium</option>
                            <option value="Low">游릭 Low</option>
                        </select>
                    </div>
                </div>
                
                <!-- Lead List (shown by default) -->
                <div class="lead-list active" id="leadList">
                    {% if active_leads %}
                        {% for lead in active_leads %}
                        <div class="lead-item" data-id="{{ lead.id }}" 
                             data-name="{{ lead.ownerName|default:lead.name|default:'' }}" 
                             data-phone="{{ lead.phoneNo|default:lead.phone|default:'' }}" 
                             data-ticket="{{ lead.ticket_number|default:'' }}"
                             data-priority="{{ lead.priority|default:'Medium' }}"
                             data-requirements-count="{{ lead.requirements_count|default:0 }}">
                            <div class="lead-avatar">
                                {{ lead.ownerName|default:lead.name|default:"L"|slice:":1"|upper }}
                            </div>

                            <div class="lead-details">
                                <div class="lead-name">
                                    <span style="font-size: 16px; margin-right: 5px;">
                                        {% if lead.priority == 'High' %}游댮
                                        {% elif lead.priority == 'Medium' %}游리
                                        {% elif lead.priority == 'Low' %}游릭
                                        {% else %}丘뿉% endif %}
                                    </span>
                                    {{ lead.ownerName|default:lead.name|default:"Unknown" }}
                                </div>
                                <div class="lead-phone">{{ lead.phoneNo|default:lead.phone|default:"" }}</div>
                                <div class="lead-ticket">{{ lead.ticket_number|default:"" }}</div>
                                <div class="lead-status" style="display: flex; justify-content: space-between; align-items: center; margin-top: 5px;">
                                    <span>Status: {{ lead.status|default:"Active" }}</span>
                                    <span style="color: {% if lead.priority == 'High' %}#ff4444{% elif lead.priority == 'Medium' %}#ffaa00{% elif lead.priority == 'Low' %}#44ff44{% else %}#ffaa00{% endif %}; font-weight:bold; font-size: 10px; padding: 2px 6px; border-radius: 10px;">
                                        {{ lead.priority|default:"Medium" }}
                                    </span>
                                </div>
                                {% if lead.requirements_count and lead.requirements_count > 0 %}
                                <div class="lead-requirements-badge" style="margin-top: 3px; font-size: 10px; color: #28a745; font-weight: 600;">
                                    <i class="fas fa-clipboard-list"></i> {{ lead.requirements_count }} requirement(s)
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="no-results">No active leads found</div>
                    {% endif %}
                </div>
                
                <!-- Employee List (hidden by default) -->
                <div class="employee-list" id="employeeList">
                    {% if active_users %}
                        {% for u in active_users %}
                        <div class="employee-item" data-id="{{ u.id }}" data-name="{{ u.name }}">
                            <div class="employee-avatar">
                                {{ u.name|slice:":1"|upper }}
                            </div>

                            <div class="employee-details">
                                <div class="employee-name">{{ u.name }}</div>
                                <div class="employee-role">
                                    {{ u.department }}{% if u.designation %} - {{ u.designation }}{% endif %}
                                </div>
                            </div>

                            <button class="assign-btn" data-id="{{ u.id }}" data-name="{{ u.name }}" data-role="employee-assign">
                                Assign
                            </button>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="no-results">No active users found</div>
                    {% endif %}
                </div>
                
                <!-- Pagination -->
                <div class="directory-pagination" id="directoryPagination">
                    <div class="pagination-buttons">
                        <button class="pagination-btn" id="prevPage" disabled>
                            <i class="fas fa-chevron-left"></i> Prev
                        </button>
                    </div>
                    
                    <div class="pagination-numbers" id="paginationNumbers">
                        <!-- Page numbers will be generated here -->
                    </div>
                    
                    <div class="pagination-info" id="paginationInfo">
                        Page 1 of 1
                    </div>
                    
                    <div class="pagination-buttons">
                        <button class="pagination-btn" id="nextPage" disabled>
                            Next <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column - Requirements Form -->
        <div class="form-column">
            <div class="form-container">
                <div class="form-header">
                    <h1>Requirements Management</h1>
                    <p>Manage your project requirements and items</p>
                    <div class="lead-details-header" style="margin-top: 10px; padding: 10px; background: rgba(255,255,255,0.2); border-radius: 6px;">
                        <div style="display: flex; justify-content: space-between; flex-wrap: wrap; gap: 10px; font-size: 13px;">
                            <div>
                                <strong><i class="fas fa-ticket-alt"></i> Ticket No:</strong> 
                                <span id="header-ticket">-</span>
                            </div>
                            <div>
                                <strong><i class="fas fa-user"></i> Name:</strong> 
                                <span id="header-name">-</span>
                            </div>
                            <div>
                                <strong><i class="fas fa-phone"></i> Phone No:</strong> 
                                <span id="header-phone">-</span>
                            </div>
                            <div>
                                <strong><i class="fas fa-flag"></i> Priority:</strong> 
                                <span id="header-priority">-</span>
                            </div>
                            <div>
                                <strong><i class="fas fa-clipboard-list"></i> Existing Items:</strong> 
                                <span id="header-existing-count">0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Navigation Menu -->
                <div class="form-navigation">
                    <ul class="nav-menu">
                        <li class="nav-item">
                            <a href="{% url 'app5:lead' %}" class="nav-link">
                                <i class="fas fa-phone-alt"></i>
                                Lead Form
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#requirements-section" class="nav-link active">
                                <i class="fas fa-clipboard-list"></i>
                                Requirements
                            </a>
                        </li>
                        <li class="nav-item">
                             <a href="{% url 'app5:event_form' %}" class="nav-link">
                             <i class="fas fa-briefcase"></i>
                             Event
                            </a>
                        </li>
                        <li class="nav-item">
                           <a href="{% url 'app5:quotation_list' %}" class="nav-link">
                          <i class="fas fa-file-invoice"></i>
                           Quotation
                         </a>
                        </li>
                    </ul>
                </div>

                <div class="form-body">
                    {% if messages %}
                        {% for message in messages %}
                            <div class="{{ message.tags|default:'info' }}-message">
                                {{ message }}
                            </div>
                        {% endfor %}
                    {% endif %}
                    
                    <!-- Lead Selection Hint -->
                    <div class="lead-selection-hint" id="leadSelectionHint">
                        <i class="fas fa-info-circle"></i>
                        Please select a lead from the directory to add or view requirements
                    </div>
                    
                    <!-- Existing Requirements Info -->
                    <div class="existing-requirements-info" id="existingRequirementsInfo" style="display: none;">
                        <i class="fas fa-clipboard-check"></i>
                        Loading existing requirements...
                    </div>
                    
                    <!-- Edit Mode Indicator -->
                    <div class="edit-mode-indicator" id="editModeIndicator" style="display: none;">
                        <i class="fas fa-edit"></i>
                        Editing existing requirements for this lead. New items will be added to existing ones.
                    </div>
                    
                    <!-- Section Information -->
                    <!-- <div class="section-info" style="margin-bottom: 15px; padding: 10px; background: #f0f8ff; border-radius: 6px; border-left: 4px solid #4a6fdc;">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                            <div style="font-weight: 600; color: #333;">
                                <i class="fas fa-filter"></i> Available Sections:
                            </div>
                            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                                {% for section, data in section_counts.items %}
                                    <span style="font-size: 12px;">
                                        {{ data.label }}: <span class="section-info-badge">{{ data.count }} items</span>
                                    </span>
                                {% endfor %}
                            </div>
                        </div>
                        <div style="font-size: 11px; color: #666; margin-top: 5px;">
                            <i class="fas fa-lightbulb"></i> Tip: Select a section first to see relevant items
                        </div>
                    </div> -->
                    
                    <!-- ===== Requirements Section (MRP used for price) ===== -->
                    <div class="requirements-section" id="requirements-section">
                        <div class="section-header">
                            <div class="section-title-compact">
                                <i class="fas fa-clipboard-list"></i>
                                <span>Requirements</span>
                            </div>
                            <button type="button" class="add-btn" id="add-item-btn">
                                <i class="fas fa-plus"></i> Add Item
                            </button>
                        </div>

                        <form id="requirements-form" method="POST" action="{% url 'app5:requirement_form' %}">
                            {% csrf_token %}

                            <!-- Hidden fields for communication details -->
                            <input type="hidden" name="owner_name" id="hiddenOwnerName">
                            <input type="hidden" name="phone_no" id="hiddenPhoneNo">
                            <input type="hidden" name="ticket_number" id="hiddenTicketNumber">
                            <input type="hidden" name="priority" id="hiddenPriority">
                            <input type="hidden" name="email_address" id="hiddenEmailAddress" value="">
                            <input type="hidden" name="requirement_ids" id="hiddenRequirementIds" value="">

                         
<template id="item-options">
    {% for it in items %}
        <option value="{{ it.id }}"
            data-unit="{{ it.unit_of_measure }}"
            data-price="{{ it.mrp }}"
            data-section="{{ it.section|default:'GENERAL' }}">
            {{ it.name }}{% if it.section %} - {{ it.section }}{% endif %}
        </option>
    {% endfor %}
</template>

                            <div class="table-container">
                                <table id="requirements-table">
                                    <thead>
                                        <tr>
                                            <th width="5%">Sl.No</th>
                                            <th width="25%">Section</th>
                                            <th width="35%">Item Name</th>
                                            <th width="10%">Unit</th>
                                            <th width="15%">Price</th>
                                            <th width="10%">Qty</th>
                                            <th width="15%">Total</th>
                                            <th width="10%">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="table-body">
                                        <!-- Rows will be added dynamically -->
                                    </tbody>
                                    <tfoot>
                                        <tr class="total-row">
                                            <td colspan="6" style="text-align: right; font-weight:700;">Grand Total:</td>
                                            <td id="grand-total" style="font-weight:700;">0.00</td>
                                            <td></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>

                            <!-- Form Actions -->
                            <div class="btn-group">
                                <button type="submit" class="submit-btn" id="submitRequirementsBtn" disabled>
                                    <i class="fas fa-paper-plane"></i> Save Requirements
                                </button>
                                <button type="button" class="reset-btn" id="clearFormBtn">
                                    <i class="fas fa-times"></i> Clear Form
                                </button>
                                <button type="button" class="back-btn" onclick="window.location.href='{% url 'app5:lead_report' %}'">
                                    <i class="fas fa-arrow-left"></i> Back to Reports
                                </button>
                            </div>
                        </form>
                    </div>
                    <!-- ===== end Requirements Section ===== -->
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Global variables
    let leadRequirementsMap = {{ lead_requirements_map|default:"{}"|safe }};
    let currentLeadTicket = null;
    let isEditMode = false;
    let existingRequirementIds = [];

    // Directory functionality
    document.addEventListener('DOMContentLoaded', function() {
        // Pagination configuration
        const itemsPerPage = 10;
        let currentPage = 1;
        let totalPages = 1;
        let currentItems = [];
        let filteredItems = [];
        
        // Pagination elements
        const prevPageBtn = document.getElementById('prevPage');
        const nextPageBtn = document.getElementById('nextPage');
        const paginationNumbers = document.getElementById('paginationNumbers');
        const paginationInfo = document.getElementById('paginationInfo');
        
        // Lead data
        const leads = [
            {% for lead in active_leads %}
            {
                id: {{ lead.id }},
                ownerName: "{{ lead.ownerName|default:lead.name|default:'Unknown'|escapejs }}",
                phoneNo: "{{ lead.phoneNo|default:lead.phone|default:''|escapejs }}",
                ticket_number: "{{ lead.ticket_number|default:''|escapejs }}",
                status: "{{ lead.status|default:'Active'|escapejs }}",
                priority: "{{ lead.priority|default:'Medium'|escapejs }}",
                requirements_count: {{ lead.requirements_count|default:0 }}
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ];

        // Employee data
        const employees = [
            {% for u in active_users %}
            {
                id: {{ u.id }},
                name: "{{ u.name|escapejs }}",
                department: "{{ u.department|escapejs }}",
                designation: "{{ u.designation|escapejs }}"
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ];

        // Priority filter functionality
        function setupPriorityFilter() {
            const priorityFilter = document.getElementById('priorityFilter');
            
            priorityFilter.addEventListener('change', function() {
                filterDirectoryItemsByPriorityAndSearch(
                    document.getElementById('directorySearch').value.toLowerCase(),
                    this.value
                );
            });
        }

        // Combined filter function for search and priority
        function filterDirectoryItemsByPriorityAndSearch(searchTerm, priority) {
            const activeTab = document.querySelector('.directory-tab.active').getAttribute('data-tab');
            
            if (activeTab === 'employees') {
                currentItems = employees;
            } else {
                currentItems = leads;
            }
            
            // Apply search filter
            if (!searchTerm) {
                filteredItems = [...currentItems];
            } else {
                filteredItems = currentItems.filter(item => {
                    let textContent = '';
                    
                    if (activeTab === 'employees') {
                        textContent = (
                            item.name.toLowerCase() + ' ' + 
                            item.department.toLowerCase() + ' ' + 
                            (item.designation || '').toLowerCase()
                        );
                    } else {
                        textContent = (
                            (item.name || '').toLowerCase() + ' ' + 
                            (item.phoneNo || '').toLowerCase() + ' ' + 
                            (item.ticket_number || '').toLowerCase() + ' ' +
                            (item.priority || '').toLowerCase()
                        );
                    }
                    
                    return textContent.includes(searchTerm);
                });
            }
            
            // Apply priority filter (only for leads tab)
            if (activeTab === 'leads' && priority !== 'all') {
                filteredItems = filteredItems.filter(item => item.priority === priority);
            }
            
            currentPage = 1;
            updatePagination();
        }

        // Initialize pagination
        function initializePagination() {
            const activeTab = document.querySelector('.directory-tab.active').getAttribute('data-tab');
            if (activeTab === 'employees') {
                currentItems = employees;
            } else {
                currentItems = leads;
            }
            
            filteredItems = [...currentItems];
            updatePagination();
        }

        // Update pagination
        function updatePagination() {
            totalPages = Math.ceil(filteredItems.length / itemsPerPage);
            
            // Ensure current page is within bounds
            if (currentPage > totalPages) {
                currentPage = totalPages || 1;
            }
            
            // Update pagination buttons
            prevPageBtn.disabled = currentPage === 1;
            nextPageBtn.disabled = currentPage === totalPages;
            
            // Update pagination info
            const startItem = (currentPage - 1) * itemsPerPage + 1;
            const endItem = Math.min(currentPage * itemsPerPage, filteredItems.length);
            paginationInfo.textContent = `Page ${currentPage} of ${totalPages} (${filteredItems.length} items)`;
            
            // Generate page numbers
            generatePageNumbers();
            
            // Display current page items
            displayCurrentPageItems();
            
            // Update active tab count
            document.getElementById('activeTabCount').textContent = filteredItems.length;
        }

        // Generate page number buttons
        function generatePageNumbers() {
            paginationNumbers.innerHTML = '';
            
            // Show max 5 page numbers
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, startPage + 4);
            
            // Adjust start page if we're near the end
            if (endPage - startPage < 4) {
                startPage = Math.max(1, endPage - 4);
            }
            
            // First page
            if (startPage > 1) {
                const firstPageBtn = document.createElement('button');
                firstPageBtn.className = 'page-number';
                firstPageBtn.textContent = '1';
                firstPageBtn.addEventListener('click', () => goToPage(1));
                paginationNumbers.appendChild(firstPageBtn);
                
                if (startPage > 2) {
                    const ellipsis = document.createElement('span');
                    ellipsis.className = 'pagination-ellipsis';
                    ellipsis.textContent = '...';
                    paginationNumbers.appendChild(ellipsis);
                }
            }
            
            // Page numbers
            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.className = `page-number ${i === currentPage ? 'active' : ''}`;
                pageBtn.textContent = i;
                pageBtn.addEventListener('click', () => goToPage(i));
                paginationNumbers.appendChild(pageBtn);
            }
            
            // Last page
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    const ellipsis = document.createElement('span');
                    ellipsis.className = 'pagination-ellipsis';
                    ellipsis.textContent = '...';
                    paginationNumbers.appendChild(ellipsis);
                }
                
                const lastPageBtn = document.createElement('button');
                lastPageBtn.className = 'page-number';
                lastPageBtn.textContent = totalPages;
                lastPageBtn.addEventListener('click', () => goToPage(totalPages));
                paginationNumbers.appendChild(lastPageBtn);
            }
        }

        // Go to specific page
        function goToPage(page) {
            currentPage = page;
            updatePagination();
        }

        // Display items for current page
        function displayCurrentPageItems() {
            const activeTab = document.querySelector('.directory-tab.active').getAttribute('data-tab');
            const container = activeTab === 'employees' ? document.getElementById('employeeList') : document.getElementById('leadList');
            
            // Clear container
            container.innerHTML = '';
            
            if (filteredItems.length === 0) {
                const noResults = document.createElement('div');
                noResults.className = 'no-results';
                noResults.textContent = 'No items found';
                container.appendChild(noResults);
                return;
            }
            
            // Calculate slice indices
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, filteredItems.length);
            const currentPageItems = filteredItems.slice(startIndex, endIndex);
            
            // Create items
            currentPageItems.forEach(item => {
                if (activeTab === 'employees') {
                    createEmployeeItem(item, container);
                } else {
                    createLeadItem(item, container);
                }
            });
            
            // Re-attach event listeners
            if (activeTab === 'employees') {
                setupEmployeeAssignButtons();
            } else {
                setupLeadViewButtons();
            }
        }

        // Create employee item
        function createEmployeeItem(employee, container) {
            const item = document.createElement('div');
            item.className = 'employee-item';
            item.setAttribute('data-id', employee.id);
            item.setAttribute('data-name', employee.name);
            
            item.innerHTML = `
                <div class="employee-avatar">
                    ${employee.name.slice(0, 1).toUpperCase()}
                </div>
                <div class="employee-details">
                    <div class="employee-name">${employee.name}</div>
                    <div class="employee-role">
                        ${employee.department}${employee.designation ? ' - ' + employee.designation : ''}
                    </div>
                </div>
                <button class="assign-btn" data-id="${employee.id}" data-name="${employee.name}" data-role="employee-assign">
                    Assign
                </button>
            `;
            
            container.appendChild(item);
        }

        // Create lead item with priority display
        function createLeadItem(lead, container) {
            const item = document.createElement('div');
            item.className = 'lead-item';
            item.setAttribute('data-id', lead.id);
            item.setAttribute('data-name', lead.ownerName || lead.name || '');
            item.setAttribute('data-phone', lead.phoneNo || '');
            item.setAttribute('data-ticket', lead.ticket_number || '');
            item.setAttribute('data-priority', lead.priority || 'Medium');
            item.setAttribute('data-requirements-count', lead.requirements_count || 0);
            
            // Get display values
            const displayName = lead.ownerName || lead.name || 'Unknown';
            const displayPhone = lead.phoneNo || '';
            const displayTicket = lead.ticket_number || '';
            const displayStatus = lead.status || 'Active';
            const requirementsCount = lead.requirements_count || 0;
            
            // Priority badge with emoji indicators
            let priorityBadge = '';
            let priorityColor = '';
            let priorityText = lead.priority || 'Medium';
            
            if (priorityText === 'High') {
                priorityBadge = '游댮';
                priorityColor = '#ff4444';
            } else if (priorityText === 'Medium') {
                priorityBadge = '游리';
                priorityColor = '#ffaa00';
            } else if (priorityText === 'Low') {
                priorityBadge = '游릭';
                priorityColor = '#44ff44';
            } else {
                priorityBadge = '游리';
                priorityColor = '#ffaa00';
                priorityText = 'Medium';
            }
            
            item.innerHTML = `
                <div class="lead-avatar">
                    ${displayName.slice(0, 1).toUpperCase()}
                </div>
                <div class="lead-details">
                    <div class="lead-name">
                        <span style="font-size: 16px; margin-right: 5px;">${priorityBadge}</span>
                        ${displayName}
                    </div>
                    <div class="lead-phone">${displayPhone}</div>
                    <div class="lead-ticket">${displayTicket}</div>
                    <div class="lead-status" style="display: flex; justify-content: space-between; align-items: center; margin-top: 5px;">
                        <span>Status: ${displayStatus}</span>
                        <span style="color: ${priorityColor}; font-weight: 600; font-size: 10px; padding: 2px 6px; border-radius: 10px;">
                            ${priorityText}
                        </span>
                    </div>
                    ${requirementsCount > 0 ? `
                    <div class="lead-requirements-badge" style="margin-top: 3px; font-size: 10px; color: #28a745; font-weight: 600;">
                        <i class="fas fa-clipboard-list"></i> ${requirementsCount} requirement(s)
                    </div>
                    ` : ''}
                </div>
            `;
            
            container.appendChild(item);
        }

        // Add event listeners to employee assign buttons
        function setupEmployeeAssignButtons() {
            const employeeAssignButtons = document.querySelectorAll('#employeeList .assign-btn[data-role="employee-assign"]');
            employeeAssignButtons.forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const empId = this.getAttribute('data-id');
                    const empName = this.getAttribute('data-name');

                    // Clear any existing lead selection
                    clearLeadSelection();
                    
                    // Fill the form fields with employee data
                    document.getElementById('header-name').textContent = empName;
                    document.getElementById('header-phone').textContent = '-';
                    document.getElementById('header-ticket').textContent = '-';
                    document.getElementById('header-priority').textContent = '-';
                    document.getElementById('header-existing-count').textContent = '0';
                    
                    // Update hidden fields
                    document.getElementById('hiddenOwnerName').value = empName;
                    document.getElementById('hiddenPhoneNo').value = '';
                    document.getElementById('hiddenTicketNumber').value = '';
                    document.getElementById('hiddenPriority').value = '';
                    document.getElementById('hiddenEmailAddress').value = '';
                    
                    // Clear existing requirements
                    clearRequirementsTable();
                    
                    // Show/hide appropriate messages
                    document.getElementById('leadSelectionHint').style.display = 'none';
                    document.getElementById('existingRequirementsInfo').style.display = 'none';
                    document.getElementById('editModeIndicator').style.display = 'none';
                    
                    // Enable submit button
                    document.getElementById('submitRequirementsBtn').disabled = false;
                    
                    showTemporaryMessage(`Employee "${empName}" assigned`, 'success');
                });
            });
        }

        // Add event listeners to lead items for click functionality
        function setupLeadViewButtons() {
            const leadItems = document.querySelectorAll('#leadList .lead-item');
            leadItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    e.stopPropagation();
                    
                    // Remove previous selection
                    leadItems.forEach(i => i.classList.remove('selected'));
                    
                    // Add selection to current item
                    this.classList.add('selected');
                    
                    const leadOwnerName = this.getAttribute('data-name') || '-';
                    const leadPhoneNo = this.getAttribute('data-phone') || '-';
                    const leadTicket = this.getAttribute('data-ticket') || '-';
                    const leadPriority = this.getAttribute('data-priority') || '-';
                    const requirementsCount = parseInt(this.getAttribute('data-requirements-count') || 0);

                    // Set current lead ticket
                    currentLeadTicket = leadTicket;
                    
                    // Update header display
                    document.getElementById('header-name').textContent = leadOwnerName || '-';
                    document.getElementById('header-phone').textContent = leadPhoneNo || '-';
                    document.getElementById('header-ticket').textContent = leadTicket || '-';
                    document.getElementById('header-priority').textContent = leadPriority || '-';
                    document.getElementById('header-existing-count').textContent = requirementsCount || '0';
                    
                    // Update hidden fields
                    document.getElementById('hiddenOwnerName').value = leadOwnerName || '';
                    document.getElementById('hiddenPhoneNo').value = leadPhoneNo || '';
                    document.getElementById('hiddenTicketNumber').value = leadTicket || '';
                    document.getElementById('hiddenPriority').value = leadPriority || '';
                    document.getElementById('hiddenEmailAddress').value = '';
                    
                    // Show/hide appropriate messages
                    document.getElementById('leadSelectionHint').style.display = 'none';
                    
                    // Load existing requirements for this lead
                    if (requirementsCount > 0) {
                        document.getElementById('existingRequirementsInfo').style.display = 'block';
                        document.getElementById('existingRequirementsInfo').innerHTML = `
                            <i class="fas fa-clipboard-check"></i>
                            Loading ${requirementsCount} existing requirement(s)...
                        `;
                        document.getElementById('editModeIndicator').style.display = 'block';
                        isEditMode = true;
                    } else {
                        document.getElementById('existingRequirementsInfo').style.display = 'none';
                        document.getElementById('editModeIndicator').style.display = 'none';
                        isEditMode = false;
                    }
                    
                    // Load requirements
                    loadLeadRequirements(leadTicket);
                    
                    // Enable submit button
                    document.getElementById('submitRequirementsBtn').disabled = false;
                    
                    showTemporaryMessage(`Lead "${leadOwnerName}" selected`, 'success');
                });
            });
        }

        // Function to load existing requirements
        function loadLeadRequirements(ticketNumber) {
            // Clear existing rows and reset IDs
            clearRequirementsTable();
            existingRequirementIds = [];
            
            // Check if this lead has existing requirements
            if (leadRequirementsMap && leadRequirementsMap[ticketNumber]) {
                const requirements = leadRequirementsMap[ticketNumber];
                
                // Update existing requirements info
                document.getElementById('existingRequirementsInfo').innerHTML = `
                    <i class="fas fa-clipboard-check"></i>
                    Found ${requirements.length} existing requirement(s)
                `;
                
                // Create rows for each requirement
                requirements.forEach((req, index) => {
                    createRowWithData(req);
                    
                    // Store requirement ID if it exists
                    if (req.id) {
                        existingRequirementIds.push(req.id);
                    }
                });
                
                // Update hidden requirement IDs field
                document.getElementById('hiddenRequirementIds').value = existingRequirementIds.join(',');
            } else {
                // No existing requirements, create one empty row
                createRow();
                
                // Update existing requirements info
                if (document.getElementById('existingRequirementsInfo').style.display !== 'none') {
                    document.getElementById('existingRequirementsInfo').innerHTML = `
                        <i class="fas fa-info-circle"></i>
                        No existing requirements found. You can add new ones.
                    `;
                }
            }
            
            // Update serial numbers and grand total
            refreshSlNos();
            recalcGrandTotal();
        }

        // Function to create a row with pre-filled data
        function createRowWithData(requirementData = null) {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="sl-no"></td>
                <td>
                    <select name="section[]" class="item-section-select section-select" 
                        style="width:100%; padding:8px; border:1px solid #ddd; border-radius:6px;">
                        <option value="">-- Select Section --</option>
                        <option value="GENERAL">General</option>
                        <option value="HARDWARE">Hardware</option>
                        <option value="SOFTWARE">Software</option>
                        <option value="PAPER_ROLLS">Paper Rolls</option>
                    </select>
                </td>
                <td>
                    <select name="item_id[]" class="form-control item-select" required disabled>
                        <option value="">-- Select Section First --</option>
                    </select>
                </td>
                <td><input type="text" name="unit[]" class="item-unit" readonly placeholder="Unit"></td>
                <td><input type="number" name="price[]" class="item-price" min="0" step="0.01" placeholder="0.00" required></td>
                <td><input type="number" name="qty[]" class="item-qty" min="1" step="1" value="1" required></td>
                <td class="item-total">0.00</td>
                <td><button type="button" class="delete-row delete-btn"><i class="fas fa-trash"></i></button></td>
            `;
            
            attachRowEvents(tr);
            tbody.appendChild(tr);
            
            // If we have requirement data, pre-fill the row
            if (requirementData) {
                setTimeout(() => {
                    const sectionSelect = tr.querySelector('.section-select');
                    const itemSelect = tr.querySelector('.item-select');
                    const unitInput = tr.querySelector('.item-unit');
                    const priceInput = tr.querySelector('.item-price');
                    const qtyInput = tr.querySelector('.item-qty');
                    
                    // Set section if available
                    if (sectionSelect && requirementData.section) {
                        sectionSelect.value = requirementData.section;
                        // Trigger change to populate items (will filter by section)
                        sectionSelect.dispatchEvent(new Event('change'));
                        
                        // Wait for items to populate
                        setTimeout(() => {
                            if (itemSelect && requirementData.item_name) {
                                // Find the option with matching item name
                                for (let option of itemSelect.options) {
                                    if (option.textContent.includes(requirementData.item_name)) {
                                        itemSelect.value = option.value;
                                        break;
                                    }
                                }
                                
                                // If we found a match, trigger change event
                                if (itemSelect.value) {
                                    itemSelect.dispatchEvent(new Event('change'));
                                    
                                    // Override with requirement data
                                    if (unitInput && requirementData.unit) {
                                        unitInput.value = requirementData.unit;
                                    }
                                    
                                    if (priceInput && requirementData.price) {
                                        priceInput.value = parseFloat(requirementData.price).toFixed(2);
                                    }
                                    
                                    if (qtyInput && requirementData.quantity) {
                                        qtyInput.value = requirementData.quantity;
                                    }
                                    
                                    // Trigger recalculation
                                    recalcRow(tr);
                                }
                            }
                        }, 200);
                    }
                }, 50);
            }
            
            return tr;
        }

        // Clear lead selection
        function clearLeadSelection() {
            const leadItems = document.querySelectorAll('#leadList .lead-item');
            leadItems.forEach(item => item.classList.remove('selected'));
            currentLeadTicket = null;
            isEditMode = false;
            existingRequirementIds = [];
        }

        // Clear requirements table
        function clearRequirementsTable() {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';
            existingRequirementIds = [];
            document.getElementById('hiddenRequirementIds').value = '';
            recalcGrandTotal();
        }

        // Show notification function
        function showTemporaryMessage(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                background: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : '#2196F3'};
                color: white;
                border-radius: 5px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                font-weight: 600;
                transition: all 0.3s ease;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100px)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // Tab switching functionality
        function setupDirectoryTabs() {
            const tabs = document.querySelectorAll('.directory-tab');
            const employeeList = document.getElementById('employeeList');
            const leadList = document.getElementById('leadList');

            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const targetTab = this.getAttribute('data-tab');

                    // Update active tab
                    tabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');

                    // Show/hide appropriate list
                    if (targetTab === 'employees') {
                        employeeList.classList.add('active');
                        leadList.classList.remove('active');
                        // Hide priority filter for employees tab
                        document.getElementById('priorityFilterContainer').style.display = 'none';
                    } else {
                        employeeList.classList.remove('active');
                        leadList.classList.add('active');
                        // Show priority filter for leads tab
                        document.getElementById('priorityFilterContainer').style.display = 'block';
                    }

                    // Reset search and pagination
                    document.getElementById('directorySearch').value = '';
                    document.getElementById('priorityFilter').value = 'all';
                    currentPage = 1;
                    initializePagination();
                    
                    // Clear form when switching tabs
                    clearForm();
                });
            });
        }

        // Search functionality for directory
        function setupDirectorySearch() {
            const searchInput = document.getElementById('directorySearch');

            searchInput.addEventListener('input', function() {
                const priority = document.getElementById('priorityFilter').value;
                filterDirectoryItemsByPriorityAndSearch(this.value.toLowerCase(), priority);
            });
        }

        // ===== Requirements table logic =====
        const tbody = document.getElementById('table-body');
        const addBtn = document.getElementById('add-item-btn');
        const grandEl = document.getElementById('grand-total');
        const submitBtn = document.getElementById('submitRequirementsBtn');
        const clearFormBtn = document.getElementById('clearFormBtn');

        function formatNumber(n) {
            n = parseFloat(n) || 0;
            return n.toFixed(2);
        }

        function createRow() {
            const row = createRowWithData(null);
            
            // Initialize the item dropdown (initially empty)
            const itemSelect = row.querySelector('.item-select');
            if (itemSelect) {
                initializeItemDropdown(itemSelect);
            }
            
            return row;
        }

        function refreshSlNos() {
            document.querySelectorAll('#table-body tr').forEach((row, idx) => {
                const cell = row.querySelector('.sl-no');
                if (cell) cell.textContent = idx + 1;
            });
        }

        function recalcRow(row) {
            const priceInput = row.querySelector('.item-price');
            const qtyInput = row.querySelector('.item-qty');
            const totalCell = row.querySelector('.item-total');

            const price = parseFloat(priceInput.value || 0);
            const qty = parseInt(qtyInput.value || 0) || 0;
            const total = price * qty;

            totalCell.textContent = formatNumber(total);
            recalcGrandTotal();
        }

        function recalcGrandTotal() {
            let grand = 0;
            document.querySelectorAll('#table-body .item-total').forEach(cell => {
                grand += parseFloat(cell.textContent || 0);
            });
            grandEl.textContent = formatNumber(grand);
        }

        // Function to initialize item dropdown with filtered items
        // Function to initialize item dropdown with filtered items
function initializeItemDropdown(itemSelect, section = null) {
    // Clear dropdown
    itemSelect.innerHTML = `<option value="">-- Select Item --</option>`;
    
    // Get template
    const template = document.getElementById('item-options');
    if (!template) {
        console.error("仇 Template #item-options not found!");
        itemSelect.innerHTML = `<option value="">-- Error: Template not found --</option>`;
        itemSelect.disabled = true;
        return;
    }
    
    // Get all item options from the template
    const allOptions = Array.from(template.content.querySelectorAll('option'));
    
    console.log(`\n=== initializeItemDropdown ===`);
    console.log(`Total options in template: ${allOptions.length}`);
    console.log(`Requested section: "${section}"`);
    
    if (section) {
        // Normalize section for comparison
        const targetSection = section.toUpperCase().trim();
        
        console.log(`Looking for section: "${targetSection}"`);
        
        // Filter items by section
        const filtered = allOptions.filter(opt => {
            const optSection = (opt.dataset.section || '').toUpperCase().trim();
            const match = optSection === targetSection;
            
            if (match) {
                console.log(`  九 Match: ${opt.textContent.trim()} (section: "${optSection}")`);
            }
            
            return match;
        });
        
        console.log(`Found ${filtered.length} items for section "${targetSection}"`);
        
        if (filtered.length === 0) {
            console.warn(`丘멆잺 No items found for section: ${targetSection}`);
            
            // Show which sections are available
            const availableSections = [...new Set(
                allOptions
                    .map(o => o.dataset.section)
                    .filter(Boolean)
                    .map(s => s.toUpperCase().trim())
            )];
            console.log(`Available sections: ${availableSections.join(', ')}`);
            
            itemSelect.innerHTML = `<option value="">-- No items in ${section} section --</option>`;
            itemSelect.disabled = true;
            return;
        }
        
        // Add filtered items to dropdown
        filtered.forEach(opt => {
            const newOption = document.createElement('option');
            newOption.value = opt.value;
            newOption.textContent = opt.textContent.trim();
            newOption.dataset.unit = opt.dataset.unit || '';
            newOption.dataset.price = opt.dataset.price || '0.00';
            newOption.dataset.section = opt.dataset.section || '';
            itemSelect.appendChild(newOption);
        });
        
        itemSelect.disabled = false;
        
        console.log(`九 Successfully added ${filtered.length} items to dropdown`);
        
        // Auto-select if only one item
        if (filtered.length === 1) {
            setTimeout(() => {
                itemSelect.value = filtered[0].value;
                itemSelect.dispatchEvent(new Event('change'));
                console.log(`Auto-selected: ${filtered[0].textContent.trim()}`);
            }, 100);
        }
    } else {
        itemSelect.innerHTML = `<option value="">-- Select Section First --</option>`;
        itemSelect.disabled = true;
    }
}
        function attachRowEvents(row) {
            const sectionSelect = row.querySelector('.section-select');
            const itemSelect = row.querySelector('.item-select');
            const unitInput = row.querySelector('.item-unit');
            const priceInput = row.querySelector('.item-price');
            const qtyInput = row.querySelector('.item-qty');
            const deleteBtn = row.querySelector('.delete-row');

            // Get all item options from the template (global)
            const allOptions = Array.from(document.querySelectorAll('#item-options option'));

            // 1勇 When SECTION changes  filter the items
            // 1勇 When SECTION changes  filter the items
sectionSelect.addEventListener('change', function () {
    const sec = this.value.trim();
    console.log(`Section changed to: "${sec}"`);
    
    // Clear item selection and values
    itemSelect.value = "";
    unitInput.value = "";
    priceInput.value = "";
    
    if (sec) {
        // 九 Enable and populate item dropdown with section-filtered items
        initializeItemDropdown(itemSelect, sec);
        
        // Debug: Check what was loaded
        setTimeout(() => {
            const loadedCount = itemSelect.options.length - 1; // Exclude placeholder
            console.log(`Items loaded for "${sec}": ${loadedCount}`);
            
            if (loadedCount === 0) {
                console.warn(`丘멆잺 No items found for section: ${sec}`);
                console.log('Available sections in data:', 
                    Array.from(new Set(
                        Array.from(document.querySelectorAll('#item-options option'))
                            .map(o => o.dataset.section)
                            .filter(Boolean)
                    ))
                );
            }
        }, 100);
    } else {
        // No section selected
        itemSelect.disabled = true;
        itemSelect.innerHTML = `<option value="">-- Select Section First --</option>`;
    }
    
    recalcRow(row);
});

            // 2勇 When ITEM changes  autofill (unit, price)
            itemSelect.addEventListener('change', function () {
                const opt = this.selectedOptions[0];

                if (opt && opt.value !== "") {
                    unitInput.value = opt.dataset.unit || "";
                    priceInput.value = parseFloat(opt.dataset.price || 0).toFixed(2);
                    console.log(`Item selected: ${opt.textContent}, Price: ${priceInput.value}, Unit: ${unitInput.value}`);
                } else {
                    unitInput.value = "";
                    priceInput.value = "";
                }

                recalcRow(row);
            });

            // 3勇 Price / Qty changes
            priceInput.addEventListener('input', () => recalcRow(row));
            qtyInput.addEventListener('input', () => recalcRow(row));

            deleteBtn.addEventListener('click', function () {
                row.remove();
                refreshSlNos();
                recalcGrandTotal();
                if (document.querySelectorAll('#table-body tr').length === 0) createRow();
            });
        }

        // Clear form function
        function clearForm() {
            // Clear header display
            document.getElementById('header-name').textContent = '-';
            document.getElementById('header-phone').textContent = '-';
            document.getElementById('header-ticket').textContent = '-';
            document.getElementById('header-priority').textContent = '-';
            document.getElementById('header-existing-count').textContent = '0';
            
            // Clear hidden fields
            document.getElementById('hiddenOwnerName').value = '';
            document.getElementById('hiddenPhoneNo').value = '';
            document.getElementById('hiddenTicketNumber').value = '';
            document.getElementById('hiddenPriority').value = '';
            document.getElementById('hiddenEmailAddress').value = '';
            document.getElementById('hiddenRequirementIds').value = '';
            
            // Clear requirements table
            clearRequirementsTable();
            
            // Show/hide messages
            document.getElementById('leadSelectionHint').style.display = 'block';
            document.getElementById('existingRequirementsInfo').style.display = 'none';
            document.getElementById('editModeIndicator').style.display = 'none';
            
            // Disable submit button
            document.getElementById('submitRequirementsBtn').disabled = true;
            
            // Clear lead selection
            clearLeadSelection();
            
            // Create initial row
            createRow();
            
            showTemporaryMessage('Form cleared', 'info');
        }

        // Initialize directory functionality
        setupDirectoryTabs();
        setupDirectorySearch();
        setupPriorityFilter();
        initializePagination();
        
        // Pagination button event listeners
        prevPageBtn.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                updatePagination();
            }
        });
        
        nextPageBtn.addEventListener('click', () => {
            if (currentPage < totalPages) {
                currentPage++;
                updatePagination();
            }
        });

        // create initial row
        createRow();

        // add new row button
        if (addBtn) {
            addBtn.addEventListener('click', function () {
                createRow();
            });
        }

        // clear form button
        if (clearFormBtn) {
            clearFormBtn.addEventListener('click', clearForm);
        }

        // Form submission validation
        document.getElementById('requirements-form').addEventListener('submit', function(e) {
            const ownerName = document.getElementById('hiddenOwnerName').value;
            if (!ownerName) {
                e.preventDefault();
                showTemporaryMessage('Please select a lead or employee first', 'error');
                return;
            }

            const hasItems = document.querySelectorAll('#table-body tr').length > 0;
            if (!hasItems) {
                e.preventDefault();
                showTemporaryMessage('Please add at least one requirement item', 'error');
                return;
            }

            // Validate all rows have items selected
            let allValid = true;
            document.querySelectorAll('.item-select').forEach(select => {
                if (!select.value) {
                    allValid = false;
                }
            });

            if (!allValid) {
                e.preventDefault();
                showTemporaryMessage('Please select an item for all rows', 'error');
                return;
            }

            // Show loading state
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            submitBtn.disabled = true;
            
            // Also disable the clear form button during submission
            clearFormBtn.disabled = true;
        });

        // Test function to verify section filtering
        function testSectionFiltering() {
            console.log("=== Testing Section Filtering ===");
            
            // Get all item options
            const allOptions = Array.from(document.querySelectorAll('#item-options option'));
            console.log(`Total items in template: ${allOptions.length}`);
            
            // Group by section
            const sections = {};
            allOptions.forEach(opt => {
                const section = opt.dataset.section || 'UNKNOWN';
                if (!sections[section]) sections[section] = 0;
                sections[section]++;
            });
            
            console.log("Items by section:", sections);
            
            // Test each section dropdown
            const availableSections = ['GENERAL', 'HARDWARE', 'SOFTWARE', 'PAPER_ROLLS'];
            availableSections.forEach(section => {
                const testSelect = document.createElement('select');
                initializeItemDropdown(testSelect, section);
                console.log(`${section}: ${testSelect.options.length - 1} items`);
            });
        }

        // Run test function after a delay
        setTimeout(testSectionFiltering, 2000);

        console.log('Requirements page initialized with section-based item filtering');
    });
</script>
</body>
</html>