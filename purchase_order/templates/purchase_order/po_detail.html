{% extends 'base.html' %}
{% load static %}

{% block title %}PO Details - {{ po.po_number }}{% endblock %}

{% block content %}
<div class="content-wrapper">
    <div class="page-header no-print">
        <h1 class="page-title">Purchase Order Details</h1>
        <div class="header-actions">
            <a href="{% url 'purchase_order:po_update' po.pk %}" class="btn btn-primary">
                <i class="fas fa-edit"></i> Edit
            </a>
            <a href="{% url 'purchase_order:po_list' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Back
            </a>
        </div>
    </div>

    <div class="po-container">
        <!-- Print Header (visible only in print) -->
        <div class="print-header">
            <!-- Department (From) Information -->
            {% if po.department %}
            <div class="print-from-section">
                <h2>{{ po.department.name|upper }}</h2>
                <p>{{ po.department.address }}</p>
                <p>{{ po.department.city }}, {{ po.department.state }} - {{ po.department.pincode }}</p>
                <p>{{ po.department.contact_number }}</p>
                {% if po.department.gst_number %}
                <p><strong>GSTIN:</strong> {{ po.department.gst_number }}</p>
                {% endif %}
            </div>
            {% endif %}

            <!-- PO Title and Details -->
            <div class="print-po-title">
                <h1>PURCHASE ORDER</h1>
                <div class="print-po-info">
                    <span class="page-number">Page 1 of 1</span>
                </div>
            </div>

            <!-- To and PO Number Section -->
            <div class="print-to-section">
                <div class="print-to-left">
                    <div class="to-label">To</div>
                    <div class="to-content">
                        <strong>{{ po.supplier.name|upper }}</strong>
                        <p>{{ po.supplier.address }}</p>
                        {% if po.supplier.places %}
                        <p>{{ po.supplier.places }}</p>
                        {% endif %}
                        <p>{{ po.supplier.city }}</p>
                        <p>{{ po.supplier.state }}</p>
                    </div>
                </div>
                <div class="print-to-right">
                    <table class="print-info-table">
                        <tr>
                            <td class="info-label-cell">No</td>
                            <td class="info-value-cell">{{ po.po_number }}</td>
                        </tr>
                        <tr>
                            <td class="info-label-cell">Date</td>
                            <td class="info-value-cell">{{ po.po_date|date:"d/m/Y" }}</td>
                        </tr>
                    </table>
                </div>
            </div>

            <!-- Sir Section -->
            <div class="print-sir-section">
                Sir,
            </div>
        </div>

        <!-- PO Header (screen only) -->
        <div class="po-header screen-only">
            <div class="po-header-left">
                <h2 class="po-number">{{ po.po_number }}</h2>
                <span class="status-badge status-{{ po.status|lower }}">
                    {{ po.get_status_display }}
                </span>
                <span class="status-badge admin-status-{{ po.admin_status|lower }}">
                    <i class="fas fa-shield-alt"></i> {{ po.get_admin_status_display }}
                </span>
            </div>
            <div class="po-header-right">
                <div class="po-dates">
                    <div class="date-item">
                        <span class="date-label">PO Date:</span>
                        <span class="date-value">{{ po.po_date|date:"d M, Y" }}</span>
                    </div>
                    <div class="date-item">
                        <span class="date-label">Delivery Date:</span>
                        <span class="date-value">{{ po.delivery_date|date:"d M, Y" }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Supplier, Department, Client and Delivery Info (screen only) -->
        <div class="info-grid three-column screen-only">
            {% if po.department %}
            <div class="info-card">
                <h3 class="card-title">
                    <i class="fas fa-store"></i> Buyer Department
                </h3>
                <div class="card-content">
                    <div class="info-row">
                        <span class="info-label">Department Name:</span>
                        <span class="info-value">{{ po.department.name }}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Location:</span>
                        <span class="info-value">{{ po.department.city }}, {{ po.department.state }} - {{ po.department.pincode }}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Contact:</span>
                        <span class="info-value">{{ po.department.contact_number }}</span>
                    </div>
                    {% if po.department.alternate_number %}
                    <div class="info-row">
                        <span class="info-label">Alternate:</span>
                        <span class="info-value">{{ po.department.alternate_number }}</span>
                    </div>
                    {% endif %}
                    {% if po.department.email %}
                    <div class="info-row">
                        <span class="info-label">Email:</span>
                        <span class="info-value">{{ po.department.email }}</span>
                    </div>
                    {% endif %}
                    {% if po.department.gst_number %}
                    <div class="info-row">
                        <span class="info-label">GSTIN:</span>
                        <span class="info-value">{{ po.department.gst_number }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <div class="info-card">
                <h3 class="card-title" style="display: flex; justify-content: space-between; align-items: center;">
                <span><i class="fas fa-building"></i> Supplier Information</span>
                <button type="button" id="viewSupplierHistoryDetail"
                    class="btn-view-supplier"
                    title="View Supplier History"
                    data-supplier-id="{{ po.supplier.id }}">
                    <i class="fas fa-eye"></i>
                </button>
            </h3>
            <div class="card-content">
                    <div class="info-row">
                        <span class="info-label">Supplier Name:</span>
                        <span class="info-value">{{ po.supplier.name }}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Address:</span>
                        <span class="info-value">{{ po.supplier.address }}</span>
                    </div>
                    {% if po.supplier.places %}
                    <div class="info-row">
                        <span class="info-label">Place:</span>
                        <span class="info-value">{{ po.supplier.places }}</span>
                    </div>
                    {% endif %}
                    <div class="info-row">
                        <span class="info-label">Location:</span>
                        <span class="info-value">{{ po.supplier.city }}, {{ po.supplier.state }}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Mobile:</span>
                        <span class="info-value">{{ po.supplier.mobile_no }}</span>
                    </div>
                    {% if po.supplier.alternate_number %}
                    <div class="info-row">
                        <span class="info-label">Alternate:</span>
                        <span class="info-value">{{ po.supplier.alternate_number }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% if po.client_details %}
            <div class="info-card">
                <h3 class="card-title">
                    <i class="fas fa-user-tie"></i> Client Details
                </h3>
                <div class="card-content">
                    <div class="info-row">
                        <span class="info-label">Client Name:</span>
                        <span class="info-value">{{ po.client_details }}</span>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        {% if po.pdf_format == "FORMAT_2" and po.client_details %}
            <div class="client-details-print">
            <strong>Client Details:</strong> {{ po.client_details }}
            </div>
        {% endif %}

        <!-- Line Items Section -->
        <div class="items-section">
            <h3 class="section-title screen-only">
                <i class="fas fa-box"></i> Order Items
            </h3>
            {% if po.po_items.all %}
            <div class="items-table-wrapper">
                <table class="items-table print-items-table">
                    <thead>
                        <tr>
                            <th class="sl-col">Sl No</th>
                            <th class="item-col">Item</th>
                            <th class="packing-col">Packing</th>
                            <th class="qty-col">QTY</th>
                            <th class="discount-col">Discount</th>
                            <th class="rate-col">Entry Rate</th>
                            <th class="tax-col">Tax %</th>
                            <th class="mrp-col">Sales Price (MRP)</th>
                            <!-- ‚úÖ ADD THIS NEW COLUMN -->
                            <th class="cost-col">Item Cost</th>
                            <th class="total-col">Total Amount</th>
                            <th class="remark-col">Remark</th>
                            <th class="action-col screen-only">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in po.po_items.all %}
                        <tr>
                            <td class="center-align">{{ forloop.counter }}</td>
                            <td>
                                <div class="item-name">{{ item.item.name }}</div>
                                <div class="client-details-format2" style="display: none;">
                                    {% if po.client_details %}
                                    <span style="font-size: 9px; color: #666; font-style: italic;">
                                        ({{ po.client_details }})
                                    </span>
                                    {% endif %}
                                </div>
                            </td>
                            <td class="center-align">{{ item.item.unit_of_measure }}</td>
                            <td class="right-align">{{ item.quantity }}</td>
                            <td class="right-align">{{ item.discount|floatformat:2 }}</td>
                            <td class="right-align">{{ item.entry_rate|floatformat:2 }}</td>
                            <td class="center-align">{{ item.tax_percent }}</td>
                            <td class="right-align">{{ item.sales_price|default:0|floatformat:2 }}</td>
                            <!-- ‚úÖ ADD THIS NEW CELL -->
                            <td class="right-align item-cost-cell">{{ item.item_cost|floatformat:2 }}</td>
                            <td class="right-align line-total">{{ item.line_total|floatformat:2 }}</td>
                            <td></td>
                            <td class="center-align action-cell screen-only">
                                <button type="button" class="btn-view-item"
                                        title="View Item History"
                                        data-item-id="{{ item.item.id }}">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot class="print-table-footer">
                        <tr class="total-row">
                            <!-- ‚úÖ CHANGE: colspan from 8 to 9 -->
                            <td colspan="9" class="right-align"><strong>Total</strong></td>
                            <td class="right-align"><strong>{{ po.total_amount|floatformat:2 }}</strong></td>
                            <td></td>
                        </tr>
                        <tr class="total-row">
                            <!-- ‚úÖ CHANGE: colspan from 8 to 9 -->
                            <td colspan="9" class="right-align"><strong>Discount</strong></td>
                            <td class="right-align"><strong>0.00</strong></td>
                            <td></td>
                        </tr>
                        <tr class="total-row">
                            <!-- ‚úÖ CHANGE: colspan from 8 to 9 -->
                            <td colspan="9" class="right-align"><strong>Tax</strong></td>
                            <td class="right-align"><strong>{{ po.tax_amount|floatformat:2 }}</strong></td>
                            <td></td>
                        </tr>
                        <tr class="grand-total-row-print">
                            <!-- ‚úÖ CHANGE: colspan from 8 to 9 -->
                            <td colspan="9" class="right-align"><strong>Grand Total</strong></td>
                            <td class="right-align grand-total-value"><strong>{{ po.grand_total|floatformat:2 }}</strong></td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            {% else %}
            <div class="no-items">
                <i class="fas fa-inbox"></i>
                <p>No items in this purchase order</p>
            </div>
            {% endif %}
        </div>

        <!-- Print Footer -->
        <div class="print-footer">
            <div class="print-footer-row">
                <div class="footer-item">
                    <strong>Mode of Transport</strong>
                </div>
            </div>
            <div class="print-footer-row">
                <div class="footer-item">
                    <strong>Enclosures</strong>
                </div>
            </div>
            <div class="print-signature">
                <div class="signature-left">
                    <p>Yours Faithfully</p>
                </div>
                <div class="signature-right">
                    <div class="signature-box">
                        Authorised Signatory
                    </div>
                </div>
            </div>
        </div>

        <!-- Financial Details (screen only) -->
        <div class="financial-section screen-only">
            <h3 class="section-title">
                <i class="fas fa-sack-dollar"></i> Financial Details
            </h3>
            <div class="financial-grid">
                <div class="financial-row">
                    <span class="financial-label">Total Amount:</span>
                    <span class="financial-value">‚Çπ{{ po.total_amount|floatformat:2 }}</span>
                </div>
                <div class="financial-row">
                    <span class="financial-label">Discount:</span>
                    <span class="financial-value">‚Çπ0.00</span>
                </div>
                <div class="financial-row">
                    <span class="financial-label">Tax Amount:</span>
                    <span class="financial-value">‚Çπ{{ po.tax_amount|floatformat:2 }}</span>
                </div>
                <div class="financial-row grand-total-row">
                    <span class="financial-label">Grand Total:</span>
                    <span class="financial-value">‚Çπ{{ po.grand_total|floatformat:2 }}</span>
                </div>
            </div>
        </div>

        <!-- Additional Notes (screen only) -->
        {% if po.notes %}
        <div class="notes-section screen-only">
            <h3 class="section-title">
                <i class="fas fa-sticky-note"></i> Additional Notes
            </h3>
            <div class="notes-content">
                {{ po.notes|linebreaks }}
            </div>
        </div>
        {% endif %}

        <!-- Admin Approval Section (superadmin only) -->
        {% if user.is_superuser %}
        <div class="approval-section screen-only">
            <h3 class="section-title">
                <i class="fas fa-shield-alt"></i> Admin Approval
            </h3>
            <form method="POST" action="{% url 'purchase_order:po_approve' po.pk %}" class="approval-form">
                {% csrf_token %}
                <div class="approval-content">
                    <div class="approval-field">
                        <label for="admin_status" class="approval-label">Approval Status:</label>
                        <select name="admin_status" id="admin_status" class="approval-select status-{{ po.admin_status|lower }}" onchange="toggleRejectionReason()">
                            <option value="PENDING" {% if po.admin_status == 'PENDING' %}selected{% endif %}>‚è≥ Pending</option>
                            <option value="APPROVED" {% if po.admin_status == 'APPROVED' %}selected{% endif %}>‚úÖ Approved</option>
                            <option value="REJECTED" {% if po.admin_status == 'REJECTED' %}selected{% endif %}>‚ùå Rejected</option>
                        </select>
                    </div> 
                    <div class="approval-actions">
                        <button type="submit" class="btn btn-success btn-approval">
                            <i class="fas fa-check"></i> Update Approval Status
                        </button>
                    </div>
                </div>
            </form>
        </div>
        {% elif po.admin_status != 'PENDING' %}
        <!-- Show read-only status for non-superadmin -->
        <div class="approval-section screen-only">
            <h3 class="section-title">
                <i class="fas fa-shield-alt"></i> Admin Approval Status
            </h3>
            <div class="approval-readonly">
                <span class="status-badge admin-status-{{ po.admin_status|lower }}">
                    {{ po.get_admin_status_display }}
                </span>
            </div>
        </div>
        {% endif %}
        
        <!-- Metadata (screen only) -->
        <div class="metadata-section screen-only">
            <div class="metadata-item">
                <i class="fas fa-calendar-plus"></i>
                <span>Created: {{ po.created_at|date:"d M, Y H:i" }}</span>
                {% if po.created_by %}
                <span class="metadata-by">by {{ po.created_by }}</span>
                {% endif %}
            </div>
            <div class="metadata-item">
                <i class="fas fa-calendar-check"></i>
                <span>Last Updated: {{ po.updated_at|date:"d M, Y H:i" }}</span>
            </div>
        </div>

        <!-- ‚úÖ ADD THIS ENTIRE SECTION -->
        <div class="pdf-format-section screen-only no-print">
            <div class="format-selector">
                <label for="pdfFormatSelect">
                    <i class="fas fa-file-pdf"></i> PDF Format:
                </label>
                <select id="pdfFormatSelect" class="format-select">
                    <option value="FORMAT_1" {% if po.pdf_format == 'FORMAT_1' %}selected{% endif %}>
                        üìÑ FORM 1
                    </option>
                    <option value="FORMAT_2" {% if po.pdf_format == 'FORMAT_2' %}selected{% endif %}>
                        üìã FORM 2
                    </option>
                </select>
            </div>
        </div>

        <div class="detail-actions no-print d-flex justify-content-end align-items-center mt-3 gap-2">
            <a href="{% url 'purchase_order:po_list' %}" class="btn btn-secondary btn-lg">
                <i class="fas fa-arrow-left"></i> Back
            </a>
            <a href="{% url 'purchase_order:po_update' po.pk %}" class="btn btn-primary btn-lg">
                <i class="fas fa-edit"></i> Edit
            </a>
            <a href="{% url 'purchase_order:po_delete' po.pk %}" class="btn btn-danger btn-lg">
                <i class="fas fa-trash"></i> Remove
            </a>
            <button onclick="printWithFormat()" class="btn btn-info btn-lg">
                <i class="fas fa-print"></i> Print
            </button>
            <button id="whatsappShareBtn" class="btn btn-success btn-lg">
                <i class="fab fa-whatsapp"></i> WhatsApp Share
            </button>
        </div>
    </div>
</div>
<!-- Supplier Purchase History Modal -->
<div id="supplierHistoryModalDetail" class="history-modal">
  <div class="history-modal-content">
    <div class="history-modal-header">
      <i class="fas fa-history"></i>
      <h2>Supplier Purchase History</h2>
    </div>
    <div class="history-modal-body">
      <table id="supplierHistoryTableDetail" class="history-table">
        <thead>
          <tr>
            <th>PO Number</th>
            <th>Date</th>
            <th>Item</th>
            <th>Quantity</th>
            <th>Total</th>
            <th>Rate</th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="6" class="no-data">Loading...</td></tr>
        </tbody>
      </table>
    </div>
    <div class="history-modal-footer">
      <button type="button" class="btn-close" onclick="closeSupplierHistoryDetail()">Close</button>
    </div>
  </div>
</div>

<!-- ‚úÖ ITEM PURCHASE HISTORY MODAL -->
<div id="itemHistoryModalDetail" class="confirmation-modal">
  <div class="confirmation-content" style="max-width: 900px;">
    <div class="confirmation-header" style="background: #6f42c1;">
      <i class="fas fa-history"></i>
      <h2>Item Purchase History</h2>
    </div>
    <div class="confirmation-body" style="max-height: 450px; overflow-y: auto;">
      <table id="itemHistoryTableDetail" class="styled-table">
        <thead>
          <tr>
            <th>PO Number</th>
            <th>Date</th>
            <th>Supplier</th>
            <th>Quantity</th>
            <th>Total</th>
            <th>Rate</th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="6" class="no-data">Loading...</td></tr>
        </tbody>
      </table>
    </div>
    <div class="confirmation-footer">
      <button type="button" class="btn-cancel" onclick="closeItemHistoryDetail()">Close</button>
    </div>
  </div>
</div>

<style>
/* Screen Styles */
.content-wrapper {
    padding: 20px;
    max-width: 1200px;
    margin: 0 auto;
}

.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
}

.page-title {
    font-size: 28px;
    font-weight: 600;
    color: #2c3e50;
    margin: 0;
}

.header-actions {
    display: flex;
    gap: 10px;
}

.btn {
    padding: 10px 20px;
    border-radius: 6px;
    text-decoration: none;
    font-weight: 500;
    transition: all 0.3s ease;
    border: none;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.btn-primary {
    background: #3498db;
    color: white;
}

.btn-primary:hover {
    background: #2980b9;
}

.btn-secondary {
    background: #95a5a6;
    color: white;
}

.btn-secondary:hover {
    background: #7f8c8d;
}

.btn-danger {
    background: #e74c3c;
    color: white;
}

.btn-danger:hover {
    background: #c0392b;
}

.btn-info {
    background: #16a085;
    color: white;
}

.btn-info:hover {
    background: #138d75;
}

.btn-lg {
    padding: 12px 24px;
    font-size: 16px;
}

.po-container {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    padding: 30px;
}

/* Hide print elements on screen */
.print-header,
.print-footer,
.print-table-footer {
    display: none !important;
}

.po-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    padding-bottom: 20px;
    border-bottom: 2px solid #ecf0f1;
    margin-bottom: 30px;
}

.po-header-left {
    display: flex;
    align-items: center;
    gap: 15px;
}

.po-number {
    font-size: 32px;
    font-weight: 700;
    color: #2c3e50;
    margin: 0;
}

.status-badge {
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 600;
    display: inline-block;
    text-transform: uppercase;
}

.status-draft {
    background: #e3f2fd;
    color: #1976d2;
}

.status-pending {
    background: #fff3e0;
    color: #f57c00;
}

.status-approved {
    background: #e8f5e9;
    color: #388e3c;
}

.status-delivered {
    background: #f3e5f5;
    color: #7b1fa2;
}

.status-cancelled {
    background: #ffebee;
    color: #c62828;
}

.po-dates {
    display: flex;
    flex-direction: column;
    gap: 10px;
    align-items: flex-end;
}

.date-item {
    display: flex;
    gap: 10px;
}

.date-label {
    color: #7f8c8d;
    font-weight: 600;
}

.date-value {
    color: #2c3e50;
    font-weight: 700;
}

.info-grid {
    display: grid;
    gap: 20px;
    margin-bottom: 30px;
}

.info-grid.three-column {
    grid-template-columns: repeat(3, 1fr);
}

.info-card {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 20px;
    border: 1px solid #e9ecef;
}

.card-title {
    font-size: 18px;
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.card-title i {
    color: #3498db;
}

.card-content {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.info-row {
    display: flex;
    gap: 10px;
    flex-direction: column;
}

.info-label {
    font-weight: 600;
    color: #7f8c8d;
    font-size: 13px;
}

.info-value {
    color: #2c3e50;
    line-height: 1.5;
}

.financial-section {
    background: linear-gradient(135deg, #E3F2FD 100%);
    border-radius: 8px;
    padding: 25px;
    margin-bottom: 30px;
}

.section-title {
    font-size: 20px;
    font-weight: 600;
    color: black;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.section-title i {
    color: #3498db;
}

.financial-grid {
    display: grid;
    gap: 15px;
}

.financial-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.37);
}

.financial-row:last-child {
    border-bottom: none;
}

.financial-label {
    font-weight: 600;
    color: rgba(0, 0, 0, 1);
    font-size: 16px;
    text-align: left;
    flex: 1;
}

.financial-value {
    font-weight: 700;
    color: black;
    font-size: 18px;
    text-align: right;
    min-width: 150px;
}

.grand-total-row {
    background: rgba(255, 255, 255, 0.37);
    padding: 15px;
    border-radius: 6px;
    margin-top: 10px;
}

.grand-total-row .financial-label {
    font-size: 18px;
}

.grand-total-row .financial-value {
    font-size: 24px;
}

.notes-section {
    background: #e6fff4ff;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 30px;
}

.notes-section .section-title {
    color: #2c3e50;
    margin-bottom: 15px;
}

.notes-section .section-title i {
    color: #f39c12;
}

.notes-content {
    color: #2c3e50;
    line-height: 1.6;
    white-space: pre-wrap;
}

.metadata-section {
    display: flex;
    gap: 30px;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 8px;
    margin-bottom: 30px;
    flex-wrap: wrap;
}

.metadata-item {
    display: flex;
    align-items: center;
    gap: 8px;
    color: #7f8c8d;
    font-size: 14px;
}

.metadata-item i {
    color: #3498db;
}

.metadata-by {
    font-weight: 600;
    color: #2c3e50;
}

.detail-actions {
    display: flex;
    gap: 15px;
    justify-content: center;
    padding-top: 20px;
    border-top: 2px solid #ecf0f1;
}

.items-section {
    background: white;
    border-radius: 8px;
    padding: 25px;
    margin-bottom: 30px;
    border: 1px solid #e9ecef;
}

.items-table-wrapper {
    overflow-x: auto;   /* keep for screen */
}

/* ===== PRINT FIXES: no horizontal scroll, fit to A4, hide Action column ===== */
@page {
  size: A4 portrait;
  margin: 12mm;               /* keep content inside printable area */
}

/* ========= PRINT / PDF FIX ========= */
@page {
  size: A4 portrait;
  margin: 10mm 10mm 12mm 10mm;
}

@media print {
  /* Hide screen-only controls */
  .screen-only, .no-print {
    display: none !important;
  }

  /* Show print headers/footers */
  .print-header, .print-footer {
    display: block !important;
  }

  /* Remove horizontal scroll bar */
  .items-table-wrapper {
    overflow-x: visible !important;
    width: 100% !important;
  }

  /* Force table to fit A4 width */
  .items-table {
    width: 100% !important;
    table-layout: fixed !important;
    border-collapse: collapse !important;
  }

  /* Let text wrap instead of stretching */
  .items-table th,
  .items-table td {
    white-space: normal !important;
    word-wrap: break-word !important;
    overflow-wrap: anywhere !important;
    font-size: 11px !important;
    padding: 4px !important;
  }

  /* Hide Action column in PDF/print */
  .action-col,
  .action-cell {
    display: none !important;
  }

  /* Keep columns proportional */
  .sl-col      { width: 5%  !important; }
  .item-col    { width: 25% !important; }
  .packing-col { width: 8%  !important; }
  .qty-col     { width: 8%  !important; }
  .discount-col{ width: 8%  !important; }
  .rate-col    { width: 10% !important; }
  .tax-col     { width: 6%  !important; }
  .mrp-col     { width: 12% !important; }
  .total-col   { width: 10% !important; }
  .remark-col  { width: 8%  !important; }

  /* Ensure totals rows line up */
  tfoot td {
    font-weight: bold;
  }

  /* Client details styling */
  .client-details-print {
    margin-bottom: 10px;
    font-size: 12px;
  }
}

.items-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
}

.items-table thead {
    background: #f8f9fa;
}

.items-table th {
    padding: 12px;
    text-align: center;
    font-weight: 600;
    color: #2c3e50;
    border-bottom: 2px solid #e9ecef;
    font-size: 13px;
    text-transform: uppercase;
}

.items-table td {
    padding: 12px;
    border-bottom: 1px solid #ecf0f1;
    color: #2c3e50;
}

.items-table tbody tr:hover {
    background: #f8f9fa;
}

.item-name {
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 4px;
}

.item-unit {
    font-size: 12px;
    color: #7f8c8d;
    text-transform: uppercase;
}

.line-total {
    font-weight: 700;
    color: #27ae60;
    font-size: 15px;
}

.no-items {
    text-align: center;
    padding: 40px;
    color: #7f8c8d;
}

.no-items i {
    font-size: 48px;
    margin-bottom: 15px;
    opacity: 0.3;
}

.no-items p {
    font-size: 16px;
}

/* Table column alignments for screen */
.items-table th.sl-col,
.items-table td.center-align {
    text-align: center;
}

.items-table th.item-col {
    text-align: left;
}

.items-table th.qty-col,
.items-table th.discount-col,
.items-table th.rate-col,
.items-table th.tax-col,
.items-table th.mrp-col,
.items-table th.total-col,
.items-table td.right-align {
    text-align: right;
}

.items-table th.packing-col,
.items-table th.remark-col {
    text-align: center;
}

@media print {
    @page {
        size: A4;
        margin: 0.5cm;
    }

    body {
        margin: 0;
        padding: 0;
        width: 100%;
    }

    .content-wrapper {
        padding: 0;
        max-width: 100%;
        margin: 0;
        width: 100%;
    }

    .po-container {
        box-shadow: none;
        padding: 0.5cm;
        border-radius: 0;
        background: white !important;
        margin: 0 !important;
        position: relative !important;
        z-index: 1 !important;
        width: 100%;
        max-width: 100%;
    }

    /* HIDE ALL SCREEN ELEMENTS */
    .no-print,
    .screen-only,
    .page-header,
    .detail-actions,
    .btn,
    header, 
    nav, 
    .navbar, 
    .header, 
    .top-bar, 
    .user-menu, 
    button[type="button"],
    .user-profile, 
    .profile-menu, 
    .login-btn, 
    .auth-buttons,
    [class*="user"], 
    [class*="profile"], 
    [class*="login"], 
    [class*="auth"],
    .logo,
    .sidebar,
    .side-menu {
        display: none !important;
        visibility: hidden !important;
    }

    /* Remove all floating/fixed elements */
    * {
        position: static !important;
    }
    
    .print-header, .print-footer, .items-section {
        position: relative !important;
        overflow: visible !important;
    }

    /* Show ONLY print elements */
    .print-header,
    .print-footer {
        display: block !important;
        visibility: visible !important;
    }

    .print-table-footer {
        display: table-footer-group !important;
        visibility: visible !important;
    }

    /* Print Header Styles */
    .print-from-section {
        text-align: left;
        margin-bottom: 15px;
        padding-bottom: 12px;
        border-bottom: 2px solid #000;
        width: 100%;
        overflow: visible !important;
        background: white !important;
        position: relative !important;
        z-index: 10 !important;
        display: block !important;
    }

    .print-from-section h2 {
        margin: 0 0 5px 0;
        font-size: 14px;
        font-weight: bold;
        word-wrap: break-word;
        white-space: normal;
        max-width: 100%;
        display: block !important;
        visibility: visible !important;
    }

    .print-from-section p {
        margin: 2px 0;
        font-size: 11px;
        line-height: 1.4;
        word-wrap: break-word;
        display: block !important;
        visibility: visible !important;
    }

    .print-po-title {
        text-align: right;
        margin: 15px 0;
        position: relative;
    }

    .print-po-title h1 {
        margin: 0;
        font-size: 24px;
        font-weight: bold;
        color: #00bfa5;
    }

    .page-number {
        font-size: 10px;
        color: #666;
    }

    .print-to-section {
        display: flex;
        justify-content: space-between;
        margin: 15px 0;
        padding: 12px 0;
        border-top: 1px solid #ddd;
        border-bottom: 1px solid #ddd;
    }

    .print-to-left {
        flex: 1;
    }

    .to-label {
        font-weight: bold;
        margin-bottom: 10px;
        font-size: 12px;
    }

    .to-content {
        font-size: 11px;
        line-height: 1.5;
    }

    .to-content strong {
        display: block;
        margin-bottom: 4px;
        font-size: 12px;
    }

    .to-content p {
        margin: 2px 0;
    }

    .print-to-right {
        flex: 0 0 280px;
    }

    .print-info-table {
        width: 100%;
        border-collapse: collapse;
    }

    .print-info-table td {
        padding: 8px;
        border: 1px solid #000;
        font-size: 11px;
    }

    .info-label-cell {
        background: #00bfa5;
        color: white;
        font-weight: bold;
        width: 90px;
    }

    .info-value-cell {
        background: #e0f2f1;
        font-weight: bold;
    }

    .print-sir-section {
        margin: 15px 0;
        padding: 20px 10px;
        background: #ffffcc;
        text-align: left;
        font-size: 12px;
        min-height: 60px;
    }

    /* Print Table Styles */
    .items-section {
        padding: 0;
        margin: 20px 0;
        border: none;
        background: none;
        width: 100%;
    }

    .print-items-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 10px;
        margin-top: 0;
    }

    .print-items-table thead {
        background: #00bfa5 !important;
        color: white;
    }

    .print-items-table th {
        padding: 8px 4px;
        text-align: center;
        font-weight: bold;
        border: 1px solid #000;
        font-size: 10px;
    }

    .print-items-table td {
        padding: 6px 3px;
        border: 1px solid #000;
        font-size: 10px;
    }

    .print-items-table .sl-col { width: 5%; }
    .print-items-table .item-col { width: 20%; }
    .print-items-table .packing-col { width: 8%; }
    .print-items-table .qty-col { width: 7%; }
    .print-items-table .discount-col { width: 7%; }
    .print-items-table .rate-col { width: 9%; }
    .print-items-table .tax-col { width: 7%; }
    .print-items-table .mrp-col { width: 9%; }
    .print-items-table .total-col { width: 12%; }
    .print-items-table .remark-col { width: 16%; }

    .center-align {
        text-align: center;
    }

    .right-align {
        text-align: right;
    }

    .print-items-table tbody tr:hover {
        background: none;
    }

    .print-items-table tfoot td {
        font-weight: bold;
        padding: 7px 3px;
        font-size: 10px;
    }

    .total-row td {
        background: #f5f5f5;
    }

    .grand-total-row-print td {
        background: #e0f2f1 !important;
        font-weight: bold;
    }

    .grand-total-value {
        background: #ffeb3b !important;
        color: #000;
    }

    /* Print Footer Styles */
    .print-footer {
        margin-top: 20px;
        page-break-inside: avoid;
    }

    .print-footer-row {
        margin: 10px 0;
        font-size: 11px;
    }

    .footer-item {
        line-height: 1.8;
    }

    .print-signature {
        display: flex;
        justify-content: space-between;
        margin-top: 25px;
        font-size: 11px;
    }

    .signature-left {
        text-align: left;
    }

    .signature-right {
        text-align: right;
    }

    .signature-box {
        background: #00bfa5;
        color: white;
        padding: 8px 20px;
        display: inline-block;
        margin-top: 35px;
        font-weight: bold;
        font-size: 11px;
    }
}

@media (max-width: 768px) {
    .info-grid.three-column {
        grid-template-columns: 1fr;
    }
    
    .page-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
    }
    
    .po-header {
        flex-direction: column;
        gap: 20px;
    }
    
    .po-dates {
        align-items: flex-start;
    }
    
    .detail-actions {
        flex-direction: column;
    }
    
    .btn-lg {
        width: 100%;
        justify-content: center;
    }
    
    .metadata-section {
        flex-direction: column;
        gap: 15px;
    }
}
.approval-info-section {
    margin-bottom: 20px;
}

/* Admin Status Badges */
.admin-status-pending {
    background: #fff3e0;
    color: #f57c00;
}

.admin-status-approved {
    background: #e8f5e9;
    color: #388e3c;
}

.admin-status-rejected {
    background: #ffebee;
    color: #c62828;
}

/* Admin Approval Section Styles */
.approval-section {
    background: linear-gradient(135deg, #E3F2FD 100%);
    border-radius: 8px;
    padding: 25px;
    margin-bottom: 30px;
    border-left: 4px solid #ffffffff;
}

.approval-section .section-title {
    color: #000000ff;
    margin-bottom: 20px;
}

.approval-section .section-title i {
    color: #000000ff;
}

.approval-form {
    width: 100%;
}

.approval-content {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.approval-field {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.approval-label {
    font-weight: 600;
    color: #000000ff;
    font-size: 14px;
}

.approval-select {
    padding: 12px 16px;
    border-radius: 6px;
    border: 2px solid #ffffffff;
    font-size: 16px;
    font-weight: 600;
    background: white;
    cursor: pointer;
    transition: all 0.3s ease;
    max-width: 300px;
}

.approval-select:hover {
    border-color: #ffffffff;
}

.approval-select:focus {
    outline: none;
    border-color: #ffffffff;
    box-shadow: 0 0 0 3px rgba(255, 152, 0, 0.1);
}

/* Status-based colors for select */
.approval-select.status-pending {
    background: #FFF3E0;
    color: #f57c00;
}

.approval-select.status-approved {
    background: #E8F5E9;
    color: #388e3c;
}

.approval-select.status-rejected {
    background: #FFEBEE;
    color: #c62828;
}

.approval-info {
    background: rgba(255, 255, 255, 0.5);
    padding: 15px;
    border-radius: 6px;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.approval-info-item {
    display: flex;
    align-items: center;
    gap: 10px;
    color: #424242;
    font-size: 14px;
}

.approval-info-item i {
    color: #ffffffff;
    width: 20px;
}

.approval-actions {
    display: flex;
    gap: 10px;
}

.btn-approval {
    padding: 12px 24px;
    font-size: 16px;
    flex: 0 0 auto;
}

.btn-success {
    background: #4CAF50;
    color: white;
}

.btn-success:hover {
    background: #45a049;
}

/* Read-only approval display */
.approval-readonly {
    padding: 20px;
    background: rgba(255, 255, 255, 0.5);
    border-radius: 6px;
}

.approval-info-readonly {
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
}

.approval-info-readonly p {
    margin: 8px 0;
    display: flex;
    align-items: center;
    gap: 10px;
    color: #424242;
}

.approval-info-readonly i {
    color: #ffffffff;
    width: 20px;
}

/* Responsive */
@media (max-width: 768px) {
    .approval-select {
        max-width: 100%;
    }
}

/* ‚úÖ Supplier History Modal Styling (Match PO Form Look) */
.history-modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  justify-content: center;
  align-items: center;
  z-index: 10000;
}

.history-modal-content {
  background: #fff;
  border-radius: 12px;
  max-width: 900px;
  width: 90%;
  overflow: hidden;
  box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
  animation: popupFadeIn 0.3s ease-in-out;
}

.history-modal-header {
  background: #6f42c1;
  color: white;
  padding: 16px 20px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.history-modal-header i {
  font-size: 20px;
}

.history-modal-header h2 {
  font-size: 18px;
  font-weight: 600;
  margin: 0;
}

.history-modal-body {
  max-height: 450px;
  overflow-y: auto;
  padding: 20px;
}

.history-table {
  width: 100%;
  border-collapse: collapse;
}

.history-table thead {
  background: #6f42c1;
  color: white;
}

.history-table th,
.history-table td {
  padding: 10px;
  text-align: center;
  border-bottom: 1px solid #ddd;
}

.no-data {
  text-align: center;
  color: #7f8c8d;
  font-style: italic;
  padding: 20px;
}

.history-modal-footer {
  background: #f8f9fa;
  padding: 15px;
  text-align: right;
}

.btn-close {
  background: #6c757d;
  color: white;
  border: none;
  padding: 8px 20px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 500;
  transition: all 0.3s;
}

.btn-close:hover {
  background: #5a6268;
}

@keyframes popupFadeIn {
  from { opacity: 0; transform: scale(0.9); }
  to { opacity: 1; transform: scale(1); }
}

/* ‚úÖ Styled modal - matches po_form.html */
.confirmation-modal {
  display: none;
  position: fixed;
  z-index: 9998;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
  animation: fadeIn 0.3s ease;
}

.confirmation-modal.active {
  display: flex;
  align-items: center;
  justify-content: center;
}

.confirmation-content {
  background-color: white;
  padding: 0;
  border-radius: 12px;
  width: 90%;
  max-width: 900px;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
  animation: slideIn 0.3s ease;
}

.confirmation-header {
  padding: 25px 30px;
  background: #6f42c1;
  color: white;
  border-radius: 12px 12px 0 0;
  display: flex;
  align-items: center;
  gap: 15px;
}

.confirmation-header i {
  font-size: 24px;
}

.confirmation-header h2 {
  margin: 0;
  font-size: 18px;
  font-weight: 600;
}

.confirmation-body {
  padding: 20px;
}

.styled-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 14px;
  background: #fff;
  border-radius: 8px;
  overflow: hidden;
}

.styled-table thead tr {
  background-color: #6f42c1;
  color: #ffffff;
  text-align: center;
}

.styled-table th,
.styled-table td {
  padding: 12px 15px;
  text-align: center;
  border-bottom: 1px solid #dddddd;
}

.styled-table tbody tr:nth-of-type(even) {
  background-color: #f3f3f3;
}

.styled-table tbody tr:hover {
  background-color: #ede7f6;
}

.no-data {
  text-align: center;
  padding: 20px;
  font-style: italic;
  color: #666;
}

.confirmation-footer {
  padding: 15px 30px;
  background: #f8f9fa;
  border-radius: 0 0 12px 12px;
  display: flex;
  justify-content: flex-end;
}

.btn-cancel {
  background: #95a5a6;
  color: white;
  padding: 10px 20px;
  border: none;
  border-radius: 6px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.3s ease;
}

.btn-cancel:hover {
  background: #7f8c8d;
}

/* ‚úÖ Final adjustment: make Supplier & Item eye buttons identical */
.btn-view-supplier,
.btn-view-item {
  background-color: #6f42c1 !important;
  border: none !important;
  border-radius: 50% !important;
  color: #6da9c5ff !important;
  font-size: 14px !important;
  width: 32px !important;
  height: 32px !important;
  display: inline-flex !important;
  align-items: center !important;
  justify-content: center !important;
  cursor: pointer !important;
  transition: all 0.2s ease !important;
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15) !important;
  vertical-align: middle !important;
  margin-left: 6px !important;
  padding: 0 !important;
}

/* ‚úÖ Hover and click effects unified */
.btn-view-supplier:hover,
.btn-view-item:hover {
  background-color: #5a32a3 !important;
  transform: scale(1.1);
  box-shadow: 0 3px 8px rgba(0, 0, 0, 0.25);
}

.btn-view-supplier:active,
.btn-view-item:active {
  transform: scale(0.95);
  background-color: #4b278f !important;
}

/* ‚úÖ Icon alignment and size (identical for both) */
.btn-view-supplier i,
.btn-view-item i {
  font-size: 15px !important;
  line-height: 1 !important;
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
}

/* ‚úÖ Optional: subtle glow on hover (modern look) */
.btn-view-supplier:hover,
.btn-view-item:hover {
  box-shadow: 0 0 10px rgba(111, 66, 193, 0.5);
}
/* ‚úÖ Blue eye icon inside purple button */
.btn-view-supplier i,
.btn-view-item i {
  color: #ffffffff !important;   /* Bright Material Blue */
  font-size: 15px;
  line-height: 1;
}

/* ‚úÖ ADD THESE STYLES */
.pdf-format-section {
    background: linear-gradient(135deg, #E3F2FD 100%);
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
}

.format-selector {
    display: flex;
    align-items: center;
    gap: 15px;
    flex-wrap: wrap;
}

.format-selector label {
    font-weight: 600;
    color: #000000ff;
    font-size: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.format-select {
    padding: 10px 15px;
    border-radius: 6px;
    border: 2px solid #007b94ff;
    font-size: 14px;
    font-weight: 500;
    background: white;
    cursor: pointer;
    transition: all 0.3s ease;
    min-width: 250px;
}

.format-select:hover {
    border-color: #F57C00;
    box-shadow: 0 2px 8px rgba(255, 152, 0, 0.2);
}

.format-select:focus {
    outline: none;
    border-color: #E65100;
    box-shadow: 0 0 0 3px rgba(255, 152, 0, 0.1);
}

.btn-sm {
    padding: 8px 16px;
    font-size: 14px;
}

.client-details-format2 {
    margin-top: 4px;
    display: none;
}

@media print {
    .pdf-format-section {
        display: none !important;
    }
    
    body.format-2 .client-details-format2 {
        display: block !important;
    }
}

.action-buttons {
  display: flex;
  justify-content: flex-end; /* Push all buttons to the right */
  gap: 10px; /* Adds space between buttons */
  margin-top: 15px;
}

/* Item Cost Column Styling */
.items-table th.cost-col,
.items-table td.item-cost-cell {
    text-align: right;
    font-weight: 600;
    color: #201f1fff; /* Orange color to distinguish from other columns */
}

.item-cost-cell {
    background: #ffffffff; /* Light orange background */
}

/* Print Styles */
@media print {
    .print-items-table .cost-col { 
        width: 10%; 
    }
    
    .item-cost-cell {
        background: none !important;
        font-weight: 600;
    }
}

@media print {
    .print-items-table .sl-col { width: 4%; }
    .print-items-table .item-col { width: 18%; }
    .print-items-table .packing-col { width: 7%; }
    .print-items-table .qty-col { width: 6%; }
    .print-items-table .discount-col { width: 7%; }
    .print-items-table .rate-col { width: 8%; }
    .print-items-table .tax-col { width: 6%; }
    .print-items-table .mrp-col { width: 9%; }
    .print-items-table .cost-col { width: 10%; }  /* ‚úÖ NEW */
    .print-items-table .total-col { width: 10%; }
    .print-items-table .remark-col { width: 15%; }
}

/* ‚úÖ ADD THIS CSS */
.department-info-section {
    animation: slideInDown 0.5s ease-out;
}

@keyframes slideInDown {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.alert-info {
    transition: all 0.3s ease;
}

.alert-info:hover {
    box-shadow: 0 4px 12px rgba(0, 191, 165, 0.2);
    transform: translateY(-2px);
}

</style>

<script>
function toggleRejectionReason() {
    const select = document.getElementById('admin_status');
    const reasonField = document.getElementById('rejectionReasonField');
    
    if (select.value === 'REJECTED') {
        reasonField.style.display = 'block';
    } else {
        reasonField.style.display = 'none';
    }
    
    // Update select styling based on status
    select.className = 'approval-select status-' + select.value.toLowerCase();
}

// Update the WhatsApp button click handler
document.getElementById("whatsappShareBtn").addEventListener("click", function () {
    const format = document.getElementById('pdfFormatSelect').value;
    const csrfToken = "{{ csrf_token }}";
    const sendUrl = "{% url 'purchase_order:send_whatsapp_po' po.id %}";
    
    const urlWithFormat = `${sendUrl}?format=${format}`;

    const btn = this;
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';

    fetch(urlWithFormat, {
        method: "POST",
        headers: {
            "X-CSRFToken": csrfToken,
        },
    })
    .then(async (response) => {
        const text = await response.text();
        try {
            const data = JSON.parse(text);
            if (data.success) {
                const formatName = format === 'FORMAT_2' ? 'Format 2 (with client details)' : 'Format 1 (standard)';
                alert(`‚úÖ WhatsApp message sent successfully!`);
            } else {
                alert("‚ö†Ô∏è Failed: " + (data.error || data.message || "Unknown error"));
            }
        } catch {
            console.error("Raw response:", text);
            alert("‚ùå Server returned invalid JSON. Check console for details.");
        }
    })
    .catch(err => {
        alert("‚ùå Network error: " + err);
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = originalText;
    });
});

function sendWhatsAppPO(poId) {
    if (!confirm('Send this PO via WhatsApp?')) return;
    
    const btn = document.getElementById('whatsapp-btn');
    btn.disabled = true;
    btn.innerHTML = '‚è≥ Sending...';
    
    fetch(`/purchase-order/purchase-orders/${poId}/send-whatsapp/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('‚úÖ ' + data.message);
        } else {
            alert('‚ùå Error: ' + data.error);
        }
    })
    .catch(error => {
        alert('‚ùå Network error: ' + error);
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = 'üì± Send WhatsApp';
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// ==================== SUPPLIER HISTORY POPUP ====================
document.getElementById('viewSupplierHistoryDetail')?.addEventListener('click', function() {
  const supplierId = this.getAttribute('data-supplier-id');
  const modal = document.getElementById('supplierHistoryModalDetail');
  const tableBody = document.querySelector('#supplierHistoryTableDetail tbody');

  tableBody.innerHTML = '<tr><td colspan="6" class="no-data">Loading...</td></tr>';
  modal.style.display = 'flex';

  fetch(`/po/supplier-history/${supplierId}/`)
    .then(response => response.json())
    .then(data => {
      if (data.history && data.history.length > 0) {
        tableBody.innerHTML = data.history.map(row => `
          <tr>
            <td>${row.po_number}</td>
            <td>${row.date}</td>
            <td>${row.item_name}</td>
            <td>${row.quantity}</td>
            <td>${row.rate}</td>
            <td>${row.total}</td>
          </tr>
        `).join('');
      } else {
        tableBody.innerHTML = '<tr><td colspan="6" class="no-data">No purchase history found.</td></tr>';
      }
    })
    .catch(() => {
      tableBody.innerHTML = '<tr><td colspan="6" class="no-data">Error loading data.</td></tr>';
    });
});

function closeSupplierHistoryDetail() {
  document.getElementById('supplierHistoryModalDetail').style.display = 'none';
}

// ==================== ITEM HISTORY POPUP ====================
document.querySelectorAll(".btn-view-item").forEach(button => {
  button.addEventListener("click", async function() {
    const itemId = this.getAttribute("data-item-id");
    const modal = document.getElementById("itemHistoryModalDetail");
    const tableBody = document.querySelector("#itemHistoryTableDetail tbody");

    tableBody.innerHTML = `<tr><td colspan="6" class="no-data">Loading...</td></tr>`;
    modal.classList.add("active"); // ‚úÖ SHOW MODAL

    try {
      const response = await fetch(`/po/item-history/${itemId}/`);
      const data = await response.json();

      if (data.history && data.history.length > 0) {
        tableBody.innerHTML = data.history.map(row => `
          <tr>
            <td>${row.po_number}</td>
            <td>${row.date}</td>
            <td>${row.supplier}</td>
            <td>${row.quantity}</td>
            <td>${parseFloat(row.rate).toFixed(2)}</td>
            <td>${parseFloat(row.total).toFixed(2)}</td>
          </tr>
        `).join('');
      } else {
        tableBody.innerHTML = `<tr><td colspan="6" class="no-data">No purchase history found.</td></tr>`;
      }
    } catch (error) {
      console.error("Error loading item history:", error);
      tableBody.innerHTML = `<tr><td colspan="6" class="no-data">Error loading data.</td></tr>`;
    }
  });
});

function closeItemHistoryDetail() {
  document.getElementById("itemHistoryModalDetail").classList.remove("active");
}

// ‚úÖ ADD THESE FUNCTIONS
function savePdfFormat() {
    const format = document.getElementById('pdfFormatSelect').value;
    const poId = {{ po.id }};
    
    fetch(`/po/purchase-orders/${poId}/update-pdf-format/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ pdf_format: format })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('‚úÖ PDF format saved successfully!');
        } else {
            alert('‚ùå Error saving format: ' + data.error);
        }
    })
    .catch(error => {
        alert('‚ùå Network error: ' + error);
    });
}

function printWithFormat() {
    const format = document.getElementById('pdfFormatSelect').value;
    
    document.body.classList.remove('format-1', 'format-2');
    document.body.classList.add(format === 'FORMAT_2' ? 'format-2' : 'format-1');
    
    const clientDetails = document.querySelectorAll('.client-details-format2');
    clientDetails.forEach(el => {
        el.style.display = format === 'FORMAT_2' ? 'block' : 'none';
    });
    
    window.print();
    
    setTimeout(() => {
        document.body.classList.remove('format-1', 'format-2');
        clientDetails.forEach(el => {
            el.style.display = 'none';
        });
    }, 1000);
}
</script>

{% endblock %}

