{% extends 'base.html' %}
{% block content %}
<head>
  <!-- Bootstrap Icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
<head/>
<style>
/******************************************************************
 *  DESKTOP STYLES
 ******************************************************************/
body {
  background: #f5f5f5;
  min-height: 100vh;
  color: #222;
}

.main-container {
  background: #ffffff;
  border-radius: 15px;
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
  padding: 2rem;
  margin: 2rem auto;
}

.page-header {
  background: #eaeaea;
  color: #111;
  padding: 2rem;
  border-radius: 10px;
  margin-bottom: 2rem;
}

.page-header h4 {
  margin: 0;
  font-weight: 600;
  font-size: 1.8rem;
}

.add-btn {
  background: #444;
  border: none;
  padding: 10px 20px;
  border-radius: 30px;
  color: white;
  font-weight: 600;
  text-decoration: none;
  transition: all 0.3s ease;
  white-space: nowrap;
}

.add-btn:hover {
  background: #111;
  color: white;
}

.search-container {
  margin-bottom: 1.5rem;
}

.search-input {
  border: 1px solid #bbb;
  border-radius: 30px;
  padding: 10px 16px;
  background: #fff;
  width: 100%;
}

.search-input:focus {
  border-color: #444;
  outline: none;
  box-shadow: 0 0 0 2px rgba(68, 68, 68, 0.2);
}

/* Branch Filter Styling */
.branch-filter {
  border: 1px solid #bbb;
  border-radius: 30px;
  padding: 10px 16px;
  background: #fff;
  width: 100%;
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;
  background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
  background-repeat: no-repeat;
  background-position: right 12px center;
  background-size: 18px;
  padding-right: 40px;
  cursor: pointer;
}

.branch-filter:focus {
  border-color: #444;
  outline: none;
  box-shadow: 0 0 0 2px rgba(68, 68, 68, 0.2);
}

.branch-filter:hover {
  border-color: #999;
  background-color: #f9f9f9;
}

.modern-table {
  background: #fff;
  border-radius: 10px;
  overflow: hidden;
  box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
  width: 100%;              /* default view fix */
  table-layout: auto;       /* allow columns to size naturally */
  transform: none !important;
  zoom: 1 !important;
}

.modern-table thead {
  background: #444;
  color: white;
}

.modern-table thead th {
  padding: 1rem;
  font-size: 0.95rem;
  font-weight: 600;
  border-bottom: none;
  text-transform: none; /* allow manual capitalization in HTML */
}

.modern-table tbody tr:hover {
  background: #f0f0f0;
}

.modern-table tbody td {
  padding: 1rem;
  border-top: 1px solid #eee;
}

.file-name-block {
  text-transform: uppercase;
  font-weight: bold;
}

.action-btn {
  background: #555;
  color: white;
  width: 36px;
  height: 36px;
  border-radius: 50%;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  transition: 0.3s;
  border: none;
  margin: 2px;
}

.action-btn:hover {
  background: #111;
  transform: scale(1.1);
  color: white;
}

.badge-counter {
  background: #333;
  color: white;
  padding: 4px 10px;
  border-radius: 20px;
  font-size: 0.85rem;
}

.pagination .page-link {
  color: #222;
  border: none;
  padding: 8px 14px;
  margin: 0 2px;
  border-radius: 30px;
  background: #e2e2e2;
  cursor: pointer;
}

.pagination .page-item.active .page-link {
  background: #444;
  color: white;
}

.pagination .page-link:hover {
  background: #111;
  color: white;
}

.pagination .page-item.disabled .page-link {
  background: #ccc;
  color: #666;
  cursor: not-allowed;
}

.empty-state {
  text-align: center;
  padding: 2rem;
  color: #888;
}

.modal-content {
  border-radius: 12px;
  border: none;
}

.modal-header {
  background: #444;
  color: white;
  border-radius: 12px 12px 0 0;
}

.modal-title {
  font-weight: 600;
}

.license-content {
  background: #f9f9f9;
  padding: 1rem;
  font-family: monospace;
  white-space: pre-wrap;
  border-radius: 10px;
  border: 1px solid #ddd;
  max-height: 400px;
  overflow-y: auto;
}

.detail-label {
  font-weight: 600;
  color: #333;
}

.detail-value {
  background: #f1f1f1;
  padding: 0.5rem 1rem;
  border-left: 4px solid #444;
  border-radius: 8px;
  margin-bottom: 1rem;
}

.modal-file-name-block {
  text-transform: uppercase;
  font-weight: bold;
}

.modal-footer .btn {
  border-radius: 30px;
  padding: 10px 20px;
  font-weight: 600;
  border: none;
}

.btn-secondary {
  background: #999;
  color: white;
}

.btn-success {
  background: #333;
  color: white;
}

.btn-warning {
  background: #666;
  color: white;
}

.hidden-row {
  display: none !important;
}

.pagination-info {
  font-size: 0.9rem;
}

.btn-close {
  filter: invert(1);
}

/* Desktop card container (hidden by default) */
.mobile-card-container {
  display: none;
}

/* Notes styling - light red, italic, and bold */
.notes-text {
  color: #dc6868 !important;
  font-style: italic !important;
  font-weight: bold !important;
}

/******************************************************************
 *  MOBILE FIRST  (≤ 768px)
 ******************************************************************/
@media (max-width: 768px) {
  /* shrink container padding */
  .main-container {
    margin: 1rem;
    padding: 1rem;
    border-radius: 10px;
  }

  /* smaller header */
  .page-header {
    padding: 1rem;
    text-align: center;
  }
  .page-header h4 {
    font-size: 1.5rem;
    margin-bottom: 1rem;
  }
  .page-header .d-flex {
    flex-direction: column !important;
    gap: 1rem;
  }
  .add-btn {
    align-self: center;
    padding: 12px 24px;
    font-size: 0.9rem;
  }

  /* Mobile search and counters */
  .search-container .row {
    flex-direction: column-reverse;
  }

  .search-container .col-md-4, .search-container .col-md-6 {
    margin-bottom: 1rem;
  }

  .search-container .d-flex {
    justify-content: center !important;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .badge-counter {
    font-size: 0.75rem;
    padding: 3px 8px;
  }

  /* Hide desktop table, show mobile cards */
  .modern-table {
    display: none !important;
  }

  /* Mobile card layout */
  .mobile-card-container {
    display: block !important;
  }

  .license-card {
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    margin-bottom: 1rem;
    padding: 1rem;
    border-left: 4px solid #444;
  }

  .license-card:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    transform: translateY(-2px);
    transition: all 0.3s ease;
  }

  .card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1rem;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .card-title {
    flex: 1;
    min-width: 0;
  }

  .card-serial {
    background: #444;
    color: white;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: bold;
    flex-shrink: 0;
  }

  .card-filename {
    display: flex;
    align-items: center;
    margin-bottom: 0.5rem;
    font-size: 0.95rem;
  }

  .card-filename i {
    margin-right: 0.5rem;
    color: #28a745;
  }

  .card-branch {
    display: flex;
    align-items: center;
    margin-bottom: 1rem;
    font-size: 0.9rem;
  }

  .card-branch i {
    margin-right: 0.5rem;
    color: #666;
  }

  .card-actions {
    display: flex;
    justify-content: center;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .action-btn {
    width: 42px;
    height: 42px;
    font-size: 1rem;
  }

  /* Mobile pagination */
  .pagination-wrapper {
    flex-direction: column;
    gap: 1rem;
    text-align: center;
  }

  .pagination {
    justify-content: center !important;
    flex-wrap: wrap;
    gap: 0.25rem;
  }

  .pagination .page-link {
    padding: 6px 10px;
    font-size: 0.85rem;
    min-width: 35px;
  }

  .pagination-info {
    order: -1;
    text-align: center;
  }

  /* Mobile modal adjustments */
  .modal-dialog {
    margin: 1rem;
    max-width: calc(100vw - 2rem);
  }

  .modal-body .row {
    flex-direction: column;
  }

  .modal-body .col-md-6 {
    margin-bottom: 1rem;
  }

  .license-content {
    font-size: 0.8rem;
    max-height: 200px;
    overflow-y: auto;
  }

  .modal-footer {
    flex-wrap: wrap;
    justify-content: center;
    gap: 0.5rem;
  }

  .modal-footer .btn {
    flex: 1;
    min-width: 120px;
    margin: 0;
    font-size: 0.9rem;
  }

  /* Mobile empty state */
  .empty-state {
    padding: 2rem 1rem;
  }

  .empty-state i {
    font-size: 3rem;
    margin-bottom: 1rem;
    display: block;
  }

  /* Mobile-specific utility classes */
  .mobile-only {
    display: block !important;
  }

  .desktop-only {
    display: none !important;
  }
}

/* Tablet adjustments */
@media (max-width: 992px) and (min-width: 769px) {
  .main-container {
    margin: 1.5rem;
  }

  .modern-table thead th,
  .modern-table tbody td {
    padding: 0.75rem 0.5rem;
    font-size: 0.85rem;
  }

  .action-btn {
    width: 32px;
    height: 32px;
    margin: 1px;
  }

  .page-header .d-flex {
    flex-wrap: wrap;
    gap: 1rem;
  }
}

/* Replace your current .date-filter style with this */
.date-filter {
  border: 1px solid #bbb;
  border-radius: 30px;
  padding: 10px 16px;
  background: #fff;
  width: 100%;
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;
  background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
  background-repeat: no-repeat;
  background-position: right 12px center;
  background-size: 18px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.date-filter:focus {
  border-color: #444;
  outline: none;
  box-shadow: 0 0 0 2px rgba(68, 68, 68, 0.2);
}

.date-filter:hover {
  border-color: #999;
  background-color: #f9f9f9;
}

.entries-select {
  border-radius: 20px;
  padding: 5px 10px;
  border: 1px solid #bbb;
  background-color: #fff;
  cursor: pointer;
  transition: all 0.3s ease;
}

.entries-select:focus {
  border-color: #444;
  outline: none;
  box-shadow: 0 0 0 2px rgba(68, 68, 68, 0.2);
}

.entries-select:hover {
  border-color: #999;
  background-color: #f9f9f9;
}
</style>
<div class="container-fluid">
  <div class="main-container">
    <div class="page-header">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h4 class="mb-2">📋 LICENSE</h4>
        </div>
        {% if 'add_license' in allowed_menus or request.session.user_level == 'admin' %}
        <a href="{% url 'add_license' %}" class="add-btn">
          <i class="bi bi-plus-circle me-2"></i>Add New License
        </a>
        {% endif %}
      </div>
    </div>

    <div class="search-container">
      <div class="row g-3 align-items-center">

        <!-- Total + Show Entries -->
        <div class="col-md-4">
          <div class="d-flex align-items-center flex-wrap gap-2">
            <span class="badge-counter" id="totalCounter">Total: {{ licenses|length }}</span>
            <div class="d-flex align-items-center">
              <span class="me-2">Show:</span>
              <select class="form-select form-select-sm entries-select" style="width: 80px;" id="entriesSelect">
                <option value="10" selected>10</option>
                <option value="25">25</option>
                <option value="50">50</option>
                <option value="100">100</option>
              </select>
              <span class="ms-2">entries</span>
            </div>
          </div>
        </div>

        <!-- Branch Filter -->
        <div class="col-md-4">
          <div class="position-relative">
            <select class="branch-filter" id="branchFilter">
              <option value="">All Branches</option>
              {% for branch in branches %}
              <option value="{{ branch.name|lower }}">{{ branch.name }}</option>
              {% endfor %}
            </select>
          </div>
        </div>

        <!-- Search Input -->
        <div class="col-md-4">
          <div class="position-relative">
            <input type="text" class="form-control search-input" id="searchInput" placeholder="Search licenses...">
            <i class="bi bi-search position-absolute top-50 end-0 translate-middle-y me-3"></i>
          </div>
        </div>

      </div>
    </div>

    <!-- Replace your current date filter with this -->
<div class="row mb-3">
  <div class="col-md-3">
    <select class="form-select date-filter" id="dateRangeFilter">
      <option value="">All Dates</option>
      <option value="today">Today</option>
      <option value="yesterday">Yesterday</option>
      <option value="this-week">This Week</option>
      <option value="this-month">This Month</option>
      <option value="this-year">This Year</option>
    </select>
  </div>
</div>

    <!-- Desktop Table View -->
    <div class="table-responsive">
      <table class="table modern-table desktop-only">
  <thead>
    <tr>
      <th><i class="bi bi-hash me-2"></i>S.NO</th>
      <th><i class="bi bi-building me-2"></i>Branch</th>
      <th><i class="bi bi-file-text me-2"></i>Firm Name</th>
      <th><i class="bi bi-geo-alt me-2"></i>Place</th>
      <th><i class="bi bi-gear me-2"></i>Service Pack</th>
      <th><i class="bi bi-list-ol me-2"></i>Number of System</th>
      <th><i class="bi bi-tag me-2"></i>Type</th>
      <th><i class="bi bi-puzzle me-2"></i>Module</th>
      <th class="text-center"><i class="bi bi-eye-fill me-2"></i>View</th>
      <th class="text-center"><i class="bi bi-download me-2"></i>Download</th>
      {% if 'license_edit' in allowed_menus or request.session.user_level == 'admin' %}
        <th class="text-center"><i class="bi bi-pencil me-2"></i>Edit</th>
      {% endif %}
      {% if 'license_delete' in allowed_menus or request.session.user_level == 'admin' %}
        <th class="text-center"><i class="bi bi-trash me-2"></i>Delete</th>
      {% endif %}
    </tr>
  </thead>
        <tbody id="licenseTableBody">
          {% for license in licenses %}
          <tr class="license-row" data-branch="{{ license.branch.name|lower }}" data-filename="{{ license.name|lower }}" data-id="{{ license.id }}" data-date="{{ license.created_at|date:'d-m-y' }}">
  <td><span class="badge-counter">{{ forloop.counter }}</span></td>
  <td>
  <div class="d-flex align-items-start flex-column">
    <div class="d-flex align-items-center">
      <i class="bi bi-building text-primary me-2"></i>
      <strong>{{ license.branch.name }}</strong>
    </div>
    <small class="text-muted ms-4">📅 Created: {{ license.created_at|date:"d-m-y" }}</small>
  </div>
</td>

  <td>
    <div class="d-flex align-items-start flex-column">
      <div class="d-flex align-items-center">
        <i class="bi bi-file-earmark-text text-success me-2"></i>
        <span class="file-name-block">{{ license.name }}</span>
      </div>
      <small class="notes-text ms-4">📝 Notes: {{ license.notes|default:"No notes added" }}</small>
    </div>
  </td>
  <td>
    <div class="d-flex align-items-center">
      <i class="bi bi-geo-alt text-warning me-2"></i>
      <span>{{ license.place|default:"N/A" }}</span>
    </div>
  </td>
  <td>
    <div class="d-flex align-items-center">
      <i class="bi bi-gear text-info me-2"></i>
      <span>{{ license.service_pack|default:"N/A" }}</span>
    </div>
  </td>
  <td>
    <div class="d-flex align-items-center">
      <i class="bi bi-list-ol text-dark me-2"></i>
      <span>{{ license.number_of_system|default:"N/A" }}</span>
    </div>
  </td>
  <td>
    <div class="d-flex align-items-center">
      <i class="bi bi-tag text-secondary me-2"></i>
      <span>{{ license.type|default:"N/A" }}</span>
    </div>
  </td>
  <td>
    <div class="d-flex align-items-center">
      <i class="bi bi-puzzle text-purple me-2"></i>
      <span>{{ license.module|default:"N/A" }}</span>
    </div>
  </td>
  <td class="text-center">
    <button class="action-btn view-btn" title="View License" data-bs-toggle="modal" data-bs-target="#licenseModal"
            onclick="fetchLicenseDetails({{ license.id }})">
      <i class="bi bi-eye-fill"></i>
    </button>
  </td>
  <td class="text-center">
    <a href="{% url 'license_download' license.id %}" class="action-btn download-btn" title="Download License">
      <i class="bi bi-download"></i>
    </a>
  </td>
  {% if 'license_edit' in allowed_menus or request.session.user_level == 'admin' %}
    <td class="text-center">
      <a href="{% url 'license_edit' license.id %}" class="action-btn edit-btn" title="Edit License">
        <i class="bi bi-pencil-square"></i>
      </a>
    </td>
  {% endif %}
  {% if 'license_delete' in allowed_menus or request.session.user_level == 'admin' %}
    <td class="text-center">
      <form action="{% url 'license_delete' license.id %}" method="post" style="display:inline;">
        {% csrf_token %}
        <button type="submit" class="action-btn delete-btn" title="Delete License"
                onclick="return confirm('🗑️ Are you sure you want to delete this license?');">
          <i class="bi bi-trash"></i>
        </button>
      </form>
    </td>
  {% endif %}
</tr>
          {% empty %}
          <tr id="emptyState">
            <td colspan="12">
              <div class="empty-state">
                <i class="bi bi-inbox"></i>
                <h5>No Licenses Found</h5>
                <p class="text-muted">Start by adding your first license using the "Add New License" button above.</p>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Mobile Card View -->
    <div class="mobile-card-container mobile-only" id="mobileCardContainer">
      {% for license in licenses %}
      <div class="license-card license-row" data-branch="{{ license.branch.name|lower }}" data-filename="{{ license.name|lower }}" data-id="{{ license.id }}">
        <div class="card-header">
          <div class="card-title">
            <div class="card-filename">
  <i class="bi bi-file-earmark-text"></i>
  <span class="file-name-block">{{ license.name }}</span>
</div>
<!-- Notes remain here with styling applied -->
<div class="notes-text ms-4" style="font-size: 0.8rem;">
  📝 Notes: {{ license.notes|default:"No notes added" }}
</div>
<div class="card-branch d-flex flex-column">
  <div>
    <i class="bi bi-building"></i>
    <strong>{{ license.branch.name }}</strong>
  </div>
  <small class="text-muted ms-4" style="font-size: 0.8rem;">
    📅 Created: {{ license.created_at|date:"d-m-y" }}
  </small>
</div>

            
            <!-- All fields in mobile view -->
            <div class="d-flex flex-column gap-2 mt-2">
              <div class="d-flex align-items-center" style="font-size: 0.85rem;">
                <i class="bi bi-gear text-info me-2"></i>
                <span><strong>Service Pack:</strong> {{ license.service_pack|default:"N/A" }}</span>
              </div>
              <div class="d-flex align-items-center" style="font-size: 0.85rem;">
                <i class="bi bi-geo-alt text-warning me-2"></i>
                <span><strong>Place:</strong> {{ license.place|default:"N/A" }}</span>
              </div>
              <div class="d-flex align-items-center" style="font-size: 0.85rem;">
                <i class="bi bi-tag text-secondary me-2"></i>
                <span><strong>Type:</strong> {{ license.type|default:"N/A" }}</span>
              </div>
              <div class="d-flex align-items-center" style="font-size: 0.85rem;">
                <i class="bi bi-list-ol text-dark me-2"></i>
                <span><strong>Systems:</strong> {{ license.number_of_system|default:"N/A" }}</span>
              </div>
              <!-- MODULE FIELD IN MOBILE -->
              <div class="d-flex align-items-center" style="font-size: 0.85rem;">
                <i class="bi bi-puzzle text-purple me-2"></i>
                <span><strong>Module:</strong> {{ license.module|default:"N/A" }}</span>
              </div>
            </div>
          </div>
          <div class="card-serial">{{ forloop.counter }}</div>
        </div>
        
        <div class="card-actions">
          <!-- View Button -->
          <button class="action-btn view-btn" title="View License" data-bs-toggle="modal" data-bs-target="#licenseModal" 
            onclick="fetchLicenseDetails({{ license.id }})">
            <i class="bi bi-eye-fill"></i>
          </button>

          <!-- Download Button -->
          <a href="{% url 'license_download' license.id %}" class="action-btn download-btn" title="Download License">
            <i class="bi bi-download"></i>
          </a>

          <!-- Edit Button -->
          <a href="{% url 'license_edit' license.id %}" class="action-btn edit-btn" title="Edit License">
            <i class="bi bi-pencil-square"></i>
          </a>

          <!-- Delete Button -->
          <form action="{% url 'license_delete' license.id %}" method="post" style="display:inline;">
            {% csrf_token %}
            <button type="submit" class="action-btn delete-btn" title="Delete License" onclick="return confirm('🗑️ Are you sure you want to delete this license?');">
              <i class="bi bi-trash"></i>
            </button>
          </form>
        </div>
      </div>
      {% empty %}
      <div class="empty-state" id="mobileEmptyState">
        <i class="bi bi-inbox"></i>
        <h5>No Licenses Found</h5>
        <p class="text-muted">Start by adding your first license using the "Add New License" button above.</p>
      </div>
      {% endfor %}
    </div>

    <!-- No Search Results Message -->
    <div id="noResults" class="empty-state" style="display: none;">
      <i class="bi bi-search"></i>
      <h5>No licenses match your search</h5>
      <p class="text-muted">Try different keywords or check your spelling.</p>
    </div>

    
    <div class="d-flex justify-content-between align-items-center mt-4 pagination-wrapper">
      <div class="text-muted pagination-info">
        <i class="bi bi-info-circle me-1"></i>
        <span id="paginationInfo">Showing 1-{{ licenses|length }} of {{ licenses|length }} license{{ licenses|length|pluralize }}</span>
      </div>
      <nav>
        <ul class="pagination mb-0" id="paginationControls">
          <!-- Pagination will be generated by JavaScript -->
        </ul>
      </nav>
    </div>
  </div>
</div>

<!-- Enhanced License Details Modal -->
<div class="modal fade" id="licenseModal" tabindex="-1" aria-labelledby="licenseModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="licenseModalLabel">
          <i class="bi bi-file-earmark-text me-2"></i>License Details
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row">
  <div class="col-md-6 mb-3"><div class="detail-label">🏢 Branch</div><div class="detail-value" id="modalLicenseBranch"></div></div>
  <div class="col-md-6 mb-3"><div class="detail-label">📄 License Name</div><div class="detail-value" id="modalLicenseName"></div></div>
  <div class="col-md-6 mb-3"><div class="detail-label">📍 Place</div><div class="detail-value" id="modalPlace"></div></div>
  <div class="col-md-6 mb-3"><div class="detail-label">⚙️ Service Pack</div><div class="detail-value" id="modalServicePack"></div></div>
  <div class="col-md-6 mb-3"><div class="detail-label">🔢 Number of System</div><div class="detail-value" id="modalNumberOfSystem"></div></div>
  <div class="col-md-6 mb-3"><div class="detail-label">🏷️ Type</div><div class="detail-value" id="modalType"></div></div>
  <div class="col-md-6 mb-3"><div class="detail-label">🧩 Module</div><div class="detail-value" id="modalModule"></div></div>
</div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="bi bi-x-circle me-2"></i>Close
        </button>
        <a id="modalDownloadBtn" href="#" class="btn btn-success">
          <i class="bi bi-download me-2"></i>Download
        </a>
        
      </div>
    </div>
  </div>
</div>

<script>
// ========== CONFIGURATION ==========
let currentPage         = 1;
let itemsPerPage        = localStorage.getItem('licenseItemsPerPage') || 10;
let allDesktopRows      = [];
let allMobileCards      = [];
let filteredDesktopRows = [];
let filteredMobileCards = [];

// ========== INITIALISATION ==========
document.addEventListener('DOMContentLoaded', () => {
  allDesktopRows      = [...document.querySelectorAll('.modern-table   tbody .license-row')];
  allMobileCards      = [...document.querySelectorAll('.mobile-card-container .license-card')];
  filteredDesktopRows = [...allDesktopRows];
  filteredMobileCards = [...allMobileCards];

  // Initialize entries select with saved value
  const entriesSelect = document.getElementById('entriesSelect');
  if (entriesSelect) {
    entriesSelect.value = itemsPerPage;
    entriesSelect.addEventListener('change', function() {
      itemsPerPage = parseInt(this.value);
      localStorage.setItem('licenseItemsPerPage', itemsPerPage);
      currentPage = 1;
      updatePagination();
      showPage(currentPage);
    });
  }

  if (allDesktopRows.length || allMobileCards.length) {
    updatePagination();
    showPage(1);
  }

  setupSearch();
  setupBranchFilter();
  window.addEventListener('resize', handleViewChange);
  handleViewChange();
});

// ========== LICENSE DETAILS MODAL ==========
function fetchLicenseDetails(id) {
  fetch(`/app4/license-preview/${id}/`)
    .then(r => r.json())
    .then(d => {
      // Directly populate each field to ensure proper display
      document.getElementById('modalLicenseName').textContent = d.name || 'N/A';
      document.getElementById('modalLicenseBranch').textContent = d.branch || 'N/A';
      document.getElementById('modalServicePack').textContent = d.service_pack || 'N/A';
      document.getElementById('modalPlace').textContent = d.place || 'N/A';
      document.getElementById('modalType').textContent = d.type || 'N/A';
      document.getElementById('modalNumberOfSystem').textContent = d.number_of_system || 'N/A';
      document.getElementById('modalModule').textContent = d.module || 'N/A';
      
      // Handle created date
      const createdEl = document.getElementById('modalLicenseCreated');
      if (createdEl) createdEl.textContent = d.created_at || 'N/A';
      
      // Handle file name
      const fileNameEl = document.getElementById('modalFileName');
      if (fileNameEl) fileNameEl.textContent = d.file_name || 'N/A';
      
      // Handle license content
      const licenseContentEl = document.getElementById('modalLicenseContent');
      if (licenseContentEl) licenseContentEl.textContent = d.license_content || 'No content available';

      // Notes handling
      const notesEl = document.getElementById('modalNotes');
      if (notesEl) {
        if (d.notes && d.notes.trim()) {
          notesEl.innerHTML = `<span class="text-dark">${d.notes.trim()}</span>`;
          notesEl.className = 'detail-value';
        } else {
          notesEl.innerHTML = '<span class="text-secondary fst-italic">No notes added</span>';
          notesEl.className = 'detail-value text-muted';
        }
      }

      // Download link
      const dlBtn = document.getElementById('modalDownloadBtn');
      if (dlBtn) dlBtn.href = `/app4/license-download/${id}/`;
    })
    .catch(err => {
      console.error('Error fetching license details:', err);
      // Set error messages for all fields
      const fields = [
        'modalLicenseName', 'modalLicenseBranch', 'modalServicePack',
        'modalPlace', 'modalType', 'modalNumberOfSystem', 'modalModule',
        'modalLicenseCreated', 'modalFileName', 'modalLicenseContent'
      ];
      fields.forEach(field => {
        const el = document.getElementById(field);
        if (el) el.textContent = 'Error loading data';
      });
    });
}

// ========== RESPONSIVE VIEW ==========
function handleViewChange() {
  const isMobile      = window.innerWidth <= 768;
  const table         = document.querySelector('.modern-table');
  const cardContainer = document.querySelector('.mobile-card-container');

  if (table)         table.style.display         = isMobile ? 'none'  : 'table';
  if (cardContainer) cardContainer.style.display = isMobile ? 'block' : 'none';
  showPage(currentPage);
}

// ========== SEARCH & FILTER ==========
function setupSearch() {
  const input = document.getElementById('searchInput');
  if (!input) return;
  let t;
  input.addEventListener('input', () => { clearTimeout(t); t = setTimeout(performFilter,300); });
  input.addEventListener('keydown', e => { if (e.key === 'Escape') { input.value=''; performFilter(); } });
}
function setupBranchFilter() {
  const sel = document.getElementById('branchFilter');
  if (sel) sel.addEventListener('change', performFilter);
}

function performFilter() {
  const term = document.getElementById('searchInput')?.value.toLowerCase().trim() || '';
  const branch = document.getElementById('branchFilter')?.value.toLowerCase() || '';
  const dateRange = document.getElementById('dateRangeFilter')?.value || '';

  const isDateInRange = (row) => {
    if (!dateRange) return true;
    
    // Get the date string from the row's data-date attribute (format: dd-mm-yy)
    const dateStr = row.dataset.date;
    if (!dateStr) return false;
    
    // Parse the date string (dd-mm-yy)
    const [day, month, year] = dateStr.split('-').map(Number);
    // Note: JavaScript months are 0-indexed, so subtract 1 from month
    const rowDate = new Date(2000 + year, month - 1, day);
    
    // Get current date and reset time components
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    // Helper function to reset time components
    const resetTime = (date) => {
      date.setHours(0, 0, 0, 0);
      return date;
    };

    // Calculate comparison dates
    const yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate() - 1);
    
    // Start of week (Sunday)
    const startOfWeek = new Date(today);
    startOfWeek.setDate(today.getDate() - today.getDay());
    
    // Start of month
    const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
    
    // Start of year
    const startOfYear = new Date(today.getFullYear(), 0, 1);
    
    // Reset time for row date
    resetTime(rowDate);
    
    // Compare dates based on selected range
    switch (dateRange) {
      case 'today':
        return rowDate.getTime() === today.getTime();
      case 'yesterday':
        return rowDate.getTime() === yesterday.getTime();
      case 'this-week':
        return rowDate >= startOfWeek;
      case 'this-month':
        return rowDate >= startOfMonth;
      case 'this-year':
        return rowDate >= startOfYear;
      default:
        return true;
    }
  };

  const filter = list => list.filter(el =>
    (branch === '' || el.dataset.branch === branch) &&
    (term === '' || el.textContent.toLowerCase().includes(term)) &&
    isDateInRange(el)
  );

  filteredDesktopRows = filter(allDesktopRows);
  filteredMobileCards = filter(allMobileCards);

  const hasResults = filteredDesktopRows.length || filteredMobileCards.length;
  document.getElementById('noResults').style.display = hasResults ? 'none' : 'block';

  currentPage = 1;
  updatePagination();
  showPage(1);
}

// Add event listener for date filter
document.getElementById('dateRangeFilter')?.addEventListener('change', performFilter);

// ========== PAGINATION ==========
function showPage(page) {
  currentPage = page;
  const items = window.innerWidth <= 768 ? filteredMobileCards : filteredDesktopRows;

  [...allDesktopRows, ...allMobileCards].forEach(el => el.style.display = 'none');

  if (!items.length) { 
    updatePaginationInfo(0,0,0); 
    document.getElementById('paginationControls').style.display = 'none';
    return; 
  }

  const start = (page-1) * itemsPerPage;
  const end   = Math.min(start + itemsPerPage, items.length);
  const slice = items.slice(start, end);

  slice.forEach((el, idx) => {
    el.style.display = '';
    const serial = start + idx + 1;
    const badge  = el.querySelector('.badge-counter, .card-serial');
    if (badge) badge.textContent = serial;
  });

  updatePaginationInfo(start+1, end, items.length);
  updateActivePage(page);
}

function updatePaginationInfo(start,end,total) {
  const info = document.getElementById('paginationInfo');
  if (info) {
    info.textContent = total
      ? `Showing ${start}-${end} of ${total} license${total-1?'s':''}`
      : 'No licenses to display';
  }
  const showing = document.getElementById('showingCounter');
  if (showing) showing.textContent = `Showing: ${end-start}`;
}

function updateActivePage(page) {
  document.querySelectorAll('.pagination .page-item').forEach(p => p.classList.remove('active'));
  document.querySelector(`[data-page="${page}"]`)?.parentElement?.classList.add('active');
}

function updatePagination() {
  const items   = window.innerWidth <= 768 ? filteredMobileCards : filteredDesktopRows;
  const total   = Math.ceil(items.length / itemsPerPage);
  const holder  = document.getElementById('paginationControls');
  if (!holder) return;

  holder.innerHTML = '';
  if (total <= 1) { holder.style.display='none'; return; }
  holder.style.display = 'flex';

  const addBtn = (num, txt=num) => {
    const li = document.createElement('li');
    li.className = `page-item ${num===currentPage?'active':''}`;
    li.innerHTML = `<a class="page-link" href="#" data-page="${num}">${txt}</a>`;
    li.addEventListener('click', e => { e.preventDefault(); showPage(num); });
    holder.appendChild(li);
  };

  // Prev
  const prev = document.createElement('li');
  prev.className = `page-item ${currentPage===1?'disabled':''}`;
  prev.innerHTML = '<a class="page-link" href="#">Previous</a>';
  if (currentPage > 1) prev.addEventListener('click', e => { e.preventDefault(); showPage(currentPage-1); });
  holder.appendChild(prev);

  // Page numbers
  const maxVisiblePages = 5;
  let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages/2));
  let endPage = Math.min(total, startPage + maxVisiblePages - 1);
  
  // Adjust if we're at the end
  if (endPage - startPage + 1 < maxVisiblePages) {
    startPage = Math.max(1, endPage - maxVisiblePages + 1);
  }

  // First page and ellipsis if needed
  if (startPage > 1) {
    addBtn(1);
    if (startPage > 2) {
      const ellipsis = document.createElement('li');
      ellipsis.className = 'page-item disabled';
      ellipsis.innerHTML = '<span class="page-link">...</span>';
      holder.appendChild(ellipsis);
    }
  }

  // Visible page numbers
  for (let i = startPage; i <= endPage; i++) {
    addBtn(i);
  }

  // Last page and ellipsis if needed
  if (endPage < total) {
    if (endPage < total - 1) {
      const ellipsis = document.createElement('li');
      ellipsis.className = 'page-item disabled';
      ellipsis.innerHTML = '<span class="page-link">...</span>';
      holder.appendChild(ellipsis);
    }
    addBtn(total);
  }

  // Next
  const next = document.createElement('li');
  next.className = `page-item ${currentPage===total?'disabled':''}`;
  next.innerHTML = '<a class="page-link" href="#">Next</a>';
  if (currentPage < total) next.addEventListener('click', e => { e.preventDefault(); showPage(currentPage+1); });
  holder.appendChild(next);
}

// ========== UTILITIES ==========
console.log('✅ License Type script loaded with enhanced modal display');
</script>

{% endblock %}