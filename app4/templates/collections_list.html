{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    {% csrf_token %}
    <meta name="delete-url-pattern" content="{% url 'collections_delete' 0 %}">
    <meta name="status-update-url" content="{% url 'collection_update_status' 0 %}">
    
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">
            <i class="fas fa-money-check-alt me-2"></i>Collections
        </h2>
        <a href="{% url 'collections_add' %}" class="btn btn-primary">
            <i class="fas fa-plus me-1"></i>Add New Collection
        </a>
    </div>

    <!-- Search and Filter -->
    <div class="filter-card mb-4">
        <div class="filter-header">
            <h6><i class="fas fa-filter me-2"></i>Search & Filter</h6>
        </div>
        <div class="filter-body">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">Search Client</label>
                    <input type="text" id="searchInput" class="form-control" placeholder="Enter client name...">
                </div>

                <div class="col-md-2">
                    <label class="form-label">Branch</label>
                    <select id="branchFilter" class="form-select">
                        <option value="">All Branches</option>
                        <option value="IMC Mukkam">IMC Mukkam</option>
                        <option value="IMCB HO">IMCB HO</option>
                        <option value="IMCB DEV">IMCB DEV</option>
                        <option value="Sysmac Info System">Sysmac Info System</option>
                        <option value="Sysmac Computers">Sysmac Computers</option>
                        <option value="DQ Technologies">DQ Technologies</option>
                    </select>
                </div>

                <div class="col-md-2">
                    <label class="form-label">Created By</label>
                    <input type="text" id="userFilter" class="form-control" placeholder="Username...">
                </div>

                <div class="col-md-2">
                    <label class="form-label">Status</label>
                    <select id="statusFilter" class="form-select">
                        <option value="">All Status</option>
                        <option value="pending">Pending</option>
                        <option value="verified">Verified</option>
                        <option value="multiple entry">Multiple Entry</option>
                    </select>
                </div>

                <div class="col-md-2">
                    <label class="form-label">Date</label>
                    <input type="date" id="dateFilter" class="form-control">
                </div>
                
                <div class="col-md-1">
                    <label class="form-label">&nbsp;</label>
                    <button type="button" id="clearFilters" class="btn btn-secondary w-100">
                        <i class="fas fa-times"></i> Clear
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Collections Table -->
    <div class="table-card">
        {% if collections %}
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th width="3%">#</th>
                            <th width="15%">Client Name</th>
                            <th width="10%">Branch</th>
                            <th width="10%">Created By</th>
                            <th width="8%">Amount</th>
                            <th width="12%">Paid For</th>
                            <th width="10%">Status</th>
                            <th width="10%">Date</th>
                            <th width="8%">Screenshot</th>
                            <th width="14%">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="collectionsTableBody">
                        {% for collection in collections %}
                            <tr id="collection-row-{{ collection.id }}" 
                                data-client-name="{{ collection.client_name|lower }}"
                                data-branch="{{ collection.branch }}"
                                data-created-by="{{ collection.created_by|lower }}"
                                data-status="{{ collection.status }}"
                                data-date="{{ collection.created_at|date:'Y-m-d' }}">
                                <td>{{ forloop.counter }}</td>
                                <td>
                                    <strong>{{ collection.client_name }}</strong>
                                    {% if collection.notes %}
                                        <br><small class="text-muted">{{ collection.notes|truncatechars:30 }}</small>
                                    {% endif %}
                                </td>
                                <td><span class="badge bg-secondary">{{ collection.branch }}</span></td>
                                <td>{{ collection.created_by|default:"—" }}</td>
                                <td><strong class="text-success">₹{{ collection.amount|floatformat:2 }}</strong></td>
                                <td>{{ collection.paid_for|truncatechars:20 }}</td>
                                <td>
                                    <div class="dropdown">
                                        <button class="btn btn-sm dropdown-toggle status-btn status-{{ collection.status|slugify }}" 
                                                type="button" id="statusDropdown{{ collection.id }}" 
                                                data-bs-toggle="dropdown">
                                            {% if collection.status == 'pending' %}
                                                <i class="fas fa-clock"></i> Pending
                                            {% elif collection.status == 'verified' %}
                                                <i class="fas fa-check-circle"></i> Verified
                                            {% elif collection.status == 'multiple entry' %}
                                                <i class="fas fa-layer-group"></i> Multiple Entry
                                            {% endif %}
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li>
                                                <a class="dropdown-item status-option" href="#" 
                                                   data-status="pending" 
                                                   data-collection-id="{{ collection.id }}">
                                                    <i class="fas fa-clock text-warning"></i> Pending
                                                </a>
                                            </li>
                                            <li>
                                                <a class="dropdown-item status-option" href="#" 
                                                   data-status="verified" 
                                                   data-collection-id="{{ collection.id }}">
                                                    <i class="fas fa-check-circle text-success"></i> Verified
                                                </a>
                                            </li>
                                            <li>
                                                <a class="dropdown-item status-option" href="#" 
                                                   data-status="multiple entry" 
                                                   data-collection-id="{{ collection.id }}">
                                                    <i class="fas fa-layer-group text-info"></i> Multiple Entry
                                                </a>
                                            </li>
                                        </ul>
                                    </div>
                                </td>
                                <td>
                                    <small>{{ collection.created_at|date:"d M Y" }}<br>
                                    {{ collection.created_at|time:"H:i" }}</small>
                                </td>
                                <td>
                                    {% if collection.payment_screenshot %}
                                        <button class="btn btn-sm btn-info" 
                                                onclick="viewScreenshot('{{ collection.payment_screenshot.url }}', '{{ collection.client_name }}')">
                                            <i class="fas fa-image"></i>
                                        </button>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <a href="{% url 'collections_edit' collection.id %}" 
                                           class="btn btn-sm btn-warning" title="Edit">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <button class="btn btn-sm btn-danger" 
                                                onclick="deleteCollection(this, {{ collection.id }}, '{{ collection.client_name|escapejs }}')" 
                                                title="Delete">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                        <a href="{% url 'collection_receipt' collection.id %}" 
                                           class="btn btn-sm btn-primary" title="Receipt">
                                            <i class="fas fa-receipt"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            {% if is_paginated %}
                <nav aria-label="Page navigation" class="mt-3" id="paginationContainer">
                    <ul class="pagination justify-content-center">
                        {% if page_obj.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?page=1">First</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.previous_page_number }}">Previous</a>
                            </li>
                        {% endif %}

                        <li class="page-item active">
                            <span class="page-link">{{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
                        </li>

                        {% if page_obj.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.next_page_number }}">Next</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}">Last</a>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
            {% endif %}
        {% else %}
            <div class="empty-state">
                <i class="fas fa-money-check-alt fa-3x text-muted mb-3"></i>
                <h5>No collections found</h5>
                <p class="text-muted">Start by adding your first collection record.</p>
                <a href="{% url 'collections_add' %}" class="btn btn-primary">
                    <i class="fas fa-plus me-1"></i>Add First Collection
                </a>
            </div>
        {% endif %}
    </div>
</div>

<!-- Screenshot Modal -->
<div class="modal fade" id="screenshotModal" tabindex="-1">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-image me-2"></i>Payment Screenshot
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <div class="image-viewer">
                    <img id="screenshotImage" src="" alt="Payment Screenshot" class="screenshot-img">
                    <div class="zoom-controls">
                        <button class="btn btn-light" onclick="zoomIn()" title="Zoom In">
                            <i class="fas fa-search-plus"></i>
                        </button>
                        <button class="btn btn-light" onclick="zoomOut()" title="Zoom Out">
                            <i class="fas fa-search-minus"></i>
                        </button>
                        <button class="btn btn-light" onclick="resetZoom()" title="Reset Zoom">
                            <i class="fas fa-expand-arrows-alt"></i>
                        </button>
                        <span class="zoom-level">100%</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-body text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3 mb-0">Processing...</p>
            </div>
        </div>
    </div>
</div>

<script>
// Get CSRF token
function getCSRFToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]').value;
}

// Get URLs
function getDeleteUrl(collectionId) {
    const urlPattern = document.querySelector('meta[name="delete-url-pattern"]').content;
    return urlPattern.replace('0', collectionId);
}

function getStatusUpdateUrl(collectionId) {
    const urlPattern = document.querySelector('meta[name="status-update-url"]').content;
    return urlPattern.replace('0', collectionId);
}

// Store all rows data for filtering
let allRowsData = [];

// Initialize rows data on page load
function initializeRowsData() {
    const rows = document.querySelectorAll('#collectionsTableBody tr');
    allRowsData = Array.from(rows).map((row, index) => ({
        element: row,
        originalIndex: index + 1,
        clientName: (row.getAttribute('data-client-name') || '').toLowerCase(),
        branch: row.getAttribute('data-branch') || '',
        createdBy: (row.getAttribute('data-created-by') || '').toLowerCase(),
        status: row.getAttribute('data-status') || '',
        date: row.getAttribute('data-date') || ''
    }));
}

// Filter table
function filterTable() {
    const searchValue = document.getElementById('searchInput').value.toLowerCase().trim();
    const branchValue = document.getElementById('branchFilter').value;
    const userValue = document.getElementById('userFilter').value.toLowerCase().trim();
    const statusValue = document.getElementById('statusFilter').value;
    const dateValue = document.getElementById('dateFilter').value;

    let visibleCount = 0;
    const hasActiveFilter = searchValue || branchValue || userValue || statusValue || dateValue;

    // Hide pagination when filters active
    const paginationContainer = document.getElementById('paginationContainer');
    if (paginationContainer) {
        paginationContainer.style.display = hasActiveFilter ? 'none' : 'block';
    }

    // Filter and display rows
    allRowsData.forEach(rowData => {
        let showRow = true;

        if (searchValue && !rowData.clientName.includes(searchValue)) showRow = false;
        if (branchValue && rowData.branch !== branchValue) showRow = false;
        if (userValue && !rowData.createdBy.includes(userValue)) showRow = false;
        if (statusValue && rowData.status !== statusValue) showRow = false;
        if (dateValue && rowData.date !== dateValue) showRow = false;

        if (showRow) {
            rowData.element.style.display = '';
            visibleCount++;
            const firstCell = rowData.element.querySelector('td:first-child');
            if (firstCell) firstCell.textContent = visibleCount;
        } else {
            rowData.element.style.display = 'none';
        }
    });

    // Show no results message
    const tbody = document.getElementById('collectionsTableBody');
    let existingMessage = document.getElementById('noResultsMessage');
    
    if (visibleCount === 0 && !existingMessage) {
        const messageRow = document.createElement('tr');
        messageRow.id = 'noResultsMessage';
        messageRow.innerHTML = `
            <td colspan="10" class="text-center py-4">
                <i class="fas fa-search fa-2x text-muted mb-2 d-block"></i>
                <h6 class="text-muted">No collections match your filters</h6>
            </td>
        `;
        tbody.appendChild(messageRow);
    } else if (visibleCount > 0 && existingMessage) {
        existingMessage.remove();
    }
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Initialize rows data
    initializeRowsData();
    
    let searchTimeout;

    // Real-time search
    ['searchInput', 'userFilter'].forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(filterTable, 300);
            });
        }
    });

    // Dropdown filters
    ['branchFilter', 'statusFilter', 'dateFilter'].forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.addEventListener('change', filterTable);
        }
    });

    // Clear filters
    const clearBtn = document.getElementById('clearFilters');
    if (clearBtn) {
        clearBtn.addEventListener('click', function() {
            document.getElementById('searchInput').value = '';
            document.getElementById('branchFilter').value = '';
            document.getElementById('userFilter').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('dateFilter').value = '';
            filterTable();
        });
    }

    // Status update handlers
    document.querySelectorAll('.status-option').forEach(option => {
        option.addEventListener('click', function(e) {
            e.preventDefault();
            const collectionId = this.getAttribute('data-collection-id');
            const newStatus = this.getAttribute('data-status');
            updateCollectionStatus(collectionId, newStatus);
        });
    });
});

// Update collection status
function updateCollectionStatus(collectionId, newStatus) {
    const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
    loadingModal.show();

    fetch(getStatusUpdateUrl(collectionId), {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCSRFToken(),
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ status: newStatus })
    })
    .then(response => response.json())
    .then(data => {
        loadingModal.hide();
        if (data.success) {
            const statusBtn = document.querySelector(`#statusDropdown${collectionId}`);
            const row = document.getElementById(`collection-row-${collectionId}`);
            
            if (row) row.setAttribute('data-status', newStatus);
            
            if (statusBtn) {
                let btnClass = 'btn btn-sm dropdown-toggle status-btn ';
                let btnContent = '';
                
                if (newStatus === 'verified') {
                    btnClass += 'status-verified';
                    btnContent = '<i class="fas fa-check-circle"></i> Verified';
                } else if (newStatus === 'multiple entry') {
                    btnClass += 'status-multiple-entry';
                    btnContent = '<i class="fas fa-layer-group"></i> Multiple Entry';
                } else {
                    btnClass += 'status-pending';
                    btnContent = '<i class="fas fa-clock"></i> Pending';
                }
                
                statusBtn.className = btnClass;
                statusBtn.innerHTML = btnContent;
            }
            
            showAlert('success', data.message);
            setTimeout(() => location.reload(), 1000);
        } else {
            showAlert('danger', data.message || 'Status update failed');
        }
    })
    .catch(err => {
        loadingModal.hide();
        showAlert('danger', 'Network error: ' + err.message);
    });
}

// Zoom functionality
let currentZoom = 1;
const minZoom = 0.5;
const maxZoom = 3;
const zoomStep = 0.25;

function updateZoomLevel() {
    const img = document.getElementById('screenshotImage');
    const zoomLevel = document.querySelector('.zoom-level');
    
    img.style.transform = `scale(${currentZoom})`;
    zoomLevel.textContent = `${Math.round(currentZoom * 100)}%`;
}

function zoomIn() {
    if (currentZoom < maxZoom) {
        currentZoom += zoomStep;
        updateZoomLevel();
    }
}

function zoomOut() {
    if (currentZoom > minZoom) {
        currentZoom -= zoomStep;
        updateZoomLevel();
    }
}

function resetZoom() {
    currentZoom = 1;
    updateZoomLevel();
}

// View screenshot
function viewScreenshot(imageUrl, clientName) {
    const img = document.getElementById('screenshotImage');
    const modal = document.getElementById('screenshotModal');
    
    currentZoom = 1;
    
    img.src = imageUrl;
    img.style.transform = 'scale(1)';
    modal.querySelector('.modal-title').innerHTML = `<i class="fas fa-image me-2"></i>Payment Screenshot - ${clientName}`;
    
    new bootstrap.Modal(modal).show();
    
    setTimeout(() => {
        updateZoomLevel();
    }, 100);
}

// Mouse wheel zoom
document.addEventListener('DOMContentLoaded', function() {
    const screenshotModal = document.getElementById('screenshotModal');
    if (screenshotModal) {
        screenshotModal.addEventListener('wheel', function(e) {
            if (screenshotModal.classList.contains('show')) {
                e.preventDefault();
                if (e.deltaY < 0) {
                    zoomIn();
                } else {
                    zoomOut();
                }
            }
        });
    }
});

// Delete collection
function deleteCollection(btn, collectionId, clientName) {
    if (!confirm(`Delete collection for "${clientName}"?\n\nThis cannot be undone.`)) {
        return;
    }

    const row = btn.closest('tr');
    const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
    loadingModal.show();

    btn.disabled = true;

    fetch(getDeleteUrl(collectionId), {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCSRFToken(),
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        loadingModal.hide();
        if (data.success) {
            row.style.opacity = '0';
            setTimeout(() => {
                row.remove();
                initializeRowsData();
                filterTable();
            }, 300);
            showAlert('success', data.message);
            setTimeout(() => location.reload(), 1500);
        } else {
            showAlert('danger', data.message || 'Deletion failed');
            btn.disabled = false;
        }
    })
    .catch(err => {
        loadingModal.hide();
        showAlert('danger', 'Network error: ' + err.message);
        btn.disabled = false;
    });
}

// Show alert
function showAlert(type, message) {
    document.querySelectorAll('.alert-dismissible').forEach(alert => alert.remove());
    
    const alertHtml = `
        <div class="alert alert-${type} alert-dismissible fade show" 
             style="position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    document.body.insertAdjacentHTML('afterbegin', alertHtml);
    
    setTimeout(() => {
        const alert = document.querySelector('.alert-dismissible');
        if (alert) new bootstrap.Alert(alert).close();
    }, 5000);
}
</script>

<style>
/* Professional clean styles */
.filter-card {
    background: #ffffff;
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
}

.filter-header {
    padding: 14px 20px;
    background: #f8f9fa;
    border-bottom: 1px solid #e0e0e0;
    border-radius: 6px 6px 0 0;
}

.filter-header h6 {
    margin: 0;
    font-weight: 600;
    font-size: 15px;
    color: #2c3e50;
}

.filter-body {
    padding: 20px;
}

.form-label {
    font-size: 13px;
    font-weight: 500;
    color: #495057;
    margin-bottom: 6px;
}

.form-control, .form-select {
    border: 1px solid #ced4da;
    border-radius: 4px;
    font-size: 14px;
    padding: 8px 12px;
}

.form-control:focus, .form-select:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13,110,253,0.15);
}

.table-card {
    background: #ffffff;
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    padding: 0;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    overflow: hidden;
}

.table {
    margin-bottom: 0;
    font-size: 14px;
}

.table thead {
    background: #2c3e50;
    color: white;
}

.table thead th {
    font-weight: 600;
    font-size: 13px;
    padding: 14px 12px;
    border: none;
    text-transform: uppercase;
    letter-spacing: 0.3px;
}

.table tbody td {
    padding: 12px;
    vertical-align: middle;
    border-bottom: 1px solid #f0f0f0;
}

.table tbody tr {
    transition: background-color 0.15s ease;
}

.table tbody tr:hover {
    background-color: #f8f9fa;
}

.table tbody tr:last-child td {
    border-bottom: none;
}

.status-btn {
    min-width: 130px;
    font-size: 13px;
    font-weight: 500;
    padding: 6px 12px;
}

.status-pending {
    background: #ffc107;
    color: #000;
    border: none;
}

.status-pending:hover {
    background: #e0a800;
}

.status-verified {
    background: #28a745;
    color: white;
    border: none;
}

.status-verified:hover {
    background: #218838;
}

.status-multiple-entry {
    background: #17a2b8;
    color: white;
    border: none;
}

.status-multiple-entry:hover {
    background: #138496;
}

.btn-group .btn {
    padding: 6px 10px;
    font-size: 13px;
}

.badge {
    font-size: 12px;
    font-weight: 500;
    padding: 5px 10px;
}

.empty-state {
    text-align: center;
    padding: 60px 20px;
}

.pagination {
    margin: 20px 0;
}

.pagination .page-link {
    color: #2c3e50;
    border: 1px solid #dee2e6;
    padding: 8px 14px;
    font-size: 14px;
}

.pagination .page-item.active .page-link {
    background-color: #2c3e50;
    border-color: #2c3e50;
}

.image-viewer {
    position: relative;
    width: 100%;
    height: 100vh;
    overflow: auto;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #f5f5f5;
}

.screenshot-img {
    max-width: 100%;
    max-height: 100%;
    transition: transform 0.2s ease;
    cursor: zoom-in;
}

.zoom-controls {
    position: fixed;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.7);
    padding: 10px 20px;
    border-radius: 30px;
    display: flex;
    gap: 10px;
    align-items: center;
    z-index: 1000;
}

.zoom-controls .btn {
    padding: 8px 12px;
    border-radius: 6px;
}

.zoom-level {
    color: white;
    font-weight: 600;
    min-width: 50px;
    text-align: center;
}

@media (max-width: 768px) {
    .btn-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }
    
    .btn-group .btn {
        width: 100%;
    }
    
    .filter-body .row {
        gap: 15px 0 !important;
    }
}
</style>
{% endblock %}