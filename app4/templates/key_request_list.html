{%extends 'base.html'%}
{%block content%}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>All Key Requests</title>
    <style>
        /* ======  CSS RESET & BASE  ====== */
        *{box-sizing:border-box;margin:0;padding:0}
        body{
            font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
            background:#f5f5f5;color:#333;line-height:1.4;
        }
        .container{max-width:1800px;margin:0 auto;padding:20px}
        header{background:#fff;padding:20px;border-radius:8px;margin-bottom:20px;display:flex;justify-content:space-between;align-items:center}
        .btn-filter{background:#3498db;color:#fff;border:none;padding:10px 20px;border-radius:5px;font-weight:600;cursor:pointer;text-decoration:none}
        .btn-filter:hover{background:#2980b9}

        /* ======  FILTERS  ====== */
        .filters-container{background:#fff;padding:20px;border-radius:8px;margin-bottom:20px}
        .filters-row{display:flex;gap:15px;align-items:end;flex-wrap:wrap}
        .filter-group{display:flex;flex-direction:column;min-width:180px}
        .filter-group label{font-weight:600;margin-bottom:5px;color:#34495e}
        .filter-group input,.filter-group select{padding:10px;border:1px solid #ddd;border-radius:5px}
        .search-input{min-width:300px}
        .filter-buttons{display:flex;gap:10px}
        .btn-clear{background:#6c757d;color:#fff;border:none;padding:10px 20px;border-radius:5px;font-weight:600;cursor:pointer}
        .btn-clear:hover{background:#5a6268}
        .btn-add{background:#28a745;color:#fff;border:none;padding:10px 20px;border-radius:5px;font-weight:600;cursor:pointer;text-decoration:none}
        .btn-add:hover{background:#218838}

        /* ======  TABLE  ====== */
        .table-container{background:#fff;border-radius:8px;overflow:hidden;box-shadow:0 2px 10px rgba(0,0,0,.1)}
        table{width:100%;border-collapse:collapse}
        thead{background:#34495e;color:#fff}
        th,td{padding:12px;font-size:14px;border-bottom:1px solid #eee;text-align:left}
        th{font-weight:600}
        .request-details{max-width:280px;word-wrap:break-word}
        .client-name{font-weight:600;color:#2c3e50}
        .location{color:#7f8c8d;font-size:14px}
        .key-type{background:#ecf0f1;padding:4px 8px;border-radius:4px;font-size:12px;font-weight:500;display:inline-block;margin-bottom:5px}
        .date{color:#7f8c8d}
        .client-info{display:flex;align-items:center;gap:10px}
        .client-image,.client-placeholder{width:40px;height:40px;border-radius:50%;object-fit:cover;border:2px solid #ecf0f1}
        .client-placeholder{background:#ecf0f1;display:flex;align-items:center;justify-content:center;font-size:18px;color:#7f8c8d}
        .action-btns{display:flex;gap:6px;flex-direction:column}
        .btn-view,.btn-edit,.btn-delete{
            padding:8px 12px;border:none;border-radius:6px;font-size:12px;
            text-align:center;color:#fff;cursor:pointer;min-width:60px;
            font-weight:500;text-decoration:none;
            transition:all 0.3s ease;
            box-shadow:0 2px 4px rgba(0,0,0,0.1);
        }
        .btn-view{background:#6c757d;border:1px solid #5a6268}
        .btn-view:hover{background:#5a6268;transform:translateY(-1px);box-shadow:0 4px 8px rgba(0,0,0,0.15)}
        .btn-edit{background:#6c757d;border:1px solid #5a6268}
        .btn-edit:hover{background:#5a6268;transform:translateY(-1px);box-shadow:0 4px 8px rgba(0,0,0,0.15)}
        .btn-delete{background:#6c757d;border:1px solid #5a6268}
        .btn-delete:hover{background:#5a6268;transform:translateY(-1px);box-shadow:0 4px 8px rgba(0,0,0,0.15)}

        /* Status Dropdown with Dynamic Colors */
        .status-select{
            padding:8px 12px;
            border:2px solid;
            border-radius:20px;
            font-size:12px;
            font-weight:600;
            text-transform:uppercase;
            cursor:pointer;
            min-width:120px;
            text-align:center;
            transition:all 0.3s ease;
            outline:none;
        }

        /* Status colors for the dropdown */
        .status-select.status-pending{
            background:linear-gradient(135deg,#fff3cd,#ffeaa7);
            color:#856404;
            border-color:#ffc107;
        }
        .status-select.status-onprocess{
            background:linear-gradient(135deg,#cce5ff,#99d6ff);
            color:#004085;
            border-color:#007bff;
        }
        .status-select.status-accepted{
            background:linear-gradient(135deg,#d4edda,#a8e6a1);
            color:#155724;
            border-color:#28a745;
        }
        .status-select.status-rejected{
            background:linear-gradient(135deg,#f8d7da,#f1aeb5);
            color:#721c24;
            border-color:#dc3545;
        }

        .status-select:focus{
            transform:scale(1.05);
            box-shadow:0 4px 12px rgba(0,0,0,0.2);
        }

        .status-select:hover{
            transform:translateY(-1px);
            box-shadow:0 4px 8px rgba(0,0,0,0.15);
        }

        /* Amount display */
        .amount{font-weight:600;color:#e74c3c}
        .amount-empty{color:#7f8c8d;font-style:italic}

        /* Branch display */
        .branch{font-size:12px;color:#6c757d;background:#f8f9fa;padding:2px 6px;border-radius:3px}

        .results-info{padding:15px 20px;background:#f8f9fa;border-bottom:1px solid #eee;font-weight:600;color:#495057}

        /* ======  PAGINATION  ====== */
        .pagination-container{background:#fff;padding:20px;border-radius:8px;margin-top:20px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:15px}
        .pagination-info{color:#7f8c8d;font-weight:600}
        .pagination-controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
        .page-size-selector{display:flex;align-items:center;gap:10px}
        .page-size-selector select{padding:8px;border:1px solid #ddd;border-radius:4px}
        .pagination-buttons{display:flex;gap:5px}
        .pagination-btn{padding:8px 12px;border:1px solid #ddd;background:#fff;color:#333;text-decoration:none;border-radius:4px;cursor:pointer;font-weight:500}
        .pagination-btn:hover{background:#f8f9fa}
        .pagination-btn.active{background:#3498db;color:#fff;border-color:#3498db}
        .pagination-btn:disabled{opacity:0.5;cursor:not-allowed}
        .pagination-btn.disabled{opacity:0.5;cursor:not-allowed;background:#f8f9fa;color:#999}

        /* ======  MODAL  ====== */
        .modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.5)}
        .modal-content{background:#fff;margin:5% auto;padding:20px;border-radius:8px;width:90%;max-width:600px}
        .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}
        .modal-title{font-size:18px;font-weight:600}
        .close{color:#aaa;font-size:24px;font-weight:bold;cursor:pointer}
        .close:hover{color:#000}
        .modal-image{max-width:100%;border-radius:8px;margin:15px 0}
        .details-section{margin:10px 0}
        .details-label{font-weight:600;color:#34495e}
        .details-value{color:#7f8c8d;margin-bottom:8px}
        .no-results{text-align:center;padding:40px;color:#7f8c8d}
        .no-results-icon{font-size:48px;margin-bottom:10px}

        /* ======  RESPONSIVE  ====== */
        @media(max-width:768px){
            .filters-row{flex-direction:column;align-items:stretch}
            .filter-group{min-width:100%}
            .search-input{min-width:100%}
            .action-btns{flex-direction:row}
            .client-image,.client-placeholder{width:30px;height:30px}
            .pagination-container{flex-direction:column;text-align:center}
            .pagination-controls{justify-content:center}
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìùAll Key Requests</h1>
        </header>

        <!-- ==========  FILTERS  ========== -->
        <div class="filters-container">
            <div class="filters-row">
                <div class="filter-group">
                    <label for="searchInput">Search</label>
                    <input type="text" id="searchInput" class="search-input" placeholder="Search by client name, location, or key type...">
                </div>
                <div class="filter-group">
                    <label for="dateFilter">Date Filter</label>
                    <select id="dateFilter">
                        <option value="">All Dates</option>
                        <option value="today">Today</option>
                        <option value="yesterday">Yesterday</option>
                        <option value="last_week">Last Week</option>
                        <option value="this_month">This Month</option>
                        <option value="this_year">This Year</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="keyTypeFilter">Key Type</label>
                    <select id="keyTypeFilter">
                        <option value="">All Key Types</option>
                       <option value="Seat Upgradation Request">Seat Upgradation Request</option>
                        <option value="More Module Request">More Module Request</option>
                        <option value="Trade Name And Address Change Request">Trade Name And Address Change Request</option>
                        <option value="Key type Change Request">Key type Change Request</option>
                        <option value="Key Extension Request">Key Extension Request</option>
                        <option value="Hosted Key Request">Hosted Key Request</option>
                        <option value="Feeder Cancellation Request">Feeder Cancellation Request</option>
                        <option value="Demo Key Request">Demo Key Request</option>
                        <option value="Software Amount Change Request">Software Amount Change Request</option>
                        <option value="Maturity Upgradation Request">Maturity Upgradation Request</option>
                        <option value="Enterprises Key Request">Enterprises Key Request</option>
                        <option value="Image Request">Image Request</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="statusFilter">Status</label>
                    <select id="statusFilter">
                        <option value="">All Status</option>
                        <option value="pending">Pending</option>
                        <option value="on process">On Process</option>
                        <option value="accepted">Accepted</option>
                        <option value="rejected">Rejected</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="branchFilter">Branch</label>
                    <select id="branchFilter">
                        <option value="">All Branches</option>
                        {% for branch in branches %}
                        <option value="{{ branch.name|lower }}">{{ branch.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="filter-buttons">
                    <button type="button" class="btn-clear" onclick="clearFilters()">Clear</button>
                    <a href="{% url 'key_request' %}" class="btn-add">+ Add New Request</a>
                </div>
            </div>
        </div>

        <div class="results-info" id="resultsInfo">Showing all requests (sorted by ID: first to last)</div>

        <!-- ==========  TABLE  ========== -->
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>#Ô∏è‚É£ID</th>
                        <th>üë§Client</th>
                        <th>üìçLocation</th>
                        <th>üè¢Branch</th>
                        <th>üìùRequest Details</th>
                        <th>‚ÇπAmount</th>
                        <th>üóìÔ∏èDate Requested</th>
                        <th>üìäStatus</th>
                        <th>üîçView</th>
                        <th>‚úèÔ∏èEdit</th>
                        <th>üóëÔ∏èDelete</th>
                    </tr>
                </thead>
                <tbody id="requestsTableBody">
                    {% for request in key_requests %}
                    <tr class="request-row"
                        data-client="{{ request.clientName|default:'Unknown Client'|lower }}"
                        data-location="{{ request.location|lower }}"
                        data-keytype="{{ request.keyType|lower }}"
                        data-status="{{ request.status|lower }}"
                        data-branch="{% if request.branch %}{{ request.branch.name|lower }}{% endif %}"
                        data-date="{{ request.requestDate|date:'Y-m-d' }}"
                        data-search="{{ request.clientName|default:'Unknown Client'|lower }} {{ request.location|lower }} {{ request.keyType|lower }}">
                        <td>{{ forloop.counter }}</td>
                        <td>
                            <div class="client-info">
                                <div class="client-details">
                                    <div class="client-name">{{ request.clientName|default:"Unknown Client" }}</div>
                                </div>
                            </div>
                        </td>
                        <td><div class="location">{{ request.location }}</div></td>
                        <td>
                            {% if request.branch %}
                                <span class="branch">{{ request.branch.name }}</span>
                            {% else %}
                                <span class="branch">-</span>
                            {% endif %}
                        </td>
                        <td class="request-details">
                            <div class="key-type">{{ request.keyType }}</div>
                            <div class="details-value">{{ request.description|truncatechars:100 }}</div>
                        </td>
                        <td>
                            {% if request.amount %}
                                <span class="amount">{{ request.amount }}</span>
                            {% else %}
                                <span class="amount-empty">-</span>
                            {% endif %}
                        </td>
                        <td class="date">{{ request.requestDate|date:"d-m-Y" }}</td>
                        <td>
                            <select class="status-select status-{{ request.status|lower|cut:' '|default:'pending' }}" data-request-id="{{ request.id }}" onchange="updateStatusDirect(this)">
                                <option value="Pending" {% if request.status == 'Pending' %}selected{% endif %}>Pending</option>
                                <option value="On Process" {% if request.status == 'On Process' %}selected{% endif %}>On Process</option>
                                <option value="Accepted" {% if request.status == 'Accepted' %}selected{% endif %}>Accepted</option>
                                <option value="Rejected" {% if request.status == 'Rejected' %}selected{% endif %}>Rejected</option>
                            </select>
                        </td>

                        <!-- VIEW -->
                        <td>
                            <button class="btn-view"
                                    data-id="{{ forloop.counter }}"
                                    data-client="{{ request.clientName|default:'Unknown Client' }}"
                                    data-location="{{ request.location }}"
                                    data-key-type="{{ request.keyType }}"
                                    data-date="{{ request.requestDate|date:'d M Y' }}"
                                    data-status="{{ request.status }}"
                                    data-amount="{{ request.amount|default:'' }}"
                                    data-branch="{% if request.branch %}{{ request.branch.name }}{% endif %}"
                                    data-img="{% if request.requestImage %}{{ request.requestImage.url }}{% endif %}"
                                    data-desc="{{ request.description|escapejs }}"
                                    data-request-id="{{ request.id }}">
                                View
                            </button>
                        </td>

                        <!-- EDIT -->
                        <td><a href="{% url 'key_request_edit' request.id %}" class="btn-edit">Edit</a></td>

                        <!-- DELETE -->
                        <td>
                            <form action="{% url 'key_request_delete' request.id %}" method="POST" style="display:inline;">
                                {% csrf_token %}
                                <button type="submit" class="btn-delete"
                                        onclick="return confirm('Delete this request?');">
                                    Delete
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% empty %}
                    <tr class="no-data-row">
                        <td colspan="11" class="no-results">
                            <div class="no-results-icon">üìã</div>
                            <div style="font-size:18px;font-weight:600;">No key requests found</div>
                            <div style="margin-top:10px;">
                                <a href="{% url 'key_request' %}" class="btn-filter">Create your first request</a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- ==========  PAGINATION  ========== -->
        <div class="pagination-container" id="paginationContainer">
            <div class="pagination-info" id="paginationInfo"></div>
            <div class="pagination-controls">
                <div class="page-size-selector">
                    <label for="pageSize">Show:</label>
                    <select id="pageSize">
                        <option value="10">10</option>
                        <option value="25" selected>25</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                    <span>per page</span>
                </div>
                <div class="pagination-buttons" id="paginationButtons"></div>
            </div>
        </div>
    </div>

    <!-- CSRF Token for AJAX requests -->
    {% csrf_token %}

    <!-- Modals + JS -->
    <div id="detailsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Request Details</h3>
                <span class="close" onclick="closeDetailsModal()">&times;</span>
            </div>
            <div id="detailsBody"></div>
        </div>
    </div>

    <div id="imageModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Request Image</h3>
                <span class="close" onclick="closeImageModal()">&times;</span>
            </div>
            <img id="modalImage" class="modal-image" style="max-width:100%;">
        </div>
    </div>

    <!-- ==========  JAVASCRIPT  ========== -->
    <script>
        /* Delegated View button handler */
        document.addEventListener('click', e => {
            if (e.target.classList.contains('btn-view')) {
                const d = e.target.dataset;
                viewDetails(d.id, d.client, d.location, d.keyType, d.date, d.status, d.amount, d.branch, d.img, d.desc, d.requestId);
            }
        });

        let originalRows = [];
        let filteredRows = [];
        let filteredCount = 0;
        let totalCount   = 0;
        let currentPage = 1;
        let pageSize = 25;

        document.addEventListener('DOMContentLoaded', () => {
            originalRows = [...document.querySelectorAll('.request-row')];
            totalCount   = originalRows.length;
            filteredRows = [...originalRows];
            filteredCount = totalCount;
            sortByNewest();
            initializeEventListeners();
            initializeStatusColors();
            updateResultsInfo();
            updatePagination();
        });

        function initializeEventListeners() {
            ['searchInput','dateFilter','keyTypeFilter','statusFilter','branchFilter'].forEach(id=>{
                document.getElementById(id).addEventListener('input', applyFilters);
                document.getElementById(id).addEventListener('change', applyFilters);
            });
            
            document.getElementById('pageSize').addEventListener('change', (e) => {
                pageSize = parseInt(e.target.value);
                currentPage = 1;
                updatePagination();
            });
        }

        function initializeStatusColors() {
            document.querySelectorAll('.status-select').forEach(select => {
                updateStatusClass(select, select.value);
            });
        }

        function sortByNewest(){
            const tbody = document.getElementById('requestsTableBody');
            const rows  = [...tbody.querySelectorAll('.request-row')];
            rows.sort((a,b)=>parseInt(a.cells[0].textContent)-parseInt(b.cells[0].textContent));
            rows.forEach(r=>tbody.appendChild(r));
            originalRows = [...rows];
        }

        function getDateRange(filterType) {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            
            switch(filterType) {
                case 'today':
                    return {
                        start: today,
                        end: new Date(today.getTime() + 24*60*60*1000 - 1)
                    };
                case 'yesterday':
                    const yesterday = new Date(today.getTime() - 24*60*60*1000);
                    return {
                        start: yesterday,
                        end: new Date(yesterday.getTime() + 24*60*60*1000 - 1)
                    };
                case 'last_week':
                    const lastWeekStart = new Date(today.getTime() - 7*24*60*60*1000);
                    return {
                        start: lastWeekStart,
                        end: today
                    };
                case 'this_month':
                    const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                    return {
                        start: monthStart,
                        end: now
                    };
                case 'this_year':
                    const yearStart = new Date(now.getFullYear(), 0, 1);
                    return {
                        start: yearStart,
                        end: now
                    };
                default:
                    return null;
            }
        }

        function applyFilters(){
            const search = document.getElementById('searchInput').value.toLowerCase();
            const dateFilter = document.getElementById('dateFilter').value;
            const type = document.getElementById('keyTypeFilter').value.toLowerCase();
            const status = document.getElementById('statusFilter').value.toLowerCase();
            const branch = document.getElementById('branchFilter').value.toLowerCase();
            
            const dateRange = getDateRange(dateFilter);
            
            filteredRows = [];
            filteredCount = 0;
            
            originalRows.forEach(row=>{
                let show = true;
                
                if(search && !row.dataset.search.includes(search)) show=false;
                if(type && row.dataset.keytype !== type) show=false;
                if(status && row.dataset.status !== status) show=false;
                if(branch && row.dataset.branch !== branch) show=false;
                
                if(dateRange) {
                    const rowDate = new Date(row.dataset.date);
                    if(rowDate < dateRange.start || rowDate > dateRange.end) show=false;
                }
                
                if(show) {
                    filteredRows.push(row);
                    filteredCount++;
                }
            });
            
            currentPage = 1;
            toggleNoResultsRow();
            updateResultsInfo();
            updatePagination();
        }

        function toggleNoResultsRow(){
            const tbody = document.getElementById('requestsTableBody');
            let noRow = tbody.querySelector('.no-data-row');
            if(filteredCount === 0 && totalCount > 0){
                if(!noRow){
                    tbody.insertAdjacentHTML('beforeend',`
                        <tr class="no-data-row">
                            <td colspan="11" class="no-results">
                                <div class="no-results-icon">üîç</div>
                                <div style="font-size:18px;font-weight:600;">No requests match your filters</div>
                                <div style="margin-top:10px;"><button class="btn-clear" onclick="clearFilters()">Clear Filters</button></div>
                            </td>
                        </tr>
                    `);
                }
            }else if(noRow){
                noRow.remove();
            }
        }

        function clearFilters(){
            ['searchInput','dateFilter','keyTypeFilter','statusFilter','branchFilter'].forEach(id=>document.getElementById(id).value='');
            applyFilters();
        }

        function updateResultsInfo(){
            const el = document.getElementById('resultsInfo');
            if(totalCount === 0){
                el.textContent = 'No requests found';
            }else if(document.getElementById('searchInput').value || document.getElementById('dateFilter').value || document.getElementById('keyTypeFilter').value || document.getElementById('statusFilter').value || document.getElementById('branchFilter').value){
                el.textContent = `Showing ${filteredCount} of ${totalCount} requests (filtered, ID: first to last)`;
            }else{
                el.textContent = `Showing all ${totalCount} requests (sorted by ID: first to last)`;
            }
        }

        function updatePagination() {
            const tbody = document.getElementById('requestsTableBody');
            
            // Hide all rows first
            originalRows.forEach(row => row.style.display = 'none');
            
            if(filteredCount === 0) {
                document.getElementById('paginationContainer').style.display = 'none';
                return;
            }
            
            document.getElementById('paginationContainer').style.display = 'flex';
            
            const totalPages = Math.ceil(filteredCount / pageSize);
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = Math.min(startIndex + pageSize, filteredCount);
            
            // Show current page rows
            for(let i = startIndex; i < endIndex; i++) {
                if(filteredRows[i]) {
                    filteredRows[i].style.display = '';
                }
            }
            
            // Update pagination info
            const paginationInfo = document.getElementById('paginationInfo');
            paginationInfo.textContent = `Showing ${startIndex + 1}-${endIndex} of ${filteredCount} results`;
            
            // Update pagination buttons
            updatePaginationButtons(totalPages);
        }

        function updatePaginationButtons(totalPages) {
            const buttonsContainer = document.getElementById('paginationButtons');
            buttonsContainer.innerHTML = '';
            
            if(totalPages <= 1) return;
            
            // Previous button
            const prevBtn = document.createElement('button');
            prevBtn.textContent = '‚Äπ Previous';
            prevBtn.className = `pagination-btn ${currentPage === 1 ? 'disabled' : ''}`;
            prevBtn.disabled = currentPage === 1;
            prevBtn.onclick = () => goToPage(currentPage - 1);
            buttonsContainer.appendChild(prevBtn);
            
            // Page numbers
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            if(endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            if(startPage > 1) {
                const firstBtn = document.createElement('button');
                firstBtn.textContent = '1';
                firstBtn.className = 'pagination-btn';
                firstBtn.onclick = () => goToPage(1);
                buttonsContainer.appendChild(firstBtn);
                
                if(startPage > 2) {
                    const ellipsis = document.createElement('span');
                    ellipsis.textContent = '...';
                    ellipsis.className = 'pagination-btn disabled';
                    buttonsContainer.appendChild(ellipsis);
                }
            }
            
            for(let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.textContent = i;
                pageBtn.className = `pagination-btn ${i === currentPage ? 'active' : ''}`;
                pageBtn.onclick = () => goToPage(i);
                buttonsContainer.appendChild(pageBtn);
            }
            
            if(endPage < totalPages) {
                if(endPage < totalPages - 1) {
                    const ellipsis = document.createElement('span');
                    ellipsis.textContent = '...';
                    ellipsis.className = 'pagination-btn disabled';
                    buttonsContainer.appendChild(ellipsis);
                }
                
                const lastBtn = document.createElement('button');
                lastBtn.textContent = totalPages;
                lastBtn.className = 'pagination-btn';
                lastBtn.onclick = () => goToPage(totalPages);
                buttonsContainer.appendChild(lastBtn);
            }
            
            // Next button
            const nextBtn = document.createElement('button');
            nextBtn.textContent = 'Next ‚Ä∫';
            nextBtn.className = `pagination-btn ${currentPage === totalPages ? 'disabled' : ''}`;
            nextBtn.disabled = currentPage === totalPages;
            nextBtn.onclick = () => goToPage(currentPage + 1);
            buttonsContainer.appendChild(nextBtn);
        }

        function goToPage(page) {
            const totalPages = Math.ceil(filteredCount / pageSize);
            if(page < 1 || page > totalPages) return;
            
            currentPage = page;
            updatePagination();
        }

        // Helper function to get CSRF token from cookies
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Direct status update function with dynamic color change
        async function updateStatusDirect(selectElement) {
            const requestId = selectElement.dataset.requestId;
            const newStatus = selectElement.value;
            const row = selectElement.closest('tr');
            
            // Get CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]') ? 
                document.querySelector('[name=csrfmiddlewaretoken]').value : 
                getCookie('csrftoken');
            
            // Update visual status immediately
            updateStatusClass(selectElement, newStatus);
            
            // Update the row's data attribute for filtering
            row.dataset.status = newStatus.toLowerCase();
            
            try {
                const response = await fetch(`/app4/key-requests/${requestId}/update-status/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({ status: newStatus })
                });
                
                const result = await response.json().catch(() => null);
                
                if (response.ok && result?.success) {
                    // Show success animation
                    selectElement.style.transform = 'scale(1.1)';
                    setTimeout(() => {
                        selectElement.style.transform = '';
                    }, 200);
                } else {
                    // Get error message from response
                    const errorMsg = result?.message || `HTTP ${response.status}: ${response.statusText}`;
                    alert(`Failed to update status: ${errorMsg}`);
                    console.error('Update failed:', errorMsg, result);
                    // Revert the select to original value
                    location.reload();
                }
            } catch (error) {
                console.error('Error updating status:', error);
                alert('Error updating status. Please refresh the page.');
                // Revert by reloading
                location.reload();
            }
        }

        // Function to update status class and colors based on selection
        function updateStatusClass(selectElement, status) {
            // Remove all status classes
            selectElement.classList.remove('status-pending', 'status-onprocess', 'status-accepted', 'status-rejected');
            
            // Add appropriate class based on status with smooth transition
            selectElement.style.transition = 'all 0.3s ease';
            
            switch(status.toLowerCase()) {
                case 'pending':
                    selectElement.classList.add('status-pending');
                    break;
                case 'on process':
                    selectElement.classList.add('status-onprocess');
                    break;
                case 'accepted':
                    selectElement.classList.add('status-accepted');
                    break;
                case 'rejected':
                    selectElement.classList.add('status-rejected');
                    break;
            }
        }

        function viewDetails(id, client, location, keyType, date, status, amount, branch, img, desc, requestId){
            const body = document.getElementById('detailsBody');
            body.innerHTML = `
                <div class="details-section"><div class="details-label">Request ID:</div><div class="details-value">${id}</div></div>
                <div class="details-section"><div class="details-label">Client Name:</div><div class="details-value">${client}</div></div>
                <div class="details-section"><div class="details-label">Location:</div><div class="details-value">${location}</div></div>
                <div class="details-section"><div class="details-label">Branch:</div><div class="details-value">${branch || 'Not assigned'}</div></div>
                <div class="details-section"><div class="details-label">Key Type:</div><div class="details-value">${keyType}</div></div>
                <div class="details-section"><div class="details-label">Amount:</div><div class="details-value">${amount ? amount : 'Not specified'}</div></div>
                <div class="details-section"><div class="details-label">Description:</div><div class="details-value">${desc}</div></div>
                <div class="details-section"><div class="details-label">Date Requested:</div><div class="details-value">${date}</div></div>
                <div class="details-section"><div class="details-label">Current Status:</div><div class="details-value">${status}</div></div>
                ${img ? `<div class="details-section"><div class="details-label">Request Image:</div><img src="${img}" class="modal-image"></div>` : ''}
            `;
            
            document.getElementById('detailsModal').style.display='block';
        }

        function closeDetailsModal(){ document.getElementById('detailsModal').style.display='none'; }
        function closeImageModal(){   document.getElementById('imageModal').style.display='none'; }

        /* Close modals on outside click */
        window.onclick = e=>{
            if(e.target.classList.contains('modal')){
                e.target.style.display='none';
            }
        };
    </script>
</body>
</html>
{%endblock%}