{% extends "base.html" %}

{% block content %}
<style>
    *{margin:0;padding:0;box-sizing:border-box}
    .monitoring-container{font-family:Arial,sans-serif;background:#f5f5f5;padding:20px;min-height:100vh}
    .container{max-width:1200px;margin:0 auto}
    .header{background:#2c3e50;color:#fff;padding:20px 30px;border-radius:4px;margin-bottom:20px;display:flex;justify-content:space-between;align-items:center}
    .header h1{font-size:1.5em;font-weight:normal}
    .back-btn{padding:8px 16px;background:#34495e;color:#fff;text-decoration:none;border-radius:3px;font-size:.9em;transition:.3s}
    .back-btn:hover{background:#415a77}
    .content-box{background:#fff;border-radius:4px;box-shadow:0 2px 4px rgba(0,0,0,.1);padding:20px;margin-bottom:20px}
    .section-title{font-size:1.2em;color:#2c3e50;margin-bottom:20px;padding-bottom:10px;border-bottom:2px solid #3498db}
    .vehicle-picker{display:flex;gap:10px;align-items:center;margin-bottom:25px;flex-wrap:wrap}
    .vehicle-picker select,.vehicle-picker input{padding:8px 12px;font-size:1em;border:1px solid #ccc;border-radius:3px}
    .vehicle-picker input[type="date"]{min-width:150px}
    .vehicle-picker button{padding:8px 16px;background:#27ae60;color:#fff;border:none;border-radius:3px;cursor:pointer}
    .vehicle-picker button:hover{background:#229954}
    .vehicle-picker button.clear-btn{background:#e74c3c}
    .vehicle-picker button.clear-btn:hover{background:#c0392b}
    .metrics{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:30px}
    .metric-box{background:#f8f9fa;border-left:4px solid #3498db;padding:20px;border-radius:5px;text-align:center}
    .metric-box.success{border-left-color:#27ae60}
    .metric-box.warning{border-left-color:#f39c12}
    .metric-box.danger{border-left-color:#e74c3c}
    .metric-label{font-size:.85em;color:#7f8c8d;text-transform:uppercase;margin-bottom:10px;letter-spacing:.5px}
    .metric-value{font-size:2em;font-weight:600;color:#2c3e50}
    .metric-unit{font-size:.6em;color:#7f8c8d;margin-left:3px}
    table{width:100%;border-collapse:collapse;margin-top:20px}
    thead{background:#34495e;color:#fff}
    th{padding:12px;text-align:left;font-weight:600;font-size:.85em}
    td{padding:12px;border-bottom:1px solid #e0e0e0}
    tbody tr:hover{background:#f8f9fa}
    tbody tr:last-child td{border-bottom:none}
    .positive{color:#27ae60}
    .negative{color:#e74c3c}
    .no-data{text-align:center;padding:40px;color:#7f8c8d}
    .traveller-list{margin-top:15px;font-size:.95em;color:#2c3e50}
    .traveller-list strong{color:#2c3e50}
    .filter-row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:15px}
    .filter-group{display:flex;flex-direction:column;gap:5px}
    .filter-group label{font-size:0.85em;color:#555;font-weight:600}
    
    /* Searchable dropdown styles */
    .search-select-wrapper {
        position: relative;
        display: inline-block;
    }
    .search-select-wrapper input[type="text"] {
        padding: 8px 30px 8px 12px;
        font-size: 1em;
        border: 1px solid #ccc;
        border-radius: 3px;
        min-width: 200px;
        cursor: pointer;
    }
    .search-select-wrapper .dropdown-arrow {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        pointer-events: none;
        color: #666;
    }
    .search-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ccc;
        border-top: none;
        max-height: 200px;
        overflow-y: auto;
        display: none;
        z-index: 1000;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .search-dropdown.show {
        display: block;
    }
    .search-dropdown-item {
        padding: 10px 12px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
    }
    .search-dropdown-item:hover {
        background: #f8f9fa;
    }
    .search-dropdown-item.selected {
        background: #e3f2fd;
    }
    
    @media(max-width:768px){
        .header{flex-direction:column;gap:10px;align-items:flex-start}
        .metrics{grid-template-columns:1fr}
        table{font-size:.85em}
        th,td{padding:8px}
        .filter-row{flex-direction:column;align-items:flex-start}
    }
</style>

<div class="monitoring-container">
  <div class="container">

    <div class="header">
      <h1>Vehicle Ledger</h1>
      <a href="{% url 'fuel_management' %}" class="back-btn">← Back</a>
    </div>

    <!-- vehicle and user picker with date filters -->
    <div class="content-box">
      <form method="get" id="filterForm">
        <!-- First Row: Vehicle and User -->
        <div class="filter-row">
          <div class="filter-group">
            <label><strong>Select vehicle:</strong></label>
            <select name="vid" required>
              <option value="">-- choose --</option>
              {% for v in vehicles %}
                <option value="{{ v.id }}" {% if v.id == selected_id %}selected{% endif %}>{{ v.vehicle_number }}</option>
              {% endfor %}
            </select>
          </div>
          
          <div class="filter-group">
            <label><strong>Select user:</strong></label>
            <div class="search-select-wrapper">
              <input type="text" 
                     id="userSearch" 
                     placeholder="-- All Users --" 
                     autocomplete="off"
                     value="{% if selected_user_id %}{% for u in users %}{% if u.id == selected_user_id %}{{ u.get_full_name|default:u.username }}{% endif %}{% endfor %}{% endif %}">
              <span class="dropdown-arrow">▼</span>
              <input type="hidden" name="user_id" id="userIdInput" value="{{ selected_user_id|default:'' }}">
              <div class="search-dropdown" id="userDropdown">
                <div class="search-dropdown-item" data-value="">-- All Users --</div>
                {% for u in users %}
                  <div class="search-dropdown-item" data-value="{{ u.id }}">
                    {{ u.get_full_name|default:u.username }}
                  </div>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>

        <!-- Second Row: Date Filters -->
        <div class="filter-row">
          <div class="filter-group">
            <label><strong>From Date:</strong></label>
            <input type="date" 
                   name="date_from" 
                   id="dateFrom"
                   value="{{ date_from|default:'' }}"
                   style="padding:8px 12px;font-size:1em;border:1px solid #ccc;border-radius:3px;">
          </div>

          <div class="filter-group">
            <label><strong>To Date:</strong></label>
            <input type="date" 
                   name="date_to" 
                   id="dateTo"
                   value="{{ date_to|default:'' }}"
                   style="padding:8px 12px;font-size:1em;border:1px solid #ccc;border-radius:3px;">
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="filter-row">
          <button type="submit" 
                  class="show-btn" 
                  style="background:linear-gradient(90deg,#3498db,#2ecc71); color:white; padding:10px 20px; border:none; border-radius:25px; text-decoration:none; font-weight:600; box-shadow:0 3px 6px rgba(0,0,0,0.2); transition:0.3s;">
            Show
          </button>

          <button type="button" 
                  onclick="clearFilters()" 
                  class="clear-btn"
                  style="background:#e74c3c; color:white; padding:10px 20px; border:none; border-radius:25px; font-weight:600; box-shadow:0 3px 6px rgba(0,0,0,0.2); transition:0.3s; cursor:pointer;">
            Clear Filters
          </button>

          <a href="{% url 'total_summary' %}" 
             class="back-btn" 
             style="background:linear-gradient(90deg,#3498db,#2ecc71); color:white; padding:10px 20px; border:none; border-radius:25px; text-decoration:none; font-weight:600; box-shadow:0 3px 6px rgba(0,0,0,0.2); transition:0.3s;">
             Total Summary →
          </a>
        </div>
      </form>

      <style>
      .show-btn:hover,
      .clear-btn:hover,
      .back-btn:hover {
          transform: translateY(-2px);
          box-shadow: 0 5px 10px rgba(0, 0, 0, 0.3);
      }
      </style>

      {% if selected_vehicle %}
        <div class="traveller-list">
          <strong>Users who have travelled {{ selected_vehicle.vehicle_number }}:</strong><br>
          {% if vehicle_travelers %}
            {% for u in vehicle_travelers %}
              {{ u.get_full_name|default:u.username }}{% if not forloop.last %}, {% endif %}
            {% endfor %}
          {% else %}
            <span style="color:#7f8c8d">No travellers recorded yet.</span>
          {% endif %}
        </div>
      {% endif %}
    </div>

    {% if selected_vehicle %}
      <!-- summary card -->
      <div class="content-box">
        <h2 class="section-title">Summary for {{ selected_vehicle.vehicle_number }}
          {% if date_from or date_to %}
            <span style="font-size:0.8em;color:#7f8c8d;">
              ({% if date_from %}From: {{ date_from }}{% endif %}
              {% if date_to %} To: {{ date_to }}{% endif %})
            </span>
          {% endif %}
        </h2>
        <div class="metrics">
          <div class="metric-box primary">
            <div class="metric-label">Trips</div>
            <div class="metric-value">{{ summary.trips }}</div>
          </div>

          <div class="metric-box success">
            <div class="metric-label">Total Distance</div>
            <div class="metric-value">{{ summary.distance|floatformat:0 }}<span class="metric-unit">km</span></div>
          </div>

          <div class="metric-box warning">
            <div class="metric-label">Total Fuel Cost (actual)</div>
            <div class="metric-value">₹{{ summary.cost|floatformat:0 }}</div>
          </div>

          <div class="metric-box" style="border-left-color:#17a2b8">
            <div class="metric-label">Mileage Of Selected Vehicle</div>
            <div class="metric-value">{{ selected_vehicle.avg_mileage|floatformat:2 }}<span class="metric-unit">km/l</span></div>
          </div>

          <div class="metric-box" style="border-left-color:#20c997">
            <div class="metric-label">Total Litres (estimated)</div>
            <div class="metric-value">{{ summary.total_litres|floatformat:2 }}<span class="metric-unit">l</span></div>
          </div>

          <div class="metric-box" style="border-left-color:#17a2b8">
            <div class="metric-label">Total km possible with fuel</div>
            <div class="metric-value">{{ summary.total_km_from_fuel|floatformat:0 }}<span class="metric-unit">km</span></div>
          </div>

          <div class="metric-box" style="border-left-color:#f39c12">
            <div class="metric-label">Expected Cost (at used rate)</div>
            <div class="metric-value">₹{{ summary.expected_cost|floatformat:0 }}</div>
          </div>
        </div>
      </div>

      <!-- trip table -->
      <div class="content-box">
        <h2 class="section-title">Trip Details</h2>
        {% if trips %}
          <div style="overflow-x:auto">
            <table>
              <thead>
                <tr>
                  <th>date</th>
                  <th>start</th>
                  <th>end</th>
                  <th>distance (km)</th>
                  <th>fuel cost (₹)</th>
                  <th>total fuel (l)</th>
                  <th>fuel used for dst (l)</th>
                  <th>fuel left (l)</th>
                  <th>cost for dst (₹)</th>
                  <th>travelled by</th>
                </tr>
              </thead>
              <tbody>
                {% for t in trips %}
                  <tr>
                    <td>{% if t.date %}{{ t.date|date:"d-M-Y" }}{% else %}—{% endif %}</td>
                    <td>{% if t.start_time %}{{ t.start_time|time:"h:i A" }}{% else %}—{% endif %}</td>
                    <td>{% if t.end_time %}{{ t.end_time|time:"h:i A" }}{% else %}—{% endif %}</td>
                    <td>{{ t.distance|floatformat:0 }}</td>
                    <td>₹{{ t.cost|floatformat:0 }}</td>
                    <td>{{ t.fuel_used|floatformat:2 }}</td>
                    <td>
                      {% if t.fuel_consumed_for_distance is not None %}
                        {{ t.fuel_consumed_for_distance|floatformat:2 }} l
                      {% else %}
                        —
                      {% endif %}
                    </td>
                    <td>{{ t.fuel_balance|floatformat:2 }}</td>
                    <td>
                      {% if t.cost_for_distance is not None %}
                        ₹{{ t.cost_for_distance|floatformat:0 }}
                      {% else %}
                        —
                      {% endif %}
                    </td>
                    <td>{{ t.travelled_by }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="no-data">No trips for this vehicle{% if date_from or date_to %} in the selected date range{% endif %}.</div>
        {% endif %}
      </div>
    {% endif %}
  </div>
</div>

<script>
function clearFilters() {
    // Get the vehicle select value (we want to keep this)
    const vehicleSelect = document.querySelector('select[name="vid"]');
    const vehicleValue = vehicleSelect ? vehicleSelect.value : '';
    
    // Redirect to the page with only the vehicle parameter
    if (vehicleValue) {
        window.location.href = '?vid=' + vehicleValue;
    } else {
        window.location.href = window.location.pathname;
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('userSearch');
    const dropdown = document.getElementById('userDropdown');
    const hiddenInput = document.getElementById('userIdInput');
    const dropdownItems = dropdown.querySelectorAll('.search-dropdown-item');
    
    // Show dropdown when clicking on input
    searchInput.addEventListener('click', function(e) {
        e.stopPropagation();
        dropdown.classList.toggle('show');
        filterDropdown();
    });
    
    // Filter dropdown items based on search
    searchInput.addEventListener('input', function() {
        filterDropdown();
    });
    
    function filterDropdown() {
        const searchTerm = searchInput.value.toLowerCase();
        let hasVisibleItems = false;
        
        dropdownItems.forEach(item => {
            const text = item.textContent.toLowerCase();
            if (text.includes(searchTerm)) {
                item.style.display = 'block';
                hasVisibleItems = true;
            } else {
                item.style.display = 'none';
            }
        });
        
        if (hasVisibleItems) {
            dropdown.classList.add('show');
        }
    }
    
    // Select item from dropdown
    dropdownItems.forEach(item => {
        item.addEventListener('click', function() {
            const value = this.getAttribute('data-value');
            const text = this.textContent;
            
            searchInput.value = text;
            hiddenInput.value = value;
            
            // Update selected state
            dropdownItems.forEach(i => i.classList.remove('selected'));
            this.classList.add('selected');
            
            dropdown.classList.remove('show');
        });
    });
    
    // Close dropdown when clicking outside
    document.addEventListener('click', function() {
        dropdown.classList.remove('show');
    });
    
    // Prevent dropdown from closing when clicking inside it
    dropdown.addEventListener('click', function(e) {
        e.stopPropagation();
    });
    
    // Set initial selected state
    const selectedValue = hiddenInput.value;
    if (selectedValue) {
        dropdownItems.forEach(item => {
            if (item.getAttribute('data-value') === selectedValue) {
                item.classList.add('selected');
            }
        });
    }
    
    // Date validation
    const dateFrom = document.getElementById('dateFrom');
    const dateTo = document.getElementById('dateTo');
    
    if (dateFrom && dateTo) {
        dateFrom.addEventListener('change', function() {
            if (dateTo.value && this.value > dateTo.value) {
                alert('From Date cannot be later than To Date');
                this.value = '';
            }
        });
        
        dateTo.addEventListener('change', function() {
            if (dateFrom.value && this.value < dateFrom.value) {
                alert('To Date cannot be earlier than From Date');
                this.value = '';
            }
        });
    }
});
</script>

{% endblock %}