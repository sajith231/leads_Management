{% extends "base.html" %}
{% block content %}

<style>
    *{margin:0;padding:0;box-sizing:border-box}
    .fuel-entry-container{font-family:Arial,sans-serif;background:#f5f5f5;padding:20px;line-height:1.6}
    .container{max-width:900px;margin:0 auto;background:#fff;border-radius:4px;box-shadow:0 2px 4px rgba(0,0,0,.1)}
    .header{background:#2c3e50;color:#fff;padding:20px 30px;border-radius:4px 4px 0 0}
    .header h1{font-size:1.5em;font-weight:normal}
    .status{font-size:.95em;opacity:.9;margin-top:6px}
    .messages{margin:20px 30px}
    .alert{padding:12px 20px;border-radius:4px;margin-bottom:10px}
    .alert-success{background:#d4edda;color:#155724;border:1px solid #c3e6cb}
    .alert-error{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb}
    .form-container{padding:30px}
    .user-info{background:#e3f2fd;border-left:4px solid #2196F3;padding:12px 15px;margin-bottom:20px;border-radius:3px;font-size:0.95em}
    .section{margin-bottom:30px;padding-bottom:25px;border-bottom:1px solid #e0e0e0}
    .section:last-of-type{border-bottom:none}
    .section-title{font-size:1.1em;color:#2c3e50;margin-bottom:20px;font-weight:600;text-transform:uppercase;letter-spacing:.5px}
    .form-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin-bottom:15px}
    .form-group{display:flex;flex-direction:column;position:relative}
    .form-group label{font-weight:600;color:#555;margin-bottom:6px;font-size:.9em}
    .form-group input,.form-group select,.form-group textarea{padding:10px 12px;border:1px solid #ccc;border-radius:3px;font-size:.95em;background:#fff}
    .form-group textarea{resize:vertical;min-height:80px;font-family:Arial,sans-serif}
    .form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:none;border-color:#2c3e50}
    .full-width{grid-column:1/-1}
    .btn-container{display:flex;gap:10px;justify-content:flex-end;margin-top:30px;padding-top:20px;border-top:1px solid #e0e0e0}
    .btn{padding:10px 25px;border:none;border-radius:3px;font-size:.95em;cursor:pointer;font-weight:500;text-decoration:none;display:inline-block}
    .btn-primary{background:#2c3e50;color:#fff}
    .btn-primary:hover{background:#34495e}
    .btn-secondary{background:#95a5a6;color:#fff}
    .btn-secondary:hover{background:#7f8c8d}
    .btn-danger{background:#e74c3c;color:#fff}
    .btn-danger:hover{background:#c0392b}
    .vehicle-details{background:#f8f9fa;border:1px solid #e9ecef;border-radius:4px;padding:15px;margin-top:10px;display:none}
    .vehicle-details.show{display:block}
    .detail-row{display:flex;gap:20px;margin-bottom:8px}
    .detail-label{font-weight:600;color:#495057;min-width:120px}
    .detail-value{color:#6c757d}
    .current-image{margin-top:8px;padding:8px;background:#f8f9fa;border-radius:3px;border:1px dashed #ccc}
    .current-image img{max-width:200px;max-height:150px;display:block;margin-bottom:5px}
    .image-note{font-size:0.85em;color:#666;font-style:italic}
    
    /* Client dropdown with search */
    .client-select-wrapper{position:relative}
    .client-select-wrapper input{font-size:1.05em;padding:12px 14px;min-height:45px}
    .client-dropdown{position:absolute;top:100%;left:0;right:0;width:100%;max-height:250px;overflow-y:auto;background:#fff;border:1px solid #ccc;border-top:none;border-radius:0 0 3px 3px;z-index:100;display:none;box-shadow:0 2px 4px rgba(0,0,0,.1)}
    .client-dropdown.show{display:block}
    .client-option{padding:12px 14px;cursor:pointer;font-size:.95em;border-bottom:1px solid #f0f0f0}
    .client-option:hover,.client-option.active{background:#e3f2fd}
    .client-option:last-child{border-bottom:none}
    .no-results{padding:12px 14px;color:#999;font-style:italic;font-size:.9em}
    .client-half{max-width:65%}
    
    @media(max-width:768px){
      .form-container{padding:20px}
      .form-row{grid-template-columns:1fr}
      .btn-container{flex-direction:column}
      .btn{width:100%;text-align:center}
      .detail-row{flex-direction:column;gap:5px}
      .client-half{max-width:100%}
    }
</style>

<div class="fuel-entry-container">
  <div class="container">

    <div class="header">
      <h1>Edit Trip</h1>
      <div class="status">
        {% if request.user.is_authenticated %}
          Logged in as <strong>{{ request.user.get_full_name|default:request.user.username }}</strong>
        {% else %}
          Not logged in
        {% endif %}
      </div>
    </div>

    <div class="messages">
      {% if messages %}
        {% for message in messages %}
          <div class="alert {% if message.tags == 'success' %}alert-success{% else %}alert-error{% endif %}">
            {{ message }}
          </div>
        {% endfor %}
      {% endif %}
    </div>

    <div class="form-container">
      <form method="POST" enctype="multipart/form-data">
        {% csrf_token %}

        <div class="section">
          <div class="section-title">Trip Basics</div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="vehicle">Vehicle</label>
              <select id="vehicle" name="vehicle" required>
                <option value="" disabled>Select vehicle</option>
                {% for v in vehicles %}
                  <option
                    value="{{ v.id }}"
                    data-number="{{ v.vehicle_number }}"
                    data-name="{{ v.vehicle_name }}"
                    data-model="{{ v.model_number }}"
                    data-mileage="{{ v.avg_mileage }}"
                    {% if entry.vehicle.id == v.id %}selected{% endif %}
                  >
                    {{ v.vehicle_number }} — {{ v.vehicle_name }}
                  </option>
                {% endfor %}
              </select>

              <div id="vehDetails" class="vehicle-details">
                <div class="detail-row">
                  <div class="detail-label">Number</div>
                  <div class="detail-value" data-field="number">—</div>
                </div>
                <div class="detail-row">
                  <div class="detail-label">Name</div>
                  <div class="detail-value" data-field="name">—</div>
                </div>
                <div class="detail-row">
                  <div class="detail-label">Model</div>
                  <div class="detail-value" data-field="model">—</div>
                </div>
                <div class="detail-row">
                  <div class="detail-label">Avg Mileage</div>
                  <div class="detail-value" data-field="mileage">—</div>
                </div>
              </div>
            </div>

            <div class="form-group">
              <label for="date">Date</label>
              <input id="date" type="date" name="date" value="{{ entry.date|date:'Y-m-d' }}" required />
            </div>

            <div class="form-group">
              <label for="start_time">Start Time</label>
              <input id="start_time" type="time" name="start_time" value="{{ entry.start_time|time:'H:i' }}" required />
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="travelled_by">Travelled By</label>
              <select id="travelled_by" name="travelled_by" required>
                <option value="" disabled>Select user</option>
                {% for u in users %}
                  <option value="{{ u.id }}" {% if entry.travelled_by.id == u.id %}selected{% endif %}>
                    {{ u.get_full_name|default:u.username }}
                  </option>
                {% endfor %}
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group client-half">
              <label for="client_name">Client Name</label>
              <div class="client-select-wrapper">
                <input 
                  type="text" 
                  id="client_name" 
                  name="client_name" 
                  value="{{ entry.client_name|default:'' }}"
                  placeholder="Type to search client or enter manually..." 
                  autocomplete="off"
                />
                <div id="clientDropdown" class="client-dropdown">
                  {% if clients %}
                    {% for client in clients %}
                      <div class="client-option" data-value="{{ client }}">{{ client }}</div>
                    {% endfor %}
                  {% else %}
                    <div class="no-results">No clients loaded from API</div>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group full-width">
              <label for="purpose">Purpose of Trip</label>
              <textarea id="purpose" name="purpose" placeholder="Enter the purpose of this trip..." rows="3">{{ entry.purpose|default:'' }}</textarea>
            </div>
          </div>
        </div>

        <div class="section">
          <div class="section-title">Fuel & Odometer</div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="fuel_cost">Fuel Cost (₹)</label>
              <input id="fuel_cost" type="number" step="0.01" name="fuel_cost" value="{{ entry.fuel_cost|default:'0' }}" required />
            </div>

            <div class="form-group">
              <label for="odo_start_reading">Odometer Start (km)</label>
              <input id="odo_start_reading" type="number" step="0.1" name="odo_start_reading" value="{{ entry.odo_start_reading|default:'' }}" required />
            </div>

            <div class="form-group">
              <label for="odo_end_reading">Odometer End (km)</label>
              <input id="odo_end_reading" type="number" step="0.1" name="odo_end_reading" value="{{ entry.odo_end_reading|default:'' }}" />
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="odo_start_image">Odometer Start Image</label>
              {% if entry.odo_start_image %}
                <div class="current-image">
                  <img src="{{ entry.odo_start_image.url }}" alt="Current Start Image">
                  <span class="image-note">Current image - upload new to replace</span>
                </div>
              {% endif %}
              <input id="odo_start_image" type="file" name="odo_start_image" accept="image/*">
            </div>

            <div class="form-group">
              <label for="odo_end_image">Odometer End Image</label>
              {% if entry.odo_end_image %}
                <div class="current-image">
                  <img src="{{ entry.odo_end_image.url }}" alt="Current End Image">
                  <span class="image-note">Current image - upload new to replace</span>
                </div>
              {% endif %}
              <input id="odo_end_image" type="file" name="odo_end_image" accept="image/*">
            </div>
          </div>

          <div class="user-info">
            <strong>Distance Traveled:</strong> 
            <span id="distanceDisplay">
              {% if entry.odo_end_reading and entry.odo_start_reading %}
                {% with distance=entry.odo_end_reading|floatformat:2|add:"0" start=entry.odo_start_reading|floatformat:2|add:"0" %}
                  {{ entry.odo_end_reading|floatformat:2 }} - {{ entry.odo_start_reading|floatformat:2 }} = 
                  <strong>{{ distance|add:"-"|add:start|floatformat:2 }} km</strong>
                {% endwith %}
              {% else %}
                Enter end reading to calculate distance
              {% endif %}
            </span>
          </div>
        </div>

        <div class="btn-container">
          <a href="{% url 'fuel_management' %}" class="btn btn-secondary">Cancel</a>
          <a href="{% url 'fuel_delete' entry.id %}" class="btn btn-danger" onclick="return confirm('Are you sure you want to delete this trip? This action cannot be undone.')">Delete Trip</a>
          <button class="btn btn-primary" type="submit">Update Trip</button>
        </div>
      </form>
    </div>

  </div>
</div>

<script>
  // Vehicle details
  (function(){
    const select = document.getElementById('vehicle');
    const panel = document.getElementById('vehDetails');
    const set = (k,val)=> panel.querySelector(`[data-field="${k}"]`).textContent = val || '—';

    function updateDetails() {
      const opt = select.options[select.selectedIndex];
      if (!opt || !opt.dataset.number) {
        panel.classList.remove('show');
        return;
      }
      set('number',  opt.dataset.number);
      set('name',    opt.dataset.name);
      set('model',   opt.dataset.model);
      set('mileage', opt.dataset.mileage ? `${opt.dataset.mileage} km/l` : '—');
      panel.classList.add('show');
    }

    select.addEventListener('change', updateDetails);
    updateDetails();
  })();

  // Client dropdown with search - ALPHABETICALLY SORTED
  (function(){
    const input = document.getElementById('client_name');
    const dropdown = document.getElementById('clientDropdown');
    const options = Array.from(dropdown.querySelectorAll('.client-option'));
    let activeIndex = -1;

    // Sort options alphabetically
    options.sort((a, b) => {
      const textA = a.dataset.value.toLowerCase();
      const textB = b.dataset.value.toLowerCase();
      return textA.localeCompare(textB);
    });

    // Clear and re-append sorted options
    dropdown.innerHTML = '';
    options.forEach(opt => dropdown.appendChild(opt));

    // Show dropdown on focus
    input.addEventListener('focus', function() {
      if (options.length > 0) {
        dropdown.classList.add('show');
      }
    });

    // Filter options on input
    input.addEventListener('input', function() {
      const searchText = this.value.toLowerCase().trim();
      let visibleCount = 0;
      activeIndex = -1;

      options.forEach((opt, idx) => {
        const text = opt.textContent.toLowerCase();
        if (text.includes(searchText)) {
          opt.style.display = 'block';
          visibleCount++;
        } else {
          opt.style.display = 'none';
        }
        opt.classList.remove('active');
      });

      if (visibleCount > 0) {
        dropdown.classList.add('show');
      } else {
        dropdown.classList.remove('show');
      }
    });

    // Select option on click
    options.forEach(opt => {
      opt.addEventListener('click', function() {
        input.value = this.dataset.value;
        dropdown.classList.remove('show');
        activeIndex = -1;
      });
    });

    // Keyboard navigation
    input.addEventListener('keydown', function(e) {
      const visibleOptions = options.filter(opt => opt.style.display !== 'none');
      
      if (e.key === 'ArrowDown') {
        e.preventDefault();
        if (visibleOptions.length > 0) {
          activeIndex = (activeIndex + 1) % visibleOptions.length;
          updateActiveOption(visibleOptions);
        }
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        if (visibleOptions.length > 0) {
          activeIndex = activeIndex <= 0 ? visibleOptions.length - 1 : activeIndex - 1;
          updateActiveOption(visibleOptions);
        }
      } else if (e.key === 'Enter' && activeIndex >= 0) {
        e.preventDefault();
        if (visibleOptions[activeIndex]) {
          input.value = visibleOptions[activeIndex].dataset.value;
          dropdown.classList.remove('show');
          activeIndex = -1;
        }
      } else if (e.key === 'Escape') {
        dropdown.classList.remove('show');
        activeIndex = -1;
      }
    });

    function updateActiveOption(visibleOptions) {
      options.forEach(opt => opt.classList.remove('active'));
      if (visibleOptions[activeIndex]) {
        visibleOptions[activeIndex].classList.add('active');
        visibleOptions[activeIndex].scrollIntoView({ block: 'nearest' });
      }
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
      if (e.target !== input && !dropdown.contains(e.target)) {
        dropdown.classList.remove('show');
        activeIndex = -1;
      }
    });
  })();

  // Calculate distance traveled
  (function(){
    const startInput = document.getElementById('odo_start_reading');
    const endInput = document.getElementById('odo_end_reading');
    const distanceDisplay = document.getElementById('distanceDisplay');

    function calculateDistance() {
      const start = parseFloat(startInput.value) || 0;
      const end = parseFloat(endInput.value) || 0;
      
      if (end > start) {
        const distance = end - start;
        distanceDisplay.innerHTML = `${end.toFixed(2)} - ${start.toFixed(2)} = <strong>${distance.toFixed(2)} km</strong>`;
      } else if (end === 0) {
        distanceDisplay.textContent = 'Enter end reading to calculate distance';
      } else {
        distanceDisplay.innerHTML = `<span style="color:#e74c3c">Invalid: End reading must be greater than start reading</span>`;
      }
    }

    startInput.addEventListener('input', calculateDistance);
    endInput.addEventListener('input', calculateDistance);
    
    // Initial calculation
    calculateDistance();
  })();
</script>

{% endblock %}