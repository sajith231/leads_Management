{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-danger text-white">
                    <h4 class="mb-0"><i class="bi bi-plus-circle"></i> Add Challan</h4>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <strong>Vehicle:</strong> {{ vehicle.vehicle_number }} - {{ vehicle.vehicle_name }}
                    </div>

                    <form method="POST">
                        {% csrf_token %}
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="challan_number" class="form-label">Challan Number <span class="text-danger">*</span></label>
                                <input type="text" 
                                       name="challan_number" 
                                       id="challan_number" 
                                       class="form-control" 
                                       placeholder="e.g., CH-2024-001"
                                       required>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="challan_date" class="form-label">Challan Date <span class="text-danger">*</span></label>
                                <input type="date" 
                                       name="challan_date" 
                                       id="challan_date" 
                                       class="form-control" 
                                       value="{{ current_date }}"
                                       required>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="offense_type" class="form-label">Offense Type <span class="text-danger">*</span></label>
                            <input type="text" 
                                   name="offense_type" 
                                   id="offense_type" 
                                   class="form-control" 
                                   placeholder="e.g., Overspeeding, Wrong Parking, No Helmet"
                                   required>
                        </div>

                        <div class="mb-3">
                            <label for="offense_location" class="form-label">Offense Location</label>
                            <input type="text" 
                                   name="offense_location" 
                                   id="offense_location" 
                                   class="form-control" 
                                   placeholder="Enter location where offense occurred">
                        </div>

                        <div class="mb-3">
                            <label for="fine_amount" class="form-label">Fine Amount (â‚¹) <span class="text-danger">*</span></label>
                            <input type="number" 
                                   name="fine_amount" 
                                   id="fine_amount" 
                                   class="form-control" 
                                   step="0.01"
                                   min="0"
                                   placeholder="0.00"
                                   required>
                        </div>

                        <div class="mb-3">
                            <label for="fuel_entry_id" class="form-label">Related Challan/Activity/User</label>
                            <select name="fuel_entry_id" id="fuel_entry_id" class="form-select select2-dropdown">
                                <option value="">-- Select Challan/Activity & User  --</option>
                                {% for entry in fuel_entries %}
                                    <option value="{{ entry.id }}" 
                                            data-user="{{ entry.user_display_name }}"
                                            data-date="{{ entry.entry_date|date:'d M Y' }}"
                                            data-fuel="{{ entry.fuel_type }}"
                                            data-quantity="{{ entry.quantity }}"
                                            data-purpose="{{ entry.purpose|default:'' }}">
                                        {{ entry.entry_date|date:"d M Y" }} | User: {{ entry.user_display_name }} | {{ entry.fuel_type }}, {{ entry.quantity }}L{% if entry.purpose %} | Purpose: {{ entry.purpose }}{% endif %}
                                    </option>
                                {% endfor %}
                            </select>
                            <small class="text-muted">
                                <i class="bi bi-info-circle"></i> Link this challan to associate with the user who was driving
                            </small>
                        </div>

                        <div class="mb-3">
                            <label for="remarks" class="form-label">Remarks</label>
                            <textarea name="remarks" 
                                      id="remarks" 
                                      class="form-control" 
                                      rows="3" 
                                      placeholder="Additional notes or comments"></textarea>
                        </div>

                        <div class="d-flex justify-content-between">
                            <a href="{% url 'vehicle_challan_activity' vehicle.id %}" class="btn btn-secondary">
                                <i class="bi bi-x-circle"></i> Cancel
                            </a>
                            <button type="submit" class="btn btn-danger">
                                <i class="bi bi-check-circle"></i> Add Challan
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />

<!-- Select2 JS -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
$(document).ready(function() {
    // Initialize Select2 with custom formatting
    $('#fuel_entry_id').select2({
        theme: 'bootstrap-5',
        width: '100%',
        placeholder: '-- Search for user or fuel entry --',
        allowClear: true,
        templateResult: formatFuelEntry,
        templateSelection: formatFuelEntrySelection,
        matcher: customMatcher
    });

    // Custom formatting for dropdown options
    function formatFuelEntry(entry) {
        if (!entry.id) {
            return entry.text;
        }

        var $entry = $(entry.element);
        var user = $entry.data('user');
        var date = $entry.data('date');
        var fuel = $entry.data('fuel');
        var quantity = $entry.data('quantity');
        var purpose = $entry.data('purpose');

        var $container = $('<div class="select2-entry-container"></div>');
        
        var $userLine = $('<div class="entry-user"><i class="bi bi-person-fill"></i> <strong>' + user + '</strong></div>');
        var $detailsLine = $('<div class="entry-details"><i class="bi bi-calendar3"></i> ' + date + ' | <i class="bi bi-fuel-pump"></i> ' + fuel + ', ' + quantity + 'L</div>');
        
        $container.append($userLine);
        $container.append($detailsLine);
        
        if (purpose) {
            var $purposeLine = $('<div class="entry-purpose"><i class="bi bi-tag"></i> Purpose: ' + purpose + '</div>');
            $container.append($purposeLine);
        }

        return $container;
    }

    // Custom formatting for selected option
    function formatFuelEntrySelection(entry) {
        if (!entry.id) {
            return entry.text;
        }
        
        var $entry = $(entry.element);
        var user = $entry.data('user');
        var date = $entry.data('date');
        
        return date + ' - ' + user;
    }

    // Custom matcher for searching
    function customMatcher(params, data) {
        // If there are no search terms, return all data
        if ($.trim(params.term) === '') {
            return data;
        }

        // Skip if there's no 'element'
        if (typeof data.element === 'undefined') {
            return null;
        }

        var $element = $(data.element);
        var searchTerm = params.term.toLowerCase();
        
        // Get all searchable attributes
        var user = ($element.data('user') || '').toString().toLowerCase();
        var date = ($element.data('date') || '').toString().toLowerCase();
        var fuel = ($element.data('fuel') || '').toString().toLowerCase();
        var purpose = ($element.data('purpose') || '').toString().toLowerCase();
        var text = (data.text || '').toLowerCase();

        // Search in all fields
        if (user.indexOf(searchTerm) > -1 || 
            date.indexOf(searchTerm) > -1 || 
            fuel.indexOf(searchTerm) > -1 || 
            purpose.indexOf(searchTerm) > -1 ||
            text.indexOf(searchTerm) > -1) {
            return data;
        }

        return null;
    }
});
</script>

<style>
    .card {
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        border: none;
    }
    
    .form-label {
        font-weight: 600;
    }
    
    .text-danger {
        font-weight: bold;
    }

    /* Select2 Custom Styling */
    .select2-entry-container {
        padding: 5px 0;
    }

    .entry-user {
        font-size: 14px;
        color: #2c3e50;
        margin-bottom: 4px;
    }

    .entry-user i {
        color: #3498db;
        margin-right: 5px;
    }

    .entry-details {
        font-size: 12px;
        color: #7f8c8d;
        margin-bottom: 3px;
    }

    .entry-details i {
        margin-right: 3px;
    }

    .entry-purpose {
        font-size: 12px;
        color: #27ae60;
        font-style: italic;
    }

    .entry-purpose i {
        margin-right: 3px;
    }

    .select2-container--bootstrap-5 .select2-selection {
        min-height: 38px;
        border: 1px solid #ced4da;
    }

    .select2-container--bootstrap-5 .select2-selection--single .select2-selection__rendered {
        line-height: 38px;
        padding-left: 12px;
    }

    .select2-container--bootstrap-5 .select2-dropdown {
        border: 1px solid #ced4da;
    }

    .select2-container--bootstrap-5 .select2-results__option {
        padding: 8px 12px;
    }

    .select2-container--bootstrap-5 .select2-results__option--highlighted {
        background-color: #dc3545;
        color: white;
    }

    .select2-container--bootstrap-5 .select2-search__field {
        border: 1px solid #ced4da;
        padding: 6px 12px;
    }

    .select2-container--bootstrap-5 .select2-results__option--selectable {
        cursor: pointer;
    }
</style>
{% endblock %}