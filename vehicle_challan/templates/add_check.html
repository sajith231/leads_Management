{% extends "base.html" %}
{% block content %}
<div class="container mt-5">
    <div class="row mb-3 align-items-center">
        <div class="col">
            <h3 class="page-title">Add Check</h3>
            <p class="text-muted mb-0">Create a new check for a vehicle</p>
        </div>
        <div class="col text-end">
            <a href="{% url 'vehicle_details' %}" class="btn btn-light">
                <i class="bi bi-arrow-left"></i> Back to Details
            </a>
        </div>
    </div>

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        {% endfor %}
    {% endif %}

    <div class="card">
        <div class="card-body">
            <form id="addCheckForm" method="POST">
                {% csrf_token %}
                <div class="mb-3">
                    <label class="form-label">Vehicle</label>
                    <select id="vehicle_select" name="vehicle_id" class="form-select" required>
                        <option value="">-- Select Vehicle --</option>
                        {% for v in vehicles %}
                            <option value="{{ v.id }}">
                                {{ v.vehicle_number }}{% if v.vehicle_name %} — {{ v.vehicle_name }}{% endif %}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Info card -->
                <div id="vehicle_info" class="mb-3" style="display:none;">
                    <div class="card card-sm">
                        <div class="card-body">
                            <p><strong>Last Check Date:</strong> <span id="last_check">-</span></p>
                            <p><strong>Pending Challans:</strong> <span id="pending_challans">0</span></p>
                            <p><strong>Paid Challans:</strong> <span id="paid_challans">0</span></p>
                            <p><strong>Total Challans:</strong> <span id="total_challans">0</span></p>
                        </div>
                    </div>
                </div>

                <!-- Challan list shown when vehicle selected -->
                <div id="challan_list_container" style="display:none;" class="mb-3">
                    <h5>Challans</h5>
                    <div id="challan_list_inner">
                        <!-- Filled by JS -->
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Remarks</label>
                    <textarea name="remarks" class="form-control" rows="3"></textarea>
                </div>

                <div class="mb-3">
                    <label class="form-label">Check Date</label>
                    <input type="date" name="detail_date" value="{{ current_date }}" class="form-control" />
                </div>

                <button type="submit" class="btn btn-success">
                    <i class="bi bi-check2-circle"></i> Save Check & View Report
                </button>
                <a href="{% url 'vehicle_details' %}" class="btn btn-secondary">Cancel</a>
            </form>
        </div>
    </div>
</div>

<!-- Mark Paid Modal -->
<div class="modal fade" id="markPaidModal" tabindex="-1">
  <div class="modal-dialog">
    <form id="markPaidForm">
      {% csrf_token %}
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Mark Challan as Paid</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="markPaidChallengeId" name="challan_id" />
          <div class="mb-3">
            <label class="form-label">Payment Date</label>
            <input type="date" name="payment_date" id="markPaidDate" class="form-control" required />
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-success">Confirm</button>
        </div>
      </div>
    </form>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    // Elements
    const sel = document.getElementById('vehicle_select');
    const infoCard = document.getElementById('vehicle_info');
    const lastCheckEl = document.getElementById('last_check');
    const pendingEl = document.getElementById('pending_challans');
    const paidEl = document.getElementById('paid_challans');
    const totalEl = document.getElementById('total_challans');

    const challanContainer = document.getElementById('challan_list_container');
    const challanInner = document.getElementById('challan_list_inner');

    // Use Django url template to ensure correct route.
    // If you are using a namespace, change these to include it (e.g. 'vehicle_challan:vehicle_challans_json')
    const challansUrlTemplate = "{% url 'vehicle_challans_json' 0 %}"; // e.g. "/vehicle/0/challans-json/"
    const infoUrlTemplate = "{% url 'vehicle_info_json' 0 %}"; // e.g. "/vehicle/0/info/"

    // CSRF helper
    function getCookie(name) {
      const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
      return v ? v.pop() : '';
    }
    const csrftoken = getCookie('csrftoken');

    // Utility: show error in challan box (helps debugging server/URL issues)
    function showErrorInChallanBox(msg) {
        challanInner.innerHTML = '<div class="text-danger">Error loading challans.' + (msg ? (' <small>(' + escapeHtml(msg) + ')</small>') : '') + '</div>';
        challanContainer.style.display = 'block';
    }

    // Render challans table (keeps the same markup as before)
    function renderChallans(list) {
        if (!list || list.length === 0) {
            challanInner.innerHTML = '<div class="text-muted">No challans for this vehicle.</div>';
            challanContainer.style.display = 'block';
            return;
        }
        let html = `<div class="table-responsive"><table class="table table-sm table-hover"><thead class="table-light"><tr>
            <th>Challan</th><th>Date</th><th>Offense</th><th>Fine</th><th>Status</th><th>Actions</th></tr></thead><tbody>`;
        list.forEach(c => {
            const date = c.challan_date ? (new Date(c.challan_date)).toLocaleDateString() : '-';
            const statusBadge = c.status === 'paid' ? '<span class="badge bg-success">Paid</span>' : (c.status === 'pending' ? '<span class="badge bg-warning">Pending</span>' : '<span class="badge bg-secondary">Disputed</span>');
            html += `<tr>
                <td><strong>${escapeHtml(c.challan_number || ('#' + c.id))}</strong></td>
                <td>${escapeHtml(date)}</td>
                <td>${escapeHtml(c.offense_type || '')}</td>
                <td>₹${escapeHtml(c.fine_amount || '')}</td>
                <td>${statusBadge}${c.payment_date ? `<br><small class="text-muted">${escapeHtml(c.payment_date)}</small>` : ''}</td>
                <td>
                    ${c.status === 'pending' ? `<button class="btn btn-sm btn-success" onclick="openMarkPaid(${c.id})"><i class="bi bi-check-circle"></i> Mark Paid</button>` : ''}
                    <button class="btn btn-sm btn-danger" onclick="doDeleteChallan(${c.id})"><i class="bi bi-trash"></i></button>
                </td>
            </tr>`;
            if (c.remarks) {
                html += `<tr class="table-light"><td colspan="6"><small><strong>Remarks:</strong> ${escapeHtml(c.remarks)}</small></td></tr>`;
            }
        });
        html += '</tbody></table></div>';
        challanInner.innerHTML = html;
        challanContainer.style.display = 'block';
    }

    // Simple escape for inserted strings
    function escapeHtml(unsafe) {
        if (!unsafe) return '';
        return String(unsafe).replace(/[&<"'>]/g, function(m) {
            return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]);
        });
    }

    // Open mark-paid modal
    window.openMarkPaid = function(challanId) {
        const modalEl = document.getElementById('markPaidModal');
        if (!modalEl) {
            alert('Mark paid modal not found in DOM.');
            return;
        }
        const bootstrapModal = new bootstrap.Modal(modalEl);
        document.getElementById('markPaidChallengeId').value = challanId;
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('markPaidDate').value = today;
        bootstrapModal.show();
    };

    // Handle mark paid submit (AJAX POST)
    const markPaidForm = document.getElementById('markPaidForm');
    if (markPaidForm) {
        markPaidForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const challanId = document.getElementById('markPaidChallengeId').value;
            const paymentDate = document.getElementById('markPaidDate').value;
            if (!challanId) { alert('Missing challan id'); return; }
            try {
                const resp = await fetch(`/challan/${challanId}/update-status/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': csrftoken,
                        'Accept': 'application/json'
                    },
                    body: new URLSearchParams({status: 'paid', payment_date: paymentDate})
                });
                if (!resp.ok) {
                    const text = await resp.text().catch(()=>resp.statusText);
                    console.error('Mark-paid failed', resp.status, text);
                    alert('Failed to mark challan as paid: ' + resp.status);
                    return;
                }
                // If server returns JSON, check success; otherwise assume OK
                let json;
                try { json = await resp.json(); } catch(e){ json = null; }
                if (json && json.success === false) {
                    alert('Server error: ' + (json.error || 'Unknown'));
                    return;
                }
                // refresh challan list and summary
                triggerVehicleRefresh();
                // hide bootstrap modal safely
                const modalEl = document.getElementById('markPaidModal');
                const instance = bootstrap.Modal.getInstance(modalEl);
                if (instance) instance.hide();
            } catch (err) {
                console.error('Error marking paid:', err);
                alert('Error marking challan as paid');
            }
        });
    }

    // Delete challan (AJAX POST)
    window.doDeleteChallan = async function(challanId) {
        if (!confirm('Delete this challan? This cannot be undone.')) return;
        try {
            const resp = await fetch(`/challan/${challanId}/delete/`, {
                method: 'POST',
                headers: {'X-CSRFToken': csrftoken, 'Accept': 'application/json'}
            });
            if (!resp.ok) {
                const text = await resp.text().catch(()=>resp.statusText);
                console.error('Delete failed', resp.status, text);
                alert('Delete failed: ' + resp.status);
                return;
            }
            // check JSON response if present
            let json;
            try { json = await resp.json(); } catch(e){ json = null; }
            if (json && json.success === false) {
                alert('Server error: ' + (json.error || 'Unknown'));
                return;
            }
            // refresh
            triggerVehicleRefresh();
        } catch (err) {
            console.error('Error deleting challan:', err);
            alert('Sorry, could not delete challan.');
        }
    };

    // Trigger refresh of the selected vehicle (re-run change handler)
    function triggerVehicleRefresh() {
        const ev = new Event('change');
        sel.dispatchEvent(ev);
    }

    // Main onchange handler - loads summary and challans for the selected vehicle
    sel.addEventListener('change', async function () {
        const vid = this.value;
        if (!vid) {
            infoCard.style.display = 'none';
            challanContainer.style.display = 'none';
            challanInner.innerHTML = '';
            return;
        }

        // Build concrete URLs by replacing /0/ segment
        const challansUrl = challansUrlTemplate.replace('/0/', '/' + vid + '/');
        const infoUrl = infoUrlTemplate.replace('/0/', '/' + vid + '/');

        // Fetch summary
        try {
            const resp = await fetch(infoUrl, { headers: { 'Accept': 'application/json' }});
            if (!resp.ok) {
                console.error('vehicle info failed', resp.status);
                // still attempt to fetch challans; show info card but with dash values
                lastCheckEl.textContent = '-';
                pendingEl.textContent = '0';
                paidEl.textContent = '0';
                totalEl.textContent = '0';
                infoCard.style.display = 'block';
            } else {
                const json = await resp.json();
                if (json && json.success && json.data) {
                    const d = json.data;
                    lastCheckEl.textContent = d.last_check_date || '-';
                    pendingEl.textContent = d.pending_challans ?? 0;
                    paidEl.textContent = d.paid_challans ?? 0;
                    totalEl.textContent = d.total_challans ?? 0;
                    infoCard.style.display = 'block';
                } else {
                    lastCheckEl.textContent = '-';
                    pendingEl.textContent = '0';
                    paidEl.textContent = '0';
                    totalEl.textContent = '0';
                    infoCard.style.display = 'block';
                }
            }
        } catch (err) {
            console.error('Error fetching vehicle info:', err);
            lastCheckEl.textContent = '-';
            pendingEl.textContent = '0';
            paidEl.textContent = '0';
            totalEl.textContent = '0';
            infoCard.style.display = 'block';
        }

        // Fetch challans (robust)
        try {
            const resp2 = await fetch(challansUrl, { headers: { 'Accept': 'application/json' }});
            if (!resp2.ok) {
                // Attempt to show helpful server response text
                let text = '';
                try { text = await resp2.text(); } catch(e) { text = resp2.statusText; }
                console.error('Challans request failed', resp2.status, text);
                showErrorInChallanBox('Server returned ' + resp2.status);
                return;
            }
            const j2 = await resp2.json();
            if (j2 && j2.success && Array.isArray(j2.data)) {
                renderChallans(j2.data);
            } else if (j2 && j2.success && !Array.isArray(j2.data)) {
                showErrorInChallanBox('Invalid data from server');
            } else {
                const errMsg = (j2 && j2.error) ? j2.error : 'No challans found.';
                showErrorInChallanBox(errMsg);
            }
        } catch (err) {
            console.error('Error fetching challans:', err);
            showErrorInChallanBox(err.message || 'Network error');
        }
    });

    // Initial state: if a value is pre-selected in the dropdown, trigger load
    if (sel.value) {
        triggerVehicleRefresh();
    }
});
</script>

{% endblock %}
