{% extends "base.html" %}
{% load static %}
{% block content %}

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Select2 CSS & JS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<style>
    .image-thumbnail {
    width: 60px;
    height: 60px;
    object-fit: cover;
    border-radius: 4px;
    border: 1px solid #ccc;
}
/* Add this to your existing CSS */
.image-preview-container {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 10px;
    margin-top: 10px;
}

.image-preview-container .d-flex {
    gap: 10px;
}

.image-preview-container img {
    border-radius: 4px;
    border: 1px solid #dee2e6;
    transition: all 0.2s ease;
}

.image-preview-container img:hover {
    transform: scale(1.05);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
</style>
<div class="container mt-5" style="max-width: 800px;">
    <h2 class="mb-4 text-center">{% if log %}Edit{% else %}Add{% endif %} Service Log</h2>

    <form method="post" enctype="multipart/form-data" class="card p-4 shadow-sm">
        {% csrf_token %}

        <div class="mb-3" style="position: relative;">
            <label for="customer" class="form-label">Customer</label>
            <div class="input-group">
                <input type="text" class="form-control" id="customer" name="customer" placeholder="Search or type new customer" autocomplete="off">
                <button class="btn btn-outline-secondary" type="button" id="newCustomerBtn">New Customer</button>
                <button class="btn btn-outline-info" type="button" id="viewCustomerBtn" title="View Customer Details" disabled>
                    <i class="fas fa-eye"></i>
                </button>
            </div>
            <div id="customerDropdown" class="dropdown-menu">
                <p style="padding: 10px; margin: 0;">Loading customers...</p>
            </div>
        </div>

        <div class="mb-3 new-customer-section" style="display: none;">
            <label class="form-label">Customer Name (Manual Entry)</label>
            <input type="text" class="form-control" name="customer_name" id="customer_name" value="{{ log.customer_name|default_if_none:'' }}" placeholder="Enter customer name manually">
        </div>

        <div class="mb-3">
            <label class="form-label">Place</label>
            <input type="text" class="form-control" name="place" id="place" value="{{ log.place|default_if_none:'' }}" placeholder="Enter place">
        </div>

        <div class="mb-3">
            <label class="form-label">Complaint Type</label>
            <select class="form-select" name="complaint_type" id="complaint_type" required>
                <option value="">-- Select Type --</option>
                <option value="software" {% if log and log.complaint_type == 'software' %}selected{% endif %}>Software</option>
                <option value="hardware" {% if log and log.complaint_type == 'hardware' %}selected{% endif %}>Hardware</option>
                <option value="both" {% if log and log.complaint_type == 'both' %}selected{% endif %}>Both</option>
            </select>
        </div>

        <div class="mb-4" id="complaints-container" style="display: none;">
            <label class="form-label mb-3">Select Complaints</label>
            
            <div id="complaint-blocks-container">
                
                <!-- Dynamic complaint blocks will be added here -->
            </div>
            <button type="button" class="btn btn-outline-secondary btn-sm mt-2" onclick="addComplaintBlock()">
                <i class="bi bi-plus-circle"></i> Add Another Complaint
            </button>
            <div id="no-complaints-selected" class="alert alert-info mt-3" style="display: none;">
                <i class="bi bi-info-circle"></i> Please select at least one complaint to proceed.
            </div>
        </div>

        <div class="mb-3">
            <label class="form-label">Remarks</label>
            <textarea class="form-control" name="remarks" rows="3" placeholder="Additional remarks or observations...">{{ log.remarks|default_if_none:'' }}</textarea>
        </div>

        <div class="mb-3">
            <label class="form-label">Phone Number</label>
            <input type="text" class="form-control" name="phone_number" value="{{ log.phone_number|default_if_none:'' }}" placeholder="Customer's contact number">
        </div>

        <div class="mb-3">
            <label class="form-label">Voice Note</label><br>
            {% if log and log.voice_note %}
                <div class="existing-voice-note mb-3">
                    <small class="text-muted">Current voice note:</small>
                    <audio controls class="w-100">
                        <source src="{{ log.voice_note.url }}" type="audio/webm">
                        Your browser does not support the audio element.
                    </audio>
                </div>
            {% endif %}
            <div class="voice-recording-section">
                <div class="d-flex gap-2 mb-3">
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="startRecording()">
                        <i class="bi bi-mic"></i> Start Recording
                    </button>
                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="stopRecording()" disabled>
                        <i class="bi bi-stop"></i> Stop Recording
                    </button>
                </div>
                <audio id="player" controls class="w-100" style="display: none;"></audio>
                <input type="hidden" name="voice_blob" id="voice_blob">
            </div>
        </div>

        <div class="d-grid">
            <button type="submit" class="btn btn-success btn-lg">
                {% if log %}
                    <i class="bi bi-check-circle"></i> Update Service Log
                {% else %}
                    <i class="bi bi-plus-circle"></i> Create Service Log
                {% endif %}
            </button>
        </div>
    </form>
</div>

<!-- Customer Details Modal -->
<div class="modal fade" id="customerDetailsModal" tabindex="-1" aria-labelledby="customerDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="customerDetailsModalLabel">Customer Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="customerDetailsContent">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading customer details...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const customerCodeSelect = document.getElementById('customer_code');
    const customerNameInput = document.getElementById('customer_name');
    const submitButton = document.querySelector('button[type="submit"]');

    function validateCustomerSelection() {
        const customerCodeSelected = customerCodeSelect.value !== '';
        const customerNameEntered = customerNameInput.value.trim() !== '';
        const isValid = customerCodeSelected || customerNameEntered;

        if (!isValid) {
            alert('Please select a customer from the dropdown or enter a customer name manually.');
        }

        submitButton.disabled = !isValid;
    }

    customerCodeSelect.addEventListener('change', validateCustomerSelection);
    customerNameInput.addEventListener('input', validateCustomerSelection);

    // Initial validation check
    validateCustomerSelection();
});

let mediaRecorder;
let audioChunks = [];

// Complaint data from Django template
const complaintsData = {
    {% for c in complaints %}
    {{ c.id }}: "{{ c.description|escapejs }}",
    {% endfor %}
};

// Selected complaints with notes (for edit mode)
const selectedComplaintsData = {
    {% if selected_complaints %}
        {% for sc in selected_complaints %}
        {{ sc.complaint.id }}: "{{ sc.note|escapejs }}",
        {% endfor %}
    {% endif %}
};

function toggleComplaintNote(complaintId) {
    const checkbox = document.getElementById(`complaint_${complaintId}`);
    const noteSection = document.getElementById(`note_section_${complaintId}`);
    const textarea = noteSection.querySelector('textarea');
    
    if (checkbox.checked) {
        noteSection.style.display = 'block';
        textarea.focus();
    } else {
        noteSection.style.display = 'none';
        textarea.value = '';
    }
    
    updateComplaintSelectionStatus();
}

function updateComplaintSelectionStatus() {
    const checkboxes = document.querySelectorAll('.complaint-checkbox');
    const checkedBoxes = document.querySelectorAll('.complaint-checkbox:checked');
    const noComplaintsAlert = document.getElementById('no-complaints-selected');
    
    if (checkedBoxes.length === 0) {
        noComplaintsAlert.style.display = 'block';
    } else {
        noComplaintsAlert.style.display = 'none';
    }
}

// Initialize the form state on page load
document.addEventListener('DOMContentLoaded', function() {
    const complaintTypeSelect = document.getElementById('complaint_type');
    const complaintItems = document.querySelectorAll('.complaint-item-wrapper');
    
    complaintTypeSelect.addEventListener('change', function() {
        const selectedType = complaintTypeSelect.value;
        const container = document.getElementById('complaints-container');
        
        if (selectedType) {
            container.style.display = 'block';
            complaintItems.forEach(item => {
                const complaintType = item.getAttribute('data-complaint-type');
                item.style.display = (complaintType === selectedType) ? 'block' : 'none';
            });
        } else {
            container.style.display = 'none';
        }
    });

    // Show note sections for already selected complaints (edit mode)
    const checkboxes = document.querySelectorAll('.complaint-checkbox:checked');
    checkboxes.forEach(checkbox => {
        const complaintId = checkbox.value;
        const noteSection = document.getElementById(`note_section_${complaintId}`);
        if (noteSection) {
            noteSection.style.display = 'block';
        }
    });
    
    updateComplaintSelectionStatus();
});

function startRecording() {
    navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.start();
        audioChunks = [];

        // Update UI
        const startBtn = document.querySelector('[onclick="startRecording()"]');
        const stopBtn = document.querySelector('[onclick="stopRecording()"]');
        startBtn.disabled = true;
        stopBtn.disabled = false;
        startBtn.innerHTML = '<i class="bi bi-mic"></i> Recording...';

        mediaRecorder.addEventListener("dataavailable", event => {
            audioChunks.push(event.data);
        });

        mediaRecorder.addEventListener("stop", () => {
            const audioBlob = new Blob(audioChunks, { type: "audio/webm" });
            const audioUrl = URL.createObjectURL(audioBlob);
            const player = document.getElementById("player");
            player.src = audioUrl;
            player.style.display = 'block';

            const fileReader = new FileReader();
            fileReader.readAsDataURL(audioBlob);
            fileReader.onloadend = function () {
                document.getElementById("voice_blob").value = fileReader.result;
            };

            // Reset button states
            const startBtn = document.querySelector('[onclick="startRecording()"]');
            const stopBtn = document.querySelector('[onclick="stopRecording()"]');
            startBtn.disabled = false;
            stopBtn.disabled = true;
            startBtn.innerHTML = '<i class="bi bi-mic"></i> Start Recording';
        });
    }).catch(error => {
        alert("Microphone access denied or not supported.");
        console.error("Mic error:", error);
    });
}

function stopRecording() {
    if (mediaRecorder && mediaRecorder.state !== "inactive") {
        mediaRecorder.stop();
        // Stop all tracks to release microphone
        mediaRecorder.stream.getTracks().forEach(track => track.stop());
    }
}
</script>

<style>
/* Complaints Selection Styling */
.complaints-selection-container {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 20px;
    border: 1px solid #e9ecef;
}

.complaint-item-wrapper {
    background: white;
    border-radius: 8px;
    border: 2px solid #e9ecef;
    transition: all 0.3s ease;
    overflow: hidden;
}

.complaint-item-wrapper:hover {
    border-color: #0d6efd;
    box-shadow: 0 2px 8px rgba(13, 110, 253, 0.1);
}

.complaint-header {
    padding: 15px 20px;
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
}

.form-check-input.complaint-checkbox {
    width: 20px;
    height: 20px;
    margin-right: 12px;
    cursor: pointer;
    border: 2px solid #dee2e6;
    transition: all 0.2s ease;
}

.form-check-input.complaint-checkbox:checked {
    background-color: #0d6efd;
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

.complaint-label {
    font-weight: 500;
    color: #495057;
    cursor: pointer;
    font-size: 16px;
    line-height: 1.5;
    transition: color 0.2s ease;
}

.form-check-input.complaint-checkbox:checked + .complaint-label {
    color: #0d6efd;
    font-weight: 600;
}

.complaint-note-section {
    border-top: 1px solid #e9ecef;
    background: #f8f9fa;
    transition: all 0.3s ease;
}

.note-input-wrapper {
    padding: 20px;
}

.note-label {
    font-size: 14px;
    font-weight: 500;
    color: #6c757d;
    margin-bottom: 8px;
}

.note-textarea {
    border: 1px solid #dee2e6;
    border-radius: 6px;
    padding: 12px;
    font-size: 14px;
    line-height: 1.5;
    resize: vertical;
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
}

.note-textarea:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

/* Voice Recording Section */
.voice-recording-section {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 20px;
    border: 1px solid #e9ecef;
}

.existing-voice-note {
    background: #e3f2fd;
    border-radius: 6px;
    padding: 15px;
    border-left: 4px solid #2196f3;
}

/* Button Enhancements */
.btn-sm i {
    margin-right: 5px;
}

.btn-lg i {
    margin-right: 8px;
}

/* Alert Styling */
.alert-info {
    background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
    border: 1px solid #bee5eb;
    color: #0c5460;
    border-radius: 8px;
    padding: 15px;
}

.alert-info i {
    margin-right: 8px;
}

/* Form Control Enhancements */
.form-control, .form-select {
    border-radius: 6px;
    padding: 12px;
    font-size: 15px;
    transition: all 0.2s ease;
}

.form-control:focus, .form-select:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

/* Card Styling */
.card {
    border: none;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
}

/* Responsive Design */
@media (max-width: 768px) {
    .container {
        margin-top: 20px;
        padding: 10px;
    }
    
    .complaint-header {
        padding: 12px 15px;
    }
    
    .note-input-wrapper {
        padding: 15px;
    }
}
</style>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const customerSelect = document.getElementById('customer_code');
    const placeInput = document.getElementById('place');

    customerSelect.addEventListener('change', function () {
        const selectedOption = customerSelect.options[customerSelect.selectedIndex];
        const address = selectedOption.getAttribute('data-address') || '';
        placeInput.value = address;
    });
});
</script>
<script>
document.addEventListener("DOMContentLoaded", function () {
    const customerInput = document.getElementById("customer");
    const customerDropdown = document.getElementById("customerDropdown");
    const placeInput = document.getElementById("place");
    const newCustomerBtn = document.getElementById("newCustomerBtn");
    const newCustomerFields = document.getElementById("newCustomerFields");
    const newCustomerName = document.getElementById("new_customer_name");
    const newCustomerAddress = document.getElementById("new_customer_address");
    const viewCustomerBtn = document.getElementById("viewCustomerBtn");

    let isNewCustomer = false;
    let allCustomers = [];
    let selectedCustomerData = null;

    // Toggle between new customer and existing customer
    newCustomerBtn.addEventListener("click", function() {
        isNewCustomer = !isNewCustomer;
        
        if (isNewCustomer) {
            newCustomerBtn.textContent = "Select Existing";
            newCustomerBtn.classList.remove("btn-outline-secondary");
            newCustomerBtn.classList.add("btn-outline-primary");
            newCustomerFields.style.display = "block";
            customerDropdown.style.display = "none";
            customerInput.value = "";
            customerInput.placeholder = "Will use new customer details below";
            customerInput.readOnly = true;
            customerInput.required = false;
            newCustomerName.required = true;
            newCustomerAddress.required = true;
            viewCustomerBtn.disabled = true;  // Disable eye button for new customers
            
            // Add event listener to auto-fill place when new customer address changes
            newCustomerAddress.addEventListener("input", function() {
                placeInput.value = newCustomerAddress.value;
            });
        } else {
            newCustomerBtn.textContent = "New Customer";
            newCustomerBtn.classList.remove("btn-outline-primary");
            newCustomerBtn.classList.add("btn-outline-secondary");
            newCustomerFields.style.display = "none";
            customerInput.placeholder = "Search or type new customer";
            customerInput.readOnly = false;
            customerInput.required = true;
            newCustomerName.required = false;
            newCustomerAddress.required = false;
            
            // Remove the event listener when switching back to existing customer
            newCustomerAddress.removeEventListener("input", function() {
                placeInput.value = newCustomerAddress.value;
            });
        }
    });

    // View Customer Details Button Click Handler
    viewCustomerBtn.addEventListener("click", function() {
        if (selectedCustomerData) {
            showCustomerDetails(selectedCustomerData);
        }
    });

    // Function to show customer details in modal
    function showCustomerDetails(customerData) {
        const modal = new bootstrap.Modal(document.getElementById('customerDetailsModal'));
        const content = document.getElementById('customerDetailsContent');

            // Calculate AG (Age from installation date to now)
    let agText = 'N/A';
    if (customerData.installationdate) {
        const installDate = new Date(customerData.installationdate);
        const today = new Date();

        let years = today.getFullYear() - installDate.getFullYear();
        let months = today.getMonth() - installDate.getMonth();

        if (months < 0) {
            years--;
            months += 12;
        }

        agText = `${years} yr${years !== 1 ? 's' : ''} ${months} month${months !== 1 ? 's' : ''}`;
    }

    // Format date to dd-mm-yyyy
    const formattedInstallDate = customerData.installationdate
        ? new Date(customerData.installationdate).toLocaleDateString('en-GB')
        : 'N/A';
        
        content.innerHTML = `
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h6 class="mb-0">Customer Details</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Code:</strong> ${customerData.code || 'N/A'}</p>
                            <p><strong>Name:</strong> ${customerData.name || 'N/A'}</p>
                            <p><strong>Mobile:</strong> ${customerData.mobile || 'N/A'}</p>
                            <p><strong>Account Code:</strong> ${customerData.accountcode || 'N/A'}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Address:</strong> ${customerData.address || 'N/A'}</p>
                            <p><strong>Address 3:</strong> ${customerData.address3 || 'N/A'}</p>
                            <p><strong>District:</strong> ${customerData.district || 'N/A'}</p>
                            <p><strong>State:</strong> ${customerData.state || 'N/A'}</p>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <p><strong>Branch:</strong> ${customerData.branch || 'N/A'}</p>
                            <p><strong>Route:</strong> ${customerData.route || 'N/A'}</p>
                            <p><strong>Nature:</strong> ${customerData.nature || 'N/A'}</p>
                            <p><strong>Direct Dealing:</strong> ${customerData.directdealing || 'N/A'}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Software:</strong> ${customerData.software || 'N/A'}</p>
                            <p><strong>Installation Date:</strong> 
                            ${customerData.installationdate ? new Date(customerData.installationdate).toLocaleDateString('en-GB') : 'N/A'}
                            </p>
                            <p><strong>Age:</strong> ${agText}</p>
                            <p><strong>License Type:</strong> ${customerData.lictype || 'N/A'}</p>
                            <p><strong>Clients:</strong> ${customerData.clients || 'N/A'}</p>
                            <p><strong>SP:</strong> ${customerData.sp || 'N/A'}</p>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-12">
                            <p><strong>AMC:</strong> ${customerData.amc || 'N/A'}</p>
                            <p><strong>AMC Amount:</strong> ${customerData.amcamt || 'N/A'}</p>
                            <p><strong>Priority:</strong> ${customerData.priority || 'N/A'}</p>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        modal.show();
    }

    // Fetch customers when the page loads
    fetch('/proxy/customers/')
        .then(response => response.json())
        .then(data => {
            allCustomers = data; // Store all customers data
            customerDropdown.innerHTML = ""; // Clear existing options

            // Add customer options with address data
            data.forEach(customer => {
                const option = document.createElement("div");
                option.classList.add("dropdown-item");
                option.textContent = `${customer.name}, ${customer.address}`;
                option.setAttribute("data-address", customer.address);
                option.setAttribute("data-customer-code", customer.code);
                option.addEventListener("click", function () {
                    customerInput.value = customer.name;
                    placeInput.value = option.getAttribute("data-address");
                    customerDropdown.style.display = "none";
                    
                    // Store selected customer data and enable eye button
                    selectedCustomerData = customer;
                    viewCustomerBtn.disabled = false;
                });
                customerDropdown.appendChild(option);
            });

            if (data.length === 0) {
                customerDropdown.innerHTML = '<p style="padding: 10px; margin: 0;">No customers found</p>';
            }
        })
        .catch(error => {
            console.error("Error loading customers:", error);
            customerDropdown.innerHTML = '<p style="padding: 10px; margin: 0;">Failed to load customers. You can add a new customer.</p>';
        });

    // Show dropdown on focus
    customerInput.addEventListener("focus", function () {
        if (!isNewCustomer) {
            customerDropdown.style.display = "block";
        }
    });

    // Hide dropdown when clicking outside
    document.addEventListener("click", function (e) {
        if (!customerInput.contains(e.target) && !customerDropdown.contains(e.target)) {
            customerDropdown.style.display = "none";
        }
    });

    // Filter customers as the user types
    customerInput.addEventListener("input", function () {
        if (isNewCustomer) return;
        
        const filter = customerInput.value.toLowerCase();
        const options = customerDropdown.querySelectorAll(".dropdown-item");
        let hasVisibleItem = false;

        // Reset selected customer data if input is cleared or changed
        if (selectedCustomerData && customerInput.value !== selectedCustomerData.name) {
            selectedCustomerData = null;
            viewCustomerBtn.disabled = true;
        }

        options.forEach(option => {
            if (option.textContent.toLowerCase().includes(filter)) {
                option.style.display = "block";
                hasVisibleItem = true;
            } else {
                option.style.display = "none";
            }
        });

        customerDropdown.style.display = hasVisibleItem ? "block" : "none";
    });

    // Auto-fill place when selecting from dropdown
    customerDropdown.addEventListener("click", function(e) {
        if (e.target.classList.contains("dropdown-item")) {
            placeInput.value = e.target.getAttribute("data-address");
        }
    });
});

// Function to filter complaints based on selected service type
function filterComplaints() {
    const serviceType = document.getElementById('service_type').value.toLowerCase();
    const complaintSelect = document.getElementById('complaint');
    
    Array.from(complaintSelect.options).forEach(option => {
        if (option.value === "") { // Keep the default "Select a complaint" option
            option.hidden = false;
            return;
        }
        const complaintType = option.getAttribute('data-type');
        const show = (complaintType === serviceType || complaintType === 'both');
        option.hidden = !show;
    });

    // Reset selection if current value is hidden
    if (complaintSelect.value && complaintSelect.options[complaintSelect.selectedIndex].hidden) {
        complaintSelect.value = "";
    }
}

// Initial filter on page load
filterComplaints();

// Add event listener for service type changes
document.getElementById('service_type').addEventListener('change', filterComplaints);

document.addEventListener("DOMContentLoaded", function () {
    const modeSelect = document.getElementById('mode_of_service');
    const phoneGroup = document.getElementById('phoneNumberGroup');
    const phoneInput = document.getElementById('phone_number');

    function togglePhoneField() {
        const isOnline = modeSelect.value === 'Online';
        phoneGroup.style.display = isOnline ? 'block' : 'none';
        phoneInput.required = isOnline;
    }

    modeSelect.addEventListener('change', togglePhoneField);
    togglePhoneField();  // Initial check on page load
});
</script>
<script>
    newCustomerBtn.addEventListener("click", function() {
    isNewCustomer = !isNewCustomer;
    
    if (isNewCustomer) {
        newCustomerBtn.textContent = "Select Existing";
        newCustomerBtn.classList.remove("btn-outline-secondary");
        newCustomerBtn.classList.add("btn-outline-primary");
        newCustomerFields.style.display = "block";
        customerDropdown.style.display = "none";
        customerInput.value = "";
        customerInput.placeholder = "Will use new customer details below";
        customerInput.readOnly = true;
        customerInput.required = false;
        newCustomerName.required = true;
        newCustomerAddress.required = true;
        viewCustomerBtn.disabled = true;  // Disable eye button for new customers
        
        // Show the "Customer Name (Manual Entry)" section
        document.querySelector('.new-customer-section').style.display = 'block';
        
        // Add event listener to auto-fill place when new customer address changes
        newCustomerAddress.addEventListener("input", function() {
            placeInput.value = newCustomerAddress.value;
        });
    } else {
        newCustomerBtn.textContent = "New Customer";
        newCustomerBtn.classList.remove("btn-outline-primary");
        newCustomerBtn.classList.add("btn-outline-secondary");
        newCustomerFields.style.display = "none";
        customerInput.placeholder = "Search or type new customer";
        customerInput.readOnly = false;
        customerInput.required = true;
        newCustomerName.required = false;
        newCustomerAddress.required = false;
        
        // Hide the "Customer Name (Manual Entry)" section
        document.querySelector('.new-customer-section').style.display = 'none';
        
        // Remove the event listener when switching back to existing customer
        newCustomerAddress.removeEventListener("input", function() {
            placeInput.value = newCustomerAddress.value;
        });
    }
});
</script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
    const newCustomerBtn = document.getElementById("newCustomerBtn");
    const customerInput = document.getElementById("customer");
    const customerNameInput = document.getElementById("customer_name");
    const newCustomerSection = document.querySelector('.new-customer-section');

    newCustomerBtn.addEventListener("click", function() {
        const isNewCustomer = newCustomerBtn.textContent === "New Customer";
        
        if (isNewCustomer) {
            newCustomerBtn.textContent = "Select Existing";
            newCustomerBtn.classList.remove("btn-outline-secondary");
            newCustomerBtn.classList.add("btn-outline-primary");
            customerInput.required = false;
            customerNameInput.required = true;
            newCustomerSection.style.display = 'block';
        } else {
            newCustomerBtn.textContent = "New Customer";
            newCustomerBtn.classList.remove("btn-outline-primary");
            newCustomerBtn.classList.add("btn-outline-secondary");
            customerInput.required = true;
            customerNameInput.required = false;
            newCustomerSection.style.display = 'none';
        }
    });
});
</script>
<script>
// Updated JavaScript code to replace the existing script in add_service_log.html

let complaintIndex = 0;
let currentComplaintType = '';

function addComplaintBlock(selectedId = '', note = '') {
    const container = document.getElementById('complaint-blocks-container');
    const div = document.createElement('div');
    div.classList.add('complaint-block', 'p-3', 'border', 'rounded', 'mb-3');
    div.dataset.index = complaintIndex;

    // build the <option>s exactly as you already do …
    let complaintOptions = '<option value="">-- Select Complaint --</option>';
    {% for c in complaints %}
        if (currentComplaintType === 'both' || currentComplaintType === '{{ c.complaint_type }}') {
            const selected = selectedId === '{{ c.id }}' ? 'selected' : '';
            complaintOptions += `<option value="{{ c.id }}" ${selected}>
                                    {{ c.description }} ({{ c.complaint_type|title }})
                                 </option>`;
        }
    {% endfor %}

    // drop the HTML in
    div.innerHTML = `
        <div class="row g-3 align-items-start">
            <div class="col-md-4">
                <label class="form-label">Complaint</label>
                <select class="form-select complaint-select"
                        name="complaints"
                        required
                        onchange="updateNoteFieldName(this)">
                    ${complaintOptions}
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label">Note</label>
                <input type="text" class="form-control note-input" name="note_placeholder_${complaintIndex}" placeholder="Optional note" value="${note}">
            </div>
            <div class="col-md-3">
                <label class="form-label">Upload Images</label>
                <input type="file" class="form-control image-input" name="images_placeholder_${complaintIndex}" multiple accept="image/*">
                <small class="text-muted">Hold Ctrl to select multiple images</small>
            </div>
            <div class="col-md-1 text-end d-flex align-items-end">
                <button type="button" class="btn btn-danger btn-sm mt-auto" onclick="removeComplaintBlock(this)">
                    <i class="bi bi-x"></i>
                </button>
            </div>
        </div>
        <div class="image-preview-container mt-2" id="image-preview-${complaintIndex}" style="display: none;">
            <div class="d-flex flex-wrap gap-2"></div>
        </div>
    `;

    container.appendChild(div);
    $(div).find('.complaint-select').select2({
        placeholder: '-- Select Complaint --',
        allowClear: true,
        width: '100%',
        dropdownParent: $(div)          // fixes z‑index if you ever use modals
    });
    complaintIndex++;

    // Initialize image preview for this block
    const imageInput = div.querySelector('.image-input');
    imageInput.addEventListener('change', function() {
        previewImages(this);
    });

    if (selectedId) {
        const imageInput = div.querySelector('.image-input');
        const noteInput = div.querySelector('.note-input');
        imageInput.name = `images_${selectedId}`;
        noteInput.name = `note_${selectedId}`;
    }

    complaintIndex++;
    updateComplaintSelectionStatus();
}

function previewImages(input) {
    const previewContainer = input.closest('.complaint-block').querySelector('.image-preview-container');
    const previewDiv = previewContainer.querySelector('.d-flex');
    previewDiv.innerHTML = '';
    
    if (input.files.length > 0) {
        previewContainer.style.display = 'block';
        
        for (let i = 0; i < input.files.length; i++) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const previewItem = document.createElement('div');
                previewItem.style.position = 'relative';
                previewItem.style.width = '80px';
                previewItem.style.height = '80px';
                previewItem.style.border = '1px solid #ddd';
                previewItem.style.borderRadius = '4px';
                previewItem.style.overflow = 'hidden';
                
                const img = document.createElement('img');
                img.src = e.target.result;
                img.style.width = '100%';
                img.style.height = '100%';
                img.style.objectFit = 'cover';
                
                previewItem.appendChild(img);
                previewDiv.appendChild(previewItem);
            }
            reader.readAsDataURL(input.files[i]);
        }
    } else {
        previewContainer.style.display = 'none';
    }
}



function updateNoteFieldName(selectElement) {
    const block = selectElement.closest('.complaint-block');
    const noteInput = block.querySelector('.note-input');
    const imageInput = block.querySelector('.image-input');
    const selectedComplaintId = selectElement.value;

    if (selectedComplaintId) {
        noteInput.name = `note_${selectedComplaintId}`;
        imageInput.name = `images_${selectedComplaintId}`;
        noteInput.disabled = false;
        imageInput.disabled = false;
    } else {
        const idx = block.getAttribute('data-index');
        noteInput.name = `note_placeholder_${idx}`;
        imageInput.name = `images_placeholder_${idx}`;
        noteInput.disabled = true;
        imageInput.disabled = true;
        noteInput.value = '';
    }
}



function removeComplaintBlock(button) {
    const block = button.closest('.complaint-block');
    block.remove();
    updateComplaintSelectionStatus();
}

function updateComplaintSelectionStatus() {
    const blocks = document.querySelectorAll('.complaint-block');
    const alertBox = document.getElementById('no-complaints-selected');
    if (blocks.length === 0) {
        alertBox.style.display = 'block';
    } else {
        alertBox.style.display = 'none';
    }
}

function updateComplaintOptions() {
    // Update all existing complaint dropdowns with the new complaint type
    const complaintSelects = document.querySelectorAll('.complaint-select');
    
    complaintSelects.forEach(select => {
        const currentValue = select.value;
        let newOptions = '<option value="">-- Select Complaint --</option>';
        
        // Add complaints that match the selected type
        {% for c in complaints %}
             if (currentComplaintType === 'both' || currentComplaintType === '{{ c.complaint_type }}') {
                const selected = currentValue === '{{ c.id }}' ? 'selected' : '';
                newOptions += `<option value="{{ c.id }}" ${selected}>{{ c.description }}</option>`;
            }
        {% endfor %}
        
        select.innerHTML = newOptions;
        
        // Update the note field name based on selection
        updateNoteFieldName(select);
        
        // If the previously selected complaint doesn't match the new type, reset
        if (currentValue) {
            let foundMatch = false;
            {% for c in complaints %}
                if ('{{ c.id }}' === currentValue && '{{ c.complaint_type }}' === currentComplaintType) {
                    foundMatch = true;
                }
            {% endfor %}
            if (!foundMatch) {
                select.value = '';
                updateNoteFieldName(select);
            }
        }
    });
}

document.addEventListener('DOMContentLoaded', function () {
    const complaintTypeSelect = document.getElementById('complaint_type');
    
    complaintTypeSelect.addEventListener('change', function () {
        const container = document.getElementById('complaints-container');
        const blocks = document.getElementById('complaint-blocks-container');
        
        currentComplaintType = this.value;

        if (this.value) {
            container.style.display = 'block';
            
            // Update existing complaint dropdowns
            updateComplaintOptions();
            
            // If no blocks exist, add the first one
            if (blocks.children.length === 0) {
                addComplaintBlock();
            }
        } else {
            container.style.display = 'none';
            blocks.innerHTML = '';
            complaintIndex = 0;
            currentComplaintType = '';
        }
    });

    // Initialize on page load if editing
    {% if log and log.complaint_type %}
        currentComplaintType = '{{ log.complaint_type }}';
        if (currentComplaintType) {
            document.getElementById('complaints-container').style.display = 'block';
            // Add existing complaint blocks for edit mode
            {% for sc in selected_complaints %}
                addComplaintBlock('{{ sc.complaint.id }}', '{{ sc.note|escapejs }}');
            {% endfor %}
        }
    {% endif %}

    updateComplaintSelectionStatus();
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const complaintTypeSelect = document.getElementById('complaint_type');
    const complaintSelect = document.getElementById('complaint');

    // Complaint data from Django template
    const complaintsData = {
        {% for c in complaints %}
        {{ c.id }}: {
            "description": "{{ c.description|escapejs }}",
            "type": "{{ c.complaint_type }}"
        },
        {% endfor %}
    };

    function updateComplaintOptions() {
        const selectedType = complaintTypeSelect.value;
        const options = complaintSelect.options;
        let optionCount = 0;

        for (const complaintId in complaintsData) {
            const complaint = complaintsData[complaintId];
            const option = options[optionCount + 1]; // +1 to skip the default option

            if (selectedType === 'both' || complaint.type === selectedType) {
                option.value = complaintId;
                option.text = `${complaint.description} (${complaint.type})`;
                option.hidden = false;
            } else {
                option.hidden = true;
            }
            optionCount++;
        }
    }

    complaintTypeSelect.addEventListener('change', updateComplaintOptions);
    updateComplaintOptions(); // Initial call to populate the dropdown
});
</script>
{% endblock %} 