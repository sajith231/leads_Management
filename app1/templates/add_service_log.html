{% extends "base.html" %}
{% load static %}
{% block content %}

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Select2 CSS & JS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<!-- Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
/* Customer dropdown sizing and behavior */
#customerDropdown {
    display: none; /* shown via JS */
    max-height: 300px;
    overflow-y: auto;
    width: 100% !important;
}

#customerDropdown .dropdown-item {
    white-space: normal;
    line-height: 1.3;
}

    .image-thumbnail {
    width: 60px;
    height: 60px;
    object-fit: cover;
    border-radius: 4px;
    border: 1px solid #ccc;
}
/* Add this to your existing CSS */
.image-preview-container {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 10px;
    margin-top: 10px;
}

.image-preview-container .d-flex {
    gap: 10px;
}

.image-preview-container img {
    border-radius: 4px;
    border: 1px solid #dee2e6;
    transition: all 0.2s ease;
}

.image-preview-container img:hover {
    transform: scale(1.05);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

/* Customer Details Modal Styling */
.customer-details-modal {
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
    border: none;
}

.customer-details-modal .modal-header {
    background: linear-gradient(135deg, #4f6df5 0%, #3a56e4 100%);
    color: white;
    border-bottom: none;
    padding: 1.5rem;
    position: relative;
}

.customer-details-modal .modal-header::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #ff7eb3, #ff758c, #ff7eb3);
    background-size: 200% 100%;
    animation: shimmer 3s infinite linear;
}

@keyframes shimmer {
    0% { background-position: -200% 0; }
    100% { background-position: 200% 0; }
}

.customer-header {
    display: flex;
    align-items: center;
    gap: 15px;
    width: 100%;
}

.customer-avatar {
    font-size: 3rem;
    color: rgba(255, 255, 255, 0.9);
}

.customer-title {
    flex: 1;
}

.customer-title h5 {
    margin: 0;
    font-weight: 600;
    font-size: 1.4rem;
}

.customer-name {
    display: block;
    font-size: 1.1rem;
    font-weight: 500;
    margin-top: 5px;
    opacity: 0.95;
}

.customer-details {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    margin-top: 8px;
}

.customer-detail-item {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 0.85rem;
    opacity: 0.9;
}

.customer-detail-item i {
    font-size: 0.8rem;
}

.direct-dealing-badge {
    background: rgba(255, 255, 255, 0.2);
    padding: 3px 8px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 500;
    border: 1px solid rgba(255, 255, 255, 0.3);
}

.customer-details-modal .btn-close {
    filter: invert(1);
    opacity: 0.8;
    position: absolute;
    top: 1rem;
    right: 1rem;
}

.customer-details-modal .btn-close:hover {
    opacity: 1;
}

.customer-details-modal .modal-body {
    padding: 0;
}

.customer-details-modal .modal-footer {
    border-top: 1px solid #e9ecef;
    padding: 1rem 1.5rem;
}

/* Customer Details Content Styling */
.customer-details-content {
    padding: 1.5rem;
}

.customer-info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
}

.customer-section {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 1.25rem;
    border-left: 4px solid #4f6df5;
    transition: all 0.3s ease;
}

.customer-section:hover {
    transform: translateY(-3px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
}

.customer-section h6 {
    color: #4f6df5;
    margin-bottom: 1rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
}

.customer-section h6 i {
    font-size: 1.1rem;
}

.info-row {
    display: flex;
    margin-bottom: 0.75rem;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid rgba(0, 0, 0, 0.05);
}

.info-row:last-child {
    margin-bottom: 0;
    padding-bottom: 0;
    border-bottom: none;
}

.info-label {
    font-weight: 600;
    color: #495057;
    min-width: 140px;
    font-size: 0.9rem;
}

.info-value {
    color: #6c757d;
    flex: 1;
    font-size: 0.9rem;
}

.highlight-value {
    color: #4f6df5;
    font-weight: 600;
}

.badge-status {
    display: inline-block;
    padding: 0.35em 0.65em;
    font-size: 0.75em;
    font-weight: 700;
    line-height: 1;
    text-align: center;
    white-space: nowrap;
    vertical-align: baseline;
    border-radius: 0.375rem;
}

.badge-amc {
    background-color: #d1ecf1;
    color: #0c5460;
}

.badge-priority {
    background-color: #f8d7da;
    color: #721c24;
}

.badge-license {
    background-color: #d4edda;
    color: #155724;
}

.loading-content {
    padding: 3rem 1rem;
}

/* Customer Details Tabs Styling */
.customer-tabs {
    border-bottom: 1px solid #dee2e6;
    margin-bottom: 1.5rem;
}

.customer-tabs .nav-tabs {
    border-bottom: none;
}

.customer-tabs .nav-link {
    border: none;
    color: #6c757d;
    font-weight: 500;
    padding: 0.75rem 1.5rem;
    border-radius: 8px 8px 0 0;
    transition: all 0.3s ease;
}

.customer-tabs .nav-link:hover {
    color: #4f6df5;
    background-color: rgba(79, 109, 245, 0.05);
}

.customer-tabs .nav-link.active {
    color: #4f6df5;
    background-color: white;
    border-bottom: 3px solid #4f6df5;
    font-weight: 600;
}

.customer-tabs .nav-link i {
    margin-right: 8px;
    font-size: 0.9rem;
}

/* Service History Styling */
.service-history-container {
    max-height: 400px;
    overflow-y: auto;
}

.service-history-item {
    background: white;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 0.75rem;
    transition: all 0.3s ease;
}

.service-history-item:hover {
    border-color: #4f6df5;
    box-shadow: 0 2px 8px rgba(79, 109, 245, 0.1);
}

.service-history-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 0.5rem;
}

.service-history-ticket {
    font-weight: 600;
    color: #4f6df5;
    font-size: 0.9rem;
}

.service-history-date {
    color: #6c757d;
    font-size: 0.8rem;
}

.service-history-complaints {
    margin-bottom: 0.5rem;
}

.service-history-complaint {
    background: #f8f9fa;
    border-radius: 4px;
    padding: 0.25rem 0.5rem;
    margin-right: 0.5rem;
    margin-bottom: 0.25rem;
    font-size: 0.8rem;
    display: inline-block;
}

.service-history-remarks {
    color: #495057;
    font-size: 0.85rem;
    margin-bottom: 0.5rem;
}

.service-history-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.75rem;
    color: #6c757d;
}

.service-history-technician {
    font-weight: 500;
}

.service-history-status {
    padding: 0.2rem 0.5rem;
    border-radius: 12px;
    font-size: 0.7rem;
    font-weight: 600;
}

.status-completed {
    background-color: #d4edda;
    color: #155724;
}

.status-pending {
    background-color: #fff3cd;
    color: #856404;
}

.status-in-progress {
    background-color: #cce7ff;
    color: #004085;
}

.no-service-history {
    text-align: center;
    padding: 2rem;
    color: #6c757d;
}

.no-service-history i {
    font-size: 3rem;
    margin-bottom: 1rem;
    color: #dee2e6;
}

.loading-tab {
    text-align: center;
    padding: 2rem;
}

.loading-tab .spinner-border {
    width: 2rem;
    height: 2rem;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .customer-info-grid {
        grid-template-columns: 1fr;
    }
    
    .customer-header {
        flex-direction: column;
        text-align: center;
        gap: 10px;
    }
    
    .customer-avatar {
        font-size: 2.5rem;
    }
    
    .customer-details {
        justify-content: center;
        gap: 10px;
    }
    
    .customer-detail-item {
        font-size: 0.8rem;
    }
    
    .service-history-header {
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .service-history-footer {
        flex-direction: column;
        gap: 0.5rem;
        align-items: flex-start;
    }
}
</style>
<style>
.neon-badge {
    background: rgba(0, 0, 0, 0.3);
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    border: 1px solid #00ff88;
    color: #00ff88;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    box-shadow: 0 0 10px rgba(0, 255, 136, 0.5),
                0 0 20px rgba(0, 255, 136, 0.3),
                0 0 30px rgba(0, 255, 136, 0.1);
    text-shadow: 0 0 5px rgba(0, 255, 136, 0.5);
    animation: neon-pulse 2s ease-in-out infinite alternate;
}

@keyframes neon-pulse {
    from {
        box-shadow: 0 0 10px rgba(0, 255, 136, 0.5),
                    0 0 20px rgba(0, 255, 136, 0.3),
                    0 0 30px rgba(0, 255, 136, 0.1);
    }
    to {
        box-shadow: 0 0 15px rgba(0, 255, 136, 0.7),
                    0 0 25px rgba(0, 255, 136, 0.5),
                    0 0 35px rgba(0, 255, 136, 0.3);
    }
}
</style>
<style>
/* Complaints Selection Container */
.complaints-selection-wrapper {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 12px;
    padding: 24px;
    border: 2px solid #dee2e6;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    margin-bottom: 24px;
}

/* Header with label and buttons */
.complaints-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 12px;
    border-bottom: 2px solid #dee2e6;
}

.complaints-label {
    font-size: 16px;
    font-weight: 600;
    color: #495057;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 8px;
}

.complaints-label i {
    color: #0d6efd;
    font-size: 18px;
}

.complaints-actions {
    display: flex;
    gap: 10px;
}

/* Complaint Blocks Container */
#complaint-blocks-container {
    display: flex;
    flex-direction: column;
    gap: 16px;
}

/* Individual Complaint Block */
.complaint-block {
    background: white;
    border-radius: 10px;
    padding: 20px;
    border: 2px solid #e9ecef;
    transition: all 0.3s ease;
    position: relative;
    box-shadow: 0 1px 4px rgba(0, 0, 0, 0.05);
}

.complaint-block:hover {
    border-color: #0d6efd;
    box-shadow: 0 4px 12px rgba(13, 110, 253, 0.15);
    transform: translateY(-2px);
}

.complaint-block-content {
    display: flex;
    align-items: center;
    gap: 16px;
}

.complaint-number {
    font-size: 14px;
    font-weight: 700;
    color: white;
    background: linear-gradient(135deg, #0d6efd 0%, #0056b3 100%);
    padding: 10px 18px;
    border-radius: 8px;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    white-space: nowrap;
    min-width: 140px;
    justify-content: center;
    box-shadow: 0 2px 6px rgba(13, 110, 253, 0.3);
}

.complaint-number i {
    font-size: 16px;
}

/* Select2 Customization */
.complaint-select-wrapper {
    position: relative;
    flex: 1;
}

.complaint-block .select2-container {
    width: 100% !important;
}

.complaint-block .select2-selection--single {
    height: 48px !important;
    padding: 10px 16px !important;
    font-size: 15px !important;
    border: 2px solid #dee2e6 !important;
    border-radius: 8px !important;
    transition: all 0.3s ease !important;
}

.complaint-block .select2-selection--single:hover {
    border-color: #0d6efd !important;
}

.complaint-block .select2-selection--single:focus,
.complaint-block .select2-container--open .select2-selection--single {
    border-color: #0d6efd !important;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25) !important;
}

.complaint-block .select2-selection__rendered {
    line-height: 28px !important;
    font-size: 15px !important;
    color: #495057 !important;
    font-weight: 500 !important;
}

.complaint-block .select2-selection__arrow {
    height: 46px !important;
    right: 10px !important;
}

/* Larger Dropdown */
.larger-dropdown {
    border: 2px solid #0d6efd !important;
    border-radius: 8px !important;
    box-shadow: 0 8px 24px rgba(13, 110, 253, 0.2) !important;
    margin-top: 4px !important;
}

.larger-dropdown .select2-results__options {
    max-height: 320px !important;
    font-size: 15px !important;
    padding: 8px 0 !important;
}

.larger-dropdown .select2-results__option {
    padding: 14px 18px !important;
    line-height: 1.5 !important;
    white-space: normal !important;
    min-height: 48px !important;
    display: flex !important;
    align-items: center !important;
    transition: all 0.2s ease !important;
    border-bottom: 1px solid #f8f9fa !important;
}

.larger-dropdown .select2-results__option:last-child {
    border-bottom: none !important;
}

.larger-dropdown .select2-results__option--highlighted {
    background: linear-gradient(135deg, #0d6efd 0%, #0056b3 100%) !important;
    color: white !important;
}

/* Complaint Summary (after selection) */
.complaint-summary {
    display: none;
    background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
    border: 2px solid #0dcaf0;
    border-radius: 8px;
    padding: 14px 18px;
    margin-top: 12px;
    font-weight: 600;
    color: #055160;
    font-size: 15px;
    box-shadow: 0 2px 6px rgba(13, 202, 240, 0.15);
}

.complaint-summary .badge-type {
    background: rgba(255, 255, 255, 0.9);
    color: #0c5460;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 700;
    margin-left: 10px;
    border: 1px solid #0dcaf0;
}

/* Action Buttons */
.btn-add-complaint {
    background: linear-gradient(135deg, #198754 0%, #157347 100%);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    transition: all 0.3s ease;
    box-shadow: 0 2px 6px rgba(25, 135, 84, 0.3);
}

.btn-add-complaint:hover {
    background: linear-gradient(135deg, #157347 0%, #0f5132 100%);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(25, 135, 84, 0.4);
}

.btn-remove-complaint {
    background: linear-gradient(135deg, #dc3545 0%, #bb2d3b 100%);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    transition: all 0.3s ease;
    box-shadow: 0 2px 6px rgba(220, 53, 69, 0.3);
}

.btn-remove-complaint:hover {
    background: linear-gradient(135deg, #bb2d3b 0%, #a02430 100%);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
}

.btn-remove-complaint:disabled {
    background: #6c757d;
    cursor: not-allowed;
    opacity: 0.5;
    box-shadow: none;
}

.btn-remove-complaint:disabled:hover {
    transform: none;
}

/* Alert Box */
#no-complaints-selected {
    background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
    border: 2px solid #ffc107;
    border-radius: 10px;
    padding: 16px 20px;
    color: #664d03;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 12px;
    margin-top: 16px;
    box-shadow: 0 2px 6px rgba(255, 193, 7, 0.2);
}

#no-complaints-selected i {
    font-size: 20px;
    color: #ffc107;
}

/* Responsive Design */
@media (max-width: 768px) {
    .complaints-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
    }
    
    .complaints-actions {
        width: 100%;
        justify-content: flex-start;
    }
    
    .btn-add-complaint,
    .btn-remove-complaint {
        flex: 1;
        justify-content: center;
    }
    
    .complaint-block {
        padding: 16px;
    }
    
    .complaint-block-content {
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
    }
    
    .complaint-number {
        width: 100%;
        min-width: auto;
    }
    
    .complaint-block .select2-selection--single {
        height: 44px !important;
        padding: 8px 14px !important;
    }
}

/* Animation */
@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.complaint-block {
    animation: slideIn 0.3s ease;
}
</style>
<style>
/* Customer Info Box Styling */
.customer-info-box {
    /* default: hidden off-canvas for small screens */
    position: fixed;
    right: 20px;     /* default on right */
    top: 50%;
    transform: translateY(-50%);
    width: 320px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 16px;
    padding: 20px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    color: white;
    display: none;
    z-index: 1000;
    max-height: 80vh;
    overflow-y: auto;
    animation: slideInRight 0.4s ease-out;
}

@keyframes slideInLeft {
    from {
        opacity: 0;
        transform: translateY(-50%) translateX(-30px);
    }
    to {
        opacity: 1;
        transform: translateY(-50%) translateX(0);
    }
}

.customer-info-box.show {
    display: block;
}
.customer-info-box.stable {
    display: block !important;
    right: 20px;
    left: auto;
    top: 50%;
    transform: translateY(-50%);
}

.customer-info-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px solid rgba(255, 255, 255, 0.3);
}

.customer-info-title {
    font-size: 18px;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 10px;
}

.customer-info-title i {
    font-size: 24px;
}

.close-info-btn {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
}

.close-info-btn:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: rotate(90deg);
}

.customer-info-item {
    margin-bottom: 16px;
    padding: 12px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    backdrop-filter: blur(10px);
    transition: all 0.3s ease;
}

.customer-info-item:hover {
    background: rgba(255, 255, 255, 0.15);
    transform: translateX(5px);
}

.info-label-small {
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    opacity: 0.8;
    margin-bottom: 4px;
    display: flex;
    align-items: center;
    gap: 6px;
}

.info-label-small i {
    font-size: 12px;
}

.info-value-large {
    font-size: 16px;
    font-weight: 700;
    word-break: break-word;
}

.info-badge {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 13px;
    font-weight: 600;
    background: rgba(255, 255, 255, 0.9);
    color: #667eea;
}

.customer-name-display {
    font-size: 20px;
    font-weight: 800;
    margin-bottom: 20px;
    padding: 15px;
    background: rgba(255, 255, 255, 0.15);
    border-radius: 12px;
    text-align: center;
    border: 2px solid rgba(255, 255, 255, 0.3);
}

/* Scrollbar styling for info box */
.customer-info-box::-webkit-scrollbar {
    width: 6px;
}

.customer-info-box::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 10px;
}

.customer-info-box::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.3);
    border-radius: 10px;
}

.customer-info-box::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.5);
}

/* Responsive adjustments */
@media (max-width: 1400px) {
    .customer-info-box {
        width: 280px;
        left: 10px;
    }
}

@media (max-width: 1200px) {
    .customer-info-box {
        position: relative;
        left: 0;
        top: 0;
        transform: none;
        width: 100%;
        margin-bottom: 20px;
    }
}
</style>


<div class="customer-info-box stable show" id="customerInfoBox">
    <div class="customer-info-header">
        <div class="customer-info-title">
            <i class="fas fa-user-circle"></i>
            <span>Customer Info</span>
        </div>
        <button type="button" class="close-info-btn" onclick="closeCustomerInfoBox()">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <div class="customer-name-display" id="infoCustomerName">
        Select a customer
    </div>

    <div class="customer-info-item">
        <div class="info-label-small">
            <i class="fas fa-desktop"></i>
            Software
        </div>
        <div class="info-value-large" id="infoSoftware">N/A</div>
    </div>

    <div class="customer-info-item">
        <div class="info-label-small">
            <i class="fas fa-calendar-alt"></i>
            Age
        </div>
        <div class="info-value-large" id="infoAge">N/A</div>
    </div>

    <div class="customer-info-item">
        <div class="info-label-small">
            <i class="fas fa-key"></i>
            License Type
        </div>
        <div class="info-value-large">
            <span class="info-badge" id="infoLicenseType">N/A</span>
        </div>
    </div>

    <div class="customer-info-item">
        <div class="info-label-small">
            <i class="fas fa-users"></i>
            Clients
        </div>
        <div class="info-value-large" id="infoClients">N/A</div>
    </div>

    <div class="customer-info-item">
        <div class="info-label-small">
            <i class="fas fa-headset"></i>
            SP
        </div>
        <div class="info-value-large" id="infoSP">N/A</div>
    </div>

    <div class="customer-info-item">
        <div class="info-label-small">
            <i class="fas fa-file-contract"></i>
            AMC
        </div>
        <div class="info-value-large">
            <span class="info-badge" id="infoAMC">N/A</span>
        </div>
    </div>

    <div class="customer-info-item">
        <div class="info-label-small">
            <i class="fas fa-code-branch"></i>
            Branch
        </div>
        <div class="info-value-large" id="infoBranch">N/A</div>
    </div>

    <div class="customer-info-item">
        <div class="info-label-small">
            <i class="fas fa-briefcase"></i>
            Nature
        </div>
        <div class="info-value-large" id="infoNature">N/A</div>
    </div>
</div>
<div class="" style="max-width: 800px;">
    <h2 class="mb-4 text-center">{% if log %}Edit{% else %}Add{% endif %} Service Log</h2>

    <form method="post" enctype="multipart/form-data" class="card p-4 shadow-sm">
        {% csrf_token %}
<!-- ======  ONE BOX – THREE ROWS  ====== -->
<div class="card shadow-lg mb-4 border-0">
    <!-- Header -->
    <div class="card-header text-center py-3 text-white"
         style="background: linear-gradient(135deg,#6a11cb 0%, #2575fc 100%);">
        <h5 class="mb-0 fw-bold"><i class="fas fa-id-card me-2"></i>Customer Information</h5>
    </div>

    <div class="card-body p-0">
        <!-- Customer row -->
        <div class="d-flex align-items-center px-4 py-3 border-bottom"
             style="background: linear-gradient(135deg,#667eea 0%, #764ba2 100%);">
            <div class="text-white fw-600 me-3" style="min-width:100px;">
                <i class="fas fa-user-circle me-2"></i>Customer
            </div>
            <div class="flex-grow-1">
                <div class="input-group input-group-sm">
                    <input type="text" class="form-control" id="customer" name="customer"
                           placeholder="Search or type new customer" autocomplete="off">
                    <button class="btn btn-light" type="button" id="newCustomerBtn">New</button>
                    <button class="btn btn-light" type="button" id="viewCustomerBtn" title="View Customer Details" disabled>
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
                <div id="customerDropdown" class="dropdown-menu w-100"></div>
                <div class="new-customer-section mt-2" style="display:none;">
                    <input type="text" class="form-control form-control-sm" name="customer_name" id="customer_name"
                           value="{{ log.customer_name|default_if_none:'' }}" placeholder="Enter customer name manually">
                </div>
            </div>
        </div>

        <!-- Place row -->
        <div class="d-flex align-items-center px-4 py-3 border-bottom"
             style="background: linear-gradient(135deg,#f093fb 0%, #f5576c 100%);">
            <div class="text-white fw-600 me-3" style="min-width:100px;">
                <i class="fas fa-map-marker-alt me-2"></i>Place
            </div>
            <div class="flex-grow-1">
                <input type="text" class="form-control form-control-sm" name="place" id="place"
                       value="{{ log.place|default_if_none:'' }}" placeholder="Enter place">
            </div>
        </div>

        <!-- Phone row -->
        <div class="d-flex align-items-center px-4 py-3"
             style="background: linear-gradient(135deg,#4facfe 0%, #00f2fe 100%);">
            <div class="text-white fw-600 me-3" style="min-width:100px;">
                <i class="fas fa-phone me-2"></i>Phone
            </div>
            <div class="flex-grow-1">
                <input type="text" class="form-control form-control-sm" name="phone_number"
                       value="{{ log.phone_number|default_if_none:'' }}" placeholder="Customer's contact number">
            </div>
        </div>
    </div><!-- /card-body -->
</div><!-- /card -->


<div class="mb-3 software-select-wrapper">
            <label class="form-label">Software</label>
            <select id="software_select" name="software" class="form-select">
                <option value="">-- All Softwares (or select to filter) --</option>
                {% for s in softwares %}
                    <option value="{{ s.id }}">{{ s.name }}</option>
                {% endfor %}
            </select>
            <small class="text-muted">Choose a software to show only complaints related to it.</small>
        </div>


        <div class="mb-3" style="display: none;">
            <label class="form-label">Complaint Type</label>
            <select class="form-select" name="complaint_type" id="complaint_type" required>
                <option value="software" selected>Software</option>
            </select>
        </div>

        <!-- ---------- Complaints Container (shown automatically when complaint_type exists) ---------- -->
        <div class="mb-4" id="complaints-container" style="display: none;">
    <div class="complaints-selection-wrapper">
        <div class="complaints-header">
            <label class="complaints-label">
                <i class="fas fa-list-check"></i>
                Select Complaints
            </label>
            <div class="complaints-actions">
                <button type="button" class="btn btn-add-complaint" onclick="addComplaintBlock()" title="Add another complaint">
                    <i class="fas fa-plus-circle"></i> Add Complaint
                </button>
                <button type="button" class="btn btn-remove-complaint" id="removeComplaintBtn" onclick="removeSelectedComplaint()" title="Remove selected complaint" disabled>
                    <i class="fas fa-trash-alt"></i> Remove
                </button>
            </div>
        </div>

        <div id="complaint-blocks-container">
            <!-- Dynamic complaint blocks will be added here -->
        </div>

        <div id="no-complaints-selected" class="alert alert-info" style="display: none;">
            <i class="fas fa-info-circle"></i>
            <span>Please select at least one complaint to proceed.</span>
        </div>
    </div>
</div>

        <div class="mb-3">
            <label class="form-label">Remarks</label>
            <textarea class="form-control" name="remarks" rows="3" placeholder="Additional remarks or observations...">{{ log.remarks|default_if_none:'' }}</textarea>
        </div>

        

        <div class="mb-3">
            <label class="form-label">Voice Note</label><br>
            {% if log and log.voice_note %}
                <div class="existing-voice-note mb-3">
                    <small class="text-muted">Current voice note:</small>
                    <audio controls class="w-100">
                        <source src="{{ log.voice_note.url }}" type="audio/webm">
                        Your browser does not support the audio element.
                    </audio>
                </div>
            {% endif %}
            <div class="voice-recording-section">
                <div class="d-flex gap-2 mb-3">
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="startRecording()">
                        <i class="bi bi-mic"></i> Start Recording
                    </button>
                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="stopRecording()" disabled>
                        <i class="bi bi-stop"></i> Stop Recording
                    </button>
                </div>
                <audio id="player" controls class="w-100" style="display: none;"></audio>
                <input type="hidden" name="voice_blob" id="voice_blob">
            </div>
        </div>

        <div class="d-grid">
            <button type="submit" class="btn btn-success btn-lg">
                {% if log %}
                    <i class="bi bi-check-circle"></i> Update Service Log
                {% else %}
                    <i class="bi bi-plus-circle"></i> Create Service Log
                {% endif %}
            </button>
        </div>
    </form>
</div>

<!-- Customer Details Modal -->
<div class="modal fade" id="customerDetailsModal" tabindex="-1" aria-labelledby="customerDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content customer-details-modal">
            <div class="modal-header">
                <div class="customer-header">
                    <div class="customer-avatar">
                        <i class="fas fa-user-circle"></i>
                    </div>
                    <div class="customer-title">
                        <h5 class="modal-title" id="customerDetailsModalLabel">Customer Details</h5>
                        <span class="customer-name" id="modalCustomerName"></span>
                        <div class="customer-details">
                            <span class="customer-detail-item">
                                <i class="fas fa-id-card"></i>
                                <span id="modalCustomerCode"></span>
                            </span>
                            <span class="customer-detail-item">
                                <i class="fas fa-mobile-alt"></i>
                                <span id="modalCustomerMobile"></span>
                            </span>
                            <span class="direct-dealing-badge neon-badge" id="modalDirectDealing">
    <i class="fas fa-handshake"></i>
    <span class="badge-text">Direct Dealing</span>
</span>
                        </div>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="customerDetailsContent">
                    <div class="customer-tabs">
                        <ul class="nav nav-tabs" id="customerTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="details-tab" data-bs-toggle="tab" data-bs-target="#details" type="button" role="tab" aria-controls="details" aria-selected="true">
                                    <i class="fas fa-info-circle"></i>Details
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="service-history-tab" data-bs-toggle="tab" data-bs-target="#service-history" type="button" role="tab" aria-controls="service-history" aria-selected="false" onclick="loadServiceHistory()">
                                    <i class="fas fa-history"></i>Service History
                                </button>
                            </li>
                        </ul>
                    </div>
                    
                    <div class="tab-content" id="customerTabContent">
                        <!-- Details Tab -->
                        <div class="tab-pane fade show active" id="details" role="tabpanel" aria-labelledby="details-tab">
                            <div class="text-center loading-content">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2 text-muted">Loading customer details...</p>
                            </div>
                        </div>
                        
                        <!-- Service History Tab -->
                        <div class="tab-pane fade" id="service-history" role="tabpanel" aria-labelledby="service-history-tab">
                            <div class="text-center loading-content">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2 text-muted">Loading service history...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
// Global variable to store current customer data
let currentCustomerData = null;

document.addEventListener('DOMContentLoaded', function() {
    const customerCodeSelect = document.getElementById('customer_code');
    const customerNameInput = document.getElementById('customer_name');
    const submitButton = document.querySelector('button[type="submit"]');

    function validateCustomerSelection() {
        const customerCodeSelected = customerCodeSelect.value !== '';
        const customerNameEntered = customerNameInput.value.trim() !== '';
        const isValid = customerCodeSelected || customerNameEntered;

        if (!isValid) {
            alert('Please select a customer from the dropdown or enter a customer name manually.');
        }

        submitButton.disabled = !isValid;
    }

    customerCodeSelect.addEventListener('change', validateCustomerSelection);
    customerNameInput.addEventListener('input', validateCustomerSelection);

    // Initial validation check
    validateCustomerSelection();
});

let mediaRecorder;
let audioChunks = [];

// Complaint data from Django template
const complaintsData = {
    {% for c in complaints %}
    {{ c.id }}: "{{ c.description|escapejs }}",
    {% endfor %}
};

// Selected complaints with notes (for edit mode)
const selectedComplaintsData = {
    {% if selected_complaints %}
        {% for sc in selected_complaints %}
        {{ sc.complaint.id }}: "{{ sc.note|escapejs }}",
        {% endfor %}
    {% endif %}
};

function toggleComplaintNote(complaintId) {
    const checkbox = document.getElementById(`complaint_${complaintId}`);
    const noteSection = document.getElementById(`note_section_${complaintId}`);
    const textarea = noteSection.querySelector('textarea');
    
    if (checkbox.checked) {
        noteSection.style.display = 'block';
        textarea.focus();
    } else {
        noteSection.style.display = 'none';
        textarea.value = '';
    }
    
    updateComplaintSelectionStatus();
}

function updateComplaintSelectionStatus() {
    const checkboxes = document.querySelectorAll('.complaint-checkbox');
    const checkedBoxes = document.querySelectorAll('.complaint-checkbox:checked');
    const noComplaintsAlert = document.getElementById('no-complaints-selected');
    
    if (checkedBoxes.length === 0) {
        noComplaintsAlert.style.display = 'block';
    } else {
        noComplaintsAlert.style.display = 'none';
    }
}

// Initialize the form state on page load
document.addEventListener('DOMContentLoaded', function() {
    const complaintTypeSelect = document.getElementById('complaint_type');
    const complaintItems = document.querySelectorAll('.complaint-item-wrapper');
    
    complaintTypeSelect.addEventListener('change', function() {
        const selectedType = complaintTypeSelect.value;
        const container = document.getElementById('complaints-container');
        
        if (selectedType) {
            container.style.display = 'block';
            complaintItems.forEach(item => {
                const complaintType = item.getAttribute('data-complaint-type');
                item.style.display = (complaintType === selectedType) ? 'block' : 'none';
            });
        } else {
            container.style.display = 'none';
        }
    });

    // Show note sections for already selected complaints (edit mode)
    const checkboxes = document.querySelectorAll('.complaint-checkbox:checked');
    checkboxes.forEach(checkbox => {
        const complaintId = checkbox.value;
        const noteSection = document.getElementById(`note_section_${complaintId}`);
        if (noteSection) {
            noteSection.style.display = 'block';
        }
    });
    
    updateComplaintSelectionStatus();
});

function startRecording() {
    navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.start();
        audioChunks = [];

        // Update UI
        const startBtn = document.querySelector('[onclick="startRecording()"]');
        const stopBtn = document.querySelector('[onclick="stopRecording()"]');
        startBtn.disabled = true;
        stopBtn.disabled = false;
        startBtn.innerHTML = '<i class="bi bi-mic"></i> Recording...';

        mediaRecorder.addEventListener("dataavailable", event => {
            audioChunks.push(event.data);
        });

        mediaRecorder.addEventListener("stop", () => {
            const audioBlob = new Blob(audioChunks, { type: "audio/webm" });
            const audioUrl = URL.createObjectURL(audioBlob);
            const player = document.getElementById("player");
            player.src = audioUrl;
            player.style.display = 'block';

            const fileReader = new FileReader();
            fileReader.readAsDataURL(audioBlob);
            fileReader.onloadend = function () {
                document.getElementById("voice_blob").value = fileReader.result;
            };

            // Reset button states
            const startBtn = document.querySelector('[onclick="startRecording()"]');
            const stopBtn = document.querySelector('[onclick="stopRecording()"]');
            startBtn.disabled = false;
            stopBtn.disabled = true;
            startBtn.innerHTML = '<i class="bi bi-mic"></i> Start Recording';
        });
    }).catch(error => {
        alert("Microphone access denied or not supported.");
        console.error("Mic error:", error);
    });
}

function stopRecording() {
    if (mediaRecorder && mediaRecorder.state !== "inactive") {
        mediaRecorder.stop();
        // Stop all tracks to release microphone
        mediaRecorder.stream.getTracks().forEach(track => track.stop());
    }
}

// Updated function to show customer details in modal
// Updated function to redirect to customer details page
function showCustomerDetails(customerData) {
    // Encode customer data for URL
    const encodedData = encodeURIComponent(JSON.stringify(customerData));
    
    // Redirect to customer details page
    window.location.href = `/customer-details/?data=${encodedData}`;
}

// Function to load customer details in the details tab
function loadCustomerDetails(customerData) {
    const detailsTab = document.getElementById('details');
    
    // Calculate AG (Age from installation date to now)
    let agText = 'N/A';
    if (customerData.installationdate) {
        const installDate = new Date(customerData.installationdate);
        const today = new Date();

        let years = today.getFullYear() - installDate.getFullYear();
        let months = today.getMonth() - installDate.getMonth();

        if (months < 0) {
            years--;
            months += 12;
        }

        agText = `${years} yr${years !== 1 ? 's' : ''} ${months} month${months !== 1 ? 's' : ''}`;
    }

    // Format date to dd-mm-yyyy
    const formattedInstallDate = customerData.installationdate
        ? new Date(customerData.installationdate).toLocaleDateString('en-GB')
        : 'N/A';

    // Create AMC badge
    const amcBadge = customerData.amc 
        ? `<span class="badge-status badge-amc">${customerData.amc}</span>` 
        : 'N/A';
    
    // Create priority badge
    const priorityBadge = customerData.priority 
        ? `<span class="badge-status badge-priority">${customerData.priority}</span>` 
        : 'N/A';
    
    // Create license badge
    const licenseBadge = customerData.lictype 
        ? `<span class="badge-status badge-license">${customerData.lictype}</span>` 
        : 'N/A';

    detailsTab.innerHTML = `
        <div class="customer-details-content">
            <div class="customer-info-grid">
                <div class="customer-section">
                    <h6><i class="fas fa-user"></i> Personal Information</h6>
                    <div class="info-row">
                        <div class="info-label">Name:</div>
                        <div class="info-value highlight-value">${customerData.name || 'N/A'}</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">Mobile:</div>
                        <div class="info-value">${customerData.mobile || 'N/A'}</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">Account Code:</div>
                        <div class="info-value">${customerData.accountcode || 'N/A'}</div>
                    </div>
                </div>
                
                <div class="customer-section">
                    <h6><i class="fas fa-map-marker-alt"></i> Location Details</h6>
                    <div class="info-row">
                        <div class="info-label">Address:</div>
                        <div class="info-value">${customerData.address || 'N/A'}</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">Address 3:</div>
                        <div class="info-value">${customerData.address3 || 'N/A'}</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">District:</div>
                        <div class="info-value">${customerData.district || 'N/A'}</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">State:</div>
                        <div class="info-value">${customerData.state || 'N/A'}</div>
                    </div>
                </div>
                
                <div class="customer-section">
                    <h6><i class="fas fa-building"></i> Business Details</h6>
                    <div class="info-row">
                        <div class="info-label">Branch:</div>
                        <div class="info-value">${customerData.branch || 'N/A'}</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">Route:</div>
                        <div class="info-value">${customerData.route || 'N/A'}</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">Nature:</div>
                        <div class="info-value">${customerData.nature || 'N/A'}</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">Direct Dealing:</div>
                        <div class="info-value">${customerData.directdealing || 'N/A'}</div>
                    </div>
                </div>
                
                <div class="customer-section">
                    <h6><i class="fas fa-cogs"></i> Service Information</h6>
                    <div class="info-row">
                        <div class="info-label">Software:</div>
                        <div class="info-value">${customerData.software || 'N/A'}</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">Installation Date:</div>
                        <div class="info-value">${formattedInstallDate}</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">Age:</div>
                        <div class="info-value highlight-value">${agText}</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">License Type:</div>
                        <div class="info-value">${licenseBadge}</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">Clients:</div>
                        <div class="info-value">${customerData.clients || 'N/A'}</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">SP:</div>
                        <div class="info-value">${customerData.sp || 'N/A'}</div>
                    </div>
                </div>
                
                <div class="customer-section">
                    <h6><i class="fas fa-chart-line"></i> Additional Information</h6>
                    <div class="info-row">
                        <div class="info-label">AMC:</div>
                        <div class="info-value">${amcBadge}</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">AMC Amount:</div>
                        <div class="info-value">${customerData.amcamt || 'N/A'}</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">Priority:</div>
                        <div class="info-value">${priorityBadge}</div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// Function to load service history
// Function to load service history
// Function to load service history
function loadServiceHistory() {
    const serviceHistoryTab = document.getElementById('service-history');
    
    if (!currentCustomerData) {
        serviceHistoryTab.innerHTML = `
            <div class="no-service-history">
                <i class="fas fa-exclamation-circle"></i>
                <p>No customer data available</p>
            </div>
        `;
        return;
    } 

    // Show loading state
    serviceHistoryTab.innerHTML = `
        <div class="loading-tab">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading service history...</span>
            </div>
            <p class="mt-2 text-muted">Loading service history...</p>
        </div>
    `;

    // Get the base customer name (before any dash/address)
    const customerName = currentCustomerData.name.split('-')[0].trim();
    
    // Fetch service history from your Django backend
    fetch(`/api/service-history/?customer_name=${encodeURIComponent(customerName)}`)
        .then(response => {
            console.log('Response status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(serviceHistory => {
            console.log('Service history received:', serviceHistory);
            
            if (!Array.isArray(serviceHistory) || serviceHistory.length === 0) {
                serviceHistoryTab.innerHTML = `
                    <div class="no-service-history">
                        <i class="fas fa-history"></i>
                        <p>No previous service history found</p>
                        <small class="text-muted">This customer has no previous service logs</small>
                    </div>
                `;
                return;
            }

            let serviceHistoryHTML = `
                <div class="service-history-container">
                    <h6 class="mb-3">Previous Service Records (${serviceHistory.length})</h6>
            `;

            serviceHistory.forEach(log => {
                const serviceDate = log.service_date ? new Date(log.service_date).toLocaleDateString('en-GB') : 'Date not available';
                const complaints = log.complaints || [];
                const statusClass = getStatusClass(log.status);
                
                serviceHistoryHTML += `
                    <div class="service-history-item">
                        <div class="service-history-header">
                            <div class="service-history-basic-info">
                                <div class="service-history-ticket">Ticket: ${log.ticket_number || 'N/A'}</div>
                                <div class="service-history-meta">
                                    <span class="service-history-date">${serviceDate}</span>
                                    <span class="service-history-type">${log.complaint_type || 'N/A'}</span>
                                </div>
                            </div>
                            <span class="service-history-status ${statusClass}">${log.status || 'Pending'}</span>
                        </div>
                        
                        ${complaints.length > 0 ? `
                            <div class="service-history-complaints">
                                ${complaints.map(complaint => {
                                    const complaintStatusClass = getStatusClass(complaint.status);
                                    return `<span class="service-history-complaint">
                                        ${complaint.description}
                                        <span class="complaint-status ${complaintStatusClass}">${complaint.status || 'Pending'}</span>
                                        ${complaint.note ? `<br><small class="text-muted">Note: ${complaint.note}</small>` : ''}
                                    </span>`;
                                }).join('')}
                            </div>
                        ` : ''}
                        
                        ${log.remarks ? `
                            <div class="service-history-remarks">
                                <strong>Remarks:</strong> ${log.remarks}
                            </div>
                        ` : ''}
                        
                        <div class="service-history-footer">
                            <span class="service-history-technician">
                                <i class="fas fa-user"></i> ${log.assigned_person || 'Not assigned'}
                            </span>
                        </div>
                    </div>
                `;
            });

            serviceHistoryHTML += '</div>';
            serviceHistoryTab.innerHTML = serviceHistoryHTML;
        })
        .catch(error => {
            console.error('Error loading service history:', error);
            serviceHistoryTab.innerHTML = `
                <div class="no-service-history">
                    <i class="fas fa-exclamation-triangle"></i>
                    <p>Failed to load service history</p>
                    <small class="text-muted">Error: ${error.message}</small>
                    <br>
                    <small class="text-muted">Please check the console for more details</small>
                </div>
            `;
        });
}

// Add CSS for complaint status badges
const style = document.createElement('style');
style.textContent = `
    .complaint-status {
        padding: 0.15rem 0.4rem;
        border-radius: 8px;
        font-size: 0.65rem;
        font-weight: 600;
        margin-left: 0.5rem;
    }
        /* Service History Compact Styling */
.service-history-basic-info {
    flex: 1;
}

.service-history-meta {
    display: flex;
    gap: 15px;
    align-items: center;
    margin-top: 2px;
}

.service-history-date {
    color: #6c757d;
    font-size: 0.8rem;
    font-weight: 500;
}

.service-history-type {
    background: #e9ecef;
    padding: 0.2rem 0.6rem;
    border-radius: 12px;
    font-size: 0.75rem;
    color: #495057;
    font-weight: 500;
}

.service-history-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 0.5rem;
    gap: 10px;
}

.service-history-complaints {
    margin-bottom: 0.5rem;
}

.service-history-remarks {
    color: #495057;
    font-size: 0.85rem;
    margin-bottom: 0.5rem;
    line-height: 1.3;
}

.service-history-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.75rem;
    color: #6c757d;
    padding-top: 0.25rem;
    border-top: 1px solid #f1f3f4;
}

/* Reduce overall item padding */
.service-history-item {
    background: white;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 0.75rem;
    margin-bottom: 0.75rem;
    transition: all 0.3s ease;
}

.service-history-item:hover {
    border-color: #4f6df5;
    box-shadow: 0 2px 8px rgba(79, 109, 245, 0.1);
}

/* Complaint status styling */
.complaint-status {
    padding: 0.1rem 0.3rem;
    border-radius: 6px;
    font-size: 0.6rem;
    font-weight: 600;
    margin-left: 0.5rem;
}
`;
document.head.appendChild(style);
// Helper function to get status class
function getStatusClass(status) {
    if (!status) return 'status-pending';
    
    const statusLower = status.toLowerCase();
    if (statusLower.includes('complete') || statusLower.includes('resolved')) {
        return 'status-completed';
    } else if (statusLower.includes('progress')) {
        return 'status-in-progress';
    } else {
        return 'status-pending';
    }
}

// Reset tabs when modal is closed
document.getElementById('customerDetailsModal').addEventListener('hidden.bs.modal', function () {
    // Reset to details tab
    const detailsTab = document.getElementById('details-tab');
    const serviceHistoryTab = document.getElementById('service-history-tab');
    
    detailsTab.classList.add('active');
    serviceHistoryTab.classList.remove('active');
    
    const detailsContent = document.getElementById('details');
    const serviceHistoryContent = document.getElementById('service-history');
    
    detailsContent.classList.add('show', 'active');
    serviceHistoryContent.classList.remove('show', 'active');
    
    // Clear service history content
    serviceHistoryContent.innerHTML = `
        <div class="text-center loading-content">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2 text-muted">Loading service history...</p>
        </div>
    `;
});
</script>

<style>
/* Complaints Selection Styling */
.complaints-selection-container {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 20px;
    border: 1px solid #e9ecef;
}

.complaint-item-wrapper {
    background: white;
    border-radius: 8px;
    border: 2px solid #e9ecef;
    transition: all 0.3s ease;
    overflow: hidden;
}

.complaint-item-wrapper:hover {
    border-color: #0d6efd;
    box-shadow: 0 2px 8px rgba(13, 110, 253, 0.1);
}

.complaint-header {
    padding: 15px 20px;
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
}

.form-check-input.complaint-checkbox {
    width: 20px;
    height: 20px;
    margin-right: 12px;
    cursor: pointer;
    border: 2px solid #dee2e6;
    transition: all 0.2s ease;
}

.form-check-input.complaint-checkbox:checked {
    background-color: #0d6efd;
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

.complaint-label {
    font-weight: 500;
    color: #495057;
    cursor: pointer;
    font-size: 16px;
    line-height: 1.5;
    transition: color 0.2s ease;
}

.form-check-input.complaint-checkbox:checked + .complaint-label {
    color: #0d6efd;
    font-weight: 600;
}

.complaint-note-section {
    border-top: 1px solid #e9ecef;
    background: #f8f9fa;
    transition: all 0.3s ease;
}

.note-input-wrapper {
    padding: 20px;
}

.note-label {
    font-size: 14px;
    font-weight: 500;
    color: #6c757d;
    margin-bottom: 8px;
}

.note-textarea {
    border: 1px solid #dee2e6;
    border-radius: 6px;
    padding: 12px;
    font-size: 14px;
    line-height: 1.5;
    resize: vertical;
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
}

.note-textarea:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

/* Voice Recording Section */
.voice-recording-section {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 20px;
    border: 1px solid #e9ecef;
}

.existing-voice-note {
    background: #e3f2fd;
    border-radius: 6px;
    padding: 15px;
    border-left: 4px solid #2196f3;
}

/* Button Enhancements */
.btn-sm i {
    margin-right: 5px;
}

.btn-lg i {
    margin-right: 8px;
}

/* Alert Styling */
.alert-info {
    background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
    border: 1px solid #bee5eb;
    color: #0c5460;
    border-radius: 8px;
    padding: 15px;
}

.alert-info i {
    margin-right: 8px;
}

/* Form Control Enhancements */
.form-control, .form-select {
    border-radius: 6px;
    padding: 12px;
    font-size: 15px;
    transition: all 0.2s ease;
}

.form-control:focus, .form-select:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

/* Card Styling */
.card {
    border: none;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
}

/* Responsive Design */
@media (max-width: 768px) {
    .container {
        margin-top: 20px;
        padding: 10px;
    }
    
    .complaint-header {
        padding: 12px 15px;
    }
    
    .note-input-wrapper {
        padding: 15px;
    }
}
/* Larger dropdown for complaints */
.larger-dropdown {
    min-width: unset !important;
    max-width: none !important;
    width: 100% !important;
}

/* Ensure dropdown matches select width when open */
.select2-container--open .select2-dropdown {
    width: 100% !important;
    left: 0 !important;
}

.larger-dropdown .select2-results__options {
    max-height: 300px !important;
    font-size: 14px;
}

.larger-dropdown .select2-results__option {
    padding: 10px 12px !important;
    line-height: 1.4 !important;
    white-space: normal !important;
    min-height: 40px !important;
    display: flex !important;
    align-items: center !important;
}

/* Make the select2 container itself larger */
.complaint-block .select2-container {
    width: 100% !important;
}

.complaint-block .select2-selection--single {
    height: 45px !important;
    padding: 8px 12px !important;
    font-size: 14px !important;
}

.complaint-block .select2-selection__rendered {
    line-height: 28px !important;
    font-size: 14px !important;
}

.complaint-block .select2-selection__arrow {
    height: 43px !important;
}

/* Complaint summary label shown after selection */
.complaint-summary {
    display: none;
    font-weight: 700;
    color: #343a40;
    padding: 10px 12px;
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 6px;
    width: 100%;
}

.complaint-summary .badge-type {
    font-weight: 600;
    margin-left: 8px;
    background: #e9ecef;
    color: #495057;
    padding: 0.1rem 0.4rem;
    border-radius: 8px;
    font-size: 0.7rem;
}

.complaint-actions {
    display: flex;
    gap: 8px;
}
</style>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const customerSelect = document.getElementById('customer_code');
    const placeInput = document.getElementById('place');

    customerSelect.addEventListener('change', function () {
        const selectedOption = customerSelect.options[customerSelect.selectedIndex];
        const address = selectedOption.getAttribute('data-address') || '';
        placeInput.value = address;
    });
});
</script>
<script>
document.addEventListener("DOMContentLoaded", function () {
    const customerInput = document.getElementById("customer");
    const customerDropdown = document.getElementById("customerDropdown");
    const placeInput = document.getElementById("place");
    const newCustomerBtn = document.getElementById("newCustomerBtn");
    const newCustomerFields = document.getElementById("newCustomerFields");
    const newCustomerName = document.getElementById("new_customer_name");
    const newCustomerAddress = document.getElementById("new_customer_address");
    const viewCustomerBtn = document.getElementById("viewCustomerBtn");

    let isNewCustomer = false;
    let allCustomers = [];
    let selectedCustomerData = null;

    // Toggle between new customer and existing customer
    newCustomerBtn.addEventListener("click", function() {
        isNewCustomer = !isNewCustomer;
        
        if (isNewCustomer) {
            newCustomerBtn.textContent = "Select Existing";
            newCustomerBtn.classList.remove("btn-outline-secondary");
            newCustomerBtn.classList.add("btn-outline-primary");
            newCustomerFields.style.display = "block";
            customerDropdown.style.display = "none";
            customerInput.value = "";
            customerInput.placeholder = "Will use new customer details below";
            customerInput.readOnly = true;
            customerInput.required = false;
            newCustomerName.required = true;
            newCustomerAddress.required = true;
            viewCustomerBtn.disabled = true;  // Disable eye button for new customers
            
            // Add event listener to auto-fill place when new customer address changes
            newCustomerAddress.addEventListener("input", function() {
                placeInput.value = newCustomerAddress.value;
            });
        } else {
            newCustomerBtn.textContent = "New Customer";
            newCustomerBtn.classList.remove("btn-outline-primary");
            newCustomerBtn.classList.add("btn-outline-secondary");
            newCustomerFields.style.display = "none";
            customerInput.placeholder = "Search or type new customer";
            customerInput.readOnly = false;
            customerInput.required = true;
            newCustomerName.required = false;
            newCustomerAddress.required = false;
            
            // Remove the event listener when switching back to existing customer
            newCustomerAddress.removeEventListener("input", function() {
                placeInput.value = newCustomerAddress.value;
            });
        }
    });

    // View Customer Details Button Click Handler
    viewCustomerBtn.addEventListener("click", function() {
        if (selectedCustomerData) {
            showCustomerDetails(selectedCustomerData);
        }
    });

    // Fetch customers when the page loads
    fetch('/proxy/customers/')
        .then(response => response.json())
        .then(data => {
            allCustomers = data; // Store all customers data
            customerDropdown.innerHTML = ""; // Clear existing options

            // Add customer options with address data
            data.forEach(customer => {
                const option = document.createElement("div");
                option.classList.add("dropdown-item");
                const branchVal = customer.branch || customer.branch_name || '';
                // OLD: option.textContent = `${customer.name}${branchVal ? ' — ' + branchVal : ''}${customer.address ? ', ' + customer.address : ''}`;
                
                // NEW: Show branch at the end in brackets
                let displayText = customer.name;
                if (customer.address) {
                    displayText += ', ' + customer.address;
                }
                if (branchVal) {
                    displayText += ' [' + branchVal + ']';
                }
                option.textContent = displayText;
                
                option.setAttribute("data-address", customer.address);
                option.setAttribute("data-customer-code", customer.code);
                
                option.addEventListener("click", function () {
                    customerInput.value = customer.name;
                    placeInput.value = option.getAttribute("data-address");
                    customerDropdown.style.display = "none";
                    
                    selectedCustomerData = customer;
                    viewCustomerBtn.disabled = false;
                    showCustomerInfoBox(customer);
                });
                customerDropdown.appendChild(option);
            });
            });

            if (data.length === 0) {
                customerDropdown.innerHTML = '<p style="padding: 10px; margin: 0;">No customers found</p>';
            }
        })
        .catch(error => {
            console.error("Error loading customers:", error);
            customerDropdown.innerHTML = '<p style="padding: 10px; margin: 0;">Failed to load customers. You can add a new customer.</p>';
        });

    // Show dropdown on focus
    customerInput.addEventListener("focus", function () {
        if (!isNewCustomer) {
            customerDropdown.style.display = "block";
        }
    });

    // Hide dropdown when clicking outside
    document.addEventListener("click", function (e) {
        if (!customerInput.contains(e.target) && !customerDropdown.contains(e.target)) {
            customerDropdown.style.display = "none";
        }
    });

    // Filter customers as the user types
    customerInput.addEventListener("input", function () {
        if (isNewCustomer) return;
        
        const filter = customerInput.value.toLowerCase();
        const options = customerDropdown.querySelectorAll(".dropdown-item");
        let hasVisibleItem = false;

        // Reset selected customer data if input is cleared or changed
        if (selectedCustomerData && customerInput.value !== selectedCustomerData.name) {
            selectedCustomerData = null;
            viewCustomerBtn.disabled = true;
        }

        options.forEach(option => {
            if (option.textContent.toLowerCase().includes(filter)) {
                option.style.display = "block";
                hasVisibleItem = true;
            } else {
                option.style.display = "none";
            }
        });

        customerDropdown.style.display = hasVisibleItem ? "block" : "none";
    });

    // Auto-fill place when selecting from dropdown
    customerDropdown.addEventListener("click", function(e) {
        if (e.target.classList.contains("dropdown-item")) {
            placeInput.value = e.target.getAttribute("data-address");
        }
    });
});

// Function to filter complaints based on selected service type
function filterComplaints() {
    const serviceType = document.getElementById('service_type').value.toLowerCase();
    const complaintSelect = document.getElementById('complaint');
    
    Array.from(complaintSelect.options).forEach(option => {
        if (option.value === "") { // Keep the default "Select a complaint" option
            option.hidden = false;
            return;
        }
        const complaintType = option.getAttribute('data-type');
        const show = (complaintType === serviceType || complaintType === 'both');
        option.hidden = !show;
    });

    // Reset selection if current value is hidden
    if (complaintSelect.value && complaintSelect.options[complaintSelect.selectedIndex].hidden) {
        complaintSelect.value = "";
    }
}

// Initial filter on page load
filterComplaints();

// Add event listener for service type changes
document.getElementById('service_type').addEventListener('change', filterComplaints);

document.addEventListener("DOMContentLoaded", function () {
    const modeSelect = document.getElementById('mode_of_service');
    const phoneGroup = document.getElementById('phoneNumberGroup');
    const phoneInput = document.getElementById('phone_number');

    function togglePhoneField() {
        const isOnline = modeSelect.value === 'Online';
        phoneGroup.style.display = isOnline ? 'block' : 'none';
        phoneInput.required = isOnline;
    }

    modeSelect.addEventListener('change', togglePhoneField);
    togglePhoneField();  // Initial check on page load
});
</script>
<script>
    newCustomerBtn.addEventListener("click", function() {
    isNewCustomer = !isNewCustomer;
    
    if (isNewCustomer) {
        newCustomerBtn.textContent = "Select Existing";
        newCustomerBtn.classList.remove("btn-outline-secondary");
        newCustomerBtn.classList.add("btn-outline-primary");
        newCustomerFields.style.display = "block";
        customerDropdown.style.display = "none";
        customerInput.value = "";
        customerInput.placeholder = "Will use new customer details below";
        customerInput.readOnly = true;
        customerInput.required = false;
        newCustomerName.required = true;
        newCustomerAddress.required = true;
        viewCustomerBtn.disabled = true;  // Disable eye button for new customers
        
        // Show the "Customer Name (Manual Entry)" section
        document.querySelector('.new-customer-section').style.display = 'block';
        
        // Add event listener to auto-fill place when new customer address changes
        newCustomerAddress.addEventListener("input", function() {
            placeInput.value = newCustomerAddress.value;
        });
    } else {
        newCustomerBtn.textContent = "New Customer";
        newCustomerBtn.classList.remove("btn-outline-primary");
        newCustomerBtn.classList.add("btn-outline-secondary");
        newCustomerFields.style.display = "none";
        customerInput.placeholder = "Search or type new customer";
        customerInput.readOnly = false;
        customerInput.required = true;
        newCustomerName.required = false;
        newCustomerAddress.required = false;
        
        // Hide the "Customer Name (Manual Entry)" section
        document.querySelector('.new-customer-section').style.display = 'none';
        
        // Remove the event listener when switching back to existing customer
        newCustomerAddress.removeEventListener("input", function() {
            placeInput.value = newCustomerAddress.value;
        });
    }
});
</script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
    const newCustomerBtn = document.getElementById("newCustomerBtn");
    const customerInput = document.getElementById("customer");
    const customerNameInput = document.getElementById("customer_name");
    const newCustomerSection = document.querySelector('.new-customer-section');

    newCustomerBtn.addEventListener("click", function() {
        const isNewCustomer = newCustomerBtn.textContent === "New Customer";
        
        if (isNewCustomer) {
            newCustomerBtn.textContent = "Select Existing";
            newCustomerBtn.classList.remove("btn-outline-secondary");
            newCustomerBtn.classList.add("btn-outline-primary");
            customerInput.required = false;
            customerNameInput.required = true;
            newCustomerSection.style.display = 'block';
        } else {
            newCustomerBtn.textContent = "New Customer";
            newCustomerBtn.classList.remove("btn-outline-primary");
            newCustomerBtn.classList.add("btn-outline-secondary");
            customerInput.required = true;
            customerNameInput.required = false;
            newCustomerSection.style.display = 'none';
        }
    });
});
</script>
<script>
let complaintIndex = 0;
let currentComplaintType = '';
let selectedComplaintBlock = null;
let selectedSoftware = '';

// Build all complaints array from server for sorting/filtering - FIXED DATA STRUCTURE
const allComplaints = [
    {% for c in complaints %}
    {
        id: '{{ c.id }}',
        description: '{{ c.description|escapejs }}',
        type: '{{ c.complaint_type }}',
        // FIX: Store all software IDs as an array for M2M relationship
        software_ids: [{% for sw in c.software.all %}'{{ sw.id }}'{% if not forloop.last %},{% endif %}{% endfor %}]
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
];

// Helper: returns whether complaint c should be shown for currentComplaintType
function complaintMatchesType(complaintType) {
    return currentComplaintType === 'both' || currentComplaintType === complaintType;
}

// Helper: returns whether a complaint (object) matches both type & software filters - FIXED LOGIC
function complaintMatchesFilters(complaint) {
    // Type must match
    if (!complaintMatchesType(complaint.type)) return false;
    
    // Software filter: if no software selected, allow all; otherwise only complaints with matching software
    if (selectedSoftware && selectedSoftware !== '') {
        // Check if this complaint has the selected software in its software_ids array
        return complaint.software_ids.includes(selectedSoftware.toString());
    }
    return true;
}

// Add a complaint block
function addComplaintBlock(selectedId = '', noteText = '') {
    const container = document.getElementById('complaint-blocks-container');
    const idx = complaintIndex++;

    const block = document.createElement('div');
    block.className = 'complaint-block';
    block.dataset.index = idx;

    // Build complaint options from preloaded array, filter by type+software and sort alphabetically
    let complaintOptions = '<option value="">-- Select Complaint --</option>';
    const filteredSorted = allComplaints
        .filter(c => complaintMatchesFilters(c))
        .sort((a, b) => a.description.localeCompare(b.description));
    
    filteredSorted.forEach(c => {
        const selAttr = selectedId && selectedId.toString() === c.id.toString() ? 'selected' : '';
        complaintOptions += `<option value="${c.id}" ${selAttr}>${c.description} (${c.type.charAt(0).toUpperCase() + c.type.slice(1)})</option>`;
    });

    const complaintNumber = container.children.length + 1;
    block.innerHTML = `
        <div class="complaint-block-content">
            <div class="complaint-number">
                <i class="fas fa-clipboard-list"></i>
                Complaint ${complaintNumber}
            </div>
            <div class="complaint-select-wrapper">
                <select class="form-select complaint-select" name="complaints" onchange="updateComplaintSelection(this)" required>
                    ${complaintOptions}
                </select>
                <div class="complaint-summary" style="display:none;"></div>
            </div>
        </div>
    `;

    container.appendChild(block);

    // Add click event to select this block
    block.addEventListener('click', function() {
        selectComplaintBlock(block);
    });

    // Initialize select2 for the complaint select with larger dropdown
    const selEl = block.querySelector('.complaint-select');
    try { $(selEl).select2('destroy'); } catch (e) {}
    $(selEl).select2({
        placeholder: '-- Select Complaint --',
        allowClear: true,
        width: '100%',
        dropdownParent: $(block),
        dropdownCssClass: 'larger-dropdown'
    });

    // If selectedId provided (edit mode), programmatically set value and update summary
    if (selectedId) {
        setTimeout(() => {
            try {
                $(selEl).val(selectedId.toString()).trigger('change.select2');
            } catch (e) {
                selEl.value = selectedId;
                try { $(selEl).trigger('change'); } catch(e) {}
            }
            updateComplaintSelection(selEl);
        }, 50);
    }

    updateComplaintSelectionStatus();
    updateComplaintNumbers();
}

// Select a complaint block
function selectComplaintBlock(block) {
    // Remove selection from all blocks
    document.querySelectorAll('.complaint-block').forEach(b => {
        b.style.border = '2px solid #e9ecef';
    });
    
    // Highlight selected block
    block.style.border = '2px solid #0d6efd';
    selectedComplaintBlock = block;
    
    // Enable remove button
    const remBtn = document.getElementById('removeComplaintBtn');
    if (remBtn) remBtn.disabled = false;
}

// Remove the selected complaint block
function removeSelectedComplaint() {
    if (selectedComplaintBlock) {
        selectedComplaintBlock.remove();
        selectedComplaintBlock = null;
        const remBtn = document.getElementById('removeComplaintBtn');
        if (remBtn) remBtn.disabled = true;
        updateComplaintSelectionStatus();
        updateComplaintNumbers();
    }
}

// Update complaint numbers after add/remove
function updateComplaintNumbers() {
    const blocks = document.querySelectorAll('.complaint-block');
    blocks.forEach((block, index) => {
        const numberLabel = block.querySelector('.complaint-number');
        if (numberLabel) {
            numberLabel.innerHTML = `<i class="fas fa-clipboard-list"></i> Complaint ${index + 1}`;
        }
    });
}

// Called when a complaint select changes - FIXED FUNCTION NAME
function updateComplaintSelection(selectEl) {
    const block = selectEl.closest('.complaint-block');
    const selectedComplaintId = selectEl.value;

    if (selectedComplaintId) {
        const selectedText = $(selectEl).find('option:selected').text();
        const [namePart, typePartRaw] = selectedText.split(' (');
        const typePart = typePartRaw ? typePartRaw.replace(')', '') : '';
        const summaryEl = block.querySelector('.complaint-summary');
        summaryEl.innerHTML = `<strong>${namePart}</strong>${typePart ? ' <span class="badge-type">' + typePart + '</span>' : ''}`;
        summaryEl.style.display = 'block';
        try { $(selectEl).select2('close'); } catch(e) {}
        try { $(selectEl).next('.select2').hide(); } catch(e) {}
    } else {
        try { $(selectEl).val(null).trigger('change.select2'); } catch(e) {}
        try { $(selectEl).next('.select2').show(); } catch(e) {}
        const summaryEl = block.querySelector('.complaint-summary');
        if (summaryEl) {
            summaryEl.style.display = 'none';
            summaryEl.textContent = '';
        }
    }
}

// Show/hide the "no complaints selected" alert
function updateComplaintSelectionStatus() {
    const blocks = document.querySelectorAll('.complaint-block');
    const alertBox = document.getElementById('no-complaints-selected');
    if (!blocks || blocks.length === 0) {
        if (alertBox) alertBox.style.display = 'flex';
        const remBtn = document.getElementById('removeComplaintBtn');
        if (remBtn) remBtn.disabled = true;
    } else {
        if (alertBox) alertBox.style.display = 'none';
    }
}

// Refresh options for all complaint selects when complaint type or software changes
function updateComplaintOptions() {
    const selects = document.querySelectorAll('.complaint-select');
    selects.forEach(sel => {
        const currentValue = sel.value;
        let newOptions = '<option value="">-- Select Complaint --</option>';
        const filteredSorted = allComplaints
            .filter(c => complaintMatchesFilters(c))
            .sort((a, b) => a.description.localeCompare(b.description));
        
        filteredSorted.forEach(c => {
            const selAttr = currentValue && currentValue.toString() === c.id.toString() ? 'selected' : '';
            newOptions += `<option value="${c.id}" ${selAttr}>${c.description} (${c.type.charAt(0).toUpperCase() + c.type.slice(1)})</option>`;
        });

        try { $(sel).select2('destroy'); } catch(e) {}
        sel.innerHTML = newOptions;
        try {
            $(sel).select2({
                placeholder: '-- Select Complaint --',
                allowClear: true,
                width: '100%',
                dropdownParent: $(sel).closest('.complaint-block'),
                dropdownCssClass: 'larger-dropdown'
            });
        } catch(e) { /* ignore select2 init errors */ }

        // If currentValue is present but no longer matches filters, clear it
        if (currentValue) {
            let foundMatch = false;
            allComplaints.forEach(c => {
                if (c.id.toString() === currentValue.toString() && complaintMatchesFilters(c)) {
                    foundMatch = true;
                }
            });
            if (!foundMatch) {
                sel.value = '';
                try { $(sel).val(null).trigger('change.select2'); } catch(e) {}
                updateComplaintSelection(sel);
            }
        }
    });
}

// DOM ready initialization
document.addEventListener('DOMContentLoaded', function() {
    const complaintTypeSelect = document.getElementById('complaint_type');
    const complaintsContainer = document.getElementById('complaints-container');
    const blocksContainer = document.getElementById('complaint-blocks-container');
    const softwareSelect = document.getElementById('software_select');

    // Initialize currentComplaintType
    currentComplaintType = (complaintTypeSelect && complaintTypeSelect.value && complaintTypeSelect.value !== '') ? complaintTypeSelect.value : 'software';
    if (complaintTypeSelect) complaintTypeSelect.value = currentComplaintType;

    // Initialize selectedSoftware from select
    if (softwareSelect) {
        selectedSoftware = softwareSelect.value ? softwareSelect.value : '';
    }

    if (currentComplaintType) {
        if (complaintsContainer) complaintsContainer.style.display = 'block';
    }

    // Hook software select change to filter complaint options
    if (softwareSelect) {
        softwareSelect.addEventListener('change', function() {
            selectedSoftware = this.value ? this.value : '';
            console.log('Software changed to:', selectedSoftware, 'Filtered complaints:', allComplaints.filter(c => complaintMatchesFilters(c)).length);
            
            // Rebuild options for existing complaint selects
            updateComplaintOptions();
            
            // Check if there are any matching complaints
            const hasAnyOptions = allComplaints.some(c => complaintMatchesFilters(c));
            const addBtn = document.querySelector('.btn-add-complaint');
            
            if (addBtn) addBtn.disabled = !hasAnyOptions;
            
            const noComplaintsEl = document.getElementById('no-complaints-selected');
            if (!hasAnyOptions) {
                if (noComplaintsEl) noComplaintsEl.style.display = 'block';
                if (addBtn) addBtn.disabled = true;
            } else {
                if (noComplaintsEl) noComplaintsEl.style.display = 'none';
                if (addBtn) addBtn.disabled = false;
            }
        });
    }

    // complaint type change handling
    if (complaintTypeSelect) {
        complaintTypeSelect.addEventListener('change', function() {
            currentComplaintType = this.value;
            if (currentComplaintType) {
                if (complaintsContainer) complaintsContainer.style.display = 'block';
                updateComplaintOptions();
                if (blocksContainer.children.length === 0) {
                    // Check if there are matching complaints before adding a block
                    const hasAnyOptions = allComplaints.some(c => complaintMatchesFilters(c));
                    if (hasAnyOptions) {
                        addComplaintBlock();
                    }
                }
            } else {
                if (complaintsContainer) complaintsContainer.style.display = 'none';
                if (blocksContainer) blocksContainer.innerHTML = '';
                complaintIndex = 0;
                currentComplaintType = '';
                selectedComplaintBlock = null;
            }
            updateComplaintSelectionStatus();
        });
    }

    // If editing an existing log, prefill values
    {% if log and log.complaint_type %}
        currentComplaintType = '{{ log.complaint_type }}';
        if (complaintTypeSelect) complaintTypeSelect.value = currentComplaintType;
        if (document.getElementById('complaints-container')) document.getElementById('complaints-container').style.display = 'block';
        
        // Set software select value on load if element exists
        {% if log.software %}
            if (softwareSelect) {
                softwareSelect.value = '{{ log.software.id }}';
                selectedSoftware = '{{ log.software.id }}';
            }
        {% endif %}

        {% for sc in selected_complaints %}
            addComplaintBlock('{{ sc.complaint.id }}', `{{ sc.note|escapejs }}`);
        {% endfor %}
    {% else %}
        // default: add one block if none exist and complaints container is shown
        if (complaintsContainer && complaintsContainer.style.display !== 'none' && blocksContainer && blocksContainer.children.length === 0) {
            // but only if there is at least one complaint matching current filters
            const hasAnyOptions = allComplaints.some(c => complaintMatchesFilters(c));
            if (hasAnyOptions) {
                addComplaintBlock();
            } else {
                // show the no-complaints message
                const noComplaintsEl = document.getElementById('no-complaints-selected');
                if (noComplaintsEl) noComplaintsEl.style.display = 'block';
                const addBtn = document.querySelector('.btn-add-complaint');
                if (addBtn) addBtn.disabled = true;
            }
        }
    {% endif %}

    updateComplaintSelectionStatus();
});
</script>
<script>
// Function to show customer info box with data
function showCustomerInfoBox(customerData) {
    const infoBox = document.getElementById('customerInfoBox');

    // Calculate age from installation date (existing logic)
    let ageText = 'N/A';
    if (customerData.installationdate) {
        const installDate = new Date(customerData.installationdate);
        const today = new Date();
        let years = today.getFullYear() - installDate.getFullYear();
        let months = today.getMonth() - installDate.getMonth();
        if (months < 0) { years--; months += 12; }
        if (today.getDate() < installDate.getDate()) {
            months--;
            if (months < 0) { years--; months += 12; }
        }
        ageText = `${years} yr${years !== 1 ? 's' : ''} ${months} month${months !== 1 ? 's' : ''}`;
    }

    // Helper to set text safely
    function setText(id, text) {
        const el = document.getElementById(id);
        if (!el) return;
        el.textContent = text;
    }
    // Helper to set HTML (for badges), safe-guarding missing element
    function setHTML(id, html) {
        const el = document.getElementById(id);
        if (!el) return;
        el.innerHTML = html;
    }

    // Basic fields
    setText('infoCustomerName', customerData.name || 'N/A');
    setText('infoSoftware', customerData.software || 'N/A');
    setText('infoAge', ageText);
    // License type will be replaced below with mapped label
    // AMC will be replaced below with mapped label
    setText('infoClients', customerData.clients || 'N/A');
    setText('infoSP', customerData.sp || 'N/A');
    setText('infoBranch', customerData.branch || 'N/A');
    setText('infoNature', customerData.nature || 'N/A');

    // ----- AMC mapping -----
    // customerData.amc may be 'A', 'F', 'S' or other
    const amcRaw = (customerData.amc || '').toString().trim().toUpperCase();
    let amcLabel = 'N/A';
    if (amcRaw === 'A') amcLabel = 'SUC';
    else if (amcRaw === 'F') amcLabel = 'FREE';
    else if (amcRaw === 'S') amcLabel = 'SERVICE CHARGE';
    else if (amcRaw) amcLabel = amcRaw;

    // Show as a badge-like element (uses your existing .info-badge style)
    setHTML('infoAMC', `<span class="info-badge">${amcLabel}</span>`);

    // ----- License type mapping -----
    const licRaw = (customerData.lictype || '').toString().trim().toUpperCase();
    let licLabel = 'N/A';
    if (licRaw === 'E') licLabel = 'Enterprises';
    else if (licRaw === 'P') licLabel = 'Professional';
    else if (licRaw) licLabel = licRaw;

    // Set license display (keeps previous style used for license)
    setHTML('infoLicenseType', `<span class="info-badge">${licLabel}</span>`);

    // Optionally update a dedicated "code" field or other UI elements if you use them:
    // e.g. setText('infoCode', (customerData.code || 'N/A'));

    // Also update any modal code display if present
    const modalCode = document.getElementById('modalCustomerCode');
    if (modalCode) {
        const rawCode = customerData.code || 'N/A';
        modalCode.textContent = `${rawCode} — AMC: ${amcLabel} — License: ${licLabel}`;
    }

    // Finally show the info box
    if (infoBox) infoBox.classList.add('show');

    // debug: uncomment to log
    // console.log('Customer Info shown:', { code: customerData.code, amc: amcRaw, amcLabel, licRaw, licLabel });
}

// Function to close customer info box
function closeCustomerInfoBox() {
    const infoBox = document.getElementById('customerInfoBox');
    infoBox.classList.remove('show');
}
document.addEventListener("DOMContentLoaded", function () {
    const customerInput = document.getElementById("customer");
    const customerDropdown = document.getElementById("customerDropdown");
    const placeInput = document.getElementById("place");
    const newCustomerBtn = document.getElementById("newCustomerBtn");
    const newCustomerFields = document.getElementById("newCustomerFields");
    const newCustomerName = document.getElementById("new_customer_name");
    const newCustomerAddress = document.getElementById("new_customer_address");
    const viewCustomerBtn = document.getElementById("viewCustomerBtn");

    let isNewCustomer = false;
    let allCustomers = [];
    let selectedCustomerData = null;

    // Toggle between new customer and existing customer
    newCustomerBtn.addEventListener("click", function() {
        isNewCustomer = !isNewCustomer;
        
        if (isNewCustomer) {
            newCustomerBtn.textContent = "Select Existing";
            newCustomerBtn.classList.remove("btn-outline-secondary");
            newCustomerBtn.classList.add("btn-outline-primary");
            newCustomerFields.style.display = "block";
            customerDropdown.style.display = "none";
            customerInput.value = "";
            customerInput.placeholder = "Will use new customer details below";
            customerInput.readOnly = true;
            customerInput.required = false;
            newCustomerName.required = true;
            newCustomerAddress.required = true;
            viewCustomerBtn.disabled = true;
            
            // Show the "Customer Name (Manual Entry)" section
            document.querySelector('.new-customer-section').style.display = 'block';
            
            // Add event listener to auto-fill place when new customer address changes
            newCustomerAddress.addEventListener("input", function() {
                placeInput.value = newCustomerAddress.value;
            });
        } else {
            newCustomerBtn.textContent = "New Customer";
            newCustomerBtn.classList.remove("btn-outline-primary");
            newCustomerBtn.classList.add("btn-outline-secondary");
            newCustomerFields.style.display = "none";
            customerInput.placeholder = "Search or type new customer";
            customerInput.readOnly = false;
            customerInput.required = true;
            newCustomerName.required = false;
            newCustomerAddress.required = false;
            
            // Hide the "Customer Name (Manual Entry)" section
            document.querySelector('.new-customer-section').style.display = 'none';
            
            // Remove the event listener when switching back to existing customer
            newCustomerAddress.removeEventListener("input", function() {
                placeInput.value = newCustomerAddress.value;
            });
        }
    });

    // View Customer Details Button Click Handler
    viewCustomerBtn.addEventListener("click", function() {
        if (selectedCustomerData) {
            showCustomerDetails(selectedCustomerData);
        }
    });

    // Fetch customers when the page loads
    fetch('/proxy/customers/')
        .then(response => response.json())
        .then(data => {
            allCustomers = data; // Store all customers data
            customerDropdown.innerHTML = ""; // Clear existing options

            // Add customer options with address data - BRANCH AT THE END IN BRACKETS
            data.forEach(customer => {
                const option = document.createElement("div");
                option.classList.add("dropdown-item");
                const branchVal = customer.branch || customer.branch_name || '';
                
                // Build display text: Name, Address [Branch]
                let displayText = customer.name;
                if (customer.address) {
                    displayText += ', ' + customer.address;
                }
                if (branchVal) {
                    displayText += ' [' + branchVal + ']';
                }
                option.textContent = displayText;
                
                option.setAttribute("data-address", customer.address);
                option.setAttribute("data-customer-code", customer.code);
                option.addEventListener("click", function () {
                    customerInput.value = customer.name;
                    placeInput.value = option.getAttribute("data-address");
                    customerDropdown.style.display = "none";
                    
                    // Store selected customer data and enable eye button
                    selectedCustomerData = customer;
                    viewCustomerBtn.disabled = false;
                });
                customerDropdown.appendChild(option);
            });

            if (data.length === 0) {
                customerDropdown.innerHTML = '<p style="padding: 10px; margin: 0;">No customers found</p>';
            }
        })
        .catch(error => {
            console.error("Error loading customers:", error);
            customerDropdown.innerHTML = '<p style="padding: 10px; margin: 0;">Failed to load customers. You can add a new customer.</p>';
        });

    // Show dropdown on focus
    customerInput.addEventListener("focus", function () {
        if (!isNewCustomer) {
            customerDropdown.style.display = "block";
        }
    });

    // Hide dropdown when clicking outside
    document.addEventListener("click", function (e) {
        if (!customerInput.contains(e.target) && !customerDropdown.contains(e.target)) {
            customerDropdown.style.display = "none";
        }
    });

    // Filter customers as the user types
    customerInput.addEventListener("input", function () {
        if (isNewCustomer) return;
        
        const filter = customerInput.value.toLowerCase();
        const options = customerDropdown.querySelectorAll(".dropdown-item");
        let hasVisibleItem = false;

        // Reset selected customer data if input is cleared or changed
        if (selectedCustomerData && customerInput.value !== selectedCustomerData.name) {
            selectedCustomerData = null;
            viewCustomerBtn.disabled = true;
        }

        options.forEach(option => {
            if (option.textContent.toLowerCase().includes(filter)) {
                option.style.display = "block";
                hasVisibleItem = true;
            } else {
                option.style.display = "none";
            }
        });

        customerDropdown.style.display = hasVisibleItem ? "block" : "none";
    });

    // Auto-fill place when selecting from dropdown
    customerDropdown.addEventListener("click", function(e) {
        if (e.target.classList.contains("dropdown-item")) {
            placeInput.value = e.target.getAttribute("data-address");
        }
    });
});

// Second instance - Customer info box integration
document.addEventListener('DOMContentLoaded', function () {
    const customerInput = document.getElementById('customer');
    const customerDropdown = document.getElementById('customerDropdown');
    const placeInput = document.getElementById('place');
    const newCustomerBtn = document.getElementById('newCustomerBtn');
    const viewCustomerBtn = document.getElementById('viewCustomerBtn');
    const newCustomerSection = document.querySelector('.new-customer-section');

    if (!customerInput || !customerDropdown) {
        // Required DOM elements are missing — do nothing (fail-safe)
        console.warn('Customer input or dropdown not found in DOM.');
        return;
    }

    let isNewCustomer = false;
    let selectedCustomerData = null;

    // Fetch customers once
    fetch('/proxy/customers/')
        .then(response => {
            if (!response.ok) throw new Error('Network response not ok');
            return response.json();
        })
        .then(data => {
            customerDropdown.innerHTML = ''; // clear existing
            if (!Array.isArray(data) || data.length === 0) {
                customerDropdown.innerHTML = '<div class="dropdown-item">No customers found</div>';
                return;
            }

            data.forEach(customer => {
                const option = document.createElement('div');
                option.className = 'dropdown-item';
                const branchVal = customer.branch || customer.branch_name || '';
                let displayText = customer.name || '';
                if (customer.address) displayText += ', ' + customer.address;
                if (branchVal) displayText += ' [' + branchVal + ']';
                option.textContent = displayText;

                option.dataset.address = customer.address || '';
                option.dataset.code = customer.code || '';

                option.addEventListener('click', function () {
                    // set input & place
                    customerInput.value = customer.name || '';
                    placeInput && (placeInput.value = option.dataset.address || '');
                    customerDropdown.style.display = 'none';

                    // set selected data and enable eye button
                    selectedCustomerData = customer;
                    if (viewCustomerBtn) viewCustomerBtn.disabled = false;

                    // show side info box if function exists
                    try { if (typeof showCustomerInfoBox === 'function') showCustomerInfoBox(customer); } catch(e) {}
                });

                customerDropdown.appendChild(option);
            });
        })
        .catch(err => {
            console.error('Failed to load customers:', err);
            customerDropdown.innerHTML = '<div class="dropdown-item">Failed to load customers</div>';
        });

    // Show dropdown on focus (if not creating a new customer)
    customerInput.addEventListener('focus', function () {
        if (!isNewCustomer) customerDropdown.style.display = 'block';
    });

    // Hide dropdown when clicking outside
    document.addEventListener('click', function (e) {
        if (!customerInput.contains(e.target) && !customerDropdown.contains(e.target)) {
            customerDropdown.style.display = 'none';
        }
    });

    // Filter dropdown items as the user types
    customerInput.addEventListener('input', function () {
        if (isNewCustomer) return;

        const filter = customerInput.value.toLowerCase();
        const items = customerDropdown.querySelectorAll('.dropdown-item');
        let anyVisible = false;

        // if user changed text, reset selection
        if (selectedCustomerData && customerInput.value !== (selectedCustomerData.name || '')) {
            selectedCustomerData = null;
            if (viewCustomerBtn) viewCustomerBtn.disabled = true;
            try { if (typeof closeCustomerInfoBox === 'function') closeCustomerInfoBox(); } catch(e) {}
        }

        items.forEach(it => {
            const show = it.textContent.toLowerCase().includes(filter);
            it.style.display = show ? 'block' : 'none';
            if (show) anyVisible = true;
        });
        customerDropdown.style.display = anyVisible ? 'block' : 'none';
    });

    // New Customer toggle
    if (newCustomerBtn) {
        newCustomerBtn.addEventListener('click', function () {
            isNewCustomer = !isNewCustomer;
            if (isNewCustomer) {
                newCustomerBtn.textContent = 'Select Existing';
                customerInput.placeholder = 'Will use new customer details below';
                customerInput.readOnly = true;
                customerDropdown.style.display = 'none';
                if (newCustomerSection) newCustomerSection.style.display = 'block';
                // disable view button for new entries
                if (viewCustomerBtn) viewCustomerBtn.disabled = true;
            } else {
                newCustomerBtn.textContent = 'New Customer';
                customerInput.placeholder = 'Search or type new customer';
                customerInput.readOnly = false;
                if (newCustomerSection) newCustomerSection.style.display = 'none';
            }
        });
    }

    // Eye (view) button: redirect to customer_details view with encoded JSON
    if (viewCustomerBtn) {
        viewCustomerBtn.addEventListener('click', function () {
            if (!selectedCustomerData) {
                alert('Please select a customer first.');
                return;
            }
            try {
                const json = JSON.stringify(selectedCustomerData);
                const encoded = encodeURIComponent(json);
                // backend view expects GET param 'data' with JSON string
                window.location.href = '/customer-details/?data=' + encoded;
            } catch (err) {
                console.error('Failed to encode customer data', err);
                alert('Unable to open customer details (check console).');
            }
        });
    }
});
</script>

{% endblock %}