{% extends 'base.html' %}

{% block content %}
<style>
    @media (max-width: 768px) {
        .buttons{
            display: flex;
            margin-top: 2%;

        }
        .BreakIn{
            font-size: 5px;
        }
        }
</style>
<div style="width: 100%; margin: auto;padding-top: 50px;">
    <div style="margin-bottom: 20px;" class="buttons"><button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#leaveRequestModal">
        Leave Request 
    </button>
    <button class="btn btn-info ms-2" onclick="loadUserLeaveRequests()">
        <i class="fas fa-list"></i> View My Leave Requests
    </button>
   </div>
   <div style="margin-bottom: 20px;" class="buttons">
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#lateRequestModal">
        Late Request 
    </button>
    <button class="btn btn-info ms-2" onclick="loadLateRequests()">
        <i class="fas fa-list"></i> View My Late Requests
    </button>
</div>
<div style="margin-bottom: 20px;" class="buttons">
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#earlyRequestModal">
        Early Request 
    </button>
    <button class="btn btn-info ms-2" onclick="loadEarlyRequests()">
        <i class="fas fa-list"></i> View My Early Requests
    </button>
    
</div>
<div style="margin-bottom: 20px;">
    {% if ongoing_task %}
    <div class="d-flex justify-content-center mt-3">
        <button class="btn btn-danger btn-sm" onclick="stopTask({{ ongoing_task.id }})">
            <i class="fa fa-stop"></i> Stop Daily Task
        </button>
    </div>
{% endif %}
</div>

    <div class="">
        <!-- Punch In/Out Card -->
        <div class="card shadow mb-4" style="overflow: hidden;">
            <div class="card-header text-white" style="padding-top: 20px;padding-bottom: 20px;background: linear-gradient(90deg, rgba(2,0,36,1) 0%, rgba(9,9,121,1) 35%, rgb(0, 145, 174) 100%);">
                <h3 class="mb-0" style="text-align: center;">Daily Attendance</h3>
            </div>
            <div class="card-body" style="background: linear-gradient(90deg, rgba(2,0,36,1) 0%, rgba(9,9,121,1) 35%, rgb(0, 145, 174) 100%);overflow: hidden;">
                <div class="row" style="overflow: hidden;">
                    <div class="col-md-6" style="overflow: hidden;">
                        <div class="card mb-3" style="overflow: hidden;">
                            <div class="card-body" style="border-radius: 15px; overflow: hidden; background-color: #ffffff19;backdrop-filter: blur(10px);border: 1px solid rgba(255, 255, 255, 0.603);">
                                <h5 class="" style="padding-left: 20px; padding-right: 20px; padding-top: 10px; padding-bottom: 10px;border-radius: 15px;border: #c2c2c2;background: linear-gradient(90deg, rgba(2,0,36,1) 0%, rgba(9,9,121,1) 35%, rgba(0,212,255,1) 100%);color: white;font-size: 15px; display: flex;justify-content: space-between;align-items: center;">Today's Status <span style="color: ;"><svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3"><path d="M441-82q-76-8-141.5-41.5t-114.5-87Q136-264 108-333T80-480q0-157 104.5-270T441-878v81q-119 15-200 104.5T160-480q0 123 81 212.5T441-163v81Zm0-198v-247L337-423l-56-57 200-200 200 200-57 56-103-103v247h-80Zm80 198v-81q44-5 83.5-22t72.5-43l57 58q-45 36-99 59T521-82Zm155-650q-33-26-72-43t-83-22v-81q60 6 114 29t99 59l-58 58Zm114 505-57-57q26-33 43-72.5t22-83.5h81q-6 60-29.5 114T790-227Zm8-293q-5-44-22-83.5T733-676l57-57q36 45 59.5 99T879-520h-81Z"/></svg></span></h5>
                                <div id="punchStatus" style="color: white;">
                                    <p class="mb-2" style="display: flex;justify-content: space-between;align-items: center;">Punch In: <span id="punchInTime" style="color: white;">Not punched in yet</span></p>
                                    <p class="mb-2" style="display: flex;justify-content: space-between;align-items: center;">Punch In Location: <a id="punchInLocationLink" style="color: white;" href="#" target="_blank">
                                            <span id="punchInLocation" style="color: white;">Not punched in yet</span>
                                        </a></p>
                                    <p class="mb-2" style="display: flex;justify-content: space-between;align-items: center;">Punch Out: <span style="color: white;" id="punchOutTime">Not punched out yet</span></p>
                                    <p class="mb-2" style="display: flex;justify-content: space-between;align-items: center;">Punch Out Location: <a style="color: white;" id="punchOutLocationLink" href="#" target="_blank"><span id="punchOutLocation" style="color: white;">Not punched out yet</span></a>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex justify-content-center align-items-center h-100">
                            <button class="btn btn-success btn-sm md:btn-lg mx-2" onclick="handlePunch('in')" id="punchInBtn" style="border: 1px solid #ffffff;">
                                <i class="fas fa-sign-in-alt"></i><span style="white-space: nowrap;"> Punch In </span>
                            </button>
                            {% if not ongoing_task %}
                            <button class="btn btn-danger btn-sm md:btn-lg mx-2" onclick="handlePunch('out')" id="punchOutBtn" style="border: 1px solid #fff;">
                                <i class="fas fa-sign-out-alt"></i> <span style="white-space: nowrap;"> Punch Out
                                </span>
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="card shadow mb-4" style="overflow: hidden;">
    <div class="card-header text-white" style="padding-top: 20px;padding-bottom: 20px;background: linear-gradient(90deg, rgba(2,0,36,1) 0%, rgba(9,9,121,1) 35%, rgb(0, 145, 174) 100%);">
        <h3 class="mb-0" style="text-align: center;">Break Time Management</h3>
    </div>
    <div class="card-body" style="background: linear-gradient(90deg, rgba(2,0,36,1) 0%, rgba(9,9,121,1) 35%, rgb(0, 145, 174) 100%);overflow: hidden;">
        <div class="row" style="overflow: hidden;">
            <div class="col-md-6" style="overflow: hidden;">
                <div class="card mb-3" style="overflow: hidden;">
                    <div class="card-body" style="border-radius: 15px; overflow: hidden; background-color: #ffffff19;backdrop-filter: blur(10px);border: 1px solid rgba(255, 255, 255, 0.603);">
                        <h5 class="" style="padding-left: 20px; padding-right: 20px; padding-top: 10px; padding-bottom: 10px;border-radius: 15px;border: #c2c2c2;background: linear-gradient(90deg, rgba(2,0,36,1) 0%, rgba(9,9,121,1) 35%, rgba(0,212,255,1) 100%);color: white;font-size: 15px; display: flex;justify-content: space-between;align-items: center;">Today's Break Status <span style="color: ;"><svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3"><path d="M441-82q-76-8-141.5-41.5t-114.5-87Q136-264 108-333T80-480q0-157 104.5-270T441-878v81q-119 15-200 104.5T160-480q0 123 81 212.5T441-163v81Zm0-198v-247L337-423l-56-57 200-200 200 200-57 56-103-103v247h-80Zm80 198v-81q44-5 83.5-22t72.5-43l57 58q-45 36-99 59T521-82Zm155-650q-33-26-72-43t-83-22v-81q60 6 114 29t99 59l-58 58Zm114 505-57-57q26-33 43-72.5t22-83.5h81q-6 60-29.5 114T790-227Zm8-293q-5-44-22-83.5T733-676l57-57q36 45 59.5 99T879-520h-81Z"/></svg></span></h5>
                        <div id="breakStatus" style="color: white;">
                            <p class="mb-2 BreakIn" style="display: flex;justify-content: center;align-items: center;gap: 5px;text-wrap: wrap;white-space: wrap;">Break Punch In: <span id="breakPunchInTime" style="color: white;">Not punched in yet</span></p>
                            <p class="mb-2" style="display: flex;justify-content: space-between;align-items: center;">Break Punch Out: <span style="color: white;" id="breakPunchOutTime">Not punched out yet</span></p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="d-flex justify-content-center align-items-center h-100">
                    <button class="btn btn-success  md:btn-lg mx-2" onclick="handleBreakPunch('in')" id="breakPunchInBtn" style="border: 1px solid #ffffff;">
                        <i class="fas fa-sign-in-alt"></i><span style="white-space: nowrap;"> Break <br> Punch In </span>
                    </button>
                    <button class="btn btn-danger btn-xs md:btn-lg mx-2" onclick="handleBreakPunch('out')" id="breakPunchOutBtn" style="border: 1px solid #fff;">
                        <i class="fas fa-sign-out-alt"></i> <span style="white-space: nowrap;"> Break <br> Punch Out
                        </span>
                    </button>
                    

                </div>
            </div>
        </div>
    </div>
</div>

        <!-- Monthly Attendance View -->
        <div class="card shadow" style="overflow: hidden;">
            <div class="card-header text-white" style="padding-top: 20px;padding-bottom: 20px;background: linear-gradient(90deg, rgba(2,0,36,1) 0%, rgba(9,9,121,1) 35%, rgb(0, 145, 174) 100%);">
                <div class="d-md-flex justify-content-between align-items-center">
                    <h3 class="mb-0" style="white-space: nowrap;">My Attendance Records</h3>
                    <input type="month" class="form-control" id="monthFilter" style="width: 200px;" 
                           value="{{ current_month|default:'' }}">
                </div>
                
            </div>
            <div class="card-body" style="background: linear-gradient(90deg, rgba(2,0,36,1) 0%, rgba(9,9,121,1) 35%, rgb(0, 145, 174) 100%);overflow: hidden;">
                <!-- Legend Section -->
                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <div class="d-flex gap-4 flex-wrap">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-star text-success me-2"></i>
                                <span style="color: white;">Full Day</span>
                            </div>
                            <div class="d-flex align-items-center">
                                <i class="fas fa-star text-primary me-2"></i>
                                <span style="color: white;">Verified Full Day</span>
                            </div>
                            <div class="d-flex align-items-center">
                                <i class="fas fa-star-half-alt text-success me-2"></i>
                                <span style="color: white;">Half Day</span>
                            </div>
                            <div class="d-flex align-items-center">
                                <i class="fas fa-star-half-alt text-primary me-2"></i>
                                <span style="color: white;">Verified Half Day</span>
                            </div>
                            <div class="d-flex align-items-center">
                                <i class="fas fa-star text-danger me-2"></i>
                                <span style="color: white;">Leave</span>
                            </div>
                            <div class="d-flex align-items-center">
                                <i class="fas fa-star text-warning me-2"></i>
                                <span style="color: white;">Holiday</span> 
                            </div>
                            <div class="d-flex align-items-center">
                                <i class="fas fa-star text-secondary me-2"></i>
                                <span style="color: white;">Not Marked</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Attendance Table -->
                <div class="table-responsive">
                    <table class="table table-bordered" style="background-color: white;">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Day</th>
                                <th>Status</th>
                                <th>Punch In</th>
                                <th>Punch Out</th>
                            </tr>
                        </thead>
                        <tbody id="attendanceBody">
                            <!-- Will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>



<!-- Update the leave request modal -->
<div class="modal fade" id="leaveRequestModal" tabindex="-1" aria-labelledby="leaveRequestModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="leaveRequestModalLabel">Request Leave</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="leaveRequestForm">
    <div class="mb-3">
        <label for="startDate" class="form-label">Start Date</label>
        <input type="date" class="form-control" id="startDate" required>
    </div>
    <div class="mb-3">
        <label for="endDate" class="form-label">End Date</label>
        <input type="date" class="form-control" id="endDate" required>
    </div>
    <div class="mb-3">
        <label for="leaveType" class="form-label">Leave Type</label>
        <select class="form-select" id="leaveType" required>
            <option value="full_day">Full Day</option>
            <option value="half_day">Half Day</option>
        </select>
    </div>
    <div class="mb-3">
        <label for="reason" class="form-label">Reason</label>
        <select class="form-select" id="reason" required>
            <option value="Medical Appointment">Medical Appointment</option>
            <option value="Bereavement Leave">Bereavement Leave</option>
            <option value="Family Event">Family Event</option>
            <option value="Health Emergency">Health Emergency</option>
            <option value="Dependent Care">Dependent Care</option>
        </select>
    </div>
</form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="submitLeaveRequest()">Submit Request</button>
            </div>
        </div>
    </div>
</div>

<!-- Update the view leave requests modal -->
<div class="modal fade" id="viewLeaveRequestsModal" tabindex="-1" aria-labelledby="viewLeaveRequestsModalLabel" aria-hidden="true">
    <div class="modal-dialog" style="max-width: 1200px;width: 100%;margin: auto;">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="viewLeaveRequestsModalLabel">My Leave Requests</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-2 p-md-10" style="margin: auto;width: 100%;">
                <div class="d-md-flex justify-content-between mb-3">
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-sm btn-outline-primary filter-btn active" style="font-size: 12px;" data-status="all">All</button>
                        <button type="button" class="btn btn-sm btn-outline-primary filter-btn" style="font-size: 12px;" data-status="pending">Pending</button>
                        <button type="button" class="btn btn-sm btn-outline-primary filter-btn" style="font-size: 12px;" data-status="approved">Approved</button>
                        <button type="button" class="btn btn-sm btn-outline-primary filter-btn" style="font-size: 12px;" data-status="rejected">Rejected</button>
                    </div>
                    <div class="d-flex mt-2 mt-md-0">
                        <button id="prevLeaveRequests" class="btn btn-sm btn-outline-primary" disabled>Previous</button>
                        <span id="leaveRequestsPaginationInfo" class="mx-2">Showing 1-10</span>
                        <button id="nextLeaveRequests" class="btn btn-sm btn-outline-primary">Next</button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Start Date</th>
                                <th>End Date</th>
                                <th>Leave Type</th>
                                <th>Reason</th>
                                <th>Status</th>
                                <th>Requested On</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="userLeaveRequestsTableBody">
                            <!-- Leave requests will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Late Request Modal -->
<div class="modal fade" id="lateRequestModal" tabindex="-1" aria-labelledby="lateRequestModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="lateRequestModalLabel">Request Late Arrival</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <form id="lateRequestForm">
    <div class="mb-3">
        <label for="lateDate" class="form-label">Date</label>
        <input type="date" class="form-control" id="lateDate" required readonly>
    </div>
    <div class="mb-3">
        <label for="delayTime" class="form-label">Enter delay time (e.g., 10 minutes)</label>
        <input type="text" class="form-control" id="delayTime" required placeholder="e.g., 10 minutes">
    </div>
    <div class="mb-3">
        <label for="lateReason" class="form-label">Reason</label>
        <select class="form-select" id="lateReason" required>
            <option value="Health Emergency">Health Emergency</option>
            <option value="Dependent Care">Dependent Care</option>
            <option value="Medical Appointment">Medical Appointment</option>
            <option value="Bereavement">Bereavement</option>
            <option value="Transportation Issues">Transportation Issues</option>
            <option value="Accident">Accident</option>
        </select>
    </div>
</form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="submitLateRequest()">Submit Request</button>
            </div>
        </div>
    </div>
</div>

<!-- View Late Requests Modal -->
<div class="modal fade" id="viewLateRequestsModal" tabindex="-1" aria-labelledby="viewLateRequestsModalLabel" aria-hidden="true">
    <div class="modal-dialog" style="max-width: 1200px;width: 100%;margin: auto;">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="viewLateRequestsModalLabel">My Late Requests</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-2 p-md-10" style="margin: auto;width: 100%;">
                <div class="d-md-flex justify-content-between mb-3">
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-sm btn-outline-primary filter-btn active" style="font-size: 12px;" data-status="all">All</button>
                        <button type="button" class="btn btn-sm btn-outline-primary filter-btn" style="font-size: 12px;" data-status="pending">Pending</button>
                        <button type="button" class="btn btn-sm btn-outline-primary filter-btn" style="font-size: 12px;" data-status="approved">Approved</button>
                        <button type="button" class="btn btn-sm btn-outline-primary filter-btn" style="font-size: 12px;" data-status="rejected">Rejected</button>
                    </div>
                    <div class="d-flex mt-2 mt-md-0">
                        <button id="prevLateRequests" class="btn btn-sm btn-outline-primary" disabled>Previous</button>
                        <span id="lateRequestsPaginationInfo" class="mx-2">Showing 1-10</span>
                        <button id="nextLateRequests" class="btn btn-sm btn-outline-primary">Next</button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Reason</th>
                                <th>Status</th>
                                <th>Requested On</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="userLateRequestsTableBody">
                            <!-- Late requests will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="earlyRequestModal" tabindex="-1" aria-labelledby="earlyRequestModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="earlyRequestModalLabel">Request Early Departure</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="earlyRequestForm">
    <div class="mb-3">
        <label for="earlyDate" class="form-label">Date</label>
        <input type="date" class="form-control" id="earlyDate" required readonly>
    </div>
    <div class="mb-3">
        <label for="earlyTime" class="form-label">Early Departure Time</label>
        <input type="time" class="form-control" id="earlyTime" required>
    </div>
    <div class="mb-3">
        <label for="earlyReason" class="form-label">Reason</label>
        <select class="form-select" id="earlyReason" required>
            <option value="Health Emergency">Health Emergency</option>
            <option value="Dependent Care">Dependent Care</option>
            <option value="Medical Appointment">Medical Appointment</option>
            <option value="Bereavement">Bereavement</option>
            <option value="Transportation Issues">Transportation Issues</option>
            <option value="Accident">Accident</option>
        </select>
    </div>
</form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="submitEarlyRequest()">Submit Request</button>
            </div>
        </div>
    </div>
</div>

<!-- View Early Requests Modal -->
<div class="modal fade" id="viewEarlyRequestsModal" tabindex="-1" aria-labelledby="viewEarlyRequestsModalLabel" aria-hidden="true">
    <div class="modal-dialog" style="max-width: 1200px;width: 100%;margin: auto;">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="viewEarlyRequestsModalLabel">My Early Requests</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-2 p-md-10" style="margin: auto;width: 100%;">
                <div class="d-md-flex justify-content-between mb-3">
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-sm btn-outline-primary filter-btn active" style="font-size: 12px;" data-status="all">All</button>
                        <button type="button" class="btn btn-sm btn-outline-primary filter-btn" style="font-size: 12px;" data-status="pending">Pending</button>
                        <button type="button" class="btn btn-sm btn-outline-primary filter-btn" style="font-size: 12px;" data-status="approved">Approved</button>
                        <button type="button" class="btn btn-sm btn-outline-primary filter-btn" style="font-size: 12px;" data-status="rejected">Rejected</button>
                    </div>
                    <div class="d-flex mt-2 mt-md-0">
                        <button id="prevEarlyRequests" class="btn btn-sm btn-outline-primary" disabled>Previous</button>
                        <span id="earlyRequestsPaginationInfo" class="mx-2">Showing 1-10</span>
                        <button id="nextEarlyRequests" class="btn btn-sm btn-outline-primary">Next</button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Early Time</th>
                                <th>Reason</th>
                                <th>Status</th>
                                <th>Requested On</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="userEarlyRequestsTableBody">
                            <!-- Early requests will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<script>
    // Global variables
    let currentEmployeeId = null;
    let currentYear = new Date().getFullYear();
    let currentMonth = new Date().getMonth() + 1;

    // Format time for display
    function formatTime(date) {
        return date.toLocaleTimeString('en-US', {
            hour: '2-digit',
            minute: '2-digit',
            hour12: true
        });
    }

    // Get current location
    function getLocation(callback) {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition((position) => {
                const latitude = position.coords.latitude;
                const longitude = position.coords.longitude;
                fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${latitude}&longitude=${longitude}&localityLanguage=en`)
                    .then(response => response.json())
                    .then(data => {
                        callback({
                            latitude: latitude,
                            longitude: longitude,
                            location_name: data.locality || data.city || data.principalSubdivision || 'Unknown Location'
                        });
                    });
            }, (error) => {
                console.error('Error getting location:', error);
                alert('Location permission is required for attendance tracking. Please enable location services and try again.');
                callback(null);
            }, {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            });
        } else {
            alert('Geolocation is not supported by your browser. Attendance tracking requires location services.');
            callback(null);
        }
    }

    // Handle punch in/out
    function handlePunch(action) {
    getLocation((location) => {
        if (!location) return;

        const today = new Date().toISOString().split('T')[0];
        const userId = '{{ request.user.id }}';
        const storageKey = `punchData_${userId}_${today}`;
        const storedData = JSON.parse(localStorage.getItem(storageKey) || '{}');

        // Check if there is an active break
        fetch('/get_break_status/')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.has_active_break && action === 'out') {
                    alert('You have an active break. Please finish your break before punching out.');
                    return;
                }

                const url = action === 'in' ? "{% url 'punch_in' %}" : "{% url 'punch_out' %}";
                const now = new Date();

                fetch(url, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        latitude: location.latitude,
                        longitude: location.longitude,
                        location_name: location.location_name
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        if (action === 'in') {
                            document.getElementById('punchInTime').textContent = formatTime(now);
                            document.getElementById('punchInLocation').textContent = location.location_name;
                            document.getElementById('punchInLocationLink').href = `https://www.google.com/maps?q=${location.latitude},${location.longitude}`;
                            document.getElementById('punchInBtn').disabled = true;
                            document.getElementById('punchOutBtn').disabled = false;

                            // Store punch-in data locally for UI updates
                            localStorage.setItem(storageKey, JSON.stringify({
                                punchIn: now.toISOString(),
                                punchInLocation: location.location_name,
                                punchInLatitude: location.latitude,
                                punchInLongitude: location.longitude
                            }));
                        } else {
                            document.getElementById('punchOutTime').textContent = formatTime(now);
                            document.getElementById('punchOutLocation').textContent = location.location_name;
                            document.getElementById('punchOutLocationLink').href = `https://www.google.com/maps?q=${location.latitude},${location.longitude}`;
                            document.getElementById('punchOutBtn').disabled = true;

                            // Update stored data locally for UI updates
                            storedData.punchOut = now.toISOString();
                            storedData.punchOutLocation = location.location_name;
                            storedData.punchOutLatitude = location.latitude;
                            storedData.punchOutLongitude = location.longitude;
                            localStorage.setItem(storageKey, JSON.stringify(storedData));
                        }
                        
                        // Refresh the monthly view after punching in/out
                        loadAttendanceData(currentYear, currentMonth);
                        alert(`Punched ${action.toUpperCase()} successfully!`);
                    } else {
                        alert(`Error: ${data.error}`);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    // alert('An error occurred. Please try again.');
                    alert(`Punched ${action.toUpperCase()} successfully!`);
                });
            })
            .catch(error => {
                console.error('Error fetching break status:', error);
                alert('An error occurred. Please try again.');
            });
    });
}

    // Load attendance data for the selected month
    function loadAttendanceData(year, month) {
        if (!currentEmployeeId) return;
        
        fetch(`/get_attendance_data/?employee_id=${currentEmployeeId}&year=${year}&month=${month}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.attendance) {
                    updateAttendanceTable(data.attendance, year, month);
                } else {
                    console.error('Error loading attendance data:', data.error || 'Unknown error');
                }
            })
            .catch(error => {
                console.error('Error loading attendance data:', error);
            });
    }

    // Update the attendance table with fetched data
        function updateAttendanceTable(attendanceData, year, month) {
        const tbody = document.getElementById('attendanceBody');
        tbody.innerHTML = '';
        
        const daysInMonth = new Date(year, month, 0).getDate();
        const today = new Date();
        
        for (let day = 1; day <= daysInMonth; day++) {
            const date = new Date(year, month - 1, day);
            const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
            const isToday = date.getDate() === today.getDate() && 
                            date.getMonth() === today.getMonth() && 
                            date.getFullYear() === today.getFullYear();
            
            const dayData = attendanceData[day] || { status: 'initial' };
            
            // Determine icon and color based on status
            let iconClass, iconColor, statusText;
            switch(dayData.status) {
                case 'full':
                    iconClass = 'fas fa-star';
                    iconColor = 'text-success';
                    statusText = 'Full Day';
                    break;
                case 'verified_full':
                    iconClass = 'fas fa-star';
                    iconColor = 'text-primary';
                    statusText = 'Verified Full Day';
                    break;
                case 'half':
                    iconClass = 'fas fa-star-half-alt';
                    iconColor = 'text-success';
                    statusText = 'Half Day';
                    break;
                case 'verified_half':
                    iconClass = 'fas fa-star-half-alt';
                    iconColor = 'text-primary';
                    statusText = 'Verified Half Day';
                    break;
                case 'leave':
                    iconClass = 'fas fa-star';
                    iconColor = 'text-danger';
                    statusText = 'Leave';
                    break;
                case 'holiday':
                    iconClass = 'fas fa-star';
                    iconColor = 'text-warning';
                    statusText = 'Holiday';
                    break;
                default:
                    iconClass = 'fas fa-star';
                    iconColor = 'text-secondary';
                    statusText = 'Not Marked';
            }
            
            // Format punch times
            const punchInTime = dayData.punch_in ? new Date(dayData.punch_in).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '--:--';
            const punchOutTime = dayData.punch_out ? new Date(dayData.punch_out).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '--:--';
            
            // Create table row
            const row = document.createElement('tr');
            if (isToday) {
                row.classList.add('table-primary');
            } else if (date.getDay() === 0 || date.getDay() === 6) {
                row.classList.add('table-light');
            }
            
            row.innerHTML = `
                <td>${date.toLocaleDateString('en-US', { day: 'numeric', month: 'short', year: 'numeric' })}</td>
                <td>${dayName}</td>
                <td class="text-center">
                    <i class="${iconClass} ${iconColor}" title="${statusText}"></i>
                    ${statusText}
                </td>
                <td>${punchInTime}</td>
                <td>${punchOutTime}</td>
            `;
            
            tbody.appendChild(row);
        }
    }


    // Initialize the page
    document.addEventListener('DOMContentLoaded', function() {
        // Set current month in the filter
        const now = new Date();
        const currentMonthFormatted = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
        document.getElementById('monthFilter').value = currentMonthFormatted;
        
        // Get the employee ID for the logged-in user
        fetch("{% url 'get_current_employee_id' %}")
            .then(response => response.json())
            .then(data => {
                if (data.employee_id) {
                    currentEmployeeId = data.employee_id;
                    loadAttendanceData(currentYear, currentMonth);
                    
                    // Get today's attendance status from the server
                    const today = new Date().toISOString().split('T')[0];
                    fetch(`/get_attendance_status/?employee_id=${currentEmployeeId}&date=${today}`)
                        .then(response => response.json())
                        .then(attendanceData => {
                            // Update UI based on server data
                            updateAttendanceUI(attendanceData);
                        })
                        .catch(error => {
                            console.error('Error fetching attendance status:', error);
                        });
                } else {
                    console.error('No employee ID found for current user');
                }
            })
            .catch(error => {
                console.error('Error fetching employee ID:', error);
            });

        // Set up month filter change handler
        document.getElementById('monthFilter').addEventListener('change', function() {
            const [year, month] = this.value.split('-');
            currentYear = parseInt(year);
            currentMonth = parseInt(month);
            loadAttendanceData(currentYear, currentMonth);
        });

        // Function to update UI based on server attendance data
        function updateAttendanceUI(data) {
            const today = new Date().toISOString().split('T')[0];
            const userId = '{{ request.user.id }}';
            const storageKey = `punchData_${userId}_${today}`;
            
            if (data.punch_in) {
                const punchInTime = new Date(data.punch_in);
                document.getElementById('punchInTime').textContent = formatTime(punchInTime);
                document.getElementById('punchInLocation').textContent = data.punch_in_location || 'Not available';
                
                if (data.punch_in_latitude && data.punch_in_longitude) {
                    document.getElementById('punchInLocationLink').href = 
                        `https://www.google.com/maps?q=${data.punch_in_latitude},${data.punch_in_longitude}`;
                }
                
                document.getElementById('punchInBtn').disabled = true;
                document.getElementById('punchOutBtn').disabled = data.punch_out ? true : false;
                
                // Store in localStorage for UI consistency
                localStorage.setItem(storageKey, JSON.stringify({
                    punchIn: data.punch_in,
                    punchInLocation: data.punch_in_location,
                    punchInLatitude: data.punch_in_latitude,
                    punchInLongitude: data.punch_in_longitude,
                    punchOut: data.punch_out,
                    punchOutLocation: data.punch_out_location,
                    punchOutLatitude: data.punch_out_latitude,
                    punchOutLongitude: data.punch_out_longitude
                }));
            } else {
                document.getElementById('punchOutBtn').disabled = true;
            }
            
            if (data.punch_out) {
                const punchOutTime = new Date(data.punch_out);
                document.getElementById('punchOutTime').textContent = formatTime(punchOutTime);
                document.getElementById('punchOutLocation').textContent = data.punch_out_location || 'Not available';
                
                if (data.punch_out_latitude && data.punch_out_longitude) {
                    document.getElementById('punchOutLocationLink').href = 
                        `https://www.google.com/maps?q=${data.punch_out_latitude},${data.punch_out_longitude}`;
                }
                
                document.getElementById('punchOutBtn').disabled = true;
            }
        }

        // Periodically check for updates (every 5 minutes)
        setInterval(() => {
            loadAttendanceData(currentYear, currentMonth);
        }, 300000);
    });
</script>

<style>
    .card {
        border: none;
        border-radius: 15px;
        background-color: #ffffff17;
        overflow: hidden;
    }

    .card-header {
        border-radius: 15px 15px 0 0 !important;
        overflow: hidden;
    }

    .btn {
        border-radius: 10px;
        padding: 12px 30px;
        font-weight: 600;
    }

    .btn i {
        margin-right: 8px;
    }

    #punchStatus {
        font-size: 1.1rem;
    }

    #punchStatus p {
        margin-bottom: 15px;
    }

    .table {
        border-radius: 10px;
        overflow: hidden;
    }
    
    .table th {
        background-color: #f8f9fa;
        font-weight: 600;
    }
    
    .table td {
        vertical-align: middle;
    }
    
    #monthFilter {
        background-color: white;
        border: none;
        border-radius: 8px;
        padding: 5px 10px;
    }

    .table-primary {
        background-color: #e8f4ff !important;
    }

    .table-light {
        background-color: #f8f9fa !important;
    }
</style>

<script>
    function submitLeaveRequest() {
    const form = document.getElementById('leaveRequestForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }

    // Show loading state
    const submitBtn = document.querySelector('#leaveRequestModal .btn-primary');
    const originalText = submitBtn.textContent;
    submitBtn.textContent = 'Submitting...';
    submitBtn.disabled = true;

    // Validate dates
    const startDate = new Date(document.getElementById('startDate').value);
    const endDate = new Date(document.getElementById('endDate').value);
    
    if (endDate < startDate) {
        alert('End date cannot be before start date');
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
        return;
    }

    const data = {
        start_date: document.getElementById('startDate').value,
        end_date: document.getElementById('endDate').value,
        leave_type: document.getElementById('leaveType').value,
        reason: document.getElementById('reason').value
    };

    // Get CSRF token from meta tag or cookie
    function getCSRFToken() {
        // Method 1: From meta tag
        const csrfToken = document.querySelector('meta[name="csrf-token"]');
        if (csrfToken) {
            return csrfToken.getAttribute('content');
        }
        
        // Method 2: From cookie
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            const [name, value] = cookie.trim().split('=');
            if (name === 'csrftoken') {
                return value;
            }
        }
        
        // Method 3: From Django form (if available)
        const csrfInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
        if (csrfInput) {
            return csrfInput.value;
        }
        
        return null;
    }

    const csrfToken = getCSRFToken();
    
    console.log('Submitting leave request:', data);
    console.log('CSRF Token:', csrfToken);

    fetch('/leave_request/create/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify(data)
    })
    .then(response => {
        console.log('Response status:', response.status);
        console.log('Response headers:', response.headers);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        return response.json();
    })
    .then(data => {
        console.log('Response data:', data);
        
        if (data.success) {
            alert('Leave request submitted successfully!');
            
            // Close modal - try multiple methods
            try {
                // Bootstrap 5 method
                const modal = bootstrap.Modal.getInstance(document.getElementById('leaveRequestModal'));
                if (modal) {
                    modal.hide();
                } else {
                    // Bootstrap 4/jQuery method
                    $('#leaveRequestModal').modal('hide');
                }
            } catch (e) {
                console.log('Modal close method failed, trying alternative');
                // Alternative method
                const modalElement = document.getElementById('leaveRequestModal');
                modalElement.style.display = 'none';
                modalElement.classList.remove('show');
                const backdrop = document.querySelector('.modal-backdrop');
                if (backdrop) backdrop.remove();
                document.body.classList.remove('modal-open');
            }
            
            form.reset();
            
            // Refresh leave requests if function exists
            if (typeof loadUserLeaveRequests === 'function') {
                loadUserLeaveRequests();
            }
        } else {
            alert('Error: ' + (data.error || 'Unknown error occurred'));
        }
    })
    .catch(error => {
        console.error('Fetch error:', error);
        alert('An error occurred while submitting the request: ' + error.message);
    })
    .finally(() => {
        // Reset button state
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
    });
}
    </script>
<script>
// Add these global variables at the top of your script section
let currentLeaveRequestsPage = 1;
const leaveRequestsPerPage = 10;
let allLeaveRequests = [];
let currentFilterStatus = 'all';

// Update the loadUserLeaveRequests function
function loadUserLeaveRequests() {
    fetch('/leave_request/list/')
        .then(response => response.json())
        .then(data => {
            if (data.leave_requests) {
                allLeaveRequests = data.leave_requests.sort((a, b) => {
                    return new Date(b.created_at) - new Date(a.created_at);
                });
                updateUserLeaveRequestsTable(1, 'all');
                new bootstrap.Modal(document.getElementById('viewLeaveRequestsModal')).show();
            } else {
                alert('Error loading leave requests');
            }
        })
        .catch(error => {
            console.error('Error loading leave requests:', error);
            alert('Error loading leave requests');
        });
}

function populateUserLeaveRequestsTable(requests) {
    const tbody = document.getElementById('userLeaveRequestsTableBody');
    tbody.innerHTML = '';
    
    requests.forEach(request => {
        const row = document.createElement('tr');
        
        // Determine status badge color
        let statusBadgeClass = 'badge bg-secondary';
        if (request.status === 'approved') {
            statusBadgeClass = 'badge bg-success';
        } else if (request.status === 'rejected') {
            statusBadgeClass = 'badge bg-danger';
        } else if (request.status === 'pending') {
            statusBadgeClass = 'badge bg-warning text-dark';
        }
        
        row.innerHTML = `
            <td>${request.start_date}</td>
            <td>${request.end_date}</td>
            <td>${request.reason}</td>
            <td><span class="${statusBadgeClass}">${request.status}</span></td>
            <td>${request.created_at}</td>
            <td>
                ${request.status === 'pending' ? `
                <button class="btn btn-sm btn-danger" onclick="deleteLeaveRequest(${request.id})">
                    <i class="fas fa-trash"></i> Delete
                </button>
                ` : ''}
            </td>
        `;
        tbody.appendChild(row);
    });
}

function updateUserLeaveRequestsTable(page, statusFilter) {
    currentLeaveRequestsPage = page;
    currentFilterStatus = statusFilter;
    
    const startIndex = (page - 1) * leaveRequestsPerPage;
    const endIndex = startIndex + leaveRequestsPerPage;
    
    // Filter requests based on current filter status
    let filteredRequests = allLeaveRequests;
    if (currentFilterStatus !== 'all') {
        filteredRequests = allLeaveRequests.filter(req => req.status === currentFilterStatus);
    }
    
    const paginatedRequests = filteredRequests.slice(startIndex, endIndex);
    
    const tbody = document.getElementById('userLeaveRequestsTableBody');
    tbody.innerHTML = '';
    
    paginatedRequests.forEach(request => {
        const row = document.createElement('tr');
        
        // Determine status badge color
        let statusBadgeClass = 'badge bg-secondary';
        if (request.status === 'approved') {
            statusBadgeClass = 'badge bg-success';
        } else if (request.status === 'rejected') {
            statusBadgeClass = 'badge bg-danger';
        } else if (request.status === 'pending') {
            statusBadgeClass = 'badge bg-warning text-dark';
        }
        
        row.innerHTML = `
            <td>${request.start_date}</td>
            <td>${request.end_date}</td>
            <td>${request.leave_type}</td>
            <td>${request.reason}</td>
            <td><span class="${statusBadgeClass}">${request.status}</span></td>
            <td>${request.created_at}</td>
            <td>
                ${request.status === 'pending' ? `
                <button class="btn btn-sm btn-danger" onclick="deleteLeaveRequest(${request.id})">
                    <i class="fas fa-trash"></i> Delete
                </button>
                ` : ''}
            </td>
        `;
        tbody.appendChild(row);
    });
    
    // Update pagination info
    const totalRequests = filteredRequests.length;
    const showingStart = startIndex + 1;
    const showingEnd = Math.min(endIndex, totalRequests);
    document.getElementById('leaveRequestsPaginationInfo').textContent = 
        `Showing ${showingStart}-${showingEnd} of ${totalRequests}`;
    
    // Update button states
    document.getElementById('prevLeaveRequests').disabled = page === 1;
    document.getElementById('nextLeaveRequests').disabled = endIndex >= totalRequests;
}

// Add event listeners for pagination buttons
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('prevLeaveRequests').addEventListener('click', function() {
        if (currentLeaveRequestsPage > 1) {
            updateUserLeaveRequestsTable(currentLeaveRequestsPage - 1, currentFilterStatus);
        }
    });
    
    document.getElementById('nextLeaveRequests').addEventListener('click', function() {
        updateUserLeaveRequestsTable(currentLeaveRequestsPage + 1, currentFilterStatus);
    });
    
    // Add filter button event listeners
    document.querySelectorAll('#viewLeaveRequestsModal .filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('#viewLeaveRequestsModal .filter-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            updateUserLeaveRequestsTable(1, this.dataset.status);
        });
    });
});

// Keep the existing deleteLeaveRequest function the same
function deleteLeaveRequest(requestId) {
    if (!confirm('Are you sure you want to delete this leave request?')) {
        return;
    }

    fetch('/leave_request/delete/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            request_id: requestId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Leave request deleted successfully');
            loadUserLeaveRequests(); // Refresh the list
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while deleting the request');
    });
}
</script>


<script>
    // Global variables for late requests pagination
let currentLateRequestsPage = 1;
const lateRequestsPerPage = 10;
let allLateRequests = [];
let currentLateFilterStatus = 'all';

// Submit late request
function submitLateRequest() {
    const form = document.getElementById('lateRequestForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }

    const data = {
        date: document.getElementById('lateDate').value,
        delay_time: document.getElementById('delayTime').value,
        reason: document.getElementById('lateReason').value
    };

    fetch('/late_request/create/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Late request submitted successfully!');
            $('#lateRequestModal').modal('hide');
            form.reset();
        } else {
            alert('Error: ' + data.error);
        }
    })
    
}

// Load user's late requests
function loadLateRequests() {
    fetch('/late_request/list/')
        .then(response => response.json())
        .then(data => {
            if (data.late_requests) {
                allLateRequests = data.late_requests.sort((a, b) => {
                    return new Date(b.created_at) - new Date(a.created_at);
                });
                updateLateRequestsTable(1, 'all');
                new bootstrap.Modal(document.getElementById('viewLateRequestsModal')).show();
            } else {
                alert('Error loading late requests');
            }
        })
        .catch(error => {
            console.error('Error loading late requests:', error);
            alert('Error loading late requests');
        });
}

// Update late requests table
function updateLateRequestsTable(page, statusFilter = 'all') {
    currentLateRequestsPage = page;
    currentLateFilterStatus = statusFilter;
    const startIndex = (page - 1) * lateRequestsPerPage;
    const endIndex = startIndex + lateRequestsPerPage;
    
    // Filter requests based on current filter status
    let filteredRequests = allLateRequests;
    if (currentLateFilterStatus !== 'all') {
        filteredRequests = allLateRequests.filter(req => req.status === currentLateFilterStatus);
    }
    
    const paginatedRequests = filteredRequests.slice(startIndex, endIndex);
    
    const tbody = document.getElementById('userLateRequestsTableBody');
    tbody.innerHTML = '';
    
    paginatedRequests.forEach(request => {
        const row = document.createElement('tr');
        
        // Determine status badge color
        let statusBadgeClass = 'badge bg-secondary';
        if (request.status === 'approved') {
            statusBadgeClass = 'badge bg-success';
        } else if (request.status === 'rejected') {
            statusBadgeClass = 'badge bg-danger';
        } else if (request.status === 'pending') {
            statusBadgeClass = 'badge bg-warning text-dark';
        }
        
        row.innerHTML = `
            <td>${request.date}</td>
            <td>${request.reason}</td>
            <td><span class="${statusBadgeClass}">${request.status}</span></td>
            <td>${request.created_at}</td>
            <td>
                ${request.status === 'pending' ? `
                <button class="btn btn-sm btn-danger" onclick="deleteLateRequest(${request.id})">
                    <i class="fas fa-trash"></i> Delete
                </button>
                ` : ''}
            </td>
        `;
        tbody.appendChild(row);
    });
    
    // Update pagination info
    const totalRequests = filteredRequests.length;
    const showingStart = startIndex + 1;
    const showingEnd = Math.min(endIndex, totalRequests);
    document.getElementById('lateRequestsPaginationInfo').textContent = 
        `Showing ${showingStart}-${showingEnd} of ${totalRequests}`;
    
    // Update button states
    document.getElementById('prevLateRequests').disabled = page === 1;
    document.getElementById('nextLateRequests').disabled = endIndex >= totalRequests;
}

// Delete late request
function deleteLateRequest(requestId) {
    if (!confirm('Are you sure you want to delete this late request?')) {
        return;
    }

    fetch('/late_request/delete/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            request_id: requestId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Late request deleted successfully');
            loadLateRequests(); // Refresh the list
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while deleting the request');
    });
}

// Initialize late request date to today
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('lateDate').valueAsDate = new Date();
    
    // Late requests pagination event listeners
    document.getElementById('prevLateRequests').addEventListener('click', function() {
        if (currentLateRequestsPage > 1) {
            updateLateRequestsTable(currentLateRequestsPage - 1, currentLateFilterStatus);
        }
    });
    
    document.getElementById('nextLateRequests').addEventListener('click', function() {
        updateLateRequestsTable(currentLateRequestsPage + 1, currentLateFilterStatus);
    });
    
    // Late requests filter buttons
    document.querySelectorAll('#viewLateRequestsModal .filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('#viewLateRequestsModal .filter-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            updateLateRequestsTable(1, this.dataset.status);
        });
    });
});
</script>

<script>
    
function handleBreakPunch(action) {
    fetch(`/handle_break_punch/${action}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (action === 'in') {
                document.getElementById('breakPunchInTime').textContent = data.break_punch_in;
                document.getElementById('breakPunchInBtn').disabled = true;
                document.getElementById('breakPunchOutBtn').disabled = false;
            } else if (action === 'out') {
                document.getElementById('breakPunchOutTime').textContent = data.break_punch_out;
                document.getElementById('breakPunchOutBtn').disabled = true;
            }
        } else {
            alert(data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred. Please try again.');
    });
}

</script>
<script>
// Update the handleBreakPunch function
function handleBreakPunch(action) {
    fetch(`/handle_break_punch/${action}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadBreakStatus(); // Refresh the break status
            if (action === 'in') {
                alert('Break started successfully!');
            } else {
                alert('Break ended successfully!');
            }
        } else {
            alert(data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred. Please try again.');
    });
}

// Update the loadBreakStatus function
function loadBreakStatus() {
    fetch('/get_break_status/')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update UI based on break status
                const breakStatusDiv = document.getElementById('breakStatus');
                let html = '';
                
                // Show all breaks today
                if (data.breaks_today && data.breaks_today.length > 0) {
                    data.breaks_today.forEach((breakItem, index) => {
                        html += `<p class="mb-2" style="display: flex;justify-content: space-between;align-items: center;">
                            Break ${index + 1}: 
                            <span>${breakItem.punch_in || '--:--'} to ${breakItem.punch_out || '--:--'}</span>
                        </p>`;
                    });
                } else {
                    html = '<p>No breaks taken today</p>';
                }
                
                // Show current active break if exists
                if (data.has_active_break) {
                    html += `<p class="mb-2" style="display: flex;justify-content: space-between;align-items: center; color: #ffcc00;">
                        <strong>Current Break:</strong> 
                        <span>Started at ${data.current_break_in}</span>
                    </p>`;
                }
                
                breakStatusDiv.innerHTML = html;
                
                // Update button states
                document.getElementById('breakPunchInBtn').disabled = !data.can_punch_in;
                document.getElementById('breakPunchOutBtn').disabled = !data.can_punch_out;
            } else {
                console.error('Error loading break status');
            }
        })
        .catch(error => {
            console.error('Error loading break status:', error);
        });
}

// Call this when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadBreakStatus();
});
</script>
<script>
    // Global variables for early requests pagination
let currentEarlyRequestsPage = 1;
const earlyRequestsPerPage = 10;
let allEarlyRequests = [];
let currentEarlyFilterStatus = 'all';

// Submit early request
function submitEarlyRequest() {
    const form = document.getElementById('earlyRequestForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }

    const data = {
        date: document.getElementById('earlyDate').value,
        early_time: document.getElementById('earlyTime').value,
        reason: document.getElementById('earlyReason').value
    };

    fetch('/early_request/create/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Early request submitted successfully!');
            $('#earlyRequestModal').modal('hide');
            form.reset();
            loadEarlyRequests(); // Refresh the early requests list
        } else {
            alert('Error: ' + data.error);
        }
    })
    
}

// Load user's early requests
function loadEarlyRequests() {
    fetch('/early_request/list/')
        .then(response => response.json())
        .then(data => {
            if (data.early_requests) {
                allEarlyRequests = data.early_requests.sort((a, b) => {
                    return new Date(b.created_at) - new Date(a.created_at);
                });
                updateEarlyRequestsTable(1, 'all');
                new bootstrap.Modal(document.getElementById('viewEarlyRequestsModal')).show();
            } else {
                alert('Error loading early requests');
            }
        })
        .catch(error => {
            console.error('Error loading early requests:', error);
            alert('Error loading early requests');
        });
}

// Update early requests table
function updateEarlyRequestsTable(page, statusFilter = 'all') {
    currentEarlyRequestsPage = page;
    currentEarlyFilterStatus = statusFilter;
    const startIndex = (page - 1) * earlyRequestsPerPage;
    const endIndex = startIndex + earlyRequestsPerPage;
    
    // Filter requests based on current filter status
    let filteredRequests = allEarlyRequests;
    if (currentEarlyFilterStatus !== 'all') {
        filteredRequests = allEarlyRequests.filter(req => req.status === currentEarlyFilterStatus);
    }
    
    const paginatedRequests = filteredRequests.slice(startIndex, endIndex);
    
    const tbody = document.getElementById('userEarlyRequestsTableBody');
    tbody.innerHTML = '';
    
    paginatedRequests.forEach(request => {
        const row = document.createElement('tr');
        
        // Determine status badge color
        let statusBadgeClass = 'badge bg-secondary';
        if (request.status === 'approved') {
            statusBadgeClass = 'badge bg-success';
        } else if (request.status === 'rejected') {
            statusBadgeClass = 'badge bg-danger';
        } else if (request.status === 'pending') {
            statusBadgeClass = 'badge bg-warning text-dark';
        }
        
        row.innerHTML = `
            <td>${request.date}</td>
            <td>${request.early_time}</td>
            <td>${request.reason}</td>
            <td><span class="${statusBadgeClass}">${request.status}</span></td>
            <td>${request.created_at}</td>
            <td>
                ${request.status === 'pending' ? `
                <button class="btn btn-sm btn-danger" onclick="deleteEarlyRequest(${request.id})">
                    <i class="fas fa-trash"></i> Delete
                </button>
                ` : ''}
            </td>
        `;
        tbody.appendChild(row);
    });
    
    // Update pagination info
    const totalRequests = filteredRequests.length;
    const showingStart = startIndex + 1;
    const showingEnd = Math.min(endIndex, totalRequests);
    document.getElementById('earlyRequestsPaginationInfo').textContent = 
        `Showing ${showingStart}-${showingEnd} of ${totalRequests}`;
    
    // Update button states
    document.getElementById('prevEarlyRequests').disabled = page === 1;
    document.getElementById('nextEarlyRequests').disabled = endIndex >= totalRequests;
}

// Delete early request
function deleteEarlyRequest(requestId) {
    if (!confirm('Are you sure you want to delete this early request?')) {
        return;
    }

    fetch('/early_request/delete/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            request_id: requestId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Early request deleted successfully');
            loadEarlyRequests(); // Refresh the list
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while deleting the request');
    });
}

// Initialize early request date to today
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('earlyDate').valueAsDate = new Date();
    
    // Early requests pagination event listeners
    document.getElementById('prevEarlyRequests').addEventListener('click', function() {
        if (currentEarlyRequestsPage > 1) {
            updateEarlyRequestsTable(currentEarlyRequestsPage - 1, currentEarlyFilterStatus);
        }
    });
    
    document.getElementById('nextEarlyRequests').addEventListener('click', function() {
        updateEarlyRequestsTable(currentEarlyRequestsPage + 1, currentEarlyFilterStatus);
    });
    
    // Early requests filter buttons
    document.querySelectorAll('#viewEarlyRequestsModal .filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('#viewEarlyRequestsModal .filter-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            updateEarlyRequestsTable(1, this.dataset.status);
        });
    });
});
</script>

<script>
    function stopTask(taskId) {
        console.log('Stopping task with ID:', taskId);
        
        // Disable the button to prevent multiple clicks
        const button = event.target.closest('button');
        button.disabled = true;
        button.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Stopping...';
        
        // Create form data
        const formData = new FormData();
        formData.append('task_id', taskId);
        formData.append('csrfmiddlewaretoken', getCookie('csrftoken'));
        
        fetch("{% url 'stop_task' %}", {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => {
            console.log('Response status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Response data:', data);
            if (data.success) {
                alert('Task stopped successfully.');
                location.reload();
            } else {
                alert('Failed to stop task: ' + (data.error || 'Unknown error'));
                // Re-enable button on error
                button.disabled = false;
                button.innerHTML = '<i class="fa fa-stop"></i> Stop';
            }
        })
        .catch(error => {
            console.error('Fetch error:', error);
            alert('An error occurred while stopping the task: ' + error.message);
            // Re-enable button on error
            button.disabled = false;
            button.innerHTML = '<i class="fa fa-stop"></i> Stop';
        });
    }

    // Get CSRF token from cookies
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}