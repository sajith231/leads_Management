{% extends 'base.html' %}
{% block content %}
{% csrf_token %}
{% if request.user.role == 'User' or request.user.role == 'Branch User' %}
    <script>
        window.location.href = "{% url 'attendance_user' %}";
    </script>
{% else %}
<style>
    /* Sticky styles */
    .sticky-header {
      position: sticky;
      left: 0;
      background-color: #f2f2f2;
      z-index: 2;
      box-shadow: 2px 0 5px rgba(0,0,0,0.1);
    }
    
    .sticky-data {
      position: sticky;
      left: 0;
      background-color: #fff;
      z-index: 1;
      box-shadow: 2px 0 5px rgba(0,0,0,0.1);
    }
  </style>
<meta name="csrf-token" content="{{ csrf_token }}">
<div class="allbody" style="overflow: hidden;">
<div class="container-fluid py-4">
    <!-- Header Section with Filters -->
    <div class="card shadow-sm mb-4" style="width: 95%;">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-12">
                    <h2 class="card-title text-center mb-0">Attendance Management</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Calendar Filter Section -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label">Select Month</label>
                    <input type="month" class="form-control" id="monthFilter" 
                           value="{{ current_month|default:'' }}" 
                           onchange="updateAttendanceTable(this.value)">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Search by Name</label>
                    <input type="text" class="form-control" id="nameFilter" onkeyup="filterEmployees()" placeholder="Enter name">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Filter by User Status</label>
                    <select class="form-select" id="statusFilter" onchange="filterByStatus()">
                        <option value="active" selected>Active Users</option>
                        <option value="inactive">Inactive Users</option>
                        <option value="all">All Users</option>
                    </select>
                </div>
                <div class="d-grid gap-2 d-md-flex" style="white-space: nowrap;">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#holidayModal">
                    Add Holiday
                </button>
                <button class="btn btn-info position-relative" onclick="loadLeaveRequests()">
                    View Leave Requests
                    <span id="leaveRequestsBadge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger d-none">
                    0
                    </span>
                </button>
                <button class="btn btn-info position-relative" onclick="loadAdminLateRequests()">
                    View Late Requests
                    <span id="lateRequestsBadge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger d-none">
                    0
                    </span>
                </button>
                <button class="btn btn-info position-relative" onclick="loadAdminEarlyRequests()">
                    View Early Requests
                    <span id="earlyRequestsBadge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger d-none">
                    0
                    </span>
                </button>
                <button class="btn btn-info" onclick="loadAdminWFHRequests()">
                    <i class="fas fa-home"></i> WFH Requests
                </button>
                <span id="wfhRequestsBadge" class="badge bg-danger d-none">New</span>

                <div>
                    <button class="btn btn-info position-relative" onclick="window.location.href='{% url 'attendance_total_summary' %}'">
                    Total Summary
                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger d-none">
                        0
                    </span>
                    </button>
                </div>
                </div>

                <!-- New row for last two buttons -->
                <div class="d-flex gap-2 mt-2">
                <button class="btn btn-info position-relative" onclick="window.location.href='{% url 'break_time_management' %}'">
                    Break Time Management
                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger d-none">
                    0
                    </span>
                </button>
                <button class="btn btn-info position-relative" onclick="window.location.href='{% url 'all_requests_summary' %}'">
                    Requests Summary
                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger d-none">
                    0
                    </span>
                </button>
                </div>

            </div>
        </div>
    </div>

    <!-- Legend Section -->
    <!-- Legend Section -->
<div class="card shadow-sm mb-4">
    <div class="card-body">
        <div class="d-flex gap-4">
            <div class="md:d-flex align-items-center">
                <i class="fas fa-star text-success me-2"></i>
                <span>Full Day</span>
            </div>
            <div class="d-flex align-items-center">
                <i class="fas fa-star-half-alt text-success me-2"></i>
                <span>Half Day</span>
            </div>
            <div class="d-flex align-items-center">
                <i class="fas fa-star-half-alt me-2" style="background: linear-gradient(45deg, #8e0023, #6d28d9); -webkit-background-clip: text; -webkit-text-fill-color: transparent;"></i>
                <span>Verified Half Day</span>
            </div>

            <div class="d-flex align-items-center">
                <i class="fas fa-star text-danger me-2"></i>
                <span>Leave</span>
            </div>
            <div class="d-flex align-items-center">
                <i class="fas fa-star text-warning me-2"></i>
                <span>Holiday</span> 
            </div>
            <div class="d-flex align-items-center">
                <i class="fas fa-star text-primary me-2"></i>
                <span>Verified</span> 
            </div>
            <div class="d-flex align-items-center">
                <i class="fas fa-home text-info me-2"></i>
                <span>Work From Home</span>
            </div>
            <div class="d-flex align-items-center">
                <i class="fas fa-star text-secondary me-2"></i>
                <span>Not Marked</span>
            </div>
        </div>
    </div>
</div>



<button class="btn btn-warning ms-2 position-relative"
        onclick="window.location.href='{% url 'admin_cancel_requestes' %}'">
  Cancel Requestes
  {% if pending_cancel_count > 0 %}
    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
      {{ pending_cancel_count }}
      <span class="visually-hidden">unread messages</span>
    </span>
  {% endif %}
</button>

    <!-- Attendance Details Modal -->
    <!-- Attendance Details Modal -->
<div class="modal fade" id="attendanceDetailsModal" tabindex="-1" aria-labelledby="attendanceDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="attendanceDetailsModalLabel">Attendance Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Employee Name</label>
                            <input type="text" class="form-control" id="employeeName" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Date</label>
                            <div class="form-control" id="attendanceDate" readonly></div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Status</label>
                            <select class="form-select" id="attendanceStatus">
                                <option value="full">Full Day</option>
                                <option value="half">Half Day</option>
                                <option value="leave">Leave</option>
                                <option value="work_from_home">Work From Home</option> <!-- NEW -->
                                <option value="initial">Not Marked</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Add Note (Optional)</label>
                            <textarea class="form-control" id="attendanceNote" rows="3" placeholder="Enter note here"></textarea>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">Punch Details</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Punch In Time</label>
                                    <div class="form-control" id="punchInDisplay">Not punched in</div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Punch In Location</label>
                                    <div class="form-control">
                                        <a id="punchInLocationLink" href="#" target="_blank" class="text-decoration-none">
                                            <span id="punchInLocation">Not available</span>
                                            <i class="fas fa-external-link-alt ms-2"></i>
                                        </a>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Punch Out Time</label>
                                    <div class="form-control" id="punchOutDisplay">Not punched out</div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Punch Out Location</label>
                                    <div class="form-control">
                                        <a id="punchOutLocationLink" href="#" target="_blank" class="text-decoration-none">
                                            <span id="punchOutLocation">Not available</span>
                                            <i class="fas fa-external-link-alt ms-2"></i>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" id="updateAttendanceBtn" class="btn btn-primary" onclick="updateAttendance()">Update Attendance</button>
                <button type="button" id="verifyAttendanceBtn" class="btn btn-primary" onclick="saveAttendance()">Verify Attendance</button>
            </div>
        </div>
    </div>
</div>

    <!-- Holiday Modal -->
    <div class="modal fade" id="holidayModal" style="max-width: 1200px;width: 100%;" tabindex="-1" aria-labelledby="holidayModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="holidayModalLabel">Add Holiday</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Select Date</label>
                        <input type="date" class="form-control" id="holidayDate">
                    </div>
                    <div class="mb-3" style="display: none;">
                        <label class="form-label">Description (Optional)</label>
                        <input type="text" class="form-control" id="holidayDescription" placeholder="Enter holiday description">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-danger" onclick="cancelHoliday()">Remove Holiday</button>
                    <button type="button" class="btn btn-primary" onclick="saveHoliday()">Save Holiday</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Attendance Table -->
    <div style="overflow: scroll;">
        <div class="card shadow-sm">
            <div class="card-body">
                <table class="table table-hover table-bordered">
                    <thead class="table-light">
                    <tr>
                        <th rowspan="3" class="align-middle">No</th>
                        <th rowspan="3" class="align-middle sticky-header" style="background-color: white;">Name</th>
                        <th rowspan="3" class="align-middle">User ID</th>
                        <th rowspan="3" class="align-middle">Duty Start</th>  <!-- New column -->
                        <th rowspan="3" class="align-middle">Duty End</th>    <!-- New column -->
                        <th rowspan="3" class="align-middle">Summary</th>
                        <th id="daysHeader" colspan="31" class="text-center">Days of Month</th>
                    </tr>
                    <tr id="dayNumbers">
                        <!-- Day numbers will be populated by JavaScript -->
                    </tr>
                    <tr id="dayNames">
                        <!-- Day names will be populated by JavaScript -->
                    </tr>
                </thead>
                    <tbody id="attendanceBody">
    {% for employee in employees|dictsort:"name" %}
    <tr class="employee-row" data-employee-id="{{ employee.id }}" data-name="{{ employee.name }}" data-status="{{ employee.user.status }}">

        <td class="serial-number"></td>
        <td class="sticky-data" style="background-color: white;">{{ employee.name }}</td>
        <td>{{ employee.user.userid|default:'' }}</td>
        <td>{{ employee.duty_time_start|time:"H:i" }}</td>  <!-- New column -->
        <td>{{ employee.duty_time_end|time:"H:i" }}</td>    <!-- New column -->
        <td class="text-center">
            <i class="fas fa-eye text-primary" 
               data-bs-toggle="tooltip" 
               title="View summary" 
               onclick="viewSummary('{{ employee.id }}')"
               style="cursor: pointer;"></i>
        </td>
        
        {% for day in days_of_month %}
        <td class="text-center">
            <i class="fas fa-star text-secondary"
               data-employee-id="{{ employee.id }}"
               data-date="{{ current_year }}-{{ current_month }}-{{ day }}"
               data-state="initial"
               data-bs-toggle="tooltip"
               data-bs-placement="top"
               title="Click to edit"
               onclick="showAttendanceModal('{{ employee.id }}', '{{ employee.name }}', '{{ current_year }}-{{ current_month }}-{{ day }}', this)">
            </i>
        </td>
        {% endfor %}
    </tr>
    {% endfor %}
</tbody>
                </table>
            </div>
        </div>
    </div>
</div>
</div>


<!-- Update the modal structure -->
<div class="modal fade" id="leaveRequestsModal" tabindex="-1" aria-labelledby="leaveRequestsModalLabel" aria-hidden="true">
    <div class="modal-dialog" style="max-width: 1200px; width: 100%;">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="leaveRequestsModalLabel">Leave Requests</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-between mb-3">
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-sm btn-outline-primary filter-btn " data-status="all">All</button>
                        <button type="button" class="btn btn-sm btn-outline-primary filter-btn active" data-status="pending">Pending</button>
                        <button type="button" class="btn btn-sm btn-outline-primary filter-btn" data-status="approved">Approved</button>
                        <button type="button" class="btn btn-sm btn-outline-primary filter-btn" data-status="rejected">Rejected</button>
                    </div>
                    <div>
                        <button id="prevLeaveRequests" class="btn btn-sm btn-outline-primary" disabled>Previous</button>
                        <span id="leaveRequestsPaginationInfo" class="mx-2">Showing 1-10</span>
                        <button id="nextLeaveRequests" class="btn btn-sm btn-outline-primary">Next</button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Employee</th>
                                <th>Start Date</th>
                                <th>End Date</th>
                                <th>Reason</th>
                                <th>Note</th> 
                                <th>Leave Type</th> 
                                <th>Status</th>
                                <th>Requested On</th>
                                <th>Actions</th>
                                <th>delete</th>
                            </tr>
                        </thead>
                        <tbody id="leaveRequestsTableBody">
                            <!-- Leave requests will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Add this modal after the leave requests modal -->
<div class="modal fade" id="adminLateRequestsModal" tabindex="-1" aria-labelledby="adminLateRequestsModalLabel" aria-hidden="true">
    <div class="modal-dialog" style="max-width: 1200px; width: 100%;">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="adminLateRequestsModalLabel">Late Requests</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-between mb-3">
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-sm btn-outline-primary filter-btn " data-status="all">All</button>
                        <button type="button" class="btn btn-sm btn-outline-primary filter-btn active" data-status="pending">Pending</button>
                        <button type="button" class="btn btn-sm btn-outline-primary filter-btn" data-status="approved">Approved</button>
                        <button type="button" class="btn btn-sm btn-outline-primary filter-btn" data-status="rejected">Rejected</button>
                    </div>
                    <div>
                        <button id="prevAdminLateRequests" class="btn btn-sm btn-outline-primary" disabled>Previous</button>
                        <span id="adminLateRequestsPaginationInfo" class="mx-2">Showing 1-10</span>
                        <button id="nextAdminLateRequests" class="btn btn-sm btn-outline-primary">Next</button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Employee</th>
                                <th>Date</th>
                                <th>Delay Time</th>
                                <th>Reason</th>
                                <th>Status</th>
                                <th>Requested On</th>
                                <th>Actions</th>
                                <th>Delete</th>
                            </tr>
                        </thead>
                        <tbody id="adminLateRequestsTableBody">
                            <!-- Late requests will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="adminEarlyRequestsModal" tabindex="-1" aria-labelledby="adminEarlyRequestsModalLabel" aria-hidden="true">
    <div class="modal-dialog" style="max-width: 1200px; width: 100%;">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="adminEarlyRequestsModalLabel">Early Requests</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-between mb-3">
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-sm btn-outline-primary filter-btn" data-status="all">All</button>
                        <button type="button" class="btn btn-sm btn-outline-primary filter-btn active" data-status="pending">Pending</button>
                        <button type="button" class="btn btn-sm btn-outline-primary filter-btn" data-status="approved">Approved</button>
                        <button type="button" class="btn btn-sm btn-outline-primary filter-btn" data-status="rejected">Rejected</button>
                    </div>
                    <div>
                        <button id="prevAdminEarlyRequests" class="btn btn-sm btn-outline-primary" disabled>Previous</button>
                        <span id="adminEarlyRequestsPaginationInfo" class="mx-2">Showing 1-10</span>
                        <button id="nextAdminEarlyRequests" class="btn btn-sm btn-outline-primary">Next</button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Employee</th>
                                <th>Date</th>
                                <th>Early Time</th>
                                <th>Reason</th>
                                <th>Status</th>
                                <th>Requested On</th>
                                <th>Actions</th>
                                <th>Delete</th>
                            </tr>
                        </thead>
                        <tbody id="adminEarlyRequestsTableBody">
                            <!-- Early requests will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<!-- Admin WFH Requests Modal (styled like other modals) -->
<div class="modal fade" id="adminWFHRequestsModal" tabindex="-1" aria-labelledby="adminWFHRequestsModalLabel" aria-hidden="true">
  <div class="modal-dialog" style="max-width: 1200px; width: 100%;">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="adminWFHRequestsModalLabel">WFH Requests</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <div class="d-flex justify-content-between mb-3">
          <div class="btn-group" role="group">
            <button type="button" class="btn btn-sm btn-outline-primary filter-btn" data-status="all">All</button>
            <button type="button" class="btn btn-sm btn-outline-primary filter-btn active" data-status="pending">Pending</button>
            <button type="button" class="btn btn-sm btn-outline-primary filter-btn" data-status="approved">Approved</button>
            <button type="button" class="btn btn-sm btn-outline-primary filter-btn" data-status="rejected">Rejected</button>
          </div>
          <div>
            <button id="prevAdminWFHRequests" class="btn btn-sm btn-outline-primary" disabled>Previous</button>
            <span id="adminWFHRequestsPaginationInfo" class="mx-2">Showing 1-10</span>
            <button id="nextAdminWFHRequests" class="btn btn-sm btn-outline-primary">Next</button>
          </div>
        </div>

        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead>
              <tr>
                <th>Employee</th>
                <th>From</th>
                <th>To</th>
                <th>Reason</th>
                <th>Status</th>
                <th>Created</th>
                <th>Actions</th>
                <th>Delete</th>
              </tr>
            </thead>
            <tbody id="adminWFHRequestsTableBody"></tbody>
          </table>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>



<style>
    .equal-width-btn {
        width: 130px; /* adjust this as needed */
    }
    </style>
<!-- Add this button near the holiday button -->


<!-- Add this script -->
<script>
// Global variables for pagination and filtering
let currentLeaveRequestsPage = 1;
const leaveRequestsPerPage = 10;
let allLeaveRequests = [];
let currentFilterStatus = 'all';

function loadLeaveRequests(page = 1, statusFilter = 'pending') {
    document.getElementById('leaveRequestsBadge').classList.add('d-none');
    fetch('/leave_request/list/')
        .then(response => response.json())
        .then(data => {
            allLeaveRequests = data.leave_requests.sort((a, b) => {
                return new Date(b.created_at) - new Date(a.created_at);
            });
            
            currentFilterStatus = statusFilter;
            updateLeaveRequestsTable(page, statusFilter);
            
            // Show the modal
            new bootstrap.Modal(document.getElementById('leaveRequestsModal')).show();
        })
        .catch(error => {
            console.error('Error loading leave requests:', error);
            alert('Error loading leave requests');
        });
}

function updateLeaveRequestsTable(page, statusFilter = 'all') {
    currentLeaveRequestsPage = page;
    currentFilterStatus = statusFilter;
    const startIndex = (page - 1) * leaveRequestsPerPage;
    const endIndex = startIndex + leaveRequestsPerPage;
    
    // Filter requests based on current filter status
    let filteredRequests = allLeaveRequests;
    if (currentFilterStatus !== 'all') {
        filteredRequests = allLeaveRequests.filter(req => req.status === currentFilterStatus);
    }
    
    const paginatedRequests = filteredRequests.slice(startIndex, endIndex);
    
    const tbody = document.getElementById('leaveRequestsTableBody');
    tbody.innerHTML = '';
    
    paginatedRequests.forEach(request => {
        const row = document.createElement('tr');
        row.setAttribute('data-request-id', request.id);
        
        // Determine status badge color
        let statusBadgeClass = 'badge bg-secondary';
        if (request.status === 'approved') {
            statusBadgeClass = 'badge bg-success';
        } else if (request.status === 'rejected') {
            statusBadgeClass = 'badge bg-danger';
        } else if (request.status === 'pending') {
            statusBadgeClass = 'badge bg-warning text-dark';
        }
        
        row.innerHTML = `
            <td>${request.employee_name}</td>
            <td>${request.start_date}</td>
            <td>${request.end_date}</td>
            <td>${request.reason}</td>
            <td>${request.note || ''}</td>
            <td>${request.leave_type}</td> <!-- Added leave type here -->
            <td><span class="${statusBadgeClass}">${request.status}</span></td>
            <td>${request.created_at}</td>
            <td>
                ${request.status === 'pending' ? `
                <button class="btn btn-sm btn-success" onclick="processLeaveRequest(${request.id}, 'approve')">Approve</button>
                <button class="btn btn-sm btn-danger" onclick="processLeaveRequest(${request.id}, 'reject')">Reject</button>
                ` : `
                ${request.status === 'approved' ? `
                    <button class="btn btn-sm btn-danger equal-width-btn" onclick="processLeaveRequest(${request.id}, 'reject')">Revoke Approval</button>
                ` : `
                    <button class="btn btn-sm btn-success equal-width-btn" onclick="processLeaveRequest(${request.id}, 'approve')">Re-approve</button>
                `}
                
                `}
            </td>
            <td>
                ${request.status === 'pending' ? `
                <button class="btn btn-sm btn-danger" onclick="deleteLeaveRequest(${request.id})">
                    <i class="fas fa-trash"></i> Delete
                </button>
                ` : ''}
            </td>
        `;
        tbody.appendChild(row);
    });
    
    // Update pagination info
    const totalRequests = filteredRequests.length;
    const showingStart = startIndex + 1;
    const showingEnd = Math.min(endIndex, totalRequests);
    document.getElementById('leaveRequestsPaginationInfo').textContent = 
        `Showing ${showingStart}-${showingEnd} of ${totalRequests}`;
    
    // Update button states
    document.getElementById('prevLeaveRequests').disabled = page === 1;
    document.getElementById('nextLeaveRequests').disabled = endIndex >= totalRequests;
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Pagination buttons
    document.getElementById('prevLeaveRequests').addEventListener('click', function() {
        if (currentLeaveRequestsPage > 1) {
            updateLeaveRequestsTable(currentLeaveRequestsPage - 1, currentFilterStatus);
        }
    });
    
    document.getElementById('nextLeaveRequests').addEventListener('click', function() {
        updateLeaveRequestsTable(currentLeaveRequestsPage + 1, currentFilterStatus);
    });
    
    // Filter buttons - scoped to the leaveRequestsModal
    document.querySelectorAll('#leaveRequestsModal .filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('#leaveRequestsModal .filter-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            updateLeaveRequestsTable(1, this.dataset.status);
        });
    });
});
function processLeaveRequest(requestId, action) {
    const confirmMessage = action === 'approve' 
        ? 'Are you sure you want to approve this leave request?'
        : 'Are you sure you want to reject this leave request?';
    
    if (!confirm(confirmMessage)) {
        return;
    }

    fetch('/leave_request/process/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector("meta[name='csrf-token']").getAttribute("content")
        },
        body: JSON.stringify({
            request_id: requestId,
            action: action
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`Leave request ${action}d successfully`);
            
            // Update specific dates rather than refreshing the whole table
            if (data.action === 'reject') {
                const startDate = new Date(data.start_date);
                const endDate = new Date(data.end_date);
                const currentDate = new Date(startDate);
                
                while (currentDate <= endDate) {
                    const formattedDate = currentDate.toISOString().split('T')[0];
                    const icons = document.querySelectorAll(`i[data-employee-id="${data.employee_id}"][data-date="${formattedDate}"]`);
                    
                    icons.forEach(icon => {
                        icon.className = 'fas fa-star text-secondary';
                        icon.setAttribute('data-state', 'initial');
                        icon.setAttribute('title', 'Not Marked');
                        
                        // Refresh tooltip
                        const tooltip = bootstrap.Tooltip.getInstance(icon);
                        if (tooltip) {
                            tooltip.dispose();
                        }
                        new bootstrap.Tooltip(icon);
                    });
                    
                    currentDate.setDate(currentDate.getDate() + 1);
                }
            } else if (data.action === 'approve') {
                const startDate = new Date(data.start_date);
                const endDate = new Date(data.end_date);
                const currentDate = new Date(startDate);
                
                while (currentDate <= endDate) {
                    const formattedDate = currentDate.toISOString().split('T')[0];
                    const icons = document.querySelectorAll(`i[data-employee-id="${data.employee_id}"][data-date="${formattedDate}"]`);
                    
                    icons.forEach(icon => {
                        icon.className = 'fas fa-star text-danger';
                        icon.setAttribute('data-state', 'leave');
                        icon.setAttribute('title', 'Leave');
                        
                        // Refresh tooltip
                        const tooltip = bootstrap.Tooltip.getInstance(icon);
                        if (tooltip) {
                            tooltip.dispose();
                        }
                        new bootstrap.Tooltip(icon);
                    });
                    
                    currentDate.setDate(currentDate.getDate() + 1);
                }
            }
            
            // Reload leave requests to reflect changes
            loadLeaveRequests(currentLeaveRequestsPage, currentFilterStatus);
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while processing the request');
    });
}
</script>
<style>
    .filter-btn.active {
        background-color: #0d6efd;
        color: white;
    }
    </style>
<!-- Add Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

<!-- Custom CSS -->
<style>
    .card {
        border-radius: 10px;
        border: none;
        transition: all 0.3s ease;
    }
    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }
    .table {
        width: 100%;
        margin-bottom: 0;
    }
    .table th {
        background-color: #f8f9fa;
        font-weight: 600;
        white-space: nowrap;
        min-width: 40px;
    }
    .table td {
        white-space: nowrap;
        min-width: 40px;
    }
    .attendance-marker {
        transition: all 0.3s ease;
    }
    .attendance-marker:hover {
        opacity: 0.8;
    }
    .form-select, .form-control {
        border-radius: 8px;
    }
    .btn {
        border-radius: 8px;
        padding: 0.5rem 1rem;
    }
    .current-day {
        background-color: #e8f4ff !important;
    }
    .weekend {
        background-color: #f8f9fa;
    }
    .future-day {
        background-color: #f5f5f5;
        pointer-events: none;
    }
    .future-day i {
        opacity: 0.5;
    }
    #punchInLocationLink, #punchOutLocationLink {
        color: #007bff;
        text-decoration: none;
    }
    #punchInLocationLink:hover, #punchOutLocationLink:hover {
        text-decoration: underline;
    }
    .holiday-cell {
        background-color: #fff8e1 !important;
    }
</style>

<script>
    // Global variables to track current month/year
    let currentYear, currentMonth;

    // Get days in month helper function
    function getDaysInMonth(year, month) {
        return new Date(year, month, 0).getDate();
    }

    // Filter employees by name
    function filterEmployees() {
        let input = document.getElementById("nameFilter").value.toLowerCase();
        let employees = document.getElementsByClassName("employee-row");
        
        for (let i = 0; i < employees.length; i++) {
            let name = employees[i].getAttribute("data-name").toLowerCase();
            if (name.includes(input)) {
                employees[i].style.display = "";
            } else {
                employees[i].style.display = "none";
            }
        }
    }

    // Save holiday function
    // Save holiday function
// Updated saveHoliday function
function saveHoliday() {
    const date = document.getElementById('holidayDate').value;
    const description = document.getElementById('holidayDescription').value;
    const csrfToken = document.querySelector("meta[name='csrf-token']").getAttribute("content");

    if (!date) {
        alert('Please select a date');
        return;
    }

    // First check if this date is already marked as a holiday in the UI
    const [year, month, day] = date.split('-');
    const formattedDate = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
    const holidayIcons = document.querySelectorAll(`i[data-date="${formattedDate}"][data-state="holiday"]`);
    
    if (holidayIcons.length > 0) {
        // This date is already marked as a holiday in the UI
        alert('This date is already marked as a holiday!');
        return;
    }

    fetch("{% url 'add_holiday' %}", {
        method: "POST",
        headers: {
            "X-CSRFToken": csrfToken,
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            date: date,
            description: description
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update the UI to show the holiday
            updateHolidayInUI(data.holiday.date);
            // Close the modal
            bootstrap.Modal.getInstance(document.getElementById('holidayModal')).hide();
            alert('Holiday added successfully!');
        } else {
            alert('Error adding holiday: ' + (data.error || "Unknown error"));
        }
    })
    .catch(error => {
        console.error("Error:", error);
        alert("Something went wrong. Please try again.");
    });
}
    // Function to update UI with holiday
    // Function to update UI with holiday
function updateHolidayInUI(date) {
    const [year, month, day] = date.split('-');
    const formattedDate = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
    
    // Update all employee rows for this day
    document.querySelectorAll(`i[data-date="${formattedDate}"]`).forEach(icon => {
        icon.classList.remove("text-success", "text-danger", "text-secondary", "text-warning");
        icon.classList.add("text-warning");
        icon.setAttribute('data-state', 'holiday');
        icon.setAttribute('title', 'Holiday');
        
        // Update the icon class
        icon.className = 'fas fa-star text-warning';
        
        // Refresh tooltip
        const tooltip = bootstrap.Tooltip.getInstance(icon);
        if (tooltip) {
            tooltip.dispose();
        }
        new bootstrap.Tooltip(icon);
    });
}

    // Function to load holidays for the month
    // Function to load holidays for the month
    function loadHolidays(year, month) {
    fetch(`/get_holidays/?year=${year}&month=${month}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.holidays) {
                // First reset all days to initial state
                document.querySelectorAll(`i[data-date^="${year}-${String(month).padStart(2, '0')}-"]`).forEach(icon => {
                    if (icon.getAttribute('data-state') === 'holiday') {
                        icon.classList.remove("text-warning");
                        icon.classList.add("text-secondary");
                        icon.setAttribute('data-state', 'initial');
                        icon.setAttribute('title', 'Not Marked');
                        icon.className = 'fas fa-star text-secondary';
                    }
                });

                // Then mark the holidays
                data.holidays.forEach(holiday => {
                    const date = new Date(holiday.date);
                    const formattedDate = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                    
                    document.querySelectorAll(`i[data-date="${formattedDate}"]`).forEach(icon => {
                        icon.classList.remove("text-success", "text-danger", "text-secondary");
                        icon.classList.add("text-warning");
                        icon.setAttribute('data-state', 'holiday');
                        icon.setAttribute('title', holiday.description || 'Holiday');
                        icon.className = 'fas fa-star text-warning';
                        
                        const tooltip = bootstrap.Tooltip.getInstance(icon);
                        if (tooltip) {
                            tooltip.dispose();
                        }
                        new bootstrap.Tooltip(icon);
                    });
                });
            }
        })
        .catch(error => {
            console.error('Error loading holidays:', error);
        });
}

    // Update attendance table based on selected month
    function updateAttendanceTable(selectedDate) {
        if (!selectedDate) {
            const now = new Date();
            selectedDate = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
        }

        const [year, month] = selectedDate.split('-');
        currentYear = year;
        currentMonth = month;
        const daysInMonth = getDaysInMonth(year, month);
        const currentDate = new Date();
        const selectedMonthDate = new Date(year, month - 1);
        
        // Update table header
        const daysHeader = document.getElementById('daysHeader');
        daysHeader.setAttribute('colspan', daysInMonth);
        
        // Update day numbers and names rows
        const dayNumbersRow = document.getElementById('dayNumbers');
        const dayNamesRow = document.getElementById('dayNames');
        dayNumbersRow.innerHTML = '';
        dayNamesRow.innerHTML = '';
        
        const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        
        for (let day = 1; day <= daysInMonth; day++) {
            const date = new Date(year, month - 1, day);
            const isWeekend = date.getDay() === 0 || date.getDay() === 6;
            const isFuture = date > currentDate;
            const isToday = date.toDateString() === currentDate.toDateString();
            
            // Add day number
            const thNumber = document.createElement('th');
            thNumber.className = `text-center${isWeekend ? ' weekend' : ''}${isToday ? ' current-day' : ''}`;
            thNumber.textContent = day;
            dayNumbersRow.appendChild(thNumber);
            
            // Add day name
            const thName = document.createElement('th');
            thName.className = `text-center${isWeekend ? ' weekend' : ''}${isToday ? ' current-day' : ''}`;
            thName.textContent = dayNames[date.getDay()];
            thName.style.fontSize = '0.8rem';
            dayNamesRow.appendChild(thName);
        }

        // Update attendance cells for each employee
        document.querySelectorAll('#attendanceBody tr').forEach(row => {
                // Remove any existing day cells (except the fixed columns)
                const fixedCells = Array.from(row.children).slice(0, 6); // Changed from 4 to 6 to keep the new columns
                row.innerHTML = '';
                
                // Add back the fixed cells
                fixedCells.forEach(cell => row.appendChild(cell));
            
            // Get employee ID from the data attribute
            const employeeId = row.getAttribute('data-employee-id');
            
            // Add attendance cells for each day
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month - 1, day);
                const isWeekend = date.getDay() === 0 || date.getDay() === 6;
                const isFuture = date > currentDate;
                const isToday = date.toDateString() === currentDate.toDateString();
                
                const td = document.createElement('td');
                td.className = `text-center${isWeekend ? ' weekend' : ''}${isToday ? ' current-day' : ''}${isFuture ? ' future-day' : ''}`;
                
                const icon = document.createElement('i');
                icon.className = 'fas fa-star attendance-marker';
                icon.setAttribute('data-employee-id', employeeId);
                icon.setAttribute('data-date', `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`);
                icon.setAttribute('data-state', 'initial');
                icon.style.cursor = 'pointer';
                icon.style.color = '#ccc';
                
                // Add click handler for attendance markers
                if (!isFuture) {
                    icon.setAttribute('onmouseover', "this.style.transform='scale(1.2)'");
                    icon.setAttribute('onmouseout', "this.style.transform='scale(1)'");
                    
                    // Add click event listener
                    icon.onclick = function() {
                        const employeeName = row.children[1].textContent;
                        showAttendanceModal(employeeId, employeeName, this.getAttribute('data-date'), this);
                    };
                }
                
                td.appendChild(icon);
                row.appendChild(td);
            }
            
            // Load attendance data for this employee and month
            loadAttendanceData(employeeId, year, month);
        });

        // Load holidays for this month
        loadHolidays(year, month);

        // Initialize tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    }

    // Load attendance data for an employee and month
    function loadAttendanceData(employeeId, year, month) {
        fetch(`/get_attendance_data/?employee_id=${employeeId}&year=${year}&month=${month}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.attendance) {
                    Object.entries(data.attendance).forEach(([day, record]) => {
                        const icon = document.querySelector(`i[data-employee-id="${employeeId}"][data-date="${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}"]`);
                        if (icon) {
                            updateAttendanceIcon(icon, record.status, record.punch_in, record.punch_out);
                        }
                    });
                }
            })
            .catch(error => {
                console.error('Error loading attendance data:', error);
            });
    }

    // Update attendance icon based on status
    // Update attendance icon based on status
// In the updateAttendanceIcon function in attendance.html
function updateAttendanceIcon(icon, status, punchIn, punchOut) {
    let iconClass = 'fas fa-star';
    let iconColor = '#ccc';
    let tooltipText = 'Not Marked';
    
    switch(status) {
        case 'full':
            iconClass = 'fas fa-star';
            iconColor = '#198754'; // Green for unverified full day
            tooltipText = `Full Day (In: ${punchIn ? new Date(punchIn).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : 'N/A'}, Out: ${punchOut ? new Date(punchOut).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : 'N/A'})`;
            break;
        case 'verified_full':
            iconClass = 'fas fa-star';
            iconColor = '#0d6efd'; // Blue for verified full day
            tooltipText = `Verified Full Day (In: ${punchIn ? new Date(punchIn).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : 'N/A'}, Out: ${punchOut ? new Date(punchOut).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : 'N/A'})`;
            break;
        case 'half':
            iconClass = 'fas fa-star-half-alt';
            iconColor = '#198754'; // Green for unverified half day
            tooltipText = `Half Day (In: ${punchIn ? new Date(punchIn).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : 'N/A'})`;
            break;
        case 'verified_half':
            iconClass = 'fas fa-star-half-alt';
            iconColor = '#FF00FF'; // Magenta for verified half day
            tooltipText = `Verified Half Day (In: ${punchIn ? new Date(punchIn).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : 'N/A'})`;
            break;

        case 'leave':
            iconClass = 'fas fa-star';
            iconColor = '#dc3545'; // Red for leave
            tooltipText = 'Leave';
            break;
        case 'holiday':
            iconClass = 'fas fa-star';
            iconColor = '#ffc107'; // Yellow for holiday
            tooltipText = 'Holiday';
            break;
        case 'work_from_home': // NEW
            iconClass = 'fas fa-home';
            iconColor = '#0dcaf0'; // Bootstrap "info" color
            tooltipText = 'Work From Home';
            break;
        default:
            iconClass = 'fas fa-star';
            iconColor = '#ccc';
            tooltipText = 'Not Marked';
    }
    
    icon.className = iconClass;
    icon.style.color = iconColor;
    icon.setAttribute('data-state', status);
    icon.setAttribute('title', tooltipText);
    icon.setAttribute('data-bs-toggle', 'tooltip');
    icon.setAttribute('data-bs-placement', 'top');
    
    // Refresh tooltip
    const tooltip = bootstrap.Tooltip.getInstance(icon);
    if (tooltip) {
        tooltip.dispose();
    }
    new bootstrap.Tooltip(icon);
}
    // Show attendance modal
    function showAttendanceModal(employeeId, employeeName, date, icon) {
    // Check if this is a holiday (don't allow editing holidays)
    if (icon.getAttribute('data-state') === 'holiday') {
        alert('Holidays cannot be edited here. Use the Holiday management feature.');
        return;
    }

    const modal = new bootstrap.Modal(document.getElementById('attendanceDetailsModal'));
    const nameInput = document.getElementById('employeeName');
    const dateDisplay = document.getElementById('attendanceDate');
    const statusSelect = document.getElementById('attendanceStatus');
    const punchInDisplay = document.getElementById('punchInDisplay');
    const punchInLocation = document.getElementById('punchInLocation');
    const punchInLocationLink = document.getElementById('punchInLocationLink');
    const punchOutDisplay = document.getElementById('punchOutDisplay');
    const punchOutLocation = document.getElementById('punchOutLocation');
    const punchOutLocationLink = document.getElementById('punchOutLocationLink');
    const noteTextarea = document.getElementById('attendanceNote'); // Get the note textarea
    const updateBtn = document.getElementById('updateAttendanceBtn');
    const verifyBtn = document.getElementById('verifyAttendanceBtn');

    // Store references for later use
    modal._element.setAttribute('data-employee-id', employeeId);
    modal._element.setAttribute('data-date', date);
    modal._element.setAttribute('data-icon-element', icon.outerHTML);

    // Set employee name
    nameInput.value = employeeName;
    nameInput.setAttribute('data-id', employeeId);

    // Format the date nicely
    const [year, month, day] = date.split('-');
    const displayDate = new Date(year, month - 1, day);
    dateDisplay.textContent = displayDate.toLocaleDateString('en-US', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });

    // Get current status from icon
    const currentState = icon.getAttribute('data-state') || 'initial';
    statusSelect.value = currentState.replace('verified_', ''); // Remove verified_ prefix for the select

    // Check if already verified (blue color or verified_ prefix)
    const isVerified = icon.style.color === 'rgb(13, 110, 253)' || currentState.startsWith('verified_');
    
    // Check if user is superuser (passed from Django template)
    const isSuperuser = {% if is_superuser %}true{% else %}false{% endif %};
    
    // Set up UI based on verification status and user role
    if (isVerified && !isSuperuser) {
        // For verified records and regular users
        statusSelect.disabled = true;
        updateBtn.disabled = true;
        verifyBtn.disabled = true;
        updateBtn.classList.add('btn-secondary');
        updateBtn.classList.remove('btn-primary');
        verifyBtn.classList.add('btn-secondary');
        verifyBtn.classList.remove('btn-primary');
    } else {
        // For unverified records OR superusers
        statusSelect.disabled = false;
        updateBtn.disabled = false;
        verifyBtn.disabled = false;
        updateBtn.classList.add('btn-primary');
        updateBtn.classList.remove('btn-secondary');
        verifyBtn.classList.add('btn-primary');
        verifyBtn.classList.remove('btn-secondary');
        
        // If superuser viewing verified record, change button text
        if (isSuperuser && isVerified) {
            verifyBtn.textContent = 'Re-verify Attendance';
        } else {
            verifyBtn.textContent = 'Verify Attendance';
        }
    }

    // Fetch attendance details for this employee and date
    fetch(`/get_attendance_status/?employee_id=${employeeId}&date=${date}`)
        .then(response => response.json())
        .then(data => {
            // Set Punch In details
            if (data.punch_in) {
                const punchInTime = new Date(data.punch_in);
                punchInDisplay.textContent = punchInTime.toLocaleTimeString('en-US', {
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: true
                });

                if (data.punch_in_location && data.punch_in_location !== 'Unknown Location') {
                    punchInLocation.textContent = data.punch_in_location;
                    if (data.punch_in_latitude && data.punch_in_longitude) {
                        punchInLocationLink.href = `https://www.google.com/maps?q=${data.punch_in_latitude},${data.punch_in_longitude}`;
                    } else {
                        punchInLocationLink.href = '#';
                    }
                } else {
                    punchInLocation.textContent = 'Not available';
                    punchInLocationLink.href = '#';
                }
            } else {
                punchInDisplay.textContent = 'Not punched in';
                punchInLocation.textContent = 'Not available';
                punchInLocationLink.href = '#';
            }

            // Set Punch Out details
            if (data.punch_out) {
                const punchOutTime = new Date(data.punch_out);
                punchOutDisplay.textContent = punchOutTime.toLocaleTimeString('en-US', {
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: true
                });

                if (data.punch_out_location && data.punch_out_location !== 'Unknown Location') {
                    punchOutLocation.textContent = data.punch_out_location;
                    if (data.punch_out_latitude && data.punch_out_longitude) {
                        punchOutLocationLink.href = `https://www.google.com/maps?q=${data.punch_out_latitude},${data.punch_out_longitude}`;
                    } else {
                        punchOutLocationLink.href = '#';
                    }
                } else {
                    punchOutLocation.textContent = 'Not available';
                    punchOutLocationLink.href = '#';
                }
            } else {
                punchOutDisplay.textContent = 'Not punched out';
                punchOutLocation.textContent = 'Not available';
                punchOutLocationLink.href = '#';
            }

            // Set Note details
            noteTextarea.value = data.note || ''; // Set the note value
        })
        .catch(error => {
            console.error('Error fetching attendance details:', error);
            punchInDisplay.textContent = 'Error loading data';
            punchOutDisplay.textContent = 'Error loading data';
            noteTextarea.value = ''; // Clear the note field in case of error
        });

    modal.show();
}

    // Save attendance changes
    function saveAttendance() {
    const modal = document.getElementById('attendanceDetailsModal');
    const employeeId = document.getElementById('employeeName').getAttribute('data-id');
    const date = modal.getAttribute('data-date');
    const status = document.getElementById('attendanceStatus').value;
    const note = document.getElementById('attendanceNote').value; // Get the note value
    const csrfToken = document.querySelector("meta[name='csrf-token']").getAttribute("content");
    const isSuperuser = {{ is_superuser|lower }};

    // Determine verified status
    let verifiedStatus;
    if (status === 'full') {
        verifiedStatus = 'verified_full';
    } else if (status === 'half') {
        verifiedStatus = 'verified_half';
    } else {
        verifiedStatus = status; // leave, holiday, etc.
    }

    // For superusers, allow reverifying already verified records
    const icon = document.querySelector(`i[data-employee-id="${employeeId}"][data-date="${date}"]`);
    const currentState = icon ? icon.getAttribute('data-state') || 'initial' : 'initial';
    const isAlreadyVerified = currentState.startsWith('verified_');

    if (isAlreadyVerified && !isSuperuser) {
        alert("This attendance is already verified and cannot be modified.");
        return;
    }

    fetch("{% url 'update_attendance_status' %}", {
        method: "POST",
        headers: {
            "X-CSRFToken": csrfToken,
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            employee_id: employeeId,
            date: date,
            status: verifiedStatus,
            note: note // Include the note in the data
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update the icon in the table
            const icon = document.querySelector(`i[data-employee-id="${data.employee_id}"][data-date="${data.date}"]`);
            if (icon) {
                updateAttendanceIcon(icon, data.status, data.punch_in, data.punch_out);
            }
            
            // Close the modal
            bootstrap.Modal.getInstance(modal).hide();
            
            // Show success message
            alert("Attendance verified successfully!");
            
            // Disable buttons after verification unless superuser
            if (!isSuperuser) {
                document.getElementById('updateAttendanceBtn').disabled = true;
                document.getElementById('verifyAttendanceBtn').disabled = true;
            }
        } else {
            alert("Error verifying attendance: " + (data.error || "Unknown error"));
        }
    })
    .catch(error => {
        console.error("Error:", error);
        alert("Something went wrong. Please try again.");
    });
}


    // Initialize the table with current month on page load
    document.addEventListener('DOMContentLoaded', function() {
        const now = new Date();
        const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
        document.getElementById('monthFilter').value = currentMonth;
        updateAttendanceTable(currentMonth);
        
        // Set the holiday date picker to today's date by default
        document.getElementById('holidayDate').valueAsDate = new Date();
    });
</script>

<script>
    // Add this new function to the script section:
function cancelHoliday() {
    const date = document.getElementById('holidayDate').value;
    const csrfToken = document.querySelector("meta[name='csrf-token']").getAttribute("content");

    if (!date) {
        alert('Please select a date to cancel holiday');
        return;
    }

    if (!confirm('Are you sure you want to cancel the holiday on ' + date + '?')) {
        return;
    }

    fetch("{% url 'delete_holiday' %}", {
        method: "POST",
        headers: {
            "X-CSRFToken": csrfToken,
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            date: date
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update the UI to remove holiday status
            removeHolidayFromUI(date);
            // Close the modal
            bootstrap.Modal.getInstance(document.getElementById('holidayModal')).hide();
            alert('Holiday cancelled successfully!');
        } else {
            alert('Error cancelling holiday: ' + (data.error || "Unknown error"));
        }
    })
    .catch(error => {
        console.error("Error:", error);
        alert("Something went wrong. Please try again.");
    });
}

// Add this helper function to remove holiday from UI
function removeHolidayFromUI(date) {
    const [year, month, day] = date.split('-');
    const formattedDate = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
    
    // Update all employee rows for this day
    document.querySelectorAll(`i[data-date="${formattedDate}"]`).forEach(icon => {
        icon.classList.remove("text-warning");
        icon.classList.add("text-secondary");
        icon.setAttribute('data-state', 'initial');
        icon.setAttribute('title', 'Not Marked');
        icon.className = 'fas fa-star text-secondary';
        
        // Refresh tooltip
        const tooltip = bootstrap.Tooltip.getInstance(icon);
        if (tooltip) {
            tooltip.dispose();
        }
        new bootstrap.Tooltip(icon);
    });
}
</script>
<script>
    // Add this function to handle leave request deletion
function deleteLeaveRequest(requestId) {
    if (!confirm('Are you sure you want to delete this leave request?')) {
        return;
    }

    fetch('/leave_request/delete/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector("meta[name='csrf-token']").getAttribute("content")
        },
        body: JSON.stringify({
            request_id: requestId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Leave request deleted successfully');
            // Remove the deleted request from the UI
            const row = document.querySelector(`tr[data-request-id="${requestId}"]`);
            if (row) {
                row.remove();
            }
            // Refresh the leave requests list
            loadLeaveRequests(currentLeaveRequestsPage, currentFilterStatus);
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while deleting the request');
    });
}
</script>
<script>
    // Admin late requests management
    let currentAdminLateRequestsPage = 1;
    const lateRequestsPerPage = 10;  // Add this line to define the constant
    let allAdminLateRequests = [];
    let currentAdminLateFilterStatus = 'all';

    function loadAdminLateRequests() {
        document.getElementById('lateRequestsBadge').classList.add('d-none');
        console.log("Loading late requests..."); // Debugging
        
        fetch('/late_request/list/')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log("Response data:", data); // Debugging
                
                if (data.success) {
                    allAdminLateRequests = data.late_requests || [];
                    updateAdminLateRequestsTable(1, 'pending');
                    new bootstrap.Modal(document.getElementById('adminLateRequestsModal')).show();
                } else {
                    console.error('Server error:', data.error);
                    alert(`Error: ${data.error || 'Unknown error'}`);
                }
            })
            .catch(error => {
                console.error('Fetch error:', error);
                alert(`Failed to load late requests: ${error.message}`);
            });
    }

    function updateAdminLateRequestsTable(page, statusFilter = 'all') {
    currentAdminLateRequestsPage = page;
    currentAdminLateFilterStatus = statusFilter;
    const startIndex = (page - 1) * lateRequestsPerPage;
    const endIndex = startIndex + lateRequestsPerPage;
    
    // Filter requests based on current filter status
    let filteredRequests = allAdminLateRequests;
    if (currentAdminLateFilterStatus !== 'all') {
        filteredRequests = allAdminLateRequests.filter(req => req.status === currentAdminLateFilterStatus);
    }
    
    const paginatedRequests = filteredRequests.slice(startIndex, endIndex);
    
    const tbody = document.getElementById('adminLateRequestsTableBody');
    tbody.innerHTML = '';
    
    paginatedRequests.forEach(request => {
        const row = document.createElement('tr');
        row.setAttribute('data-request-id', request.id);
        
        // Determine status badge color
        let statusBadgeClass = 'badge bg-secondary';
        if (request.status === 'approved') {
            statusBadgeClass = 'badge bg-success';
        } else if (request.status === 'rejected') {
            statusBadgeClass = 'badge bg-danger';
        } else if (request.status === 'pending') {
            statusBadgeClass = 'badge bg-warning text-dark';
        }
        
        row.innerHTML = `
            <td>${request.employee_name}</td>
            <td>${request.date}</td>
            <td>${request.delay_time}</td>
            <td>${request.reason}</td>
            <td><span class="${statusBadgeClass}">${request.status}</span></td>
            <td>${request.created_at}</td>
            <td>
                ${request.status === 'pending' ? `
                <button class="btn btn-sm btn-success" onclick="processLateRequest(${request.id}, 'approve')">Approve</button>
                <button class="btn btn-sm btn-danger" onclick="processLateRequest(${request.id}, 'reject')">Reject</button>
                ` : `
                ${request.status === 'approved' ? `
                    <button class="btn btn-sm btn-danger equal-width-btn" onclick="processLateRequest(${request.id}, 'reject')">Revoke Approval</button>
                ` : `
                    <button class="btn btn-sm btn-success equal-width-btn" onclick="processLateRequest(${request.id}, 'approve')">Re-approve</button>
                `}
                `}
            </td>
            <td>
                ${request.status === 'pending' ? `
                <button class="btn btn-sm btn-danger" onclick="deleteLateRequest(${request.id})">
                    <i class="fas fa-trash"></i> Delete
                </button>
                ` : ''}
            </td>
        `;
        tbody.appendChild(row);
    });
    
    // Update pagination info
    const totalRequests = filteredRequests.length;
    const showingStart = startIndex + 1;
    const showingEnd = Math.min(endIndex, totalRequests);
    document.getElementById('adminLateRequestsPaginationInfo').textContent = 
        `Showing ${showingStart}-${showingEnd} of ${totalRequests}`;
    
    // Update button states
    document.getElementById('prevAdminLateRequests').disabled = page === 1;
    document.getElementById('nextAdminLateRequests').disabled = endIndex >= totalRequests;
}

    function processLateRequest(requestId, action) {
        const confirmMessage = action === 'approve' 
            ? 'Are you sure you want to approve this late request?'
            : 'Are you sure you want to reject this late request?';
        
        if (!confirm(confirmMessage)) {
            return;
        }

        fetch('/late_request/process/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector("meta[name='csrf-token']").getAttribute("content")
            },
            body: JSON.stringify({
                request_id: requestId,
                action: action
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`Late request ${action}d successfully`);
                loadAdminLateRequests(); // Refresh the list
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while processing the request');
        });
    }

    // Add event listeners for admin late requests
    document.addEventListener('DOMContentLoaded', function() {
        // Pagination buttons
        document.getElementById('prevAdminLateRequests').addEventListener('click', function() {
            if (currentAdminLateRequestsPage > 1) {
                updateAdminLateRequestsTable(currentAdminLateRequestsPage - 1, currentAdminLateFilterStatus);
            }
        });
        
        document.getElementById('nextAdminLateRequests').addEventListener('click', function() {
            updateAdminLateRequestsTable(currentAdminLateRequestsPage + 1, currentAdminLateFilterStatus);
        });
        
        // Filter buttons
        document.querySelectorAll('#adminLateRequestsModal .filter-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('#adminLateRequestsModal .filter-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                updateAdminLateRequestsTable(1, this.dataset.status);
            });
        });
    });
</script>


<script>
    function viewSummary(employeeId) {
    const monthFilter = document.getElementById('monthFilter').value;
    const [year, month] = monthFilter.split('-');
    window.location.href = `/attendance/summary/${employeeId}/?year=${year}&month=${month}`;
}
</script>
<script>
// Add this script to attendance.html
function checkNewRequests() {
    // Check for new leave requests
    fetch('/leave_request/list/?status=pending')
        .then(response => response.json())
        .then(data => {
            if (data.leave_requests) {
                const badge = document.getElementById('leaveRequestsBadge');
                const count = data.leave_requests.length;
                if (count > 0) {
                    badge.textContent = count;
                    badge.classList.remove('d-none');
                } else {
                    badge.classList.add('d-none');
                }
            }
        })
        .catch(error => console.error('Error checking leave requests:', error));

    // Check for new late requests
    fetch('/late_request/list/?status=pending')
        .then(response => response.json())
        .then(data => {
            if (data.late_requests) {
                const badge = document.getElementById('lateRequestsBadge');
                const count = data.late_requests.length;
                if (count > 0) {
                    badge.textContent = count;
                    badge.classList.remove('d-none');
                } else {
                    badge.classList.add('d-none');
                }
            }
        })
        .catch(error => console.error('Error checking late requests:', error));
}

// Call checkNewRequests on page load and every 5 minutes
document.addEventListener('DOMContentLoaded', function() {
    checkNewRequests();
    setInterval(checkNewRequests, 300000); // 5 minutes
});

</script>
<script>
    function deleteLateRequest(requestId) {
    if (!confirm('Are you sure you want to delete this late request?')) {
        return;
    }

    fetch('/late_request/delete/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector("meta[name='csrf-token']").getAttribute("content")
        },
        body: JSON.stringify({
            request_id: requestId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Late request deleted successfully');
            // Remove the deleted request from the UI
            const row = document.querySelector(`tr[data-request-id="${requestId}"]`);
            if (row) {
                row.remove();
            }
            // Refresh the late requests list
            loadAdminLateRequests(currentAdminLateRequestsPage, currentAdminLateFilterStatus);
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while deleting the request');
    });
}
</script>
<script>
    function updateAttendance() {
    const modal = document.getElementById('attendanceDetailsModal');
    const employeeId = document.getElementById('employeeName').getAttribute('data-id');
    const date = modal.getAttribute('data-date');
    const status = document.getElementById('attendanceStatus').value;
    const csrfToken = document.querySelector("meta[name='csrf-token']").getAttribute("content");
    const isSuperuser = {{ is_superuser|lower }};

    // Determine verified status
    let verifiedStatus;
    if (status === 'full') {
        verifiedStatus = 'verified_full';
    } else if (status === 'half') {
        verifiedStatus = 'verified_half';
    } else {
        verifiedStatus = status; // leave, holiday, etc.
    }

    // For superusers, allow reverifying already verified records
    const icon = document.querySelector(`i[data-employee-id="${employeeId}"][data-date="${date}"]`);
    const currentState = icon ? icon.getAttribute('data-state') || 'initial' : 'initial';
    const isAlreadyVerified = currentState.startsWith('verified_');

    if (isAlreadyVerified && !isSuperuser) {
        alert("This attendance is already verified and cannot be modified.");
        return;
    }

    fetch("{% url 'update_attendance_status' %}", {
        method: "POST",
        headers: {
            "X-CSRFToken": csrfToken,
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            employee_id: employeeId,
            date: date,
            status: status
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update the icon in the table
            const icon = document.querySelector(`i[data-employee-id="${data.employee_id}"][data-date="${data.date}"]`);
            if (icon) {
                updateAttendanceIcon(icon, data.status, data.punch_in, data.punch_out);
            }
            
            // Close the modal
            bootstrap.Modal.getInstance(modal).hide();
            
            // Show success message
            alert("Attendance updated successfully!");
        } else {
            alert("Error updating attendance: " + (data.error || "Unknown error"));
        }
    })
    .catch(error => {
        console.error("Error:", error);
        alert("Something went wrong. Please try again.");
    });
}

</script>
<script>
// Admin early requests management
let currentAdminEarlyRequestsPage = 1;
let allAdminEarlyRequests = [];
let currentAdminEarlyFilterStatus = 'all';

function loadAdminEarlyRequests() {
    document.getElementById('earlyRequestsBadge').classList.add('d-none');
    
    fetch('/early_request/list/')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                allAdminEarlyRequests = data.early_requests || [];
                updateAdminEarlyRequestsTable(1, 'pending');
                new bootstrap.Modal(document.getElementById('adminEarlyRequestsModal')).show();
            } else {
                console.error('Server error:', data.error);
                alert(`Error: ${data.error || 'Unknown error'}`);
            }
        })
        .catch(error => {
            console.error('Fetch error:', error);
            alert(`Failed to load early requests: ${error.message}`);
        });
}

function updateAdminEarlyRequestsTable(page, statusFilter = 'all') {
    currentAdminEarlyRequestsPage = page;
    currentAdminEarlyFilterStatus = statusFilter;
    const startIndex = (page - 1) * lateRequestsPerPage;
    const endIndex = startIndex + lateRequestsPerPage;
    
    // Filter requests based on current filter status
    let filteredRequests = allAdminEarlyRequests;
    if (currentAdminEarlyFilterStatus !== 'all') {
        filteredRequests = allAdminEarlyRequests.filter(req => req.status === currentAdminEarlyFilterStatus);
    }
    
    const paginatedRequests = filteredRequests.slice(startIndex, endIndex);
    
    const tbody = document.getElementById('adminEarlyRequestsTableBody');
    tbody.innerHTML = '';
    
    paginatedRequests.forEach(request => {
        const row = document.createElement('tr');
        row.setAttribute('data-request-id', request.id);
        
        // Determine status badge color
        let statusBadgeClass = 'badge bg-secondary';
        if (request.status === 'approved') {
            statusBadgeClass = 'badge bg-success';
        } else if (request.status === 'rejected') {
            statusBadgeClass = 'badge bg-danger';
        } else if (request.status === 'pending') {
            statusBadgeClass = 'badge bg-warning text-dark';
        }
        
        row.innerHTML = `
            <td>${request.employee_name}</td>
            <td>${request.date}</td>
            <td>${request.early_time}</td>
            <td>${request.reason}</td>
            <td><span class="${statusBadgeClass}">${request.status}</span></td>
            <td>${request.created_at}</td>
            <td>
                ${request.status === 'pending' ? `
                <button class="btn btn-sm btn-success" onclick="processEarlyRequest(${request.id}, 'approve')">Approve</button>
                <button class="btn btn-sm btn-danger" onclick="processEarlyRequest(${request.id}, 'reject')">Reject</button>
                ` : `
                ${request.status === 'approved' ? `
                    <button class="btn btn-sm btn-danger equal-width-btn" onclick="processEarlyRequest(${request.id}, 'reject')">Revoke Approval</button>
                ` : `
                    <button class="btn btn-sm btn-success equal-width-btn" onclick="processEarlyRequest(${request.id}, 'approve')">Re-approve</button>
                `}
                `}
            </td>
            <td>
                ${request.status === 'pending' ? `
                <button class="btn btn-sm btn-danger" onclick="deleteEarlyRequest(${request.id})">
                    <i class="fas fa-trash"></i> Delete
                </button>
                ` : ''}
            </td>
        `;
        tbody.appendChild(row);
    });
    
    // Update pagination info
    const totalRequests = filteredRequests.length;
    const showingStart = startIndex + 1;
    const showingEnd = Math.min(endIndex, totalRequests);
    document.getElementById('adminEarlyRequestsPaginationInfo').textContent = 
        `Showing ${showingStart}-${showingEnd} of ${totalRequests}`;
    
    // Update button states
    document.getElementById('prevAdminEarlyRequests').disabled = page === 1;
    document.getElementById('nextAdminEarlyRequests').disabled = endIndex >= totalRequests;
}

function processEarlyRequest(requestId, action) {
    const confirmMessage = action === 'approve' 
        ? 'Are you sure you want to approve this early request?'
        : 'Are you sure you want to reject this early request?';
    
    if (!confirm(confirmMessage)) {
        return;
    }

    fetch('/early_request/process/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector("meta[name='csrf-token']").getAttribute("content")
        },
        body: JSON.stringify({
            request_id: requestId,
            action: action
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`Early request ${action}d successfully`);
            loadAdminEarlyRequests(); // Refresh the list
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while processing the request');
    });
}

function deleteEarlyRequest(requestId) {
    if (!confirm('Are you sure you want to delete this early request?')) {
        return;
    }

    fetch('/early_request/delete/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector("meta[name='csrf-token']").getAttribute("content")
        },
        body: JSON.stringify({
            request_id: requestId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Early request deleted successfully');
            // Remove the deleted request from the UI
            const row = document.querySelector(`tr[data-request-id="${requestId}"]`);
            if (row) {
                row.remove();
            }
            // Refresh the early requests list
            loadAdminEarlyRequests(currentAdminEarlyRequestsPage, currentAdminEarlyFilterStatus);
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while deleting the request');
    });
}

// Add event listeners for admin early requests
document.addEventListener('DOMContentLoaded', function() {
    // Pagination buttons
    document.getElementById('prevAdminEarlyRequests').addEventListener('click', function() {
        if (currentAdminEarlyRequestsPage > 1) {
            updateAdminEarlyRequestsTable(currentAdminEarlyRequestsPage - 1, currentAdminEarlyFilterStatus);
        }
    });
    
    document.getElementById('nextAdminEarlyRequests').addEventListener('click', function() {
        updateAdminEarlyRequestsTable(currentAdminEarlyRequestsPage + 1, currentAdminEarlyFilterStatus);
    });
    
    // Filter buttons
    document.querySelectorAll('#adminEarlyRequestsModal .filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('#adminEarlyRequestsModal .filter-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            updateAdminEarlyRequestsTable(1, this.dataset.status);
        });
    });
});

// Update checkNewRequests to include early requests
function checkNewRequests() {
    // Check for new early requests
    fetch('/early_request/list/?status=pending')
        .then(response => response.json())
        .then(data => {
            if (data.early_requests) {
                const badge = document.getElementById('earlyRequestsBadge');
                const count = data.early_requests.length;
                if (count > 0) {
                    badge.textContent = count;
                    badge.classList.remove('d-none');
                } else {
                    badge.classList.add('d-none');
                }
            }
        })
        .catch(error => console.error('Error checking early requests:', error));
}
</script>
<script>
    // Add this function to check for new requests
function checkNewRequestsForSummary() {
    fetch('/leave_request/list/?status=pending')
        .then(response => response.json())
        .then(data => {
            if (data.leave_requests) {
                const leaveCount = data.leave_requests.length;
                
                // Check late requests
                fetch('/late_request/list/?status=pending')
                    .then(response => response.json())
                    .then(lateData => {
                        const lateCount = lateData.late_requests ? lateData.late_requests.length : 0;
                        
                        // Check early requests
                        fetch('/early_request/list/?status=pending')
                            .then(response => response.json())
                            .then(earlyData => {
                                const earlyCount = earlyData.early_requests ? earlyData.early_requests.length : 0;
                                
                                const totalCount = leaveCount + lateCount + earlyCount;
                                const badge = document.getElementById('requestsSummaryBadge');
                                
                                if (totalCount > 0) {
                                    badge.textContent = totalCount;
                                    badge.classList.remove('d-none');
                                } else {
                                    badge.classList.add('d-none');
                                }
                            });
                    });
            }
        })
        .catch(error => console.error('Error checking requests:', error));
}

// Call on page load and periodically
document.addEventListener('DOMContentLoaded', function() {
    checkNewRequestsForSummary();
    setInterval(checkNewRequestsForSummary, 300000); // 5 minutes
});
</script>

<script>
let currentAdminWFHPage = 1;
const adminWFHPerPage = 10;
let allAdminWFH = [];
let currentAdminWfhFilter = 'all';

function loadAdminWFHRequests() {
  document.getElementById('wfhRequestsBadge').classList.add('d-none');
  fetch('/wfh_request/list/')
    .then(r=>r.json())
    .then(d=>{
      if (d.success) {
        allAdminWFH = (d.wfh_requests || []).sort((a,b)=>new Date(b.created_at)-new Date(a.created_at));
        updateAdminWFHRequestsTable(1, 'pending');
        new bootstrap.Modal(document.getElementById('adminWFHRequestsModal')).show();
      } else {
        alert('Error loading WFH requests');
      }
    });
}

function updateAdminWFHRequestsTable(page, statusFilter='all') {
  currentAdminWFHPage = page; currentAdminWfhFilter = statusFilter;
  const startIndex = (page-1)*adminWFHPerPage, endIndex = startIndex + adminWFHPerPage;
  let rows = allAdminWFH;
  if (statusFilter!=='all') rows = rows.filter(r=>r.status===statusFilter);
  const slice = rows.slice(startIndex, endIndex);

  const tbody = document.getElementById('adminWFHRequestsTableBody');
  tbody.innerHTML = '';

  slice.forEach(req=>{
    let badge='badge bg-secondary';
    if (req.status==='approved') badge='badge bg-success';
    else if (req.status==='rejected') badge='badge bg-danger';
    else if (req.status==='pending')  badge='badge bg-warning text-dark';

    const tr = document.createElement('tr');
    tr.setAttribute('data-request-id', req.id);
    tr.innerHTML = `
      <td>${req.employee_name || ''}</td>
      <td>${req.start_date}</td>
      <td>${req.end_date}</td>
      <td>${req.reason}</td>
      <td><span class="${badge}">${req.status}</span></td>
      <td>${req.created_at}</td>
      <td>
        ${req.status==='pending' ? `
          <button class="btn btn-sm btn-success" onclick="processWFHRequest(${req.id}, 'approve')">Approve</button>
          <button class="btn btn-sm btn-danger"  onclick="processWFHRequest(${req.id}, 'reject')">Reject</button>
        ` : `
          ${req.status==='approved' ? `
            <button class="btn btn-sm btn-danger"  onclick="processWFHRequest(${req.id}, 'reject')">Revoke Approval</button>
          ` : `
            <button class="btn btn-sm btn-success" onclick="processWFHRequest(${req.id}, 'approve')">Re-approve</button>
          `}
        `}
      </td>
      <td>
        ${req.status==='pending' ? `
          <button class="btn btn-sm btn-danger" onclick="deleteAdminWFHRequest(${req.id})">
            <i class="fas fa-trash"></i> Delete
          </button>
        ` : ``}
      </td>`;
    tbody.appendChild(tr);
  });

  document.getElementById('adminWFHRequestsPaginationInfo').textContent =
    `Showing ${rows.length?startIndex+1:0}-${Math.min(endIndex, rows.length)} of ${rows.length}`;
  document.getElementById('prevAdminWFHRequests').disabled = page===1;
  document.getElementById('nextAdminWFHRequests').disabled = endIndex>=rows.length;
}

function processWFHRequest(id, action) {
  const msg = action==='approve' ? 'Approve this WFH request?' : 'Reject this WFH request?';
  if (!confirm(msg)) return;
  fetch('/wfh_request/process/', {
    method:'POST',
    headers:{'Content-Type':'application/json','X-CSRFToken':document.querySelector("meta[name='csrf-token']").getAttribute("content")},
    body: JSON.stringify({request_id:id, action})
  }).then(r=>r.json()).then(d=>{
    if (d.success) {
      alert(`WFH request ${action}d successfully`);

      // update icons for range (same pattern you use for leave updates: iterate date range and call updateAttendanceIcon) :contentReference[oaicite:15]{index=15}
      const start = new Date(d.start_date), end = new Date(d.end_date);
      const cur = new Date(start);
      while (cur <= end) {
        const yyyy = cur.getFullYear(), mm = String(cur.getMonth()+1).padStart(2,'0'), dd = String(cur.getDate()).padStart(2,'0');
        document.querySelectorAll(`i[data-employee-id="${d.employee_id}"][data-date="${yyyy}-${mm}-${dd}"]`).forEach(icon=>{
          if (action==='approve') {
            // set to WFH (house, info)  your updateAttendanceIcon already supports it :contentReference[oaicite:16]{index=16}
            updateAttendanceIcon(icon, 'work_from_home', null, null);
          } else {
            // back to Not Marked
            updateAttendanceIcon(icon, 'initial', null, null);
          }
        });
        cur.setDate(cur.getDate()+1);
      }

      loadAdminWFHRequests(); // refresh table
    } else {
      alert('Error: ' + (d.error || 'Unknown error'));
    }
  }).catch(e=>alert('Error: ' + e.message));
}

function deleteAdminWFHRequest(id) {
  if (!confirm('Delete this WFH request?')) return;
  fetch('/wfh_request/delete/', {
    method:'POST',
    headers:{'Content-Type':'application/json','X-CSRFToken':document.querySelector("meta[name='csrf-token']").getAttribute("content")},
    body: JSON.stringify({request_id:id})
  }).then(r=>r.json()).then(d=>{
    if (d.success) { alert('Deleted'); loadAdminWFHRequests(); }
    else alert('Error: ' + d.error);
  });
}

document.addEventListener('DOMContentLoaded', function(){
  document.getElementById('prevAdminWFHRequests').addEventListener('click', ()=>{
    if (currentAdminWFHPage>1) updateAdminWFHRequestsTable(currentAdminWFHPage-1,currentAdminWfhFilter);
  });
  document.getElementById('nextAdminWFHRequests').addEventListener('click', ()=>{
    updateAdminWFHRequestsTable(currentAdminWFHPage+1,currentAdminWfhFilter);
  });
  document.querySelectorAll('#adminWFHRequestsModal .filter-btn').forEach(b=>{
    b.addEventListener('click', function(){
      document.querySelectorAll('#adminWFHRequestsModal .filter-btn').forEach(x=>x.classList.remove('active'));
      this.classList.add('active');
      updateAdminWFHRequestsTable(1, this.dataset.status);
    });
  });
});
</script>
<script>
function filterByStatus() {
    const selectedStatus = document.getElementById("statusFilter").value;
    const rows = document.querySelectorAll(".employee-row");

    rows.forEach(row => {
        const status = row.getAttribute("data-status") || "active";
        if (selectedStatus === "all" || status === selectedStatus) {
            row.style.display = "";
        } else {
            row.style.display = "none";
        }
    });
}

// Auto-apply the default filter (active only) when page loads
document.addEventListener("DOMContentLoaded", function() {
    filterByStatus();
});

</script>
<script>
function updateSerialNumbers() {
    let rows = document.querySelectorAll(".employee-row");
    let count = 1;

    rows.forEach(row => {
        if (row.style.display !== "none") {
            row.querySelector(".serial-number").textContent = count++;
        }
    });
}
document.addEventListener("DOMContentLoaded", updateSerialNumbers);
document.getElementById("nameFilter").addEventListener("keyup", updateSerialNumbers);
document.getElementById("statusFilter").addEventListener("change", updateSerialNumbers);
</script>


{% endif %}
{% endblock %}