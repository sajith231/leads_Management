{% extends 'base.html' %}
{% load static %}

{% block content %}
<style>
    @media (max-width: 768px){.allbody{margin-top:15%;}}
    .employee-management-container{max-width:1600px;margin:0 auto;padding:20px;}
    
    .page-header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:30px;border-radius:10px;margin-bottom:30px;box-shadow:0 4px 6px rgba(0,0,0,0.1);}
    .page-header h2{margin:0;font-size:28px;font-weight:600;display:flex;align-items:center;gap:15px;}
    
    /* Main Layout - Two Column */
    .main-layout{display:grid;grid-template-columns:320px 1fr;gap:30px;}
    
    /* Left Panel - Filters & Directory */
    .left-panel{display:flex;flex-direction:column;gap:25px;}
    
    /* Filters Card */
    .filters-card{background:white;padding:25px;border-radius:10px;box-shadow:0 2px 12px rgba(0,0,0,0.08);}
    .filters-card h3{font-size:18px;font-weight:600;color:#333;margin:0 0 20px 0;display:flex;align-items:center;gap:10px;}
    
    .filter-group{margin-bottom:20px;}
    .filter-group label{font-weight:600;color:#555;margin-bottom:8px;display:block;font-size:14px;}
    .filter-group input,.filter-group select{width:100%;padding:12px 15px;border:1px solid #ddd;border-radius:8px;font-size:14px;transition:all .3s;background:#f8f9fa;}
    .filter-group input:focus,.filter-group select:focus{outline:none;border-color:#667eea;box-shadow:0 0 0 3px rgba(102,126,234,0.1);background:white;}
    
    /* Directory Card */
    .directory-card{background:white;padding:25px;border-radius:10px;box-shadow:0 2px 12px rgba(0,0,0,0.08);flex:1;display:flex;flex-direction:column;}
    .directory-header{margin-bottom:20px;}
    .directory-header h3{font-size:18px;font-weight:600;color:#333;margin:0 0 5px 0;display:flex;align-items:center;gap:10px;}
    .employee-count{color:#666;font-size:14px;}
    
    .employee-list{flex:1;overflow-y:auto;max-height:500px;}
    .employee-item{padding:18px 20px;border-bottom:1px solid #eee;cursor:pointer;transition:all .2s;background:white;margin:0;border-left:4px solid transparent;}
    .employee-item:hover{background:#f8f9fa;border-left-color:#667eea;}
    .employee-item.active{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;border-left-color:#5568d3;}
    .employee-item-content{display:flex;align-items:center;gap:15px;}
    .employee-avatar{width:50px;height:50px;border-radius:50%;object-fit:cover;border:2px solid #e0e0e0;}
    .employee-item.active .employee-avatar{border-color:white;}
    .employee-info{flex:1;min-width:0;}
    .employee-name{font-weight:600;font-size:15px;margin:0 0 4px 0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .employee-title{font-size:13px;color:#666;margin:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .employee-item.active .employee-title{color:rgba(255,255,255,0.9);}
    
    .no-employees{padding:40px 20px;text-align:center;color:#999;}
    .no-employees i{font-size:48px;margin-bottom:15px;opacity:.3;}
    
    /* Right Panel - Employee Details */
    .right-panel{display:flex;flex-direction:column;gap:25px;}
    
    /* Action Bar */
    .action-bar{background:white;padding:20px 25px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.08);display:flex;justify-content:space-between;align-items:center;}
    .action-bar .pagination-info{display:flex;align-items:center;gap:15px;}
    .pagination-text{color:#666;font-size:14px;}
    .pagination{display:flex;gap:6px;margin:0;padding:0;list-style:none;}
    .page-item{margin:0;}
    .page-link{padding:8px 12px;background:white;border:1px solid #ddd;color:#667eea;text-decoration:none;border-radius:6px;font-weight:600;font-size:13px;transition:.3s;}
    .page-link:hover{background:#667eea;color:white;border-color:#667eea;}
    .page-item.active .page-link{background:#667eea;color:white;border-color:#667eea;}
    
    .btn-add-employee{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:12px 24px;border:none;border-radius:8px;font-weight:600;text-decoration:none;display:inline-flex;align-items:center;gap:8px;transition:all .3s;box-shadow:0 4px 6px rgba(102,126,234,0.2);}
    .btn-add-employee:hover{transform:translateY(-2px);box-shadow:0 6px 12px rgba(102,126,234,0.3);color:white;}
    
    /* Employee Details Card */
    .details-card{background:white;padding:30px;border-radius:10px;box-shadow:0 2px 12px rgba(0,0,0,0.08);flex:1;}
    
    .employee-header{display:flex;align-items:center;gap:25px;padding-bottom:25px;margin-bottom:25px;border-bottom:2px solid #f0f0f0;position:relative;}
    .employee-photo-large{width:120px;height:120px;border-radius:12px;object-fit:cover;border:3px solid #e0e0e0;box-shadow:0 4px 8px rgba(0,0,0,0.1);cursor:pointer;transition:.3s;}
    .employee-photo-large:hover{transform:scale(1.05);}
    .employee-header-info{flex:1;}
    .employee-header-info h3{margin:0 0 8px 0;font-size:24px;font-weight:700;color:#333;}
    .employee-id{color:#666;font-size:14px;margin-bottom:10px;}
    .status-badge{display:inline-block;padding:6px 14px;border-radius:20px;font-size:12px;font-weight:600;text-transform:uppercase;}
    .status-active{background:#d4edda;color:#155724;}
    .status-inactive{background:#f8d7da;color:#721c24;}
    .status-on-leave{background:#fff3cd;color:#856404;}
    
    /* Header Actions - New style for Edit/Delete buttons in header */
    .header-actions{position:absolute;right:0;top:0;display:flex;gap:8px;align-items:center;}
    .header-actions .btn-edit,.header-actions .btn-delete{padding:8px 14px;font-weight:600;border-radius:6px;border:none;cursor:pointer;display:inline-flex;gap:6px;align-items:center;justify-content:center;font-size:13px;transition:.3s;}
    .header-actions .btn-edit{background:#ffc107;color:#000;}
    .header-actions .btn-edit:hover{background:#e0a800;}
    .header-actions .btn-delete{background:#dc3545;color:#fff;}
    .header-actions .btn-delete:hover{background:#c82333;}
    
    .tabs-container{margin-bottom:25px;}
    .nav-tabs{border-bottom:2px solid #e0e0e0;display:flex;gap:5px;}
    .nav-tab{padding:12px 20px;background:none;border:none;color:#666;font-weight:600;font-size:14px;cursor:pointer;border-bottom:3px solid transparent;transition:all .3s;position:relative;border-radius:6px 6px 0 0;}
    .nav-tab:hover{color:#667eea;background:#f8f9fa;}
    .nav-tab.active{color:#667eea;border-bottom-color:#667eea;}
    
    .tab-content{display:none;}
    .tab-content.active{display:block;animation:fadeIn .3s;}
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}
    
    .detail-section{background:#f8f9fa;padding:22px;border-radius:10px;margin-bottom:20px;position:relative;border-left:4px solid #667eea;}
    .detail-section h4{font-size:16px;font-weight:700;color:#333;margin:0 0 16px 0;display:flex;align-items:center;gap:10px;}
    .section-actions{position:absolute;right:12px;top:12px;display:flex;gap:8px;align-items:center;display:none; /* Hide from sections */ }
    .section-actions .btn-edit,.section-actions .btn-delete{padding:8px 14px;font-weight:600;border-radius:6px;border:none;cursor:pointer;display:inline-flex;gap:6px;align-items:center;justify-content:center;font-size:13px;transition:.3s;}
    .section-actions .btn-edit{background:#ffc107;color:#000;}
    .section-actions .btn-edit:hover{background:#e0a800;}
    .section-actions .btn-delete{background:#dc3545;color:#fff;}
    .section-actions .btn-delete:hover{background:#c82333;}
    
    .detail-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:15px;}
    .detail-item{background:white;padding:15px;border-radius:8px;border-left:3px solid #667eea;}
    .detail-label{font-size:12px;font-weight:600;color:#666;text-transform:uppercase;margin-bottom:8px;letter-spacing:.5px;}
    .detail-value{font-size:15px;color:#333;font-weight:500;word-wrap:break-word;}
    .detail-text-area{background:white;padding:15px;border-radius:8px;margin-top:10px;border-left:3px solid #667eea;}
    
    .attachments-list{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px;}
    .attachment-link{display:inline-flex;align-items:center;gap:8px;padding:10px 15px;background:white;border:1px solid #ddd;border-radius:6px;color:#667eea;text-decoration:none;font-size:14px;transition:all .3s;}
    .attachment-link:hover{background:#667eea;color:white;border-color:#667eea;}
    
    /* Scrollbar Styling */
    .employee-list::-webkit-scrollbar{width:6px;}
    .employee-list::-webkit-scrollbar-track{background:#f1f1f1;border-radius:3px;}
    .employee-list::-webkit-scrollbar-thumb{background:#888;border-radius:3px;}
    .employee-list::-webkit-scrollbar-thumb:hover{background:#555;}
    
    .details-card::-webkit-scrollbar{width:6px;}
    .details-card::-webkit-scrollbar-track{background:#f1f1f1;border-radius:3px;}
    .details-card::-webkit-scrollbar-thumb{background:#888;border-radius:3px;}
    .details-card::-webkit-scrollbar-thumb:hover{background:#555;}
    
    /* Responsive */
    @media (max-width:1200px){.main-layout{grid-template-columns:1fr;}.left-panel{flex-direction:row;}.filters-card,.directory-card{flex:1;}.employee-list{max-height:300px;}}
    @media (max-width:768px){.left-panel{flex-direction:column;}.action-bar{flex-direction:column;gap:15px;align-items:flex-start;}.employee-header{flex-direction:column;text-align:center;}.detail-grid{grid-template-columns:1fr;}.header-actions{position:static;margin-top:15px;justify-content:center;}}
    
    /* Modal */
    .modal-content{border-radius:10px;border:none;box-shadow:0 10px 40px rgba(0,0,0,0.2);}
    .modal-header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;border-radius:10px 10px 0 0;padding:20px 25px;}
    .modal-title{font-weight:600;}
    .modal-body{padding:25px;}
    .modal-footer{padding:15px 25px;border-top:1px solid #e0e0e0;}
</style>

<div class="allbody">
    <div class="employee-management-container">
        <!-- Page Header -->
        <div class="page-header">
            <h2>
                <i class="fas fa-users"></i>
                Employee Management
            </h2>
        </div>

        <!-- Main Layout -->
        <div class="main-layout">
            <!-- Left Panel: Filters & Directory -->
            <div class="left-panel">
                <!-- Filters Card -->
                <div class="filters-card">
                    <h3><i class="fas fa-filter"></i> Filters</h3>
                    
                    <!-- Search -->
                    <div class="filter-group">
                        <label for="searchInput">Search</label>
                        <input type="text" id="searchInput" placeholder="Search by name, ID, job..." value="{{ search_query }}">
                    </div>

                    <!-- Status Filter -->
                    <div class="filter-group">
                        <label for="statusFilter">Status</label>
                        <select id="statusFilter" onchange="filterByStatus()">
                            <option value="active" {% if not status_filter or status_filter == 'active' %}selected{% endif %}>
                                Active
                            </option>
                            <option value="inactive" {% if status_filter == 'inactive' %}selected{% endif %}>
                                Inactive
                            </option>
                            <option value="on_leave" {% if status_filter == 'on_leave' %}selected{% endif %}>
                                On Leave
                            </option>
                        </select>
                    </div>
<!-- Job Filter -->
<div class="filter-group">
    <label for="jobFilter">Job Title</label>
    <select id="jobFilter" onchange="filterByJob()">
        <option value="">All Jobs</option>
        {% for j in job_choices %}
        <option value="{{ j }}" {% if job_filter == j %}selected{% endif %}>{{ j }}</option>
        {% endfor %}
    </select>
</div>

<!-- Organization Filter -->
<div class="filter-group">
    <label for="organizationFilter">Organization</label>
    <select id="organizationFilter" onchange="filterByOrganization()">
        <option value="">All Organizations</option>
        {% for o in organization_choices %}
        <option value="{{ o }}" {% if organization_filter == o %}selected{% endif %}>{{ o }}</option>
        {% endfor %}
    </select>
</div>


                </div>

                <!-- Directory Card -->
                <div class="directory-card">
                    <div class="directory-header">
                        <h3><i class="fas fa-list"></i> Employee Directory</h3>
                        <div class="employee-count">{% if employees %}{{ employees|length }} employee(s){% else %}0 employees{% endif %}</div>
                    </div>

                    <div class="employee-list">
                        {% for employee in employees %}
                        <div class="employee-item {% if forloop.first %}active{% endif %}"
                             onclick="showEmployeeDetails({{ employee.id }}, this)"
                             data-employee-id="{{ employee.id }}">
                            <div class="employee-item-content">
                                <img src="{{ employee.photo.url }}" alt="{{ employee.name }}" class="employee-avatar">
                                <div class="employee-info">
                                    <p class="employee-name">{{ employee.name }}</p>
                                    <p class="employee-title">{{ employee.job_title }}</p>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="no-employees">
                            <i class="fas fa-user-slash"></i>
                            <p>No employees found</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Right Panel: Action Bar & Employee Details -->
            <div class="right-panel">
                <!-- Action Bar with Pagination -->
                <div class="action-bar">
                    <div class="pagination-info">
                        <div class="pagination-text">
                            Showing {% if page_obj %}{{ page_obj.start_index }} to {{ page_obj.end_index }} of {% endif %}{{ total_employees }} employees
                            {% if search_query or job_filter or organization_filter or status_filter %}
                                <span style="color: #667eea; font-weight: 600;"></span>
                            {% endif %}
                        </div>

                        {% if page_obj %}
                        <nav aria-label="Employee pagination">
                            <ul class="pagination">
                                {% if page_obj.has_previous %}
                                    <li class="page-item">
                                        <a class="page-link" href="?{% if status_filter %}status={{ status_filter }}&{% endif %}{% if search_query %}search={{ search_query }}&{% endif %}{% if job_filter %}job={{ job_filter }}&{% endif %}{% if organization_filter %}organization={{ organization_filter }}&{% endif %}page={{ page_obj.previous_page_number }}">
                                            <i class="fas fa-chevron-left"></i>
                                        </a>
                                    </li>
                                {% endif %}

                                {% for num in page_obj.paginator.page_range %}
                                    {% if page_obj.number == num %}
                                        <li class="page-item active">
                                            <span class="page-link">{{ num }}</span>
                                        </li>
                                    {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                                        <li class="page-item">
                                            <a class="page-link" href="?{% if status_filter %}status={{ status_filter }}&{% endif %}{% if search_query %}search={{ search_query }}&{% endif %}{% if job_filter %}job={{ job_filter }}&{% endif %}{% if organization_filter %}organization={{ organization_filter }}&{% endif %}page={{ num }}">{{ num }}</a>
                                        </li>
                                    {% endif %}
                                {% endfor %}

                                {% if page_obj.has_next %}
                                    <li class="page-item">
                                        <a class="page-link" href="?{% if status_filter %}status={{ status_filter }}&{% endif %}{% if search_query %}search={{ search_query }}&{% endif %}{% if job_filter %}job={{ job_filter }}&{% endif %}{% if organization_filter %}organization={{ organization_filter }}&{% endif %}page={{ page_obj.next_page_number }}">
                                            <i class="fas fa-chevron-right"></i>
                                        </a>
                                    </li>
                                {% endif %}
                            </ul>
                        </nav>
                        {% endif %}
                    </div>

                    <a href="{% url 'add_employee' %}" class="btn-add-employee">
                        <i class="fas fa-plus"></i> Add New Employee
                    </a>
                </div>

                <!-- Employee Details Card -->
                <div class="details-card" id="employeeDetailsPanel">
                    {% if employees %}
                    {% with employee=employees.0 %}
                    <div id="employeeDetails{{ employee.id }}" class="employee-details-content">
                        <div class="employee-header">
                            <img src="{{ employee.photo.url }}" alt="{{ employee.name }}" class="employee-photo-large" onclick="showPhotoModal('{{ employee.photo.url }}', '{{ employee.name }}')">
                            <div class="employee-header-info">
                                <h3>{{ employee.name }}</h3>
                                <p class="employee-id">Employee ID: {{ employee.user.userid }}</p>
                                <span class="status-badge status-{{ employee.status }}">{{ employee.get_status_display }}</span>
                            </div>
                            <!-- Header Actions - Edit/Delete buttons moved here -->
                            <div class="header-actions">
                                <a href="{% url 'edit_employee' employee.id %}" class="btn-edit"><i class="fas fa-edit"></i> Edit</a>
                                <button type="button" class="btn-delete" onclick="triggerDelete('{% url 'delete_employee' employee.id %}')"><i class="fas fa-trash"></i> Delete</button>
                            </div>
                        </div>

                        <!-- Tabs -->
                        <div class="tabs-container">
                            <div class="nav-tabs">
                                <button class="nav-tab active" onclick="switchTab(event, 'jobInfo{{ employee.id }}')">
                                    <i class="fas fa-briefcase"></i> Job Information
                                </button>
                                <button class="nav-tab" onclick="switchTab(event, 'contactInfo{{ employee.id }}')">
                                    <i class="fas fa-address-book"></i> Contact Details
                                </button>
                                <button class="nav-tab" onclick="switchTab(event, 'bankInfo{{ employee.id }}')">
                                    <i class="fas fa-university"></i> Bank Details
                                </button>
                            </div>
                        </div>

                        <!-- Job Info -->
                        <div id="jobInfo{{ employee.id }}" class="tab-content active">
                            <div class="detail-section">
                                <h4><i class="fas fa-briefcase"></i> Organization & Position</h4>
                                <!-- Section actions removed from here -->

                                <div class="detail-grid">
                                    <div class="detail-item">
                                        <div class="detail-label">Organization</div>
                                        <div class="detail-value">{{ employee.organization }}</div>
                                    </div>
                                    <div class="detail-item">
                                        <div class="detail-label">Job Title</div>
                                        <div class="detail-value">{{ employee.job_title }}</div>
                                    </div>
                                    <div class="detail-item">
                                        <div class="detail-label">Joining Date</div>
                                        <div class="detail-value">{{ employee.joining_date }}</div>
                                    </div>
                                    <div class="detail-item">
                                        <div class="detail-label">Date of Birth</div>
                                        <div class="detail-value">{{ employee.dob }}</div>
                                    </div>
                                </div>
                            </div>

                            <div class="detail-section">
                                <h4><i class="fas fa-clock"></i> Working Hours</h4>
                                <div class="detail-grid">
                                    <div class="detail-item">
                                        <div class="detail-label">Duty Start Time</div>
                                        <div class="detail-value">{{ employee.duty_time_start }}</div>
                                    </div>
                                    <div class="detail-item">
                                        <div class="detail-label">Duty End Time</div>
                                        <div class="detail-value">{{ employee.duty_time_end }}</div>
                                    </div>
                                </div>
                            </div>

                            <div class="detail-section">
                                <h4><i class="fas fa-graduation-cap"></i> Education</h4>
                                <div class="detail-text-area">
                                    <div class="detail-value">{{ employee.education }}</div>
                                </div>
                            </div>

                            <div class="detail-section">
                                <h4><i class="fas fa-suitcase"></i> Experience</h4>
                                <div class="detail-text-area">
                                    <div class="detail-value">{{ employee.experience }}</div>
                                </div>
                            </div>

                            {% if employee.attachments.all %}
                            <div class="detail-section">
                                <h4><i class="fas fa-paperclip"></i> Attachments</h4>
                                <div class="attachments-list">
                                    {% for attachment in employee.attachments.all %}
                                    <a href="{{ attachment.file.url }}" target="_blank" class="attachment-link">
                                        <i class="fas fa-file-alt"></i>
                                        View Document {{ forloop.counter }}
                                    </a>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}
                        </div>

                        <!-- Contact Info -->
                        <div id="contactInfo{{ employee.id }}" class="tab-content">
                            <div class="detail-section">
                                <h4><i class="fas fa-phone"></i> Phone Numbers</h4>
                                <div class="detail-grid">
                                    <div class="detail-item">
                                        <div class="detail-label">Personal Phone</div>
                                        <div class="detail-value">{{ employee.phone_personal }}</div>
                                    </div>
                                    <div class="detail-item">
                                        <div class="detail-label">Residential Phone</div>
                                        <div class="detail-value">{{ employee.phone_residential }}</div>
                                    </div>
                                </div>
                            </div>

                            <div class="detail-section">
                                <h4><i class="fas fa-map-marker-alt"></i> Address Information</h4>
                                <div class="detail-grid">
                                    <div class="detail-item">
                                        <div class="detail-label">Address</div>
                                        <div class="detail-value">{{ employee.address }}</div>
                                    </div>
                                    <div class="detail-item">
                                        <div class="detail-label">Place</div>
                                        <div class="detail-value">{{ employee.place }}</div>
                                    </div>
                                    <div class="detail-item">
                                        <div class="detail-label">District</div>
                                        <div class="detail-value">{{ employee.district }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Bank Info -->
                        <div id="bankInfo{{ employee.id }}" class="tab-content">
                            <div class="detail-section">
                                <h4><i class="fas fa-university"></i> Bank Account Information</h4>
                                <!-- Section actions removed from here -->

                                <div class="detail-grid">
                                    <div class="detail-item">
                                        <div class="detail-label">Bank Account Number</div>
                                        <div class="detail-value">{{ employee.bank_account_number|default:"Not provided" }}</div>
                                    </div>
                                    <div class="detail-item">
                                        <div class="detail-label">IFSC Code</div>
                                        <div class="detail-value">{{ employee.ifsc_code|default:"Not provided" }}</div>
                                    </div>
                                    <div class="detail-item">
                                        <div class="detail-label">Bank Name</div>
                                        <div class="detail-value">{{ employee.bank_name|default:"Not provided" }}</div>
                                    </div>
                                    <div class="detail-item">
                                        <div class="detail-label">Branch</div>
                                        <div class="detail-value">{{ employee.branch|default:"Not provided" }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endwith %}
                    {% else %}
                    <div class="no-employee-selected">
                        <i class="fas fa-user-circle"></i>
                        <h3>No Employees Available</h3>
                        <p>Add a new employee to get started</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Hidden delete form -->
<div style="display:none;">
    <form id="hiddenDeleteForm" method="post" action="#">
        {% csrf_token %}
    </form>
</div>

<!-- Photo modal -->
<div class="modal fade" id="photoModal" tabindex="-1" aria-labelledby="photoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="photoModalLabel">Employee Photo</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <img id="photoModalImage" src="" class="img-fluid" alt="Employee Photo">
            </div>
        </div>
    </div>
</div>

<script>
/* Employee management page script - consolidated and robust */

/* --- Utilities --- */
function updateQueryParam(key, value) {
    try {
        const u = new URL(window.location);
        // reset page when filters change
        u.searchParams.delete('page');

        if (value === '' || value === null || value === undefined) {
            u.searchParams.delete(key);
        } else {
            u.searchParams.set(key, value);
        }

        // Navigate to the updated URL
        window.location.href = u.toString();
    } catch (err) {
        console.warn('updateQueryParam error:', err);
    }
}

/* Safe setter for element value (no error if element missing) */
function safeSetValue(elId, value) {
    const el = document.getElementById(elId);
    if (!el) return;
    try {
        el.value = value === null ? '' : value;
    } catch (e) {
        for (const opt of el.options || []) {
            if (opt.value === value) {
                el.value = value;
                break;
            }
        }
    }
}

/* --- Sync controls from URL on load --- */
function syncFiltersFromURL() {
    try {
        const u = new URL(window.location);
        const status = u.searchParams.get('status');
        const job = u.searchParams.get('job');
        const org = u.searchParams.get('organization');
        const search = u.searchParams.get('search');

        safeSetValue('statusFilter', status);
        safeSetValue('jobFilter', job);
        safeSetValue('organizationFilter', org);

        const searchEl = document.getElementById('searchInput');
        if (searchEl && search !== null) searchEl.value = search;
    } catch (err) {
        console.warn("syncFiltersFromURL error:", err);
    }
}

/* --- Filtering functions used by onchange attributes or direct calls --- */
function filterByStatus() {
    const el = document.getElementById('statusFilter');
    const val = el ? el.value : '';
    updateQueryParam('status', val);
}

function filterByJob() {
    const el = document.getElementById('jobFilter');
    const val = el ? el.value : '';
    updateQueryParam('job', val);
}

function filterByOrganization() {
    const el = document.getElementById('organizationFilter');
    const val = el ? el.value : '';
    updateQueryParam('organization', val);
}

/* --- Search (debounced) --- */
let searchTimeout = null;
function setupSearchListener() {
    const searchInputEl = document.getElementById("searchInput");
    if (!searchInputEl) return;
    searchInputEl.addEventListener("keyup", function () {
        clearTimeout(searchTimeout);
        const that = this;
        searchTimeout = setTimeout(() => {
            const val = that.value.trim();
            // Fixed: Always use 'search' as the key, not conditional
            updateQueryParam('search', val);
        }, 400);
    });
}

/* --- Employee data & UI rendering --- */
const employeeData = {
    {% for employee in employees %}
    {{ employee.id }}: {
        id: {{ employee.id }},
        name: "{{ employee.name|escapejs }}",
        userid: "{{ employee.user.userid|escapejs }}",
        photo: "{{ employee.photo.url|default_if_none:''|escapejs }}",
        status: "{{ employee.status|escapejs }}",
        statusDisplay: "{{ employee.get_status_display|escapejs }}",
        jobTitle: "{{ employee.job_title|escapejs }}",
        organization: "{{ employee.organization|escapejs }}",
        joiningDate: "{{ employee.joining_date|escapejs }}",
        dob: "{{ employee.dob|escapejs }}",
        dutyTimeStart: "{{ employee.duty_time_start|escapejs }}",
        dutyTimeEnd: "{{ employee.duty_time_end|escapejs }}",
        education: "{{ employee.education|escapejs }}",
        experience: "{{ employee.experience|escapejs }}",
        phonePersonal: "{{ employee.phone_personal|escapejs }}",
        phoneResidential: "{{ employee.phone_residential|escapejs }}",
        address: "{{ employee.address|escapejs }}",
        place: "{{ employee.place|escapejs }}",
        district: "{{ employee.district|escapejs }}",
        bankAccountNumber: "{{ employee.bank_account_number|default:'Not provided'|escapejs }}",
        ifscCode: "{{ employee.ifsc_code|default:'Not provided'|escapejs }}",
        bankName: "{{ employee.bank_name|default:'Not provided'|escapejs }}",
        branch: "{{ employee.branch|default:'Not provided'|escapejs }}",
        editUrl: "{% url 'edit_employee' employee.id %}",
        deleteUrl: "{% url 'delete_employee' employee.id %}",
        attachments: [
            {% for attachment in employee.attachments.all %}
            {url: "{{ attachment.file.url|escapejs }}", index: {{ forloop.counter }}}{% if not forloop.last %},{% endif %}
            {% endfor %}
        ]
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
};

/* --- Details rendering & UI helpers --- */
function showEmployeeDetails(employeeId, element) {
    // clear active class on list items
    document.querySelectorAll('.employee-item').forEach(item => item.classList.remove('active'));
    if (element) element.classList.add('active');

    const employee = employeeData[employeeId];
    if (!employee) return;

    const attachmentsHTML = (employee.attachments && employee.attachments.length > 0) ? `
        <div class="detail-section">
            <h4><i class="fas fa-paperclip"></i> Attachments</h4>
            <div class="attachments-list">
                ${employee.attachments.map(att =>
                    `<a href="${att.url}" target="_blank" class="attachment-link">
                        <i class="fas fa-file-alt"></i>
                        View Document ${att.index}
                    </a>`
                ).join('')}
            </div>
        </div>` : '';

    const detailsHTML = `
        <div id="employeeDetails${employeeId}" class="employee-details-content">
            <div class="employee-header">
                <img src="${employee.photo}" alt="${employee.name}" class="employee-photo-large"
                     onclick="showPhotoModal('${employee.photo}', '${employee.name.replace(/'/g,"\\'")}')">
                <div class="employee-header-info">
                    <h3>${employee.name}</h3>
                    <p class="employee-id">Employee ID: ${employee.userid}</p>
                    <span class="status-badge status-${employee.status}">${employee.statusDisplay}</span>
                </div>
                <div class="header-actions">
                    <a href="${employee.editUrl}" class="btn-edit">
                        <i class="fas fa-edit"></i> Edit
                    </a>
                    <button type="button" class="btn-delete" onclick="triggerDelete('${employee.deleteUrl}')">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </div>
            </div>

            <div class="tabs-container">
                <div class="nav-tabs">
                    <button class="nav-tab active" onclick="switchTab(event, 'jobInfo${employeeId}')">
                        <i class="fas fa-briefcase"></i> Job Information
                    </button>
                    <button class="nav-tab" onclick="switchTab(event, 'contactInfo${employeeId}')">
                        <i class="fas fa-address-book"></i> Contact Details
                    </button>
                    <button class="nav-tab" onclick="switchTab(event, 'bankInfo${employeeId}')">
                        <i class="fas fa-university"></i> Bank Details
                    </button>
                </div>
            </div>

            <div id="jobInfo${employeeId}" class="tab-content active">
                <div class="detail-section">
                    <h4><i class="fas fa-briefcase"></i> Organization & Position</h4>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">Organization</div>
                            <div class="detail-value">${employee.organization}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Job Title</div>
                            <div class="detail-value">${employee.jobTitle}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Joining Date</div>
                            <div class="detail-value">${employee.joiningDate}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Date of Birth</div>
                            <div class="detail-value">${employee.dob}</div>
                        </div>
                    </div>
                </div>

                <div class="detail-section">
                    <h4><i class="fas fa-clock"></i> Working Hours</h4>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">Duty Start Time</div>
                            <div class="detail-value">${employee.dutyTimeStart}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Duty End Time</div>
                            <div class="detail-value">${employee.dutyTimeEnd}</div>
                        </div>
                    </div>
                </div>

                <div class="detail-section">
                    <h4><i class="fas fa-graduation-cap"></i> Education</h4>
                    <div class="detail-text-area">
                        <div class="detail-value">${employee.education}</div>
                    </div>
                </div>

                <div class="detail-section">
                    <h4><i class="fas fa-suitcase"></i> Experience</h4>
                    <div class="detail-text-area">
                        <div class="detail-value">${employee.experience}</div>
                    </div>
                </div>

                ${attachmentsHTML}
            </div>

            <div id="contactInfo${employeeId}" class="tab-content">
                <div class="detail-section">
                    <h4><i class="fas fa-phone"></i> Phone Numbers</h4>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">Personal Phone</div>
                            <div class="detail-value">${employee.phonePersonal}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Residential Phone</div>
                            <div class="detail-value">${employee.phoneResidential}</div>
                        </div>
                    </div>
                </div>

                <div class="detail-section">
                    <h4><i class="fas fa-map-marker-alt"></i> Address Information</h4>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">Address</div>
                            <div class="detail-value">${employee.address}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Place</div>
                            <div class="detail-value">${employee.place}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">District</div>
                            <div class="detail-value">${employee.district}</div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="bankInfo${employeeId}" class="tab-content">
                <div class="detail-section">
                    <h4><i class="fas fa-university"></i> Bank Account Information</h4>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <div class="detail-label">Bank Account Number</div>
                            <div class="detail-value">${employee.bankAccountNumber}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">IFSC Code</div>
                            <div class="detail-value">${employee.ifscCode}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Bank Name</div>
                            <div class="detail-value">${employee.bankName}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Branch</div>
                            <div class="detail-value">${employee.branch}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;

    const panel = document.getElementById('employeeDetailsPanel');
    if (!panel) return;
    panel.innerHTML = detailsHTML;
    panel.scrollTop = 0;
}

function switchTab(event, tabId) {
    const navContainer = event.target.closest('.tabs-container');
    if (navContainer) {
        navContainer.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
        event.target.classList.add('active');
    } else {
        event.target.classList.add('active');
    }

    const tabEl = document.getElementById(tabId);
    if (!tabEl) return;
    const contentRoot = tabEl.closest('.employee-details-content');
    if (!contentRoot) return;
    contentRoot.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    tabEl.classList.add('active');
}

function showPhotoModal(photoUrl, employeeName) {
    const img = document.getElementById('photoModalImage');
    const label = document.getElementById('photoModalLabel');
    if (img) img.src = photoUrl || '';
    if (label) label.textContent = (employeeName || '') + ' - Photo';
    const modalEl = document.getElementById('photoModal');
    if (modalEl && typeof bootstrap !== 'undefined') {
        new bootstrap.Modal(modalEl).show();
    }
}

function confirmDeletion() {
    return confirm("Are you sure you want to delete this employee? This action cannot be undone.");
}

function triggerDelete(deleteUrl) {
    if (!deleteUrl) return;
    if (!confirmDeletion()) return;
    const form = document.getElementById('hiddenDeleteForm');
    if (!form) {
        window.location.href = deleteUrl;
    } else {
        form.action = deleteUrl;
        form.submit();
    }
}

/* --- Initialize on DOMContentLoaded --- */
document.addEventListener('DOMContentLoaded', function () {
    console.log("Employee page loaded. Current query string:", window.location.search);

    syncFiltersFromURL();
    setupSearchListener();

    // Auto-open first employee details if employees exist
    {% if employees %}
        try {
            const firstId = {{ employees.0.id }};
            const detailsPanel = document.getElementById('employeeDetailsPanel');
            let ele = document.querySelector('.employee-item[data-employee-id="' + firstId + '"]');
            if (!ele) ele = document.querySelector('.employee-item');
            if (detailsPanel && !detailsPanel.querySelector('#employeeDetails' + firstId)) {
                showEmployeeDetails(firstId, ele);
            }
        } catch (err) {
            console.warn('Error auto-opening first employee details:', err);
        }
    {% endif %}
});
</script>

{% endblock %}