{% extends "base.html" %}
{% block content %}
{% load static %}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
  body {
    background: #fff;
    color: #2b2f36;
    font-family: Arial, Helvetica, sans-serif;
  }

  .page-wrap {
    max-width: 1200px;
    margin: 28px auto 60px;
    padding: 0 16px;
  }

  .top-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
  }

  .back-link {
    display: inline-block;
    padding: 10px 16px;
    background: #332f89;
    color: #fff;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 600;
  }

  .back-link:hover { background: #271cbf; }

  /* Grid layout */
  .main-grid {
    display: grid;
    grid-template-columns: 180px 1fr;
    gap: 24px;
    align-items: start;
  }

  @media (max-width: 992px) {
    .main-grid { grid-template-columns: 1fr; }
  }

  /* Subfolder panel */
  .subfolder-panel {
    background: #fff;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    padding: 18px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    height: fit-content;
    margin-left: -100px;
  }

  .subfolder-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
  }

  .subfolder-header h3 {
    font-size: 16px;
    font-weight: 700;
    color: #1f2937;
    margin: 0;
  }

  #openCreateSubfolder {
    border: none;
    background: none;
    cursor: pointer;
    position: relative;
    width: 34px;
    height: 34px;
    border-radius: 8px;
    transition: all 0.3s ease;
  }

  #openCreateSubfolder i.fa-folder {
    font-size: 24px;
    color: #2563eb;
  }

  #openCreateSubfolder::after {
    content: "+";
    position: absolute;
    right: 0;
    bottom: 0;
    background: #10b981;
    color: #fff;
    border-radius: 50%;
    width: 16px;
    height: 16px;
    font-size: 12px;
    line-height: 16px;
    text-align: center;
    border: 2px solid #fff;
  }

  #openCreateSubfolder:hover { transform: scale(1.1); }

  .subfolder-list { display: flex; flex-direction: column; gap: 10px; }
  .subfolder-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #fafafa;
    border: 1px solid #e5e7eb;
    border-radius: 10px;
    padding: 10px 12px;
  }

  .subfolder-item a {
    color: #111827;
    text-decoration: none;
    font-weight: 600;
    margin-right: 8px;
  }

  .subfolder-item button {
    border: 0;
    background: none;
    cursor: pointer;
    color: #ef4444;
    font-size: 16px;
    margin-left: 8px;
  }

  .subfolder-item button:hover { color: #dc2626; }

  .no-subfolders { color: #6b7280; font-size: 14px; line-height: 1.5; }

  .folder-content {
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex: 1;
  }

  .item-count {
    background: #e5e7eb;
    color: #374151;
    font-size: 11px;
    font-weight: 600;
    padding: 2px 8px;
    border-radius: 10px;
    min-width: 20px;
    text-align: center;
  }

  /* Main content */
  .panel {
    background: #fff;
    border: 1px solid #e7e8ef;
    border-radius: 10px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    padding: 20px;
    margin-bottom: 20px;
  }

  .meta { color: #374151; font-size: 15px; margin: 6px 0; }
  .meta strong { font-weight: 600; }

  /* Search Section at Top */
  .search-section {
    background: #fff;
    border: 1px solid #e7e8ef;
    border-radius: 10px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    padding: 16px;
    margin-bottom: 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
  }

  .search-form {
    display: flex;
    gap: 8px;
    align-items: center;
    flex: 1;
    min-width: 280px;
  }

  .search-form input[type="text"] {
    padding: 10px 14px;
    border: 1px solid #0d3f8a;
    border-radius: 8px;
    font-size: 14px;
    flex: 1;
    min-width: 200px;
  }

  .search-form button {
    padding: 10px 16px;
    background: #e5e7eb;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    color: #374151;
    white-space: nowrap;
    transition: 0.2s;
  }

  .search-form button:hover {
    background: #d1d5db;
  }

  .row-selector {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .row-selector label {
    font-weight: 600;
    color: #374151;
    font-size: 14px;
    white-space: nowrap;
  }

  .row-selector select {
    padding: 10px 14px;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    color: #374151;
    background: #fff;
    cursor: pointer;
    transition: 0.2s;
  }

  .row-selector select:hover {
    border-color: #2563eb;
  }

  @media (max-width: 768px) {
    .search-section {
      flex-direction: column;
      align-items: stretch;
    }
    .search-form {
      width: 100%;
    }
    .row-selector {
      justify-content: space-between;
    }
  }

  /* Upload Section with Block Style */
  .upload-section {
    background: #fafafa;
    border: 1px solid #e5e7eb;
    border-radius: 10px;
    padding: 16px;
    margin-bottom: 16px;
  }

  .upload-section label {
    display: block;
    font-weight: 600;
    color: #333;
    margin-bottom: 12px;
    font-size: 15px;
  }

  .upload-form {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .upload-form input[type="file"] {
    padding: 10px 12px;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    background: #fff;
    width: 100%;
    display: block;
  }

  .upload-form input[type="text"] {
    padding: 10px 12px;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    width: 100%;
    display: block;
  }

  .upload-form button {
    padding: 10px 20px;
    border: 0;
    background: #0d6efd;
    color: #fff;
    font-weight: 600;
    cursor: pointer;
    border-radius: 8px;
    white-space: nowrap;
    display: block;
    width: 100%;
  }

  .upload-form button:hover {
    background: #0b5ed7;
  }

  /* Upload loader */
  .upload-loader {
    display: none;
    text-align: center;
    margin-bottom: 12px;
    padding: 12px;
    background: #f0f9ff;
    border: 1px solid #bae6fd;
    border-radius: 8px;
  }

  .upload-loader.active {
    display: block;
  }

  .spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid #cbd5e1;
    border-top-color: #2563eb;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    vertical-align: middle;
    margin-right: 8px;
  }

  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }

  /* Pagination */
  .pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    margin: 15px 0 20px;
    gap: 14px;
  }

  .pagination a,
  .pagination span {
    padding: 8px 12px;
    border-radius: 6px;
    border: 1px solid #e6eefb;
    text-decoration: none;
  }

  .pagination a {
    color: #2563eb;
  }

  .pagination a:hover {
    background: #f0f9ff;
  }

  .pagination .current {
    background: #f8fafc;
    font-weight: 600;
    color: #1e40af;
  }

  .pagination .disabled {
    color: #94a3b8;
    border-color: #f1f5f9;
  }

  /* Table wrapper */
  .table-wrap {
    background: #fff;
    border: 1px solid #e5e7eb;
    border-radius: 10px;
    overflow: auto;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
  }

  table {
    width: 100%;
    border-collapse: collapse;
    table-layout: fixed;
    min-width: 700px;
  }

  thead th {
    background: linear-gradient(135deg, #2563eb 0%, #0a2f94 100%);
    color: #fff;
    padding: 12px;
    font-size: 14px;
    font-weight: 600;
    text-align: left;
  }

  tbody td {
    padding: 12px;
    border-top: 1px solid #edf0f5;
    font-size: 14px;
    vertical-align: middle;
  }

  tbody tr:nth-child(even) td {
    background: #f9fafb;
  }

  tbody tr:hover td {
    background: #f3f4f6;
  }

  .text-center {
    text-align: center;
  }

  .icon-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    border-radius: 6px;
    transition: 0.2s;
  }

  .icon-btn:hover {
    transform: translateY(-1px);
  }

  .icon-view {
    color: #0d6efd;
    background: #eef4ff;
  }

  .icon-edit {
    color: #f59e0b;
    background: #fff7ed;
  }

  .icon-delete {
    color: #fff;
    background: #dc3545;
  }

  .icon-delete:hover {
    background: #bb2d3b;
  }

  /* File name cell */
  .file-name {
    display: block;
    width: 100%;
    max-width: 100%;
    white-space: normal;
    word-break: break-word;
    overflow-wrap: anywhere;
    line-height: 1.35;
    margin: 0;
    padding: 0;
  }

  /* Shared popup styling */
  #createSubfolderModal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(17, 24, 39, 0.55);
    align-items: center;
    justify-content: center;
    z-index: 3000;
    backdrop-filter: blur(3px);
    animation: fadeIn 0.25s ease;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }

  .modal-card {
    background: #fff;
    border-radius: 16px;
    padding: 24px 28px;
    width: 400px;
    max-width: 90%;
    box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
    transform: scale(0.95);
    animation: popIn 0.25s ease forwards;
  }

  @keyframes popIn {
    to {
      transform: scale(1);
    }
  }

  .modal-card h3 {
    margin-top: 0;
    font-size: 20px;
    font-weight: 700;
    color: #111827;
  }

  .modal-card p {
    color: #6b7280;
    margin-bottom: 16px;
  }

  .modal-card input {
    width: 100%;
    padding: 10px;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    margin-bottom: 14px;
    font-size: 14px;
  }

  .modal-card .actions {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
  }

  .modal-card button {
    padding: 8px 16px;
    border-radius: 8px;
    cursor: pointer;
    border: none;
    font-weight: 600;
  }

  .btn-cancel {
    background: #e5e7eb;
    color: #111827;
  }

  .btn-create {
    background: #2563eb;
    color: #fff;
  }

  .btn-create:hover {
    background: #1d4ed8;
  }
</style>

<div class="page-wrap">
  <div class="top-bar">
    <a href="{% url 'drive_list' %}" class="back-link">‚Üê Back to Drive</a>
  </div>

  <div class="main-grid">
    <!-- LEFT: Subfolders -->
    <aside class="subfolder-panel">
      <div class="subfolder-header">
        <h3>Subfolders</h3>
        <button id="openCreateSubfolder"><i class="fa-solid fa-folder"></i></button>
      </div>

      <div class="subfolder-list">
        {% if subfolders %}
          {% for sub in subfolders %}
            <div class="subfolder-item">
              <div class="folder-content">
                <a href="{% url 'drive_detail' sub.id %}">üìÅ {{ sub.name }}</a>
                <span class="item-count">{{ sub.file_count }}</span>
              </div>

              <form method="POST" action="{% url 'subfolder_delete' sub.id %}"
                    onsubmit="return handleSubfolderDelete({{ sub.file_count }});">
                {% csrf_token %}
                <button type="submit" title="Delete {{ sub.name }}">üóëÔ∏è</button>
              </form>
            </div>
          {% endfor %}
        {% else %}
          <div class="no-subfolders">
            No subfolders yet.<br>Create one using the button above.
          </div>
        {% endif %}
      </div>
    </aside>

    <!-- RIGHT: Main Content -->
    <div>
      <div class="panel">
        <div class="meta"><strong>Folder:</strong> {{ folder.name }}</div>
        <div class="meta"><strong>Created:</strong> {{ folder.created_at|date:"Y-m-d" }}</div>
      </div>

      <!-- SEARCH SECTION AT TOP -->
      <div class="search-section">
        <div class="search-form">
          <input type="text" id="fileSearch" placeholder="üîç Search files...">
          <button id="clearSearch">Clear</button>
        </div>

        <div class="row-selector">
          <label for="rowCount">Show rows:</label>
          <select
            id="rowCount"
            onchange="location.href='?per_page=' + this.value + '{% if query %}&q={{ query|urlencode }}{% endif %}{% if request.GET.page %}&page=1{% endif %}'">
            <option value="10" {% if per_page == 10 or not per_page %}selected{% endif %}>10</option>
            <option value="15" {% if per_page == 15 %}selected{% endif %}>15</option>
            <option value="25" {% if per_page == 25 %}selected{% endif %}>25</option>
            <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
            <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
          </select>
        </div>
      </div>

      <!-- UPLOAD SECTION WITH BLOCK STYLE -->
      <div class="upload-section">
        <label for="fileUpload"><i class="fa-solid fa-upload"></i> Upload File (PDF, DOCX, TXT, XLSX, PPTX):</label>
        <form class="upload-form" method="POST" enctype="multipart/form-data">
          {% csrf_token %}
          <input type="file" id="fileUpload" name="fileUpload" accept=".pdf,.doc,.docx,.txt,.xls,.xlsx,.ppt,.pptx" required>
          <input type="text" id="customFileName" name="file_name" placeholder="Custom file name (optional)">
          <button type="submit">Upload</button>
        </form>
      </div>

      <!-- Upload loader -->
      <div id="uploadLoader" class="upload-loader">
        <span class="spinner"></span>
        <span style="color:#374151;font-size:14px;font-weight:500;">Uploading file...</span>
      </div>

      <!-- Pagination -->
      {% if paginator.num_pages > 1 %}
        <div class="pagination">
          {% if page_obj.has_previous %}
            <a href="?per_page={{ per_page|default:'10' }}&page={{ page_obj.previous_page_number }}{% if query %}&q={{ query|urlencode }}{% endif %}">Previous</a>
          {% else %}
            <span class="disabled">Previous</span>
          {% endif %}

          <span class="current">Page {{ page_obj.number }} of {{ paginator.num_pages }}</span>

          {% if page_obj.has_next %}
            <a href="?per_page={{ per_page|default:'10' }}&page={{ page_obj.next_page_number }}{% if query %}&q={{ query|urlencode }}{% endif %}">Next</a>
          {% else %}
            <span class="disabled">Next</span>
          {% endif %}
        </div>
      {% endif %}

      <div class="table-wrap">
        <table>
          <colgroup>
            <col style="width: 60px;">
            <col style="width: 140px;">
            <col>
            <col style="width: 80px;">
            <col style="width: 80px;">
            <col style="width: 80px;">
            <col style="width: 80px;">
          </colgroup>
          <thead>
            <tr>
              <th>SL No</th>
              <th>Date</th>
              <th>File Name</th>
              <th class="text-center">Download</th>
              <th class="text-center">View</th>
              <th class="text-center">Edit</th>
              <th class="text-center">Delete</th>
            </tr>
          </thead>
          <tbody>
            {% for f in files %}
              <tr>
                <td>{{ forloop.counter }}</td>
                <td>{{ f.uploaded_at|date:"Y-m-d" }}</td>

                <td>
                  <div class="file-name" title="{% if f.file_name %}{{ f.file_name }}{% else %}{{ f.file.name|slice:'7:' }}{% endif %}">
                    {% if f.file_name %}
                      {{ f.file_name }}
                    {% else %}
                      {{ f.file.name|slice:"7:" }}
                    {% endif %}
                  </div>
                </td>

                <td class="text-center"><a class="icon-btn icon-view" href="{% url 'file_download' f.id %}"><i class="fa-solid fa-download"></i></a></td>
                <td class="text-center"><a class="icon-btn icon-view" href="{% url 'file_preview' f.id %}" target="_blank"><i class="fa-solid fa-eye"></i></a></td>
                <td class="text-center">
                  <a href="{% url 'file_edit_page' f.id %}" class="icon-btn icon-edit" title="Edit file name">
                    <i class="fa-solid fa-pen-to-square"></i>
                  </a>
                </td>
                <td class="text-center"><a class="icon-btn icon-delete" href="{% url 'file_delete' f.id %}" onclick="return confirm('Delete this file?');"><i class="fa-solid fa-trash"></i></a></td>
              </tr>
            {% empty %}
              <tr><td colspan="7" class="text-center" style="color:#6b7280;padding:20px;">No files yet.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Create Subfolder Modal -->
<div id="createSubfolderModal">
  <div class="modal-card">
    <h3>Create New Subfolder</h3>
    <p>Enter a name for your new subfolder inside "{{ folder.name }}"</p>
    <form method="POST" action="{% url 'subfolder_add' folder.id %}">
      {% csrf_token %}
      <input type="text" name="folderName" placeholder="Subfolder name" required>
      <div class="actions">
        <button type="button" class="btn-cancel" id="cancelCreateSubfolder">Cancel</button>
        <button type="submit" class="btn-create">Create</button>
      </div>
    </form>
  </div>
</div>

<script>
  // Subfolder modal logic
  const subModal = document.getElementById('createSubfolderModal');
  document.getElementById('openCreateSubfolder').onclick = () => subModal.style.display = 'flex';
  document.getElementById('cancelCreateSubfolder').onclick = () => subModal.style.display = 'none';
  subModal.onclick = e => { if (e.target === subModal) subModal.style.display = 'none'; };

  // Subfolder deletion logic
  function handleSubfolderDelete(fileCount) {
    if (fileCount > 0) {
      alert("üö´ This folder cannot be deleted because it contains files.\n\nPlease remove all files first.");
      return false;
    } else {
      return confirm("Are you sure you want to delete this empty subfolder?");
    }
  }

  // Upload inline loader
  document.querySelector('.upload-form').addEventListener('submit', function() {
    const fileInput = document.getElementById('fileUpload');
    if (fileInput.files.length > 0) {
      document.getElementById('uploadLoader').classList.add('active');
    }
  });

  // Auto-fill custom name from selected file (without extension)
  (function() {
    const fileInput = document.getElementById('fileUpload');
    const customInput = document.getElementById('customFileName');

    if (fileInput && customInput) {
      fileInput.addEventListener('change', () => {
        if (!fileInput.files || !fileInput.files[0]) return;

        const fullName = fileInput.files[0].name;
        const baseName = fullName.replace(/\.[^/.]+$/, '');
        customInput.value = baseName;
      });
    }
  })();

  // File search filter with clear button
  const searchInput = document.getElementById("fileSearch");
  const clearButton = document.getElementById("clearSearch");
  const rows = document.querySelectorAll("tbody tr");

  searchInput.addEventListener("input", function() {
    const query = this.value.toLowerCase().trim();

    rows.forEach(row => {
      const fileNameCell = row.querySelector(".file-name");
      if (!fileNameCell) return;
      const text = fileNameCell.textContent.toLowerCase();
      row.style.display = text.includes(query) ? "" : "none";
    });
  });

  clearButton.addEventListener("click", function() {
    searchInput.value = "";
    rows.forEach(row => row.style.display = "");
    searchInput.focus();
  });
</script>

{% endblock %}