{% extends "base.html" %}
{% block content %}
{% load static %}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
  body {
    background: #fff;
    color: #2b2f36;
    font-family: Arial, Helvetica, sans-serif;
  }

  .page-wrap {
    max-width: 1200px;
    margin: 28px auto 60px;
    padding: 0 16px;
  }

  .top-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
  }

  .back-link {
    display: inline-block;
    padding: 10px 16px;
    background: #332f89;
    color: #fff;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 600;
  }

  .back-link:hover { background: #271cbf; }

  /* Grid layout */
  .main-grid {
    display: grid;
    grid-template-columns: 180px 1fr;
    gap: 24px;
    align-items: start;
  }

  @media (max-width: 992px) {
    .main-grid { grid-template-columns: 1fr; }
  }

  /* Subfolder panel */
  .subfolder-panel {
    background: #fff;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    padding: 18px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    height: fit-content;
    margin-left: -100px;
  }

  .subfolder-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
  }

  .subfolder-header h3 {
    font-size: 16px;
    font-weight: 700;
    color: #1f2937;
    margin: 0;
  }

  #openCreateSubfolder {
    border: none;
    background: none;
    cursor: pointer;
    position: relative;
    width: 34px;
    height: 34px;
    border-radius: 8px;
    transition: all 0.3s ease;
  }

  #openCreateSubfolder i.fa-folder {
    font-size: 24px;
    color: #2563eb;
  }

  #openCreateSubfolder::after {
    content: "+";
    position: absolute;
    right: 0;
    bottom: 0;
    background: #10b981;
    color: #fff;
    border-radius: 50%;
    width: 16px;
    height: 16px;
    font-size: 12px;
    line-height: 16px;
    text-align: center;
    border: 2px solid #fff;
  }

  #openCreateSubfolder:hover { transform: scale(1.1); }

  .subfolder-list { display: flex; flex-direction: column; gap: 10px; }
  .subfolder-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #fafafa;
    border: 1px solid #e5e7eb;
    border-radius: 10px;
    padding: 10px 12px;
  }

  .subfolder-item a {
    color: #111827;
    text-decoration: none;
    font-weight: 600;
    flex: 1;
  }

  .subfolder-item button {
    border: 0;
    background: none;
    cursor: pointer;
    color: #ef4444;
    font-size: 16px;
  }

  .subfolder-item button:hover { color: #dc2626; }

  .no-subfolders { color: #6b7280; font-size: 14px; line-height: 1.5; }

  /* Main content */
  .panel {
    background: #fff;
    border: 1px solid #e7e8ef;
    border-radius: 10px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    padding: 20px;
    margin-bottom: 20px;
  }

  .meta { color: #374151; font-size: 15px; margin: 6px 0; }
  .meta strong { font-weight: 600; }

  /* Upload box layout */
  .upload-box {
    background: #fafafa;
    border: 1px solid #e5e7eb;
    border-radius: 10px;
    padding: 16px;
    display: grid;
    gap: 12px;
    /* use two columns: inputs and fixed area for button */
    grid-template-columns: 1fr 220px;
    align-items: center;
  }

  @media (max-width: 640px) {
    .upload-box { grid-template-columns: 1fr; }
    .upload-box .controls-row { display: grid; grid-template-columns: 1fr 120px; gap: 8px; width: 100%; }
  }

  .upload-box label { grid-column: 1 / -1; font-weight: 600; color: #333; margin-bottom: 6px; }
  .upload-box input, .upload-box button {
    border-radius: 8px; font-size: 14px;
  }

  /* style file and text inputs to not expand the grid */
  .upload-box .controls-row {
    grid-column: 1 / -1;
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .upload-box input[type="file"] {
    padding: 10px;
    border: 1px solid #d1d5db;
    min-width: 0; /* important to prevent overflowing the flex container */
    flex: 0 1 320px; /* allow shrink */
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .upload-box input[name="file_name"] {
    padding: 10px;
    border: 1px solid #d1d5db;
    min-width: 0;
    flex: 1 1 auto;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  /* Make the upload button small and fixed width */
  .upload-box button {
    padding: 8px 12px;
    border: 0;
    background: #0d6efd;
    color: #fff;
    font-weight: 600;
    cursor: pointer;
    width: 120px;
    white-space: nowrap;
  }
  .upload-box button:hover { background: #0b5ed7; }

  /* Table wrapper */
  .table-wrap {
    background: #fff;
    border: 1px solid #e5e7eb;
    border-radius: 10px;
    overflow: auto; /* allow horizontal scroll if absolutely necessary */
    box-shadow: 0 2px 8px rgba(0,0,0,0.04);
  }

  /* Use fixed table layout so columns won't stretch with long content */
  table {
    width: 100%;
    border-collapse: collapse;
    table-layout: fixed;
    min-width: 700px; /* keep a reasonable minimum so small screens get a scrollbar */
  }

  thead th {
    background: linear-gradient(135deg, #2563eb 0%, #0a2f94 100%);
    color: #fff;
    padding: 12px;
    font-size: 14px;
    font-weight: 600;
    text-align: left;
  }

  tbody td { padding: 12px; border-top: 1px solid #edf0f5; font-size: 14px; vertical-align: middle; }
  tbody tr:nth-child(even) td { background: #f9fafb; }
  /* Keep hover background but it won't change layout */
  tbody tr:hover td { background: #f3f4f6; }
  .text-center { text-align: center; }

  .icon-btn { display: inline-flex; align-items: center; justify-content: center; width: 32px; height: 32px; border-radius: 6px; transition: 0.2s; }
  .icon-btn:hover { transform: translateY(-1px); }

  .icon-view { color: #0d6efd; background: #eef4ff; }
  .icon-edit { color: #f59e0b; background: #fff7ed; }
  .icon-delete { color: #fff; background: #dc3545; }
  .icon-delete:hover { background: #bb2d3b; }

  /* File name cell: wrap long names line-by-line (no hover reflow) */
  .file-name {
    display: block;
    width: 100%;
    max-width: 100%;
    white-space: normal;          /* allow wrapping */
    word-break: break-word;      /* break long continuous strings */
    overflow-wrap: anywhere;     /* supports breaking at any point if needed */
    line-height: 1.35;
    margin: 0;
    padding: 0;
  }

  /* remove hover expansion to prevent shaking (no :hover style here) */

  /* Shared popup styling */
  #createSubfolderModal, #renameModal {
    display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(17,24,39,0.55); align-items: center; justify-content: center;
    z-index: 3000; backdrop-filter: blur(3px); animation: fadeIn .25s ease;
  }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

  .modal-card {
    background: #fff; border-radius: 16px; padding: 24px 28px; width: 400px; max-width: 90%;
    box-shadow: 0 15px 40px rgba(0,0,0,0.15); transform: scale(0.95);
    animation: popIn .25s ease forwards;
  }
  @keyframes popIn { to { transform: scale(1); } }

  .modal-card h3 { margin-top: 0; font-size: 20px; font-weight: 700; color: #111827; }
  .modal-card p { color: #6b7280; margin-bottom: 16px; }
  .modal-card input {
    width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px;
    margin-bottom: 14px; font-size: 14px;
  }
  .modal-card .actions { display: flex; justify-content: flex-end; gap: 10px; }
  .modal-card button {
    padding: 8px 16px; border-radius: 8px; cursor: pointer; border: none; font-weight: 600;
  }
  .btn-cancel { background: #e5e7eb; color: #111827; }
  .btn-create { background: #2563eb; color: #fff; }
  .btn-create:hover { background: #1d4ed8; }
</style>

<div class="page-wrap">
  <div class="top-bar">
    <a href="{% url 'drive_list' %}" class="back-link">‚Üê Back to Drive</a>
  </div>

  <div class="main-grid">
    <!-- LEFT: Subfolders -->
    <aside class="subfolder-panel">
      <div class="subfolder-header">
        <h3>Subfolders</h3>
        <button id="openCreateSubfolder"><i class="fa-solid fa-folder"></i></button>
      </div>

      <div class="subfolder-list">
        {% if subfolders %}
          {% for sub in subfolders %}
            <div class="subfolder-item">
              <a href="{% url 'drive_detail' sub.id %}">üìÅ {{ sub.name }}</a>
              <form method="POST" action="{% url 'subfolder_delete' sub.id %}" 
                    onsubmit="return handleSubfolderDelete({{ sub.files.count }});">
                {% csrf_token %}
                <button type="submit" title="Delete {{ sub.name }}">üóëÔ∏è</button>
              </form>
            </div>
          {% endfor %}
        {% else %}
          <div class="no-subfolders">No subfolders yet.<br>Create one using the button above.</div>
        {% endif %}
      </div>
    </aside>

    <!-- RIGHT: Main Content -->
    <div>
      <div class="panel">
        <div class="meta"><strong>Folder:</strong> {{ folder.name }}</div>
        <div class="meta"><strong>Created:</strong> {{ folder.created_at|date:"Y-m-d" }}</div>

        <form class="upload-box" method="POST" enctype="multipart/form-data">
          {% csrf_token %}
          <label for="fileUpload"><i class="fa-solid fa-upload"></i> Upload File (PDF, DOCX, TXT, XLSX, PPTX):</label>

          <!-- Controls row: file input + optional custom filename + button -->
          <div class="controls-row">
            <input type="file" id="fileUpload" name="fileUpload" accept=".pdf,doc,docx,txt,xls,xlsx,ppt,pptx" required>
            <input type="text" name="file_name" placeholder="Custom file name (optional)">
            <button type="submit">Upload</button>
          </div>
        </form>
      </div>

      <div class="table-wrap">
        <table>
          <!-- fixed column widths using colgroup so layout stays stable -->
          <colgroup>
            <col style="width: 60px;">
            <col style="width: 140px;">
            <col> <!-- file name takes remaining space -->
            <col style="width: 80px;">
            <col style="width: 80px;">
            <col style="width: 80px;">
            <col style="width: 80px;">
          </colgroup>
          <thead>
            <tr>
              <th>SL No</th><th>Date</th><th>File Name</th>
              <th class="text-center">Download</th>
              <th class="text-center">View</th>
              <th class="text-center">Edit</th>
              <th class="text-center">Delete</th>
            </tr>
          </thead>
          <tbody>
            {% for f in files %}
            <tr>
              <td>{{ forloop.counter }}</td>
              <td>{{ f.uploaded_at|date:"Y-m-d" }}</td>

              <!-- file name cell: use .file-name and allow multi-line wrapping -->
              <td>
                <div class="file-name" title="{% if f.file_name %}{{ f.file_name }}{% else %}{{ f.file.name|slice:'7:' }}{% endif %}">
                  {% if f.file_name %}
                    {{ f.file_name }}
                  {% else %}
                    {{ f.file.name|slice:"7:" }}
                  {% endif %}
                </div>
              </td>

              <td class="text-center"><a class="icon-btn icon-view" href="{% url 'file_download' f.id %}"><i class="fa-solid fa-download"></i></a></td>
              <td class="text-center"><a class="icon-btn icon-view" href="{% url 'file_preview' f.id %}" target="_blank"><i class="fa-solid fa-eye"></i></a></td>
              <td class="text-center"><a href="javascript:void(0);" class="icon-btn icon-edit" onclick="openRenameModal({{ f.id }}, '{{ f.file_name|default:f.file.name|escapejs }}')"><i class="fa-solid fa-pen-to-square"></i></a></td>
              <td class="text-center"><a class="icon-btn icon-delete" href="{% url 'file_delete' f.id %}" onclick="return confirm('Delete this file?');"><i class="fa-solid fa-trash"></i></a></td>
            </tr>
            {% empty %}
            <tr><td colspan="7" class="text-center" style="color:#6b7280;padding:20px;">No files yet.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Create Subfolder Modal -->
<div id="createSubfolderModal">
  <div class="modal-card">
    <h3>Create New Subfolder</h3>
    <p>Enter a name for your new subfolder inside ‚Äú{{ folder.name }}‚Äù</p>
    <form method="POST" action="{% url 'subfolder_add' folder.id %}">
      {% csrf_token %}
      <input type="text" name="folderName" placeholder="Subfolder name" required>
      <div class="actions">
        <button type="button" class="btn-cancel" id="cancelCreateSubfolder">Cancel</button>
        <button type="submit" class="btn-create">Create</button>
      </div>
    </form>
  </div>
</div>

<!-- Rename (Edit) Modal -->
<div id="renameModal">
  <div class="modal-card">
    <h3>Rename File</h3>
    <p id="currentFileLabel" style="margin-bottom:8px;color:#6b7280;"></p>
    <form id="renameForm" method="POST" action="">
      {% csrf_token %}
      <input type="text" id="newFileName" name="file_name" placeholder="Enter new name" required>
      <div class="actions">
        <button type="button" class="btn-cancel" onclick="closeRenameModal()">Cancel</button>
        <button type="submit" class="btn-create">Save</button>
      </div>
    </form>
  </div>
</div>

<script>
  // Subfolder modal logic
  const subModal = document.getElementById('createSubfolderModal');
  document.getElementById('openCreateSubfolder').onclick = () => subModal.style.display = 'flex';
  document.getElementById('cancelCreateSubfolder').onclick = () => subModal.style.display = 'none';
  subModal.onclick = e => { if(e.target===subModal) subModal.style.display='none'; };

  // Rename modal logic
  const renameModal = document.getElementById('renameModal');
  const renameForm = document.getElementById('renameForm');
  const currentLabel = document.getElementById('currentFileLabel');
  const newNameInput = document.getElementById('newFileName');
  const FILE_EDIT_BASE = "{% url 'file_edit' 0 %}";

  function openRenameModal(fileId, currentName) {
    renameForm.action = FILE_EDIT_BASE.replace(/0\/?$/, fileId + "/");
    currentLabel.textContent = "Current name: " + currentName;
    newNameInput.value = currentName;
    renameModal.style.display = 'flex';
    setTimeout(() => newNameInput.focus(), 50);
  }

  function closeRenameModal() {
    renameModal.style.display = 'none';
  }

  renameModal.addEventListener('click', e => {
    if (e.target === renameModal) closeRenameModal();
  });

  // Subfolder deletion logic (keeps your previous behavior)
  function handleSubfolderDelete(fileCount) {
    if (fileCount > 0) {
      alert("üö´ This folder cannot be deleted because it contains files.\n\nPlease remove all files first.");
      return false;
    } else {
      return confirm("Are you sure you want to delete this empty subfolder?");
    }
  }

  // No extra JS needed for file-name display: CSS handles multi-line wrapping.
  document.addEventListener('DOMContentLoaded', function() {
    // nothing required here for file names
  });
</script>

{% endblock %}
