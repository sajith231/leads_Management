{% extends "base.html" %}
{% block content %}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
  body{background:#fff;color:#2b2f36;font-family:Arial,Helvetica,sans-serif;}

  .page-wrap{max-width:1100px;margin:28px auto 60px;padding:0 16px;}
  .page-title{text-align:center;font-size:28px;font-weight:700;margin-bottom:22px;}

  .top-bar{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;position:relative;}
  .back-link{display:inline-block;padding:10px 16px;background:#332f89;color:#fff;border-radius:8px;text-decoration:none;font-weight:600;}
  .back-link:hover{background:#271cbf;}

  /* Folder picker in top bar */
  .folder-picker{position:relative;}
  .icon-only{
    display:inline-flex;align-items:center;justify-content:center;
    width:44px;height:44px;border:1px solid #e5e7eb;border-radius:12px;
    background:#fff;cursor:pointer;font-size:18px;transition:.15s;
  }
  .icon-only:hover{transform:translateY(-1px);box-shadow:0 2px 8px rgba(0,0,0,.06);}
  .icon-only:focus{outline:2px solid #0d6efd;outline-offset:2px;}

  /* Emoji + counter */
  .folder-btn{position:relative;font-size:24px;line-height:1;}
  .badge{
    position:absolute;top:-6px;right:-6px;
    background:#dc3545;color:#fff;font-size:12px;font-weight:700;
    padding:2px 6px;border-radius:999px;line-height:1;
    box-shadow:0 2px 6px rgba(0,0,0,.2);
    min-width:18px;text-align:center;
  }

  .dropdown{
    position:absolute;right:0;top:52px;min-width:300px;max-height:360px;overflow:auto;
    background:#fff;border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 10px 24px rgba(0,0,0,.12);
    padding:8px;display:none;z-index:1001;
  }
  .dropdown.show{display:block;}
  .dropdown-head{
    font-weight:700;color:#374151;padding:6px 8px 8px;border-bottom:1px solid #f1f5f9;margin-bottom:6px;
  }
  .dropdown ul{list-style:none;margin:0;padding:0;}
  .dropdown li{padding:0;margin:0;border-radius:8px;}
  .dropdown li:hover{background:#f9fafb;}
  .dropdown .empty{color:#6b7280;font-size:14px;padding:10px;}
  .dropdown-item{
    display:flex;align-items:center;justify-content:space-between;gap:10px;
    padding:6px 8px;
  }
  .dropdown a{
    display:flex;gap:8px;align-items:center;text-decoration:none;color:#111827;font-size:14px;
    flex:1 1 auto;min-width:0;
  }
  .dropdown a .name{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
  .dropdown .delete-sub-btn{
    border:none;background:none;cursor:pointer;font-size:16px;line-height:1;
    padding:6px;border-radius:6px;
  }
  .dropdown .delete-sub-btn:hover{color:#dc3545;background:#fff1f2;}

  .panel{background:#fff;border:1px solid #e7e8ef;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,.04);padding:20px;margin-bottom:20px;}
  .meta{color:#374151;font-size:15px;margin:6px 0;}
  .meta strong{font-weight:600;}

  .action-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-top:14px;}
  @media (max-width:820px){.action-grid{grid-template-columns:1fr;}}

  .subfolder-box,.upload-box{
    background:#fafafa;border:1px solid #e5e7eb;border-radius:10px;
    padding:16px;display:grid;gap:12px;grid-template-columns:1fr auto;align-items:center;
  }
  .subfolder-box label,.upload-box label{grid-column:1 / -1;font-weight:600;color:#333;margin-bottom:6px;}
  .subfolder-box input[type="text"],.upload-box input[type="file"],.upload-box input[name="file_name"]{
    padding:10px;border:1px solid #d1d5db;border-radius:8px;font-size:14px;
  }
  .subfolder-box button,.upload-box button{
    padding:10px 16px;border:0;border-radius:8px;background:#0d6efd;color:#fff;font-weight:600;cursor:pointer;
  }
  .subfolder-box button:hover,.upload-box button:hover{background:#0b5ed7;}

  .table-wrap{background:#fff;border:1px solid #e5e7eb;border-radius:10px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,.04);}
  table{width:100%;border-collapse:collapse;}
  thead th {
  background: linear-gradient(135deg, #2563eb 0%, #0a2f94 100%);
  color:#fff;
  padding:12px;
  font-size:14px;
  font-weight:600;
  text-align:left;
}

  tbody td{padding:12px;border-top:1px solid #edf0f5;font-size:14px;}
  tbody tr:nth-child(even) td{background:#f9fafb;}
  tbody tr:hover td{background:#f3f4f6;}

  .text-center{text-align:center;}
  .icon-btn{display:inline-flex;align-items:center;justify-content:center;width:32px;height:32px;border-radius:6px;text-decoration:none;transition:.2s;}
  .icon-btn:hover{transform:translateY(-1px);}
  .icon-view{color:#0d6efd;background:#eef4ff;}
  .icon-edit{color:#f59e0b;background:#fff7ed;}
  .icon-delete{color:#fff;background:#dc3545;}
  .icon-delete:hover{background:#bb2d3b;}

  /* Modal */
  .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);align-items:center;justify-content:center;z-index:1000;}
  .modal-card{background:#fff;border-radius:12px;max-width:420px;width:92%;padding:20px;box-shadow:0 8px 20px rgba(0,0,0,.2);}
  .modal-title{font-size:18px;font-weight:700;margin-bottom:10px;}
  .modal-actions{display:flex;justify-content:flex-end;gap:10px;margin-top:14px;}
  .btn{padding:8px 14px;border:0;border-radius:8px;cursor:pointer;font-weight:600;}
  .btn-secondary{background:#6c757d;color:#fff;}
  .btn-secondary:hover{background:#5a6268;}
  .btn-primary{background:#0d6efd;color:#fff;}
  .btn-primary:hover{background:#0b5ed7;}

 .upload-box button {
  padding:6px 10px;
  font-size:13px;
  border-radius:8px;
  width:auto;       /* prevents full stretch */
  min-width:100px;  /* optional fixed min width */
}


</style>

<div class="page-wrap">
  <div class="top-bar">
    <a href="{% url 'drive_list' %}" class="back-link">‚Üê Back to Drive</a>

    <!-- Folder icon button with badge + dropdown -->
    <div class="folder-picker">
      <button id="subfolderToggle" class="icon-only folder-btn" aria-haspopup="true" aria-expanded="false" aria-controls="subfolderMenu" title="Select subfolder">
        üìÇ
        {% if subfolders %}
          <span class="badge">{{ subfolders|length }}</span>
        {% endif %}
      </button>

      <div id="subfolderMenu" class="dropdown" role="menu" aria-hidden="true">
        <div class="dropdown-head">Subfolders</div>
        <ul>
          {% if subfolders %}
            {% for sub in subfolders %}
            <li>
              <div class="dropdown-item">
                <a role="menuitem" href="{% url 'drive_detail' sub.id %}" title="Open {{ sub.name }}">
                  üìÅ <span class="name">{{ sub.name }}</span>
                </a>
                <form method="POST" action="{% url 'subfolder_delete' sub.id %}" onsubmit="return confirm('Delete this subfolder?');">
                  {% csrf_token %}
                  <button type="submit" class="delete-sub-btn" title="Delete {{ sub.name }}">üóëÔ∏è</button>
                </form>
              </div>
            </li>
            {% endfor %}
          {% else %}
            <li class="empty">No subfolders</li>
          {% endif %}
        </ul>
      </div>
    </div>
  </div>

  <h1 class="page-title">Folder Details</h1>

  <div class="panel">
    <div class="meta"><strong>Folder:</strong> {{ folder.name }}</div>
    <div class="meta"><strong>Created:</strong> {{ folder.created_at|date:"Y-m-d" }}</div>

    <div class="action-grid">
      <!-- Create Subfolder -->
      <form class="subfolder-box" method="POST" action="{% url 'subfolder_add' folder.id %}">
        {% csrf_token %}
        <label><i class="fa-solid fa-folder-plus"></i> Create a subfolder inside ‚Äú{{ folder.name }}‚Äù</label>
        <input type="text" name="folderName" placeholder="Enter subfolder name" required>
        <button type="submit">Create Subfolder</button>
      </form>

      <!-- Upload -->
      <form class="upload-box" method="POST" enctype="multipart/form-data">
        {% csrf_token %}
        <label for="fileUpload"><i class="fa-solid fa-upload"></i> Upload File (PDF, DOCX, TXT, XLSX, PPTX):</label>
        <input type="file" id="fileUpload" name="fileUpload" accept=".pdf,.doc,.docx,.txt,.xls,.xlsx,.ppt,.pptx" required>

        <!-- New custom name input -->
        <input type="text" name="file_name" placeholder="Custom file name (optional)">

        <button type="submit">Upload</button>
      </form>
    </div>
  </div>

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>SL No</th>
          <th>Date</th>
          <th>File Name</th>
          <th class="text-center">View</th>
          <th class="text-center">Edit</th>
          <th class="text-center">Delete</th>
        </tr>
      </thead>
      <tbody>
        {% for f in files %}
        <tr>
          <td data-label="SL No">{{ forloop.counter }}</td>
          <td data-label="Date">{{ f.uploaded_at|date:"Y-m-d" }}</td>
          <td data-label="File Name">{% if f.file_name %}{{ f.file_name }}{% else %}{{ f.file.name|slice:"7:" }}{% endif %}</td>

          <td data-label="View" class="text-center">
            <a class="icon-btn icon-view" href="{% url 'file_preview' f.id %}" target="_blank" title="Open file">
              <i class="fa-solid fa-eye"></i>
            </a>
          </td>

          <td data-label="Edit" class="text-center">
      <a href="javascript:void(0);"
        class="icon-btn icon-edit"
        title="Rename file"
        data-filename="{% if f.file_name %}{{ f.file_name|escapejs }}{% else %}{{ f.file.name|slice:'7:'|escapejs }}{% endif %}"
        onclick="openRenameModal({{ f.id }}, this.dataset.filename)">
        <i class="fa-solid fa-pen-to-square"></i>
      </a>
</td>


          <td data-label="Delete" class="text-center">
            <a class="icon-btn icon-delete" href="{% url 'file_delete' f.id %}" onclick="return confirm('Delete this file?');" title="Delete">
              <i class="fa-solid fa-trash"></i>
            </a>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="6" class="text-center" style="color:#6b7280;padding:20px;">No files yet. Upload one above.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Rename Modal -->
<div id="renameModal" class="modal" aria-hidden="true">
  <div class="modal-card">
    <div class="modal-title">Rename File</div>
    <p id="currentFileLabel" style="color:#6b7280;margin:0 0 12px;"></p>
    <form id="renameForm" method="POST" action="">
      {% csrf_token %}
      <input type="text" id="newFileName" name="file_name" placeholder="Enter new file name"
             style="width:100%;padding:10px;border:1px solid #d1d5db;border-radius:8px;" required>
      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" onclick="closeRenameModal()">Cancel</button>
        <button type="submit" class="btn btn-primary">Save</button>
      </div>
    </form>
  </div>
</div>

<script>
  /* Rename modal logic */
  const FILE_EDIT_BASE = "{% url 'file_edit' 0 %}";
  function openRenameModal(fileId, currentName) {
    const modal = document.getElementById('renameModal');
    const input = document.getElementById('newFileName');
    const label = document.getElementById('currentFileLabel');
    const form = document.getElementById('renameForm');
    form.action = FILE_EDIT_BASE.replace(/0\/?$/, fileId + "/");
    label.textContent = "Current name: " + currentName;
    input.value = currentName;
    modal.style.display = 'flex';
    modal.setAttribute('aria-hidden','false');
    setTimeout(()=>input.focus(),50);
  }
  function closeRenameModal(){
    const modal = document.getElementById('renameModal');
    modal.style.display = 'none';
    modal.setAttribute('aria-hidden','true');
  }
  document.getElementById('renameModal').addEventListener('click',function(e){ if(e.target===this) closeRenameModal(); });
  document.addEventListener('keydown',function(e){ if(e.key==='Escape') closeRenameModal(); });

  /* Subfolder dropdown toggle */
  (function(){
    const toggle = document.getElementById('subfolderToggle');
    const menu = document.getElementById('subfolderMenu');
    if(!toggle || !menu) return;

    function openMenu(){
      menu.classList.add('show');
      menu.setAttribute('aria-hidden','false');
      toggle.setAttribute('aria-expanded','true');
    }
    function closeMenu(){
      menu.classList.remove('show');
      menu.setAttribute('aria-hidden','true');
      toggle.setAttribute('aria-expanded','false');
    }

    toggle.addEventListener('click',function(e){
      e.stopPropagation();
      if(menu.classList.contains('show')){ closeMenu(); } else { openMenu(); }
    });

    document.addEventListener('click',function(e){
      if(menu.classList.contains('show') && !menu.contains(e.target) && e.target !== toggle){ closeMenu(); }
    });

    document.addEventListener('keydown',function(e){
      if(e.key==='Escape') closeMenu();
    });
  })();
</script>

{% endblock %}
