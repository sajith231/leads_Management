{% extends "base.html" %}
{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
  .page-wrap { max-width: 1200px; margin: 28px auto 60px; }
  .top-bar { display:flex; justify-content:flex-start; margin-bottom: 10px; }
  .back-link { display:inline-block; padding:8px 14px; background:#271cbf; color:#fff; border-radius:8px; text-decoration:none; }

  .main-grid {
    display: grid;
    grid-template-columns: 280px 1fr;
    gap: 16px;
  }
  @media (max-width: 960px){ .main-grid { grid-template-columns: 1fr; } }

  /* Subfolder panel */
  .subfolder-panel {
    background: #fff; border:1px solid #e7e8ef; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,.04);
    padding: 14px;
  }
  .subfolder-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:10px; }
  .subfolder-header h3 { margin:0; font-size:16px; }
  .subfolder-header button { border:0; background:#0d6efd; color:#fff; border-radius:8px; padding:6px 10px; cursor:pointer; }
  .subfolder-list { display:flex; flex-direction:column; gap:10px; }
  .subfolder-item {
    display:flex; align-items:center; justify-content:space-between;
    background:#fafafa; border:1px solid #e5e7eb; border-radius:10px; padding:10px 12px;
  }
  .subfolder-item a { color:#111827; text-decoration:none; font-weight:600; margin-right:8px; }
  .folder-content { display:flex; align-items:center; gap:8px; }
  .item-count { background:#eef2ff; color:#3730a3; font-weight:700; padding:2px 8px; border-radius:999px; }

  .no-subfolders { color:#6b7280; font-size:14px; line-height:1.5; }

  /* Main content panel */
  .panel {
    background:#fff; border:1px solid #e7e8ef; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,.04);
    padding:20px; margin-bottom:20px;
  }
  .meta { color:#374151; font-size:15px; margin:6px 0; }
  .meta strong { font-weight:600; }

  /* Search Section at Top */
  .search-section {
    background:#fff; border:1px solid #e7e8ef; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,.04);
    padding:16px; margin-bottom:16px;
    display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap;
  }
  .search-form { display:flex; gap:8px; align-items:center; flex:1; min-width:280px; }
  .search-form input[type="text"] { 
    padding:10px 14px; border:1px solid #0d3f8a; border-radius:8px; font-size:14px; 
    flex:1; min-width:200px;
  }
  .search-form button { 
    padding:10px 16px; background:#0d6efd; border:none; border-radius:8px; 
    font-weight:600; cursor:pointer; color:#fff; white-space:nowrap;
  }
  .search-form button:hover { background:#0b5ed7; }
  .search-form a { 
    padding:10px 16px; background:#e5e7eb; border-radius:8px; 
    font-weight:600; color:#374151; text-decoration:none; white-space:nowrap;
  }
  .search-form a:hover { background:#d1d5db; }
  
  .row-selector { display:flex; align-items:center; gap:10px; }
  .row-selector label { font-weight:600; color:#374151; font-size:14px; white-space:nowrap; }
  .row-selector select {
    padding:10px 14px; border:1px solid #d1d5db; border-radius:8px; font-size:14px; 
    font-weight:600; color:#374151; background:#fff; cursor:pointer; transition:.2s;
  }
  .row-selector select:hover { border-color:#2563eb; }

  @media (max-width: 768px) {
    .search-section { flex-direction:column; align-items:stretch; }
    .search-form { width:100%; }
    .row-selector { justify-content:space-between; }
  }

  /* Upload Section with Block Style */
  .upload-section {
    background:#fafafa; border:1px solid #e5e7eb; border-radius:10px; padding:16px;
    margin-bottom:16px;
  }
  .upload-section label { 
    display:block; font-weight:600; color:#333; margin-bottom:12px; font-size:15px;
  }
  .upload-form {
    display:flex; flex-direction:column; gap:12px;
  }
  .upload-form input[type="file"] {
    padding:10px 12px; border:1px solid #d1d5db; border-radius:8px; 
    background:#fff; width:100%; display:block;
  }
  .upload-form input[type="text"] {
    padding:10px 12px; border:1px solid #d1d5db; border-radius:8px; 
    width:100%; display:block;
  }
  .upload-form button {
    padding:10px 20px; border:0; background:#0d6efd; color:#fff; 
    font-weight:600; cursor:pointer; border-radius:8px; white-space:nowrap;
    display:block; width:100%;
  }
  .upload-form button:hover { background:#0b5ed7; }

  /* Upload loader */
  .upload-loader {
    display:none; text-align:center; margin-bottom:12px;
    padding:12px; background:#f0f9ff; border:1px solid #bae6fd; border-radius:8px;
  }
  .upload-loader.active { display:block; }
  .spinner {
    display:inline-block; width:20px; height:20px; 
    border:3px solid #cbd5e1; border-top-color:#2563eb; 
    border-radius:50%; animation:spin 1s linear infinite; 
    vertical-align:middle; margin-right:8px;
  }
  @keyframes spin { to { transform:rotate(360deg); } }

  /* Table */
  .table-wrap { background:#fff; border:1px solid #e5e7eb; border-radius:10px; overflow:auto; box-shadow:0 2px 8px rgba(0,0,0,.04); }
  table { width:100%; border-collapse:collapse; table-layout:fixed; min-width:700px; }
  thead th { background:linear-gradient(135deg,#2563eb 0%,#0a2f94 100%); color:#fff; padding:12px; font-size:14px; font-weight:600; text-align:left; }
  tbody td { padding:12px; border-top:1px solid #edf0f5; font-size:14px; vertical-align:middle; }
  tbody tr:nth-child(even) td { background:#f9fafb; }
  tbody tr:hover td { background:#f3f4f6; }
  .text-center { text-align:center; }

  .icon-btn { display:inline-flex; align-items:center; justify-content:center; width:32px; height:32px; border-radius:6px; transition:.2s; }
  .icon-btn:hover { transform: translateY(-1px); }
  .icon-view { color:#0d6efd; background:#eef4ff; }
  .icon-download { color:#198754; background:#e8f5ee; }
  .icon-delete { color:#fff; background:#dc3545; }
  .icon-edit { color:#111827; background:#e5e7eb; }

  /* Long names */
  .file-name { max-width: 340px; word-wrap:break-word; word-break:break-word; white-space:normal; line-height:1.4; }

  /* Pagination */
  .pagination {
    display:flex; justify-content:center; align-items:center; margin:15px 0 20px; gap:14px;
  }
  .pagination a, .pagination span {
    padding:8px 12px; border-radius:6px; border:1px solid #e6eefb; text-decoration:none;
  }
  .pagination a { color:#2563eb; }
  .pagination a:hover { background:#f0f9ff; }
  .pagination .current { background:#f8fafc; font-weight:600; color:#1e40af; }
  .pagination .disabled { color:#94a3b8; border-color:#f1f5f9; }
</style>

<div class="page-wrap">
  <div class="top-bar">
    <a href="{% url 'drive_list' %}" class="back-link">‚Üê Back to Drive</a>
  </div>

  <div class="main-grid">
    <!-- LEFT: Subfolders -->
    <aside class="subfolder-panel">
      <div class="subfolder-header">
        <h3>Subfolders</h3>
        <button id="openCreateSubfolder"><i class="fa-solid fa-folder"></i></button>
      </div>

      <div class="subfolder-list">
        {% if subfolders %}
          {% for sub in subfolders %}
            <div class="subfolder-item">
              <div class="folder-content">
                <a href="{% url 'drive_detail' sub.id %}">üìÅ {{ sub.name }}</a>
                <span class="item-count">{{ sub.file_count }}</span>
              </div>
              <form method="POST" action="{% url 'subfolder_delete' sub.id %}" onsubmit="return handleSubfolderDelete({{ sub.file_count }});">
                {% csrf_token %}
                <button type="submit" title="Delete {{ sub.name }}">üóëÔ∏è</button>
              </form>
            </div>
          {% endfor %}
        {% else %}
          <div class="no-subfolders">No subfolders yet.<br>Create one using the button above.</div>
        {% endif %}
      </div>
    </aside>

    <!-- RIGHT: Main content -->
    <div>
      <div class="panel">
        <div class="meta"><strong>Folder:</strong> {{ folder.name }}</div>
        <div class="meta"><strong>Created:</strong> {{ folder.created_at|date:"Y-m-d" }}</div>
      </div>

      <!-- SEARCH SECTION AT TOP -->
      <div class="search-section">
        <form method="get" class="search-form">
          <input type="text" name="q" value="{{ query }}" placeholder="üîç Search files...">
          {% if per_page %}<input type="hidden" name="per_page" value="{{ per_page }}">{% endif %}
          <button type="submit">Search</button>
          {% if query %}
            <a href="?{% if per_page %}per_page={{ per_page }}{% endif %}">Clear</a>
          {% endif %}
        </form>

        <div class="row-selector">
          <label for="rowCount">Show rows:</label>
          <select
            id="rowCount"
            onchange="location.href='?per_page=' + this.value + '{% if query %}&q={{ query|urlencode }}{% endif %}{% if request.GET.page %}&page=1{% endif %}'">
            <option value="10"  {% if per_page == 10  %}selected{% endif %}>10</option>
            <option value="15"  {% if per_page == 15  %}selected{% endif %}>15</option>
            <option value="25"  {% if per_page == 25  %}selected{% endif %}>25</option>
            <option value="50"  {% if per_page == 50  %}selected{% endif %}>50</option>
            <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
          </select>
        </div>
      </div>

      <!-- UPLOAD SECTION WITH FLEX -->
      <div class="upload-section">
        <label for="fileUpload"><i class="fa-solid fa-upload"></i> Upload File (PDF, DOCX, TXT, XLSX, PPTX):</label>
        <form class="upload-form" method="POST" enctype="multipart/form-data">
          {% csrf_token %}
          <input type="file" id="fileUpload" name="fileUpload" accept=".pdf,.doc,.docx,.txt,.xls,.xlsx,.ppt,.pptx" required>
          <input type="text" id="customFileName" name="file_name" placeholder="Custom file name (optional)">
          <button type="submit">Upload</button>
        </form>
      </div>

      <!-- Upload loader -->
      <div id="uploadLoader" class="upload-loader">
        <span class="spinner"></span>
        <span style="color:#374151;font-size:14px;font-weight:500;">Uploading file...</span>
      </div>

      <!-- Pagination -->
      {% if paginator.num_pages > 1 %}
        <div class="pagination">
          {% if page_obj.has_previous %}
            <a href="?per_page={{ per_page|default:'10' }}&page={{ page_obj.previous_page_number }}{% if query %}&q={{ query|urlencode }}{% endif %}">Previous</a>
          {% else %}
            <span class="disabled">Previous</span>
          {% endif %}

          <span class="current">Page {{ page_obj.number }} of {{ paginator.num_pages }}</span>

          {% if page_obj.has_next %}
            <a href="?per_page={{ per_page|default:'10' }}&page={{ page_obj.next_page_number }}{% if query %}&q={{ query|urlencode }}{% endif %}">Next</a>
          {% else %}
            <span class="disabled">Next</span>
          {% endif %}
        </div>
      {% endif %}

      <div class="table-wrap">
        <table>
          <colgroup>
            <col style="width:60px;">
            <col style="width:160px;">
            <col>
            <col style="width:90px;">
            <col style="width:110px;">
            <col style="width:80px;">
            <col style="width:80px;">
          </colgroup>
          <thead>
            <tr>
              <th>No.</th>
              <th>Date</th>
              <th>File Name</th>
              <th class="text-center">Preview</th>
              <th class="text-center">Download</th>
              <th class="text-center">Edit</th>
              <th class="text-center">Delete</th>
            </tr>
          </thead>
          <tbody>
            {% for f in files %}
              <tr>
                <td>{{ forloop.counter }}</td>
                <td>{{ f.uploaded_at|date:"Y-m-d H:i" }}</td>
                <td class="file-name">{% firstof f.file_name f.file.name %}</td>
                <td class="text-center"><a class="icon-btn icon-view" href="{% url 'file_preview' f.id %}" title="Preview"><i class="fa-solid fa-eye"></i></a></td>
                <td class="text-center"><a class="icon-btn icon-download" href="{% url 'file_download' f.id %}" title="Download"><i class="fa-solid fa-download"></i></a></td>
                <td class="text-center"><a href="{% url 'file_edit_page' f.id %}" class="icon-btn icon-edit" title="Edit file name"><i class="fa-solid fa-pen-to-square"></i></a></td>
                <td class="text-center"><a class="icon-btn icon-delete" href="{% url 'file_delete' f.id %}" onclick="return confirm('Delete this file?');"><i class="fa-solid fa-trash"></i></a></td>
              </tr>
            {% empty %}
              <tr><td colspan="7" class="text-center" style="color:#6b7280;padding:20px;">No files yet.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Create Subfolder Modal -->
<div id="createSubfolderModal" style="position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:1000;">
  <div class="modal-card" style="background:#fff; border-radius:12px; padding:18px; width:min(92vw,420px); box-shadow:0 10px 30px rgba(0,0,0,.2);">
    <h3 style="margin:0 0 8px 0;">Create New Subfolder</h3>
    <p style="margin:0 0 12px 0; color:#6b7280;">Enter a name for your new subfolder inside "{{ folder.name }}"</p>
    <form method="POST" action="{% url 'subfolder_add' folder.id %}">
      {% csrf_token %}
      <input type="text" name="folderName" placeholder="Subfolder name" required style="width:100%; padding:10px; border:1px solid #d1d5db; border-radius:8px; margin-bottom:12px;">
      <div class="actions" style="display:flex; justify-content:flex-end; gap:10px;">
        <button type="button" class="btn-cancel" id="cancelCreateSubfolder" style="padding:8px 14px; background:#e5e7eb; border:none; border-radius:8px; font-weight:600; cursor:pointer;">Cancel</button>
        <button type="submit" class="btn-create" style="padding:8px 14px; background:#0d6efd; border:none; border-radius:8px; color:#fff; font-weight:600; cursor:pointer;">Create</button>
      </div>
    </form>
  </div>
</div>

<script>
  // Subfolder modal
  const subModal = document.getElementById('createSubfolderModal');
  document.getElementById('openCreateSubfolder').onclick = () => subModal.style.display = 'flex';
  document.getElementById('cancelCreateSubfolder').onclick = () => subModal.style.display = 'none';
  subModal.onclick = e => { if (e.target === subModal) subModal.style.display = 'none'; };

  // Prevent deleting non-empty subfolders
  function handleSubfolderDelete(fileCount) {
    if (fileCount > 0) {
      alert("üö´ This folder cannot be deleted because it contains files.\n\nPlease remove all files first.");
      return false;
    }
    return confirm("Are you sure you want to delete this empty subfolder?");
  }

  // Upload inline loader
  document.querySelector('.upload-form').addEventListener('submit', function() {
    const fileInput = document.getElementById('fileUpload');
    if (fileInput.files.length > 0) {
      document.getElementById('uploadLoader').classList.add('active');
    }
  });

  // Auto-fill custom name from selected file (without extension)
  (function() {
    const fileInput = document.getElementById('fileUpload');
    const customInput = document.getElementById('customFileName');
    
    if (fileInput && customInput) {
      fileInput.addEventListener('change', () => {
        if (!fileInput.files || !fileInput.files[0]) return;
        
        const fullName = fileInput.files[0].name;
        // Remove file extension
        const baseName = fullName.replace(/\.[^/.]+$/, '');
        
        // Auto-fill the custom name field
        customInput.value = baseName;
      });
    }
  })();
</script>

{% endblock %}