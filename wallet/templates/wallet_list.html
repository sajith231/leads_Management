{% extends "base.html" %}
{% block content %}
    <title>Wallet List</title>

    <!-- font awesome kept for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* Reset & base */
        *, *:before, *:after { box-sizing: border-box; }
        html,body{ height:100%; margin:0; font-family: Inter, "Segoe UI", Roboto, Arial, sans-serif; background:#f5f5f5; color:#333;}
        a { color: inherit; text-decoration: none; }

        /* Container */
        .container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 0 18px;
        }

        /* Header card */
        .header {
            background: #fff;
            border-radius: 8px;
            padding: 22px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            border: 1px solid #e6e6e6;
            display:flex;
            align-items:center;
            justify-content:space-between;
            gap:16px;
        }
        .header-left { display:flex; gap:14px; align-items:center; }
        .header h1 { font-size:22px; margin:0; display:flex; gap:8px; align-items:center; }
        .header p { margin:0; color:#6b7280; font-size:13px; margin-top:4px; }

        /* Add button */
        .btn-add {
            background: #4a5568;
            color: #fff;
            padding: 10px 18px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight:600;
            display:inline-flex;
            align-items:center;
            gap:8px;
        }
        .btn-add:hover { filter:brightness(.95); }

        /* Alerts */
        .alert {
            background:#fff;
            border:1px solid #e6e6e6;
            padding:12px 14px;
            border-radius:8px;
            box-shadow:0 2px 8px rgba(0,0,0,0.03);
            display:flex;
            align-items:center;
            justify-content:space-between;
            gap:10px;
            margin-bottom:14px;
        }
        .alert .text { color:#111827; font-size:14px; }
        .alert .close-btn {
            background:transparent;
            border: none;
            cursor:pointer;
            font-size:18px;
            color:#6b7280;
        }

        /* Ribbon navigation */
        .ribbon-container {
            display:flex;
            gap:15px;
            margin-bottom:18px;
            flex-wrap:wrap;
        }
        .ribbon {
            background:white;
            border:2px solid #e6e6e6;
            color:#666;
            padding:14px 18px;
            border-radius:8px;
            cursor:pointer;
            transition:all .15s ease;
            flex:1;
            min-width:180px;
            text-align:center;
        }
        .ribbon:hover { border-color:#4a5568; background:#fafafa; }
        .ribbon.active { background:#4a5568; border-color:#4a5568; color:#fff; }
        .ribbon-title { font-size:13px; font-weight:700; display:flex; gap:8px; justify-content:center; align-items:center; }
        .ribbon-count { font-size:20px; font-weight:800; margin-top:6px; }

        /* Filter section */
        .filter-section {
            background:white;
            padding:14px;
            border-radius:8px;
            margin-bottom:18px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            border:1px solid #e6e6e6;
            display:none;
        }
        .filter-label { font-size:14px; font-weight:700; color:#333; margin-bottom:8px; display:flex; gap:8px; align-items:center;}
        .filter-buttons { display:flex; gap:10px; flex-wrap:wrap; }
        .filter-btn {
            padding:8px 12px;
            border-radius:8px;
            border:1px solid #e6e6e6;
            background:#fff;
            cursor:pointer;
            font-weight:600;
            font-size:13px;
        }
        .filter-btn.active { background:#4a5568; color:#fff; border-color:#4a5568; }

        /* Wallet grid / cards */
        .wallet-grid {
            display:grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap:20px;
            margin-top:6px;
        }
        .wallet-card {
            background:#fff;
            border-radius:8px;
            overflow:hidden;
            box-shadow:0 2px 8px rgba(0,0,0,0.06);
            border:1px solid #e6e6e6;
            transition: transform .12s ease, box-shadow .12s ease;
            display:flex;
            flex-direction:column;
            min-height:300px;
        }
        .wallet-card:hover { transform: translateY(-4px); box-shadow:0 8px 18px rgba(0,0,0,0.08); }
        .wallet-image { width:100%; height:180px; object-fit:cover; border-bottom:1px solid #eee; background:#f3f4f6; display:block; }
        .no-image { width:100%; height:180px; display:flex; align-items:center; justify-content:center; background:#f3f4f6; border-bottom:1px solid #eee; color:#cbd5e1; }
        .wallet-content { padding:14px; display:flex; flex-direction:column; gap:8px; flex:1; }

        .wallet-type-badge {
            display:inline-block;
            padding:6px 10px;
            border-radius:6px;
            font-size:12px;
            font-weight:700;
            text-transform:uppercase;
            background:#f3f4f6;
            color:#374151;
            align-self:flex-start;
        }
        .visibility-badge {
            display:inline-block;
            padding:5px 8px;
            border-radius:6px;
            font-size:12px;
            margin-left:8px;
            background:#eef2ff;
            color:#374151;
            font-weight:600;
        }
        .wallet-title { font-size:15px; margin:0; color:#111827; font-weight:700; }
        .wallet-desc { color:#6b7280; font-size:13px; margin:0 0 6px 0; }

        .wallet-meta {
            display:flex;
            justify-content:space-between;
            align-items:center;
            gap:10px;
            margin-top:auto;
        }
        .small-muted { font-size:12px; color:#6b7280; display:flex; gap:6px; align-items:center; }

        /* action buttons */
        .action-btns { display:flex; gap:8px; align-items:center; }
        .btn {
            padding:7px 11px;
            border-radius:6px;
            border:none;
            font-weight:700;
            cursor:pointer;
            font-size:13px;
            display:inline-flex;
            gap:8px;
            align-items:center;
        }
        .btn-view { background:#3b82f6; color:#fff; text-decoration:none; }
        .btn-view:hover{ filter:brightness(.96) }
        .btn-delete { background:#ef4444; color:#fff; }
        .btn-delete:hover{ filter:brightness(.96) }
        .btn-wa { background:#25D366; color:#fff; }
        .btn-wa:hover{ filter:brightness(.96) }
        .btn-edit { background:#f59e0b; color:#fff; border-radius:6px; padding:7px 11px; }

        /* Empty state box */
        .empty-state {
            text-align:center;
            padding:40px 20px;
            background:white;
            border-radius:8px;
            box-shadow:0 2px 8px rgba(0,0,0,0.04);
            border:1px solid #e6e6e6;
        }
        .empty-state i { font-size:48px; color:#d1d5db; margin-bottom:12px; display:block; }

        /* Modal (custom) */
        .modal-backdrop {
            position:fixed;
            top:0;
            left:0;
            right:0;
            bottom:0;
            background:rgba(0,0,0,0.6);
            display:none;
            align-items:center;
            justify-content:center;
            z-index:9999;
            padding:20px;
        }
        .modal-backdrop.show {
            display:flex !important;
        }
        .modal {
            width:100%;
            max-width:900px;
            max-height:90vh;
            background:#fff;
            border-radius:10px;
            overflow:hidden;
            box-shadow:0 14px 40px rgba(0,0,0,0.25);
            border:1px solid rgba(0,0,0,0.04);
            position:relative;
            z-index:10000;
        }
        .modal-header { padding:14px 18px; border-bottom:1px solid #f3f4f6; display:flex; align-items:center; justify-content:space-between; }
        .modal-body { padding:18px; max-height:70vh; overflow:auto; }
        .modal-footer { padding:12px 18px; border-top:1px solid #f3f4f6; display:flex; gap:12px; justify-content:flex-end; }

        .btn-close { background:transparent; border:none; font-size:22px; cursor:pointer; color:#6b7280; }
        .btn-close:hover { color:#111827; }

        .spinner { width:36px; height:36px; border-radius:50%; border:4px solid #f3f4f6; border-top-color:#4a5568; animation:spin 1s linear infinite; margin:auto; }
        @keyframes spin { to { transform:rotate(360deg); } }

        .detail-section { margin-bottom:12px; }
        .detail-section small.text-muted { color:#6b7280; display:block; margin-bottom:6px; font-size:13px; }
    </style>

    <div class="container">
        <div class="header">
            <div class="header-left">
                <h1><i class="fas fa-wallet"></i> Wallets</h1>
                <p>Manage bank details, QR codes, docs and more</p>
            </div>
            <div>
                <a href="{% url 'add_wallet' %}" class="btn-add"><i class="fas fa-plus"></i> Add Wallet</a>
            </div>
        </div>

        {% if messages %}
            <div class="alert" id="msgAlert">
                <div class="text">
                    {% for message in messages %}
                        {{ message }}
                    {% endfor %}
                </div>
                <button class="close-btn" onclick="closeAlert('msgAlert')">&times;</button>
            </div>
        {% endif %}

        <!-- Ribbons with counts -->
        <div class="ribbon-container">
            <div class="ribbon" data-type="" id="allRibbon">
                <div class="ribbon-title"><i class="fas fa-th-large"></i> All Wallets</div>
                <div class="ribbon-count">{{ wallets|length }}</div>
            </div>
            <div class="ribbon" data-type="bank">
                <div class="ribbon-title"><i class="fas fa-university"></i> Bank</div>
                <div class="ribbon-count">{{ bank_wallets|length }}</div>
            </div>
            <div class="ribbon" data-type="qr">
                <div class="ribbon-title"><i class="fas fa-qrcode"></i> QR</div>
                <div class="ribbon-count">{{ qr_wallets|length }}</div>
            </div>
            <div class="ribbon" data-type="document">
                <div class="ribbon-title"><i class="fas fa-file-alt"></i> Document</div>
                <div class="ribbon-count">{{ document_wallets|length }}</div>
            </div>
            <div class="ribbon" data-type="other">
                <div class="ribbon-title"><i class="fas fa-wallet"></i> Other</div>
                <div class="ribbon-count">{{ other_wallets|length }}</div>
            </div>
        </div>

        <!-- Filter controls (shown when a ribbon is clicked) -->
        <div class="filter-section" id="filterSection">
            <div class="filter-label">Filter visibility:</div>
            <div class="filter-buttons">
                <button class="filter-btn active" data-visibility="all">All</button>
                <button class="filter-btn" data-visibility="superadmin">Super Admin</button>
                <button class="filter-btn" data-visibility="admin">Admin</button>
                <button class="filter-btn" data-visibility="user">User</button>
            </div>
        </div>

        <!-- Wallet Cards -->
        <div class="wallet-grid" id="walletGrid">
            {% for wallet in wallets %}
                <div class="wallet-card" data-type="{{ wallet.upload_type }}" data-visibility="{{ wallet.visibility_priority }}" data-id="{{ wallet.id }}">
                    {% if wallet.image %}
                        <img src="{{ wallet.image.url }}" alt="{{ wallet.title }}" class="wallet-image">
                    {% else %}
                        <div class="no-image"><i class="fas fa-image"></i></div>
                    {% endif %}

                    <div class="wallet-content">
                        <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
                            <span class="wallet-type-badge">
                                {% if wallet.upload_type == 'bank' %}
                                    <i class="fas fa-university"></i> Bank
                                {% elif wallet.upload_type == 'qr' %}
                                    <i class="fas fa-qrcode"></i> QR
                                {% elif wallet.upload_type == 'document' %}
                                    <i class="fas fa-file-alt"></i> Document
                                {% else %}
                                    <i class="fas fa-wallet"></i> Other
                                {% endif %}
                            </span>
                            <span class="visibility-badge"><i class="fas fa-eye"></i> {{ wallet.get_visibility_priority_display }}</span>
                        </div>

                        <h3 class="wallet-title">{{ wallet.title }}</h3>
                        <p class="wallet-desc">{{ wallet.description|truncatewords:15 }}</p>

                        <div class="wallet-meta">
                            <div class="small-muted"><i class="fas fa-clock"></i> {{ wallet.created_at|date:"M d, Y" }}</div>
                            <div class="action-btns">
                                <!-- WhatsApp share -->
                                <a class="btn btn-wa" href="javascript:void(0)" onclick="shareOnWhatsApp({{ wallet.id }})" title="Share on WhatsApp"><i class="fab fa-whatsapp"></i></a>

                                <!-- View (opens modal) -->
                                <button type="button" class="btn btn-view" onclick="viewWalletDetails({{ wallet.id }})"><i class="fas fa-eye"></i> View</button>

                                <!-- Edit (direct link to edit page) -->
                                <a class="btn btn-edit" href="{% url 'edit_wallet' wallet.id %}"><i class="fas fa-edit"></i></a>

                                <!-- Delete -->
                                <form method="post" action="{% url 'delete_wallet' wallet.id %}" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this wallet item?');">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-delete" title="Delete"><i class="fas fa-trash"></i></button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>

        {% if wallets|length == 0 %}
            <div style="margin-top:20px;">
                <div class="empty-state">
                    <i class="fas fa-wallet"></i>
                    <div style="font-weight:700; margin-bottom:6px;">No wallets yet</div>
                    <div style="color:#6b7280; font-size:13px;">Upload wallets and they'll appear here.</div>
                </div>
            </div>
        {% endif %}

    </div>

    <!-- Modal markup -->
    <div class="modal-backdrop" id="modalBackdrop" aria-hidden="true" role="dialog" onclick="backdropClick(event)">
      <div class="modal" id="walletDetailModal" role="document" aria-modal="true" tabindex="-1" onclick="event.stopPropagation()">
        <div class="modal-header">
          <div style="display:flex; align-items:center; gap:10px;">
            <i class="fas fa-wallet"></i>
            <div style="font-weight:700;">Wallet Details</div>
          </div>
          <button class="btn-close" onclick="closeModal()" aria-label="Close">&times;</button>
        </div>

        <div class="modal-body" id="walletDetailContent">
          <div style="text-align:center; padding:22px;">
            <div class="spinner" aria-hidden="true"></div>
          </div>
        </div>

        <div class="modal-footer" id="modalFooter">
          <button class="btn btn-wa" id="modalWhatsAppBtn"><i class="fab fa-whatsapp"></i> Share on WhatsApp</button>
          <a id="modalEditBtn" class="btn btn-edit" href="#"><i class="fas fa-edit"></i> Edit</a>
        </div>
      </div>
    </div>

    <script>
      // CSRF token helper
      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';');
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
              cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
              break;
            }
          }
        }
        return cookieValue;
      }
      const csrftoken = getCookie('csrftoken');

      // Debug helper
      function debugLog(...args){ 
        if(window.console) console.log('[wallet-debug]', ...args); 
      }

      // Ensure elements exist
      const modalBackdrop = document.getElementById('modalBackdrop');
      const walletDetailModal = document.getElementById('walletDetailModal');
      const walletDetailContent = document.getElementById('walletDetailContent');
      const modalEditBtn = document.getElementById('modalEditBtn');
      const modalWhatsAppBtn = document.getElementById('modalWhatsAppBtn');

      // Check if elements exist
      if(!modalBackdrop) console.error('modalBackdrop not found!');
      if(!walletDetailModal) console.error('walletDetailModal not found!');
      if(!walletDetailContent) console.error('walletDetailContent not found!');

      let currentWalletId = null;

      function openModal() {
        debugLog('Opening modal...');
        if(!modalBackdrop || !walletDetailModal) {
          console.error('Modal elements missing!');
          alert('Modal elements not found. Please refresh the page.');
          return;
        }
        
        // Show backdrop with class
        modalBackdrop.classList.add('show');
        modalBackdrop.style.display = 'flex';
        modalBackdrop.setAttribute('aria-hidden', 'false');
        
        // Prevent background scroll
        document.body.style.overflow = 'hidden';
        
        debugLog('Modal opened, backdrop display:', modalBackdrop.style.display);
        
        // Ensure modal is focused for keyboard users
        setTimeout(() => {
          try { 
            walletDetailModal.focus(); 
            debugLog('Modal focused successfully');
          } catch(e) { 
            debugLog('Focus error:', e); 
          }
        }, 100);
      }

      function closeModal() {
        debugLog('Closing modal...');
        if(!modalBackdrop || !walletDetailModal) return;
        
        modalBackdrop.classList.remove('show');
        modalBackdrop.style.display = 'none';
        modalBackdrop.setAttribute('aria-hidden', 'true');
        
        // Restore page scroll
        document.body.style.overflow = '';
        
        // Restore placeholder content and reset links
        walletDetailContent.innerHTML = '<div style="text-align:center; padding:22px;"><div class="spinner"></div></div>';
        currentWalletId = null;
        if(modalEditBtn) modalEditBtn.href = '#';
        if(modalWhatsAppBtn) modalWhatsAppBtn.onclick = null;
      }

      function backdropClick(e){
        // Close only when clicking on the backdrop element itself
        if(e.target === modalBackdrop){
          closeModal();
        }
      }

      // Close modal on ESC key
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && modalBackdrop && modalBackdrop.style.display === 'flex') {
          closeModal();
        }
      });

      // Close alert function
      function closeAlert(id) {
        const alert = document.getElementById(id);
        if (alert) {
          alert.style.display = 'none';
        }
      }

      // Share on WhatsApp
      async function shareOnWhatsApp(walletId){
        debugLog('Sharing wallet', walletId, 'on WhatsApp');
        try {
          const response = await fetch(`/wallet/detail/${walletId}/`, {
            method: 'GET',
            headers: {
              'X-Requested-With': 'XMLHttpRequest',
              'X-CSRFToken': csrftoken
            }
          });
          
          if(!response.ok) {
            throw new Error('Fetch failed: ' + response.status + ' ' + response.statusText);
          }

          const ct = response.headers.get('content-type') || '';
          debugLog('Content type:', ct);
          
          if(ct.includes('application/json')){
            const data = await response.json();
            let message = '*' + (data.title || 'Wallet Details') + '*\n\n';
            message += 'Type: ' + (data.upload_type || '') + '\n';

            if (data.upload_type_code === 'bank') {
              message += '\nBank Details:\n';
              if (data.account_holder_name) message += 'Account Holder: ' + data.account_holder_name + '\n';
              if (data.account_number) message += 'Account Number: ' + data.account_number + '\n';
              if (data.ifsc_code) message += 'IFSC Code: ' + data.ifsc_code + '\n';
              if (data.bank_address) message += 'Bank Address: ' + data.bank_address + '\n';
            } else if (data.upload_type_code === 'qr') {
              if (data.qr_name) message += '\nQR Name: ' + data.qr_name + '\n';
            } else if (data.upload_type_code === 'other') {
              if (data.other_name) message += '\nWallet Name: ' + data.other_name + '\n';
            }

            if (data.description) message += '\nDescription: ' + data.description + '\n';

            const encoded = encodeURIComponent(message);
            const wa = 'https://wa.me/?text=' + encoded;
            window.open(wa, '_blank');
          } else {
            // Content is not JSON; assume HTML/text snippet
            const text = await response.text();
            const encoded = encodeURIComponent(stripHtml(text).slice(0, 1500));
            window.open('https://wa.me/?text=' + encoded, '_blank');
          }
        } catch(err){
          console.error('WhatsApp share error:', err);
          alert('Failed to generate WhatsApp share link. Error: ' + err.message);
        }
      }

      // View wallet details - FIXED VERSION
      async function viewWalletDetails(walletId){
        console.log('=== VIEW WALLET DETAILS CALLED ===');
        console.log('Wallet ID:', walletId);
        
        currentWalletId = walletId;
        
        // Set edit link immediately
        if(modalEditBtn) {
          modalEditBtn.href = '/wallet/edit/' + walletId + '/';
          console.log('Edit button href set');
        }
        if(modalWhatsAppBtn){
          modalWhatsAppBtn.onclick = function(){ shareOnWhatsApp(walletId); };
          console.log('WhatsApp button onclick set');
        }

        // Show spinner while fetching
        if(walletDetailContent) {
          walletDetailContent.innerHTML = '<div style="text-align:center; padding:40px;"><div class="spinner"></div><p style="margin-top:16px; color:#6b7280; font-size:14px;">Loading wallet details...</p></div>';
          console.log('Spinner displayed');
        } else {
          console.error('walletDetailContent element not found!');
          return;
        }

        // Open modal after setting content
        try {
          openModal();
          console.log('Modal opened');
        } catch(e){ 
          console.error('openModal failed:', e);
          alert('Failed to open modal: ' + e.message);
          return;
        }

        try {
          const url = '/wallet/detail/' + walletId + '/';
          console.log('Fetching from URL:', url);
          
          const response = await fetch(url, {
            method: 'GET',
            headers: {
              'X-Requested-With': 'XMLHttpRequest',
              'X-CSRFToken': csrftoken
            }
          });
          
          console.log('Response received:', response.status, response.statusText);
          
          if(!response.ok){
            throw new Error('HTTP Error: ' + response.status + ' ' + response.statusText);
          }

          const ct = response.headers.get('content-type') || '';
          console.log('Content-Type:', ct);
          
          // If JSON, parse and build details HTML
          if(ct.includes('application/json')){
            const data = await response.json();
            console.log('JSON data received:', data);
            
            // Build the modal content
            let detailsHTML = buildWalletDetailsHTML(data);
            walletDetailContent.innerHTML = detailsHTML;
            console.log('Content loaded successfully (JSON)');
          } else {
            // Content is HTML/text - insert as-is
            const html = await response.text();
            console.log('HTML content received, length:', html.length);
            walletDetailContent.innerHTML = '<div style="padding:10px;">' + html + '</div>';
            console.log('Content loaded successfully (HTML)');
          }
        } catch(err){
          console.error('Error loading wallet details:', err);
          walletDetailContent.innerHTML = '<div style="padding:16px;"><div style="background:#fff6f6;color:#9b1c1c;padding:16px;border-radius:8px;border:1px solid #f2c1c1;"><i class="fas fa-exclamation-circle"></i> <strong>Failed to load wallet details</strong><br><small style="margin-top:8px; display:block;">' + err.message + '</small></div></div>';
        }
      }

      // Helper function to build wallet details HTML
      function buildWalletDetailsHTML(data) {
        const safe = (s) => (s === null || s === undefined) ? '' : String(s);
        
        let detailsHTML = '<div style="padding:10px;">';
        
        // Title and Type
        detailsHTML += '<div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:16px;">';
        detailsHTML += '<div class="detail-section"><div style="font-size:12px; font-weight:700; color:#6b7280; text-transform:uppercase;">Title</div><div style="font-weight:700; margin-top:6px;">' + escapeHtml(safe(data.title)) + '</div></div>';
        detailsHTML += '<div class="detail-section"><div style="font-size:12px; font-weight:700; color:#6b7280; text-transform:uppercase;">Type</div><div style="margin-top:6px;">' + getTypeIcon(data.upload_type_code) + ' ' + escapeHtml(safe(data.upload_type)) + '</div></div>';
        detailsHTML += '</div>';

        // Type-specific details
        if(data.upload_type_code === 'bank'){
          detailsHTML += '<div class="detail-section" style="margin-bottom:16px; padding:16px; background:#f8f9fa; border-radius:8px;">';
          detailsHTML += '<div style="font-weight:700; margin-bottom:12px; display:flex; align-items:center; gap:8px;"><i class="fas fa-university"></i> Bank Details</div>';
          detailsHTML += '<div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">';
          detailsHTML += '<div><small class="text-muted">Account Holder</small><div style="font-weight:700; margin-top:4px;">' + escapeHtml(safe(data.account_holder_name) || 'N/A') + '</div></div>';
          detailsHTML += '<div><small class="text-muted">Account Number</small><div style="font-weight:700; margin-top:4px;">' + escapeHtml(safe(data.account_number) || 'N/A') + '</div></div>';
          detailsHTML += '</div>';
          detailsHTML += '<div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:12px;">';
          detailsHTML += '<div><small class="text-muted">IFSC Code</small><div style="font-weight:700; margin-top:4px;">' + escapeHtml(safe(data.ifsc_code) || 'N/A') + '</div></div>';
          detailsHTML += '<div><small class="text-muted">Bank Address</small><div style="font-weight:700; margin-top:4px;">' + escapeHtml(safe(data.bank_address) || 'N/A') + '</div></div>';
          detailsHTML += '</div>';
          detailsHTML += '</div>';
        } else if(data.upload_type_code === 'qr') {
          detailsHTML += '<div class="detail-section" style="margin-bottom:16px; padding:16px; background:#f8f9fa; border-radius:8px;">';
          detailsHTML += '<div style="font-weight:700; margin-bottom:8px; display:flex; align-items:center; gap:8px;"><i class="fas fa-qrcode"></i> QR Details</div>';
          detailsHTML += '<div><small class="text-muted">QR Name</small><div style="font-weight:700; margin-top:4px;">' + escapeHtml(safe(data.qr_name) || 'N/A') + '</div></div>';
          detailsHTML += '</div>';
        } else if(data.upload_type_code === 'other') {
          detailsHTML += '<div class="detail-section" style="margin-bottom:16px; padding:16px; background:#f8f9fa; border-radius:8px;">';
          detailsHTML += '<div style="font-weight:700; margin-bottom:8px; display:flex; align-items:center; gap:8px;"><i class="fas fa-wallet"></i> Wallet Details</div>';
          detailsHTML += '<div><small class="text-muted">Wallet Name</small><div style="font-weight:700; margin-top:4px;">' + escapeHtml(safe(data.other_name) || 'N/A') + '</div></div>';
          detailsHTML += '</div>';
        } else if(data.upload_type_code === 'document') {
          detailsHTML += '<div class="detail-section" style="margin-bottom:16px; padding:16px; background:#f8f9fa; border-radius:8px;">';
          detailsHTML += '<div style="font-weight:700; display:flex; align-items:center; gap:8px;"><i class="fas fa-file-alt"></i> Document</div>';
          detailsHTML += '</div>';
        }

        // Visibility and Created date
        detailsHTML += '<div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:16px;">';
        detailsHTML += '<div class="detail-section"><small class="text-muted">Visibility</small><div style="font-weight:700; margin-top:6px; display:flex; align-items:center; gap:6px;"><i class="fas fa-eye"></i> ' + escapeHtml(safe(data.visibility_priority) || '') + '</div></div>';
        detailsHTML += '<div class="detail-section"><small class="text-muted">Created</small><div style="font-weight:700; margin-top:6px; display:flex; align-items:center; gap:6px;"><i class="fas fa-clock"></i> ' + escapeHtml(safe(data.created_at) || '') + '</div></div>';
        detailsHTML += '</div>';

        // Description
        if(data.description){
          detailsHTML += '<div class="detail-section" style="margin-bottom:16px; padding:16px; background:#f8f9fa; border-radius:8px;">';
          detailsHTML += '<small class="text-muted">Description</small>';
          detailsHTML += '<div style="margin-top:8px; line-height:1.5;">' + escapeHtml(safe(data.description)) + '</div>';
          detailsHTML += '</div>';
        }

        // Image
        if(data.image_url){
          detailsHTML += '<div class="detail-section">';
          detailsHTML += '<small class="text-muted">Image</small>';
          detailsHTML += '<img src="' + escapeAttr(safe(data.image_url)) + '" alt="' + escapeAttr(safe(data.title)) + '" style="width:100%; max-height:400px; object-fit:contain; margin-top:8px; border-radius:6px; border:1px solid #e6e6e6;">';
          detailsHTML += '</div>';
        }
        
        detailsHTML += '</div>';
        
        return detailsHTML;
      }

      // Helper functions
      function getTypeIcon(type){
        const icons = {
          'bank': '<i class="fas fa-university"></i>',
          'qr': '<i class="fas fa-qrcode"></i>',
          'document': '<i class="fas fa-file-alt"></i>',
          'other': '<i class="fas fa-wallet"></i>'
        };
        return icons[type] || '<i class="fas fa-wallet"></i>';
      }

      function escapeHtml(str){
        if(!str) return '';
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
      }
      
      function escapeAttr(str){
        if(!str) return '';
        return String(str).replace(/"/g, '&quot;').replace(/'/g, '&#39;');
      }
      
      function stripHtml(html){
        const tmp = document.createElement('div');
        tmp.innerHTML = html;
        return tmp.textContent || tmp.innerText || '';
      }

      // Ribbon filtering functionality
      document.querySelectorAll('.ribbon').forEach(ribbon => {
        ribbon.addEventListener('click', function() {
          const filterType = this.getAttribute('data-type');
          debugLog('Filtering by type:', filterType);
          
          // Update active ribbon
          document.querySelectorAll('.ribbon').forEach(r => r.classList.remove('active'));
          this.classList.add('active');
          
          // Show/hide filter section
          const filterSection = document.getElementById('filterSection');
          if (filterType === '') {
            filterSection.style.display = 'none';
          } else {
            filterSection.style.display = 'block';
          }
          
          // Filter cards
          filterCards(filterType, 'all');
        });
      });

      // Visibility filter buttons
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const visibility = this.getAttribute('data-visibility');
          const activeRibbon = document.querySelector('.ribbon.active');
          const filterType = activeRibbon ? activeRibbon.getAttribute('data-type') : '';
          
          // Update active button
          document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          
          // Filter cards
          filterCards(filterType, visibility);
        });
      });

      function filterCards(type, visibility) {
        const cards = document.querySelectorAll('.wallet-card');
        let visibleCount = 0;
        
        cards.forEach(card => {
          const cardType = card.getAttribute('data-type');
          const cardVisibility = card.getAttribute('data-visibility');
          
          let typeMatch = (type === '' || cardType === type);
          let visibilityMatch = (visibility === 'all' || cardVisibility === visibility);
          
          if (typeMatch && visibilityMatch) {
            card.style.display = 'flex';
            visibleCount++;
          } else {
            card.style.display = 'none';
          }
        });
        
        debugLog('Filtered cards:', visibleCount, 'visible');
      }

      // Initialize: set "All Wallets" as active
      document.addEventListener('DOMContentLoaded', function() {
        const allRibbon = document.getElementById('allRibbon');
        if (allRibbon) {
          allRibbon.classList.add('active');
        }
        debugLog('Page loaded, modal system initialized');
      });
    </script>
{% endblock %}