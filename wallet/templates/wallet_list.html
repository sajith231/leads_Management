{% extends "base.html" %}
{% block content %}
    <title>Wallet List</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        *, *:before, *:after { box-sizing: border-box; }
        html,body{ height:100%; margin:0; font-family: Inter, "Segoe UI", Roboto, Arial, sans-serif; background:#f5f5f5; color:#333;}
        a { color: inherit; text-decoration: none; }

        .container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 0 18px;
        }

        .header {
            background: #fff;
            border-radius: 8px;
            padding: 22px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            border: 1px solid #e6e6e6;
            display:flex;
            align-items:center;
            justify-content:space-between;
            gap:16px;
        }
        .header-left { display:flex; gap:14px; align-items:center; }
        .header h1 { font-size:22px; margin:0; display:flex; gap:8px; align-items:center; }
        .header p { margin:0; color:#6b7280; font-size:13px; margin-top:4px; }

        .btn-add {
            background: #4a5568;
            color: #fff;
            padding: 10px 18px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight:600;
            display:inline-flex;
            align-items:center;
            gap:8px;
        }
        .btn-add:hover { filter:brightness(.95); }

        .alert {
            background:#fff;
            border:1px solid #e6e6e6;
            padding:12px 14px;
            border-radius:8px;
            box-shadow:0 2px 8px rgba(0,0,0,0.03);
            display:flex;
            align-items:center;
            justify-content:space-between;
            gap:10px;
            margin-bottom:14px;
        }
        .alert .text { color:#111827; font-size:14px; }
        .alert .close-btn {
            background:transparent;
            border: none;
            cursor:pointer;
            font-size:18px;
            color:#6b7280;
        }

        /* Filter Section */
        .filter-section {
            background: #fff;
            border-radius: 8px;
            padding: 18px;
            margin-bottom: 18px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            border: 1px solid #e6e6e6;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto;
            gap: 12px;
            align-items: end;
        }

        @media (max-width: 768px) {
            .filter-grid {
                grid-template-columns: 1fr;
            }
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .filter-label {
            font-size: 12px;
            font-weight: 700;
            color: #6b7280;
            text-transform: uppercase;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .filter-input {
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.2s;
            background: #fff;
        }

        .filter-input:focus {
            outline: none;
            border-color: #4a5568;
            box-shadow: 0 0 0 3px rgba(74, 85, 104, 0.1);
        }

        .btn-clear-filters {
            background: #ef4444;
            color: #fff;
            padding: 10px 16px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .btn-clear-filters:hover {
            filter: brightness(0.95);
        }

        .results-info {
            background: #f3f4f6;
            padding: 10px 14px;
            border-radius: 6px;
            font-size: 13px;
            color: #374151;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .results-info-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ribbon-container {
            display:flex;
            gap:15px;
            margin-bottom:18px;
            flex-wrap:wrap;
        }
        .ribbon {
            background:white;
            border:2px solid #e6e6e6;
            color:#666;
            padding:14px 18px;
            border-radius:8px;
            cursor:pointer;
            transition:all .15s ease;
            flex:1;
            min-width:180px;
            text-align:center;
        }
        .ribbon:hover { border-color:#4a5568; background:#fafafa; }
        .ribbon.active { background:#4a5568; border-color:#4a5568; color:#fff; }
        .ribbon-title { font-size:13px; font-weight:700; display:flex; gap:8px; justify-content:center; align-items:center; }
        .ribbon-count { font-size:20px; font-weight:800; margin-top:6px; }

        .wallet-grid {
            display:grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap:20px;
            margin-top:6px;
        }
        .wallet-card {
            background:#fff;
            border-radius:8px;
            overflow:hidden;
            box-shadow:0 2px 8px rgba(0,0,0,0.06);
            border:1px solid #e6e6e6;
            transition: transform .12s ease, box-shadow .12s ease;
            display:flex;
            flex-direction:column;
            min-height:300px;
        }
        .wallet-card:hover { transform: translateY(-4px); box-shadow:0 8px 18px rgba(0,0,0,0.08); }
        .wallet-image { width:100%; height:180px; object-fit:cover; border-bottom:1px solid #eee; background:#f3f4f6; display:block; }
        .no-image { width:100%; height:180px; display:flex; align-items:center; justify-content:center; background:#f3f4f6; border-bottom:1px solid #eee; color:#cbd5e1; }
        .wallet-content { padding:14px; display:flex; flex-direction:column; gap:8px; flex:1; }

        .wallet-type-badge {
            display:inline-block;
            padding:6px 10px;
            border-radius:6px;
            font-size:12px;
            font-weight:700;
            text-transform:uppercase;
            background:#f3f4f6;
            color:#374151;
            align-self:flex-start;
        }
        .wallet-title { font-size:15px; margin:0; color:#111827; font-weight:700; }
        .wallet-desc { color:#6b7280; font-size:13px; margin:0 0 6px 0; }

        .wallet-meta {
            display:flex;
            justify-content:space-between;
            align-items:center;
            gap:10px;
            margin-top:auto;
        }
        .small-muted { font-size:12px; color:#6b7280; display:flex; gap:6px; align-items:center; }

        .action-btns { display:flex; gap:8px; align-items:center; }
        .btn {
            padding:7px 11px;
            border-radius:6px;
            border:none;
            font-weight:700;
            cursor:pointer;
            font-size:13px;
            display:inline-flex;
            gap:8px;
            align-items:center;
        }
        .btn-view { background:#3b82f6; color:#fff; }
        .btn-view:hover{ filter:brightness(.96) }
        .btn-delete { background:#ef4444; color:#fff; }
        .btn-delete:hover{ filter:brightness(.96) }
        .btn-wa { background:#25D366; color:#fff; }
        .btn-wa:hover{ filter:brightness(.96) }
        .btn-edit { background:#f59e0b; color:#fff; border-radius:6px; padding:7px 11px; }

        .empty-state {
            text-align:center;
            padding:40px 20px;
            background:white;
            border-radius:8px;
            box-shadow:0 2px 8px rgba(0,0,0,0.04);
            border:1px solid #e6e6e6;
        }
        .empty-state i { font-size:48px; color:#d1d5db; margin-bottom:12px; display:block; }

        /* Pagination Styles */
        .pagination-container {
            background: #fff;
            border-radius: 8px;
            padding: 20px;
            margin-top: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            border: 1px solid #e6e6e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }

        .pagination-info {
            font-size: 14px;
            color: #6b7280;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .pagination-controls {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .page-btn {
            padding: 8px 14px;
            border: 1px solid #d1d5db;
            background: #fff;
            color: #374151;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .page-btn:hover:not(:disabled) {
            background: #f3f4f6;
            border-color: #4a5568;
        }

        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .page-btn.active {
            background: #4a5568;
            color: #fff;
            border-color: #4a5568;
        }

        .page-btn.ellipsis {
            border: none;
            background: transparent;
            cursor: default;
            pointer-events: none;
        }

        .items-per-page {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #6b7280;
        }

        .items-per-page select {
            padding: 6px 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            background: #fff;
            cursor: pointer;
        }

        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 9998;
            backdrop-filter: blur(4px);
        }

        .modal-overlay.active {
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: #fff;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            position: relative;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { 
                opacity: 0;
                transform: translateY(30px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid #e6e6e6;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            background: #fff;
            z-index: 1;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 20px;
            color: #111827;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-close {
            background: transparent;
            border: none;
            font-size: 28px;
            color: #6b7280;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: #f3f4f6;
            color: #111827;
        }

        .modal-body {
            padding: 24px;
        }

        .modal-image-container {
            width: 100%;
            margin-bottom: 20px;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #e6e6e6;
        }

        .modal-image {
            width: 100%;
            height: auto;
            max-height: 300px;
            object-fit: contain;
            background: #f3f4f6;
        }

        .modal-no-image {
            width: 100%;
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f3f4f6;
            color: #cbd5e1;
            font-size: 48px;
        }

        .detail-section {
            margin-bottom: 20px;
        }

        .detail-section:last-child {
            margin-bottom: 0;
        }

        .detail-label {
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            color: #6b7280;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .detail-value {
            font-size: 15px;
            color: #111827;
            background: #f9fafb;
            padding: 10px 12px;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
        }

        .detail-value.long-text {
            white-space: pre-wrap;
            word-break: break-word;
        }

        .bank-details-grid {
            display: grid;
            gap: 14px;
        }

        .detail-row {
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .detail-row i {
            color: #6b7280;
            margin-top: 12px;
            font-size: 14px;
        }

        .detail-row-content {
            flex: 1;
        }
    </style>

    <div class="container">
        <div class="header">
            <div class="header-left">
                <h1><i class="fas fa-wallet"></i> Wallets</h1>
                <p>Manage bank details, QR codes, docs and more</p>
            </div>
            <div>
                <a href="{% url 'add_wallet' %}" class="btn-add"><i class="fas fa-plus"></i> Add Wallet</a>
            </div>
        </div>

        {% if messages %}
            <div class="alert" id="msgAlert">
                <div class="text">
                    {% for message in messages %}
                        {{ message }}
                    {% endfor %}
                </div>
                <button class="close-btn" onclick="document.getElementById('msgAlert').remove()">&times;</button>
            </div>
        {% endif %}

        <!-- Filter Section -->
        <div class="filter-section">
            <div class="filter-grid">
                <div class="filter-group">
                    <label class="filter-label" for="searchInput">
                        <i class="fas fa-search"></i> Search All Pages
                    </label>
                    <input 
                        type="text" 
                        id="searchInput" 
                        class="filter-input" 
                        placeholder="Search by title, description..."
                    >
                </div>
                
                <div class="filter-group">
                    <label class="filter-label" for="dateFrom">
                        <i class="fas fa-calendar-alt"></i> From Date
                    </label>
                    <input 
                        type="date" 
                        id="dateFrom" 
                        class="filter-input"
                    >
                </div>
                
                <div class="filter-group">
                    <label class="filter-label" for="dateTo">
                        <i class="fas fa-calendar-check"></i> To Date
                    </label>
                    <input 
                        type="date" 
                        id="dateTo" 
                        class="filter-input"
                    >
                </div>
                
                <div class="filter-group">
                    <button class="btn-clear-filters" onclick="clearAllFilters()">
                        <i class="fas fa-times-circle"></i> Clear
                    </button>
                </div>
            </div>
        </div>

        <!-- Results Info -->
        <div class="results-info" id="resultsInfo">
            <div class="results-info-left">
                <i class="fas fa-info-circle"></i>
                <span id="resultsText">Showing all {{ wallets|length }} wallets</span>
            </div>
            <div class="items-per-page">
                <label for="itemsPerPage">Items per page:</label>
                <select id="itemsPerPage" onchange="changeItemsPerPage()">
                    <option value="6">6</option>
                    <option value="12" selected>12</option>
                    <option value="24">24</option>
                    <option value="48">48</option>
                    <option value="all">All</option>
                </select>
            </div>
        </div>

        <div class="ribbon-container">
            <div class="ribbon active" data-type="" id="allRibbon">
                <div class="ribbon-title"><i class="fas fa-th-large"></i> All Wallets</div>
                <div class="ribbon-count" id="count-all">{{ wallets|length }}</div>
            </div>
            <div class="ribbon" data-type="bank">
                <div class="ribbon-title"><i class="fas fa-university"></i> Bank wallet</div>
                <div class="ribbon-count" id="count-bank">{{ bank_wallets|length }}</div>
            </div>
            <div class="ribbon" data-type="qr">
                <div class="ribbon-title"><i class="fas fa-qrcode"></i> QR wallet</div>
                <div class="ribbon-count" id="count-qr">{{ qr_wallets|length }}</div>
            </div>
            <div class="ribbon" data-type="document">
                <div class="ribbon-title"><i class="fas fa-file-alt"></i> Docs wallet</div>
                <div class="ribbon-count" id="count-document">{{ document_wallets|length }}</div>
            </div>
            <div class="ribbon" data-type="other">
                <div class="ribbon-title"><i class="fas fa-wallet"></i> Other wallets</div>
                <div class="ribbon-count" id="count-other">{{ other_wallets|length }}</div>
            </div>
        </div>

        <div class="wallet-grid" id="walletGrid">
            {% for wallet in wallets %}
                <div class="wallet-card" 
                     data-type="{{ wallet.upload_type }}" 
                     data-id="{{ wallet.id }}"
                     data-title="{{ wallet.title }}"
                     data-description="{{ wallet.description }}"
                     data-upload-type="{{ wallet.upload_type }}"
                     data-visibility="{{ wallet.get_visibility_priority_display }}"
                     data-created="{{ wallet.created_at|date:'M d, Y' }}"
                     data-created-iso="{{ wallet.created_at|date:'Y-m-d' }}"
                     data-account-holder="{{ wallet.account_holder_name }}"
                     data-account-number="{{ wallet.account_number }}"
                     data-ifsc="{{ wallet.ifsc_code }}"
                     data-bank-address="{{ wallet.bank_address }}"
                     data-qr-name="{{ wallet.qr_name }}"
                     data-other-name="{{ wallet.other_name }}"
                     data-image-url="{% if wallet.image %}{{ wallet.image.url }}{% endif %}">
                    {% if wallet.image %}
                        <img src="{{ wallet.image.url }}" alt="{{ wallet.title }}" class="wallet-image">
                    {% else %}
                        <div class="no-image"><i class="fas fa-image"></i></div>
                    {% endif %}

                    <div class="wallet-content">
                        <span class="wallet-type-badge">
                            {% if wallet.upload_type == 'bank' %}
                                <i class="fas fa-university"></i> Bank
                            {% elif wallet.upload_type == 'qr' %}
                                <i class="fas fa-qrcode"></i> QR
                            {% elif wallet.upload_type == 'document' %}
                                <i class="fas fa-file-alt"></i> Document
                            {% else %}
                                <i class="fas fa-wallet"></i> Other
                            {% endif %}
                        </span>

                        <h3 class="wallet-title">{{ wallet.title }}</h3>
                        <p class="wallet-desc">{{ wallet.description|truncatewords:15 }}</p>

                        <div class="wallet-meta">
                            <div class="small-muted"><i class="fas fa-clock"></i> {{ wallet.created_at|date:"M d, Y" }}</div>
                            <div class="action-btns">
                                <button class="btn btn-view" onclick="openViewModal({{ wallet.id }})"><i class="fas fa-eye"></i></button>
                                <button class="btn btn-wa" onclick="handleWhatsAppShare({{ wallet.id }})"><i class="fab fa-whatsapp"></i></button>
                                <a class="btn btn-edit" href="{% url 'edit_wallet' wallet.id %}"><i class="fas fa-edit"></i></a>
                                <form method="post" action="{% url 'delete_wallet' wallet.id %}" style="display:inline;" onsubmit="return confirm('Delete this wallet?');">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-delete"><i class="fas fa-trash"></i></button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>

        {% if wallets|length == 0 %}
            <div style="margin-top:20px;">
                <div class="empty-state">
                    <i class="fas fa-wallet"></i>
                    <div style="font-weight:700; margin-bottom:6px;">No wallets yet</div>
                    <div style="color:#6b7280; font-size:13px;">Upload wallets and they'll appear here.</div>
                </div>
            </div>
        {% endif %}

        <!-- No Results Message -->
        <div class="empty-state" id="noResultsMessage" style="display:none; margin-top:20px;">
            <i class="fas fa-search"></i>
            <div style="font-weight:700; margin-bottom:6px;">No wallets found</div>
            <div style="color:#6b7280; font-size:13px;">Try adjusting your search or filters.</div>
        </div>

        <!-- Pagination -->
        <div class="pagination-container" id="paginationContainer">
            <div class="pagination-info" id="paginationInfo">
                Showing <strong>1-12</strong> of <strong>{{ wallets|length }}</strong> wallets
            </div>
            <div class="pagination-controls" id="paginationControls">
                <!-- Pagination buttons will be generated here -->
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal-overlay" id="viewModal" onclick="closeModalOnOverlay(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2><i class="fas fa-info-circle"></i> Wallet Details</h2>
                <button class="modal-close" onclick="closeViewModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Content will be dynamically inserted here -->
            </div>
        </div>
    </div>

    <script>
      // Get CSRF token
      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie) {
          const cookies = document.cookie.split(';');
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
              cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
              break;
            }
          }
        }
        return cookieValue;
      }
      const csrftoken = getCookie('csrftoken');

      // Pagination state
      let currentPage = 1;
      let itemsPerPage = 12;
      let filteredWallets = [];
      let currentTypeFilter = '';

      // Get all wallet cards and store them
      const allWalletCards = Array.from(document.querySelectorAll('.wallet-card'));

      // Initialize
      function init() {
        applyFilters();
      }

      // Filter functionality - searches ALL wallets, not just current page
      function applyFilters() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const dateFrom = document.getElementById('dateFrom').value;
        const dateTo = document.getElementById('dateTo').value;
        
        filteredWallets = [];
        let typeCounts = { '': 0, 'bank': 0, 'qr': 0, 'document': 0, 'other': 0 };
        
        // Filter through ALL wallets
        allWalletCards.forEach(card => {
          const cardType = card.getAttribute('data-type');
          const title = card.getAttribute('data-title').toLowerCase();
          const description = card.getAttribute('data-description').toLowerCase();
          const createdDate = card.getAttribute('data-created-iso');
          
          // Check type filter
          const typeMatch = currentTypeFilter === '' || cardType === currentTypeFilter;
          
          // Check search filter
          const searchMatch = searchTerm === '' || 
                             title.includes(searchTerm) || 
                             description.includes(searchTerm);
          
          // Check date filters
          let dateMatch = true;
          if (dateFrom && createdDate < dateFrom) {
            dateMatch = false;
          }
          if (dateTo && createdDate > dateTo) {
            dateMatch = false;
          }
          
          // If all filters match, add to filtered results
          if (typeMatch && searchMatch && dateMatch) {
            filteredWallets.push(card);
            typeCounts['']++;
            typeCounts[cardType]++;
          }
        });
        
        // Update counts
        updateRibbonCounts(typeCounts);
        
        // Reset to page 1 when filters change
        currentPage = 1;
        
        // Update display
        updateDisplay();
      }

      function updateDisplay() {
        const grid = document.getElementById('walletGrid');
        const noResults = document.getElementById('noResultsMessage');
        const paginationContainer = document.getElementById('paginationContainer');
        
        // Hide all cards first
        allWalletCards.forEach(card => {
          card.style.display = 'none';
        });
        
        if (filteredWallets.length === 0) {
          noResults.style.display = 'block';
          grid.style.display = 'none';
          paginationContainer.style.display = 'none';
          updateResultsInfo(0, 0, 0);
          return;
        }
        
        noResults.style.display = 'none';
        grid.style.display = 'grid';
        
        // Calculate pagination
        const totalItems = filteredWallets.length;
        const showAll = itemsPerPage === 'all';
        const itemsToShow = showAll ? totalItems : itemsPerPage;
        const totalPages = showAll ? 1 : Math.ceil(totalItems / itemsPerPage);
        
        // Ensure current page is valid
        if (currentPage > totalPages) {
          currentPage = totalPages;
        }
        if (currentPage < 1) {
          currentPage = 1;
        }
        
        // Calculate start and end indices
        const startIndex = showAll ? 0 : (currentPage - 1) * itemsPerPage;
        const endIndex = showAll ? totalItems : Math.min(startIndex + itemsPerPage, totalItems);
        
        // Show only the cards for current page
        for (let i = startIndex; i < endIndex; i++) {
          filteredWallets[i].style.display = 'flex';
          grid.appendChild(filteredWallets[i]);
        }
        
        // Update pagination info and controls
        updatePaginationInfo(startIndex + 1, endIndex, totalItems);
        renderPaginationControls(totalPages);
        
        // Show/hide pagination
        paginationContainer.style.display = showAll ? 'none' : 'flex';
        
        // Update results info
        updateResultsInfo(totalItems, startIndex + 1, endIndex);
      }

      function updateRibbonCounts(counts) {
        document.getElementById('count-all').textContent = counts[''];
        document.getElementById('count-bank').textContent = counts['bank'];
        document.getElementById('count-qr').textContent = counts['qr'];
        document.getElementById('count-document').textContent = counts['document'];
        document.getElementById('count-other').textContent = counts['other'];
      }

      function updateResultsInfo(total, start, end) {
        const resultsText = document.getElementById('resultsText');
        const searchTerm = document.getElementById('searchInput').value;
        const dateFrom = document.getElementById('dateFrom').value;
        const dateTo = document.getElementById('dateTo').value;
        
        let text = '';
        if (itemsPerPage === 'all') {
          text = `Showing all ${total} wallet${total !== 1 ? 's' : ''}`;
        } else {
          text = `Showing ${start}-${end} of ${total} wallet${total !== 1 ? 's' : ''}`;
        }
        
        const filters = [];
        if (searchTerm) filters.push('search');
        if (dateFrom || dateTo) filters.push('date range');
        if (currentTypeFilter) filters.push('type');
        
        if (filters.length > 0) {
          text += ` (filtered by ${filters.join(', ')})`;
        }
        
        resultsText.textContent = text;
      }

      function updatePaginationInfo(start, end, total) {
        const paginationInfo = document.getElementById('paginationInfo');
        paginationInfo.innerHTML = `Showing <strong>${start}-${end}</strong> of <strong>${total}</strong> wallets`;
      }

      function renderPaginationControls(totalPages) {
        const controls = document.getElementById('paginationControls');
        controls.innerHTML = '';
        
        if (totalPages <= 1) {
          return;
        }
        
        // Previous button
        const prevBtn = document.createElement('button');
        prevBtn.className = 'page-btn';
        prevBtn.innerHTML = '<i class="fas fa-chevron-left"></i> Previous';
        prevBtn.disabled = currentPage === 1;
        prevBtn.onclick = () => goToPage(currentPage - 1);
        controls.appendChild(prevBtn);
        
        // Page number buttons
        const pageButtons = getPageButtons(currentPage, totalPages);
        pageButtons.forEach(page => {
          const btn = document.createElement('button');
          btn.className = 'page-btn';
          
          if (page === '...') {
            btn.className += ' ellipsis';
            btn.textContent = '...';
          } else {
            btn.textContent = page;
            if (page === currentPage) {
              btn.className += ' active';
            }
            btn.onclick = () => goToPage(page);
          }
          
          controls.appendChild(btn);
        });
        
        // Next button
        const nextBtn = document.createElement('button');
        nextBtn.className = 'page-btn';
        nextBtn.innerHTML = 'Next <i class="fas fa-chevron-right"></i>';
        nextBtn.disabled = currentPage === totalPages;
        nextBtn.onclick = () => goToPage(currentPage + 1);
        controls.appendChild(nextBtn);
      }

      function getPageButtons(current, total) {
        const pages = [];
        const maxButtons = 7; // Show max 7 page buttons
        
        if (total <= maxButtons) {
          // Show all pages if total is small
          for (let i = 1; i <= total; i++) {
            pages.push(i);
          }
        } else {
          // Always show first page
          pages.push(1);
          
          if (current > 3) {
            pages.push('...');
          }
          
          // Show pages around current page
          const start = Math.max(2, current - 1);
          const end = Math.min(total - 1, current + 1);
          
          for (let i = start; i <= end; i++) {
            pages.push(i);
          }
          
          if (current < total - 2) {
            pages.push('...');
          }
          
          // Always show last page
          pages.push(total);
        }
        
        return pages;
      }

      function goToPage(page) {
        currentPage = page;
        updateDisplay();
        
        // Scroll to top of wallet grid
        document.getElementById('walletGrid').scrollIntoView({ behavior: 'smooth', block: 'start' });
      }

      function changeItemsPerPage() {
        const select = document.getElementById('itemsPerPage');
        itemsPerPage = select.value === 'all' ? 'all' : parseInt(select.value);
        currentPage = 1;
        updateDisplay();
      }

      function clearAllFilters() {
        document.getElementById('searchInput').value = '';
        document.getElementById('dateFrom').value = '';
        document.getElementById('dateTo').value = '';
        applyFilters();
      }

      // Add event listeners for filters
      document.getElementById('searchInput').addEventListener('input', applyFilters);
      document.getElementById('dateFrom').addEventListener('change', applyFilters);
      document.getElementById('dateTo').addEventListener('change', applyFilters);

      // Modal Functions
      function openViewModal(walletId) {
        const card = document.querySelector(`[data-id="${walletId}"]`);
        if (!card) return;

        const modal = document.getElementById('viewModal');
        const modalBody = document.getElementById('modalBody');

        const title = card.getAttribute('data-title');
        const description = card.getAttribute('data-description');
        const uploadType = card.getAttribute('data-upload-type');
        const visibility = card.getAttribute('data-visibility');
        const created = card.getAttribute('data-created');
        const imageUrl = card.getAttribute('data-image-url');

        // Type-specific data
        const accountHolder = card.getAttribute('data-account-holder');
        const accountNumber = card.getAttribute('data-account-number');
        const ifsc = card.getAttribute('data-ifsc');
        const bankAddress = card.getAttribute('data-bank-address');
        const qrName = card.getAttribute('data-qr-name');
        const otherName = card.getAttribute('data-other-name');

        let typeLabel = 'Other';
        let typeIcon = 'fas fa-wallet';
        if (uploadType === 'bank') {
          typeLabel = 'Bank';
          typeIcon = 'fas fa-university';
        } else if (uploadType === 'qr') {
          typeLabel = 'QR';
          typeIcon = 'fas fa-qrcode';
        } else if (uploadType === 'document') {
          typeLabel = 'Document';
          typeIcon = 'fas fa-file-alt';
        }

        let content = '';

        // Image section
        if (imageUrl) {
          content += `
            <div class="modal-image-container">
              <img src="${imageUrl}" alt="${title}" class="modal-image">
            </div>
          `;
        } else {
          content += `
            <div class="modal-image-container">
              <div class="modal-no-image"><i class="fas fa-image"></i></div>
            </div>
          `;
        }

        // Title section
        content += `
          <div class="detail-section">
            <div class="detail-label"><i class="fas fa-heading"></i> Title</div>
            <div class="detail-value">${title}</div>
          </div>
        `;

        // Type section
        content += `
          <div class="detail-section">
            <div class="detail-label"><i class="${typeIcon}"></i> Type</div>
            <div class="detail-value">${typeLabel}</div>
          </div>
        `;

        // Type-specific details
        if (uploadType === 'bank') {
          content += `<div class="detail-section"><div class="detail-label"><i class="fas fa-university"></i> Bank Details</div><div class="bank-details-grid">`;
          
          if (accountHolder) {
            content += `
              <div class="detail-row">
                <i class="fas fa-user"></i>
                <div class="detail-row-content">
                  <div style="font-size:11px; color:#6b7280; font-weight:600; margin-bottom:4px;">ACCOUNT HOLDER</div>
                  <div class="detail-value">${accountHolder}</div>
                </div>
              </div>
            `;
          }
          
          if (accountNumber) {
            content += `
              <div class="detail-row">
                <i class="fas fa-hashtag"></i>
                <div class="detail-row-content">
                  <div style="font-size:11px; color:#6b7280; font-weight:600; margin-bottom:4px;">ACCOUNT NUMBER</div>
                  <div class="detail-value">${accountNumber}</div>
                </div>
              </div>
            `;
          }
          
          if (ifsc) {
            content += `
              <div class="detail-row">
                <i class="fas fa-code"></i>
                <div class="detail-row-content">
                  <div style="font-size:11px; color:#6b7280; font-weight:600; margin-bottom:4px;">IFSC CODE</div>
                  <div class="detail-value">${ifsc}</div>
                </div>
              </div>
            `;
          }
          
          if (bankAddress) {
            content += `
              <div class="detail-row">
                <i class="fas fa-map-marker-alt"></i>
                <div class="detail-row-content">
                  <div style="font-size:11px; color:#6b7280; font-weight:600; margin-bottom:4px;">BANK ADDRESS</div>
                  <div class="detail-value">${bankAddress}</div>
                </div>
              </div>
            `;
          }
          
          content += `</div></div>`;
        } else if (uploadType === 'qr' && qrName) {
          content += `
            <div class="detail-section">
              <div class="detail-label"><i class="fas fa-qrcode"></i> QR Name</div>
              <div class="detail-value">${qrName}</div>
            </div>
          `;
        } else if (uploadType === 'other' && otherName) {
          content += `
            <div class="detail-section">
              <div class="detail-label"><i class="fas fa-wallet"></i> Wallet Name</div>
              <div class="detail-value">${otherName}</div>
            </div>
          `;
        }

        // Description section
        if (description) {
          content += `
            <div class="detail-section">
              <div class="detail-label"><i class="fas fa-align-left"></i> Description</div>
              <div class="detail-value long-text">${description}</div>
            </div>
          `;
        }

        // Visibility section
        content += `
          <div class="detail-section">
            <div class="detail-label"><i class="fas fa-eye"></i> Visibility</div>
            <div class="detail-value">${visibility}</div>
          </div>
        `;

        // Created date section
        content += `
          <div class="detail-section">
            <div class="detail-label"><i class="fas fa-calendar"></i> Created Date</div>
            <div class="detail-value">${created}</div>
          </div>
        `;

        modalBody.innerHTML = content;
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
      }

      function closeViewModal() {
        const modal = document.getElementById('viewModal');
        modal.classList.remove('active');
        document.body.style.overflow = '';
      }

      function closeModalOnOverlay(event) {
        if (event.target.id === 'viewModal') {
          closeViewModal();
        }
      }

      // Close modal on ESC key
      document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
          closeViewModal();
        }
      });

      // WhatsApp share - builds message from wallet data
      function handleWhatsAppShare(walletId) {
        const card = document.querySelector(`[data-id="${walletId}"]`);
        if (!card) {
          alert('Wallet not found');
          return;
        }

        const title = card.querySelector('.wallet-title')?.textContent || 'Wallet';
        const description = card.querySelector('.wallet-desc')?.textContent || '';
        const typeText = card.querySelector('.wallet-type-badge')?.textContent.trim() || '';
        const imageUrl = card.querySelector('.wallet-image')?.src || '';

        let msg = '*' + title + '*\n\n';
        msg += 'ðŸ“‹ Type: ' + typeText + '\n';
        
        if (description) {
          msg += '\nðŸ“ Description: ' + description + '\n';
        }
        
        if (imageUrl) {
          msg += '\nðŸ–¼ï¸ Image: ' + imageUrl + '\n';
        }

        window.open('https://wa.me/?text=' + encodeURIComponent(msg), '_blank');
      }

      // Ribbon filtering
      document.querySelectorAll('.ribbon').forEach(ribbon => {
        ribbon.addEventListener('click', function() {
          const type = this.getAttribute('data-type');
          
          document.querySelectorAll('.ribbon').forEach(r => r.classList.remove('active'));
          this.classList.add('active');
          
          currentTypeFilter = type;
          applyFilters();
        });
      });

      // Initialize on page load
      init();
    </script>
{% endblock %}