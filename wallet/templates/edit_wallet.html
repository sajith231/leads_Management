{% extends "base.html" %}
{% block content %}
<title>Edit Wallet Item</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    *, *::before, *::after { box-sizing: border-box; }
    body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial; color: #222; }

    .page-center {
        min-height: calc(100vh - 160px);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
        background: transparent;
    }

    .form-container {
        background: #fff;
        border-radius: 8px;
        padding: 28px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.06);
        border: 1px solid #e6e6e6;
        max-width: 680px;
        width: 100%;
    }

    .form-header { margin-bottom: 20px; text-align: center; }
    .upload-icon { font-size: 36px; color: #4a5568; margin-bottom: 8px; display:block; }
    .form-header h2 { font-size: 22px; margin: 6px 0; color:#222; }
    .form-header p { color: #6b7280; margin:0; font-size: 13px; }

    label.form-label { display:block; margin-bottom:6px; font-weight:600; color:#333; font-size:14px; }
    .required { color:#e63946; margin-left:4px; }

    .form-row { margin-bottom:16px; }
    input[type="text"], input[type="file"], select, textarea {
        width:100%;
        padding:10px 12px;
        border-radius:6px;
        border:1px solid #e6e6e6;
        font-size:14px;
        outline: none;
        background: #fff;
        transition: box-shadow .12s, border-color .12s;
    }
    input[type="text"]:focus, select:focus, textarea:focus {
        border-color: #4a5568;
        box-shadow: 0 0 0 4px rgba(74,85,104,0.06);
    }
    textarea { resize: vertical; min-height: 90px; }

    .info-text { font-size:12px; color:#6b7280; margin-top:6px; }
    .info-text.highlight { color:#2563eb; font-weight:600; }

    .field-group { background:#f8fafb; border:1px solid #eef2f7; padding:14px; border-radius:6px; margin-bottom:14px; }
    .field-group-title { display:flex; align-items:center; gap:8px; font-weight:600; color:#325065; margin-bottom:10px; font-size:15px; }

    .btn { display:inline-flex; align-items:center; gap:8px; justify-content:center; cursor:pointer; border-radius:6px; padding:8px 14px; font-weight:600; font-size:14px; border:1px solid transparent; }
    .btn-submit { width:100%; background:#4a5568; color:#fff; border-color:#4a5568; padding:12px 14px; }
    .btn-submit:hover { background:#2f3a42; border-color:#2f3a42; }

    .btn-back { display:inline-block; background:#eef2f3; color:#394046; padding:8px 14px; text-decoration:none; border-radius:6px; border:1px solid #e1e6e9; }
    .btn-back:hover { background:#e4eaed; }

    .image-preview-container { margin-top:10px; display:none; }
    .image-preview { max-width:100%; max-height:250px; border-radius:6px; border:1px solid #e6e6e6; box-shadow:0 1px 6px rgba(0,0,0,0.04); }

    .pdf-preview-container { margin-top:10px; display:none; background:#f9fafb; padding:12px; border-radius:6px; border:1px solid #e6e6e6; }
    .pdf-preview-info { display:flex; align-items:center; gap:10px; color:#374151; font-size:13px; }
    .pdf-icon { font-size:32px; color:#dc2626; }
    .pdf-details { flex:1; }
    .pdf-name { font-weight:600; margin-bottom:4px; }
    .pdf-size { color:#6b7280; font-size:12px; }

    .alert { position: relative; padding:10px 12px; border-radius:6px; margin-bottom:12px; border:1px solid transparent; display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .alert .message-text { flex:1; margin-right:10px; }
    .alert .close-btn { background:transparent; border:none; font-size:16px; cursor:pointer; color:inherit; padding:6px; border-radius:4px; }
    .alert-info { background:#eef2f8; color:#083b6b; border-color:#cfe7ff; }
    .alert-success { background:#ecfdf5; color:#064e3b; border-color:#bbf7d0; }
    .alert-danger { background:#fff1f2; color:#701a1a; border-color:#fecaca; }

    .file-upload-section { background:#f8fafb; border:1px solid #eef2f7; padding:16px; border-radius:6px; margin-bottom:14px; }
    .section-title { font-weight:600; color:#325065; margin-bottom:12px; font-size:15px; display:flex; align-items:center; gap:8px; }

    .existing-file { background:#e0f2fe; border:1px solid #bae6fd; padding:10px 12px; border-radius:6px; margin-top:6px; display:flex; align-items:center; gap:8px; font-size:13px; color:#0c4a6e; margin-bottom:8px; }
    .existing-file i { color:#0284c7; font-size:18px; }
    .existing-file a { color:#0c4a6e; text-decoration:none; font-weight:600; }
    .existing-file a:hover { text-decoration:underline; }
    
    .current-image-preview { max-width:100%; max-height:200px; border-radius:6px; border:1px solid #bae6fd; margin-top:6px; }
    
    .dynamic-fields { display: none; }
    .file-upload-section { display: block; }
</style>

<div class="page-center">
  <div class="form-container">
    <div class="form-header">
      <i class="fas fa-edit upload-icon"></i>
      <h2>Edit Wallet Item</h2>
      <p>Update wallet details and files</p>
    </div>

    {% if messages %}
      {% for message in messages %}
        {% if 'error' in message.tags or 'danger' in message.tags %}
          <div class="alert alert-danger" role="alert">
            <div class="message-text">{{ message }}</div>
            <button type="button" class="close-btn" aria-label="Close">&times;</button>
          </div>
        {% elif 'success' in message.tags %}
          <div class="alert alert-success" role="alert">
            <div class="message-text">{{ message }}</div>
            <button type="button" class="close-btn" aria-label="Close">&times;</button>
          </div>
        {% else %}
          <div class="alert alert-info" role="alert">
            <div class="message-text">{{ message }}</div>
            <button type="button" class="close-btn" aria-label="Close">&times;</button>
          </div>
        {% endif %}
      {% endfor %}
    {% endif %}

    <form method="post" enctype="multipart/form-data" id="walletForm" autocomplete="off">
      {% csrf_token %}

      <div class="form-row">
        <label class="form-label" for="title">Wallet name <span class="required">*</span></label>
        <input id="title" name="title" type="text" value="{{ wallet.title }}" required>
      </div>

      <div class="form-row">
        <label class="form-label" for="upload_type">Upload Type <span class="required">*</span></label>
        <select id="upload_type" name="upload_type" required>
          <option value="">Select upload type</option>
          <option value="bank" {% if wallet.upload_type == 'bank' %}selected{% endif %}>Bank/ACC-Details QR</option>
          <option value="qr" {% if wallet.upload_type == 'qr' %}selected{% endif %}>QR</option>
          <option value="document" {% if wallet.upload_type == 'document' %}selected{% endif %}>Documentation Image</option>
          <option value="pdf" {% if wallet.upload_type == 'pdf' %}selected{% endif %}>PDF Document</option>
          <option value="other" {% if wallet.upload_type == 'other' %}selected{% endif %}>Address Card</option>
          <option value="ofdocs_imc_dev" {% if wallet.upload_type == 'ofdocs_imc_dev' %}selected{% endif %}>Ofdocs - IMC DEV</option>
          <option value="ofdocs_imc_ho" {% if wallet.upload_type == 'ofdocs_imc_ho' %}selected{% endif %}>Ofdocs - IMC HO</option>
          <option value="ofdocs_imc_mukkam" {% if wallet.upload_type == 'ofdocs_imc_mukkam' %}selected{% endif %}>Ofdocs - IMC Mukkam</option>
          <option value="ofdocs_sysmac" {% if wallet.upload_type == 'ofdocs_sysmac' %}selected{% endif %}>Ofdocs - Sysmac</option>
          <option value="ofdocs_sysmac_info" {% if wallet.upload_type == 'ofdocs_sysmac_info' %}selected{% endif %}>Ofdocs - Sysmac Info</option>
          <option value="ofdocs_sysmac_old" {% if wallet.upload_type == 'ofdocs_sysmac_old' %}selected{% endif %}>Ofdocs - Sysmac Old</option>
          <option value="vehicle_data" {% if wallet.upload_type == 'vehicle_data' %}selected{% endif %}>Vehicle Data</option>
        </select>
        <div class="info-text">Select the category for this wallet item</div>
      </div>

      <!-- Type-Specific Fields -->
      <div id="typeSpecificFields">

        <!-- Bank Fields -->
        <div id="bankFields" class="dynamic-fields">
          <div class="field-group">
            <div class="field-group-title"><i class="fas fa-university"></i> Bank Account Details</div>

            <div class="form-row">
              <label class="form-label" for="account_holder_name">Account Holder Name</label>
              <input id="account_holder_name" name="account_holder_name" type="text" value="{{ wallet.account_holder_name }}">
            </div>

            <div class="form-row">
              <label class="form-label" for="account_number">Account Number</label>
              <input id="account_number" name="account_number" type="text" value="{{ wallet.account_number }}">
            </div>

            <div class="form-row">
              <label class="form-label" for="ifsc_code">IFSC Code</label>
              <input id="ifsc_code" name="ifsc_code" type="text" value="{{ wallet.ifsc_code }}" style="text-transform:uppercase;">
            </div>

            <div class="form-row">
              <label class="form-label" for="bank_address">Bank Address</label>
              <textarea id="bank_address" name="bank_address" rows="3">{{ wallet.bank_address }}</textarea>
            </div>
          </div>
        </div>

        <!-- QR Fields -->
        <div id="qrFields" class="dynamic-fields">
          <div class="field-group">
            <div class="field-group-title"><i class="fas fa-qrcode"></i> QR Details</div>
            <div class="form-row">
              <label class="form-label" for="qr_name">QR Name</label>
              <input id="qr_name" name="qr_name" type="text" value="{{ wallet.qr_name }}">
            </div>
          </div>
        </div>

        <!-- PDF Fields -->
        <div id="pdfSpecificFields" class="dynamic-fields">
          <div class="field-group">
            <div class="field-group-title"><i class="fas fa-file-pdf"></i> PDF Details</div>
            <div class="form-row">
              <label class="form-label" for="pdf_name">PDF Name</label>
              <input id="pdf_name" name="pdf_name" type="text" value="{{ wallet.pdf_name }}">
            </div>
          </div>
        </div>

        <!-- Address Book -->
        <div id="otherFields" class="dynamic-fields">
          <div class="field-group">
            <div class="field-group-title"><i class="fas fa-address-book"></i> Address Book</div>
            <div class="form-row">
              <label class="form-label" for="other_name">Name <span class="required">*</span></label>
              <input id="other_name" name="other_name" type="text" value="{{ wallet.other_name }}" {% if wallet.upload_type == 'other' %}required{% endif %}>
            </div>
          </div>
        </div>

        <!-- File Upload Section -->
        <div class="file-upload-section">
          <div class="section-title"><i class="fas fa-cloud-upload-alt"></i> File Upload</div>
          <div class="info-text highlight" style="margin-bottom:12px;">
            <i class="fas fa-info-circle"></i> At least one file (Image OR PDF) must be present
          </div>

          <!-- IMAGE -->
          <div class="form-row">
            <label class="form-label"><i class="fas fa-image"></i> Image Upload</label>

            {% if wallet.image %}
              <div class="existing-file">
                <i class="fas fa-check-circle"></i>
                <span>Current Image: <strong>{{ wallet.image.name|slice:"14:" }}</strong></span>
              </div>
              <img src="{{ wallet.image.url }}" class="current-image-preview" alt="Current image">
              <input type="hidden" id="hasExistingImage" value="true">
            {% else %}
              <div style="font-size:12px;color:#999;">No image uploaded</div>
              <input type="hidden" id="hasExistingImage" value="false">
            {% endif %}

            <input id="wallet_image" name="wallet_image" type="file" accept="image/png, image/jpeg, image/jpg">
            <div class="info-text">Supported formats: JPG, JPEG, PNG (Max 5MB)</div>

            <div id="imagePreview" class="image-preview-container">
              <img id="previewImg" class="image-preview" alt="New image preview">
            </div>
          </div>

          <!-- PDF -->
          <div class="form-row">
            <label class="form-label"><i class="fas fa-file-pdf"></i> PDF Upload</label>

            {% if wallet.pdf_file %}
              <div class="existing-file">
                <i class="fas fa-file-pdf"></i>
                <span>Current PDF: <a href="{{ wallet.pdf_file.url }}" target="_blank"><strong>{{ wallet.pdf_file.name|slice:"13:" }}</strong></a></span>
              </div>
              <input type="hidden" id="hasExistingPdf" value="true">
            {% else %}
              <div style="font-size:12px;color:#999;">No PDF uploaded</div>
              <input type="hidden" id="hasExistingPdf" value="false">
            {% endif %}

            <input id="wallet_pdf" name="wallet_pdf" type="file" accept="application/pdf">
            <div class="info-text">Supported format: PDF (Max 10MB)</div>

            <div id="pdfPreview" class="pdf-preview-container">
              <div class="pdf-preview-info">
                <i class="fas fa-file-pdf pdf-icon"></i>
                <div>
                  <div class="pdf-name" id="pdfFileName"></div>
                  <div class="pdf-size" id="pdfFileSize"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="form-row">
        <label class="form-label" for="visibility_priority">Visibility Priority <span class="required">*</span></label>
        <select id="visibility_priority" name="visibility_priority" required>
          <option value="">Select</option>
          <option value="superadmin" {% if wallet.visibility_priority == 'superadmin' %}selected{% endif %}>Super Admin</option>
          <option value="admin" {% if wallet.visibility_priority == 'admin' %}selected{% endif %}>Admin</option>
          <option value="user" {% if wallet.visibility_priority == 'user' %}selected{% endif %}>User</option>
        </select>
        <div class="info-text">Who can view this wallet item</div>
      </div>

      <div class="form-row">
        <label class="form-label" for="description">Description <span class="required" id="descRequired">{% if wallet.upload_type == 'other' %}*{% endif %}</span></label>
        <textarea id="description" name="description" rows="4" {% if wallet.upload_type == 'other' %}required{% endif %}>{{ wallet.description }}</textarea>
        <div class="info-text">Add any additional details about this wallet item</div>
      </div>

      <div class="form-row">
        <button type="submit" class="btn btn-submit"><i class="fas fa-save"></i> Update Wallet Item</button>
      </div>
    </form>

    <div style="text-align:center;margin-top:12px;">
      <a href="{% url 'wallet_list' %}" class="btn-back"><i class="fas fa-arrow-left"></i> Back to Wallet List</a>
    </div>

  </div>
</div>

<script>
  // Get current values
  const uploadTypeEl = document.getElementById('upload_type');
  const walletImage = document.getElementById('wallet_image');
  const walletPdf = document.getElementById('wallet_pdf');
  const hasExistingImage = document.getElementById('hasExistingImage').value === 'true';
  const hasExistingPdf = document.getElementById('hasExistingPdf').value === 'true';

  // Hide all dynamic fields
  function hideAllDynamicFields() {
    document.querySelectorAll('.dynamic-fields').forEach(el => el.style.display = 'none');
  }

  // Show specific fields based on upload type
  function showFieldsForType(type) {
    hideAllDynamicFields();
    
    if (type === 'bank') {
      document.getElementById('bankFields').style.display = 'block';
    } else if (type === 'qr') {
      document.getElementById('qrFields').style.display = 'block';
    } else if (type === 'pdf') {
      document.getElementById('pdfSpecificFields').style.display = 'block';
    } else if (type === 'other') {
      document.getElementById('otherFields').style.display = 'block';
    }
    // Other types show no specific fields
  }

  // Handle upload type change
  function handleUploadTypeChange() {
    const type = uploadTypeEl.value;
    
    if (!type) {
      document.getElementById('typeSpecificFields').style.display = 'none';
      return;
    }
    
    document.getElementById('typeSpecificFields').style.display = 'block';
    showFieldsForType(type);
    
    // Handle required fields
    const descriptionEl = document.getElementById('description');
    const descRequired = document.getElementById('descRequired');
    const otherNameEl = document.getElementById('other_name');
    
    if (type === 'other') {
      descriptionEl.setAttribute('required', 'required');
      descRequired.style.display = 'inline';
      if (otherNameEl) otherNameEl.setAttribute('required', 'required');
    } else {
      descriptionEl.removeAttribute('required');
      descRequired.style.display = 'none';
      if (otherNameEl) otherNameEl.removeAttribute('required');
    }
  }

  // Initialize on page load
  if (uploadTypeEl.value) {
    document.getElementById('typeSpecificFields').style.display = 'block';
    showFieldsForType(uploadTypeEl.value);
  }
  
  uploadTypeEl.addEventListener('change', handleUploadTypeChange);

  // Image preview
  walletImage.addEventListener('change', function(e) {
    const file = e.target.files && e.target.files[0];
    const img = document.getElementById('previewImg');
    const container = document.getElementById('imagePreview');

    if (!file) {
      container.style.display = 'none';
      img.src = '';
      return;
    }

    // Validate file type
    const allowed = ['image/jpeg', 'image/jpg', 'image/png'];
    if (!allowed.includes(file.type)) {
      alert('Only JPG, JPEG, and PNG images are allowed.');
      walletImage.value = '';
      return;
    }

    // Validate file size
    if (file.size > 5 * 1024 * 1024) {
      alert('Image file size should not exceed 5MB.');
      walletImage.value = '';
      return;
    }

    // Show preview
    const reader = new FileReader();
    reader.onload = function(ev) {
      img.src = ev.target.result;
      container.style.display = 'block';
    };
    reader.readAsDataURL(file);
  });

  // PDF preview
  walletPdf.addEventListener('change', function(e) {
    const file = e.target.files && e.target.files[0];
    const container = document.getElementById('pdfPreview');
    const fileName = document.getElementById('pdfFileName');
    const fileSize = document.getElementById('pdfFileSize');

    if (!file) {
      container.style.display = 'none';
      return;
    }

    // Validate file type
    if (file.type !== 'application/pdf') {
      alert('Only PDF files are allowed.');
      walletPdf.value = '';
      return;
    }

    // Validate file size
    if (file.size > 10 * 1024 * 1024) {
      alert('PDF file size should not exceed 10MB.');
      walletPdf.value = '';
      return;
    }

    // Show preview info
    fileName.textContent = file.name;
    
    let size = file.size;
    let sizeStr = '';
    if (size < 1024) {
      sizeStr = size + ' B';
    } else if (size < 1024 * 1024) {
      sizeStr = (size / 1024).toFixed(1) + ' KB';
    } else {
      sizeStr = (size / (1024 * 1024)).toFixed(1) + ' MB';
    }
    fileSize.textContent = sizeStr;
    
    container.style.display = 'block';
  });

  // IFSC code uppercase
  const ifscEl = document.getElementById('ifsc_code');
  if (ifscEl) {
    ifscEl.addEventListener('input', function() {
      this.value = this.value.toUpperCase();
    });
  }

  // Form validation - ensure at least one file is present
  document.getElementById('walletForm').addEventListener('submit', function(e) {
    const newImg = walletImage.files.length > 0;
    const newPdf = walletPdf.files.length > 0;
    const finalImg = hasExistingImage || newImg;
    const finalPdf = hasExistingPdf || newPdf;

    if (!finalImg && !finalPdf) {
      e.preventDefault();
      alert('At least one file (Image OR PDF) must be present. Please upload a file.');
      return false;
    }

    // Additional validation for Address Book
    if (uploadTypeEl.value === 'other') {
      const otherName = document.getElementById('other_name').value.trim();
      const description = document.getElementById('description').value.trim();
      
      if (!otherName || !description) {
        e.preventDefault();
        alert('Address Book requires both Name and Description.');
        return false;
      }
    }
  });

  // Close alert messages
  document.querySelectorAll('.alert .close-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const alert = this.closest('.alert');
      if (!alert) return;
      alert.style.transition = 'opacity .18s ease, height .18s ease, margin .18s ease';
      alert.style.opacity = '0';
      alert.style.height = '0';
      alert.style.margin = '0';
      setTimeout(() => alert.remove(), 200);
    });
  });
</script>
{% endblock %}